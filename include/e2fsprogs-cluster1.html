<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f68fdb61c5411ac000c7f?cs=4f1f68fdb61c5411ac000c8f -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./e2fsprogs-cluster1_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./e2fsprogs-cluster1_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./e2fsprogs-cluster1_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./e2fsprogs-cluster1_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./e2fsprogs-cluster1_files/chosen.jquery.js"></script>


        <script src="./e2fsprogs-cluster1_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./e2fsprogs-cluster1_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./e2fsprogs-cluster1_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f68fdb61c5411ac000c7f?cs=4f1f68fdb61c5411ac000c8f");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./e2fsprogs-cluster1_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./e2fsprogs-cluster1_files/bootstrap.css" rel="stylesheet">

        <link href="./e2fsprogs-cluster1_files/force.css" rel="stylesheet" type="text/css">
        <link href="./e2fsprogs-cluster1_files/chosen.css" rel="stylesheet" type="text/css">
       
        
<link rel="stylesheet" href="../pygments.css">
<title>Fica -- survey e2fsprogs-1.41.14 12-01-25 02:29:09</title>

<script language="javascript">

    var reheight = function(){
        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-70']")[0].scrollIntoView();
        $("a[name='c1-92']")[0].scrollIntoView();
        reheight();
        
        $("#clonesets").accordion({event:"click", autoHeight: false});
        $("#clonesets").accordion("activate","#cs-4f1f68fdb61c5411ac000c8f");
        
        $("#cs-4f1f68fdb61c5411ac000c8f").scrollintoview();
        

        
        $(".scrollbox").each(function(){
            var scrollbox = $(this);
            scrollbox.scroll(function(){
                var percent = $(this).scrollTop() /
                    (this.scrollHeight-$(this).height()) ;
                $(this).prev().css("opacity", percent * 5 );
                $(this).next().css("opacity", (1 - percent ) * 5 );
            });
        });
        
    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

    <body>
<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> lib/ext2fs/undo_io.c 
                <small> (70,2)-(86,8)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 716px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">  1</span> <span class="cm">/*</span>
<a name="c0-2"></a><span class="lineno">  2</span> <span class="cm"> * undo_io.c --- This is the undo io manager that copies the old data that</span>
<a name="c0-3"></a><span class="lineno">  3</span> <span class="cm"> * copies the old data being overwritten into a tdb database</span>
<a name="c0-4"></a><span class="lineno">  4</span> <span class="cm"> *</span>
<a name="c0-5"></a><span class="lineno">  5</span> <span class="cm"> * Copyright IBM Corporation, 2007</span>
<a name="c0-6"></a><span class="lineno">  6</span> <span class="cm"> * Author Aneesh Kumar K.V &lt;aneesh.kumar@linux.vnet.ibm.com&gt;</span>
<a name="c0-7"></a><span class="lineno">  7</span> <span class="cm"> *</span>
<a name="c0-8"></a><span class="lineno">  8</span> <span class="cm"> * %Begin-Header%</span>
<a name="c0-9"></a><span class="lineno">  9</span> <span class="cm"> * This file may be redistributed under the terms of the GNU Library</span>
<a name="c0-10"></a><span class="lineno"> 10</span> <span class="cm"> * General Public License, version 2.</span>
<a name="c0-11"></a><span class="lineno"> 11</span> <span class="cm"> * %End-Header%</span>
<a name="c0-12"></a><span class="lineno"> 12</span> <span class="cm"> */</span>
<a name="c0-13"></a><span class="lineno"> 13</span> 
<a name="c0-14"></a><span class="lineno"> 14</span> <span class="cp">#define _LARGEFILE_SOURCE</span>
<a name="c0-15"></a><span class="lineno"> 15</span> <span class="cp">#define _LARGEFILE64_SOURCE</span>
<a name="c0-16"></a><span class="lineno"> 16</span> 
<a name="c0-17"></a><span class="lineno"> 17</span> <span class="cp">#include &lt;stdio.h&gt;</span>
<a name="c0-18"></a><span class="lineno"> 18</span> <span class="cp">#include &lt;string.h&gt;</span>
<a name="c0-19"></a><span class="lineno"> 19</span> <span class="cp">#if HAVE_UNISTD_H</span>
<a name="c0-20"></a><span class="lineno"> 20</span> <span class="cp">#include &lt;unistd.h&gt;</span>
<a name="c0-21"></a><span class="lineno"> 21</span> <span class="cp">#endif</span>
<a name="c0-22"></a><span class="lineno"> 22</span> <span class="cp">#if HAVE_ERRNO_H</span>
<a name="c0-23"></a><span class="lineno"> 23</span> <span class="cp">#include &lt;errno.h&gt;</span>
<a name="c0-24"></a><span class="lineno"> 24</span> <span class="cp">#endif</span>
<a name="c0-25"></a><span class="lineno"> 25</span> <span class="cp">#include &lt;fcntl.h&gt;</span>
<a name="c0-26"></a><span class="lineno"> 26</span> <span class="cp">#include &lt;time.h&gt;</span>
<a name="c0-27"></a><span class="lineno"> 27</span> <span class="cp">#ifdef __linux__</span>
<a name="c0-28"></a><span class="lineno"> 28</span> <span class="cp">#include &lt;sys/utsname.h&gt;</span>
<a name="c0-29"></a><span class="lineno"> 29</span> <span class="cp">#endif</span>
<a name="c0-30"></a><span class="lineno"> 30</span> <span class="cp">#if HAVE_SYS_STAT_H</span>
<a name="c0-31"></a><span class="lineno"> 31</span> <span class="cp">#include &lt;sys/stat.h&gt;</span>
<a name="c0-32"></a><span class="lineno"> 32</span> <span class="cp">#endif</span>
<a name="c0-33"></a><span class="lineno"> 33</span> <span class="cp">#if HAVE_SYS_TYPES_H</span>
<a name="c0-34"></a><span class="lineno"> 34</span> <span class="cp">#include &lt;sys/types.h&gt;</span>
<a name="c0-35"></a><span class="lineno"> 35</span> <span class="cp">#endif</span>
<a name="c0-36"></a><span class="lineno"> 36</span> <span class="cp">#if HAVE_SYS_RESOURCE_H</span>
<a name="c0-37"></a><span class="lineno"> 37</span> <span class="cp">#include &lt;sys/resource.h&gt;</span>
<a name="c0-38"></a><span class="lineno"> 38</span> <span class="cp">#endif</span>
<a name="c0-39"></a><span class="lineno"> 39</span> 
<a name="c0-40"></a><span class="lineno"> 40</span> <span class="cp">#include "tdb.h"</span>
<a name="c0-41"></a><span class="lineno"> 41</span> 
<a name="c0-42"></a><span class="lineno"> 42</span> <span class="cp">#include "ext2_fs.h"</span>
<a name="c0-43"></a><span class="lineno"> 43</span> <span class="cp">#include "ext2fs.h"</span>
<a name="c0-44"></a><span class="lineno"> 44</span> 
<a name="c0-45"></a><span class="lineno"> 45</span> <span class="cp">#ifdef __GNUC__</span>
<a name="c0-46"></a><span class="lineno"> 46</span> <span class="cp">#define ATTR(x) __attribute__(x)</span>
<a name="c0-47"></a><span class="lineno"> 47</span> <span class="cp">#else</span>
<a name="c0-48"></a><span class="lineno"> 48</span> <span class="cp">#define ATTR(x)</span>
<a name="c0-49"></a><span class="lineno"> 49</span> <span class="cp">#endif</span>
<a name="c0-50"></a><span class="lineno"> 50</span> 
<a name="c0-51"></a><span class="lineno"> 51</span> <span class="cm">/*</span>
<a name="c0-52"></a><span class="lineno"> 52</span> <span class="cm"> * For checking structure magic numbers...</span>
<a name="c0-53"></a><span class="lineno"> 53</span> <span class="cm"> */</span>
<a name="c0-54"></a><span class="lineno"> 54</span> 
<a name="c0-55"></a><span class="lineno"> 55</span> <span class="cp">#define EXT2_CHECK_MAGIC(struct, code) \</span>
<a name="c0-56"></a><span class="lineno"> 56</span> <span class="cp">   if ((struct)-&gt;magic != (code)) return (code)</span>
<a name="c0-57"></a><span class="lineno"> 57</span> 
<a name="c0-58"></a><span class="lineno"> 58</span> <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="p">{</span>
<a name="c0-59"></a><span class="lineno"> 59</span>   <span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>
<a name="c0-60"></a><span class="lineno"> 60</span>   <span class="n">TDB_CONTEXT</span> <span class="o">*</span><span class="n">tdb</span><span class="p">;</span>
<a name="c0-61"></a><span class="lineno"> 61</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">tdb_file</span><span class="p">;</span>
<a name="c0-62"></a><span class="lineno"> 62</span> 
<a name="c0-63"></a><span class="lineno"> 63</span>   <span class="cm">/* The backing io channel */</span>
<a name="c0-64"></a><span class="lineno"> 64</span>   <span class="n">io_channel</span> <span class="n">real</span><span class="p">;</span>
<a name="c0-65"></a><span class="lineno"> 65</span> 
<a name="c0-66"></a><span class="lineno"> 66</span>   <span class="kt">int</span> <span class="n">tdb_data_size</span><span class="p">;</span>
<a name="c0-67"></a><span class="lineno"> 67</span>   <span class="kt">int</span> <span class="n">tdb_written</span><span class="p">;</span>
<a name="c0-68"></a><span class="lineno"> 68</span> 
<a name="c0-69"></a><span class="lineno"> 69</span>   <span class="cm">/* to support offset in unix I/O manager */</span>
<a name="c0-70"></a><span class="lineno"> 70</span> <span class="hll">  <span class="n">ext2_loff_t</span> <span class="n">offset</span><span class="p">;</span>
</span><a name="c0-71"></a><span class="lineno"> 71</span> <span class="hll"><span class="p">};</span>
</span><a name="c0-72"></a><span class="lineno"> 72</span> <span class="hll">
</span><a name="c0-73"></a><span class="lineno"> 73</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">io_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">);</span>
</span><a name="c0-74"></a><span class="lineno"> 74</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_close</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">);</span>
</span><a name="c0-75"></a><span class="lineno"> 75</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_set_blksize</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">);</span>
</span><a name="c0-76"></a><span class="lineno"> 76</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_read_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
</span><a name="c0-77"></a><span class="lineno"> 77</span> <span class="hll">            <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><a name="c0-78"></a><span class="lineno"> 78</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_write_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
</span><a name="c0-79"></a><span class="lineno"> 79</span> <span class="hll">       <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><a name="c0-80"></a><span class="lineno"> 80</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_flush</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">);</span>
</span><a name="c0-81"></a><span class="lineno"> 81</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_write_byte</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
</span><a name="c0-82"></a><span class="lineno"> 82</span> <span class="hll">       <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><a name="c0-83"></a><span class="lineno"> 83</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">undo_set_option</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">,</span>
</span><a name="c0-84"></a><span class="lineno"> 84</span> <span class="hll">        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</span><a name="c0-85"></a><span class="lineno"> 85</span> <span class="hll">
</span><a name="c0-86"></a><span class="lineno"> 86</span> <span class="hll"><span class="k">static</span> <span class="k">struct</span> <span class="n">struct_io_manager</span> <span class="n">struct_undo_manager</span> <span class="o">=</span> <span class="p">{</span>
</span><a name="c0-87"></a><span class="lineno"> 87</span>  <span class="n">EXT2_ET_MAGIC_IO_MANAGER</span><span class="p">,</span>
<a name="c0-88"></a><span class="lineno"> 88</span>   <span class="s">"Undo I/O Manager"</span><span class="p">,</span>
<a name="c0-89"></a><span class="lineno"> 89</span>   <span class="n">undo_open</span><span class="p">,</span>
<a name="c0-90"></a><span class="lineno"> 90</span>   <span class="n">undo_close</span><span class="p">,</span>
<a name="c0-91"></a><span class="lineno"> 91</span>   <span class="n">undo_set_blksize</span><span class="p">,</span>
<a name="c0-92"></a><span class="lineno"> 92</span>   <span class="n">undo_read_blk</span><span class="p">,</span>
<a name="c0-93"></a><span class="lineno"> 93</span>   <span class="n">undo_write_blk</span><span class="p">,</span>
<a name="c0-94"></a><span class="lineno"> 94</span>   <span class="n">undo_flush</span><span class="p">,</span>
<a name="c0-95"></a><span class="lineno"> 95</span>   <span class="n">undo_write_byte</span><span class="p">,</span>
<a name="c0-96"></a><span class="lineno"> 96</span>   <span class="n">undo_set_option</span>
<a name="c0-97"></a><span class="lineno"> 97</span> <span class="p">};</span>
<a name="c0-98"></a><span class="lineno"> 98</span> 
<a name="c0-99"></a><span class="lineno"> 99</span> <span class="n">io_manager</span> <span class="n">undo_io_manager</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">struct_undo_manager</span><span class="p">;</span>
<a name="c0-100"></a><span class="lineno">100</span> <span class="k">static</span> <span class="n">io_manager</span> <span class="n">undo_io_backing_manager</span> <span class="p">;</span>
<a name="c0-101"></a><span class="lineno">101</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tdb_file</span><span class="p">;</span>
<a name="c0-102"></a><span class="lineno">102</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">actual_size</span><span class="p">;</span>
<a name="c0-103"></a><span class="lineno">103</span> 
<a name="c0-104"></a><span class="lineno">104</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mtime_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"filesystem MTIME"</span><span class="p">;</span>
<a name="c0-105"></a><span class="lineno">105</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">blksize_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"filesystem BLKSIZE"</span><span class="p">;</span>
<a name="c0-106"></a><span class="lineno">106</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">uuid_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"filesystem UUID"</span><span class="p">;</span>
<a name="c0-107"></a><span class="lineno">107</span> 
<a name="c0-108"></a><span class="lineno">108</span> <span class="n">errcode_t</span> <span class="nf">set_undo_io_backing_manager</span><span class="p">(</span><span class="n">io_manager</span> <span class="n">manager</span><span class="p">)</span>
<a name="c0-109"></a><span class="lineno">109</span> <span class="p">{</span>
<a name="c0-110"></a><span class="lineno">110</span>  <span class="cm">/*</span>
<a name="c0-111"></a><span class="lineno">111</span> <span class="cm">   * We may want to do some validation later</span>
<a name="c0-112"></a><span class="lineno">112</span> <span class="cm">   */</span>
<a name="c0-113"></a><span class="lineno">113</span>  <span class="n">undo_io_backing_manager</span> <span class="o">=</span> <span class="n">manager</span><span class="p">;</span>
<a name="c0-114"></a><span class="lineno">114</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-115"></a><span class="lineno">115</span> <span class="p">}</span>
<a name="c0-116"></a><span class="lineno">116</span> 
<a name="c0-117"></a><span class="lineno">117</span> <span class="n">errcode_t</span> <span class="nf">set_undo_io_backup_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file_name</span><span class="p">)</span>
<a name="c0-118"></a><span class="lineno">118</span> <span class="p">{</span>
<a name="c0-119"></a><span class="lineno">119</span>  <span class="n">tdb_file</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">file_name</span><span class="p">);</span>
<a name="c0-120"></a><span class="lineno">120</span> 
<a name="c0-121"></a><span class="lineno">121</span>  <span class="k">if</span> <span class="p">(</span><span class="n">tdb_file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-122"></a><span class="lineno">122</span>    <span class="k">return</span> <span class="n">EXT2_ET_NO_MEMORY</span><span class="p">;</span>
<a name="c0-123"></a><span class="lineno">123</span>  <span class="p">}</span>
<a name="c0-124"></a><span class="lineno">124</span> 
<a name="c0-125"></a><span class="lineno">125</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-126"></a><span class="lineno">126</span> <span class="p">}</span>
<a name="c0-127"></a><span class="lineno">127</span> 
<a name="c0-128"></a><span class="lineno">128</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">write_file_system_identity</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">undo_channel</span><span class="p">,</span>
<a name="c0-129"></a><span class="lineno">129</span>              <span class="n">TDB_CONTEXT</span> <span class="o">*</span><span class="n">tdb</span><span class="p">)</span>
<a name="c0-130"></a><span class="lineno">130</span> <span class="p">{</span>
<a name="c0-131"></a><span class="lineno">131</span>  <span class="n">errcode_t</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-132"></a><span class="lineno">132</span>  <span class="k">struct</span> <span class="n">ext2_super_block</span> <span class="n">super</span><span class="p">;</span>
<a name="c0-133"></a><span class="lineno">133</span>  <span class="n">TDB_DATA</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">;</span>
<a name="c0-134"></a><span class="lineno">134</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-135"></a><span class="lineno">135</span>  <span class="n">io_channel</span> <span class="n">channel</span><span class="p">;</span>
<a name="c0-136"></a><span class="lineno">136</span>  <span class="kt">int</span> <span class="n">block_size</span> <span class="p">;</span>
<a name="c0-137"></a><span class="lineno">137</span> 
<a name="c0-138"></a><span class="lineno">138</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">undo_channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-139"></a><span class="lineno">139</span>  <span class="n">channel</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">;</span>
<a name="c0-140"></a><span class="lineno">140</span>  <span class="n">block_size</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-141"></a><span class="lineno">141</span> 
<a name="c0-142"></a><span class="lineno">142</span>  <span class="n">io_channel_set_blksize</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">SUPERBLOCK_OFFSET</span><span class="p">);</span>
<a name="c0-143"></a><span class="lineno">143</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_read_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">SUPERBLOCK_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">super</span><span class="p">);</span>
<a name="c0-144"></a><span class="lineno">144</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-145"></a><span class="lineno">145</span>    <span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
<a name="c0-146"></a><span class="lineno">146</span> 
<a name="c0-147"></a><span class="lineno">147</span>  <span class="cm">/* Write to tdb file in the file system byte order */</span>
<a name="c0-148"></a><span class="lineno">148</span>  <span class="n">tdb_key</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="n">mtime_key</span><span class="p">;</span>
<a name="c0-149"></a><span class="lineno">149</span>  <span class="n">tdb_key</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mtime_key</span><span class="p">);</span>
<a name="c0-150"></a><span class="lineno">150</span>  <span class="n">tdb_data</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">super</span><span class="p">.</span><span class="n">s_mtime</span><span class="p">);</span>
<a name="c0-151"></a><span class="lineno">151</span>  <span class="n">tdb_data</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">super</span><span class="p">.</span><span class="n">s_mtime</span><span class="p">);</span>
<a name="c0-152"></a><span class="lineno">152</span> 
<a name="c0-153"></a><span class="lineno">153</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">tdb_store</span><span class="p">(</span><span class="n">tdb</span><span class="p">,</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">,</span> <span class="n">TDB_INSERT</span><span class="p">);</span>
<a name="c0-154"></a><span class="lineno">154</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-155"></a><span class="lineno">155</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_TDB_SUCCESS</span> <span class="o">+</span> <span class="n">tdb_error</span><span class="p">(</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-156"></a><span class="lineno">156</span>    <span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
<a name="c0-157"></a><span class="lineno">157</span>  <span class="p">}</span>
<a name="c0-158"></a><span class="lineno">158</span> 
<a name="c0-159"></a><span class="lineno">159</span>  <span class="n">tdb_key</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="n">uuid_key</span><span class="p">;</span>
<a name="c0-160"></a><span class="lineno">160</span>  <span class="n">tdb_key</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uuid_key</span><span class="p">);</span>
<a name="c0-161"></a><span class="lineno">161</span>  <span class="n">tdb_data</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">super</span><span class="p">.</span><span class="n">s_uuid</span><span class="p">);</span>
<a name="c0-162"></a><span class="lineno">162</span>  <span class="n">tdb_data</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">super</span><span class="p">.</span><span class="n">s_uuid</span><span class="p">);</span>
<a name="c0-163"></a><span class="lineno">163</span> 
<a name="c0-164"></a><span class="lineno">164</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">tdb_store</span><span class="p">(</span><span class="n">tdb</span><span class="p">,</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">,</span> <span class="n">TDB_INSERT</span><span class="p">);</span>
<a name="c0-165"></a><span class="lineno">165</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-166"></a><span class="lineno">166</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_TDB_SUCCESS</span> <span class="o">+</span> <span class="n">tdb_error</span><span class="p">(</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-167"></a><span class="lineno">167</span>  <span class="p">}</span>
<a name="c0-168"></a><span class="lineno">168</span> 
<a name="c0-169"></a><span class="lineno">169</span> <span class="nl">err_out:</span>
<a name="c0-170"></a><span class="lineno">170</span>  <span class="n">io_channel_set_blksize</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
<a name="c0-171"></a><span class="lineno">171</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-172"></a><span class="lineno">172</span> <span class="p">}</span>
<a name="c0-173"></a><span class="lineno">173</span> 
<a name="c0-174"></a><span class="lineno">174</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">write_block_size</span><span class="p">(</span><span class="n">TDB_CONTEXT</span> <span class="o">*</span><span class="n">tdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span>
<a name="c0-175"></a><span class="lineno">175</span> <span class="p">{</span>
<a name="c0-176"></a><span class="lineno">176</span>  <span class="n">errcode_t</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-177"></a><span class="lineno">177</span>  <span class="n">TDB_DATA</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">;</span>
<a name="c0-178"></a><span class="lineno">178</span> 
<a name="c0-179"></a><span class="lineno">179</span>  <span class="n">tdb_key</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="n">blksize_key</span><span class="p">;</span>
<a name="c0-180"></a><span class="lineno">180</span>  <span class="n">tdb_key</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">blksize_key</span><span class="p">);</span>
<a name="c0-181"></a><span class="lineno">181</span>  <span class="n">tdb_data</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>
<a name="c0-182"></a><span class="lineno">182</span>  <span class="n">tdb_data</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>
<a name="c0-183"></a><span class="lineno">183</span> 
<a name="c0-184"></a><span class="lineno">184</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">tdb_store</span><span class="p">(</span><span class="n">tdb</span><span class="p">,</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">,</span> <span class="n">TDB_INSERT</span><span class="p">);</span>
<a name="c0-185"></a><span class="lineno">185</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-186"></a><span class="lineno">186</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_TDB_SUCCESS</span> <span class="o">+</span> <span class="n">tdb_error</span><span class="p">(</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-187"></a><span class="lineno">187</span>  <span class="p">}</span>
<a name="c0-188"></a><span class="lineno">188</span> 
<a name="c0-189"></a><span class="lineno">189</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-190"></a><span class="lineno">190</span> <span class="p">}</span>
<a name="c0-191"></a><span class="lineno">191</span> 
<a name="c0-192"></a><span class="lineno">192</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_write_tdb</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span>
<a name="c0-193"></a><span class="lineno">193</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<a name="c0-194"></a><span class="lineno">194</span> 
<a name="c0-195"></a><span class="lineno">195</span> <span class="p">{</span>
<a name="c0-196"></a><span class="lineno">196</span>  <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-197"></a><span class="lineno">197</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">backing_blk_num</span><span class="p">;</span>
<a name="c0-198"></a><span class="lineno">198</span>  <span class="n">errcode_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-199"></a><span class="lineno">199</span>  <span class="n">ext2_loff_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-200"></a><span class="lineno">200</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-201"></a><span class="lineno">201</span>  <span class="n">TDB_DATA</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">;</span>
<a name="c0-202"></a><span class="lineno">202</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">read_ptr</span><span class="p">;</span>
<a name="c0-203"></a><span class="lineno">203</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_block</span><span class="p">;</span>
<a name="c0-204"></a><span class="lineno">204</span> 
<a name="c0-205"></a><span class="lineno">205</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-206"></a><span class="lineno">206</span> 
<a name="c0-207"></a><span class="lineno">207</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-208"></a><span class="lineno">208</span>    <span class="cm">/*</span>
<a name="c0-209"></a><span class="lineno">209</span> <span class="cm">     * Transaction database not initialized</span>
<a name="c0-210"></a><span class="lineno">210</span> <span class="cm">     */</span>
<a name="c0-211"></a><span class="lineno">211</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-212"></a><span class="lineno">212</span>  <span class="p">}</span>
<a name="c0-213"></a><span class="lineno">213</span> 
<a name="c0-214"></a><span class="lineno">214</span>  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-215"></a><span class="lineno">215</span>    <span class="n">size</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-216"></a><span class="lineno">216</span>  <span class="k">else</span> <span class="p">{</span>
<a name="c0-217"></a><span class="lineno">217</span>    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-218"></a><span class="lineno">218</span>      <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="n">count</span><span class="p">;</span>
<a name="c0-219"></a><span class="lineno">219</span>    <span class="k">else</span>
<a name="c0-220"></a><span class="lineno">220</span>      <span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-221"></a><span class="lineno">221</span>  <span class="p">}</span>
<a name="c0-222"></a><span class="lineno">222</span>  <span class="cm">/*</span>
<a name="c0-223"></a><span class="lineno">223</span> <span class="cm">   * Data is stored in tdb database as blocks of tdb_data_size size</span>
<a name="c0-224"></a><span class="lineno">224</span> <span class="cm">   * This helps in efficient lookup further.</span>
<a name="c0-225"></a><span class="lineno">225</span> <span class="cm">   *</span>
<a name="c0-226"></a><span class="lineno">226</span> <span class="cm">   * We divide the disk to blocks of tdb_data_size.</span>
<a name="c0-227"></a><span class="lineno">227</span> <span class="cm">   */</span>
<a name="c0-228"></a><span class="lineno">228</span>  <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="p">;</span>
<a name="c0-229"></a><span class="lineno">229</span>  <span class="n">block_num</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span><span class="p">;</span>
<a name="c0-230"></a><span class="lineno">230</span>  <span class="n">end_block</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span><span class="p">;</span>
<a name="c0-231"></a><span class="lineno">231</span> 
<a name="c0-232"></a><span class="lineno">232</span>  <span class="n">tdb_transaction_start</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-233"></a><span class="lineno">233</span>  <span class="k">while</span> <span class="p">(</span><span class="n">block_num</span> <span class="o">&lt;=</span> <span class="n">end_block</span> <span class="p">)</span> <span class="p">{</span>
<a name="c0-234"></a><span class="lineno">234</span> 
<a name="c0-235"></a><span class="lineno">235</span>    <span class="n">tdb_key</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">block_num</span><span class="p">;</span>
<a name="c0-236"></a><span class="lineno">236</span>    <span class="n">tdb_key</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">block_num</span><span class="p">);</span>
<a name="c0-237"></a><span class="lineno">237</span>    <span class="cm">/*</span>
<a name="c0-238"></a><span class="lineno">238</span> <span class="cm">     * Check if we have the record already</span>
<a name="c0-239"></a><span class="lineno">239</span> <span class="cm">     */</span>
<a name="c0-240"></a><span class="lineno">240</span>    <span class="k">if</span> <span class="p">(</span><span class="n">tdb_exists</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">,</span> <span class="n">tdb_key</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-241"></a><span class="lineno">241</span>      <span class="cm">/* Try the next block */</span>
<a name="c0-242"></a><span class="lineno">242</span>      <span class="n">block_num</span><span class="o">++</span><span class="p">;</span>
<a name="c0-243"></a><span class="lineno">243</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-244"></a><span class="lineno">244</span>    <span class="p">}</span>
<a name="c0-245"></a><span class="lineno">245</span>    <span class="cm">/*</span>
<a name="c0-246"></a><span class="lineno">246</span> <span class="cm">     * Read one block using the backing I/O manager</span>
<a name="c0-247"></a><span class="lineno">247</span> <span class="cm">     * The backing I/O manager block size may be</span>
<a name="c0-248"></a><span class="lineno">248</span> <span class="cm">     * different from the tdb_data_size.</span>
<a name="c0-249"></a><span class="lineno">249</span> <span class="cm">     * Also we need to recalcuate the block number with respect</span>
<a name="c0-250"></a><span class="lineno">250</span> <span class="cm">     * to the backing I/O manager.</span>
<a name="c0-251"></a><span class="lineno">251</span> <span class="cm">     */</span>
<a name="c0-252"></a><span class="lineno">252</span>    <span class="n">offset</span> <span class="o">=</span> <span class="n">block_num</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span><span class="p">;</span>
<a name="c0-253"></a><span class="lineno">253</span>    <span class="n">backing_blk_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-254"></a><span class="lineno">254</span> 
<a name="c0-255"></a><span class="lineno">255</span>    <span class="n">count</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span> <span class="o">+</span>
<a name="c0-256"></a><span class="lineno">256</span>        <span class="p">((</span><span class="n">offset</span> <span class="o">-</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">%</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c0-257"></a><span class="lineno">257</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_ptr</span><span class="p">);</span>
<a name="c0-258"></a><span class="lineno">258</span>    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-259"></a><span class="lineno">259</span>      <span class="n">tdb_transaction_cancel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-260"></a><span class="lineno">260</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-261"></a><span class="lineno">261</span>    <span class="p">}</span>
<a name="c0-262"></a><span class="lineno">262</span> 
<a name="c0-263"></a><span class="lineno">263</span>    <span class="n">memset</span><span class="p">(</span><span class="n">read_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<a name="c0-264"></a><span class="lineno">264</span>    <span class="n">actual_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-265"></a><span class="lineno">265</span>    <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">%</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-266"></a><span class="lineno">266</span>      <span class="n">sz</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-267"></a><span class="lineno">267</span>    <span class="k">else</span>
<a name="c0-268"></a><span class="lineno">268</span>      <span class="n">sz</span> <span class="o">=</span> <span class="o">-</span><span class="n">count</span><span class="p">;</span>
<a name="c0-269"></a><span class="lineno">269</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_read_blk</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">,</span> <span class="n">backing_blk_num</span><span class="p">,</span>
<a name="c0-270"></a><span class="lineno">270</span>               <span class="n">sz</span><span class="p">,</span> <span class="n">read_ptr</span><span class="p">);</span>
<a name="c0-271"></a><span class="lineno">271</span>    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-272"></a><span class="lineno">272</span>      <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">EXT2_ET_SHORT_READ</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-273"></a><span class="lineno">273</span>        <span class="n">free</span><span class="p">(</span><span class="n">read_ptr</span><span class="p">);</span>
<a name="c0-274"></a><span class="lineno">274</span>        <span class="n">tdb_transaction_cancel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-275"></a><span class="lineno">275</span>        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-276"></a><span class="lineno">276</span>      <span class="p">}</span>
<a name="c0-277"></a><span class="lineno">277</span>      <span class="cm">/*</span>
<a name="c0-278"></a><span class="lineno">278</span> <span class="cm">       * short read so update the record size</span>
<a name="c0-279"></a><span class="lineno">279</span> <span class="cm">       * accordingly</span>
<a name="c0-280"></a><span class="lineno">280</span> <span class="cm">       */</span>
<a name="c0-281"></a><span class="lineno">281</span>      <span class="n">tdb_data</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">actual_size</span><span class="p">;</span>
<a name="c0-282"></a><span class="lineno">282</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-283"></a><span class="lineno">283</span>      <span class="n">tdb_data</span><span class="p">.</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span><span class="p">;</span>
<a name="c0-284"></a><span class="lineno">284</span>    <span class="p">}</span>
<a name="c0-285"></a><span class="lineno">285</span>    <span class="n">tdb_data</span><span class="p">.</span><span class="n">dptr</span> <span class="o">=</span> <span class="n">read_ptr</span> <span class="o">+</span>
<a name="c0-286"></a><span class="lineno">286</span>        <span class="p">((</span><span class="n">offset</span> <span class="o">-</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">%</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c0-287"></a><span class="lineno">287</span> <span class="cp">#ifdef DEBUG</span>
<a name="c0-288"></a><span class="lineno">288</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Printing with key %ld data %x and size %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-289"></a><span class="lineno">289</span>           <span class="n">block_num</span><span class="p">,</span>
<a name="c0-290"></a><span class="lineno">290</span>           <span class="n">tdb_data</span><span class="p">.</span><span class="n">dptr</span><span class="p">,</span>
<a name="c0-291"></a><span class="lineno">291</span>           <span class="n">tdb_data</span><span class="p">.</span><span class="n">dsize</span><span class="p">);</span>
<a name="c0-292"></a><span class="lineno">292</span> <span class="cp">#endif</span>
<a name="c0-293"></a><span class="lineno">293</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_written</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-294"></a><span class="lineno">294</span>      <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_written</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-295"></a><span class="lineno">295</span>      <span class="cm">/* Write the blocksize to tdb file */</span>
<a name="c0-296"></a><span class="lineno">296</span>      <span class="n">retval</span> <span class="o">=</span> <span class="n">write_block_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">,</span>
<a name="c0-297"></a><span class="lineno">297</span>              <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span><span class="p">);</span>
<a name="c0-298"></a><span class="lineno">298</span>      <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-299"></a><span class="lineno">299</span>        <span class="n">tdb_transaction_cancel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-300"></a><span class="lineno">300</span>        <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_TDB_ERR_IO</span><span class="p">;</span>
<a name="c0-301"></a><span class="lineno">301</span>        <span class="n">free</span><span class="p">(</span><span class="n">read_ptr</span><span class="p">);</span>
<a name="c0-302"></a><span class="lineno">302</span>        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-303"></a><span class="lineno">303</span>      <span class="p">}</span>
<a name="c0-304"></a><span class="lineno">304</span>    <span class="p">}</span>
<a name="c0-305"></a><span class="lineno">305</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">tdb_store</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">,</span> <span class="n">tdb_key</span><span class="p">,</span> <span class="n">tdb_data</span><span class="p">,</span> <span class="n">TDB_INSERT</span><span class="p">);</span>
<a name="c0-306"></a><span class="lineno">306</span>    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-307"></a><span class="lineno">307</span>      <span class="cm">/*</span>
<a name="c0-308"></a><span class="lineno">308</span> <span class="cm">       * TDB_ERR_EXISTS cannot happen because we</span>
<a name="c0-309"></a><span class="lineno">309</span> <span class="cm">       * have already verified it doesn't exist</span>
<a name="c0-310"></a><span class="lineno">310</span> <span class="cm">       */</span>
<a name="c0-311"></a><span class="lineno">311</span>      <span class="n">tdb_transaction_cancel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-312"></a><span class="lineno">312</span>      <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_TDB_ERR_IO</span><span class="p">;</span>
<a name="c0-313"></a><span class="lineno">313</span>      <span class="n">free</span><span class="p">(</span><span class="n">read_ptr</span><span class="p">);</span>
<a name="c0-314"></a><span class="lineno">314</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-315"></a><span class="lineno">315</span>    <span class="p">}</span>
<a name="c0-316"></a><span class="lineno">316</span>    <span class="n">free</span><span class="p">(</span><span class="n">read_ptr</span><span class="p">);</span>
<a name="c0-317"></a><span class="lineno">317</span>    <span class="cm">/* Next block */</span>
<a name="c0-318"></a><span class="lineno">318</span>    <span class="n">block_num</span><span class="o">++</span><span class="p">;</span>
<a name="c0-319"></a><span class="lineno">319</span>  <span class="p">}</span>
<a name="c0-320"></a><span class="lineno">320</span>  <span class="n">tdb_transaction_commit</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-321"></a><span class="lineno">321</span> 
<a name="c0-322"></a><span class="lineno">322</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-323"></a><span class="lineno">323</span> <span class="p">}</span>
<a name="c0-324"></a><span class="lineno">324</span> 
<a name="c0-325"></a><span class="lineno">325</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_io_read_error</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span> <span class="n">ATTR</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
<a name="c0-326"></a><span class="lineno">326</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span> <span class="n">ATTR</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
<a name="c0-327"></a><span class="lineno">327</span>            <span class="kt">int</span> <span class="n">count</span> <span class="n">ATTR</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
<a name="c0-328"></a><span class="lineno">328</span>            <span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="n">ATTR</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
<a name="c0-329"></a><span class="lineno">329</span>            <span class="kt">size_t</span> <span class="n">size</span> <span class="n">ATTR</span><span class="p">((</span><span class="n">unused</span><span class="p">)),</span>
<a name="c0-330"></a><span class="lineno">330</span>            <span class="kt">int</span> <span class="n">actual</span><span class="p">,</span>
<a name="c0-331"></a><span class="lineno">331</span>            <span class="n">errcode_t</span> <span class="n">error</span> <span class="n">ATTR</span><span class="p">((</span><span class="n">unused</span><span class="p">)))</span>
<a name="c0-332"></a><span class="lineno">332</span> <span class="p">{</span>
<a name="c0-333"></a><span class="lineno">333</span>  <span class="n">actual_size</span> <span class="o">=</span> <span class="n">actual</span><span class="p">;</span>
<a name="c0-334"></a><span class="lineno">334</span>  <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<a name="c0-335"></a><span class="lineno">335</span> <span class="p">}</span>
<a name="c0-336"></a><span class="lineno">336</span> 
<a name="c0-337"></a><span class="lineno">337</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">undo_err_handler_init</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">)</span>
<a name="c0-338"></a><span class="lineno">338</span> <span class="p">{</span>
<a name="c0-339"></a><span class="lineno">339</span>  <span class="n">channel</span><span class="o">-&gt;</span><span class="n">read_error</span> <span class="o">=</span> <span class="n">undo_io_read_error</span><span class="p">;</span>
<a name="c0-340"></a><span class="lineno">340</span> <span class="p">}</span>
<a name="c0-341"></a><span class="lineno">341</span> 
<a name="c0-342"></a><span class="lineno">342</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">io_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<a name="c0-343"></a><span class="lineno">343</span> <span class="p">{</span>
<a name="c0-344"></a><span class="lineno">344</span>  <span class="n">io_channel</span> <span class="n">io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-345"></a><span class="lineno">345</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-346"></a><span class="lineno">346</span>  <span class="n">errcode_t</span>  <span class="n">retval</span><span class="p">;</span>
<a name="c0-347"></a><span class="lineno">347</span> 
<a name="c0-348"></a><span class="lineno">348</span>  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-349"></a><span class="lineno">349</span>    <span class="k">return</span> <span class="n">EXT2_ET_BAD_DEVICE_NAME</span><span class="p">;</span>
<a name="c0-350"></a><span class="lineno">350</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">struct_io_channel</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
<a name="c0-351"></a><span class="lineno">351</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-352"></a><span class="lineno">352</span>    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-353"></a><span class="lineno">353</span>  <span class="n">memset</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">struct_io_channel</span><span class="p">));</span>
<a name="c0-354"></a><span class="lineno">354</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">;</span>
<a name="c0-355"></a><span class="lineno">355</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<a name="c0-356"></a><span class="lineno">356</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-357"></a><span class="lineno">357</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-358"></a><span class="lineno">358</span> 
<a name="c0-359"></a><span class="lineno">359</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">=</span> <span class="n">undo_io_manager</span><span class="p">;</span>
<a name="c0-360"></a><span class="lineno">360</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-361"></a><span class="lineno">361</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-362"></a><span class="lineno">362</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-363"></a><span class="lineno">363</span> 
<a name="c0-364"></a><span class="lineno">364</span>  <span class="n">strcpy</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-365"></a><span class="lineno">365</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<a name="c0-366"></a><span class="lineno">366</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c0-367"></a><span class="lineno">367</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">read_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-368"></a><span class="lineno">368</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">write_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-369"></a><span class="lineno">369</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-370"></a><span class="lineno">370</span> 
<a name="c0-371"></a><span class="lineno">371</span>  <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span><span class="p">));</span>
<a name="c0-372"></a><span class="lineno">372</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">;</span>
<a name="c0-373"></a><span class="lineno">373</span> 
<a name="c0-374"></a><span class="lineno">374</span>  <span class="k">if</span> <span class="p">(</span><span class="n">undo_io_backing_manager</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-375"></a><span class="lineno">375</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">undo_io_backing_manager</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
<a name="c0-376"></a><span class="lineno">376</span>                   <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">);</span>
<a name="c0-377"></a><span class="lineno">377</span>    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-378"></a><span class="lineno">378</span>      <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-379"></a><span class="lineno">379</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-380"></a><span class="lineno">380</span>    <span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-381"></a><span class="lineno">381</span>  <span class="p">}</span>
<a name="c0-382"></a><span class="lineno">382</span> 
<a name="c0-383"></a><span class="lineno">383</span>  <span class="cm">/* setup the tdb file */</span>
<a name="c0-384"></a><span class="lineno">384</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span> <span class="o">=</span> <span class="n">tdb_open</span><span class="p">(</span><span class="n">tdb_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TDB_CLEAR_IF_FIRST</span><span class="p">,</span>
<a name="c0-385"></a><span class="lineno">385</span>           <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">O_EXCL</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<a name="c0-386"></a><span class="lineno">386</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-387"></a><span class="lineno">387</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="c0-388"></a><span class="lineno">388</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-389"></a><span class="lineno">389</span>  <span class="p">}</span>
<a name="c0-390"></a><span class="lineno">390</span> 
<a name="c0-391"></a><span class="lineno">391</span>  <span class="cm">/*</span>
<a name="c0-392"></a><span class="lineno">392</span> <span class="cm">   * setup err handler for read so that we know</span>
<a name="c0-393"></a><span class="lineno">393</span> <span class="cm">   * when the backing manager fails do short read</span>
<a name="c0-394"></a><span class="lineno">394</span> <span class="cm">   */</span>
<a name="c0-395"></a><span class="lineno">395</span>  <span class="n">undo_err_handler_init</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">);</span>
<a name="c0-396"></a><span class="lineno">396</span> 
<a name="c0-397"></a><span class="lineno">397</span>  <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
<a name="c0-398"></a><span class="lineno">398</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-399"></a><span class="lineno">399</span> 
<a name="c0-400"></a><span class="lineno">400</span> <span class="nl">cleanup:</span>
<a name="c0-401"></a><span class="lineno">401</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">)</span>
<a name="c0-402"></a><span class="lineno">402</span>    <span class="n">io_channel_close</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">);</span>
<a name="c0-403"></a><span class="lineno">403</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a name="c0-404"></a><span class="lineno">404</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<a name="c0-405"></a><span class="lineno">405</span>  <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span>
<a name="c0-406"></a><span class="lineno">406</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
<a name="c0-407"></a><span class="lineno">407</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-408"></a><span class="lineno">408</span> <span class="p">}</span>
<a name="c0-409"></a><span class="lineno">409</span> 
<a name="c0-410"></a><span class="lineno">410</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_close</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">)</span>
<a name="c0-411"></a><span class="lineno">411</span> <span class="p">{</span>
<a name="c0-412"></a><span class="lineno">412</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-413"></a><span class="lineno">413</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-414"></a><span class="lineno">414</span> 
<a name="c0-415"></a><span class="lineno">415</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-416"></a><span class="lineno">416</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-417"></a><span class="lineno">417</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-418"></a><span class="lineno">418</span> 
<a name="c0-419"></a><span class="lineno">419</span>  <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-420"></a><span class="lineno">420</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-421"></a><span class="lineno">421</span>  <span class="cm">/* Before closing write the file system identity */</span>
<a name="c0-422"></a><span class="lineno">422</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">write_file_system_identity</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-423"></a><span class="lineno">423</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-424"></a><span class="lineno">424</span>    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-425"></a><span class="lineno">425</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">)</span>
<a name="c0-426"></a><span class="lineno">426</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_close</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">);</span>
<a name="c0-427"></a><span class="lineno">427</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">)</span>
<a name="c0-428"></a><span class="lineno">428</span>    <span class="n">tdb_close</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb</span><span class="p">);</span>
<a name="c0-429"></a><span class="lineno">429</span>  <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
<a name="c0-430"></a><span class="lineno">430</span>  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
<a name="c0-431"></a><span class="lineno">431</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-432"></a><span class="lineno">432</span>  <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">);</span>
<a name="c0-433"></a><span class="lineno">433</span> 
<a name="c0-434"></a><span class="lineno">434</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-435"></a><span class="lineno">435</span> <span class="p">}</span>
<a name="c0-436"></a><span class="lineno">436</span> 
<a name="c0-437"></a><span class="lineno">437</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_set_blksize</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">)</span>
<a name="c0-438"></a><span class="lineno">438</span> <span class="p">{</span>
<a name="c0-439"></a><span class="lineno">439</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-440"></a><span class="lineno">440</span>  <span class="n">errcode_t</span>    <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-441"></a><span class="lineno">441</span> 
<a name="c0-442"></a><span class="lineno">442</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-443"></a><span class="lineno">443</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-444"></a><span class="lineno">444</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-445"></a><span class="lineno">445</span> 
<a name="c0-446"></a><span class="lineno">446</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">)</span>
<a name="c0-447"></a><span class="lineno">447</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_set_blksize</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>
<a name="c0-448"></a><span class="lineno">448</span>  <span class="cm">/*</span>
<a name="c0-449"></a><span class="lineno">449</span> <span class="cm">   * Set the block size used for tdb</span>
<a name="c0-450"></a><span class="lineno">450</span> <span class="cm">   */</span>
<a name="c0-451"></a><span class="lineno">451</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-452"></a><span class="lineno">452</span>    <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
<a name="c0-453"></a><span class="lineno">453</span>  <span class="p">}</span>
<a name="c0-454"></a><span class="lineno">454</span>  <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
<a name="c0-455"></a><span class="lineno">455</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-456"></a><span class="lineno">456</span> <span class="p">}</span>
<a name="c0-457"></a><span class="lineno">457</span> 
<a name="c0-458"></a><span class="lineno">458</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_read_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c0-459"></a><span class="lineno">459</span>             <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-460"></a><span class="lineno">460</span> <span class="p">{</span>
<a name="c0-461"></a><span class="lineno">461</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-462"></a><span class="lineno">462</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-463"></a><span class="lineno">463</span> 
<a name="c0-464"></a><span class="lineno">464</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-465"></a><span class="lineno">465</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-466"></a><span class="lineno">466</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-467"></a><span class="lineno">467</span> 
<a name="c0-468"></a><span class="lineno">468</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">)</span>
<a name="c0-469"></a><span class="lineno">469</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_read_blk</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c0-470"></a><span class="lineno">470</span> 
<a name="c0-471"></a><span class="lineno">471</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-472"></a><span class="lineno">472</span> <span class="p">}</span>
<a name="c0-473"></a><span class="lineno">473</span> 
<a name="c0-474"></a><span class="lineno">474</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_write_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c0-475"></a><span class="lineno">475</span>        <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-476"></a><span class="lineno">476</span> <span class="p">{</span>
<a name="c0-477"></a><span class="lineno">477</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-478"></a><span class="lineno">478</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-479"></a><span class="lineno">479</span> 
<a name="c0-480"></a><span class="lineno">480</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-481"></a><span class="lineno">481</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-482"></a><span class="lineno">482</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-483"></a><span class="lineno">483</span>  <span class="cm">/*</span>
<a name="c0-484"></a><span class="lineno">484</span> <span class="cm">   * First write the existing content into database</span>
<a name="c0-485"></a><span class="lineno">485</span> <span class="cm">   */</span>
<a name="c0-486"></a><span class="lineno">486</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">undo_write_tdb</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<a name="c0-487"></a><span class="lineno">487</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-488"></a><span class="lineno">488</span>     <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-489"></a><span class="lineno">489</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">)</span>
<a name="c0-490"></a><span class="lineno">490</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_write_blk</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c0-491"></a><span class="lineno">491</span> 
<a name="c0-492"></a><span class="lineno">492</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-493"></a><span class="lineno">493</span> <span class="p">}</span>
<a name="c0-494"></a><span class="lineno">494</span> 
<a name="c0-495"></a><span class="lineno">495</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_write_byte</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
<a name="c0-496"></a><span class="lineno">496</span>         <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-497"></a><span class="lineno">497</span> <span class="p">{</span>
<a name="c0-498"></a><span class="lineno">498</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-499"></a><span class="lineno">499</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-500"></a><span class="lineno">500</span>  <span class="n">ext2_loff_t</span>  <span class="n">location</span><span class="p">;</span>
<a name="c0-501"></a><span class="lineno">501</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blk_num</span><span class="p">,</span> <span class="n">count</span><span class="p">;;</span>
<a name="c0-502"></a><span class="lineno">502</span> 
<a name="c0-503"></a><span class="lineno">503</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-504"></a><span class="lineno">504</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-505"></a><span class="lineno">505</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-506"></a><span class="lineno">506</span> 
<a name="c0-507"></a><span class="lineno">507</span>  <span class="n">location</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="c0-508"></a><span class="lineno">508</span>  <span class="n">blk_num</span> <span class="o">=</span> <span class="n">location</span><span class="o">/</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-509"></a><span class="lineno">509</span>  <span class="cm">/*</span>
<a name="c0-510"></a><span class="lineno">510</span> <span class="cm">   * the size specified may spread across multiple blocks</span>
<a name="c0-511"></a><span class="lineno">511</span> <span class="cm">   * also make sure we account for the fact that block start</span>
<a name="c0-512"></a><span class="lineno">512</span> <span class="cm">   * offset for tdb is different from the backing I/O manager</span>
<a name="c0-513"></a><span class="lineno">513</span> <span class="cm">   * due to possible different block size</span>
<a name="c0-514"></a><span class="lineno">514</span> <span class="cm">   */</span>
<a name="c0-515"></a><span class="lineno">515</span>  <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="n">location</span> <span class="o">%</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">+</span>
<a name="c0-516"></a><span class="lineno">516</span>      <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span>  <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c0-517"></a><span class="lineno">517</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">undo_write_tdb</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">blk_num</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<a name="c0-518"></a><span class="lineno">518</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c0-519"></a><span class="lineno">519</span>    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-520"></a><span class="lineno">520</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">)</span>
<a name="c0-521"></a><span class="lineno">521</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_write_byte</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c0-522"></a><span class="lineno">522</span> 
<a name="c0-523"></a><span class="lineno">523</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-524"></a><span class="lineno">524</span> <span class="p">}</span>
<a name="c0-525"></a><span class="lineno">525</span> 
<a name="c0-526"></a><span class="lineno">526</span> <span class="cm">/*</span>
<a name="c0-527"></a><span class="lineno">527</span> <span class="cm"> * Flush data buffers to disk.</span>
<a name="c0-528"></a><span class="lineno">528</span> <span class="cm"> */</span>
<a name="c0-529"></a><span class="lineno">529</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_flush</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">)</span>
<a name="c0-530"></a><span class="lineno">530</span> <span class="p">{</span>
<a name="c0-531"></a><span class="lineno">531</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-532"></a><span class="lineno">532</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-533"></a><span class="lineno">533</span> 
<a name="c0-534"></a><span class="lineno">534</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-535"></a><span class="lineno">535</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-536"></a><span class="lineno">536</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-537"></a><span class="lineno">537</span> 
<a name="c0-538"></a><span class="lineno">538</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">)</span>
<a name="c0-539"></a><span class="lineno">539</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">io_channel_flush</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">);</span>
<a name="c0-540"></a><span class="lineno">540</span> 
<a name="c0-541"></a><span class="lineno">541</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-542"></a><span class="lineno">542</span> <span class="p">}</span>
<a name="c0-543"></a><span class="lineno">543</span> 
<a name="c0-544"></a><span class="lineno">544</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">undo_set_option</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">,</span>
<a name="c0-545"></a><span class="lineno">545</span>         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<a name="c0-546"></a><span class="lineno">546</span> <span class="p">{</span>
<a name="c0-547"></a><span class="lineno">547</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-548"></a><span class="lineno">548</span>  <span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-549"></a><span class="lineno">549</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
<a name="c0-550"></a><span class="lineno">550</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c0-551"></a><span class="lineno">551</span> 
<a name="c0-552"></a><span class="lineno">552</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-553"></a><span class="lineno">553</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">undo_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c0-554"></a><span class="lineno">554</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c0-555"></a><span class="lineno">555</span> 
<a name="c0-556"></a><span class="lineno">556</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"tdb_data_size"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-557"></a><span class="lineno">557</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
<a name="c0-558"></a><span class="lineno">558</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c0-559"></a><span class="lineno">559</span> 
<a name="c0-560"></a><span class="lineno">560</span>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-561"></a><span class="lineno">561</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<a name="c0-562"></a><span class="lineno">562</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c0-563"></a><span class="lineno">563</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_written</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-564"></a><span class="lineno">564</span>      <span class="n">data</span><span class="o">-&gt;</span><span class="n">tdb_data_size</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<a name="c0-565"></a><span class="lineno">565</span>    <span class="p">}</span>
<a name="c0-566"></a><span class="lineno">566</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-567"></a><span class="lineno">567</span>  <span class="p">}</span>
<a name="c0-568"></a><span class="lineno">568</span>  <span class="cm">/*</span>
<a name="c0-569"></a><span class="lineno">569</span> <span class="cm">   * Need to support offset option to work with</span>
<a name="c0-570"></a><span class="lineno">570</span> <span class="cm">   * Unix I/O manager</span>
<a name="c0-571"></a><span class="lineno">571</span> <span class="cm">   */</span>
<a name="c0-572"></a><span class="lineno">572</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_option</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-573"></a><span class="lineno">573</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="o">-&gt;</span><span class="n">manager</span><span class="o">-&gt;</span><span class="n">set_option</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">real</span><span class="p">,</span>
<a name="c0-574"></a><span class="lineno">574</span>              <span class="n">option</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-575"></a><span class="lineno">575</span>  <span class="p">}</span>
<a name="c0-576"></a><span class="lineno">576</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"offset"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-577"></a><span class="lineno">577</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
<a name="c0-578"></a><span class="lineno">578</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c0-579"></a><span class="lineno">579</span> 
<a name="c0-580"></a><span class="lineno">580</span>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-581"></a><span class="lineno">581</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<a name="c0-582"></a><span class="lineno">582</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c0-583"></a><span class="lineno">583</span>    <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<a name="c0-584"></a><span class="lineno">584</span>  <span class="p">}</span>
<a name="c0-585"></a><span class="lineno">585</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-586"></a><span class="lineno">586</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> lib/ext2fs/unix_io.c 
                <small> (92,9)-(110,8)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 716px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">  1</span> <span class="cm">/*</span>
<a name="c1-2"></a><span class="lineno">  2</span> <span class="cm"> * unix_io.c --- This is the Unix (well, really POSIX) implementation</span>
<a name="c1-3"></a><span class="lineno">  3</span> <span class="cm"> *  of the I/O manager.</span>
<a name="c1-4"></a><span class="lineno">  4</span> <span class="cm"> *</span>
<a name="c1-5"></a><span class="lineno">  5</span> <span class="cm"> * Implements a one-block write-through cache.</span>
<a name="c1-6"></a><span class="lineno">  6</span> <span class="cm"> *</span>
<a name="c1-7"></a><span class="lineno">  7</span> <span class="cm"> * Includes support for Windows NT support under Cygwin.</span>
<a name="c1-8"></a><span class="lineno">  8</span> <span class="cm"> *</span>
<a name="c1-9"></a><span class="lineno">  9</span> <span class="cm"> * Copyright (C) 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001,</span>
<a name="c1-10"></a><span class="lineno"> 10</span> <span class="cm"> *   2002 by Theodore Ts'o.</span>
<a name="c1-11"></a><span class="lineno"> 11</span> <span class="cm"> *</span>
<a name="c1-12"></a><span class="lineno"> 12</span> <span class="cm"> * %Begin-Header%</span>
<a name="c1-13"></a><span class="lineno"> 13</span> <span class="cm"> * This file may be redistributed under the terms of the GNU Library</span>
<a name="c1-14"></a><span class="lineno"> 14</span> <span class="cm"> * General Public License, version 2.</span>
<a name="c1-15"></a><span class="lineno"> 15</span> <span class="cm"> * %End-Header%</span>
<a name="c1-16"></a><span class="lineno"> 16</span> <span class="cm"> */</span>
<a name="c1-17"></a><span class="lineno"> 17</span> 
<a name="c1-18"></a><span class="lineno"> 18</span> <span class="cp">#define _LARGEFILE_SOURCE</span>
<a name="c1-19"></a><span class="lineno"> 19</span> <span class="cp">#define _LARGEFILE64_SOURCE</span>
<a name="c1-20"></a><span class="lineno"> 20</span> <span class="cp">#define _GNU_SOURCE</span>
<a name="c1-21"></a><span class="lineno"> 21</span> 
<a name="c1-22"></a><span class="lineno"> 22</span> <span class="cp">#include &lt;stdio.h&gt;</span>
<a name="c1-23"></a><span class="lineno"> 23</span> <span class="cp">#include &lt;string.h&gt;</span>
<a name="c1-24"></a><span class="lineno"> 24</span> <span class="cp">#if HAVE_UNISTD_H</span>
<a name="c1-25"></a><span class="lineno"> 25</span> <span class="cp">#include &lt;unistd.h&gt;</span>
<a name="c1-26"></a><span class="lineno"> 26</span> <span class="cp">#endif</span>
<a name="c1-27"></a><span class="lineno"> 27</span> <span class="cp">#if HAVE_ERRNO_H</span>
<a name="c1-28"></a><span class="lineno"> 28</span> <span class="cp">#include &lt;errno.h&gt;</span>
<a name="c1-29"></a><span class="lineno"> 29</span> <span class="cp">#endif</span>
<a name="c1-30"></a><span class="lineno"> 30</span> <span class="cp">#include &lt;fcntl.h&gt;</span>
<a name="c1-31"></a><span class="lineno"> 31</span> <span class="cp">#include &lt;time.h&gt;</span>
<a name="c1-32"></a><span class="lineno"> 32</span> <span class="cp">#ifdef __linux__</span>
<a name="c1-33"></a><span class="lineno"> 33</span> <span class="cp">#include &lt;sys/utsname.h&gt;</span>
<a name="c1-34"></a><span class="lineno"> 34</span> <span class="cp">#endif</span>
<a name="c1-35"></a><span class="lineno"> 35</span> <span class="cp">#ifdef HAVE_SYS_IOCTL_H</span>
<a name="c1-36"></a><span class="lineno"> 36</span> <span class="cp">#include &lt;sys/ioctl.h&gt;</span>
<a name="c1-37"></a><span class="lineno"> 37</span> <span class="cp">#endif</span>
<a name="c1-38"></a><span class="lineno"> 38</span> <span class="cp">#ifdef HAVE_SYS_MOUNT_H</span>
<a name="c1-39"></a><span class="lineno"> 39</span> <span class="cp">#include &lt;sys/mount.h&gt;</span>
<a name="c1-40"></a><span class="lineno"> 40</span> <span class="cp">#endif</span>
<a name="c1-41"></a><span class="lineno"> 41</span> <span class="cp">#if HAVE_SYS_STAT_H</span>
<a name="c1-42"></a><span class="lineno"> 42</span> <span class="cp">#include &lt;sys/stat.h&gt;</span>
<a name="c1-43"></a><span class="lineno"> 43</span> <span class="cp">#endif</span>
<a name="c1-44"></a><span class="lineno"> 44</span> <span class="cp">#if HAVE_SYS_TYPES_H</span>
<a name="c1-45"></a><span class="lineno"> 45</span> <span class="cp">#include &lt;sys/types.h&gt;</span>
<a name="c1-46"></a><span class="lineno"> 46</span> <span class="cp">#endif</span>
<a name="c1-47"></a><span class="lineno"> 47</span> <span class="cp">#if HAVE_SYS_RESOURCE_H</span>
<a name="c1-48"></a><span class="lineno"> 48</span> <span class="cp">#include &lt;sys/resource.h&gt;</span>
<a name="c1-49"></a><span class="lineno"> 49</span> <span class="cp">#endif</span>
<a name="c1-50"></a><span class="lineno"> 50</span> 
<a name="c1-51"></a><span class="lineno"> 51</span> <span class="cp">#if defined(__linux__) &amp;&amp; defined(_IO) &amp;&amp; !defined(BLKROGET)</span>
<a name="c1-52"></a><span class="lineno"> 52</span> <span class="cp">#define BLKROGET   _IO(0x12, 94) </span><span class="cm">/* Get read-only status (0 = read_write).  */</span><span class="cp"></span>
<a name="c1-53"></a><span class="lineno"> 53</span> <span class="cp">#endif</span>
<a name="c1-54"></a><span class="lineno"> 54</span> 
<a name="c1-55"></a><span class="lineno"> 55</span> <span class="cp">#if defined(__linux__) &amp;&amp; defined(_IO) &amp;&amp; !defined(BLKSSZGET)</span>
<a name="c1-56"></a><span class="lineno"> 56</span> <span class="cp">#define BLKSSZGET  _IO(0x12,104)</span><span class="cm">/* get block device sector size */</span><span class="cp"></span>
<a name="c1-57"></a><span class="lineno"> 57</span> <span class="cp">#endif</span>
<a name="c1-58"></a><span class="lineno"> 58</span> 
<a name="c1-59"></a><span class="lineno"> 59</span> <span class="cp">#undef ALIGN_DEBUG</span>
<a name="c1-60"></a><span class="lineno"> 60</span> 
<a name="c1-61"></a><span class="lineno"> 61</span> <span class="cp">#include "ext2_fs.h"</span>
<a name="c1-62"></a><span class="lineno"> 62</span> <span class="cp">#include "ext2fs.h"</span>
<a name="c1-63"></a><span class="lineno"> 63</span> 
<a name="c1-64"></a><span class="lineno"> 64</span> <span class="cm">/*</span>
<a name="c1-65"></a><span class="lineno"> 65</span> <span class="cm"> * For checking structure magic numbers...</span>
<a name="c1-66"></a><span class="lineno"> 66</span> <span class="cm"> */</span>
<a name="c1-67"></a><span class="lineno"> 67</span> 
<a name="c1-68"></a><span class="lineno"> 68</span> <span class="cp">#define EXT2_CHECK_MAGIC(struct, code) \</span>
<a name="c1-69"></a><span class="lineno"> 69</span> <span class="cp">   if ((struct)-&gt;magic != (code)) return (code)</span>
<a name="c1-70"></a><span class="lineno"> 70</span> 
<a name="c1-71"></a><span class="lineno"> 71</span> <span class="k">struct</span> <span class="n">unix_cache</span> <span class="p">{</span>
<a name="c1-72"></a><span class="lineno"> 72</span>   <span class="kt">char</span>    <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-73"></a><span class="lineno"> 73</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">;</span>
<a name="c1-74"></a><span class="lineno"> 74</span>   <span class="kt">int</span>   <span class="n">access_time</span><span class="p">;</span>
<a name="c1-75"></a><span class="lineno"> 75</span>   <span class="kt">unsigned</span>  <span class="n">dirty</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-76"></a><span class="lineno"> 76</span>   <span class="kt">unsigned</span>  <span class="n">in_use</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-77"></a><span class="lineno"> 77</span> <span class="p">};</span>
<a name="c1-78"></a><span class="lineno"> 78</span> 
<a name="c1-79"></a><span class="lineno"> 79</span> <span class="cp">#define CACHE_SIZE 8</span>
<a name="c1-80"></a><span class="lineno"> 80</span> <span class="cp">#define WRITE_DIRECT_SIZE 4  </span><span class="cm">/* Must be smaller than CACHE_SIZE */</span><span class="cp"></span>
<a name="c1-81"></a><span class="lineno"> 81</span> <span class="cp">#define READ_DIRECT_SIZE 4 </span><span class="cm">/* Should be smaller than CACHE_SIZE */</span><span class="cp"></span>
<a name="c1-82"></a><span class="lineno"> 82</span> 
<a name="c1-83"></a><span class="lineno"> 83</span> <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="p">{</span>
<a name="c1-84"></a><span class="lineno"> 84</span>   <span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>
<a name="c1-85"></a><span class="lineno"> 85</span>   <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
<a name="c1-86"></a><span class="lineno"> 86</span>   <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="c1-87"></a><span class="lineno"> 87</span>   <span class="kt">int</span> <span class="n">align</span><span class="p">;</span>
<a name="c1-88"></a><span class="lineno"> 88</span>   <span class="kt">int</span> <span class="n">access_time</span><span class="p">;</span>
<a name="c1-89"></a><span class="lineno"> 89</span>   <span class="n">ext2_loff_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c1-90"></a><span class="lineno"> 90</span>   <span class="k">struct</span> <span class="n">unix_cache</span> <span class="n">cache</span><span class="p">[</span><span class="n">CACHE_SIZE</span><span class="p">];</span>
<a name="c1-91"></a><span class="lineno"> 91</span>   <span class="kt">void</span>  <span class="o">*</span><span class="n">bounce</span><span class="p">;</span>
<a name="c1-92"></a><span class="lineno"> 92</span> <span class="hll">  <span class="k">struct</span> <span class="n">struct_io_stats</span> <span class="n">io_stats</span><span class="p">;</span>
</span><a name="c1-93"></a><span class="lineno"> 93</span> <span class="hll"><span class="p">};</span>
</span><a name="c1-94"></a><span class="lineno"> 94</span> <span class="hll">
</span><a name="c1-95"></a><span class="lineno"> 95</span> <span class="hll"><span class="cp">#define IS_ALIGNED(n, align) ((((unsigned long) n) &amp; \</span>
</span><a name="c1-96"></a><span class="lineno"> 96</span> <span class="hll"><span class="cp">             ((unsigned long) ((align)-1))) == 0)</span>
</span><a name="c1-97"></a><span class="lineno"> 97</span> <span class="hll">
</span><a name="c1-98"></a><span class="lineno"> 98</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">io_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">);</span>
</span><a name="c1-99"></a><span class="lineno"> 99</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_close</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">);</span>
</span><a name="c1-100"></a><span class="lineno">100</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_set_blksize</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">);</span>
</span><a name="c1-101"></a><span class="lineno">101</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_read_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
</span><a name="c1-102"></a><span class="lineno">102</span> <span class="hll">             <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><a name="c1-103"></a><span class="lineno">103</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_write_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
</span><a name="c1-104"></a><span class="lineno">104</span> <span class="hll">        <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><a name="c1-105"></a><span class="lineno">105</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_flush</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">);</span>
</span><a name="c1-106"></a><span class="lineno">106</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_write_byte</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
</span><a name="c1-107"></a><span class="lineno">107</span> <span class="hll">        <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><a name="c1-108"></a><span class="lineno">108</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_set_option</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">,</span>
</span><a name="c1-109"></a><span class="lineno">109</span> <span class="hll">         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</span><a name="c1-110"></a><span class="lineno">110</span> <span class="hll"><span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_get_stats</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">io_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
</span><a name="c1-111"></a><span class="lineno">111</span> <span class="p">;</span>
<a name="c1-112"></a><span class="lineno">112</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">reuse_cache</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
<a name="c1-113"></a><span class="lineno">113</span>     <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">);</span>
<a name="c1-114"></a><span class="lineno">114</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_read_blk64</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-115"></a><span class="lineno">115</span>             <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<a name="c1-116"></a><span class="lineno">116</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="n">unix_write_blk64</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-117"></a><span class="lineno">117</span>        <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<a name="c1-118"></a><span class="lineno">118</span> 
<a name="c1-119"></a><span class="lineno">119</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">struct_io_manager</span> <span class="n">struct_unix_manager</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-120"></a><span class="lineno">120</span>  <span class="n">EXT2_ET_MAGIC_IO_MANAGER</span><span class="p">,</span>
<a name="c1-121"></a><span class="lineno">121</span>  <span class="s">"Unix I/O Manager"</span><span class="p">,</span>
<a name="c1-122"></a><span class="lineno">122</span>  <span class="n">unix_open</span><span class="p">,</span>
<a name="c1-123"></a><span class="lineno">123</span>  <span class="n">unix_close</span><span class="p">,</span>
<a name="c1-124"></a><span class="lineno">124</span>  <span class="n">unix_set_blksize</span><span class="p">,</span>
<a name="c1-125"></a><span class="lineno">125</span>  <span class="n">unix_read_blk</span><span class="p">,</span>
<a name="c1-126"></a><span class="lineno">126</span>  <span class="n">unix_write_blk</span><span class="p">,</span>
<a name="c1-127"></a><span class="lineno">127</span>  <span class="n">unix_flush</span><span class="p">,</span>
<a name="c1-128"></a><span class="lineno">128</span>  <span class="n">unix_write_byte</span><span class="p">,</span>
<a name="c1-129"></a><span class="lineno">129</span>  <span class="n">unix_set_option</span><span class="p">,</span>
<a name="c1-130"></a><span class="lineno">130</span>  <span class="n">unix_get_stats</span><span class="p">,</span>
<a name="c1-131"></a><span class="lineno">131</span>  <span class="n">unix_read_blk64</span><span class="p">,</span>
<a name="c1-132"></a><span class="lineno">132</span>  <span class="n">unix_write_blk64</span><span class="p">,</span>
<a name="c1-133"></a><span class="lineno">133</span> <span class="p">};</span>
<a name="c1-134"></a><span class="lineno">134</span> 
<a name="c1-135"></a><span class="lineno">135</span> <span class="n">io_manager</span> <span class="n">unix_io_manager</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">struct_unix_manager</span><span class="p">;</span>
<a name="c1-136"></a><span class="lineno">136</span> 
<a name="c1-137"></a><span class="lineno">137</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_get_stats</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="n">io_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<a name="c1-138"></a><span class="lineno">138</span> <span class="p">{</span>
<a name="c1-139"></a><span class="lineno">139</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-140"></a><span class="lineno">140</span> 
<a name="c1-141"></a><span class="lineno">141</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-142"></a><span class="lineno">142</span> 
<a name="c1-143"></a><span class="lineno">143</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-144"></a><span class="lineno">144</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-145"></a><span class="lineno">145</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-146"></a><span class="lineno">146</span> 
<a name="c1-147"></a><span class="lineno">147</span>  <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<a name="c1-148"></a><span class="lineno">148</span>    <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">;</span>
<a name="c1-149"></a><span class="lineno">149</span> 
<a name="c1-150"></a><span class="lineno">150</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-151"></a><span class="lineno">151</span> <span class="p">}</span>
<a name="c1-152"></a><span class="lineno">152</span> 
<a name="c1-153"></a><span class="lineno">153</span> <span class="cm">/*</span>
<a name="c1-154"></a><span class="lineno">154</span> <span class="cm"> * Here are the raw I/O functions</span>
<a name="c1-155"></a><span class="lineno">155</span> <span class="cm"> */</span>
<a name="c1-156"></a><span class="lineno">156</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">raw_read_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span>
<a name="c1-157"></a><span class="lineno">157</span>            <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
<a name="c1-158"></a><span class="lineno">158</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-159"></a><span class="lineno">159</span>            <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-160"></a><span class="lineno">160</span> <span class="p">{</span>
<a name="c1-161"></a><span class="lineno">161</span>  <span class="n">errcode_t</span>  <span class="n">retval</span><span class="p">;</span>
<a name="c1-162"></a><span class="lineno">162</span>  <span class="kt">ssize_t</span>   <span class="n">size</span><span class="p">;</span>
<a name="c1-163"></a><span class="lineno">163</span>  <span class="n">ext2_loff_t</span>  <span class="n">location</span><span class="p">;</span>
<a name="c1-164"></a><span class="lineno">164</span>  <span class="kt">int</span>   <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-165"></a><span class="lineno">165</span> 
<a name="c1-166"></a><span class="lineno">166</span>  <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">count</span> <span class="o">:</span> <span class="n">count</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-167"></a><span class="lineno">167</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<a name="c1-168"></a><span class="lineno">168</span>  <span class="n">location</span> <span class="o">=</span> <span class="p">((</span><span class="n">ext2_loff_t</span><span class="p">)</span> <span class="n">block</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="c1-169"></a><span class="lineno">169</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ext2fs_llseek</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">!=</span> <span class="n">location</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-170"></a><span class="lineno">170</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">errno</span> <span class="o">?</span> <span class="n">errno</span> <span class="o">:</span> <span class="n">EXT2_ET_LLSEEK_FAILED</span><span class="p">;</span>
<a name="c1-171"></a><span class="lineno">171</span>    <span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
<a name="c1-172"></a><span class="lineno">172</span>  <span class="p">}</span>
<a name="c1-173"></a><span class="lineno">173</span>  <span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-174"></a><span class="lineno">174</span>      <span class="p">((</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-175"></a><span class="lineno">175</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c1-176"></a><span class="lineno">176</span>    <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-177"></a><span class="lineno">177</span>    <span class="nl">short_read:</span>
<a name="c1-178"></a><span class="lineno">178</span>      <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-179"></a><span class="lineno">179</span>        <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-180"></a><span class="lineno">180</span>      <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_SHORT_READ</span><span class="p">;</span>
<a name="c1-181"></a><span class="lineno">181</span>      <span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
<a name="c1-182"></a><span class="lineno">182</span>    <span class="p">}</span>
<a name="c1-183"></a><span class="lineno">183</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-184"></a><span class="lineno">184</span>  <span class="p">}</span>
<a name="c1-185"></a><span class="lineno">185</span> 
<a name="c1-186"></a><span class="lineno">186</span> <span class="cp">#ifdef ALIGN_DEBUG</span>
<a name="c1-187"></a><span class="lineno">187</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"raw_read_blk: O_DIRECT fallback: %p %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
<a name="c1-188"></a><span class="lineno">188</span>         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span><span class="p">);</span>
<a name="c1-189"></a><span class="lineno">189</span> <span class="cp">#endif</span>
<a name="c1-190"></a><span class="lineno">190</span> 
<a name="c1-191"></a><span class="lineno">191</span>  <span class="cm">/*</span>
<a name="c1-192"></a><span class="lineno">192</span> <span class="cm">   * The buffer or size which we're trying to read isn't aligned</span>
<a name="c1-193"></a><span class="lineno">193</span> <span class="cm">   * to the O_DIRECT rules, so we need to do this the hard way...</span>
<a name="c1-194"></a><span class="lineno">194</span> <span class="cm">   */</span>
<a name="c1-195"></a><span class="lineno">195</span>  <span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-196"></a><span class="lineno">196</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-197"></a><span class="lineno">197</span>    <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
<a name="c1-198"></a><span class="lineno">198</span>      <span class="k">goto</span> <span class="n">short_read</span><span class="p">;</span>
<a name="c1-199"></a><span class="lineno">199</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c1-200"></a><span class="lineno">200</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
<a name="c1-201"></a><span class="lineno">201</span>      <span class="n">actual</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-202"></a><span class="lineno">202</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">,</span> <span class="n">actual</span><span class="p">);</span>
<a name="c1-203"></a><span class="lineno">203</span>    <span class="n">size</span> <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
<a name="c1-204"></a><span class="lineno">204</span>    <span class="n">buf</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
<a name="c1-205"></a><span class="lineno">205</span>  <span class="p">}</span>
<a name="c1-206"></a><span class="lineno">206</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-207"></a><span class="lineno">207</span> 
<a name="c1-208"></a><span class="lineno">208</span> <span class="nl">error_out:</span>
<a name="c1-209"></a><span class="lineno">209</span>  <span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="o">+</span><span class="n">actual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">actual</span><span class="p">);</span>
<a name="c1-210"></a><span class="lineno">210</span>  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">read_error</span><span class="p">)</span>
<a name="c1-211"></a><span class="lineno">211</span>    <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">read_error</span><span class="p">)(</span><span class="n">channel</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
<a name="c1-212"></a><span class="lineno">212</span>                 <span class="n">size</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<a name="c1-213"></a><span class="lineno">213</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-214"></a><span class="lineno">214</span> <span class="p">}</span>
<a name="c1-215"></a><span class="lineno">215</span> 
<a name="c1-216"></a><span class="lineno">216</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">raw_write_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span>
<a name="c1-217"></a><span class="lineno">217</span>             <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
<a name="c1-218"></a><span class="lineno">218</span>             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-219"></a><span class="lineno">219</span>             <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-220"></a><span class="lineno">220</span> <span class="p">{</span>
<a name="c1-221"></a><span class="lineno">221</span>  <span class="kt">ssize_t</span>   <span class="n">size</span><span class="p">;</span>
<a name="c1-222"></a><span class="lineno">222</span>  <span class="n">ext2_loff_t</span>  <span class="n">location</span><span class="p">;</span>
<a name="c1-223"></a><span class="lineno">223</span>  <span class="kt">int</span>   <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-224"></a><span class="lineno">224</span>  <span class="n">errcode_t</span>  <span class="n">retval</span><span class="p">;</span>
<a name="c1-225"></a><span class="lineno">225</span> 
<a name="c1-226"></a><span class="lineno">226</span>  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c1-227"></a><span class="lineno">227</span>    <span class="n">size</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-228"></a><span class="lineno">228</span>  <span class="k">else</span> <span class="p">{</span>
<a name="c1-229"></a><span class="lineno">229</span>    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-230"></a><span class="lineno">230</span>      <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="n">count</span><span class="p">;</span>
<a name="c1-231"></a><span class="lineno">231</span>    <span class="k">else</span>
<a name="c1-232"></a><span class="lineno">232</span>      <span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-233"></a><span class="lineno">233</span>  <span class="p">}</span>
<a name="c1-234"></a><span class="lineno">234</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">.</span><span class="n">bytes_written</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<a name="c1-235"></a><span class="lineno">235</span> 
<a name="c1-236"></a><span class="lineno">236</span>  <span class="n">location</span> <span class="o">=</span> <span class="p">((</span><span class="n">ext2_loff_t</span><span class="p">)</span> <span class="n">block</span> <span class="o">*</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<a name="c1-237"></a><span class="lineno">237</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ext2fs_llseek</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">!=</span> <span class="n">location</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-238"></a><span class="lineno">238</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">errno</span> <span class="o">?</span> <span class="n">errno</span> <span class="o">:</span> <span class="n">EXT2_ET_LLSEEK_FAILED</span><span class="p">;</span>
<a name="c1-239"></a><span class="lineno">239</span>    <span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
<a name="c1-240"></a><span class="lineno">240</span>  <span class="p">}</span>
<a name="c1-241"></a><span class="lineno">241</span> 
<a name="c1-242"></a><span class="lineno">242</span>  <span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-243"></a><span class="lineno">243</span>      <span class="p">((</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-244"></a><span class="lineno">244</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c1-245"></a><span class="lineno">245</span>    <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-246"></a><span class="lineno">246</span>    <span class="nl">short_write:</span>
<a name="c1-247"></a><span class="lineno">247</span>      <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_SHORT_WRITE</span><span class="p">;</span>
<a name="c1-248"></a><span class="lineno">248</span>      <span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
<a name="c1-249"></a><span class="lineno">249</span>    <span class="p">}</span>
<a name="c1-250"></a><span class="lineno">250</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-251"></a><span class="lineno">251</span>  <span class="p">}</span>
<a name="c1-252"></a><span class="lineno">252</span> 
<a name="c1-253"></a><span class="lineno">253</span> <span class="cp">#ifdef ALIGN_DEBUG</span>
<a name="c1-254"></a><span class="lineno">254</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"raw_write_blk: O_DIRECT fallback: %p %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
<a name="c1-255"></a><span class="lineno">255</span>         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span><span class="p">);</span>
<a name="c1-256"></a><span class="lineno">256</span> <span class="cp">#endif</span>
<a name="c1-257"></a><span class="lineno">257</span>  <span class="cm">/*</span>
<a name="c1-258"></a><span class="lineno">258</span> <span class="cm">   * The buffer or size which we're trying to write isn't aligned</span>
<a name="c1-259"></a><span class="lineno">259</span> <span class="cm">   * to the O_DIRECT rules, so we need to do this the hard way...</span>
<a name="c1-260"></a><span class="lineno">260</span> <span class="cm">   */</span>
<a name="c1-261"></a><span class="lineno">261</span>  <span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-262"></a><span class="lineno">262</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-263"></a><span class="lineno">263</span>      <span class="n">actual</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">,</span>
<a name="c1-264"></a><span class="lineno">264</span>              <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-265"></a><span class="lineno">265</span>      <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-266"></a><span class="lineno">266</span>        <span class="n">retval</span> <span class="o">=</span> <span class="n">EXT2_ET_SHORT_READ</span><span class="p">;</span>
<a name="c1-267"></a><span class="lineno">267</span>        <span class="k">goto</span> <span class="n">error_out</span><span class="p">;</span>
<a name="c1-268"></a><span class="lineno">268</span>      <span class="p">}</span>
<a name="c1-269"></a><span class="lineno">269</span>    <span class="p">}</span>
<a name="c1-270"></a><span class="lineno">270</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c1-271"></a><span class="lineno">271</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
<a name="c1-272"></a><span class="lineno">272</span>      <span class="n">actual</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-273"></a><span class="lineno">273</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">actual</span><span class="p">);</span>
<a name="c1-274"></a><span class="lineno">274</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-275"></a><span class="lineno">275</span>    <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span>
<a name="c1-276"></a><span class="lineno">276</span>      <span class="k">goto</span> <span class="n">short_write</span><span class="p">;</span>
<a name="c1-277"></a><span class="lineno">277</span>    <span class="n">size</span> <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
<a name="c1-278"></a><span class="lineno">278</span>    <span class="n">buf</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
<a name="c1-279"></a><span class="lineno">279</span>  <span class="p">}</span>
<a name="c1-280"></a><span class="lineno">280</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-281"></a><span class="lineno">281</span> 
<a name="c1-282"></a><span class="lineno">282</span> <span class="nl">error_out:</span>
<a name="c1-283"></a><span class="lineno">283</span>  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">write_error</span><span class="p">)</span>
<a name="c1-284"></a><span class="lineno">284</span>    <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">write_error</span><span class="p">)(</span><span class="n">channel</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
<a name="c1-285"></a><span class="lineno">285</span>            <span class="n">size</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<a name="c1-286"></a><span class="lineno">286</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-287"></a><span class="lineno">287</span> <span class="p">}</span>
<a name="c1-288"></a><span class="lineno">288</span> 
<a name="c1-289"></a><span class="lineno">289</span> 
<a name="c1-290"></a><span class="lineno">290</span> <span class="cm">/*</span>
<a name="c1-291"></a><span class="lineno">291</span> <span class="cm"> * Here we implement the cache functions</span>
<a name="c1-292"></a><span class="lineno">292</span> <span class="cm"> */</span>
<a name="c1-293"></a><span class="lineno">293</span> 
<a name="c1-294"></a><span class="lineno">294</span> <span class="cm">/* Allocate the cache buffers */</span>
<a name="c1-295"></a><span class="lineno">295</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">alloc_cache</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span>
<a name="c1-296"></a><span class="lineno">296</span>           <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-297"></a><span class="lineno">297</span> <span class="p">{</span>
<a name="c1-298"></a><span class="lineno">298</span>  <span class="n">errcode_t</span>    <span class="n">retval</span><span class="p">;</span>
<a name="c1-299"></a><span class="lineno">299</span>  <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>
<a name="c1-300"></a><span class="lineno">300</span>  <span class="kt">int</span>     <span class="n">i</span><span class="p">;</span>
<a name="c1-301"></a><span class="lineno">301</span> 
<a name="c1-302"></a><span class="lineno">302</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-303"></a><span class="lineno">303</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CACHE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cache</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-304"></a><span class="lineno">304</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-305"></a><span class="lineno">305</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-306"></a><span class="lineno">306</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-307"></a><span class="lineno">307</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-308"></a><span class="lineno">308</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-309"></a><span class="lineno">309</span>      <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-310"></a><span class="lineno">310</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_memalign</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span>
<a name="c1-311"></a><span class="lineno">311</span>               <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-312"></a><span class="lineno">312</span>    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c1-313"></a><span class="lineno">313</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-314"></a><span class="lineno">314</span>  <span class="p">}</span>
<a name="c1-315"></a><span class="lineno">315</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-316"></a><span class="lineno">316</span>    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">)</span>
<a name="c1-317"></a><span class="lineno">317</span>      <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">);</span>
<a name="c1-318"></a><span class="lineno">318</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_memalign</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">,</span>
<a name="c1-319"></a><span class="lineno">319</span>               <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">);</span>
<a name="c1-320"></a><span class="lineno">320</span>  <span class="p">}</span>
<a name="c1-321"></a><span class="lineno">321</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-322"></a><span class="lineno">322</span> <span class="p">}</span>
<a name="c1-323"></a><span class="lineno">323</span> 
<a name="c1-324"></a><span class="lineno">324</span> <span class="cm">/* Free the cache buffers */</span>
<a name="c1-325"></a><span class="lineno">325</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">free_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-326"></a><span class="lineno">326</span> <span class="p">{</span>
<a name="c1-327"></a><span class="lineno">327</span>  <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>
<a name="c1-328"></a><span class="lineno">328</span>  <span class="kt">int</span>     <span class="n">i</span><span class="p">;</span>
<a name="c1-329"></a><span class="lineno">329</span> 
<a name="c1-330"></a><span class="lineno">330</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-331"></a><span class="lineno">331</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CACHE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cache</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-332"></a><span class="lineno">332</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-333"></a><span class="lineno">333</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-334"></a><span class="lineno">334</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-335"></a><span class="lineno">335</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-336"></a><span class="lineno">336</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-337"></a><span class="lineno">337</span>      <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-338"></a><span class="lineno">338</span>  <span class="p">}</span>
<a name="c1-339"></a><span class="lineno">339</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">)</span>
<a name="c1-340"></a><span class="lineno">340</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bounce</span><span class="p">);</span>
<a name="c1-341"></a><span class="lineno">341</span> <span class="p">}</span>
<a name="c1-342"></a><span class="lineno">342</span> 
<a name="c1-343"></a><span class="lineno">343</span> <span class="cp">#ifndef NO_IO_CACHE</span>
<a name="c1-344"></a><span class="lineno">344</span> <span class="cm">/*</span>
<a name="c1-345"></a><span class="lineno">345</span> <span class="cm"> * Try to find a block in the cache.  If the block is not found, and</span>
<a name="c1-346"></a><span class="lineno">346</span> <span class="cm"> * eldest is a non-zero pointer, then fill in eldest with the cache</span>
<a name="c1-347"></a><span class="lineno">347</span> <span class="cm"> * entry to that should be reused.</span>
<a name="c1-348"></a><span class="lineno">348</span> <span class="cm"> */</span>
<a name="c1-349"></a><span class="lineno">349</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="nf">find_cached_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
<a name="c1-350"></a><span class="lineno">350</span>              <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-351"></a><span class="lineno">351</span>              <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">**</span><span class="n">eldest</span><span class="p">)</span>
<a name="c1-352"></a><span class="lineno">352</span> <span class="p">{</span>
<a name="c1-353"></a><span class="lineno">353</span>  <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="o">*</span><span class="n">unused_cache</span><span class="p">,</span> <span class="o">*</span><span class="n">oldest_cache</span><span class="p">;</span>
<a name="c1-354"></a><span class="lineno">354</span>  <span class="kt">int</span>     <span class="n">i</span><span class="p">;</span>
<a name="c1-355"></a><span class="lineno">355</span> 
<a name="c1-356"></a><span class="lineno">356</span>  <span class="n">unused_cache</span> <span class="o">=</span> <span class="n">oldest_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-357"></a><span class="lineno">357</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CACHE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cache</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-358"></a><span class="lineno">358</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-359"></a><span class="lineno">359</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unused_cache</span><span class="p">)</span>
<a name="c1-360"></a><span class="lineno">360</span>        <span class="n">unused_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">;</span>
<a name="c1-361"></a><span class="lineno">361</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-362"></a><span class="lineno">362</span>    <span class="p">}</span>
<a name="c1-363"></a><span class="lineno">363</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">==</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-364"></a><span class="lineno">364</span>      <span class="n">cache</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="o">++</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">access_time</span><span class="p">;</span>
<a name="c1-365"></a><span class="lineno">365</span>      <span class="k">return</span> <span class="n">cache</span><span class="p">;</span>
<a name="c1-366"></a><span class="lineno">366</span>    <span class="p">}</span>
<a name="c1-367"></a><span class="lineno">367</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldest_cache</span> <span class="o">||</span>
<a name="c1-368"></a><span class="lineno">368</span>        <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">&lt;</span> <span class="n">oldest_cache</span><span class="o">-&gt;</span><span class="n">access_time</span><span class="p">))</span>
<a name="c1-369"></a><span class="lineno">369</span>      <span class="n">oldest_cache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">;</span>
<a name="c1-370"></a><span class="lineno">370</span>  <span class="p">}</span>
<a name="c1-371"></a><span class="lineno">371</span>  <span class="k">if</span> <span class="p">(</span><span class="n">eldest</span><span class="p">)</span>
<a name="c1-372"></a><span class="lineno">372</span>    <span class="o">*</span><span class="n">eldest</span> <span class="o">=</span> <span class="p">(</span><span class="n">unused_cache</span><span class="p">)</span> <span class="o">?</span> <span class="n">unused_cache</span> <span class="o">:</span> <span class="n">oldest_cache</span><span class="p">;</span>
<a name="c1-373"></a><span class="lineno">373</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-374"></a><span class="lineno">374</span> <span class="p">}</span>
<a name="c1-375"></a><span class="lineno">375</span> 
<a name="c1-376"></a><span class="lineno">376</span> <span class="cm">/*</span>
<a name="c1-377"></a><span class="lineno">377</span> <span class="cm"> * Reuse a particular cache entry for another block.</span>
<a name="c1-378"></a><span class="lineno">378</span> <span class="cm"> */</span>
<a name="c1-379"></a><span class="lineno">379</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">reuse_cache</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
<a name="c1-380"></a><span class="lineno">380</span>     <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">)</span>
<a name="c1-381"></a><span class="lineno">381</span> <span class="p">{</span>
<a name="c1-382"></a><span class="lineno">382</span>  <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span>
<a name="c1-383"></a><span class="lineno">383</span>    <span class="n">raw_write_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-384"></a><span class="lineno">384</span> 
<a name="c1-385"></a><span class="lineno">385</span>  <span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-386"></a><span class="lineno">386</span>  <span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-387"></a><span class="lineno">387</span>  <span class="n">cache</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span>
<a name="c1-388"></a><span class="lineno">388</span>  <span class="n">cache</span><span class="o">-&gt;</span><span class="n">access_time</span> <span class="o">=</span> <span class="o">++</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">access_time</span><span class="p">;</span>
<a name="c1-389"></a><span class="lineno">389</span> <span class="p">}</span>
<a name="c1-390"></a><span class="lineno">390</span> 
<a name="c1-391"></a><span class="lineno">391</span> <span class="cm">/*</span>
<a name="c1-392"></a><span class="lineno">392</span> <span class="cm"> * Flush all of the blocks in the cache</span>
<a name="c1-393"></a><span class="lineno">393</span> <span class="cm"> */</span>
<a name="c1-394"></a><span class="lineno">394</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">flush_cached_blocks</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span>
<a name="c1-395"></a><span class="lineno">395</span>             <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
<a name="c1-396"></a><span class="lineno">396</span>             <span class="kt">int</span> <span class="n">invalidate</span><span class="p">)</span>
<a name="c1-397"></a><span class="lineno">397</span> 
<a name="c1-398"></a><span class="lineno">398</span> <span class="p">{</span>
<a name="c1-399"></a><span class="lineno">399</span>  <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">;</span>
<a name="c1-400"></a><span class="lineno">400</span>  <span class="n">errcode_t</span>    <span class="n">retval</span><span class="p">,</span> <span class="n">retval2</span><span class="p">;</span>
<a name="c1-401"></a><span class="lineno">401</span>  <span class="kt">int</span>     <span class="n">i</span><span class="p">;</span>
<a name="c1-402"></a><span class="lineno">402</span> 
<a name="c1-403"></a><span class="lineno">403</span>  <span class="n">retval2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-404"></a><span class="lineno">404</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CACHE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cache</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-405"></a><span class="lineno">405</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span>
<a name="c1-406"></a><span class="lineno">406</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-407"></a><span class="lineno">407</span> 
<a name="c1-408"></a><span class="lineno">408</span>    <span class="k">if</span> <span class="p">(</span><span class="n">invalidate</span><span class="p">)</span>
<a name="c1-409"></a><span class="lineno">409</span>      <span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-410"></a><span class="lineno">410</span> 
<a name="c1-411"></a><span class="lineno">411</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span>
<a name="c1-412"></a><span class="lineno">412</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-413"></a><span class="lineno">413</span> 
<a name="c1-414"></a><span class="lineno">414</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">raw_write_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
<a name="c1-415"></a><span class="lineno">415</span>               <span class="n">cache</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-416"></a><span class="lineno">416</span>    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c1-417"></a><span class="lineno">417</span>      <span class="n">retval2</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-418"></a><span class="lineno">418</span>    <span class="k">else</span>
<a name="c1-419"></a><span class="lineno">419</span>      <span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-420"></a><span class="lineno">420</span>  <span class="p">}</span>
<a name="c1-421"></a><span class="lineno">421</span>  <span class="k">return</span> <span class="n">retval2</span><span class="p">;</span>
<a name="c1-422"></a><span class="lineno">422</span> <span class="p">}</span>
<a name="c1-423"></a><span class="lineno">423</span> <span class="cp">#endif </span><span class="cm">/* NO_IO_CACHE */</span><span class="cp"></span>
<a name="c1-424"></a><span class="lineno">424</span> 
<a name="c1-425"></a><span class="lineno">425</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">io_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<a name="c1-426"></a><span class="lineno">426</span> <span class="p">{</span>
<a name="c1-427"></a><span class="lineno">427</span>  <span class="n">io_channel</span> <span class="n">io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-428"></a><span class="lineno">428</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-429"></a><span class="lineno">429</span>  <span class="n">errcode_t</span>  <span class="n">retval</span><span class="p">;</span>
<a name="c1-430"></a><span class="lineno">430</span>  <span class="kt">int</span>   <span class="n">open_flags</span><span class="p">;</span>
<a name="c1-431"></a><span class="lineno">431</span>  <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c1-432"></a><span class="lineno">432</span> <span class="cp">#ifdef __linux__</span>
<a name="c1-433"></a><span class="lineno">433</span>  <span class="k">struct</span>     <span class="n">utsname</span> <span class="n">ut</span><span class="p">;</span>
<a name="c1-434"></a><span class="lineno">434</span> <span class="cp">#endif</span>
<a name="c1-435"></a><span class="lineno">435</span> 
<a name="c1-436"></a><span class="lineno">436</span>  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-437"></a><span class="lineno">437</span>    <span class="k">return</span> <span class="n">EXT2_ET_BAD_DEVICE_NAME</span><span class="p">;</span>
<a name="c1-438"></a><span class="lineno">438</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">struct_io_channel</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
<a name="c1-439"></a><span class="lineno">439</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c1-440"></a><span class="lineno">440</span>    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-441"></a><span class="lineno">441</span>  <span class="n">memset</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">struct_io_channel</span><span class="p">));</span>
<a name="c1-442"></a><span class="lineno">442</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">;</span>
<a name="c1-443"></a><span class="lineno">443</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<a name="c1-444"></a><span class="lineno">444</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c1-445"></a><span class="lineno">445</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c1-446"></a><span class="lineno">446</span> 
<a name="c1-447"></a><span class="lineno">447</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">manager</span> <span class="o">=</span> <span class="n">unix_io_manager</span><span class="p">;</span>
<a name="c1-448"></a><span class="lineno">448</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">ext2fs_get_mem</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c1-449"></a><span class="lineno">449</span>  <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
<a name="c1-450"></a><span class="lineno">450</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c1-451"></a><span class="lineno">451</span> 
<a name="c1-452"></a><span class="lineno">452</span>  <span class="n">strcpy</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c1-453"></a><span class="lineno">453</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<a name="c1-454"></a><span class="lineno">454</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c1-455"></a><span class="lineno">455</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">read_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-456"></a><span class="lineno">456</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">write_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-457"></a><span class="lineno">457</span>  <span class="n">io</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-458"></a><span class="lineno">458</span> 
<a name="c1-459"></a><span class="lineno">459</span>  <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span><span class="p">));</span>
<a name="c1-460"></a><span class="lineno">460</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">;</span>
<a name="c1-461"></a><span class="lineno">461</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">io_stats</span><span class="p">.</span><span class="n">num_fields</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c1-462"></a><span class="lineno">462</span> 
<a name="c1-463"></a><span class="lineno">463</span>  <span class="n">open_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_FLAG_RW</span><span class="p">)</span> <span class="o">?</span> <span class="n">O_RDWR</span> <span class="o">:</span> <span class="n">O_RDONLY</span><span class="p">;</span>
<a name="c1-464"></a><span class="lineno">464</span>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_FLAG_EXCLUSIVE</span><span class="p">)</span>
<a name="c1-465"></a><span class="lineno">465</span>    <span class="n">open_flags</span> <span class="o">|=</span> <span class="n">O_EXCL</span><span class="p">;</span>
<a name="c1-466"></a><span class="lineno">466</span>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_FLAG_DIRECT_IO</span><span class="p">)</span>
<a name="c1-467"></a><span class="lineno">467</span>    <span class="n">open_flags</span> <span class="o">|=</span> <span class="n">O_DIRECT</span><span class="p">;</span>
<a name="c1-468"></a><span class="lineno">468</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
<a name="c1-469"></a><span class="lineno">469</span> 
<a name="c1-470"></a><span class="lineno">470</span> <span class="cp">#ifdef HAVE_OPEN64</span>
<a name="c1-471"></a><span class="lineno">471</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">open64</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">open_flags</span><span class="p">);</span>
<a name="c1-472"></a><span class="lineno">472</span> <span class="cp">#else</span>
<a name="c1-473"></a><span class="lineno">473</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">open_flags</span><span class="p">);</span>
<a name="c1-474"></a><span class="lineno">474</span> <span class="cp">#endif</span>
<a name="c1-475"></a><span class="lineno">475</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-476"></a><span class="lineno">476</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-477"></a><span class="lineno">477</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c1-478"></a><span class="lineno">478</span>  <span class="p">}</span>
<a name="c1-479"></a><span class="lineno">479</span> 
<a name="c1-480"></a><span class="lineno">480</span> <span class="cp">#ifdef BLKSSZGET</span>
<a name="c1-481"></a><span class="lineno">481</span>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_FLAG_DIRECT_IO</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-482"></a><span class="lineno">482</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BLKSSZGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-483"></a><span class="lineno">483</span>      <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-484"></a><span class="lineno">484</span>  <span class="p">}</span>
<a name="c1-485"></a><span class="lineno">485</span> <span class="cp">#endif</span>
<a name="c1-486"></a><span class="lineno">486</span> 
<a name="c1-487"></a><span class="lineno">487</span> <span class="cp">#if defined(__CYGWIN__) || defined(__FreeBSD__) || defined(__FreeBSD_kernel__)</span>
<a name="c1-488"></a><span class="lineno">488</span>  <span class="cm">/*</span>
<a name="c1-489"></a><span class="lineno">489</span> <span class="cm">   * Some operating systems require that the buffers be aligned,</span>
<a name="c1-490"></a><span class="lineno">490</span> <span class="cm">   * regardless of O_DIRECT</span>
<a name="c1-491"></a><span class="lineno">491</span> <span class="cm">   */</span>
<a name="c1-492"></a><span class="lineno">492</span>  <span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
<a name="c1-493"></a><span class="lineno">493</span> <span class="cp">#endif</span>
<a name="c1-494"></a><span class="lineno">494</span> 
<a name="c1-495"></a><span class="lineno">495</span> 
<a name="c1-496"></a><span class="lineno">496</span>  <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloc_cache</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">data</span><span class="p">)))</span>
<a name="c1-497"></a><span class="lineno">497</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c1-498"></a><span class="lineno">498</span> 
<a name="c1-499"></a><span class="lineno">499</span> <span class="cp">#ifdef BLKROGET</span>
<a name="c1-500"></a><span class="lineno">500</span>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_FLAG_RW</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-501"></a><span class="lineno">501</span>    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
<a name="c1-502"></a><span class="lineno">502</span>    <span class="kt">int</span> <span class="n">readonly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-503"></a><span class="lineno">503</span> 
<a name="c1-504"></a><span class="lineno">504</span>    <span class="cm">/* Is the block device actually writable? */</span>
<a name="c1-505"></a><span class="lineno">505</span>    <span class="n">error</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BLKROGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readonly</span><span class="p">);</span>
<a name="c1-506"></a><span class="lineno">506</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">readonly</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-507"></a><span class="lineno">507</span>      <span class="n">close</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<a name="c1-508"></a><span class="lineno">508</span>      <span class="n">retval</span> <span class="o">=</span> <span class="n">EPERM</span><span class="p">;</span>
<a name="c1-509"></a><span class="lineno">509</span>      <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c1-510"></a><span class="lineno">510</span>    <span class="p">}</span>
<a name="c1-511"></a><span class="lineno">511</span>  <span class="p">}</span>
<a name="c1-512"></a><span class="lineno">512</span> <span class="cp">#endif</span>
<a name="c1-513"></a><span class="lineno">513</span> 
<a name="c1-514"></a><span class="lineno">514</span> <span class="cp">#ifdef __linux__</span>
<a name="c1-515"></a><span class="lineno">515</span> <span class="cp">#undef RLIM_INFINITY</span>
<a name="c1-516"></a><span class="lineno">516</span> <span class="cp">#if (defined(__alpha__) || ((defined(__sparc__) || defined(__mips__)) &amp;&amp; (SIZEOF_LONG == 4)))</span>
<a name="c1-517"></a><span class="lineno">517</span> <span class="cp">#define RLIM_INFINITY ((unsigned long)(~0UL&gt;&gt;1))</span>
<a name="c1-518"></a><span class="lineno">518</span> <span class="cp">#else</span>
<a name="c1-519"></a><span class="lineno">519</span> <span class="cp">#define RLIM_INFINITY  (~0UL)</span>
<a name="c1-520"></a><span class="lineno">520</span> <span class="cp">#endif</span>
<a name="c1-521"></a><span class="lineno">521</span>  <span class="cm">/*</span>
<a name="c1-522"></a><span class="lineno">522</span> <span class="cm">   * Work around a bug in 2.4.10-2.4.18 kernels where writes to</span>
<a name="c1-523"></a><span class="lineno">523</span> <span class="cm">   * block devices are wrongly getting hit by the filesize</span>
<a name="c1-524"></a><span class="lineno">524</span> <span class="cm">   * limit.  This workaround isn't perfect, since it won't work</span>
<a name="c1-525"></a><span class="lineno">525</span> <span class="cm">   * if glibc wasn't built against 2.2 header files.  (Sigh.)</span>
<a name="c1-526"></a><span class="lineno">526</span> <span class="cm">   *</span>
<a name="c1-527"></a><span class="lineno">527</span> <span class="cm">   */</span>
<a name="c1-528"></a><span class="lineno">528</span>  <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IO_FLAG_RW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-529"></a><span class="lineno">529</span>      <span class="p">(</span><span class="n">uname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ut</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-530"></a><span class="lineno">530</span>      <span class="p">((</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'2'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-531"></a><span class="lineno">531</span>       <span class="p">(</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'4'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-532"></a><span class="lineno">532</span>       <span class="p">(</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'1'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-533"></a><span class="lineno">533</span>       <span class="p">(</span><span class="n">ut</span><span class="p">.</span><span class="n">release</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="sc">'8'</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
<a name="c1-534"></a><span class="lineno">534</span>      <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-535"></a><span class="lineno">535</span>      <span class="p">(</span><span class="n">S_ISBLK</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-536"></a><span class="lineno">536</span>    <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">rlim</span><span class="p">;</span>
<a name="c1-537"></a><span class="lineno">537</span> 
<a name="c1-538"></a><span class="lineno">538</span>    <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">RLIM_INFINITY</span><span class="p">;</span>
<a name="c1-539"></a><span class="lineno">539</span>    <span class="n">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
<a name="c1-540"></a><span class="lineno">540</span>    <span class="n">getrlimit</span><span class="p">(</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
<a name="c1-541"></a><span class="lineno">541</span>    <span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">)</span> <span class="o">&lt;</span>
<a name="c1-542"></a><span class="lineno">542</span>        <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-543"></a><span class="lineno">543</span>      <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">rlim</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">;</span>
<a name="c1-544"></a><span class="lineno">544</span>      <span class="n">setrlimit</span><span class="p">(</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlim</span><span class="p">);</span>
<a name="c1-545"></a><span class="lineno">545</span>    <span class="p">}</span>
<a name="c1-546"></a><span class="lineno">546</span>  <span class="p">}</span>
<a name="c1-547"></a><span class="lineno">547</span> <span class="cp">#endif</span>
<a name="c1-548"></a><span class="lineno">548</span>  <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
<a name="c1-549"></a><span class="lineno">549</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-550"></a><span class="lineno">550</span> 
<a name="c1-551"></a><span class="lineno">551</span> <span class="nl">cleanup:</span>
<a name="c1-552"></a><span class="lineno">552</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-553"></a><span class="lineno">553</span>    <span class="n">free_cache</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c1-554"></a><span class="lineno">554</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<a name="c1-555"></a><span class="lineno">555</span>  <span class="p">}</span>
<a name="c1-556"></a><span class="lineno">556</span>  <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">)</span>
<a name="c1-557"></a><span class="lineno">557</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
<a name="c1-558"></a><span class="lineno">558</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-559"></a><span class="lineno">559</span> <span class="p">}</span>
<a name="c1-560"></a><span class="lineno">560</span> 
<a name="c1-561"></a><span class="lineno">561</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_close</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">)</span>
<a name="c1-562"></a><span class="lineno">562</span> <span class="p">{</span>
<a name="c1-563"></a><span class="lineno">563</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-564"></a><span class="lineno">564</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-565"></a><span class="lineno">565</span> 
<a name="c1-566"></a><span class="lineno">566</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-567"></a><span class="lineno">567</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-568"></a><span class="lineno">568</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-569"></a><span class="lineno">569</span> 
<a name="c1-570"></a><span class="lineno">570</span>  <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-571"></a><span class="lineno">571</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-572"></a><span class="lineno">572</span> 
<a name="c1-573"></a><span class="lineno">573</span> <span class="cp">#ifndef NO_IO_CACHE</span>
<a name="c1-574"></a><span class="lineno">574</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">flush_cached_blocks</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-575"></a><span class="lineno">575</span> <span class="cp">#endif</span>
<a name="c1-576"></a><span class="lineno">576</span> 
<a name="c1-577"></a><span class="lineno">577</span>  <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-578"></a><span class="lineno">578</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-579"></a><span class="lineno">579</span>  <span class="n">free_cache</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c1-580"></a><span class="lineno">580</span> 
<a name="c1-581"></a><span class="lineno">581</span>  <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
<a name="c1-582"></a><span class="lineno">582</span>  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
<a name="c1-583"></a><span class="lineno">583</span>    <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c1-584"></a><span class="lineno">584</span>  <span class="n">ext2fs_free_mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">);</span>
<a name="c1-585"></a><span class="lineno">585</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-586"></a><span class="lineno">586</span> <span class="p">}</span>
<a name="c1-587"></a><span class="lineno">587</span> 
<a name="c1-588"></a><span class="lineno">588</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_set_blksize</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">)</span>
<a name="c1-589"></a><span class="lineno">589</span> <span class="p">{</span>
<a name="c1-590"></a><span class="lineno">590</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-591"></a><span class="lineno">591</span>  <span class="n">errcode_t</span>    <span class="n">retval</span><span class="p">;</span>
<a name="c1-592"></a><span class="lineno">592</span> 
<a name="c1-593"></a><span class="lineno">593</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-594"></a><span class="lineno">594</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-595"></a><span class="lineno">595</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-596"></a><span class="lineno">596</span> 
<a name="c1-597"></a><span class="lineno">597</span>  <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">!=</span> <span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-598"></a><span class="lineno">598</span> <span class="cp">#ifndef NO_IO_CACHE</span>
<a name="c1-599"></a><span class="lineno">599</span>    <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">flush_cached_blocks</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
<a name="c1-600"></a><span class="lineno">600</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-601"></a><span class="lineno">601</span> <span class="cp">#endif</span>
<a name="c1-602"></a><span class="lineno">602</span> 
<a name="c1-603"></a><span class="lineno">603</span>    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">blksize</span><span class="p">;</span>
<a name="c1-604"></a><span class="lineno">604</span>    <span class="n">free_cache</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c1-605"></a><span class="lineno">605</span>    <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloc_cache</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">)))</span>
<a name="c1-606"></a><span class="lineno">606</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-607"></a><span class="lineno">607</span>  <span class="p">}</span>
<a name="c1-608"></a><span class="lineno">608</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-609"></a><span class="lineno">609</span> <span class="p">}</span>
<a name="c1-610"></a><span class="lineno">610</span> 
<a name="c1-611"></a><span class="lineno">611</span> 
<a name="c1-612"></a><span class="lineno">612</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_read_blk64</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-613"></a><span class="lineno">613</span>             <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-614"></a><span class="lineno">614</span> <span class="p">{</span>
<a name="c1-615"></a><span class="lineno">615</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-616"></a><span class="lineno">616</span>  <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="o">*</span><span class="n">reuse</span><span class="p">[</span><span class="n">READ_DIRECT_SIZE</span><span class="p">];</span>
<a name="c1-617"></a><span class="lineno">617</span>  <span class="n">errcode_t</span>  <span class="n">retval</span><span class="p">;</span>
<a name="c1-618"></a><span class="lineno">618</span>  <span class="kt">char</span>    <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c1-619"></a><span class="lineno">619</span>  <span class="kt">int</span>   <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<a name="c1-620"></a><span class="lineno">620</span> 
<a name="c1-621"></a><span class="lineno">621</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-622"></a><span class="lineno">622</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-623"></a><span class="lineno">623</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-624"></a><span class="lineno">624</span> 
<a name="c1-625"></a><span class="lineno">625</span> <span class="cp">#ifdef NO_IO_CACHE</span>
<a name="c1-626"></a><span class="lineno">626</span>  <span class="k">return</span> <span class="n">raw_read_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-627"></a><span class="lineno">627</span> <span class="cp">#else</span>
<a name="c1-628"></a><span class="lineno">628</span>  <span class="cm">/*</span>
<a name="c1-629"></a><span class="lineno">629</span> <span class="cm">   * If we're doing an odd-sized read or a very large read,</span>
<a name="c1-630"></a><span class="lineno">630</span> <span class="cm">   * flush out the cache and then do a direct read.</span>
<a name="c1-631"></a><span class="lineno">631</span> <span class="cm">   */</span>
<a name="c1-632"></a><span class="lineno">632</span>  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">WRITE_DIRECT_SIZE</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-633"></a><span class="lineno">633</span>    <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">flush_cached_blocks</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
<a name="c1-634"></a><span class="lineno">634</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-635"></a><span class="lineno">635</span>    <span class="k">return</span> <span class="n">raw_read_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-636"></a><span class="lineno">636</span>  <span class="p">}</span>
<a name="c1-637"></a><span class="lineno">637</span> 
<a name="c1-638"></a><span class="lineno">638</span>  <span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<a name="c1-639"></a><span class="lineno">639</span>  <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-640"></a><span class="lineno">640</span>    <span class="cm">/* If it's in the cache, use it! */</span>
<a name="c1-641"></a><span class="lineno">641</span>    <span class="k">if</span> <span class="p">((</span><span class="n">cache</span> <span class="o">=</span> <span class="n">find_cached_block</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reuse</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
<a name="c1-642"></a><span class="lineno">642</span> <span class="cp">#ifdef DEBUG</span>
<a name="c1-643"></a><span class="lineno">643</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"Using cached block %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<a name="c1-644"></a><span class="lineno">644</span> <span class="cp">#endif</span>
<a name="c1-645"></a><span class="lineno">645</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-646"></a><span class="lineno">646</span>      <span class="n">count</span><span class="o">--</span><span class="p">;</span>
<a name="c1-647"></a><span class="lineno">647</span>      <span class="n">block</span><span class="o">++</span><span class="p">;</span>
<a name="c1-648"></a><span class="lineno">648</span>      <span class="n">cp</span> <span class="o">+=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-649"></a><span class="lineno">649</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-650"></a><span class="lineno">650</span>    <span class="p">}</span>
<a name="c1-651"></a><span class="lineno">651</span>    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-652"></a><span class="lineno">652</span>      <span class="cm">/*</span>
<a name="c1-653"></a><span class="lineno">653</span> <span class="cm">       * Special case where we read directly into the</span>
<a name="c1-654"></a><span class="lineno">654</span> <span class="cm">       * cache buffer; important in the O_DIRECT case</span>
<a name="c1-655"></a><span class="lineno">655</span> <span class="cm">       */</span>
<a name="c1-656"></a><span class="lineno">656</span>      <span class="n">cache</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="c1-657"></a><span class="lineno">657</span>      <span class="n">reuse_cache</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<a name="c1-658"></a><span class="lineno">658</span>      <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">raw_read_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<a name="c1-659"></a><span class="lineno">659</span>               <span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-660"></a><span class="lineno">660</span>        <span class="n">cache</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-661"></a><span class="lineno">661</span>        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-662"></a><span class="lineno">662</span>      <span class="p">}</span>
<a name="c1-663"></a><span class="lineno">663</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-664"></a><span class="lineno">664</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-665"></a><span class="lineno">665</span>    <span class="p">}</span>
<a name="c1-666"></a><span class="lineno">666</span> 
<a name="c1-667"></a><span class="lineno">667</span>    <span class="cm">/*</span>
<a name="c1-668"></a><span class="lineno">668</span> <span class="cm">     * Find the number of uncached blocks so we can do a</span>
<a name="c1-669"></a><span class="lineno">669</span> <span class="cm">     * single read request</span>
<a name="c1-670"></a><span class="lineno">670</span> <span class="cm">     */</span>
<a name="c1-671"></a><span class="lineno">671</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-672"></a><span class="lineno">672</span>      <span class="k">if</span> <span class="p">(</span><span class="n">find_cached_block</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reuse</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<a name="c1-673"></a><span class="lineno">673</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-674"></a><span class="lineno">674</span> <span class="cp">#ifdef DEBUG</span>
<a name="c1-675"></a><span class="lineno">675</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Reading %d blocks starting at %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<a name="c1-676"></a><span class="lineno">676</span> <span class="cp">#endif</span>
<a name="c1-677"></a><span class="lineno">677</span>    <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">raw_read_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cp</span><span class="p">)))</span>
<a name="c1-678"></a><span class="lineno">678</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-679"></a><span class="lineno">679</span> 
<a name="c1-680"></a><span class="lineno">680</span>    <span class="cm">/* Save the results in the cache */</span>
<a name="c1-681"></a><span class="lineno">681</span>    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-682"></a><span class="lineno">682</span>      <span class="n">count</span><span class="o">--</span><span class="p">;</span>
<a name="c1-683"></a><span class="lineno">683</span>      <span class="n">cache</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a name="c1-684"></a><span class="lineno">684</span>      <span class="n">reuse_cache</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">block</span><span class="o">++</span><span class="p">);</span>
<a name="c1-685"></a><span class="lineno">685</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-686"></a><span class="lineno">686</span>      <span class="n">cp</span> <span class="o">+=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-687"></a><span class="lineno">687</span>    <span class="p">}</span>
<a name="c1-688"></a><span class="lineno">688</span>  <span class="p">}</span>
<a name="c1-689"></a><span class="lineno">689</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-690"></a><span class="lineno">690</span> <span class="cp">#endif </span><span class="cm">/* NO_IO_CACHE */</span><span class="cp"></span>
<a name="c1-691"></a><span class="lineno">691</span> <span class="p">}</span>
<a name="c1-692"></a><span class="lineno">692</span> 
<a name="c1-693"></a><span class="lineno">693</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_read_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-694"></a><span class="lineno">694</span>             <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-695"></a><span class="lineno">695</span> <span class="p">{</span>
<a name="c1-696"></a><span class="lineno">696</span>  <span class="k">return</span> <span class="n">unix_read_blk64</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-697"></a><span class="lineno">697</span> <span class="p">}</span>
<a name="c1-698"></a><span class="lineno">698</span> 
<a name="c1-699"></a><span class="lineno">699</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_write_blk64</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-700"></a><span class="lineno">700</span>        <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-701"></a><span class="lineno">701</span> <span class="p">{</span>
<a name="c1-702"></a><span class="lineno">702</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-703"></a><span class="lineno">703</span>  <span class="k">struct</span> <span class="n">unix_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="o">*</span><span class="n">reuse</span><span class="p">;</span>
<a name="c1-704"></a><span class="lineno">704</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-705"></a><span class="lineno">705</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c1-706"></a><span class="lineno">706</span>  <span class="kt">int</span>   <span class="n">writethrough</span><span class="p">;</span>
<a name="c1-707"></a><span class="lineno">707</span> 
<a name="c1-708"></a><span class="lineno">708</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-709"></a><span class="lineno">709</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-710"></a><span class="lineno">710</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-711"></a><span class="lineno">711</span> 
<a name="c1-712"></a><span class="lineno">712</span> <span class="cp">#ifdef NO_IO_CACHE</span>
<a name="c1-713"></a><span class="lineno">713</span>  <span class="k">return</span> <span class="n">raw_write_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-714"></a><span class="lineno">714</span> <span class="cp">#else</span>
<a name="c1-715"></a><span class="lineno">715</span>  <span class="cm">/*</span>
<a name="c1-716"></a><span class="lineno">716</span> <span class="cm">   * If we're doing an odd-sized write or a very large write,</span>
<a name="c1-717"></a><span class="lineno">717</span> <span class="cm">   * flush out the cache completely and then do a direct write.</span>
<a name="c1-718"></a><span class="lineno">718</span> <span class="cm">   */</span>
<a name="c1-719"></a><span class="lineno">719</span>  <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">WRITE_DIRECT_SIZE</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-720"></a><span class="lineno">720</span>    <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">flush_cached_blocks</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<a name="c1-721"></a><span class="lineno">721</span>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-722"></a><span class="lineno">722</span>    <span class="k">return</span> <span class="n">raw_write_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-723"></a><span class="lineno">723</span>  <span class="p">}</span>
<a name="c1-724"></a><span class="lineno">724</span> 
<a name="c1-725"></a><span class="lineno">725</span>  <span class="cm">/*</span>
<a name="c1-726"></a><span class="lineno">726</span> <span class="cm">   * For a moderate-sized multi-block write, first force a write</span>
<a name="c1-727"></a><span class="lineno">727</span> <span class="cm">   * if we're in write-through cache mode, and then fill the</span>
<a name="c1-728"></a><span class="lineno">728</span> <span class="cm">   * cache with the blocks.</span>
<a name="c1-729"></a><span class="lineno">729</span> <span class="cm">   */</span>
<a name="c1-730"></a><span class="lineno">730</span>  <span class="n">writethrough</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHANNEL_FLAGS_WRITETHROUGH</span><span class="p">;</span>
<a name="c1-731"></a><span class="lineno">731</span>  <span class="k">if</span> <span class="p">(</span><span class="n">writethrough</span><span class="p">)</span>
<a name="c1-732"></a><span class="lineno">732</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">raw_write_blk</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-733"></a><span class="lineno">733</span> 
<a name="c1-734"></a><span class="lineno">734</span>  <span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<a name="c1-735"></a><span class="lineno">735</span>  <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-736"></a><span class="lineno">736</span>    <span class="n">cache</span> <span class="o">=</span> <span class="n">find_cached_block</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reuse</span><span class="p">);</span>
<a name="c1-737"></a><span class="lineno">737</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-738"></a><span class="lineno">738</span>      <span class="n">cache</span> <span class="o">=</span> <span class="n">reuse</span><span class="p">;</span>
<a name="c1-739"></a><span class="lineno">739</span>      <span class="n">reuse_cache</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
<a name="c1-740"></a><span class="lineno">740</span>    <span class="p">}</span>
<a name="c1-741"></a><span class="lineno">741</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<a name="c1-742"></a><span class="lineno">742</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="o">!</span><span class="n">writethrough</span><span class="p">;</span>
<a name="c1-743"></a><span class="lineno">743</span>    <span class="n">count</span><span class="o">--</span><span class="p">;</span>
<a name="c1-744"></a><span class="lineno">744</span>    <span class="n">block</span><span class="o">++</span><span class="p">;</span>
<a name="c1-745"></a><span class="lineno">745</span>    <span class="n">cp</span> <span class="o">+=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
<a name="c1-746"></a><span class="lineno">746</span>  <span class="p">}</span>
<a name="c1-747"></a><span class="lineno">747</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-748"></a><span class="lineno">748</span> <span class="cp">#endif </span><span class="cm">/* NO_IO_CACHE */</span><span class="cp"></span>
<a name="c1-749"></a><span class="lineno">749</span> <span class="p">}</span>
<a name="c1-750"></a><span class="lineno">750</span> 
<a name="c1-751"></a><span class="lineno">751</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_write_blk</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">block</span><span class="p">,</span>
<a name="c1-752"></a><span class="lineno">752</span>        <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-753"></a><span class="lineno">753</span> <span class="p">{</span>
<a name="c1-754"></a><span class="lineno">754</span>  <span class="k">return</span> <span class="n">unix_write_blk64</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<a name="c1-755"></a><span class="lineno">755</span> <span class="p">}</span>
<a name="c1-756"></a><span class="lineno">756</span> 
<a name="c1-757"></a><span class="lineno">757</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_write_byte</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
<a name="c1-758"></a><span class="lineno">758</span>         <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-759"></a><span class="lineno">759</span> <span class="p">{</span>
<a name="c1-760"></a><span class="lineno">760</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-761"></a><span class="lineno">761</span>  <span class="n">errcode_t</span>  <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-762"></a><span class="lineno">762</span>  <span class="kt">ssize_t</span>   <span class="n">actual</span><span class="p">;</span>
<a name="c1-763"></a><span class="lineno">763</span> 
<a name="c1-764"></a><span class="lineno">764</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-765"></a><span class="lineno">765</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-766"></a><span class="lineno">766</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-767"></a><span class="lineno">767</span> 
<a name="c1-768"></a><span class="lineno">768</span>  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-769"></a><span class="lineno">769</span> <span class="cp">#ifdef ALIGN_DEBUG</span>
<a name="c1-770"></a><span class="lineno">770</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"unix_write_byte: O_DIRECT fallback</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-771"></a><span class="lineno">771</span> <span class="cp">#endif</span>
<a name="c1-772"></a><span class="lineno">772</span>    <span class="k">return</span> <span class="n">EXT2_ET_UNIMPLEMENTED</span><span class="p">;</span>
<a name="c1-773"></a><span class="lineno">773</span>  <span class="p">}</span>
<a name="c1-774"></a><span class="lineno">774</span> 
<a name="c1-775"></a><span class="lineno">775</span> <span class="cp">#ifndef NO_IO_CACHE</span>
<a name="c1-776"></a><span class="lineno">776</span>  <span class="cm">/*</span>
<a name="c1-777"></a><span class="lineno">777</span> <span class="cm">   * Flush out the cache completely</span>
<a name="c1-778"></a><span class="lineno">778</span> <span class="cm">   */</span>
<a name="c1-779"></a><span class="lineno">779</span>  <span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">flush_cached_blocks</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<a name="c1-780"></a><span class="lineno">780</span>    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-781"></a><span class="lineno">781</span> <span class="cp">#endif</span>
<a name="c1-782"></a><span class="lineno">782</span> 
<a name="c1-783"></a><span class="lineno">783</span>  <span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-784"></a><span class="lineno">784</span>    <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-785"></a><span class="lineno">785</span> 
<a name="c1-786"></a><span class="lineno">786</span>  <span class="n">actual</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c1-787"></a><span class="lineno">787</span>  <span class="k">if</span> <span class="p">(</span><span class="n">actual</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span>
<a name="c1-788"></a><span class="lineno">788</span>    <span class="k">return</span> <span class="n">EXT2_ET_SHORT_WRITE</span><span class="p">;</span>
<a name="c1-789"></a><span class="lineno">789</span> 
<a name="c1-790"></a><span class="lineno">790</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-791"></a><span class="lineno">791</span> <span class="p">}</span>
<a name="c1-792"></a><span class="lineno">792</span> 
<a name="c1-793"></a><span class="lineno">793</span> <span class="cm">/*</span>
<a name="c1-794"></a><span class="lineno">794</span> <span class="cm"> * Flush data buffers to disk.</span>
<a name="c1-795"></a><span class="lineno">795</span> <span class="cm"> */</span>
<a name="c1-796"></a><span class="lineno">796</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_flush</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">)</span>
<a name="c1-797"></a><span class="lineno">797</span> <span class="p">{</span>
<a name="c1-798"></a><span class="lineno">798</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-799"></a><span class="lineno">799</span>  <span class="n">errcode_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-800"></a><span class="lineno">800</span> 
<a name="c1-801"></a><span class="lineno">801</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-802"></a><span class="lineno">802</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-803"></a><span class="lineno">803</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-804"></a><span class="lineno">804</span> 
<a name="c1-805"></a><span class="lineno">805</span> <span class="cp">#ifndef NO_IO_CACHE</span>
<a name="c1-806"></a><span class="lineno">806</span>  <span class="n">retval</span> <span class="o">=</span> <span class="n">flush_cached_blocks</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-807"></a><span class="lineno">807</span> <span class="cp">#endif</span>
<a name="c1-808"></a><span class="lineno">808</span>  <span class="n">fsync</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<a name="c1-809"></a><span class="lineno">809</span>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="c1-810"></a><span class="lineno">810</span> <span class="p">}</span>
<a name="c1-811"></a><span class="lineno">811</span> 
<a name="c1-812"></a><span class="lineno">812</span> <span class="k">static</span> <span class="n">errcode_t</span> <span class="nf">unix_set_option</span><span class="p">(</span><span class="n">io_channel</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">,</span>
<a name="c1-813"></a><span class="lineno">813</span>         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<a name="c1-814"></a><span class="lineno">814</span> <span class="p">{</span>
<a name="c1-815"></a><span class="lineno">815</span>  <span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-816"></a><span class="lineno">816</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
<a name="c1-817"></a><span class="lineno">817</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c1-818"></a><span class="lineno">818</span> 
<a name="c1-819"></a><span class="lineno">819</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-820"></a><span class="lineno">820</span>  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unix_private_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
<a name="c1-821"></a><span class="lineno">821</span>  <span class="n">EXT2_CHECK_MAGIC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">EXT2_ET_MAGIC_UNIX_IO_CHANNEL</span><span class="p">);</span>
<a name="c1-822"></a><span class="lineno">822</span> 
<a name="c1-823"></a><span class="lineno">823</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"offset"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-824"></a><span class="lineno">824</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
<a name="c1-825"></a><span class="lineno">825</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c1-826"></a><span class="lineno">826</span> 
<a name="c1-827"></a><span class="lineno">827</span>    <span class="n">tmp</span> <span class="o">=</span> <span class="n">strtoull</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-828"></a><span class="lineno">828</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span><span class="p">)</span>
<a name="c1-829"></a><span class="lineno">829</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c1-830"></a><span class="lineno">830</span>    <span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<a name="c1-831"></a><span class="lineno">831</span>    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-832"></a><span class="lineno">832</span>      <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c1-833"></a><span class="lineno">833</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-834"></a><span class="lineno">834</span>  <span class="p">}</span>
<a name="c1-835"></a><span class="lineno">835</span>  <span class="k">return</span> <span class="n">EXT2_ET_INVALID_ARGUMENT</span><span class="p">;</span>
<a name="c1-836"></a><span class="lineno">836</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>
</body></html>