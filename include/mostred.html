<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000677 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="shortcut icon" href="http://tyr.ics.es.osaka-u.ac.jp/static/favicon.ico">
        <script type="text/javascript" src="./mostred_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./mostred_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./mostred_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./mostred_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./mostred_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./mostred_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./mostred_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./mostred_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./mostred_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./mostred_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./mostred_files/chosen.jquery.js"></script>


        <script src="./mostred_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./mostred_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./mostred_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000677");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./mostred_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./mostred_files/bootstrap.css" rel="stylesheet">

        <link href="./mostred_files/force.css" rel="stylesheet" type="text/css">
        <link href="./mostred_files/chosen.css" rel="stylesheet" type="text/css">
        <link href="./motivating_files/font-awesome.css" rel="stylesheet" type="text/css">
        
        
<link rel="stylesheet" href="http://tyr.ics.es.osaka-u.ac.jp/pygments.css">
<title>Fica -- survey git-v1.7.9-rc1 12-01-25 02:26:57</title>

<script language="javascript">

    var reheight = function(){
        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-2035']")[0].scrollIntoView();
        $("a[name='c1-528']")[0].scrollIntoView();
        reheight();

    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

    <body>

      <table>
    <tr>
        <th><a href="http://localhost/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000677">96</a></th>
        

        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        

        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
    </tr></table>

<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> builtin/pack-objects.c 
                <small> (2036,2)-(2050,13)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 716px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">   1</span> <span class="cp">#include "builtin.h"</span>
<a name="c0-2"></a><span class="lineno">   2</span> <span class="cp">#include "cache.h"</span>
<a name="c0-3"></a><span class="lineno">   3</span> <span class="cp">#include "attr.h"</span>
<a name="c0-4"></a><span class="lineno">   4</span> <span class="cp">#include "object.h"</span>
<a name="c0-5"></a><span class="lineno">   5</span> <span class="cp">#include "blob.h"</span>
<a name="c0-6"></a><span class="lineno">   6</span> <span class="cp">#include "commit.h"</span>
<a name="c0-7"></a><span class="lineno">   7</span> <span class="cp">#include "tag.h"</span>
<a name="c0-8"></a><span class="lineno">   8</span> <span class="cp">#include "tree.h"</span>
<a name="c0-9"></a><span class="lineno">   9</span> <span class="cp">#include "delta.h"</span>
<a name="c0-10"></a><span class="lineno">  10</span> <span class="cp">#include "pack.h"</span>
<a name="c0-11"></a><span class="lineno">  11</span> <span class="cp">#include "pack-revindex.h"</span>
<a name="c0-12"></a><span class="lineno">  12</span> <span class="cp">#include "csum-file.h"</span>
<a name="c0-13"></a><span class="lineno">  13</span> <span class="cp">#include "tree-walk.h"</span>
<a name="c0-14"></a><span class="lineno">  14</span> <span class="cp">#include "diff.h"</span>
<a name="c0-15"></a><span class="lineno">  15</span> <span class="cp">#include "revision.h"</span>
<a name="c0-16"></a><span class="lineno">  16</span> <span class="cp">#include "list-objects.h"</span>
<a name="c0-17"></a><span class="lineno">  17</span> <span class="cp">#include "progress.h"</span>
<a name="c0-18"></a><span class="lineno">  18</span> <span class="cp">#include "refs.h"</span>
<a name="c0-19"></a><span class="lineno">  19</span> <span class="cp">#include "thread-utils.h"</span>
<a name="c0-20"></a><span class="lineno">  20</span> 
<a name="c0-21"></a><span class="lineno">  21</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">pack_usage</span><span class="p">[]</span> <span class="o">=</span>
<a name="c0-22"></a><span class="lineno">  22</span>   <span class="s">"git pack-objects [ -q | --progress | --all-progress ]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-23"></a><span class="lineno">  23</span>   <span class="s">"        [--all-progress-implied]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-24"></a><span class="lineno">  24</span>   <span class="s">"        [--max-pack-size=&lt;n&gt;] [--local] [--incremental]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-25"></a><span class="lineno">  25</span>   <span class="s">"        [--window=&lt;n&gt;] [--window-memory=&lt;n&gt;] [--depth=&lt;n&gt;]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-26"></a><span class="lineno">  26</span>   <span class="s">"        [--no-reuse-delta] [--no-reuse-object] [--delta-base-offset]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-27"></a><span class="lineno">  27</span>   <span class="s">"        [--threads=&lt;n&gt;] [--non-empty] [--revs [--unpacked | --all]]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-28"></a><span class="lineno">  28</span>   <span class="s">"        [--reflog] [--stdout | base-name] [--include-tag]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-29"></a><span class="lineno">  29</span>   <span class="s">"        [--keep-unreachable | --unpack-unreachable]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-30"></a><span class="lineno">  30</span>   <span class="s">"        [&lt; ref-list | &lt; object-list]"</span><span class="p">;</span>
<a name="c0-31"></a><span class="lineno">  31</span> 
<a name="c0-32"></a><span class="lineno">  32</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="p">{</span>
<a name="c0-33"></a><span class="lineno">  33</span>  <span class="k">struct</span> <span class="n">pack_idx_entry</span> <span class="n">idx</span><span class="p">;</span>
<a name="c0-34"></a><span class="lineno">  34</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* uncompressed size */</span>
<a name="c0-35"></a><span class="lineno">  35</span>  <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">in_pack</span><span class="p">;</span>  <span class="cm">/* already in pack */</span>
<a name="c0-36"></a><span class="lineno">  36</span>  <span class="kt">off_t</span> <span class="n">in_pack_offset</span><span class="p">;</span>
<a name="c0-37"></a><span class="lineno">  37</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">delta</span><span class="p">;</span>  <span class="cm">/* delta base object */</span>
<a name="c0-38"></a><span class="lineno">  38</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">delta_child</span><span class="p">;</span> <span class="cm">/* deltified objects who bases me */</span>
<a name="c0-39"></a><span class="lineno">  39</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">delta_sibling</span><span class="p">;</span> <span class="cm">/* other deltified objects who</span>
<a name="c0-40"></a><span class="lineno">  40</span> <span class="cm">               * uses the same base as me</span>
<a name="c0-41"></a><span class="lineno">  41</span> <span class="cm">               */</span>
<a name="c0-42"></a><span class="lineno">  42</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">delta_data</span><span class="p">;</span>  <span class="cm">/* cached delta (uncompressed) */</span>
<a name="c0-43"></a><span class="lineno">  43</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta_size</span><span class="p">;</span> <span class="cm">/* delta data size (uncompressed) */</span>
<a name="c0-44"></a><span class="lineno">  44</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">z_delta_size</span><span class="p">;</span> <span class="cm">/* delta data size (compressed) */</span>
<a name="c0-45"></a><span class="lineno">  45</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>  <span class="cm">/* name hint hash */</span>
<a name="c0-46"></a><span class="lineno">  46</span>  <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-47"></a><span class="lineno">  47</span>  <span class="k">enum</span> <span class="n">object_type</span> <span class="n">in_pack_type</span><span class="p">;</span>  <span class="cm">/* could be delta */</span>
<a name="c0-48"></a><span class="lineno">  48</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in_pack_header_size</span><span class="p">;</span>
<a name="c0-49"></a><span class="lineno">  49</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">preferred_base</span><span class="p">;</span> <span class="cm">/* we do not pack this, but is available</span>
<a name="c0-50"></a><span class="lineno">  50</span> <span class="cm">               * to be used as the base object to delta</span>
<a name="c0-51"></a><span class="lineno">  51</span> <span class="cm">               * objects against.</span>
<a name="c0-52"></a><span class="lineno">  52</span> <span class="cm">               */</span>
<a name="c0-53"></a><span class="lineno">  53</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">no_try_delta</span><span class="p">;</span>
<a name="c0-54"></a><span class="lineno">  54</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tagged</span><span class="p">;</span> <span class="cm">/* near the very tip of refs */</span>
<a name="c0-55"></a><span class="lineno">  55</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">filled</span><span class="p">;</span> <span class="cm">/* assigned write-order */</span>
<a name="c0-56"></a><span class="lineno">  56</span> <span class="p">};</span>
<a name="c0-57"></a><span class="lineno">  57</span> 
<a name="c0-58"></a><span class="lineno">  58</span> <span class="cm">/*</span>
<a name="c0-59"></a><span class="lineno">  59</span> <span class="cm"> * Objects we are going to pack are collected in objects array (dynamically</span>
<a name="c0-60"></a><span class="lineno">  60</span> <span class="cm"> * expanded).  nr_objects &amp; nr_alloc controls this array.  They are stored</span>
<a name="c0-61"></a><span class="lineno">  61</span> <span class="cm"> * in the order we see -- typically rev-list --objects order that gives us</span>
<a name="c0-62"></a><span class="lineno">  62</span> <span class="cm"> * nice "minimum seek" order.</span>
<a name="c0-63"></a><span class="lineno">  63</span> <span class="cm"> */</span>
<a name="c0-64"></a><span class="lineno">  64</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">objects</span><span class="p">;</span>
<a name="c0-65"></a><span class="lineno">  65</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">pack_idx_entry</span> <span class="o">**</span><span class="n">written_list</span><span class="p">;</span>
<a name="c0-66"></a><span class="lineno">  66</span> <span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">nr_objects</span><span class="p">,</span> <span class="n">nr_alloc</span><span class="p">,</span> <span class="n">nr_result</span><span class="p">,</span> <span class="n">nr_written</span><span class="p">;</span>
<a name="c0-67"></a><span class="lineno">  67</span> 
<a name="c0-68"></a><span class="lineno">  68</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">non_empty</span><span class="p">;</span>
<a name="c0-69"></a><span class="lineno">  69</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">reuse_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reuse_object</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-70"></a><span class="lineno">  70</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">keep_unreachable</span><span class="p">,</span> <span class="n">unpack_unreachable</span><span class="p">,</span> <span class="n">include_tag</span><span class="p">;</span>
<a name="c0-71"></a><span class="lineno">  71</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">local</span><span class="p">;</span>
<a name="c0-72"></a><span class="lineno">  72</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">incremental</span><span class="p">;</span>
<a name="c0-73"></a><span class="lineno">  73</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">ignore_packed_keep</span><span class="p">;</span>
<a name="c0-74"></a><span class="lineno">  74</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">allow_ofs_delta</span><span class="p">;</span>
<a name="c0-75"></a><span class="lineno">  75</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">pack_idx_option</span> <span class="n">pack_idx_opts</span><span class="p">;</span>
<a name="c0-76"></a><span class="lineno">  76</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base_name</span><span class="p">;</span>
<a name="c0-77"></a><span class="lineno">  77</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-78"></a><span class="lineno">  78</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="c0-79"></a><span class="lineno">  79</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pack_size_limit</span><span class="p">;</span>
<a name="c0-80"></a><span class="lineno">  80</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<a name="c0-81"></a><span class="lineno">  81</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">delta_search_threads</span><span class="p">;</span>
<a name="c0-82"></a><span class="lineno">  82</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">pack_to_stdout</span><span class="p">;</span>
<a name="c0-83"></a><span class="lineno">  83</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">num_preferred_base</span><span class="p">;</span>
<a name="c0-84"></a><span class="lineno">  84</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">progress</span> <span class="o">*</span><span class="n">progress_state</span><span class="p">;</span>
<a name="c0-85"></a><span class="lineno">  85</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">pack_compression_level</span> <span class="o">=</span> <span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">;</span>
<a name="c0-86"></a><span class="lineno">  86</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">pack_compression_seen</span><span class="p">;</span>
<a name="c0-87"></a><span class="lineno">  87</span> 
<a name="c0-88"></a><span class="lineno">  88</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta_cache_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-89"></a><span class="lineno">  89</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_delta_cache_size</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c0-90"></a><span class="lineno">  90</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cache_max_small_delta_size</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<a name="c0-91"></a><span class="lineno">  91</span> 
<a name="c0-92"></a><span class="lineno">  92</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">window_memory_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-93"></a><span class="lineno">  93</span> 
<a name="c0-94"></a><span class="lineno">  94</span> <span class="cm">/*</span>
<a name="c0-95"></a><span class="lineno">  95</span> <span class="cm"> * The object names in objects array are hashed with this hashtable,</span>
<a name="c0-96"></a><span class="lineno">  96</span> <span class="cm"> * to help looking up the entry by object name.</span>
<a name="c0-97"></a><span class="lineno">  97</span> <span class="cm"> * This hashtable is built after all the objects are seen.</span>
<a name="c0-98"></a><span class="lineno">  98</span> <span class="cm"> */</span>
<a name="c0-99"></a><span class="lineno">  99</span> <span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="n">object_ix</span><span class="p">;</span>
<a name="c0-100"></a><span class="lineno"> 100</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">object_ix_hashsz</span><span class="p">;</span>
<a name="c0-101"></a><span class="lineno"> 101</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">locate_object_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-102"></a><span class="lineno"> 102</span> 
<a name="c0-103"></a><span class="lineno"> 103</span> <span class="cm">/*</span>
<a name="c0-104"></a><span class="lineno"> 104</span> <span class="cm"> * stats</span>
<a name="c0-105"></a><span class="lineno"> 105</span> <span class="cm"> */</span>
<a name="c0-106"></a><span class="lineno"> 106</span> <span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">written</span><span class="p">,</span> <span class="n">written_delta</span><span class="p">;</span>
<a name="c0-107"></a><span class="lineno"> 107</span> <span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">reused</span><span class="p">,</span> <span class="n">reused_delta</span><span class="p">;</span>
<a name="c0-108"></a><span class="lineno"> 108</span> 
<a name="c0-109"></a><span class="lineno"> 109</span> 
<a name="c0-110"></a><span class="lineno"> 110</span> <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">get_delta</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<a name="c0-111"></a><span class="lineno"> 111</span> <span class="p">{</span>
<a name="c0-112"></a><span class="lineno"> 112</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">base_size</span><span class="p">,</span> <span class="n">delta_size</span><span class="p">;</span>
<a name="c0-113"></a><span class="lineno"> 113</span>   <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">base_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">delta_buf</span><span class="p">;</span>
<a name="c0-114"></a><span class="lineno"> 114</span>   <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-115"></a><span class="lineno"> 115</span> 
<a name="c0-116"></a><span class="lineno"> 116</span>   <span class="n">buf</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-117"></a><span class="lineno"> 117</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-118"></a><span class="lineno"> 118</span>     <span class="n">die</span><span class="p">(</span><span class="s">"unable to read %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-119"></a><span class="lineno"> 119</span>   <span class="n">base_buf</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_size</span><span class="p">);</span>
<a name="c0-120"></a><span class="lineno"> 120</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_buf</span><span class="p">)</span>
<a name="c0-121"></a><span class="lineno"> 121</span>     <span class="n">die</span><span class="p">(</span><span class="s">"unable to read %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-122"></a><span class="lineno"> 122</span>   <span class="n">delta_buf</span> <span class="o">=</span> <span class="n">diff_delta</span><span class="p">(</span><span class="n">base_buf</span><span class="p">,</span> <span class="n">base_size</span><span class="p">,</span>
<a name="c0-123"></a><span class="lineno"> 123</span>              <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delta_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-124"></a><span class="lineno"> 124</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta_buf</span> <span class="o">||</span> <span class="n">delta_size</span> <span class="o">!=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">)</span>
<a name="c0-125"></a><span class="lineno"> 125</span>     <span class="n">die</span><span class="p">(</span><span class="s">"delta size changed"</span><span class="p">);</span>
<a name="c0-126"></a><span class="lineno"> 126</span>   <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-127"></a><span class="lineno"> 127</span>   <span class="n">free</span><span class="p">(</span><span class="n">base_buf</span><span class="p">);</span>
<a name="c0-128"></a><span class="lineno"> 128</span>   <span class="k">return</span> <span class="n">delta_buf</span><span class="p">;</span>
<a name="c0-129"></a><span class="lineno"> 129</span> <span class="p">}</span>
<a name="c0-130"></a><span class="lineno"> 130</span> 
<a name="c0-131"></a><span class="lineno"> 131</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">do_compress</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">pptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<a name="c0-132"></a><span class="lineno"> 132</span> <span class="p">{</span>
<a name="c0-133"></a><span class="lineno"> 133</span>   <span class="n">git_zstream</span> <span class="n">stream</span><span class="p">;</span>
<a name="c0-134"></a><span class="lineno"> 134</span>   <span class="kt">void</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
<a name="c0-135"></a><span class="lineno"> 135</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">maxsize</span><span class="p">;</span>
<a name="c0-136"></a><span class="lineno"> 136</span> 
<a name="c0-137"></a><span class="lineno"> 137</span>   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span>
<a name="c0-138"></a><span class="lineno"> 138</span>   <span class="n">git_deflate_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="n">pack_compression_level</span><span class="p">);</span>
<a name="c0-139"></a><span class="lineno"> 139</span>   <span class="n">maxsize</span> <span class="o">=</span> <span class="n">git_deflate_bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-140"></a><span class="lineno"> 140</span> 
<a name="c0-141"></a><span class="lineno"> 141</span>   <span class="n">in</span> <span class="o">=</span> <span class="o">*</span><span class="n">pptr</span><span class="p">;</span>
<a name="c0-142"></a><span class="lineno"> 142</span>   <span class="n">out</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">maxsize</span><span class="p">);</span>
<a name="c0-143"></a><span class="lineno"> 143</span>   <span class="o">*</span><span class="n">pptr</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
<a name="c0-144"></a><span class="lineno"> 144</span> 
<a name="c0-145"></a><span class="lineno"> 145</span>   <span class="n">stream</span><span class="p">.</span><span class="n">next_in</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
<a name="c0-146"></a><span class="lineno"> 146</span>   <span class="n">stream</span><span class="p">.</span><span class="n">avail_in</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-147"></a><span class="lineno"> 147</span>   <span class="n">stream</span><span class="p">.</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
<a name="c0-148"></a><span class="lineno"> 148</span>   <span class="n">stream</span><span class="p">.</span><span class="n">avail_out</span> <span class="o">=</span> <span class="n">maxsize</span><span class="p">;</span>
<a name="c0-149"></a><span class="lineno"> 149</span>   <span class="k">while</span> <span class="p">(</span><span class="n">git_deflate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="n">Z_FINISH</span><span class="p">)</span> <span class="o">==</span> <span class="n">Z_OK</span><span class="p">)</span>
<a name="c0-150"></a><span class="lineno"> 150</span>     <span class="p">;</span> <span class="cm">/* nothing */</span>
<a name="c0-151"></a><span class="lineno"> 151</span>   <span class="n">git_deflate_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
<a name="c0-152"></a><span class="lineno"> 152</span> 
<a name="c0-153"></a><span class="lineno"> 153</span>   <span class="n">free</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<a name="c0-154"></a><span class="lineno"> 154</span>   <span class="k">return</span> <span class="n">stream</span><span class="p">.</span><span class="n">total_out</span><span class="p">;</span>
<a name="c0-155"></a><span class="lineno"> 155</span> <span class="p">}</span>
<a name="c0-156"></a><span class="lineno"> 156</span> 
<a name="c0-157"></a><span class="lineno"> 157</span> <span class="cm">/*</span>
<a name="c0-158"></a><span class="lineno"> 158</span> <span class="cm"> * we are going to reuse the existing object data as is.  make</span>
<a name="c0-159"></a><span class="lineno"> 159</span> <span class="cm"> * sure it is not corrupt.</span>
<a name="c0-160"></a><span class="lineno"> 160</span> <span class="cm"> */</span>
<a name="c0-161"></a><span class="lineno"> 161</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">check_pack_inflate</span><span class="p">(</span><span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
<a name="c0-162"></a><span class="lineno"> 162</span>     <span class="k">struct</span> <span class="n">pack_window</span> <span class="o">**</span><span class="n">w_curs</span><span class="p">,</span>
<a name="c0-163"></a><span class="lineno"> 163</span>     <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
<a name="c0-164"></a><span class="lineno"> 164</span>     <span class="kt">off_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c0-165"></a><span class="lineno"> 165</span>     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expect</span><span class="p">)</span>
<a name="c0-166"></a><span class="lineno"> 166</span> <span class="p">{</span>
<a name="c0-167"></a><span class="lineno"> 167</span>   <span class="n">git_zstream</span> <span class="n">stream</span><span class="p">;</span>
<a name="c0-168"></a><span class="lineno"> 168</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fakebuf</span><span class="p">[</span><span class="mi">4096</span><span class="p">],</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
<a name="c0-169"></a><span class="lineno"> 169</span>   <span class="kt">int</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-170"></a><span class="lineno"> 170</span> 
<a name="c0-171"></a><span class="lineno"> 171</span>   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span>
<a name="c0-172"></a><span class="lineno"> 172</span>   <span class="n">git_inflate_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
<a name="c0-173"></a><span class="lineno"> 173</span>   <span class="k">do</span> <span class="p">{</span>
<a name="c0-174"></a><span class="lineno"> 174</span>     <span class="n">in</span> <span class="o">=</span> <span class="n">use_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">w_curs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stream</span><span class="p">.</span><span class="n">avail_in</span><span class="p">);</span>
<a name="c0-175"></a><span class="lineno"> 175</span>     <span class="n">stream</span><span class="p">.</span><span class="n">next_in</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
<a name="c0-176"></a><span class="lineno"> 176</span>     <span class="n">stream</span><span class="p">.</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">fakebuf</span><span class="p">;</span>
<a name="c0-177"></a><span class="lineno"> 177</span>     <span class="n">stream</span><span class="p">.</span><span class="n">avail_out</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fakebuf</span><span class="p">);</span>
<a name="c0-178"></a><span class="lineno"> 178</span>     <span class="n">st</span> <span class="o">=</span> <span class="n">git_inflate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="n">Z_FINISH</span><span class="p">);</span>
<a name="c0-179"></a><span class="lineno"> 179</span>     <span class="n">offset</span> <span class="o">+=</span> <span class="n">stream</span><span class="p">.</span><span class="n">next_in</span> <span class="o">-</span> <span class="n">in</span><span class="p">;</span>
<a name="c0-180"></a><span class="lineno"> 180</span>   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="n">Z_OK</span> <span class="o">||</span> <span class="n">st</span> <span class="o">==</span> <span class="n">Z_BUF_ERROR</span><span class="p">);</span>
<a name="c0-181"></a><span class="lineno"> 181</span>   <span class="n">git_inflate_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
<a name="c0-182"></a><span class="lineno"> 182</span>   <span class="k">return</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="n">Z_STREAM_END</span> <span class="o">&amp;&amp;</span>
<a name="c0-183"></a><span class="lineno"> 183</span>     <span class="n">stream</span><span class="p">.</span><span class="n">total_out</span> <span class="o">==</span> <span class="n">expect</span> <span class="o">&amp;&amp;</span>
<a name="c0-184"></a><span class="lineno"> 184</span>     <span class="n">stream</span><span class="p">.</span><span class="n">total_in</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-185"></a><span class="lineno"> 185</span> <span class="p">}</span>
<a name="c0-186"></a><span class="lineno"> 186</span> 
<a name="c0-187"></a><span class="lineno"> 187</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_pack_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sha1file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
<a name="c0-188"></a><span class="lineno"> 188</span>     <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
<a name="c0-189"></a><span class="lineno"> 189</span>     <span class="k">struct</span> <span class="n">pack_window</span> <span class="o">**</span><span class="n">w_curs</span><span class="p">,</span>
<a name="c0-190"></a><span class="lineno"> 190</span>     <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
<a name="c0-191"></a><span class="lineno"> 191</span>     <span class="kt">off_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-192"></a><span class="lineno"> 192</span> <span class="p">{</span>
<a name="c0-193"></a><span class="lineno"> 193</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
<a name="c0-194"></a><span class="lineno"> 194</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">avail</span><span class="p">;</span>
<a name="c0-195"></a><span class="lineno"> 195</span> 
<a name="c0-196"></a><span class="lineno"> 196</span>   <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-197"></a><span class="lineno"> 197</span>     <span class="n">in</span> <span class="o">=</span> <span class="n">use_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">w_curs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>
<a name="c0-198"></a><span class="lineno"> 198</span>     <span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-199"></a><span class="lineno"> 199</span>       <span class="n">avail</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>
<a name="c0-200"></a><span class="lineno"> 200</span>     <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">avail</span><span class="p">);</span>
<a name="c0-201"></a><span class="lineno"> 201</span>     <span class="n">offset</span> <span class="o">+=</span> <span class="n">avail</span><span class="p">;</span>
<a name="c0-202"></a><span class="lineno"> 202</span>     <span class="n">len</span> <span class="o">-=</span> <span class="n">avail</span><span class="p">;</span>
<a name="c0-203"></a><span class="lineno"> 203</span>   <span class="p">}</span>
<a name="c0-204"></a><span class="lineno"> 204</span> <span class="p">}</span>
<a name="c0-205"></a><span class="lineno"> 205</span> 
<a name="c0-206"></a><span class="lineno"> 206</span> <span class="cm">/* Return 0 if we will bust the pack-size limit */</span>
<a name="c0-207"></a><span class="lineno"> 207</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">write_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">sha1file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
<a name="c0-208"></a><span class="lineno"> 208</span>           <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
<a name="c0-209"></a><span class="lineno"> 209</span>           <span class="kt">off_t</span> <span class="n">write_offset</span><span class="p">)</span>
<a name="c0-210"></a><span class="lineno"> 210</span> <span class="p">{</span>
<a name="c0-211"></a><span class="lineno"> 211</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">datalen</span><span class="p">;</span>
<a name="c0-212"></a><span class="lineno"> 212</span>   <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-213"></a><span class="lineno"> 213</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">header</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">dheader</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<a name="c0-214"></a><span class="lineno"> 214</span>   <span class="kt">unsigned</span> <span class="n">hdrlen</span><span class="p">;</span>
<a name="c0-215"></a><span class="lineno"> 215</span>   <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-216"></a><span class="lineno"> 216</span>   <span class="kt">int</span> <span class="n">usable_delta</span><span class="p">,</span> <span class="n">to_reuse</span><span class="p">;</span>
<a name="c0-217"></a><span class="lineno"> 217</span> 
<a name="c0-218"></a><span class="lineno"> 218</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-219"></a><span class="lineno"> 219</span>     <span class="n">crc32_begin</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c0-220"></a><span class="lineno"> 220</span> 
<a name="c0-221"></a><span class="lineno"> 221</span>   <span class="n">type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
<a name="c0-222"></a><span class="lineno"> 222</span> 
<a name="c0-223"></a><span class="lineno"> 223</span>   <span class="cm">/* apply size limit if limited packsize and not first object */</span>
<a name="c0-224"></a><span class="lineno"> 224</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_size_limit</span> <span class="o">||</span> <span class="o">!</span><span class="n">nr_written</span><span class="p">)</span>
<a name="c0-225"></a><span class="lineno"> 225</span>     <span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-226"></a><span class="lineno"> 226</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pack_size_limit</span> <span class="o">&lt;=</span> <span class="n">write_offset</span><span class="p">)</span>
<a name="c0-227"></a><span class="lineno"> 227</span>     <span class="cm">/*</span>
<a name="c0-228"></a><span class="lineno"> 228</span> <span class="cm">    * the earlier object did not fit the limit; avoid</span>
<a name="c0-229"></a><span class="lineno"> 229</span> <span class="cm">    * mistaking this with unlimited (i.e. limit = 0).</span>
<a name="c0-230"></a><span class="lineno"> 230</span> <span class="cm">    */</span>
<a name="c0-231"></a><span class="lineno"> 231</span>     <span class="n">limit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-232"></a><span class="lineno"> 232</span>   <span class="k">else</span>
<a name="c0-233"></a><span class="lineno"> 233</span>     <span class="n">limit</span> <span class="o">=</span> <span class="n">pack_size_limit</span> <span class="o">-</span> <span class="n">write_offset</span><span class="p">;</span>
<a name="c0-234"></a><span class="lineno"> 234</span> 
<a name="c0-235"></a><span class="lineno"> 235</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span>
<a name="c0-236"></a><span class="lineno"> 236</span>     <span class="n">usable_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no delta */</span>
<a name="c0-237"></a><span class="lineno"> 237</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_size_limit</span><span class="p">)</span>
<a name="c0-238"></a><span class="lineno"> 238</span>          <span class="n">usable_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* unlimited packfile */</span>
<a name="c0-239"></a><span class="lineno"> 239</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-240"></a><span class="lineno"> 240</span>     <span class="n">usable_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* base was written to another pack */</span>
<a name="c0-241"></a><span class="lineno"> 241</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
<a name="c0-242"></a><span class="lineno"> 242</span>     <span class="n">usable_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* base already exists in this pack */</span>
<a name="c0-243"></a><span class="lineno"> 243</span>   <span class="k">else</span>
<a name="c0-244"></a><span class="lineno"> 244</span>     <span class="n">usable_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* base could end up in another pack */</span>
<a name="c0-245"></a><span class="lineno"> 245</span> 
<a name="c0-246"></a><span class="lineno"> 246</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reuse_object</span><span class="p">)</span>
<a name="c0-247"></a><span class="lineno"> 247</span>     <span class="n">to_reuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* explicit */</span>
<a name="c0-248"></a><span class="lineno"> 248</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">)</span>
<a name="c0-249"></a><span class="lineno"> 249</span>     <span class="n">to_reuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* can't reuse what we don't have */</span>
<a name="c0-250"></a><span class="lineno"> 250</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_REF_DELTA</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_OFS_DELTA</span><span class="p">)</span>
<a name="c0-251"></a><span class="lineno"> 251</span>         <span class="cm">/* check_object() decided it for us ... */</span>
<a name="c0-252"></a><span class="lineno"> 252</span>     <span class="n">to_reuse</span> <span class="o">=</span> <span class="n">usable_delta</span><span class="p">;</span>
<a name="c0-253"></a><span class="lineno"> 253</span>         <span class="cm">/* ... but pack split may override that */</span>
<a name="c0-254"></a><span class="lineno"> 254</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span><span class="p">)</span>
<a name="c0-255"></a><span class="lineno"> 255</span>     <span class="n">to_reuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* pack has delta which is unusable */</span>
<a name="c0-256"></a><span class="lineno"> 256</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span>
<a name="c0-257"></a><span class="lineno"> 257</span>     <span class="n">to_reuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* we want to pack afresh */</span>
<a name="c0-258"></a><span class="lineno"> 258</span>   <span class="k">else</span>
<a name="c0-259"></a><span class="lineno"> 259</span>     <span class="n">to_reuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* we have it in-pack undeltified,</span>
<a name="c0-260"></a><span class="lineno"> 260</span> <span class="cm">        * and we do not need to deltify it.</span>
<a name="c0-261"></a><span class="lineno"> 261</span> <span class="cm">        */</span>
<a name="c0-262"></a><span class="lineno"> 262</span> 
<a name="c0-263"></a><span class="lineno"> 263</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to_reuse</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-264"></a><span class="lineno"> 264</span>     <span class="nl">no_reuse:</span>
<a name="c0-265"></a><span class="lineno"> 265</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usable_delta</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-266"></a><span class="lineno"> 266</span>       <span class="n">buf</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-267"></a><span class="lineno"> 267</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-268"></a><span class="lineno"> 268</span>         <span class="n">die</span><span class="p">(</span><span class="s">"unable to read %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-269"></a><span class="lineno"> 269</span>       <span class="cm">/*</span>
<a name="c0-270"></a><span class="lineno"> 270</span> <span class="cm">      * make sure no cached delta data remains from a</span>
<a name="c0-271"></a><span class="lineno"> 271</span> <span class="cm">      * previous attempt before a pack split occurred.</span>
<a name="c0-272"></a><span class="lineno"> 272</span> <span class="cm">      */</span>
<a name="c0-273"></a><span class="lineno"> 273</span>       <span class="n">free</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span><span class="p">);</span>
<a name="c0-274"></a><span class="lineno"> 274</span>       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-275"></a><span class="lineno"> 275</span>       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">z_delta_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-276"></a><span class="lineno"> 276</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-277"></a><span class="lineno"> 277</span>       <span class="n">size</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">;</span>
<a name="c0-278"></a><span class="lineno"> 278</span>       <span class="n">buf</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span><span class="p">;</span>
<a name="c0-279"></a><span class="lineno"> 279</span>       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-280"></a><span class="lineno"> 280</span>       <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">allow_ofs_delta</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
<a name="c0-281"></a><span class="lineno"> 281</span>         <span class="n">OBJ_OFS_DELTA</span> <span class="o">:</span> <span class="n">OBJ_REF_DELTA</span><span class="p">;</span>
<a name="c0-282"></a><span class="lineno"> 282</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-283"></a><span class="lineno"> 283</span>       <span class="n">buf</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<a name="c0-284"></a><span class="lineno"> 284</span>       <span class="n">size</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">;</span>
<a name="c0-285"></a><span class="lineno"> 285</span>       <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">allow_ofs_delta</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
<a name="c0-286"></a><span class="lineno"> 286</span>         <span class="n">OBJ_OFS_DELTA</span> <span class="o">:</span> <span class="n">OBJ_REF_DELTA</span><span class="p">;</span>
<a name="c0-287"></a><span class="lineno"> 287</span>     <span class="p">}</span>
<a name="c0-288"></a><span class="lineno"> 288</span> 
<a name="c0-289"></a><span class="lineno"> 289</span>     <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">z_delta_size</span><span class="p">)</span>
<a name="c0-290"></a><span class="lineno"> 290</span>       <span class="n">datalen</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">z_delta_size</span><span class="p">;</span>
<a name="c0-291"></a><span class="lineno"> 291</span>     <span class="k">else</span>
<a name="c0-292"></a><span class="lineno"> 292</span>       <span class="n">datalen</span> <span class="o">=</span> <span class="n">do_compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-293"></a><span class="lineno"> 293</span> 
<a name="c0-294"></a><span class="lineno"> 294</span>     <span class="cm">/*</span>
<a name="c0-295"></a><span class="lineno"> 295</span> <span class="cm">    * The object header is a byte of 'type' followed by zero or</span>
<a name="c0-296"></a><span class="lineno"> 296</span> <span class="cm">    * more bytes of length.</span>
<a name="c0-297"></a><span class="lineno"> 297</span> <span class="cm">    */</span>
<a name="c0-298"></a><span class="lineno"> 298</span>     <span class="n">hdrlen</span> <span class="o">=</span> <span class="n">encode_in_pack_object_header</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
<a name="c0-299"></a><span class="lineno"> 299</span> 
<a name="c0-300"></a><span class="lineno"> 300</span>     <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_OFS_DELTA</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-301"></a><span class="lineno"> 301</span>       <span class="cm">/*</span>
<a name="c0-302"></a><span class="lineno"> 302</span> <span class="cm">      * Deltas with relative base contain an additional</span>
<a name="c0-303"></a><span class="lineno"> 303</span> <span class="cm">      * encoding of the relative offset for the delta</span>
<a name="c0-304"></a><span class="lineno"> 304</span> <span class="cm">      * base from this object's position in the pack.</span>
<a name="c0-305"></a><span class="lineno"> 305</span> <span class="cm">      */</span>
<a name="c0-306"></a><span class="lineno"> 306</span>       <span class="kt">off_t</span> <span class="n">ofs</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
<a name="c0-307"></a><span class="lineno"> 307</span>       <span class="kt">unsigned</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-308"></a><span class="lineno"> 308</span>       <span class="n">dheader</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
<a name="c0-309"></a><span class="lineno"> 309</span>       <span class="k">while</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span><span class="p">)</span>
<a name="c0-310"></a><span class="lineno"> 310</span>         <span class="n">dheader</span><span class="p">[</span><span class="o">--</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">|</span> <span class="p">(</span><span class="o">--</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">);</span>
<a name="c0-311"></a><span class="lineno"> 311</span>       <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-312"></a><span class="lineno"> 312</span>         <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-313"></a><span class="lineno"> 313</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-314"></a><span class="lineno"> 314</span>       <span class="p">}</span>
<a name="c0-315"></a><span class="lineno"> 315</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
<a name="c0-316"></a><span class="lineno"> 316</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dheader</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
<a name="c0-317"></a><span class="lineno"> 317</span>       <span class="n">hdrlen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
<a name="c0-318"></a><span class="lineno"> 318</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_REF_DELTA</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-319"></a><span class="lineno"> 319</span>       <span class="cm">/*</span>
<a name="c0-320"></a><span class="lineno"> 320</span> <span class="cm">      * Deltas with a base reference contain</span>
<a name="c0-321"></a><span class="lineno"> 321</span> <span class="cm">      * an additional 20 bytes for the base sha1.</span>
<a name="c0-322"></a><span class="lineno"> 322</span> <span class="cm">      */</span>
<a name="c0-323"></a><span class="lineno"> 323</span>       <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-324"></a><span class="lineno"> 324</span>         <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-325"></a><span class="lineno"> 325</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-326"></a><span class="lineno"> 326</span>       <span class="p">}</span>
<a name="c0-327"></a><span class="lineno"> 327</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
<a name="c0-328"></a><span class="lineno"> 328</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<a name="c0-329"></a><span class="lineno"> 329</span>       <span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span>
<a name="c0-330"></a><span class="lineno"> 330</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-331"></a><span class="lineno"> 331</span>       <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-332"></a><span class="lineno"> 332</span>         <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-333"></a><span class="lineno"> 333</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-334"></a><span class="lineno"> 334</span>       <span class="p">}</span>
<a name="c0-335"></a><span class="lineno"> 335</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
<a name="c0-336"></a><span class="lineno"> 336</span>     <span class="p">}</span>
<a name="c0-337"></a><span class="lineno"> 337</span>     <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
<a name="c0-338"></a><span class="lineno"> 338</span>     <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-339"></a><span class="lineno"> 339</span>   <span class="p">}</span>
<a name="c0-340"></a><span class="lineno"> 340</span>   <span class="k">else</span> <span class="p">{</span>
<a name="c0-341"></a><span class="lineno"> 341</span>     <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">;</span>
<a name="c0-342"></a><span class="lineno"> 342</span>     <span class="k">struct</span> <span class="n">pack_window</span> <span class="o">*</span><span class="n">w_curs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-343"></a><span class="lineno"> 343</span>     <span class="k">struct</span> <span class="n">revindex_entry</span> <span class="o">*</span><span class="n">revidx</span><span class="p">;</span>
<a name="c0-344"></a><span class="lineno"> 344</span>     <span class="kt">off_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-345"></a><span class="lineno"> 345</span> 
<a name="c0-346"></a><span class="lineno"> 346</span>     <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span>
<a name="c0-347"></a><span class="lineno"> 347</span>       <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">allow_ofs_delta</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span>
<a name="c0-348"></a><span class="lineno"> 348</span>         <span class="n">OBJ_OFS_DELTA</span> <span class="o">:</span> <span class="n">OBJ_REF_DELTA</span><span class="p">;</span>
<a name="c0-349"></a><span class="lineno"> 349</span>     <span class="n">hdrlen</span> <span class="o">=</span> <span class="n">encode_in_pack_object_header</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
<a name="c0-350"></a><span class="lineno"> 350</span> 
<a name="c0-351"></a><span class="lineno"> 351</span>     <span class="n">offset</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span><span class="p">;</span>
<a name="c0-352"></a><span class="lineno"> 352</span>     <span class="n">revidx</span> <span class="o">=</span> <span class="n">find_pack_revindex</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<a name="c0-353"></a><span class="lineno"> 353</span>     <span class="n">datalen</span> <span class="o">=</span> <span class="n">revidx</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-354"></a><span class="lineno"> 354</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index_version</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
<a name="c0-355"></a><span class="lineno"> 355</span>         <span class="n">check_pack_crc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">revidx</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-356"></a><span class="lineno"> 356</span>       <span class="n">error</span><span class="p">(</span><span class="s">"bad packed object CRC for %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-357"></a><span class="lineno"> 357</span>       <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-358"></a><span class="lineno"> 358</span>       <span class="k">goto</span> <span class="n">no_reuse</span><span class="p">;</span>
<a name="c0-359"></a><span class="lineno"> 359</span>     <span class="p">}</span>
<a name="c0-360"></a><span class="lineno"> 360</span> 
<a name="c0-361"></a><span class="lineno"> 361</span>     <span class="n">offset</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_header_size</span><span class="p">;</span>
<a name="c0-362"></a><span class="lineno"> 362</span>     <span class="n">datalen</span> <span class="o">-=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_header_size</span><span class="p">;</span>
<a name="c0-363"></a><span class="lineno"> 363</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index_version</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
<a name="c0-364"></a><span class="lineno"> 364</span>         <span class="n">check_pack_inflate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-365"></a><span class="lineno"> 365</span>       <span class="n">error</span><span class="p">(</span><span class="s">"corrupt packed object for %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-366"></a><span class="lineno"> 366</span>       <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-367"></a><span class="lineno"> 367</span>       <span class="k">goto</span> <span class="n">no_reuse</span><span class="p">;</span>
<a name="c0-368"></a><span class="lineno"> 368</span>     <span class="p">}</span>
<a name="c0-369"></a><span class="lineno"> 369</span> 
<a name="c0-370"></a><span class="lineno"> 370</span>     <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_OFS_DELTA</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-371"></a><span class="lineno"> 371</span>       <span class="kt">off_t</span> <span class="n">ofs</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">-</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
<a name="c0-372"></a><span class="lineno"> 372</span>       <span class="kt">unsigned</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-373"></a><span class="lineno"> 373</span>       <span class="n">dheader</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofs</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
<a name="c0-374"></a><span class="lineno"> 374</span>       <span class="k">while</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span><span class="p">)</span>
<a name="c0-375"></a><span class="lineno"> 375</span>         <span class="n">dheader</span><span class="p">[</span><span class="o">--</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">|</span> <span class="p">(</span><span class="o">--</span><span class="n">ofs</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">);</span>
<a name="c0-376"></a><span class="lineno"> 376</span>       <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-377"></a><span class="lineno"> 377</span>         <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-378"></a><span class="lineno"> 378</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-379"></a><span class="lineno"> 379</span>       <span class="p">}</span>
<a name="c0-380"></a><span class="lineno"> 380</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
<a name="c0-381"></a><span class="lineno"> 381</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dheader</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
<a name="c0-382"></a><span class="lineno"> 382</span>       <span class="n">hdrlen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dheader</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
<a name="c0-383"></a><span class="lineno"> 383</span>       <span class="n">reused_delta</span><span class="o">++</span><span class="p">;</span>
<a name="c0-384"></a><span class="lineno"> 384</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_REF_DELTA</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-385"></a><span class="lineno"> 385</span>       <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-386"></a><span class="lineno"> 386</span>         <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-387"></a><span class="lineno"> 387</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-388"></a><span class="lineno"> 388</span>       <span class="p">}</span>
<a name="c0-389"></a><span class="lineno"> 389</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
<a name="c0-390"></a><span class="lineno"> 390</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<a name="c0-391"></a><span class="lineno"> 391</span>       <span class="n">hdrlen</span> <span class="o">+=</span> <span class="mi">20</span><span class="p">;</span>
<a name="c0-392"></a><span class="lineno"> 392</span>       <span class="n">reused_delta</span><span class="o">++</span><span class="p">;</span>
<a name="c0-393"></a><span class="lineno"> 393</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-394"></a><span class="lineno"> 394</span>       <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-395"></a><span class="lineno"> 395</span>         <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-396"></a><span class="lineno"> 396</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-397"></a><span class="lineno"> 397</span>       <span class="p">}</span>
<a name="c0-398"></a><span class="lineno"> 398</span>       <span class="n">sha1write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
<a name="c0-399"></a><span class="lineno"> 399</span>     <span class="p">}</span>
<a name="c0-400"></a><span class="lineno"> 400</span>     <span class="n">copy_pack_data</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>
<a name="c0-401"></a><span class="lineno"> 401</span>     <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-402"></a><span class="lineno"> 402</span>     <span class="n">reused</span><span class="o">++</span><span class="p">;</span>
<a name="c0-403"></a><span class="lineno"> 403</span>   <span class="p">}</span>
<a name="c0-404"></a><span class="lineno"> 404</span>   <span class="k">if</span> <span class="p">(</span><span class="n">usable_delta</span><span class="p">)</span>
<a name="c0-405"></a><span class="lineno"> 405</span>     <span class="n">written_delta</span><span class="o">++</span><span class="p">;</span>
<a name="c0-406"></a><span class="lineno"> 406</span>   <span class="n">written</span><span class="o">++</span><span class="p">;</span>
<a name="c0-407"></a><span class="lineno"> 407</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-408"></a><span class="lineno"> 408</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">crc32</span> <span class="o">=</span> <span class="n">crc32_end</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c0-409"></a><span class="lineno"> 409</span>   <span class="k">return</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="n">datalen</span><span class="p">;</span>
<a name="c0-410"></a><span class="lineno"> 410</span> <span class="p">}</span>
<a name="c0-411"></a><span class="lineno"> 411</span> 
<a name="c0-412"></a><span class="lineno"> 412</span> <span class="k">enum</span> <span class="n">write_one_status</span> <span class="p">{</span>
<a name="c0-413"></a><span class="lineno"> 413</span>   <span class="n">WRITE_ONE_SKIP</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* already written */</span>
<a name="c0-414"></a><span class="lineno"> 414</span>   <span class="n">WRITE_ONE_BREAK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* writing this will bust the limit; not written */</span>
<a name="c0-415"></a><span class="lineno"> 415</span>   <span class="n">WRITE_ONE_WRITTEN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* normal */</span>
<a name="c0-416"></a><span class="lineno"> 416</span>   <span class="n">WRITE_ONE_RECURSIVE</span> <span class="o">=</span> <span class="mi">2</span> <span class="cm">/* already scheduled to be written */</span>
<a name="c0-417"></a><span class="lineno"> 417</span> <span class="p">};</span>
<a name="c0-418"></a><span class="lineno"> 418</span> 
<a name="c0-419"></a><span class="lineno"> 419</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">write_one_status</span> <span class="nf">write_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">sha1file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
<a name="c0-420"></a><span class="lineno"> 420</span>                <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
<a name="c0-421"></a><span class="lineno"> 421</span>                <span class="kt">off_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<a name="c0-422"></a><span class="lineno"> 422</span> <span class="p">{</span>
<a name="c0-423"></a><span class="lineno"> 423</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-424"></a><span class="lineno"> 424</span>   <span class="kt">int</span> <span class="n">recursing</span><span class="p">;</span>
<a name="c0-425"></a><span class="lineno"> 425</span> 
<a name="c0-426"></a><span class="lineno"> 426</span>   <span class="cm">/*</span>
<a name="c0-427"></a><span class="lineno"> 427</span> <span class="cm">  * we set offset to 1 (which is an impossible value) to mark</span>
<a name="c0-428"></a><span class="lineno"> 428</span> <span class="cm">  * the fact that this object is involved in "write its base</span>
<a name="c0-429"></a><span class="lineno"> 429</span> <span class="cm">  * first before writing a deltified object" recursion.</span>
<a name="c0-430"></a><span class="lineno"> 430</span> <span class="cm">  */</span>
<a name="c0-431"></a><span class="lineno"> 431</span>   <span class="n">recursing</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-432"></a><span class="lineno"> 432</span>   <span class="k">if</span> <span class="p">(</span><span class="n">recursing</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-433"></a><span class="lineno"> 433</span>     <span class="n">warning</span><span class="p">(</span><span class="s">"recursive delta detected for object %s"</span><span class="p">,</span>
<a name="c0-434"></a><span class="lineno"> 434</span>       <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-435"></a><span class="lineno"> 435</span>     <span class="k">return</span> <span class="n">WRITE_ONE_RECURSIVE</span><span class="p">;</span>
<a name="c0-436"></a><span class="lineno"> 436</span>   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-437"></a><span class="lineno"> 437</span>     <span class="cm">/* offset is non zero if object is written already. */</span>
<a name="c0-438"></a><span class="lineno"> 438</span>     <span class="k">return</span> <span class="n">WRITE_ONE_SKIP</span><span class="p">;</span>
<a name="c0-439"></a><span class="lineno"> 439</span>   <span class="p">}</span>
<a name="c0-440"></a><span class="lineno"> 440</span> 
<a name="c0-441"></a><span class="lineno"> 441</span>   <span class="cm">/* if we are deltified, write out base object first. */</span>
<a name="c0-442"></a><span class="lineno"> 442</span>   <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-443"></a><span class="lineno"> 443</span>     <span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* now recurse */</span>
<a name="c0-444"></a><span class="lineno"> 444</span>     <span class="k">switch</span> <span class="p">(</span><span class="n">write_one</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-445"></a><span class="lineno"> 445</span>     <span class="k">case</span> <span class="n">WRITE_ONE_RECURSIVE</span>:
<a name="c0-446"></a><span class="lineno"> 446</span>       <span class="cm">/* we cannot depend on this one */</span>
<a name="c0-447"></a><span class="lineno"> 447</span>       <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-448"></a><span class="lineno"> 448</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-449"></a><span class="lineno"> 449</span>     <span class="nl">default:</span>
<a name="c0-450"></a><span class="lineno"> 450</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-451"></a><span class="lineno"> 451</span>     <span class="k">case</span> <span class="n">WRITE_ONE_BREAK</span>:
<a name="c0-452"></a><span class="lineno"> 452</span>       <span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">recursing</span><span class="p">;</span>
<a name="c0-453"></a><span class="lineno"> 453</span>       <span class="k">return</span> <span class="n">WRITE_ONE_BREAK</span><span class="p">;</span>
<a name="c0-454"></a><span class="lineno"> 454</span>     <span class="p">}</span>
<a name="c0-455"></a><span class="lineno"> 455</span>   <span class="p">}</span>
<a name="c0-456"></a><span class="lineno"> 456</span> 
<a name="c0-457"></a><span class="lineno"> 457</span>   <span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
<a name="c0-458"></a><span class="lineno"> 458</span>   <span class="n">size</span> <span class="o">=</span> <span class="n">write_object</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">offset</span><span class="p">);</span>
<a name="c0-459"></a><span class="lineno"> 459</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-460"></a><span class="lineno"> 460</span>     <span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">recursing</span><span class="p">;</span>
<a name="c0-461"></a><span class="lineno"> 461</span>     <span class="k">return</span> <span class="n">WRITE_ONE_BREAK</span><span class="p">;</span>
<a name="c0-462"></a><span class="lineno"> 462</span>   <span class="p">}</span>
<a name="c0-463"></a><span class="lineno"> 463</span>   <span class="n">written_list</span><span class="p">[</span><span class="n">nr_written</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
<a name="c0-464"></a><span class="lineno"> 464</span> 
<a name="c0-465"></a><span class="lineno"> 465</span>   <span class="cm">/* make sure off_t is sufficiently large not to wrap */</span>
<a name="c0-466"></a><span class="lineno"> 466</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signed_add_overflows</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
<a name="c0-467"></a><span class="lineno"> 467</span>     <span class="n">die</span><span class="p">(</span><span class="s">"pack too large for current definition of off_t"</span><span class="p">);</span>
<a name="c0-468"></a><span class="lineno"> 468</span>   <span class="o">*</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-469"></a><span class="lineno"> 469</span>   <span class="k">return</span> <span class="n">WRITE_ONE_WRITTEN</span><span class="p">;</span>
<a name="c0-470"></a><span class="lineno"> 470</span> <span class="p">}</span>
<a name="c0-471"></a><span class="lineno"> 471</span> 
<a name="c0-472"></a><span class="lineno"> 472</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">mark_tagged</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span>
<a name="c0-473"></a><span class="lineno"> 473</span>            <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<a name="c0-474"></a><span class="lineno"> 474</span> <span class="p">{</span>
<a name="c0-475"></a><span class="lineno"> 475</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">peeled</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-476"></a><span class="lineno"> 476</span>   <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">locate_object_entry</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-477"></a><span class="lineno"> 477</span> 
<a name="c0-478"></a><span class="lineno"> 478</span>   <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<a name="c0-479"></a><span class="lineno"> 479</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">tagged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-480"></a><span class="lineno"> 480</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peel_ref</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">peeled</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-481"></a><span class="lineno"> 481</span>     <span class="n">entry</span> <span class="o">=</span> <span class="n">locate_object_entry</span><span class="p">(</span><span class="n">peeled</span><span class="p">);</span>
<a name="c0-482"></a><span class="lineno"> 482</span>     <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<a name="c0-483"></a><span class="lineno"> 483</span>       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">tagged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-484"></a><span class="lineno"> 484</span>   <span class="p">}</span>
<a name="c0-485"></a><span class="lineno"> 485</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-486"></a><span class="lineno"> 486</span> <span class="p">}</span>
<a name="c0-487"></a><span class="lineno"> 487</span> 
<a name="c0-488"></a><span class="lineno"> 488</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">add_to_write_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">wo</span><span class="p">,</span>
<a name="c0-489"></a><span class="lineno"> 489</span>              <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">endp</span><span class="p">,</span>
<a name="c0-490"></a><span class="lineno"> 490</span>              <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<a name="c0-491"></a><span class="lineno"> 491</span> <span class="p">{</span>
<a name="c0-492"></a><span class="lineno"> 492</span>   <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">filled</span><span class="p">)</span>
<a name="c0-493"></a><span class="lineno"> 493</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-494"></a><span class="lineno"> 494</span>   <span class="n">wo</span><span class="p">[(</span><span class="o">*</span><span class="n">endp</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
<a name="c0-495"></a><span class="lineno"> 495</span>   <span class="n">e</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-496"></a><span class="lineno"> 496</span> <span class="p">}</span>
<a name="c0-497"></a><span class="lineno"> 497</span> 
<a name="c0-498"></a><span class="lineno"> 498</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_descendants_to_write_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">wo</span><span class="p">,</span>
<a name="c0-499"></a><span class="lineno"> 499</span>              <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">endp</span><span class="p">,</span>
<a name="c0-500"></a><span class="lineno"> 500</span>              <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<a name="c0-501"></a><span class="lineno"> 501</span> <span class="p">{</span>
<a name="c0-502"></a><span class="lineno"> 502</span>   <span class="kt">int</span> <span class="n">add_to_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-503"></a><span class="lineno"> 503</span>   <span class="k">while</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-504"></a><span class="lineno"> 504</span>     <span class="k">if</span> <span class="p">(</span><span class="n">add_to_order</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-505"></a><span class="lineno"> 505</span>       <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="c0-506"></a><span class="lineno"> 506</span>       <span class="cm">/* add this node... */</span>
<a name="c0-507"></a><span class="lineno"> 507</span>       <span class="n">add_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<a name="c0-508"></a><span class="lineno"> 508</span>       <span class="cm">/* all its siblings... */</span>
<a name="c0-509"></a><span class="lineno"> 509</span>       <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">;</span> <span class="n">s</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-510"></a><span class="lineno"> 510</span>         <span class="n">add_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<a name="c0-511"></a><span class="lineno"> 511</span>       <span class="p">}</span>
<a name="c0-512"></a><span class="lineno"> 512</span>     <span class="p">}</span>
<a name="c0-513"></a><span class="lineno"> 513</span>     <span class="cm">/* drop down a level to add left subtree nodes if possible */</span>
<a name="c0-514"></a><span class="lineno"> 514</span>     <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_child</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-515"></a><span class="lineno"> 515</span>       <span class="n">add_to_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-516"></a><span class="lineno"> 516</span>       <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_child</span><span class="p">;</span>
<a name="c0-517"></a><span class="lineno"> 517</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-518"></a><span class="lineno"> 518</span>       <span class="n">add_to_order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-519"></a><span class="lineno"> 519</span>       <span class="cm">/* our sibling might have some children, it is next */</span>
<a name="c0-520"></a><span class="lineno"> 520</span>       <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-521"></a><span class="lineno"> 521</span>         <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">;</span>
<a name="c0-522"></a><span class="lineno"> 522</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c0-523"></a><span class="lineno"> 523</span>       <span class="p">}</span>
<a name="c0-524"></a><span class="lineno"> 524</span>       <span class="cm">/* go back to our parent node */</span>
<a name="c0-525"></a><span class="lineno"> 525</span>       <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">;</span>
<a name="c0-526"></a><span class="lineno"> 526</span>       <span class="k">while</span> <span class="p">(</span><span class="n">e</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-527"></a><span class="lineno"> 527</span>         <span class="cm">/* we're on the right side of a subtree, keep</span>
<a name="c0-528"></a><span class="lineno"> 528</span> <span class="cm">        * going up until we can go right again */</span>
<a name="c0-529"></a><span class="lineno"> 529</span>         <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">;</span>
<a name="c0-530"></a><span class="lineno"> 530</span>       <span class="p">}</span>
<a name="c0-531"></a><span class="lineno"> 531</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-532"></a><span class="lineno"> 532</span>         <span class="cm">/* done- we hit our original root node */</span>
<a name="c0-533"></a><span class="lineno"> 533</span>         <span class="k">return</span><span class="p">;</span>
<a name="c0-534"></a><span class="lineno"> 534</span>       <span class="p">}</span>
<a name="c0-535"></a><span class="lineno"> 535</span>       <span class="cm">/* pass it off to sibling at this level */</span>
<a name="c0-536"></a><span class="lineno"> 536</span>       <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">;</span>
<a name="c0-537"></a><span class="lineno"> 537</span>     <span class="p">}</span>
<a name="c0-538"></a><span class="lineno"> 538</span>   <span class="p">};</span>
<a name="c0-539"></a><span class="lineno"> 539</span> <span class="p">}</span>
<a name="c0-540"></a><span class="lineno"> 540</span> 
<a name="c0-541"></a><span class="lineno"> 541</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_family_to_write_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">wo</span><span class="p">,</span>
<a name="c0-542"></a><span class="lineno"> 542</span>               <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">endp</span><span class="p">,</span>
<a name="c0-543"></a><span class="lineno"> 543</span>               <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<a name="c0-544"></a><span class="lineno"> 544</span> <span class="p">{</span>
<a name="c0-545"></a><span class="lineno"> 545</span>   <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
<a name="c0-546"></a><span class="lineno"> 546</span> 
<a name="c0-547"></a><span class="lineno"> 547</span>   <span class="k">for</span> <span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span>
<a name="c0-548"></a><span class="lineno"> 548</span>     <span class="p">;</span> <span class="cm">/* nothing */</span>
<a name="c0-549"></a><span class="lineno"> 549</span>   <span class="n">add_descendants_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="n">endp</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<a name="c0-550"></a><span class="lineno"> 550</span> <span class="p">}</span>
<a name="c0-551"></a><span class="lineno"> 551</span> 
<a name="c0-552"></a><span class="lineno"> 552</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="nf">compute_write_order</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-553"></a><span class="lineno"> 553</span> <span class="p">{</span>
<a name="c0-554"></a><span class="lineno"> 554</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">wo_end</span><span class="p">,</span> <span class="n">last_untagged</span><span class="p">;</span>
<a name="c0-555"></a><span class="lineno"> 555</span> 
<a name="c0-556"></a><span class="lineno"> 556</span>   <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">wo</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">nr_objects</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wo</span><span class="p">));</span>
<a name="c0-557"></a><span class="lineno"> 557</span> 
<a name="c0-558"></a><span class="lineno"> 558</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-559"></a><span class="lineno"> 559</span>     <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tagged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-560"></a><span class="lineno"> 560</span>     <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-561"></a><span class="lineno"> 561</span>     <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">delta_child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-562"></a><span class="lineno"> 562</span>     <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">delta_sibling</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-563"></a><span class="lineno"> 563</span>   <span class="p">}</span>
<a name="c0-564"></a><span class="lineno"> 564</span> 
<a name="c0-565"></a><span class="lineno"> 565</span>   <span class="cm">/*</span>
<a name="c0-566"></a><span class="lineno"> 566</span> <span class="cm">  * Fully connect delta_child/delta_sibling network.</span>
<a name="c0-567"></a><span class="lineno"> 567</span> <span class="cm">  * Make sure delta_sibling is sorted in the original</span>
<a name="c0-568"></a><span class="lineno"> 568</span> <span class="cm">  * recency order.</span>
<a name="c0-569"></a><span class="lineno"> 569</span> <span class="cm">  */</span>
<a name="c0-570"></a><span class="lineno"> 570</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
<a name="c0-571"></a><span class="lineno"> 571</span>     <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">];</span>
<a name="c0-572"></a><span class="lineno"> 572</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span>
<a name="c0-573"></a><span class="lineno"> 573</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c0-574"></a><span class="lineno"> 574</span>     <span class="cm">/* Mark me as the first child */</span>
<a name="c0-575"></a><span class="lineno"> 575</span>     <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta_sibling</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">delta_child</span><span class="p">;</span>
<a name="c0-576"></a><span class="lineno"> 576</span>     <span class="n">e</span><span class="o">-&gt;</span><span class="n">delta</span><span class="o">-&gt;</span><span class="n">delta_child</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
<a name="c0-577"></a><span class="lineno"> 577</span>   <span class="p">}</span>
<a name="c0-578"></a><span class="lineno"> 578</span> 
<a name="c0-579"></a><span class="lineno"> 579</span>   <span class="cm">/*</span>
<a name="c0-580"></a><span class="lineno"> 580</span> <span class="cm">  * Mark objects that are at the tip of tags.</span>
<a name="c0-581"></a><span class="lineno"> 581</span> <span class="cm">  */</span>
<a name="c0-582"></a><span class="lineno"> 582</span>   <span class="n">for_each_tag_ref</span><span class="p">(</span><span class="n">mark_tagged</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-583"></a><span class="lineno"> 583</span> 
<a name="c0-584"></a><span class="lineno"> 584</span>   <span class="cm">/*</span>
<a name="c0-585"></a><span class="lineno"> 585</span> <span class="cm">  * Give the objects in the original recency order until</span>
<a name="c0-586"></a><span class="lineno"> 586</span> <span class="cm">  * we see a tagged tip.</span>
<a name="c0-587"></a><span class="lineno"> 587</span> <span class="cm">  */</span>
<a name="c0-588"></a><span class="lineno"> 588</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">wo_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-589"></a><span class="lineno"> 589</span>     <span class="k">if</span> <span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tagged</span><span class="p">)</span>
<a name="c0-590"></a><span class="lineno"> 590</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-591"></a><span class="lineno"> 591</span>     <span class="n">add_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wo_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-592"></a><span class="lineno"> 592</span>   <span class="p">}</span>
<a name="c0-593"></a><span class="lineno"> 593</span>   <span class="n">last_untagged</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-594"></a><span class="lineno"> 594</span> 
<a name="c0-595"></a><span class="lineno"> 595</span>   <span class="cm">/*</span>
<a name="c0-596"></a><span class="lineno"> 596</span> <span class="cm">  * Then fill all the tagged tips.</span>
<a name="c0-597"></a><span class="lineno"> 597</span> <span class="cm">  */</span>
<a name="c0-598"></a><span class="lineno"> 598</span>   <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-599"></a><span class="lineno"> 599</span>     <span class="k">if</span> <span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tagged</span><span class="p">)</span>
<a name="c0-600"></a><span class="lineno"> 600</span>       <span class="n">add_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wo_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-601"></a><span class="lineno"> 601</span>   <span class="p">}</span>
<a name="c0-602"></a><span class="lineno"> 602</span> 
<a name="c0-603"></a><span class="lineno"> 603</span>   <span class="cm">/*</span>
<a name="c0-604"></a><span class="lineno"> 604</span> <span class="cm">  * And then all remaining commits and tags.</span>
<a name="c0-605"></a><span class="lineno"> 605</span> <span class="cm">  */</span>
<a name="c0-606"></a><span class="lineno"> 606</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">last_untagged</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-607"></a><span class="lineno"> 607</span>     <span class="k">if</span> <span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_COMMIT</span> <span class="o">&amp;&amp;</span>
<a name="c0-608"></a><span class="lineno"> 608</span>         <span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_TAG</span><span class="p">)</span>
<a name="c0-609"></a><span class="lineno"> 609</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c0-610"></a><span class="lineno"> 610</span>     <span class="n">add_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wo_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-611"></a><span class="lineno"> 611</span>   <span class="p">}</span>
<a name="c0-612"></a><span class="lineno"> 612</span> 
<a name="c0-613"></a><span class="lineno"> 613</span>   <span class="cm">/*</span>
<a name="c0-614"></a><span class="lineno"> 614</span> <span class="cm">  * And then all the trees.</span>
<a name="c0-615"></a><span class="lineno"> 615</span> <span class="cm">  */</span>
<a name="c0-616"></a><span class="lineno"> 616</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">last_untagged</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-617"></a><span class="lineno"> 617</span>     <span class="k">if</span> <span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_TREE</span><span class="p">)</span>
<a name="c0-618"></a><span class="lineno"> 618</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c0-619"></a><span class="lineno"> 619</span>     <span class="n">add_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wo_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-620"></a><span class="lineno"> 620</span>   <span class="p">}</span>
<a name="c0-621"></a><span class="lineno"> 621</span> 
<a name="c0-622"></a><span class="lineno"> 622</span>   <span class="cm">/*</span>
<a name="c0-623"></a><span class="lineno"> 623</span> <span class="cm">  * Finally all the rest in really tight order</span>
<a name="c0-624"></a><span class="lineno"> 624</span> <span class="cm">  */</span>
<a name="c0-625"></a><span class="lineno"> 625</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">last_untagged</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-626"></a><span class="lineno"> 626</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">filled</span><span class="p">)</span>
<a name="c0-627"></a><span class="lineno"> 627</span>       <span class="n">add_family_to_write_order</span><span class="p">(</span><span class="n">wo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wo_end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-628"></a><span class="lineno"> 628</span>   <span class="p">}</span>
<a name="c0-629"></a><span class="lineno"> 629</span> 
<a name="c0-630"></a><span class="lineno"> 630</span>   <span class="k">if</span> <span class="p">(</span><span class="n">wo_end</span> <span class="o">!=</span> <span class="n">nr_objects</span><span class="p">)</span>
<a name="c0-631"></a><span class="lineno"> 631</span>     <span class="n">die</span><span class="p">(</span><span class="s">"ordered %u objects, expected %"</span><span class="n">PRIu32</span><span class="p">,</span> <span class="n">wo_end</span><span class="p">,</span> <span class="n">nr_objects</span><span class="p">);</span>
<a name="c0-632"></a><span class="lineno"> 632</span> 
<a name="c0-633"></a><span class="lineno"> 633</span>   <span class="k">return</span> <span class="n">wo</span><span class="p">;</span>
<a name="c0-634"></a><span class="lineno"> 634</span> <span class="p">}</span>
<a name="c0-635"></a><span class="lineno"> 635</span> 
<a name="c0-636"></a><span class="lineno"> 636</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">write_pack_file</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-637"></a><span class="lineno"> 637</span> <span class="p">{</span>
<a name="c0-638"></a><span class="lineno"> 638</span>   <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<a name="c0-639"></a><span class="lineno"> 639</span>   <span class="k">struct</span> <span class="n">sha1file</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
<a name="c0-640"></a><span class="lineno"> 640</span>   <span class="kt">off_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-641"></a><span class="lineno"> 641</span>   <span class="kt">uint32_t</span> <span class="n">nr_remaining</span> <span class="o">=</span> <span class="n">nr_result</span><span class="p">;</span>
<a name="c0-642"></a><span class="lineno"> 642</span>   <span class="kt">time_t</span> <span class="n">last_mtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-643"></a><span class="lineno"> 643</span>   <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">write_order</span><span class="p">;</span>
<a name="c0-644"></a><span class="lineno"> 644</span> 
<a name="c0-645"></a><span class="lineno"> 645</span>   <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&gt;</span> <span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-646"></a><span class="lineno"> 646</span>     <span class="n">progress_state</span> <span class="o">=</span> <span class="n">start_progress</span><span class="p">(</span><span class="s">"Writing objects"</span><span class="p">,</span> <span class="n">nr_result</span><span class="p">);</span>
<a name="c0-647"></a><span class="lineno"> 647</span>   <span class="n">written_list</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">nr_objects</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">written_list</span><span class="p">));</span>
<a name="c0-648"></a><span class="lineno"> 648</span>   <span class="n">write_order</span> <span class="o">=</span> <span class="n">compute_write_order</span><span class="p">();</span>
<a name="c0-649"></a><span class="lineno"> 649</span> 
<a name="c0-650"></a><span class="lineno"> 650</span>   <span class="k">do</span> <span class="p">{</span>
<a name="c0-651"></a><span class="lineno"> 651</span>     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-652"></a><span class="lineno"> 652</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">pack_tmp_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-653"></a><span class="lineno"> 653</span> 
<a name="c0-654"></a><span class="lineno"> 654</span>     <span class="k">if</span> <span class="p">(</span><span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-655"></a><span class="lineno"> 655</span>       <span class="n">f</span> <span class="o">=</span> <span class="n">sha1fd_throughput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"&lt;stdout&gt;"</span><span class="p">,</span> <span class="n">progress_state</span><span class="p">);</span>
<a name="c0-656"></a><span class="lineno"> 656</span>     <span class="k">else</span>
<a name="c0-657"></a><span class="lineno"> 657</span>       <span class="n">f</span> <span class="o">=</span> <span class="n">create_tmp_packfile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pack_tmp_name</span><span class="p">);</span>
<a name="c0-658"></a><span class="lineno"> 658</span> 
<a name="c0-659"></a><span class="lineno"> 659</span>     <span class="n">offset</span> <span class="o">=</span> <span class="n">write_pack_header</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">nr_remaining</span><span class="p">);</span>
<a name="c0-660"></a><span class="lineno"> 660</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">offset</span><span class="p">)</span>
<a name="c0-661"></a><span class="lineno"> 661</span>       <span class="n">die_errno</span><span class="p">(</span><span class="s">"unable to write pack header"</span><span class="p">);</span>
<a name="c0-662"></a><span class="lineno"> 662</span>     <span class="n">nr_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-663"></a><span class="lineno"> 663</span>     <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-664"></a><span class="lineno"> 664</span>       <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">write_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-665"></a><span class="lineno"> 665</span>       <span class="k">if</span> <span class="p">(</span><span class="n">write_one</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE_ONE_BREAK</span><span class="p">)</span>
<a name="c0-666"></a><span class="lineno"> 666</span>         <span class="k">break</span><span class="p">;</span>
<a name="c0-667"></a><span class="lineno"> 667</span>       <span class="n">display_progress</span><span class="p">(</span><span class="n">progress_state</span><span class="p">,</span> <span class="n">written</span><span class="p">);</span>
<a name="c0-668"></a><span class="lineno"> 668</span>     <span class="p">}</span>
<a name="c0-669"></a><span class="lineno"> 669</span> 
<a name="c0-670"></a><span class="lineno"> 670</span>     <span class="cm">/*</span>
<a name="c0-671"></a><span class="lineno"> 671</span> <span class="cm">    * Did we write the wrong # entries in the header?</span>
<a name="c0-672"></a><span class="lineno"> 672</span> <span class="cm">    * If so, rewrite it like in fast-import</span>
<a name="c0-673"></a><span class="lineno"> 673</span> <span class="cm">    */</span>
<a name="c0-674"></a><span class="lineno"> 674</span>     <span class="k">if</span> <span class="p">(</span><span class="n">pack_to_stdout</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-675"></a><span class="lineno"> 675</span>       <span class="n">sha1close</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">CSUM_CLOSE</span><span class="p">);</span>
<a name="c0-676"></a><span class="lineno"> 676</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr_written</span> <span class="o">==</span> <span class="n">nr_remaining</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-677"></a><span class="lineno"> 677</span>       <span class="n">sha1close</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">CSUM_FSYNC</span><span class="p">);</span>
<a name="c0-678"></a><span class="lineno"> 678</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-679"></a><span class="lineno"> 679</span>       <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">sha1close</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-680"></a><span class="lineno"> 680</span>       <span class="n">fixup_pack_header_footer</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">pack_tmp_name</span><span class="p">,</span>
<a name="c0-681"></a><span class="lineno"> 681</span>              <span class="n">nr_written</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<a name="c0-682"></a><span class="lineno"> 682</span>       <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c0-683"></a><span class="lineno"> 683</span>     <span class="p">}</span>
<a name="c0-684"></a><span class="lineno"> 684</span> 
<a name="c0-685"></a><span class="lineno"> 685</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-686"></a><span class="lineno"> 686</span>       <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-687"></a><span class="lineno"> 687</span>       <span class="kt">char</span> <span class="n">tmpname</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
<a name="c0-688"></a><span class="lineno"> 688</span> 
<a name="c0-689"></a><span class="lineno"> 689</span>       <span class="cm">/*</span>
<a name="c0-690"></a><span class="lineno"> 690</span> <span class="cm">      * Packs are runtime accessed in their mtime</span>
<a name="c0-691"></a><span class="lineno"> 691</span> <span class="cm">      * order since newer packs are more likely to contain</span>
<a name="c0-692"></a><span class="lineno"> 692</span> <span class="cm">      * younger objects.  So if we are creating multiple</span>
<a name="c0-693"></a><span class="lineno"> 693</span> <span class="cm">      * packs then we should modify the mtime of later ones</span>
<a name="c0-694"></a><span class="lineno"> 694</span> <span class="cm">      * to preserve this property.</span>
<a name="c0-695"></a><span class="lineno"> 695</span> <span class="cm">      */</span>
<a name="c0-696"></a><span class="lineno"> 696</span>       <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">pack_tmp_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-697"></a><span class="lineno"> 697</span>         <span class="n">warning</span><span class="p">(</span><span class="s">"failed to stat %s: %s"</span><span class="p">,</span>
<a name="c0-698"></a><span class="lineno"> 698</span>           <span class="n">pack_tmp_name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-699"></a><span class="lineno"> 699</span>       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_mtime</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-700"></a><span class="lineno"> 700</span>         <span class="n">last_mtime</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">;</span>
<a name="c0-701"></a><span class="lineno"> 701</span>       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-702"></a><span class="lineno"> 702</span>         <span class="k">struct</span> <span class="n">utimbuf</span> <span class="n">utb</span><span class="p">;</span>
<a name="c0-703"></a><span class="lineno"> 703</span>         <span class="n">utb</span><span class="p">.</span><span class="n">actime</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_atime</span><span class="p">;</span>
<a name="c0-704"></a><span class="lineno"> 704</span>         <span class="n">utb</span><span class="p">.</span><span class="n">modtime</span> <span class="o">=</span> <span class="o">--</span><span class="n">last_mtime</span><span class="p">;</span>
<a name="c0-705"></a><span class="lineno"> 705</span>         <span class="k">if</span> <span class="p">(</span><span class="n">utime</span><span class="p">(</span><span class="n">pack_tmp_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">utb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-706"></a><span class="lineno"> 706</span>           <span class="n">warning</span><span class="p">(</span><span class="s">"failed utime() on %s: %s"</span><span class="p">,</span>
<a name="c0-707"></a><span class="lineno"> 707</span>             <span class="n">tmpname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-708"></a><span class="lineno"> 708</span>       <span class="p">}</span>
<a name="c0-709"></a><span class="lineno"> 709</span> 
<a name="c0-710"></a><span class="lineno"> 710</span>       <span class="cm">/* Enough space for "-&lt;sha-1&gt;.pack"? */</span>
<a name="c0-711"></a><span class="lineno"> 711</span>       <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tmpname</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
<a name="c0-712"></a><span class="lineno"> 712</span>         <span class="n">die</span><span class="p">(</span><span class="s">"pack base name '%s' too long"</span><span class="p">,</span> <span class="n">base_name</span><span class="p">);</span>
<a name="c0-713"></a><span class="lineno"> 713</span>       <span class="n">snprintf</span><span class="p">(</span><span class="n">tmpname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpname</span><span class="p">),</span> <span class="s">"%s-"</span><span class="p">,</span> <span class="n">base_name</span><span class="p">);</span>
<a name="c0-714"></a><span class="lineno"> 714</span>       <span class="n">finish_tmp_packfile</span><span class="p">(</span><span class="n">tmpname</span><span class="p">,</span> <span class="n">pack_tmp_name</span><span class="p">,</span>
<a name="c0-715"></a><span class="lineno"> 715</span>               <span class="n">written_list</span><span class="p">,</span> <span class="n">nr_written</span><span class="p">,</span>
<a name="c0-716"></a><span class="lineno"> 716</span>               <span class="o">&amp;</span><span class="n">pack_idx_opts</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c0-717"></a><span class="lineno"> 717</span>       <span class="n">free</span><span class="p">(</span><span class="n">pack_tmp_name</span><span class="p">);</span>
<a name="c0-718"></a><span class="lineno"> 718</span>       <span class="n">puts</span><span class="p">(</span><span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-719"></a><span class="lineno"> 719</span>     <span class="p">}</span>
<a name="c0-720"></a><span class="lineno"> 720</span> 
<a name="c0-721"></a><span class="lineno"> 721</span>     <span class="cm">/* mark written objects as written to previous pack */</span>
<a name="c0-722"></a><span class="lineno"> 722</span>     <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nr_written</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-723"></a><span class="lineno"> 723</span>       <span class="n">written_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-724"></a><span class="lineno"> 724</span>     <span class="p">}</span>
<a name="c0-725"></a><span class="lineno"> 725</span>     <span class="n">nr_remaining</span> <span class="o">-=</span> <span class="n">nr_written</span><span class="p">;</span>
<a name="c0-726"></a><span class="lineno"> 726</span>   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nr_remaining</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">);</span>
<a name="c0-727"></a><span class="lineno"> 727</span> 
<a name="c0-728"></a><span class="lineno"> 728</span>   <span class="n">free</span><span class="p">(</span><span class="n">written_list</span><span class="p">);</span>
<a name="c0-729"></a><span class="lineno"> 729</span>   <span class="n">free</span><span class="p">(</span><span class="n">write_order</span><span class="p">);</span>
<a name="c0-730"></a><span class="lineno"> 730</span>   <span class="n">stop_progress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_state</span><span class="p">);</span>
<a name="c0-731"></a><span class="lineno"> 731</span>   <span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">!=</span> <span class="n">nr_result</span><span class="p">)</span>
<a name="c0-732"></a><span class="lineno"> 732</span>     <span class="n">die</span><span class="p">(</span><span class="s">"wrote %"</span><span class="n">PRIu32</span><span class="s">" objects while expecting %"</span><span class="n">PRIu32</span><span class="p">,</span>
<a name="c0-733"></a><span class="lineno"> 733</span>       <span class="n">written</span><span class="p">,</span> <span class="n">nr_result</span><span class="p">);</span>
<a name="c0-734"></a><span class="lineno"> 734</span> <span class="p">}</span>
<a name="c0-735"></a><span class="lineno"> 735</span> 
<a name="c0-736"></a><span class="lineno"> 736</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">locate_object_entry_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-737"></a><span class="lineno"> 737</span> <span class="p">{</span>
<a name="c0-738"></a><span class="lineno"> 738</span>   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-739"></a><span class="lineno"> 739</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ui</span><span class="p">;</span>
<a name="c0-740"></a><span class="lineno"> 740</span>   <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ui</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-741"></a><span class="lineno"> 741</span>   <span class="n">i</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">%</span> <span class="n">object_ix_hashsz</span><span class="p">;</span>
<a name="c0-742"></a><span class="lineno"> 742</span>   <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">object_ix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
<a name="c0-743"></a><span class="lineno"> 743</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hashcmp</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="n">object_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">))</span>
<a name="c0-744"></a><span class="lineno"> 744</span>       <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-745"></a><span class="lineno"> 745</span>     <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">object_ix_hashsz</span><span class="p">)</span>
<a name="c0-746"></a><span class="lineno"> 746</span>       <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-747"></a><span class="lineno"> 747</span>   <span class="p">}</span>
<a name="c0-748"></a><span class="lineno"> 748</span>   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-749"></a><span class="lineno"> 749</span> <span class="p">}</span>
<a name="c0-750"></a><span class="lineno"> 750</span> 
<a name="c0-751"></a><span class="lineno"> 751</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="nf">locate_object_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-752"></a><span class="lineno"> 752</span> <span class="p">{</span>
<a name="c0-753"></a><span class="lineno"> 753</span>   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-754"></a><span class="lineno"> 754</span> 
<a name="c0-755"></a><span class="lineno"> 755</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">object_ix_hashsz</span><span class="p">)</span>
<a name="c0-756"></a><span class="lineno"> 756</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-757"></a><span class="lineno"> 757</span> 
<a name="c0-758"></a><span class="lineno"> 758</span>   <span class="n">i</span> <span class="o">=</span> <span class="n">locate_object_entry_hash</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-759"></a><span class="lineno"> 759</span>   <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span>
<a name="c0-760"></a><span class="lineno"> 760</span>     <span class="k">return</span> <span class="o">&amp;</span><span class="n">objects</span><span class="p">[</span><span class="n">object_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<a name="c0-761"></a><span class="lineno"> 761</span>   <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-762"></a><span class="lineno"> 762</span> <span class="p">}</span>
<a name="c0-763"></a><span class="lineno"> 763</span> 
<a name="c0-764"></a><span class="lineno"> 764</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">rehash_objects</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-765"></a><span class="lineno"> 765</span> <span class="p">{</span>
<a name="c0-766"></a><span class="lineno"> 766</span>   <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-767"></a><span class="lineno"> 767</span>   <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">oe</span><span class="p">;</span>
<a name="c0-768"></a><span class="lineno"> 768</span> 
<a name="c0-769"></a><span class="lineno"> 769</span>   <span class="n">object_ix_hashsz</span> <span class="o">=</span> <span class="n">nr_objects</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
<a name="c0-770"></a><span class="lineno"> 770</span>   <span class="k">if</span> <span class="p">(</span><span class="n">object_ix_hashsz</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
<a name="c0-771"></a><span class="lineno"> 771</span>     <span class="n">object_ix_hashsz</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c0-772"></a><span class="lineno"> 772</span>   <span class="n">object_ix</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">object_ix</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">object_ix_hashsz</span><span class="p">);</span>
<a name="c0-773"></a><span class="lineno"> 773</span>   <span class="n">memset</span><span class="p">(</span><span class="n">object_ix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">object_ix_hashsz</span><span class="p">);</span>
<a name="c0-774"></a><span class="lineno"> 774</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oe</span> <span class="o">=</span> <span class="n">objects</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">oe</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-775"></a><span class="lineno"> 775</span>     <span class="kt">int</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">locate_object_entry_hash</span><span class="p">(</span><span class="n">oe</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-776"></a><span class="lineno"> 776</span>     <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ix</span><span class="p">)</span>
<a name="c0-777"></a><span class="lineno"> 777</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c0-778"></a><span class="lineno"> 778</span>     <span class="n">ix</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ix</span><span class="p">;</span>
<a name="c0-779"></a><span class="lineno"> 779</span>     <span class="n">object_ix</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-780"></a><span class="lineno"> 780</span>   <span class="p">}</span>
<a name="c0-781"></a><span class="lineno"> 781</span> <span class="p">}</span>
<a name="c0-782"></a><span class="lineno"> 782</span> 
<a name="c0-783"></a><span class="lineno"> 783</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">name_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-784"></a><span class="lineno"> 784</span> <span class="p">{</span>
<a name="c0-785"></a><span class="lineno"> 785</span>   <span class="kt">unsigned</span> <span class="n">c</span><span class="p">,</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-786"></a><span class="lineno"> 786</span> 
<a name="c0-787"></a><span class="lineno"> 787</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
<a name="c0-788"></a><span class="lineno"> 788</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-789"></a><span class="lineno"> 789</span> 
<a name="c0-790"></a><span class="lineno"> 790</span>   <span class="cm">/*</span>
<a name="c0-791"></a><span class="lineno"> 791</span> <span class="cm">  * This effectively just creates a sortable number from the</span>
<a name="c0-792"></a><span class="lineno"> 792</span> <span class="cm">  * last sixteen non-whitespace characters. Last characters</span>
<a name="c0-793"></a><span class="lineno"> 793</span> <span class="cm">  * count "most", so things that end in ".c" sort together.</span>
<a name="c0-794"></a><span class="lineno"> 794</span> <span class="cm">  */</span>
<a name="c0-795"></a><span class="lineno"> 795</span>   <span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-796"></a><span class="lineno"> 796</span>     <span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<a name="c0-797"></a><span class="lineno"> 797</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c0-798"></a><span class="lineno"> 798</span>     <span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
<a name="c0-799"></a><span class="lineno"> 799</span>   <span class="p">}</span>
<a name="c0-800"></a><span class="lineno"> 800</span>   <span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<a name="c0-801"></a><span class="lineno"> 801</span> <span class="p">}</span>
<a name="c0-802"></a><span class="lineno"> 802</span> 
<a name="c0-803"></a><span class="lineno"> 803</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_delta_attr_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<a name="c0-804"></a><span class="lineno"> 804</span> <span class="p">{</span>
<a name="c0-805"></a><span class="lineno"> 805</span>   <span class="k">static</span> <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">attr_delta</span><span class="p">;</span>
<a name="c0-806"></a><span class="lineno"> 806</span> 
<a name="c0-807"></a><span class="lineno"> 807</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr_delta</span><span class="p">)</span>
<a name="c0-808"></a><span class="lineno"> 808</span>     <span class="n">attr_delta</span> <span class="o">=</span> <span class="n">git_attr</span><span class="p">(</span><span class="s">"delta"</span><span class="p">);</span>
<a name="c0-809"></a><span class="lineno"> 809</span> 
<a name="c0-810"></a><span class="lineno"> 810</span>   <span class="n">check</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr_delta</span><span class="p">;</span>
<a name="c0-811"></a><span class="lineno"> 811</span> <span class="p">}</span>
<a name="c0-812"></a><span class="lineno"> 812</span> 
<a name="c0-813"></a><span class="lineno"> 813</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">no_try_delta</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<a name="c0-814"></a><span class="lineno"> 814</span> <span class="p">{</span>
<a name="c0-815"></a><span class="lineno"> 815</span>   <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="n">check</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="c0-816"></a><span class="lineno"> 816</span> 
<a name="c0-817"></a><span class="lineno"> 817</span>   <span class="n">setup_delta_attr_check</span><span class="p">(</span><span class="n">check</span><span class="p">);</span>
<a name="c0-818"></a><span class="lineno"> 818</span>   <span class="k">if</span> <span class="p">(</span><span class="n">git_check_attr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">check</span><span class="p">),</span> <span class="n">check</span><span class="p">))</span>
<a name="c0-819"></a><span class="lineno"> 819</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-820"></a><span class="lineno"> 820</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_FALSE</span><span class="p">(</span><span class="n">check</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span>
<a name="c0-821"></a><span class="lineno"> 821</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-822"></a><span class="lineno"> 822</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-823"></a><span class="lineno"> 823</span> <span class="p">}</span>
<a name="c0-824"></a><span class="lineno"> 824</span> 
<a name="c0-825"></a><span class="lineno"> 825</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">add_object_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">,</span> <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">,</span>
<a name="c0-826"></a><span class="lineno"> 826</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exclude</span><span class="p">)</span>
<a name="c0-827"></a><span class="lineno"> 827</span> <span class="p">{</span>
<a name="c0-828"></a><span class="lineno"> 828</span>   <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<a name="c0-829"></a><span class="lineno"> 829</span>   <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">found_pack</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-830"></a><span class="lineno"> 830</span>   <span class="kt">off_t</span> <span class="n">found_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-831"></a><span class="lineno"> 831</span>   <span class="kt">int</span> <span class="n">ix</span><span class="p">;</span>
<a name="c0-832"></a><span class="lineno"> 832</span>   <span class="kt">unsigned</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">name_hash</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-833"></a><span class="lineno"> 833</span> 
<a name="c0-834"></a><span class="lineno"> 834</span>   <span class="n">ix</span> <span class="o">=</span> <span class="n">nr_objects</span> <span class="o">?</span> <span class="n">locate_object_entry_hash</span><span class="p">(</span><span class="n">sha1</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-835"></a><span class="lineno"> 835</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ix</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-836"></a><span class="lineno"> 836</span>     <span class="k">if</span> <span class="p">(</span><span class="n">exclude</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-837"></a><span class="lineno"> 837</span>       <span class="n">entry</span> <span class="o">=</span> <span class="n">objects</span> <span class="o">+</span> <span class="n">object_ix</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-838"></a><span class="lineno"> 838</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span>
<a name="c0-839"></a><span class="lineno"> 839</span>         <span class="n">nr_result</span><span class="o">--</span><span class="p">;</span>
<a name="c0-840"></a><span class="lineno"> 840</span>       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-841"></a><span class="lineno"> 841</span>     <span class="p">}</span>
<a name="c0-842"></a><span class="lineno"> 842</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-843"></a><span class="lineno"> 843</span>   <span class="p">}</span>
<a name="c0-844"></a><span class="lineno"> 844</span> 
<a name="c0-845"></a><span class="lineno"> 845</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exclude</span> <span class="o">&amp;&amp;</span> <span class="n">local</span> <span class="o">&amp;&amp;</span> <span class="n">has_loose_object_nonlocal</span><span class="p">(</span><span class="n">sha1</span><span class="p">))</span>
<a name="c0-846"></a><span class="lineno"> 846</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-847"></a><span class="lineno"> 847</span> 
<a name="c0-848"></a><span class="lineno"> 848</span>   <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">packed_git</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-849"></a><span class="lineno"> 849</span>     <span class="kt">off_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">find_pack_entry_one</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<a name="c0-850"></a><span class="lineno"> 850</span>     <span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-851"></a><span class="lineno"> 851</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_pack</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-852"></a><span class="lineno"> 852</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pack_valid</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-853"></a><span class="lineno"> 853</span>           <span class="n">warning</span><span class="p">(</span><span class="s">"packfile %s cannot be accessed"</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_name</span><span class="p">);</span>
<a name="c0-854"></a><span class="lineno"> 854</span>           <span class="k">continue</span><span class="p">;</span>
<a name="c0-855"></a><span class="lineno"> 855</span>         <span class="p">}</span>
<a name="c0-856"></a><span class="lineno"> 856</span>         <span class="n">found_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-857"></a><span class="lineno"> 857</span>         <span class="n">found_pack</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<a name="c0-858"></a><span class="lineno"> 858</span>       <span class="p">}</span>
<a name="c0-859"></a><span class="lineno"> 859</span>       <span class="k">if</span> <span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
<a name="c0-860"></a><span class="lineno"> 860</span>         <span class="k">break</span><span class="p">;</span>
<a name="c0-861"></a><span class="lineno"> 861</span>       <span class="k">if</span> <span class="p">(</span><span class="n">incremental</span><span class="p">)</span>
<a name="c0-862"></a><span class="lineno"> 862</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-863"></a><span class="lineno"> 863</span>       <span class="k">if</span> <span class="p">(</span><span class="n">local</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_local</span><span class="p">)</span>
<a name="c0-864"></a><span class="lineno"> 864</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-865"></a><span class="lineno"> 865</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_packed_keep</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_local</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_keep</span><span class="p">)</span>
<a name="c0-866"></a><span class="lineno"> 866</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-867"></a><span class="lineno"> 867</span>     <span class="p">}</span>
<a name="c0-868"></a><span class="lineno"> 868</span>   <span class="p">}</span>
<a name="c0-869"></a><span class="lineno"> 869</span> 
<a name="c0-870"></a><span class="lineno"> 870</span>   <span class="k">if</span> <span class="p">(</span><span class="n">nr_objects</span> <span class="o">&gt;=</span> <span class="n">nr_alloc</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-871"></a><span class="lineno"> 871</span>     <span class="n">nr_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr_alloc</span>  <span class="o">+</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-872"></a><span class="lineno"> 872</span>     <span class="n">objects</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">nr_alloc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">));</span>
<a name="c0-873"></a><span class="lineno"> 873</span>   <span class="p">}</span>
<a name="c0-874"></a><span class="lineno"> 874</span> 
<a name="c0-875"></a><span class="lineno"> 875</span>   <span class="n">entry</span> <span class="o">=</span> <span class="n">objects</span> <span class="o">+</span> <span class="n">nr_objects</span><span class="o">++</span><span class="p">;</span>
<a name="c0-876"></a><span class="lineno"> 876</span>   <span class="n">memset</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">));</span>
<a name="c0-877"></a><span class="lineno"> 877</span>   <span class="n">hashcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c0-878"></a><span class="lineno"> 878</span>   <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
<a name="c0-879"></a><span class="lineno"> 879</span>   <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
<a name="c0-880"></a><span class="lineno"> 880</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-881"></a><span class="lineno"> 881</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
<a name="c0-882"></a><span class="lineno"> 882</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-883"></a><span class="lineno"> 883</span>   <span class="k">else</span>
<a name="c0-884"></a><span class="lineno"> 884</span>     <span class="n">nr_result</span><span class="o">++</span><span class="p">;</span>
<a name="c0-885"></a><span class="lineno"> 885</span>   <span class="k">if</span> <span class="p">(</span><span class="n">found_pack</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-886"></a><span class="lineno"> 886</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">=</span> <span class="n">found_pack</span><span class="p">;</span>
<a name="c0-887"></a><span class="lineno"> 887</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">=</span> <span class="n">found_offset</span><span class="p">;</span>
<a name="c0-888"></a><span class="lineno"> 888</span>   <span class="p">}</span>
<a name="c0-889"></a><span class="lineno"> 889</span> 
<a name="c0-890"></a><span class="lineno"> 890</span>   <span class="k">if</span> <span class="p">(</span><span class="n">object_ix_hashsz</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">nr_objects</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
<a name="c0-891"></a><span class="lineno"> 891</span>     <span class="n">rehash_objects</span><span class="p">();</span>
<a name="c0-892"></a><span class="lineno"> 892</span>   <span class="k">else</span>
<a name="c0-893"></a><span class="lineno"> 893</span>     <span class="n">object_ix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr_objects</span><span class="p">;</span>
<a name="c0-894"></a><span class="lineno"> 894</span> 
<a name="c0-895"></a><span class="lineno"> 895</span>   <span class="n">display_progress</span><span class="p">(</span><span class="n">progress_state</span><span class="p">,</span> <span class="n">nr_objects</span><span class="p">);</span>
<a name="c0-896"></a><span class="lineno"> 896</span> 
<a name="c0-897"></a><span class="lineno"> 897</span>   <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">no_try_delta</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<a name="c0-898"></a><span class="lineno"> 898</span>     <span class="n">entry</span><span class="o">-&gt;</span><span class="n">no_try_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-899"></a><span class="lineno"> 899</span> 
<a name="c0-900"></a><span class="lineno"> 900</span>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-901"></a><span class="lineno"> 901</span> <span class="p">}</span>
<a name="c0-902"></a><span class="lineno"> 902</span> 
<a name="c0-903"></a><span class="lineno"> 903</span> <span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="p">{</span>
<a name="c0-904"></a><span class="lineno"> 904</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-905"></a><span class="lineno"> 905</span>   <span class="kt">int</span> <span class="n">ref</span><span class="p">;</span>
<a name="c0-906"></a><span class="lineno"> 906</span>   <span class="kt">int</span> <span class="n">temporary</span><span class="p">;</span>
<a name="c0-907"></a><span class="lineno"> 907</span>   <span class="kt">void</span> <span class="o">*</span><span class="n">tree_data</span><span class="p">;</span>
<a name="c0-908"></a><span class="lineno"> 908</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tree_size</span><span class="p">;</span>
<a name="c0-909"></a><span class="lineno"> 909</span> <span class="p">};</span>
<a name="c0-910"></a><span class="lineno"> 910</span> 
<a name="c0-911"></a><span class="lineno"> 911</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="o">*</span><span class="p">(</span><span class="n">pbase_tree_cache</span><span class="p">[</span><span class="mi">256</span><span class="p">]);</span>
<a name="c0-912"></a><span class="lineno"> 912</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">pbase_tree_cache_ix</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-913"></a><span class="lineno"> 913</span> <span class="p">{</span>
<a name="c0-914"></a><span class="lineno"> 914</span>   <span class="k">return</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pbase_tree_cache</span><span class="p">);</span>
<a name="c0-915"></a><span class="lineno"> 915</span> <span class="p">}</span>
<a name="c0-916"></a><span class="lineno"> 916</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">pbase_tree_cache_ix_incr</span><span class="p">(</span><span class="kt">int</span> <span class="n">ix</span><span class="p">)</span>
<a name="c0-917"></a><span class="lineno"> 917</span> <span class="p">{</span>
<a name="c0-918"></a><span class="lineno"> 918</span>   <span class="k">return</span> <span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pbase_tree_cache</span><span class="p">);</span>
<a name="c0-919"></a><span class="lineno"> 919</span> <span class="p">}</span>
<a name="c0-920"></a><span class="lineno"> 920</span> 
<a name="c0-921"></a><span class="lineno"> 921</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">pbase_tree</span> <span class="p">{</span>
<a name="c0-922"></a><span class="lineno"> 922</span>   <span class="k">struct</span> <span class="n">pbase_tree</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-923"></a><span class="lineno"> 923</span>   <span class="cm">/* This is a phony "cache" entry; we are not</span>
<a name="c0-924"></a><span class="lineno"> 924</span> <span class="cm">  * going to evict it nor find it through _get()</span>
<a name="c0-925"></a><span class="lineno"> 925</span> <span class="cm">  * mechanism -- this is for the toplevel node that</span>
<a name="c0-926"></a><span class="lineno"> 926</span> <span class="cm">  * would almost always change with any commit.</span>
<a name="c0-927"></a><span class="lineno"> 927</span> <span class="cm">  */</span>
<a name="c0-928"></a><span class="lineno"> 928</span>   <span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="n">pcache</span><span class="p">;</span>
<a name="c0-929"></a><span class="lineno"> 929</span> <span class="p">}</span> <span class="o">*</span><span class="n">pbase_tree</span><span class="p">;</span>
<a name="c0-930"></a><span class="lineno"> 930</span> 
<a name="c0-931"></a><span class="lineno"> 931</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="o">*</span><span class="nf">pbase_tree_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-932"></a><span class="lineno"> 932</span> <span class="p">{</span>
<a name="c0-933"></a><span class="lineno"> 933</span>   <span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="o">*</span><span class="n">nent</span><span class="p">;</span>
<a name="c0-934"></a><span class="lineno"> 934</span>   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-935"></a><span class="lineno"> 935</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-936"></a><span class="lineno"> 936</span>   <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-937"></a><span class="lineno"> 937</span>   <span class="kt">int</span> <span class="n">neigh</span><span class="p">;</span>
<a name="c0-938"></a><span class="lineno"> 938</span>   <span class="kt">int</span> <span class="n">my_ix</span> <span class="o">=</span> <span class="n">pbase_tree_cache_ix</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-939"></a><span class="lineno"> 939</span>   <span class="kt">int</span> <span class="n">available_ix</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-940"></a><span class="lineno"> 940</span> 
<a name="c0-941"></a><span class="lineno"> 941</span>   <span class="cm">/* pbase-tree-cache acts as a limited hashtable.</span>
<a name="c0-942"></a><span class="lineno"> 942</span> <span class="cm">  * your object will be found at your index or within a few</span>
<a name="c0-943"></a><span class="lineno"> 943</span> <span class="cm">  * slots after that slot if it is cached.</span>
<a name="c0-944"></a><span class="lineno"> 944</span> <span class="cm">  */</span>
<a name="c0-945"></a><span class="lineno"> 945</span>   <span class="k">for</span> <span class="p">(</span><span class="n">neigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">neigh</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">neigh</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-946"></a><span class="lineno"> 946</span>     <span class="n">ent</span> <span class="o">=</span> <span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">my_ix</span><span class="p">];</span>
<a name="c0-947"></a><span class="lineno"> 947</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hashcmp</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-948"></a><span class="lineno"> 948</span>       <span class="n">ent</span><span class="o">-&gt;</span><span class="n">ref</span><span class="o">++</span><span class="p">;</span>
<a name="c0-949"></a><span class="lineno"> 949</span>       <span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
<a name="c0-950"></a><span class="lineno"> 950</span>     <span class="p">}</span>
<a name="c0-951"></a><span class="lineno"> 951</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">available_ix</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span> <span class="o">||</span> <span class="o">!</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">))</span> <span class="o">||</span>
<a name="c0-952"></a><span class="lineno"> 952</span>        <span class="p">((</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">available_ix</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-953"></a><span class="lineno"> 953</span>         <span class="p">(</span><span class="o">!</span><span class="n">ent</span> <span class="o">&amp;&amp;</span> <span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">available_ix</span><span class="p">])))</span>
<a name="c0-954"></a><span class="lineno"> 954</span>       <span class="n">available_ix</span> <span class="o">=</span> <span class="n">my_ix</span><span class="p">;</span>
<a name="c0-955"></a><span class="lineno"> 955</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span>
<a name="c0-956"></a><span class="lineno"> 956</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-957"></a><span class="lineno"> 957</span>     <span class="n">my_ix</span> <span class="o">=</span> <span class="n">pbase_tree_cache_ix_incr</span><span class="p">(</span><span class="n">my_ix</span><span class="p">);</span>
<a name="c0-958"></a><span class="lineno"> 958</span>   <span class="p">}</span>
<a name="c0-959"></a><span class="lineno"> 959</span> 
<a name="c0-960"></a><span class="lineno"> 960</span>   <span class="cm">/* Did not find one.  Either we got a bogus request or</span>
<a name="c0-961"></a><span class="lineno"> 961</span> <span class="cm">  * we need to read and perhaps cache.</span>
<a name="c0-962"></a><span class="lineno"> 962</span> <span class="cm">  */</span>
<a name="c0-963"></a><span class="lineno"> 963</span>   <span class="n">data</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-964"></a><span class="lineno"> 964</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
<a name="c0-965"></a><span class="lineno"> 965</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-966"></a><span class="lineno"> 966</span>   <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_TREE</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-967"></a><span class="lineno"> 967</span>     <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c0-968"></a><span class="lineno"> 968</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-969"></a><span class="lineno"> 969</span>   <span class="p">}</span>
<a name="c0-970"></a><span class="lineno"> 970</span> 
<a name="c0-971"></a><span class="lineno"> 971</span>   <span class="cm">/* We need to either cache or return a throwaway copy */</span>
<a name="c0-972"></a><span class="lineno"> 972</span> 
<a name="c0-973"></a><span class="lineno"> 973</span>   <span class="k">if</span> <span class="p">(</span><span class="n">available_ix</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-974"></a><span class="lineno"> 974</span>     <span class="n">ent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-975"></a><span class="lineno"> 975</span>   <span class="k">else</span> <span class="p">{</span>
<a name="c0-976"></a><span class="lineno"> 976</span>     <span class="n">ent</span> <span class="o">=</span> <span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">available_ix</span><span class="p">];</span>
<a name="c0-977"></a><span class="lineno"> 977</span>     <span class="n">my_ix</span> <span class="o">=</span> <span class="n">available_ix</span><span class="p">;</span>
<a name="c0-978"></a><span class="lineno"> 978</span>   <span class="p">}</span>
<a name="c0-979"></a><span class="lineno"> 979</span> 
<a name="c0-980"></a><span class="lineno"> 980</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-981"></a><span class="lineno"> 981</span>     <span class="n">nent</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nent</span><span class="p">));</span>
<a name="c0-982"></a><span class="lineno"> 982</span>     <span class="n">nent</span><span class="o">-&gt;</span><span class="n">temporary</span> <span class="o">=</span> <span class="p">(</span><span class="n">available_ix</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-983"></a><span class="lineno"> 983</span>   <span class="p">}</span>
<a name="c0-984"></a><span class="lineno"> 984</span>   <span class="k">else</span> <span class="p">{</span>
<a name="c0-985"></a><span class="lineno"> 985</span>     <span class="cm">/* evict and reuse */</span>
<a name="c0-986"></a><span class="lineno"> 986</span>     <span class="n">free</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">tree_data</span><span class="p">);</span>
<a name="c0-987"></a><span class="lineno"> 987</span>     <span class="n">nent</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
<a name="c0-988"></a><span class="lineno"> 988</span>   <span class="p">}</span>
<a name="c0-989"></a><span class="lineno"> 989</span>   <span class="n">hashcpy</span><span class="p">(</span><span class="n">nent</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c0-990"></a><span class="lineno"> 990</span>   <span class="n">nent</span><span class="o">-&gt;</span><span class="n">tree_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<a name="c0-991"></a><span class="lineno"> 991</span>   <span class="n">nent</span><span class="o">-&gt;</span><span class="n">tree_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-992"></a><span class="lineno"> 992</span>   <span class="n">nent</span><span class="o">-&gt;</span><span class="n">ref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-993"></a><span class="lineno"> 993</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nent</span><span class="o">-&gt;</span><span class="n">temporary</span><span class="p">)</span>
<a name="c0-994"></a><span class="lineno"> 994</span>     <span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">my_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">nent</span><span class="p">;</span>
<a name="c0-995"></a><span class="lineno"> 995</span>   <span class="k">return</span> <span class="n">nent</span><span class="p">;</span>
<a name="c0-996"></a><span class="lineno"> 996</span> <span class="p">}</span>
<a name="c0-997"></a><span class="lineno"> 997</span> 
<a name="c0-998"></a><span class="lineno"> 998</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">pbase_tree_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="o">*</span><span class="n">cache</span><span class="p">)</span>
<a name="c0-999"></a><span class="lineno"> 999</span> <span class="p">{</span>
<a name="c0-1000"></a><span class="lineno">1000</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">temporary</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1001"></a><span class="lineno">1001</span>    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">ref</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1002"></a><span class="lineno">1002</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1003"></a><span class="lineno">1003</span>  <span class="p">}</span>
<a name="c0-1004"></a><span class="lineno">1004</span>  <span class="n">free</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">tree_data</span><span class="p">);</span>
<a name="c0-1005"></a><span class="lineno">1005</span>  <span class="n">free</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
<a name="c0-1006"></a><span class="lineno">1006</span> <span class="p">}</span>
<a name="c0-1007"></a><span class="lineno">1007</span> 
<a name="c0-1008"></a><span class="lineno">1008</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">name_cmp_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-1009"></a><span class="lineno">1009</span> <span class="p">{</span>
<a name="c0-1010"></a><span class="lineno">1010</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1011"></a><span class="lineno">1011</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1012"></a><span class="lineno">1012</span>    <span class="p">;</span>
<a name="c0-1013"></a><span class="lineno">1013</span>  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1014"></a><span class="lineno">1014</span> <span class="p">}</span>
<a name="c0-1015"></a><span class="lineno">1015</span> 
<a name="c0-1016"></a><span class="lineno">1016</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_pbase_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">tree_desc</span> <span class="o">*</span><span class="n">tree</span><span class="p">,</span>
<a name="c0-1017"></a><span class="lineno">1017</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
<a name="c0-1018"></a><span class="lineno">1018</span>           <span class="kt">int</span> <span class="n">cmplen</span><span class="p">,</span>
<a name="c0-1019"></a><span class="lineno">1019</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fullname</span><span class="p">)</span>
<a name="c0-1020"></a><span class="lineno">1020</span> <span class="p">{</span>
<a name="c0-1021"></a><span class="lineno">1021</span>  <span class="k">struct</span> <span class="n">name_entry</span> <span class="n">entry</span><span class="p">;</span>
<a name="c0-1022"></a><span class="lineno">1022</span>  <span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>
<a name="c0-1023"></a><span class="lineno">1023</span> 
<a name="c0-1024"></a><span class="lineno">1024</span>  <span class="k">while</span> <span class="p">(</span><span class="n">tree_entry</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1025"></a><span class="lineno">1025</span>    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISGITLINK</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span>
<a name="c0-1026"></a><span class="lineno">1026</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1027"></a><span class="lineno">1027</span>    <span class="n">cmp</span> <span class="o">=</span> <span class="n">tree_entry_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cmplen</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
<a name="c0-1028"></a><span class="lineno">1028</span>          <span class="n">memcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">cmplen</span><span class="p">);</span>
<a name="c0-1029"></a><span class="lineno">1029</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1030"></a><span class="lineno">1030</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1031"></a><span class="lineno">1031</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1032"></a><span class="lineno">1032</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1033"></a><span class="lineno">1033</span>    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">cmplen</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1034"></a><span class="lineno">1034</span>      <span class="n">add_object_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span>
<a name="c0-1035"></a><span class="lineno">1035</span>           <span class="n">object_type</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mode</span><span class="p">),</span>
<a name="c0-1036"></a><span class="lineno">1036</span>           <span class="n">fullname</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-1037"></a><span class="lineno">1037</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1038"></a><span class="lineno">1038</span>    <span class="p">}</span>
<a name="c0-1039"></a><span class="lineno">1039</span>    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1040"></a><span class="lineno">1040</span>      <span class="k">struct</span> <span class="n">tree_desc</span> <span class="n">sub</span><span class="p">;</span>
<a name="c0-1041"></a><span class="lineno">1041</span>      <span class="k">struct</span> <span class="n">pbase_tree_cache</span> <span class="o">*</span><span class="n">tree</span><span class="p">;</span>
<a name="c0-1042"></a><span class="lineno">1042</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">down</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="n">cmplen</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1043"></a><span class="lineno">1043</span>      <span class="kt">int</span> <span class="n">downlen</span> <span class="o">=</span> <span class="n">name_cmp_len</span><span class="p">(</span><span class="n">down</span><span class="p">);</span>
<a name="c0-1044"></a><span class="lineno">1044</span> 
<a name="c0-1045"></a><span class="lineno">1045</span>      <span class="n">tree</span> <span class="o">=</span> <span class="n">pbase_tree_get</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-1046"></a><span class="lineno">1046</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tree</span><span class="p">)</span>
<a name="c0-1047"></a><span class="lineno">1047</span>        <span class="k">return</span><span class="p">;</span>
<a name="c0-1048"></a><span class="lineno">1048</span>      <span class="n">init_tree_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sub</span><span class="p">,</span> <span class="n">tree</span><span class="o">-&gt;</span><span class="n">tree_data</span><span class="p">,</span> <span class="n">tree</span><span class="o">-&gt;</span><span class="n">tree_size</span><span class="p">);</span>
<a name="c0-1049"></a><span class="lineno">1049</span> 
<a name="c0-1050"></a><span class="lineno">1050</span>      <span class="n">add_pbase_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sub</span><span class="p">,</span> <span class="n">down</span><span class="p">,</span> <span class="n">downlen</span><span class="p">,</span> <span class="n">fullname</span><span class="p">);</span>
<a name="c0-1051"></a><span class="lineno">1051</span>      <span class="n">pbase_tree_put</span><span class="p">(</span><span class="n">tree</span><span class="p">);</span>
<a name="c0-1052"></a><span class="lineno">1052</span>    <span class="p">}</span>
<a name="c0-1053"></a><span class="lineno">1053</span>  <span class="p">}</span>
<a name="c0-1054"></a><span class="lineno">1054</span> <span class="p">}</span>
<a name="c0-1055"></a><span class="lineno">1055</span> 
<a name="c0-1056"></a><span class="lineno">1056</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">done_pbase_paths</span><span class="p">;</span>
<a name="c0-1057"></a><span class="lineno">1057</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">done_pbase_paths_num</span><span class="p">;</span>
<a name="c0-1058"></a><span class="lineno">1058</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">done_pbase_paths_alloc</span><span class="p">;</span>
<a name="c0-1059"></a><span class="lineno">1059</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">done_pbase_path_pos</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">hash</span><span class="p">)</span>
<a name="c0-1060"></a><span class="lineno">1060</span> <span class="p">{</span>
<a name="c0-1061"></a><span class="lineno">1061</span>  <span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1062"></a><span class="lineno">1062</span>  <span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">done_pbase_paths_num</span><span class="p">;</span>
<a name="c0-1063"></a><span class="lineno">1063</span>  <span class="k">while</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1064"></a><span class="lineno">1064</span>    <span class="kt">int</span> <span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">+</span> <span class="n">lo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1065"></a><span class="lineno">1065</span>    <span class="k">if</span> <span class="p">(</span><span class="n">done_pbase_paths</span><span class="p">[</span><span class="n">mi</span><span class="p">]</span> <span class="o">==</span> <span class="n">hash</span><span class="p">)</span>
<a name="c0-1066"></a><span class="lineno">1066</span>      <span class="k">return</span> <span class="n">mi</span><span class="p">;</span>
<a name="c0-1067"></a><span class="lineno">1067</span>    <span class="k">if</span> <span class="p">(</span><span class="n">done_pbase_paths</span><span class="p">[</span><span class="n">mi</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">hash</span><span class="p">)</span>
<a name="c0-1068"></a><span class="lineno">1068</span>      <span class="n">hi</span> <span class="o">=</span> <span class="n">mi</span><span class="p">;</span>
<a name="c0-1069"></a><span class="lineno">1069</span>    <span class="k">else</span>
<a name="c0-1070"></a><span class="lineno">1070</span>      <span class="n">lo</span> <span class="o">=</span> <span class="n">mi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1071"></a><span class="lineno">1071</span>  <span class="p">}</span>
<a name="c0-1072"></a><span class="lineno">1072</span>  <span class="k">return</span> <span class="o">-</span><span class="n">lo</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1073"></a><span class="lineno">1073</span> <span class="p">}</span>
<a name="c0-1074"></a><span class="lineno">1074</span> 
<a name="c0-1075"></a><span class="lineno">1075</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">check_pbase_path</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">hash</span><span class="p">)</span>
<a name="c0-1076"></a><span class="lineno">1076</span> <span class="p">{</span>
<a name="c0-1077"></a><span class="lineno">1077</span>  <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">done_pbase_paths</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">done_pbase_path_pos</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<a name="c0-1078"></a><span class="lineno">1078</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">)</span>
<a name="c0-1079"></a><span class="lineno">1079</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1080"></a><span class="lineno">1080</span>  <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1081"></a><span class="lineno">1081</span>  <span class="k">if</span> <span class="p">(</span><span class="n">done_pbase_paths_alloc</span> <span class="o">&lt;=</span> <span class="n">done_pbase_paths_num</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1082"></a><span class="lineno">1082</span>    <span class="n">done_pbase_paths_alloc</span> <span class="o">=</span> <span class="n">alloc_nr</span><span class="p">(</span><span class="n">done_pbase_paths_alloc</span><span class="p">);</span>
<a name="c0-1083"></a><span class="lineno">1083</span>    <span class="n">done_pbase_paths</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">done_pbase_paths</span><span class="p">,</span>
<a name="c0-1084"></a><span class="lineno">1084</span>              <span class="n">done_pbase_paths_alloc</span> <span class="o">*</span>
<a name="c0-1085"></a><span class="lineno">1085</span>              <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">));</span>
<a name="c0-1086"></a><span class="lineno">1086</span>  <span class="p">}</span>
<a name="c0-1087"></a><span class="lineno">1087</span>  <span class="n">done_pbase_paths_num</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1088"></a><span class="lineno">1088</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">done_pbase_paths_num</span><span class="p">)</span>
<a name="c0-1089"></a><span class="lineno">1089</span>    <span class="n">memmove</span><span class="p">(</span><span class="n">done_pbase_paths</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a name="c0-1090"></a><span class="lineno">1090</span>      <span class="n">done_pbase_paths</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
<a name="c0-1091"></a><span class="lineno">1091</span>      <span class="p">(</span><span class="n">done_pbase_paths_num</span> <span class="o">-</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">));</span>
<a name="c0-1092"></a><span class="lineno">1092</span>  <span class="n">done_pbase_paths</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
<a name="c0-1093"></a><span class="lineno">1093</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1094"></a><span class="lineno">1094</span> <span class="p">}</span>
<a name="c0-1095"></a><span class="lineno">1095</span> 
<a name="c0-1096"></a><span class="lineno">1096</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_preferred_base_object</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-1097"></a><span class="lineno">1097</span> <span class="p">{</span>
<a name="c0-1098"></a><span class="lineno">1098</span>  <span class="k">struct</span> <span class="n">pbase_tree</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
<a name="c0-1099"></a><span class="lineno">1099</span>  <span class="kt">int</span> <span class="n">cmplen</span><span class="p">;</span>
<a name="c0-1100"></a><span class="lineno">1100</span>  <span class="kt">unsigned</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">name_hash</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-1101"></a><span class="lineno">1101</span> 
<a name="c0-1102"></a><span class="lineno">1102</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_preferred_base</span> <span class="o">||</span> <span class="n">check_pbase_path</span><span class="p">(</span><span class="n">hash</span><span class="p">))</span>
<a name="c0-1103"></a><span class="lineno">1103</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1104"></a><span class="lineno">1104</span> 
<a name="c0-1105"></a><span class="lineno">1105</span>  <span class="n">cmplen</span> <span class="o">=</span> <span class="n">name_cmp_len</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-1106"></a><span class="lineno">1106</span>  <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">pbase_tree</span><span class="p">;</span> <span class="n">it</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1107"></a><span class="lineno">1107</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cmplen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1108"></a><span class="lineno">1108</span>      <span class="n">add_object_entry</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">OBJ_TREE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-1109"></a><span class="lineno">1109</span>    <span class="p">}</span>
<a name="c0-1110"></a><span class="lineno">1110</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c0-1111"></a><span class="lineno">1111</span>      <span class="k">struct</span> <span class="n">tree_desc</span> <span class="n">tree</span><span class="p">;</span>
<a name="c0-1112"></a><span class="lineno">1112</span>      <span class="n">init_tree_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">tree_data</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">tree_size</span><span class="p">);</span>
<a name="c0-1113"></a><span class="lineno">1113</span>      <span class="n">add_pbase_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tree</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cmplen</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-1114"></a><span class="lineno">1114</span>    <span class="p">}</span>
<a name="c0-1115"></a><span class="lineno">1115</span>  <span class="p">}</span>
<a name="c0-1116"></a><span class="lineno">1116</span> <span class="p">}</span>
<a name="c0-1117"></a><span class="lineno">1117</span> 
<a name="c0-1118"></a><span class="lineno">1118</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_preferred_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-1119"></a><span class="lineno">1119</span> <span class="p">{</span>
<a name="c0-1120"></a><span class="lineno">1120</span>  <span class="k">struct</span> <span class="n">pbase_tree</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
<a name="c0-1121"></a><span class="lineno">1121</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-1122"></a><span class="lineno">1122</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-1123"></a><span class="lineno">1123</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tree_sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-1124"></a><span class="lineno">1124</span> 
<a name="c0-1125"></a><span class="lineno">1125</span>  <span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">&lt;=</span> <span class="n">num_preferred_base</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1126"></a><span class="lineno">1126</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1127"></a><span class="lineno">1127</span> 
<a name="c0-1128"></a><span class="lineno">1128</span>  <span class="n">data</span> <span class="o">=</span> <span class="n">read_object_with_reference</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">tree_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="n">tree_sha1</span><span class="p">);</span>
<a name="c0-1129"></a><span class="lineno">1129</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
<a name="c0-1130"></a><span class="lineno">1130</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1131"></a><span class="lineno">1131</span> 
<a name="c0-1132"></a><span class="lineno">1132</span>  <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">pbase_tree</span><span class="p">;</span> <span class="n">it</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1133"></a><span class="lineno">1133</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hashcmp</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">tree_sha1</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1134"></a><span class="lineno">1134</span>      <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c0-1135"></a><span class="lineno">1135</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1136"></a><span class="lineno">1136</span>    <span class="p">}</span>
<a name="c0-1137"></a><span class="lineno">1137</span>  <span class="p">}</span>
<a name="c0-1138"></a><span class="lineno">1138</span> 
<a name="c0-1139"></a><span class="lineno">1139</span>  <span class="n">it</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">));</span>
<a name="c0-1140"></a><span class="lineno">1140</span>  <span class="n">it</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pbase_tree</span><span class="p">;</span>
<a name="c0-1141"></a><span class="lineno">1141</span>  <span class="n">pbase_tree</span> <span class="o">=</span> <span class="n">it</span><span class="p">;</span>
<a name="c0-1142"></a><span class="lineno">1142</span> 
<a name="c0-1143"></a><span class="lineno">1143</span>  <span class="n">hashcpy</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">tree_sha1</span><span class="p">);</span>
<a name="c0-1144"></a><span class="lineno">1144</span>  <span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">tree_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<a name="c0-1145"></a><span class="lineno">1145</span>  <span class="n">it</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">tree_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-1146"></a><span class="lineno">1146</span> <span class="p">}</span>
<a name="c0-1147"></a><span class="lineno">1147</span> 
<a name="c0-1148"></a><span class="lineno">1148</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_preferred_base</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-1149"></a><span class="lineno">1149</span> <span class="p">{</span>
<a name="c0-1150"></a><span class="lineno">1150</span>  <span class="k">struct</span> <span class="n">pbase_tree</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
<a name="c0-1151"></a><span class="lineno">1151</span>  <span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1152"></a><span class="lineno">1152</span> 
<a name="c0-1153"></a><span class="lineno">1153</span>  <span class="n">it</span> <span class="o">=</span> <span class="n">pbase_tree</span><span class="p">;</span>
<a name="c0-1154"></a><span class="lineno">1154</span>  <span class="n">pbase_tree</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1155"></a><span class="lineno">1155</span>  <span class="k">while</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1156"></a><span class="lineno">1156</span>    <span class="k">struct</span> <span class="n">pbase_tree</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">it</span><span class="p">;</span>
<a name="c0-1157"></a><span class="lineno">1157</span>    <span class="n">it</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-1158"></a><span class="lineno">1158</span>    <span class="n">free</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">pcache</span><span class="p">.</span><span class="n">tree_data</span><span class="p">);</span>
<a name="c0-1159"></a><span class="lineno">1159</span>    <span class="n">free</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
<a name="c0-1160"></a><span class="lineno">1160</span>  <span class="p">}</span>
<a name="c0-1161"></a><span class="lineno">1161</span> 
<a name="c0-1162"></a><span class="lineno">1162</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pbase_tree_cache</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1163"></a><span class="lineno">1163</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a name="c0-1164"></a><span class="lineno">1164</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1165"></a><span class="lineno">1165</span>    <span class="n">free</span><span class="p">(</span><span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tree_data</span><span class="p">);</span>
<a name="c0-1166"></a><span class="lineno">1166</span>    <span class="n">free</span><span class="p">(</span><span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-1167"></a><span class="lineno">1167</span>    <span class="n">pbase_tree_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1168"></a><span class="lineno">1168</span>  <span class="p">}</span>
<a name="c0-1169"></a><span class="lineno">1169</span> 
<a name="c0-1170"></a><span class="lineno">1170</span>  <span class="n">free</span><span class="p">(</span><span class="n">done_pbase_paths</span><span class="p">);</span>
<a name="c0-1171"></a><span class="lineno">1171</span>  <span class="n">done_pbase_paths</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1172"></a><span class="lineno">1172</span>  <span class="n">done_pbase_paths_num</span> <span class="o">=</span> <span class="n">done_pbase_paths_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1173"></a><span class="lineno">1173</span> <span class="p">}</span>
<a name="c0-1174"></a><span class="lineno">1174</span> 
<a name="c0-1175"></a><span class="lineno">1175</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">check_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<a name="c0-1176"></a><span class="lineno">1176</span> <span class="p">{</span>
<a name="c0-1177"></a><span class="lineno">1177</span>  <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1178"></a><span class="lineno">1178</span>    <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">;</span>
<a name="c0-1179"></a><span class="lineno">1179</span>    <span class="k">struct</span> <span class="n">pack_window</span> <span class="o">*</span><span class="n">w_curs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1180"></a><span class="lineno">1180</span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base_ref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1181"></a><span class="lineno">1181</span>    <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">base_entry</span><span class="p">;</span>
<a name="c0-1182"></a><span class="lineno">1182</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">,</span> <span class="n">used_0</span><span class="p">;</span>
<a name="c0-1183"></a><span class="lineno">1183</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">avail</span><span class="p">;</span>
<a name="c0-1184"></a><span class="lineno">1184</span>    <span class="kt">off_t</span> <span class="n">ofs</span><span class="p">;</span>
<a name="c0-1185"></a><span class="lineno">1185</span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
<a name="c0-1186"></a><span class="lineno">1186</span> 
<a name="c0-1187"></a><span class="lineno">1187</span>    <span class="n">buf</span> <span class="o">=</span> <span class="n">use_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avail</span><span class="p">);</span>
<a name="c0-1188"></a><span class="lineno">1188</span> 
<a name="c0-1189"></a><span class="lineno">1189</span>    <span class="cm">/*</span>
<a name="c0-1190"></a><span class="lineno">1190</span> <span class="cm">     * We want in_pack_type even if we do not reuse delta</span>
<a name="c0-1191"></a><span class="lineno">1191</span> <span class="cm">     * since non-delta representations could still be reused.</span>
<a name="c0-1192"></a><span class="lineno">1192</span> <span class="cm">     */</span>
<a name="c0-1193"></a><span class="lineno">1193</span>    <span class="n">used</span> <span class="o">=</span> <span class="n">unpack_object_header_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span>
<a name="c0-1194"></a><span class="lineno">1194</span>               <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span><span class="p">,</span>
<a name="c0-1195"></a><span class="lineno">1195</span>               <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-1196"></a><span class="lineno">1196</span>    <span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1197"></a><span class="lineno">1197</span>      <span class="k">goto</span> <span class="n">give_up</span><span class="p">;</span>
<a name="c0-1198"></a><span class="lineno">1198</span> 
<a name="c0-1199"></a><span class="lineno">1199</span>    <span class="cm">/*</span>
<a name="c0-1200"></a><span class="lineno">1200</span> <span class="cm">     * Determine if this is a delta and if so whether we can</span>
<a name="c0-1201"></a><span class="lineno">1201</span> <span class="cm">     * reuse it or not.  Otherwise let's find out as cheaply as</span>
<a name="c0-1202"></a><span class="lineno">1202</span> <span class="cm">     * possible what the actual type and size for this object is.</span>
<a name="c0-1203"></a><span class="lineno">1203</span> <span class="cm">     */</span>
<a name="c0-1204"></a><span class="lineno">1204</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1205"></a><span class="lineno">1205</span>    <span class="nl">default:</span>
<a name="c0-1206"></a><span class="lineno">1206</span>      <span class="cm">/* Not a delta hence we've already got all we need. */</span>
<a name="c0-1207"></a><span class="lineno">1207</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span><span class="p">;</span>
<a name="c0-1208"></a><span class="lineno">1208</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_header_size</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span>
<a name="c0-1209"></a><span class="lineno">1209</span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">OBJ_COMMIT</span> <span class="o">||</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">OBJ_BLOB</span><span class="p">)</span>
<a name="c0-1210"></a><span class="lineno">1210</span>        <span class="k">goto</span> <span class="n">give_up</span><span class="p">;</span>
<a name="c0-1211"></a><span class="lineno">1211</span>      <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-1212"></a><span class="lineno">1212</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1213"></a><span class="lineno">1213</span>    <span class="k">case</span> <span class="n">OBJ_REF_DELTA</span>:
<a name="c0-1214"></a><span class="lineno">1214</span>      <span class="k">if</span> <span class="p">(</span><span class="n">reuse_delta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span>
<a name="c0-1215"></a><span class="lineno">1215</span>        <span class="n">base_ref</span> <span class="o">=</span> <span class="n">use_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span>
<a name="c0-1216"></a><span class="lineno">1216</span>            <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">+</span> <span class="n">used</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1217"></a><span class="lineno">1217</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_header_size</span> <span class="o">=</span> <span class="n">used</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
<a name="c0-1218"></a><span class="lineno">1218</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1219"></a><span class="lineno">1219</span>    <span class="k">case</span> <span class="n">OBJ_OFS_DELTA</span>:
<a name="c0-1220"></a><span class="lineno">1220</span>      <span class="n">buf</span> <span class="o">=</span> <span class="n">use_pack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span>
<a name="c0-1221"></a><span class="lineno">1221</span>               <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">+</span> <span class="n">used</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1222"></a><span class="lineno">1222</span>      <span class="n">used_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1223"></a><span class="lineno">1223</span>      <span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">used_0</span><span class="o">++</span><span class="p">];</span>
<a name="c0-1224"></a><span class="lineno">1224</span>      <span class="n">ofs</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
<a name="c0-1225"></a><span class="lineno">1225</span>      <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1226"></a><span class="lineno">1226</span>        <span class="n">ofs</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1227"></a><span class="lineno">1227</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ofs</span> <span class="o">||</span> <span class="n">MSB</span><span class="p">(</span><span class="n">ofs</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1228"></a><span class="lineno">1228</span>          <span class="n">error</span><span class="p">(</span><span class="s">"delta base offset overflow in pack for %s"</span><span class="p">,</span>
<a name="c0-1229"></a><span class="lineno">1229</span>                <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-1230"></a><span class="lineno">1230</span>          <span class="k">goto</span> <span class="n">give_up</span><span class="p">;</span>
<a name="c0-1231"></a><span class="lineno">1231</span>        <span class="p">}</span>
<a name="c0-1232"></a><span class="lineno">1232</span>        <span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">used_0</span><span class="o">++</span><span class="p">];</span>
<a name="c0-1233"></a><span class="lineno">1233</span>        <span class="n">ofs</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">);</span>
<a name="c0-1234"></a><span class="lineno">1234</span>      <span class="p">}</span>
<a name="c0-1235"></a><span class="lineno">1235</span>      <span class="n">ofs</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">;</span>
<a name="c0-1236"></a><span class="lineno">1236</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ofs</span> <span class="o">&gt;=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1237"></a><span class="lineno">1237</span>        <span class="n">error</span><span class="p">(</span><span class="s">"delta base offset out of bound for %s"</span><span class="p">,</span>
<a name="c0-1238"></a><span class="lineno">1238</span>              <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-1239"></a><span class="lineno">1239</span>        <span class="k">goto</span> <span class="n">give_up</span><span class="p">;</span>
<a name="c0-1240"></a><span class="lineno">1240</span>      <span class="p">}</span>
<a name="c0-1241"></a><span class="lineno">1241</span>      <span class="k">if</span> <span class="p">(</span><span class="n">reuse_delta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1242"></a><span class="lineno">1242</span>        <span class="k">struct</span> <span class="n">revindex_entry</span> <span class="o">*</span><span class="n">revidx</span><span class="p">;</span>
<a name="c0-1243"></a><span class="lineno">1243</span>        <span class="n">revidx</span> <span class="o">=</span> <span class="n">find_pack_revindex</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
<a name="c0-1244"></a><span class="lineno">1244</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">revidx</span><span class="p">)</span>
<a name="c0-1245"></a><span class="lineno">1245</span>          <span class="k">goto</span> <span class="n">give_up</span><span class="p">;</span>
<a name="c0-1246"></a><span class="lineno">1246</span>        <span class="n">base_ref</span> <span class="o">=</span> <span class="n">nth_packed_object_sha1</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">revidx</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
<a name="c0-1247"></a><span class="lineno">1247</span>      <span class="p">}</span>
<a name="c0-1248"></a><span class="lineno">1248</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_header_size</span> <span class="o">=</span> <span class="n">used</span> <span class="o">+</span> <span class="n">used_0</span><span class="p">;</span>
<a name="c0-1249"></a><span class="lineno">1249</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1250"></a><span class="lineno">1250</span>    <span class="p">}</span>
<a name="c0-1251"></a><span class="lineno">1251</span> 
<a name="c0-1252"></a><span class="lineno">1252</span>    <span class="k">if</span> <span class="p">(</span><span class="n">base_ref</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">base_entry</span> <span class="o">=</span> <span class="n">locate_object_entry</span><span class="p">(</span><span class="n">base_ref</span><span class="p">)))</span> <span class="p">{</span>
<a name="c0-1253"></a><span class="lineno">1253</span>      <span class="cm">/*</span>
<a name="c0-1254"></a><span class="lineno">1254</span> <span class="cm">       * If base_ref was set above that means we wish to</span>
<a name="c0-1255"></a><span class="lineno">1255</span> <span class="cm">       * reuse delta data, and we even found that base</span>
<a name="c0-1256"></a><span class="lineno">1256</span> <span class="cm">       * in the list of objects we want to pack. Goodie!</span>
<a name="c0-1257"></a><span class="lineno">1257</span> <span class="cm">       *</span>
<a name="c0-1258"></a><span class="lineno">1258</span> <span class="cm">       * Depth value does not matter - find_deltas() will</span>
<a name="c0-1259"></a><span class="lineno">1259</span> <span class="cm">       * never consider reused delta as the base object to</span>
<a name="c0-1260"></a><span class="lineno">1260</span> <span class="cm">       * deltify other objects against, in order to avoid</span>
<a name="c0-1261"></a><span class="lineno">1261</span> <span class="cm">       * circular deltas.</span>
<a name="c0-1262"></a><span class="lineno">1262</span> <span class="cm">       */</span>
<a name="c0-1263"></a><span class="lineno">1263</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span><span class="p">;</span>
<a name="c0-1264"></a><span class="lineno">1264</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span> <span class="o">=</span> <span class="n">base_entry</span><span class="p">;</span>
<a name="c0-1265"></a><span class="lineno">1265</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_size</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<a name="c0-1266"></a><span class="lineno">1266</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_sibling</span> <span class="o">=</span> <span class="n">base_entry</span><span class="o">-&gt;</span><span class="n">delta_child</span><span class="p">;</span>
<a name="c0-1267"></a><span class="lineno">1267</span>      <span class="n">base_entry</span><span class="o">-&gt;</span><span class="n">delta_child</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<a name="c0-1268"></a><span class="lineno">1268</span>      <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-1269"></a><span class="lineno">1269</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1270"></a><span class="lineno">1270</span>    <span class="p">}</span>
<a name="c0-1271"></a><span class="lineno">1271</span> 
<a name="c0-1272"></a><span class="lineno">1272</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1273"></a><span class="lineno">1273</span>      <span class="cm">/*</span>
<a name="c0-1274"></a><span class="lineno">1274</span> <span class="cm">       * This must be a delta and we already know what the</span>
<a name="c0-1275"></a><span class="lineno">1275</span> <span class="cm">       * final object type is.  Let's extract the actual</span>
<a name="c0-1276"></a><span class="lineno">1276</span> <span class="cm">       * object size from the delta header.</span>
<a name="c0-1277"></a><span class="lineno">1277</span> <span class="cm">       */</span>
<a name="c0-1278"></a><span class="lineno">1278</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">get_size_from_delta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_curs</span><span class="p">,</span>
<a name="c0-1279"></a><span class="lineno">1279</span>          <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">in_pack_header_size</span><span class="p">);</span>
<a name="c0-1280"></a><span class="lineno">1280</span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1281"></a><span class="lineno">1281</span>        <span class="k">goto</span> <span class="n">give_up</span><span class="p">;</span>
<a name="c0-1282"></a><span class="lineno">1282</span>      <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-1283"></a><span class="lineno">1283</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1284"></a><span class="lineno">1284</span>    <span class="p">}</span>
<a name="c0-1285"></a><span class="lineno">1285</span> 
<a name="c0-1286"></a><span class="lineno">1286</span>    <span class="cm">/*</span>
<a name="c0-1287"></a><span class="lineno">1287</span> <span class="cm">     * No choice but to fall back to the recursive delta walk</span>
<a name="c0-1288"></a><span class="lineno">1288</span> <span class="cm">     * with sha1_object_info() to find about the object type</span>
<a name="c0-1289"></a><span class="lineno">1289</span> <span class="cm">     * at this point...</span>
<a name="c0-1290"></a><span class="lineno">1290</span> <span class="cm">     */</span>
<a name="c0-1291"></a><span class="lineno">1291</span>    <span class="nl">give_up:</span>
<a name="c0-1292"></a><span class="lineno">1292</span>    <span class="n">unuse_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w_curs</span><span class="p">);</span>
<a name="c0-1293"></a><span class="lineno">1293</span>  <span class="p">}</span>
<a name="c0-1294"></a><span class="lineno">1294</span> 
<a name="c0-1295"></a><span class="lineno">1295</span>  <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sha1_object_info</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-1296"></a><span class="lineno">1296</span>  <span class="cm">/*</span>
<a name="c0-1297"></a><span class="lineno">1297</span> <span class="cm">   * The error condition is checked in prepare_pack().  This is</span>
<a name="c0-1298"></a><span class="lineno">1298</span> <span class="cm">   * to permit a missing preferred base object to be ignored</span>
<a name="c0-1299"></a><span class="lineno">1299</span> <span class="cm">   * as a preferred base.  Doing so can result in a larger</span>
<a name="c0-1300"></a><span class="lineno">1300</span> <span class="cm">   * pack file, but the transfer will still take place.</span>
<a name="c0-1301"></a><span class="lineno">1301</span> <span class="cm">   */</span>
<a name="c0-1302"></a><span class="lineno">1302</span> <span class="p">}</span>
<a name="c0-1303"></a><span class="lineno">1303</span> 
<a name="c0-1304"></a><span class="lineno">1304</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">pack_offset_sort</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_b</span><span class="p">)</span>
<a name="c0-1305"></a><span class="lineno">1305</span> <span class="p">{</span>
<a name="c0-1306"></a><span class="lineno">1306</span>  <span class="k">const</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="p">)</span><span class="n">_a</span><span class="p">;</span>
<a name="c0-1307"></a><span class="lineno">1307</span>  <span class="k">const</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="p">)</span><span class="n">_b</span><span class="p">;</span>
<a name="c0-1308"></a><span class="lineno">1308</span> 
<a name="c0-1309"></a><span class="lineno">1309</span>  <span class="cm">/* avoid filesystem trashing with loose objects */</span>
<a name="c0-1310"></a><span class="lineno">1310</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">)</span>
<a name="c0-1311"></a><span class="lineno">1311</span>    <span class="k">return</span> <span class="n">hashcmp</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-1312"></a><span class="lineno">1312</span> 
<a name="c0-1313"></a><span class="lineno">1313</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">)</span>
<a name="c0-1314"></a><span class="lineno">1314</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1315"></a><span class="lineno">1315</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">in_pack</span><span class="p">)</span>
<a name="c0-1316"></a><span class="lineno">1316</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1317"></a><span class="lineno">1317</span>  <span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span>
<a name="c0-1318"></a><span class="lineno">1318</span>      <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">in_pack_offset</span><span class="p">);</span>
<a name="c0-1319"></a><span class="lineno">1319</span> <span class="p">}</span>
<a name="c0-1320"></a><span class="lineno">1320</span> 
<a name="c0-1321"></a><span class="lineno">1321</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">get_object_details</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-1322"></a><span class="lineno">1322</span> <span class="p">{</span>
<a name="c0-1323"></a><span class="lineno">1323</span>  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1324"></a><span class="lineno">1324</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">sorted_by_offset</span><span class="p">;</span>
<a name="c0-1325"></a><span class="lineno">1325</span> 
<a name="c0-1326"></a><span class="lineno">1326</span>  <span class="n">sorted_by_offset</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="n">nr_objects</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1327"></a><span class="lineno">1327</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1328"></a><span class="lineno">1328</span>    <span class="n">sorted_by_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">objects</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1329"></a><span class="lineno">1329</span>  <span class="n">qsort</span><span class="p">(</span><span class="n">sorted_by_offset</span><span class="p">,</span> <span class="n">nr_objects</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sorted_by_offset</span><span class="p">),</span> <span class="n">pack_offset_sort</span><span class="p">);</span>
<a name="c0-1330"></a><span class="lineno">1330</span> 
<a name="c0-1331"></a><span class="lineno">1331</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1332"></a><span class="lineno">1332</span>    <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">sorted_by_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-1333"></a><span class="lineno">1333</span>    <span class="n">check_object</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<a name="c0-1334"></a><span class="lineno">1334</span>    <span class="k">if</span> <span class="p">(</span><span class="n">big_file_threshold</span> <span class="o">&lt;=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<a name="c0-1335"></a><span class="lineno">1335</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">no_try_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1336"></a><span class="lineno">1336</span>  <span class="p">}</span>
<a name="c0-1337"></a><span class="lineno">1337</span> 
<a name="c0-1338"></a><span class="lineno">1338</span>  <span class="n">free</span><span class="p">(</span><span class="n">sorted_by_offset</span><span class="p">);</span>
<a name="c0-1339"></a><span class="lineno">1339</span> <span class="p">}</span>
<a name="c0-1340"></a><span class="lineno">1340</span> 
<a name="c0-1341"></a><span class="lineno">1341</span> <span class="cm">/*</span>
<a name="c0-1342"></a><span class="lineno">1342</span> <span class="cm"> * We search for deltas in a list sorted by type, by filename hash, and then</span>
<a name="c0-1343"></a><span class="lineno">1343</span> <span class="cm"> * by size, so that we see progressively smaller and smaller files.</span>
<a name="c0-1344"></a><span class="lineno">1344</span> <span class="cm"> * That's because we prefer deltas to be from the bigger file</span>
<a name="c0-1345"></a><span class="lineno">1345</span> <span class="cm"> * to the smaller -- deletes are potentially cheaper, but perhaps</span>
<a name="c0-1346"></a><span class="lineno">1346</span> <span class="cm"> * more importantly, the bigger file is likely the more recent</span>
<a name="c0-1347"></a><span class="lineno">1347</span> <span class="cm"> * one.  The deepest deltas are therefore the oldest objects which are</span>
<a name="c0-1348"></a><span class="lineno">1348</span> <span class="cm"> * less susceptible to be accessed often.</span>
<a name="c0-1349"></a><span class="lineno">1349</span> <span class="cm"> */</span>
<a name="c0-1350"></a><span class="lineno">1350</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">type_size_sort</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_b</span><span class="p">)</span>
<a name="c0-1351"></a><span class="lineno">1351</span> <span class="p">{</span>
<a name="c0-1352"></a><span class="lineno">1352</span>  <span class="k">const</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="p">)</span><span class="n">_a</span><span class="p">;</span>
<a name="c0-1353"></a><span class="lineno">1353</span>  <span class="k">const</span> <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="p">)</span><span class="n">_b</span><span class="p">;</span>
<a name="c0-1354"></a><span class="lineno">1354</span> 
<a name="c0-1355"></a><span class="lineno">1355</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
<a name="c0-1356"></a><span class="lineno">1356</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1357"></a><span class="lineno">1357</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
<a name="c0-1358"></a><span class="lineno">1358</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1359"></a><span class="lineno">1359</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span>
<a name="c0-1360"></a><span class="lineno">1360</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1361"></a><span class="lineno">1361</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span>
<a name="c0-1362"></a><span class="lineno">1362</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1363"></a><span class="lineno">1363</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">preferred_base</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span>
<a name="c0-1364"></a><span class="lineno">1364</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1365"></a><span class="lineno">1365</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">preferred_base</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span>
<a name="c0-1366"></a><span class="lineno">1366</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1367"></a><span class="lineno">1367</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<a name="c0-1368"></a><span class="lineno">1368</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1369"></a><span class="lineno">1369</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<a name="c0-1370"></a><span class="lineno">1370</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1371"></a><span class="lineno">1371</span>  <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">);</span>  <span class="cm">/* newest first */</span>
<a name="c0-1372"></a><span class="lineno">1372</span> <span class="p">}</span>
<a name="c0-1373"></a><span class="lineno">1373</span> 
<a name="c0-1374"></a><span class="lineno">1374</span> <span class="k">struct</span> <span class="n">unpacked</span> <span class="p">{</span>
<a name="c0-1375"></a><span class="lineno">1375</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<a name="c0-1376"></a><span class="lineno">1376</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-1377"></a><span class="lineno">1377</span>  <span class="k">struct</span> <span class="n">delta_index</span> <span class="o">*</span><span class="n">index</span><span class="p">;</span>
<a name="c0-1378"></a><span class="lineno">1378</span>  <span class="kt">unsigned</span> <span class="n">depth</span><span class="p">;</span>
<a name="c0-1379"></a><span class="lineno">1379</span> <span class="p">};</span>
<a name="c0-1380"></a><span class="lineno">1380</span> 
<a name="c0-1381"></a><span class="lineno">1381</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">delta_cacheable</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trg_size</span><span class="p">,</span>
<a name="c0-1382"></a><span class="lineno">1382</span>         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta_size</span><span class="p">)</span>
<a name="c0-1383"></a><span class="lineno">1383</span> <span class="p">{</span>
<a name="c0-1384"></a><span class="lineno">1384</span>  <span class="k">if</span> <span class="p">(</span><span class="n">max_delta_cache_size</span> <span class="o">&amp;&amp;</span> <span class="n">delta_cache_size</span> <span class="o">+</span> <span class="n">delta_size</span> <span class="o">&gt;</span> <span class="n">max_delta_cache_size</span><span class="p">)</span>
<a name="c0-1385"></a><span class="lineno">1385</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1386"></a><span class="lineno">1386</span> 
<a name="c0-1387"></a><span class="lineno">1387</span>  <span class="k">if</span> <span class="p">(</span><span class="n">delta_size</span> <span class="o">&lt;</span> <span class="n">cache_max_small_delta_size</span><span class="p">)</span>
<a name="c0-1388"></a><span class="lineno">1388</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1389"></a><span class="lineno">1389</span> 
<a name="c0-1390"></a><span class="lineno">1390</span>  <span class="cm">/* cache delta, if objects are large enough compared to delta size */</span>
<a name="c0-1391"></a><span class="lineno">1391</span>  <span class="k">if</span> <span class="p">((</span><span class="n">src_size</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">trg_size</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">delta_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">))</span>
<a name="c0-1392"></a><span class="lineno">1392</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1393"></a><span class="lineno">1393</span> 
<a name="c0-1394"></a><span class="lineno">1394</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1395"></a><span class="lineno">1395</span> <span class="p">}</span>
<a name="c0-1396"></a><span class="lineno">1396</span> 
<a name="c0-1397"></a><span class="lineno">1397</span> <span class="cp">#ifndef NO_PTHREADS</span>
<a name="c0-1398"></a><span class="lineno">1398</span> 
<a name="c0-1399"></a><span class="lineno">1399</span> <span class="k">static</span> <span class="n">pthread_mutex_t</span> <span class="n">read_mutex</span><span class="p">;</span>
<a name="c0-1400"></a><span class="lineno">1400</span> <span class="cp">#define read_lock()   pthread_mutex_lock(&amp;read_mutex)</span>
<a name="c0-1401"></a><span class="lineno">1401</span> <span class="cp">#define read_unlock()   pthread_mutex_unlock(&amp;read_mutex)</span>
<a name="c0-1402"></a><span class="lineno">1402</span> 
<a name="c0-1403"></a><span class="lineno">1403</span> <span class="k">static</span> <span class="n">pthread_mutex_t</span> <span class="n">cache_mutex</span><span class="p">;</span>
<a name="c0-1404"></a><span class="lineno">1404</span> <span class="cp">#define cache_lock()    pthread_mutex_lock(&amp;cache_mutex)</span>
<a name="c0-1405"></a><span class="lineno">1405</span> <span class="cp">#define cache_unlock()    pthread_mutex_unlock(&amp;cache_mutex)</span>
<a name="c0-1406"></a><span class="lineno">1406</span> 
<a name="c0-1407"></a><span class="lineno">1407</span> <span class="k">static</span> <span class="n">pthread_mutex_t</span> <span class="n">progress_mutex</span><span class="p">;</span>
<a name="c0-1408"></a><span class="lineno">1408</span> <span class="cp">#define progress_lock()   pthread_mutex_lock(&amp;progress_mutex)</span>
<a name="c0-1409"></a><span class="lineno">1409</span> <span class="cp">#define progress_unlock() pthread_mutex_unlock(&amp;progress_mutex)</span>
<a name="c0-1410"></a><span class="lineno">1410</span> 
<a name="c0-1411"></a><span class="lineno">1411</span> <span class="cp">#else</span>
<a name="c0-1412"></a><span class="lineno">1412</span> 
<a name="c0-1413"></a><span class="lineno">1413</span> <span class="cp">#define read_lock()   (void)0</span>
<a name="c0-1414"></a><span class="lineno">1414</span> <span class="cp">#define read_unlock()   (void)0</span>
<a name="c0-1415"></a><span class="lineno">1415</span> <span class="cp">#define cache_lock()    (void)0</span>
<a name="c0-1416"></a><span class="lineno">1416</span> <span class="cp">#define cache_unlock()    (void)0</span>
<a name="c0-1417"></a><span class="lineno">1417</span> <span class="cp">#define progress_lock()   (void)0</span>
<a name="c0-1418"></a><span class="lineno">1418</span> <span class="cp">#define progress_unlock() (void)0</span>
<a name="c0-1419"></a><span class="lineno">1419</span> 
<a name="c0-1420"></a><span class="lineno">1420</span> <span class="cp">#endif</span>
<a name="c0-1421"></a><span class="lineno">1421</span> 
<a name="c0-1422"></a><span class="lineno">1422</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">try_delta</span><span class="p">(</span><span class="k">struct</span> <span class="n">unpacked</span> <span class="o">*</span><span class="n">trg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unpacked</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
<a name="c0-1423"></a><span class="lineno">1423</span>         <span class="kt">unsigned</span> <span class="n">max_depth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_usage</span><span class="p">)</span>
<a name="c0-1424"></a><span class="lineno">1424</span> <span class="p">{</span>
<a name="c0-1425"></a><span class="lineno">1425</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">trg_entry</span> <span class="o">=</span> <span class="n">trg</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
<a name="c0-1426"></a><span class="lineno">1426</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">src_entry</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
<a name="c0-1427"></a><span class="lineno">1427</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trg_size</span><span class="p">,</span> <span class="n">src_size</span><span class="p">,</span> <span class="n">delta_size</span><span class="p">,</span> <span class="n">sizediff</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-1428"></a><span class="lineno">1428</span>  <span class="kt">unsigned</span> <span class="n">ref_depth</span><span class="p">;</span>
<a name="c0-1429"></a><span class="lineno">1429</span>  <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-1430"></a><span class="lineno">1430</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">delta_buf</span><span class="p">;</span>
<a name="c0-1431"></a><span class="lineno">1431</span> 
<a name="c0-1432"></a><span class="lineno">1432</span>  <span class="cm">/* Don't bother doing diffs between different types */</span>
<a name="c0-1433"></a><span class="lineno">1433</span>  <span class="k">if</span> <span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
<a name="c0-1434"></a><span class="lineno">1434</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1435"></a><span class="lineno">1435</span> 
<a name="c0-1436"></a><span class="lineno">1436</span>  <span class="cm">/*</span>
<a name="c0-1437"></a><span class="lineno">1437</span> <span class="cm">   * We do not bother to try a delta that we discarded on an</span>
<a name="c0-1438"></a><span class="lineno">1438</span> <span class="cm">   * earlier try, but only when reusing delta data.  Note that</span>
<a name="c0-1439"></a><span class="lineno">1439</span> <span class="cm">   * src_entry that is marked as the preferred_base should always</span>
<a name="c0-1440"></a><span class="lineno">1440</span> <span class="cm">   * be considered, as even if we produce a suboptimal delta against</span>
<a name="c0-1441"></a><span class="lineno">1441</span> <span class="cm">   * it, we will still save the transfer cost, as we already know</span>
<a name="c0-1442"></a><span class="lineno">1442</span> <span class="cm">   * the other side has it and we won't send src_entry at all.</span>
<a name="c0-1443"></a><span class="lineno">1443</span> <span class="cm">   */</span>
<a name="c0-1444"></a><span class="lineno">1444</span>  <span class="k">if</span> <span class="p">(</span><span class="n">reuse_delta</span> <span class="o">&amp;&amp;</span> <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">&amp;&amp;</span>
<a name="c0-1445"></a><span class="lineno">1445</span>      <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">==</span> <span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">in_pack</span> <span class="o">&amp;&amp;</span>
<a name="c0-1446"></a><span class="lineno">1446</span>      <span class="o">!</span><span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span> <span class="o">&amp;&amp;</span>
<a name="c0-1447"></a><span class="lineno">1447</span>      <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span> <span class="o">!=</span> <span class="n">OBJ_REF_DELTA</span> <span class="o">&amp;&amp;</span>
<a name="c0-1448"></a><span class="lineno">1448</span>      <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">in_pack_type</span> <span class="o">!=</span> <span class="n">OBJ_OFS_DELTA</span><span class="p">)</span>
<a name="c0-1449"></a><span class="lineno">1449</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1450"></a><span class="lineno">1450</span> 
<a name="c0-1451"></a><span class="lineno">1451</span>  <span class="cm">/* Let's not bust the allowed depth. */</span>
<a name="c0-1452"></a><span class="lineno">1452</span>  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">max_depth</span><span class="p">)</span>
<a name="c0-1453"></a><span class="lineno">1453</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1454"></a><span class="lineno">1454</span> 
<a name="c0-1455"></a><span class="lineno">1455</span>  <span class="cm">/* Now some size filtering heuristics. */</span>
<a name="c0-1456"></a><span class="lineno">1456</span>  <span class="n">trg_size</span> <span class="o">=</span> <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<a name="c0-1457"></a><span class="lineno">1457</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1458"></a><span class="lineno">1458</span>    <span class="n">max_size</span> <span class="o">=</span> <span class="n">trg_size</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">20</span><span class="p">;</span>
<a name="c0-1459"></a><span class="lineno">1459</span>    <span class="n">ref_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1460"></a><span class="lineno">1460</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-1461"></a><span class="lineno">1461</span>    <span class="n">max_size</span> <span class="o">=</span> <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">;</span>
<a name="c0-1462"></a><span class="lineno">1462</span>    <span class="n">ref_depth</span> <span class="o">=</span> <span class="n">trg</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
<a name="c0-1463"></a><span class="lineno">1463</span>  <span class="p">}</span>
<a name="c0-1464"></a><span class="lineno">1464</span>  <span class="n">max_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">max_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_depth</span> <span class="o">-</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">/</span>
<a name="c0-1465"></a><span class="lineno">1465</span>            <span class="p">(</span><span class="n">max_depth</span> <span class="o">-</span> <span class="n">ref_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-1466"></a><span class="lineno">1466</span>  <span class="k">if</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1467"></a><span class="lineno">1467</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1468"></a><span class="lineno">1468</span>  <span class="n">src_size</span> <span class="o">=</span> <span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<a name="c0-1469"></a><span class="lineno">1469</span>  <span class="n">sizediff</span> <span class="o">=</span> <span class="n">src_size</span> <span class="o">&lt;</span> <span class="n">trg_size</span> <span class="o">?</span> <span class="n">trg_size</span> <span class="o">-</span> <span class="n">src_size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1470"></a><span class="lineno">1470</span>  <span class="k">if</span> <span class="p">(</span><span class="n">sizediff</span> <span class="o">&gt;=</span> <span class="n">max_size</span><span class="p">)</span>
<a name="c0-1471"></a><span class="lineno">1471</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1472"></a><span class="lineno">1472</span>  <span class="k">if</span> <span class="p">(</span><span class="n">trg_size</span> <span class="o">&lt;</span> <span class="n">src_size</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span>
<a name="c0-1473"></a><span class="lineno">1473</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1474"></a><span class="lineno">1474</span> 
<a name="c0-1475"></a><span class="lineno">1475</span>  <span class="cm">/* Load data if not already done */</span>
<a name="c0-1476"></a><span class="lineno">1476</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1477"></a><span class="lineno">1477</span>    <span class="n">read_lock</span><span class="p">();</span>
<a name="c0-1478"></a><span class="lineno">1478</span>    <span class="n">trg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<a name="c0-1479"></a><span class="lineno">1479</span>    <span class="n">read_unlock</span><span class="p">();</span>
<a name="c0-1480"></a><span class="lineno">1480</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
<a name="c0-1481"></a><span class="lineno">1481</span>      <span class="n">die</span><span class="p">(</span><span class="s">"object %s cannot be read"</span><span class="p">,</span>
<a name="c0-1482"></a><span class="lineno">1482</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-1483"></a><span class="lineno">1483</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="n">trg_size</span><span class="p">)</span>
<a name="c0-1484"></a><span class="lineno">1484</span>      <span class="n">die</span><span class="p">(</span><span class="s">"object %s inconsistent object length (%lu vs %lu)"</span><span class="p">,</span>
<a name="c0-1485"></a><span class="lineno">1485</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">),</span> <span class="n">sz</span><span class="p">,</span> <span class="n">trg_size</span><span class="p">);</span>
<a name="c0-1486"></a><span class="lineno">1486</span>    <span class="o">*</span><span class="n">mem_usage</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-1487"></a><span class="lineno">1487</span>  <span class="p">}</span>
<a name="c0-1488"></a><span class="lineno">1488</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1489"></a><span class="lineno">1489</span>    <span class="n">read_lock</span><span class="p">();</span>
<a name="c0-1490"></a><span class="lineno">1490</span>    <span class="n">src</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<a name="c0-1491"></a><span class="lineno">1491</span>    <span class="n">read_unlock</span><span class="p">();</span>
<a name="c0-1492"></a><span class="lineno">1492</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1493"></a><span class="lineno">1493</span>      <span class="k">if</span> <span class="p">(</span><span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1494"></a><span class="lineno">1494</span>        <span class="k">static</span> <span class="kt">int</span> <span class="n">warned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1495"></a><span class="lineno">1495</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">warned</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1496"></a><span class="lineno">1496</span>          <span class="n">warning</span><span class="p">(</span><span class="s">"object %s cannot be read"</span><span class="p">,</span>
<a name="c0-1497"></a><span class="lineno">1497</span>            <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-1498"></a><span class="lineno">1498</span>        <span class="cm">/*</span>
<a name="c0-1499"></a><span class="lineno">1499</span> <span class="cm">         * Those objects are not included in the</span>
<a name="c0-1500"></a><span class="lineno">1500</span> <span class="cm">         * resulting pack.  Be resilient and ignore</span>
<a name="c0-1501"></a><span class="lineno">1501</span> <span class="cm">         * them if they can't be read, in case the</span>
<a name="c0-1502"></a><span class="lineno">1502</span> <span class="cm">         * pack could be created nevertheless.</span>
<a name="c0-1503"></a><span class="lineno">1503</span> <span class="cm">         */</span>
<a name="c0-1504"></a><span class="lineno">1504</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1505"></a><span class="lineno">1505</span>      <span class="p">}</span>
<a name="c0-1506"></a><span class="lineno">1506</span>      <span class="n">die</span><span class="p">(</span><span class="s">"object %s cannot be read"</span><span class="p">,</span>
<a name="c0-1507"></a><span class="lineno">1507</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-1508"></a><span class="lineno">1508</span>    <span class="p">}</span>
<a name="c0-1509"></a><span class="lineno">1509</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">!=</span> <span class="n">src_size</span><span class="p">)</span>
<a name="c0-1510"></a><span class="lineno">1510</span>      <span class="n">die</span><span class="p">(</span><span class="s">"object %s inconsistent object length (%lu vs %lu)"</span><span class="p">,</span>
<a name="c0-1511"></a><span class="lineno">1511</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">src_entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">),</span> <span class="n">sz</span><span class="p">,</span> <span class="n">src_size</span><span class="p">);</span>
<a name="c0-1512"></a><span class="lineno">1512</span>    <span class="o">*</span><span class="n">mem_usage</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-1513"></a><span class="lineno">1513</span>  <span class="p">}</span>
<a name="c0-1514"></a><span class="lineno">1514</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1515"></a><span class="lineno">1515</span>    <span class="n">src</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">create_delta_index</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">src_size</span><span class="p">);</span>
<a name="c0-1516"></a><span class="lineno">1516</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1517"></a><span class="lineno">1517</span>      <span class="k">static</span> <span class="kt">int</span> <span class="n">warned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1518"></a><span class="lineno">1518</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">warned</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1519"></a><span class="lineno">1519</span>        <span class="n">warning</span><span class="p">(</span><span class="s">"suboptimal pack - out of memory"</span><span class="p">);</span>
<a name="c0-1520"></a><span class="lineno">1520</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1521"></a><span class="lineno">1521</span>    <span class="p">}</span>
<a name="c0-1522"></a><span class="lineno">1522</span>    <span class="o">*</span><span class="n">mem_usage</span> <span class="o">+=</span> <span class="n">sizeof_delta_index</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<a name="c0-1523"></a><span class="lineno">1523</span>  <span class="p">}</span>
<a name="c0-1524"></a><span class="lineno">1524</span> 
<a name="c0-1525"></a><span class="lineno">1525</span>  <span class="n">delta_buf</span> <span class="o">=</span> <span class="n">create_delta</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">trg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">trg_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delta_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">);</span>
<a name="c0-1526"></a><span class="lineno">1526</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta_buf</span><span class="p">)</span>
<a name="c0-1527"></a><span class="lineno">1527</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1528"></a><span class="lineno">1528</span> 
<a name="c0-1529"></a><span class="lineno">1529</span>  <span class="k">if</span> <span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1530"></a><span class="lineno">1530</span>    <span class="cm">/* Prefer only shallower same-sized deltas. */</span>
<a name="c0-1531"></a><span class="lineno">1531</span>    <span class="k">if</span> <span class="p">(</span><span class="n">delta_size</span> <span class="o">==</span> <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_size</span> <span class="o">&amp;&amp;</span>
<a name="c0-1532"></a><span class="lineno">1532</span>        <span class="n">src</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">trg</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1533"></a><span class="lineno">1533</span>      <span class="n">free</span><span class="p">(</span><span class="n">delta_buf</span><span class="p">);</span>
<a name="c0-1534"></a><span class="lineno">1534</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1535"></a><span class="lineno">1535</span>    <span class="p">}</span>
<a name="c0-1536"></a><span class="lineno">1536</span>  <span class="p">}</span>
<a name="c0-1537"></a><span class="lineno">1537</span> 
<a name="c0-1538"></a><span class="lineno">1538</span>  <span class="cm">/*</span>
<a name="c0-1539"></a><span class="lineno">1539</span> <span class="cm">   * Handle memory allocation outside of the cache</span>
<a name="c0-1540"></a><span class="lineno">1540</span> <span class="cm">   * accounting lock.  Compiler will optimize the strangeness</span>
<a name="c0-1541"></a><span class="lineno">1541</span> <span class="cm">   * away when NO_PTHREADS is defined.</span>
<a name="c0-1542"></a><span class="lineno">1542</span> <span class="cm">   */</span>
<a name="c0-1543"></a><span class="lineno">1543</span>  <span class="n">free</span><span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_data</span><span class="p">);</span>
<a name="c0-1544"></a><span class="lineno">1544</span>  <span class="n">cache_lock</span><span class="p">();</span>
<a name="c0-1545"></a><span class="lineno">1545</span>  <span class="k">if</span> <span class="p">(</span><span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_data</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1546"></a><span class="lineno">1546</span>    <span class="n">delta_cache_size</span> <span class="o">-=</span> <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">;</span>
<a name="c0-1547"></a><span class="lineno">1547</span>    <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1548"></a><span class="lineno">1548</span>  <span class="p">}</span>
<a name="c0-1549"></a><span class="lineno">1549</span>  <span class="k">if</span> <span class="p">(</span><span class="n">delta_cacheable</span><span class="p">(</span><span class="n">src_size</span><span class="p">,</span> <span class="n">trg_size</span><span class="p">,</span> <span class="n">delta_size</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1550"></a><span class="lineno">1550</span>    <span class="n">delta_cache_size</span> <span class="o">+=</span> <span class="n">delta_size</span><span class="p">;</span>
<a name="c0-1551"></a><span class="lineno">1551</span>    <span class="n">cache_unlock</span><span class="p">();</span>
<a name="c0-1552"></a><span class="lineno">1552</span>    <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_data</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">delta_buf</span><span class="p">,</span> <span class="n">delta_size</span><span class="p">);</span>
<a name="c0-1553"></a><span class="lineno">1553</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-1554"></a><span class="lineno">1554</span>    <span class="n">cache_unlock</span><span class="p">();</span>
<a name="c0-1555"></a><span class="lineno">1555</span>    <span class="n">free</span><span class="p">(</span><span class="n">delta_buf</span><span class="p">);</span>
<a name="c0-1556"></a><span class="lineno">1556</span>  <span class="p">}</span>
<a name="c0-1557"></a><span class="lineno">1557</span> 
<a name="c0-1558"></a><span class="lineno">1558</span>  <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta</span> <span class="o">=</span> <span class="n">src_entry</span><span class="p">;</span>
<a name="c0-1559"></a><span class="lineno">1559</span>  <span class="n">trg_entry</span><span class="o">-&gt;</span><span class="n">delta_size</span> <span class="o">=</span> <span class="n">delta_size</span><span class="p">;</span>
<a name="c0-1560"></a><span class="lineno">1560</span>  <span class="n">trg</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1561"></a><span class="lineno">1561</span> 
<a name="c0-1562"></a><span class="lineno">1562</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1563"></a><span class="lineno">1563</span> <span class="p">}</span>
<a name="c0-1564"></a><span class="lineno">1564</span> 
<a name="c0-1565"></a><span class="lineno">1565</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">check_delta_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<a name="c0-1566"></a><span class="lineno">1566</span> <span class="p">{</span>
<a name="c0-1567"></a><span class="lineno">1567</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">delta_child</span><span class="p">;</span>
<a name="c0-1568"></a><span class="lineno">1568</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-1569"></a><span class="lineno">1569</span>  <span class="k">while</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1570"></a><span class="lineno">1570</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">check_delta_limit</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-1571"></a><span class="lineno">1571</span>    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">)</span>
<a name="c0-1572"></a><span class="lineno">1572</span>      <span class="n">m</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="c0-1573"></a><span class="lineno">1573</span>    <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">delta_sibling</span><span class="p">;</span>
<a name="c0-1574"></a><span class="lineno">1574</span>  <span class="p">}</span>
<a name="c0-1575"></a><span class="lineno">1575</span>  <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<a name="c0-1576"></a><span class="lineno">1576</span> <span class="p">}</span>
<a name="c0-1577"></a><span class="lineno">1577</span> 
<a name="c0-1578"></a><span class="lineno">1578</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">free_unpacked</span><span class="p">(</span><span class="k">struct</span> <span class="n">unpacked</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<a name="c0-1579"></a><span class="lineno">1579</span> <span class="p">{</span>
<a name="c0-1580"></a><span class="lineno">1580</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freed_mem</span> <span class="o">=</span> <span class="n">sizeof_delta_index</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<a name="c0-1581"></a><span class="lineno">1581</span>  <span class="n">free_delta_index</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<a name="c0-1582"></a><span class="lineno">1582</span>  <span class="n">n</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1583"></a><span class="lineno">1583</span>  <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1584"></a><span class="lineno">1584</span>    <span class="n">freed_mem</span> <span class="o">+=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<a name="c0-1585"></a><span class="lineno">1585</span>    <span class="n">free</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<a name="c0-1586"></a><span class="lineno">1586</span>    <span class="n">n</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1587"></a><span class="lineno">1587</span>  <span class="p">}</span>
<a name="c0-1588"></a><span class="lineno">1588</span>  <span class="n">n</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1589"></a><span class="lineno">1589</span>  <span class="n">n</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1590"></a><span class="lineno">1590</span>  <span class="k">return</span> <span class="n">freed_mem</span><span class="p">;</span>
<a name="c0-1591"></a><span class="lineno">1591</span> <span class="p">}</span>
<a name="c0-1592"></a><span class="lineno">1592</span> 
<a name="c0-1593"></a><span class="lineno">1593</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">find_deltas</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">list_size</span><span class="p">,</span>
<a name="c0-1594"></a><span class="lineno">1594</span>      <span class="kt">int</span> <span class="n">window</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">processed</span><span class="p">)</span>
<a name="c0-1595"></a><span class="lineno">1595</span> <span class="p">{</span>
<a name="c0-1596"></a><span class="lineno">1596</span>  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1597"></a><span class="lineno">1597</span>  <span class="k">struct</span> <span class="n">unpacked</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
<a name="c0-1598"></a><span class="lineno">1598</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_usage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1599"></a><span class="lineno">1599</span> 
<a name="c0-1600"></a><span class="lineno">1600</span>  <span class="n">array</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unpacked</span><span class="p">));</span>
<a name="c0-1601"></a><span class="lineno">1601</span> 
<a name="c0-1602"></a><span class="lineno">1602</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-1603"></a><span class="lineno">1603</span>    <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<a name="c0-1604"></a><span class="lineno">1604</span>    <span class="k">struct</span> <span class="n">unpacked</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">array</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
<a name="c0-1605"></a><span class="lineno">1605</span>    <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">best_base</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1606"></a><span class="lineno">1606</span> 
<a name="c0-1607"></a><span class="lineno">1607</span>    <span class="n">progress_lock</span><span class="p">();</span>
<a name="c0-1608"></a><span class="lineno">1608</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">list_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1609"></a><span class="lineno">1609</span>      <span class="n">progress_unlock</span><span class="p">();</span>
<a name="c0-1610"></a><span class="lineno">1610</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1611"></a><span class="lineno">1611</span>    <span class="p">}</span>
<a name="c0-1612"></a><span class="lineno">1612</span>    <span class="n">entry</span> <span class="o">=</span> <span class="o">*</span><span class="n">list</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1613"></a><span class="lineno">1613</span>    <span class="p">(</span><span class="o">*</span><span class="n">list_size</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1614"></a><span class="lineno">1614</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1615"></a><span class="lineno">1615</span>      <span class="p">(</span><span class="o">*</span><span class="n">processed</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1616"></a><span class="lineno">1616</span>      <span class="n">display_progress</span><span class="p">(</span><span class="n">progress_state</span><span class="p">,</span> <span class="o">*</span><span class="n">processed</span><span class="p">);</span>
<a name="c0-1617"></a><span class="lineno">1617</span>    <span class="p">}</span>
<a name="c0-1618"></a><span class="lineno">1618</span>    <span class="n">progress_unlock</span><span class="p">();</span>
<a name="c0-1619"></a><span class="lineno">1619</span> 
<a name="c0-1620"></a><span class="lineno">1620</span>    <span class="n">mem_usage</span> <span class="o">-=</span> <span class="n">free_unpacked</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<a name="c0-1621"></a><span class="lineno">1621</span>    <span class="n">n</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<a name="c0-1622"></a><span class="lineno">1622</span> 
<a name="c0-1623"></a><span class="lineno">1623</span>    <span class="k">while</span> <span class="p">(</span><span class="n">window_memory_limit</span> <span class="o">&amp;&amp;</span>
<a name="c0-1624"></a><span class="lineno">1624</span>           <span class="n">mem_usage</span> <span class="o">&gt;</span> <span class="n">window_memory_limit</span> <span class="o">&amp;&amp;</span>
<a name="c0-1625"></a><span class="lineno">1625</span>           <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1626"></a><span class="lineno">1626</span>      <span class="kt">uint32_t</span> <span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">window</span> <span class="o">-</span> <span class="n">count</span><span class="p">)</span> <span class="o">%</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1627"></a><span class="lineno">1627</span>      <span class="n">mem_usage</span> <span class="o">-=</span> <span class="n">free_unpacked</span><span class="p">(</span><span class="n">array</span> <span class="o">+</span> <span class="n">tail</span><span class="p">);</span>
<a name="c0-1628"></a><span class="lineno">1628</span>      <span class="n">count</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1629"></a><span class="lineno">1629</span>    <span class="p">}</span>
<a name="c0-1630"></a><span class="lineno">1630</span> 
<a name="c0-1631"></a><span class="lineno">1631</span>    <span class="cm">/* We do not compute delta to *create* objects we are not</span>
<a name="c0-1632"></a><span class="lineno">1632</span> <span class="cm">     * going to pack.</span>
<a name="c0-1633"></a><span class="lineno">1633</span> <span class="cm">     */</span>
<a name="c0-1634"></a><span class="lineno">1634</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span>
<a name="c0-1635"></a><span class="lineno">1635</span>      <span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
<a name="c0-1636"></a><span class="lineno">1636</span> 
<a name="c0-1637"></a><span class="lineno">1637</span>    <span class="cm">/*</span>
<a name="c0-1638"></a><span class="lineno">1638</span> <span class="cm">     * If the current object is at pack edge, take the depth the</span>
<a name="c0-1639"></a><span class="lineno">1639</span> <span class="cm">     * objects that depend on the current object into account</span>
<a name="c0-1640"></a><span class="lineno">1640</span> <span class="cm">     * otherwise they would become too deep.</span>
<a name="c0-1641"></a><span class="lineno">1641</span> <span class="cm">     */</span>
<a name="c0-1642"></a><span class="lineno">1642</span>    <span class="n">max_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
<a name="c0-1643"></a><span class="lineno">1643</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_child</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1644"></a><span class="lineno">1644</span>      <span class="n">max_depth</span> <span class="o">-=</span> <span class="n">check_delta_limit</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1645"></a><span class="lineno">1645</span>      <span class="k">if</span> <span class="p">(</span><span class="n">max_depth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1646"></a><span class="lineno">1646</span>        <span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
<a name="c0-1647"></a><span class="lineno">1647</span>    <span class="p">}</span>
<a name="c0-1648"></a><span class="lineno">1648</span> 
<a name="c0-1649"></a><span class="lineno">1649</span>    <span class="n">j</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1650"></a><span class="lineno">1650</span>    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1651"></a><span class="lineno">1651</span>      <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c0-1652"></a><span class="lineno">1652</span>      <span class="kt">uint32_t</span> <span class="n">other_idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
<a name="c0-1653"></a><span class="lineno">1653</span>      <span class="k">struct</span> <span class="n">unpacked</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
<a name="c0-1654"></a><span class="lineno">1654</span>      <span class="k">if</span> <span class="p">(</span><span class="n">other_idx</span> <span class="o">&gt;=</span> <span class="n">window</span><span class="p">)</span>
<a name="c0-1655"></a><span class="lineno">1655</span>        <span class="n">other_idx</span> <span class="o">-=</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1656"></a><span class="lineno">1656</span>      <span class="n">m</span> <span class="o">=</span> <span class="n">array</span> <span class="o">+</span> <span class="n">other_idx</span><span class="p">;</span>
<a name="c0-1657"></a><span class="lineno">1657</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">)</span>
<a name="c0-1658"></a><span class="lineno">1658</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-1659"></a><span class="lineno">1659</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">try_delta</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_usage</span><span class="p">);</span>
<a name="c0-1660"></a><span class="lineno">1660</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1661"></a><span class="lineno">1661</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-1662"></a><span class="lineno">1662</span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1663"></a><span class="lineno">1663</span>        <span class="n">best_base</span> <span class="o">=</span> <span class="n">other_idx</span><span class="p">;</span>
<a name="c0-1664"></a><span class="lineno">1664</span>    <span class="p">}</span>
<a name="c0-1665"></a><span class="lineno">1665</span> 
<a name="c0-1666"></a><span class="lineno">1666</span>    <span class="cm">/*</span>
<a name="c0-1667"></a><span class="lineno">1667</span> <span class="cm">     * If we decided to cache the delta data, then it is best</span>
<a name="c0-1668"></a><span class="lineno">1668</span> <span class="cm">     * to compress it right away.  First because we have to do</span>
<a name="c0-1669"></a><span class="lineno">1669</span> <span class="cm">     * it anyway, and doing it here while we're threaded will</span>
<a name="c0-1670"></a><span class="lineno">1670</span> <span class="cm">     * save a lot of time in the non threaded write phase,</span>
<a name="c0-1671"></a><span class="lineno">1671</span> <span class="cm">     * as well as allow for caching more deltas within</span>
<a name="c0-1672"></a><span class="lineno">1672</span> <span class="cm">     * the same cache size limit.</span>
<a name="c0-1673"></a><span class="lineno">1673</span> <span class="cm">     * ...</span>
<a name="c0-1674"></a><span class="lineno">1674</span> <span class="cm">     * But only if not writing to stdout, since in that case</span>
<a name="c0-1675"></a><span class="lineno">1675</span> <span class="cm">     * the network is most likely throttling writes anyway,</span>
<a name="c0-1676"></a><span class="lineno">1676</span> <span class="cm">     * and therefore it is best to go to the write phase ASAP</span>
<a name="c0-1677"></a><span class="lineno">1677</span> <span class="cm">     * instead, as we can afford spending more time compressing</span>
<a name="c0-1678"></a><span class="lineno">1678</span> <span class="cm">     * between writes at that moment.</span>
<a name="c0-1679"></a><span class="lineno">1679</span> <span class="cm">     */</span>
<a name="c0-1680"></a><span class="lineno">1680</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pack_to_stdout</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1681"></a><span class="lineno">1681</span>      <span class="n">entry</span><span class="o">-&gt;</span><span class="n">z_delta_size</span> <span class="o">=</span> <span class="n">do_compress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_data</span><span class="p">,</span>
<a name="c0-1682"></a><span class="lineno">1682</span>                <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">);</span>
<a name="c0-1683"></a><span class="lineno">1683</span>      <span class="n">cache_lock</span><span class="p">();</span>
<a name="c0-1684"></a><span class="lineno">1684</span>      <span class="n">delta_cache_size</span> <span class="o">-=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta_size</span><span class="p">;</span>
<a name="c0-1685"></a><span class="lineno">1685</span>      <span class="n">delta_cache_size</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">z_delta_size</span><span class="p">;</span>
<a name="c0-1686"></a><span class="lineno">1686</span>      <span class="n">cache_unlock</span><span class="p">();</span>
<a name="c0-1687"></a><span class="lineno">1687</span>    <span class="p">}</span>
<a name="c0-1688"></a><span class="lineno">1688</span> 
<a name="c0-1689"></a><span class="lineno">1689</span>    <span class="cm">/* if we made n a delta, and if n is already at max</span>
<a name="c0-1690"></a><span class="lineno">1690</span> <span class="cm">     * depth, leaving it in the window is pointless.  we</span>
<a name="c0-1691"></a><span class="lineno">1691</span> <span class="cm">     * should evict it first.</span>
<a name="c0-1692"></a><span class="lineno">1692</span> <span class="cm">     */</span>
<a name="c0-1693"></a><span class="lineno">1693</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span> <span class="o">&amp;&amp;</span> <span class="n">max_depth</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span>
<a name="c0-1694"></a><span class="lineno">1694</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1695"></a><span class="lineno">1695</span> 
<a name="c0-1696"></a><span class="lineno">1696</span>    <span class="cm">/*</span>
<a name="c0-1697"></a><span class="lineno">1697</span> <span class="cm">     * Move the best delta base up in the window, after the</span>
<a name="c0-1698"></a><span class="lineno">1698</span> <span class="cm">     * currently deltified object, to keep it longer.  It will</span>
<a name="c0-1699"></a><span class="lineno">1699</span> <span class="cm">     * be the first base object to be attempted next.</span>
<a name="c0-1700"></a><span class="lineno">1700</span> <span class="cm">     */</span>
<a name="c0-1701"></a><span class="lineno">1701</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1702"></a><span class="lineno">1702</span>      <span class="k">struct</span> <span class="n">unpacked</span> <span class="n">swap</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">best_base</span><span class="p">];</span>
<a name="c0-1703"></a><span class="lineno">1703</span>      <span class="kt">int</span> <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">best_base</span><span class="p">)</span> <span class="o">%</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1704"></a><span class="lineno">1704</span>      <span class="kt">int</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">best_base</span><span class="p">;</span>
<a name="c0-1705"></a><span class="lineno">1705</span>      <span class="k">while</span> <span class="p">(</span><span class="n">dist</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1706"></a><span class="lineno">1706</span>        <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1707"></a><span class="lineno">1707</span>        <span class="n">array</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">src</span><span class="p">];</span>
<a name="c0-1708"></a><span class="lineno">1708</span>        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
<a name="c0-1709"></a><span class="lineno">1709</span>      <span class="p">}</span>
<a name="c0-1710"></a><span class="lineno">1710</span>      <span class="n">array</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">swap</span><span class="p">;</span>
<a name="c0-1711"></a><span class="lineno">1711</span>    <span class="p">}</span>
<a name="c0-1712"></a><span class="lineno">1712</span> 
<a name="c0-1713"></a><span class="lineno">1713</span>    <span class="nl">next:</span>
<a name="c0-1714"></a><span class="lineno">1714</span>    <span class="n">idx</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1715"></a><span class="lineno">1715</span>    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">)</span>
<a name="c0-1716"></a><span class="lineno">1716</span>      <span class="n">count</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1717"></a><span class="lineno">1717</span>    <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">window</span><span class="p">)</span>
<a name="c0-1718"></a><span class="lineno">1718</span>      <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1719"></a><span class="lineno">1719</span>  <span class="p">}</span>
<a name="c0-1720"></a><span class="lineno">1720</span> 
<a name="c0-1721"></a><span class="lineno">1721</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1722"></a><span class="lineno">1722</span>    <span class="n">free_delta_index</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
<a name="c0-1723"></a><span class="lineno">1723</span>    <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<a name="c0-1724"></a><span class="lineno">1724</span>  <span class="p">}</span>
<a name="c0-1725"></a><span class="lineno">1725</span>  <span class="n">free</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
<a name="c0-1726"></a><span class="lineno">1726</span> <span class="p">}</span>
<a name="c0-1727"></a><span class="lineno">1727</span> 
<a name="c0-1728"></a><span class="lineno">1728</span> <span class="cp">#ifndef NO_PTHREADS</span>
<a name="c0-1729"></a><span class="lineno">1729</span> 
<a name="c0-1730"></a><span class="lineno">1730</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">try_to_free_from_threads</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<a name="c0-1731"></a><span class="lineno">1731</span> <span class="p">{</span>
<a name="c0-1732"></a><span class="lineno">1732</span>  <span class="n">read_lock</span><span class="p">();</span>
<a name="c0-1733"></a><span class="lineno">1733</span>  <span class="n">release_pack_memory</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-1734"></a><span class="lineno">1734</span>  <span class="n">read_unlock</span><span class="p">();</span>
<a name="c0-1735"></a><span class="lineno">1735</span> <span class="p">}</span>
<a name="c0-1736"></a><span class="lineno">1736</span> 
<a name="c0-1737"></a><span class="lineno">1737</span> <span class="k">static</span> <span class="n">try_to_free_t</span> <span class="n">old_try_to_free_routine</span><span class="p">;</span>
<a name="c0-1738"></a><span class="lineno">1738</span> 
<a name="c0-1739"></a><span class="lineno">1739</span> <span class="cm">/*</span>
<a name="c0-1740"></a><span class="lineno">1740</span> <span class="cm"> * The main thread waits on the condition that (at least) one of the workers</span>
<a name="c0-1741"></a><span class="lineno">1741</span> <span class="cm"> * has stopped working (which is indicated in the .working member of</span>
<a name="c0-1742"></a><span class="lineno">1742</span> <span class="cm"> * struct thread_params).</span>
<a name="c0-1743"></a><span class="lineno">1743</span> <span class="cm"> * When a work thread has completed its work, it sets .working to 0 and</span>
<a name="c0-1744"></a><span class="lineno">1744</span> <span class="cm"> * signals the main thread and waits on the condition that .data_ready</span>
<a name="c0-1745"></a><span class="lineno">1745</span> <span class="cm"> * becomes 1.</span>
<a name="c0-1746"></a><span class="lineno">1746</span> <span class="cm"> */</span>
<a name="c0-1747"></a><span class="lineno">1747</span> 
<a name="c0-1748"></a><span class="lineno">1748</span> <span class="k">struct</span> <span class="n">thread_params</span> <span class="p">{</span>
<a name="c0-1749"></a><span class="lineno">1749</span>  <span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">;</span>
<a name="c0-1750"></a><span class="lineno">1750</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">list</span><span class="p">;</span>
<a name="c0-1751"></a><span class="lineno">1751</span>  <span class="kt">unsigned</span> <span class="n">list_size</span><span class="p">;</span>
<a name="c0-1752"></a><span class="lineno">1752</span>  <span class="kt">unsigned</span> <span class="n">remaining</span><span class="p">;</span>
<a name="c0-1753"></a><span class="lineno">1753</span>  <span class="kt">int</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1754"></a><span class="lineno">1754</span>  <span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
<a name="c0-1755"></a><span class="lineno">1755</span>  <span class="kt">int</span> <span class="n">working</span><span class="p">;</span>
<a name="c0-1756"></a><span class="lineno">1756</span>  <span class="kt">int</span> <span class="n">data_ready</span><span class="p">;</span>
<a name="c0-1757"></a><span class="lineno">1757</span>  <span class="n">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<a name="c0-1758"></a><span class="lineno">1758</span>  <span class="n">pthread_cond_t</span> <span class="n">cond</span><span class="p">;</span>
<a name="c0-1759"></a><span class="lineno">1759</span>  <span class="kt">unsigned</span> <span class="o">*</span><span class="n">processed</span><span class="p">;</span>
<a name="c0-1760"></a><span class="lineno">1760</span> <span class="p">};</span>
<a name="c0-1761"></a><span class="lineno">1761</span> 
<a name="c0-1762"></a><span class="lineno">1762</span> <span class="k">static</span> <span class="n">pthread_cond_t</span> <span class="n">progress_cond</span><span class="p">;</span>
<a name="c0-1763"></a><span class="lineno">1763</span> 
<a name="c0-1764"></a><span class="lineno">1764</span> <span class="cm">/*</span>
<a name="c0-1765"></a><span class="lineno">1765</span> <span class="cm"> * Mutex and conditional variable can't be statically-initialized on Windows.</span>
<a name="c0-1766"></a><span class="lineno">1766</span> <span class="cm"> */</span>
<a name="c0-1767"></a><span class="lineno">1767</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">init_threaded_search</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-1768"></a><span class="lineno">1768</span> <span class="p">{</span>
<a name="c0-1769"></a><span class="lineno">1769</span>  <span class="n">init_recursive_mutex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_mutex</span><span class="p">);</span>
<a name="c0-1770"></a><span class="lineno">1770</span>  <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1771"></a><span class="lineno">1771</span>  <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1772"></a><span class="lineno">1772</span>  <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_cond</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1773"></a><span class="lineno">1773</span>  <span class="n">old_try_to_free_routine</span> <span class="o">=</span> <span class="n">set_try_to_free_routine</span><span class="p">(</span><span class="n">try_to_free_from_threads</span><span class="p">);</span>
<a name="c0-1774"></a><span class="lineno">1774</span> <span class="p">}</span>
<a name="c0-1775"></a><span class="lineno">1775</span> 
<a name="c0-1776"></a><span class="lineno">1776</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_threaded_search</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-1777"></a><span class="lineno">1777</span> <span class="p">{</span>
<a name="c0-1778"></a><span class="lineno">1778</span>  <span class="n">set_try_to_free_routine</span><span class="p">(</span><span class="n">old_try_to_free_routine</span><span class="p">);</span>
<a name="c0-1779"></a><span class="lineno">1779</span>  <span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_cond</span><span class="p">);</span>
<a name="c0-1780"></a><span class="lineno">1780</span>  <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_mutex</span><span class="p">);</span>
<a name="c0-1781"></a><span class="lineno">1781</span>  <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache_mutex</span><span class="p">);</span>
<a name="c0-1782"></a><span class="lineno">1782</span>  <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_mutex</span><span class="p">);</span>
<a name="c0-1783"></a><span class="lineno">1783</span> <span class="p">}</span>
<a name="c0-1784"></a><span class="lineno">1784</span> 
<a name="c0-1785"></a><span class="lineno">1785</span> <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">threaded_find_deltas</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<a name="c0-1786"></a><span class="lineno">1786</span> <span class="p">{</span>
<a name="c0-1787"></a><span class="lineno">1787</span>  <span class="k">struct</span> <span class="n">thread_params</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
<a name="c0-1788"></a><span class="lineno">1788</span> 
<a name="c0-1789"></a><span class="lineno">1789</span>  <span class="k">while</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1790"></a><span class="lineno">1790</span>    <span class="n">find_deltas</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">remaining</span><span class="p">,</span>
<a name="c0-1791"></a><span class="lineno">1791</span>          <span class="n">me</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">processed</span><span class="p">);</span>
<a name="c0-1792"></a><span class="lineno">1792</span> 
<a name="c0-1793"></a><span class="lineno">1793</span>    <span class="n">progress_lock</span><span class="p">();</span>
<a name="c0-1794"></a><span class="lineno">1794</span>    <span class="n">me</span><span class="o">-&gt;</span><span class="n">working</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1795"></a><span class="lineno">1795</span>    <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_cond</span><span class="p">);</span>
<a name="c0-1796"></a><span class="lineno">1796</span>    <span class="n">progress_unlock</span><span class="p">();</span>
<a name="c0-1797"></a><span class="lineno">1797</span> 
<a name="c0-1798"></a><span class="lineno">1798</span>    <span class="cm">/*</span>
<a name="c0-1799"></a><span class="lineno">1799</span> <span class="cm">     * We must not set -&gt;data_ready before we wait on the</span>
<a name="c0-1800"></a><span class="lineno">1800</span> <span class="cm">     * condition because the main thread may have set it to 1</span>
<a name="c0-1801"></a><span class="lineno">1801</span> <span class="cm">     * before we get here. In order to be sure that new</span>
<a name="c0-1802"></a><span class="lineno">1802</span> <span class="cm">     * work is available if we see 1 in -&gt;data_ready, it</span>
<a name="c0-1803"></a><span class="lineno">1803</span> <span class="cm">     * was initialized to 0 before this thread was spawned</span>
<a name="c0-1804"></a><span class="lineno">1804</span> <span class="cm">     * and we reset it to 0 right away.</span>
<a name="c0-1805"></a><span class="lineno">1805</span> <span class="cm">     */</span>
<a name="c0-1806"></a><span class="lineno">1806</span>    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a name="c0-1807"></a><span class="lineno">1807</span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">data_ready</span><span class="p">)</span>
<a name="c0-1808"></a><span class="lineno">1808</span>      <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a name="c0-1809"></a><span class="lineno">1809</span>    <span class="n">me</span><span class="o">-&gt;</span><span class="n">data_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1810"></a><span class="lineno">1810</span>    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a name="c0-1811"></a><span class="lineno">1811</span>  <span class="p">}</span>
<a name="c0-1812"></a><span class="lineno">1812</span>  <span class="cm">/* leave -&gt;working 1 so that this doesn't get more work assigned */</span>
<a name="c0-1813"></a><span class="lineno">1813</span>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1814"></a><span class="lineno">1814</span> <span class="p">}</span>
<a name="c0-1815"></a><span class="lineno">1815</span> 
<a name="c0-1816"></a><span class="lineno">1816</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">ll_find_deltas</span><span class="p">(</span><span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">list_size</span><span class="p">,</span>
<a name="c0-1817"></a><span class="lineno">1817</span>         <span class="kt">int</span> <span class="n">window</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">processed</span><span class="p">)</span>
<a name="c0-1818"></a><span class="lineno">1818</span> <span class="p">{</span>
<a name="c0-1819"></a><span class="lineno">1819</span>  <span class="k">struct</span> <span class="n">thread_params</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-1820"></a><span class="lineno">1820</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">active_threads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1821"></a><span class="lineno">1821</span> 
<a name="c0-1822"></a><span class="lineno">1822</span>  <span class="n">init_threaded_search</span><span class="p">();</span>
<a name="c0-1823"></a><span class="lineno">1823</span> 
<a name="c0-1824"></a><span class="lineno">1824</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delta_search_threads</span><span class="p">)</span> <span class="cm">/* --threads=0 means autodetect */</span>
<a name="c0-1825"></a><span class="lineno">1825</span>    <span class="n">delta_search_threads</span> <span class="o">=</span> <span class="n">online_cpus</span><span class="p">();</span>
<a name="c0-1826"></a><span class="lineno">1826</span>  <span class="k">if</span> <span class="p">(</span><span class="n">delta_search_threads</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1827"></a><span class="lineno">1827</span>    <span class="n">find_deltas</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_size</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">processed</span><span class="p">);</span>
<a name="c0-1828"></a><span class="lineno">1828</span>    <span class="n">cleanup_threaded_search</span><span class="p">();</span>
<a name="c0-1829"></a><span class="lineno">1829</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1830"></a><span class="lineno">1830</span>  <span class="p">}</span>
<a name="c0-1831"></a><span class="lineno">1831</span>  <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&gt;</span> <span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-1832"></a><span class="lineno">1832</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Delta compression using up to %d threads.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-1833"></a><span class="lineno">1833</span>        <span class="n">delta_search_threads</span><span class="p">);</span>
<a name="c0-1834"></a><span class="lineno">1834</span>  <span class="n">p</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="n">delta_search_threads</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">));</span>
<a name="c0-1835"></a><span class="lineno">1835</span> 
<a name="c0-1836"></a><span class="lineno">1836</span>  <span class="cm">/* Partition the work amongst work threads. */</span>
<a name="c0-1837"></a><span class="lineno">1837</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delta_search_threads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1838"></a><span class="lineno">1838</span>    <span class="kt">unsigned</span> <span class="n">sub_size</span> <span class="o">=</span> <span class="n">list_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta_search_threads</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
<a name="c0-1839"></a><span class="lineno">1839</span> 
<a name="c0-1840"></a><span class="lineno">1840</span>    <span class="cm">/* don't use too small segments or no deltas will be found */</span>
<a name="c0-1841"></a><span class="lineno">1841</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sub_size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">window</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">delta_search_threads</span><span class="p">)</span>
<a name="c0-1842"></a><span class="lineno">1842</span>      <span class="n">sub_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1843"></a><span class="lineno">1843</span> 
<a name="c0-1844"></a><span class="lineno">1844</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
<a name="c0-1845"></a><span class="lineno">1845</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
<a name="c0-1846"></a><span class="lineno">1846</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">processed</span> <span class="o">=</span> <span class="n">processed</span><span class="p">;</span>
<a name="c0-1847"></a><span class="lineno">1847</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">working</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1848"></a><span class="lineno">1848</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1849"></a><span class="lineno">1849</span> 
<a name="c0-1850"></a><span class="lineno">1850</span>    <span class="cm">/* try to split chunks on "path" boundaries */</span>
<a name="c0-1851"></a><span class="lineno">1851</span>    <span class="k">while</span> <span class="p">(</span><span class="n">sub_size</span> <span class="o">&amp;&amp;</span> <span class="n">sub_size</span> <span class="o">&lt;</span> <span class="n">list_size</span> <span class="o">&amp;&amp;</span>
<a name="c0-1852"></a><span class="lineno">1852</span>           <span class="n">list</span><span class="p">[</span><span class="n">sub_size</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&amp;&amp;</span>
<a name="c0-1853"></a><span class="lineno">1853</span>           <span class="n">list</span><span class="p">[</span><span class="n">sub_size</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">==</span> <span class="n">list</span><span class="p">[</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span>
<a name="c0-1854"></a><span class="lineno">1854</span>      <span class="n">sub_size</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1855"></a><span class="lineno">1855</span> 
<a name="c0-1856"></a><span class="lineno">1856</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
<a name="c0-1857"></a><span class="lineno">1857</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list_size</span> <span class="o">=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1858"></a><span class="lineno">1858</span>    <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1859"></a><span class="lineno">1859</span> 
<a name="c0-1860"></a><span class="lineno">1860</span>    <span class="n">list</span> <span class="o">+=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1861"></a><span class="lineno">1861</span>    <span class="n">list_size</span> <span class="o">-=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1862"></a><span class="lineno">1862</span>  <span class="p">}</span>
<a name="c0-1863"></a><span class="lineno">1863</span> 
<a name="c0-1864"></a><span class="lineno">1864</span>  <span class="cm">/* Start work threads. */</span>
<a name="c0-1865"></a><span class="lineno">1865</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delta_search_threads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1866"></a><span class="lineno">1866</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list_size</span><span class="p">)</span>
<a name="c0-1867"></a><span class="lineno">1867</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1868"></a><span class="lineno">1868</span>    <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1869"></a><span class="lineno">1869</span>    <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cond</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1870"></a><span class="lineno">1870</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
<a name="c0-1871"></a><span class="lineno">1871</span>             <span class="n">threaded_find_deltas</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-1872"></a><span class="lineno">1872</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<a name="c0-1873"></a><span class="lineno">1873</span>      <span class="n">die</span><span class="p">(</span><span class="s">"unable to create thread: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
<a name="c0-1874"></a><span class="lineno">1874</span>    <span class="n">active_threads</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1875"></a><span class="lineno">1875</span>  <span class="p">}</span>
<a name="c0-1876"></a><span class="lineno">1876</span> 
<a name="c0-1877"></a><span class="lineno">1877</span>  <span class="cm">/*</span>
<a name="c0-1878"></a><span class="lineno">1878</span> <span class="cm">   * Now let's wait for work completion.  Each time a thread is done</span>
<a name="c0-1879"></a><span class="lineno">1879</span> <span class="cm">   * with its work, we steal half of the remaining work from the</span>
<a name="c0-1880"></a><span class="lineno">1880</span> <span class="cm">   * thread with the largest number of unprocessed objects and give</span>
<a name="c0-1881"></a><span class="lineno">1881</span> <span class="cm">   * it to that newly idle thread.  This ensure good load balancing</span>
<a name="c0-1882"></a><span class="lineno">1882</span> <span class="cm">   * until the remaining object list segments are simply too short</span>
<a name="c0-1883"></a><span class="lineno">1883</span> <span class="cm">   * to be worth splitting anymore.</span>
<a name="c0-1884"></a><span class="lineno">1884</span> <span class="cm">   */</span>
<a name="c0-1885"></a><span class="lineno">1885</span>  <span class="k">while</span> <span class="p">(</span><span class="n">active_threads</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1886"></a><span class="lineno">1886</span>    <span class="k">struct</span> <span class="n">thread_params</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1887"></a><span class="lineno">1887</span>    <span class="k">struct</span> <span class="n">thread_params</span> <span class="o">*</span><span class="n">victim</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1888"></a><span class="lineno">1888</span>    <span class="kt">unsigned</span> <span class="n">sub_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1889"></a><span class="lineno">1889</span> 
<a name="c0-1890"></a><span class="lineno">1890</span>    <span class="n">progress_lock</span><span class="p">();</span>
<a name="c0-1891"></a><span class="lineno">1891</span>    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-1892"></a><span class="lineno">1892</span>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delta_search_threads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1893"></a><span class="lineno">1893</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">working</span><span class="p">)</span>
<a name="c0-1894"></a><span class="lineno">1894</span>          <span class="n">target</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-1895"></a><span class="lineno">1895</span>      <span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
<a name="c0-1896"></a><span class="lineno">1896</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-1897"></a><span class="lineno">1897</span>      <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">progress_mutex</span><span class="p">);</span>
<a name="c0-1898"></a><span class="lineno">1898</span>    <span class="p">}</span>
<a name="c0-1899"></a><span class="lineno">1899</span> 
<a name="c0-1900"></a><span class="lineno">1900</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delta_search_threads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1901"></a><span class="lineno">1901</span>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">window</span> <span class="o">&amp;&amp;</span>
<a name="c0-1902"></a><span class="lineno">1902</span>          <span class="p">(</span><span class="o">!</span><span class="n">victim</span> <span class="o">||</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">remaining</span><span class="p">))</span>
<a name="c0-1903"></a><span class="lineno">1903</span>        <span class="n">victim</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-1904"></a><span class="lineno">1904</span>    <span class="k">if</span> <span class="p">(</span><span class="n">victim</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1905"></a><span class="lineno">1905</span>      <span class="n">sub_size</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">remaining</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1906"></a><span class="lineno">1906</span>      <span class="n">list</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">+</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">list_size</span> <span class="o">-</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1907"></a><span class="lineno">1907</span>      <span class="k">while</span> <span class="p">(</span><span class="n">sub_size</span> <span class="o">&amp;&amp;</span> <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">&amp;&amp;</span>
<a name="c0-1908"></a><span class="lineno">1908</span>             <span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hash</span> <span class="o">==</span> <span class="n">list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1909"></a><span class="lineno">1909</span>        <span class="n">list</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1910"></a><span class="lineno">1910</span>        <span class="n">sub_size</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1911"></a><span class="lineno">1911</span>      <span class="p">}</span>
<a name="c0-1912"></a><span class="lineno">1912</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sub_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1913"></a><span class="lineno">1913</span>        <span class="cm">/*</span>
<a name="c0-1914"></a><span class="lineno">1914</span> <span class="cm">         * It is possible for some "paths" to have</span>
<a name="c0-1915"></a><span class="lineno">1915</span> <span class="cm">         * so many objects that no hash boundary</span>
<a name="c0-1916"></a><span class="lineno">1916</span> <span class="cm">         * might be found.  Let's just steal the</span>
<a name="c0-1917"></a><span class="lineno">1917</span> <span class="cm">         * exact half in that case.</span>
<a name="c0-1918"></a><span class="lineno">1918</span> <span class="cm">         */</span>
<a name="c0-1919"></a><span class="lineno">1919</span>        <span class="n">sub_size</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">remaining</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1920"></a><span class="lineno">1920</span>        <span class="n">list</span> <span class="o">-=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1921"></a><span class="lineno">1921</span>      <span class="p">}</span>
<a name="c0-1922"></a><span class="lineno">1922</span>      <span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
<a name="c0-1923"></a><span class="lineno">1923</span>      <span class="n">victim</span><span class="o">-&gt;</span><span class="n">list_size</span> <span class="o">-=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1924"></a><span class="lineno">1924</span>      <span class="n">victim</span><span class="o">-&gt;</span><span class="n">remaining</span> <span class="o">-=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1925"></a><span class="lineno">1925</span>    <span class="p">}</span>
<a name="c0-1926"></a><span class="lineno">1926</span>    <span class="n">target</span><span class="o">-&gt;</span><span class="n">list_size</span> <span class="o">=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1927"></a><span class="lineno">1927</span>    <span class="n">target</span><span class="o">-&gt;</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">sub_size</span><span class="p">;</span>
<a name="c0-1928"></a><span class="lineno">1928</span>    <span class="n">target</span><span class="o">-&gt;</span><span class="n">working</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1929"></a><span class="lineno">1929</span>    <span class="n">progress_unlock</span><span class="p">();</span>
<a name="c0-1930"></a><span class="lineno">1930</span> 
<a name="c0-1931"></a><span class="lineno">1931</span>    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a name="c0-1932"></a><span class="lineno">1932</span>    <span class="n">target</span><span class="o">-&gt;</span><span class="n">data_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1933"></a><span class="lineno">1933</span>    <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">);</span>
<a name="c0-1934"></a><span class="lineno">1934</span>    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a name="c0-1935"></a><span class="lineno">1935</span> 
<a name="c0-1936"></a><span class="lineno">1936</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sub_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1937"></a><span class="lineno">1937</span>      <span class="n">pthread_join</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1938"></a><span class="lineno">1938</span>      <span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cond</span><span class="p">);</span>
<a name="c0-1939"></a><span class="lineno">1939</span>      <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<a name="c0-1940"></a><span class="lineno">1940</span>      <span class="n">active_threads</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1941"></a><span class="lineno">1941</span>    <span class="p">}</span>
<a name="c0-1942"></a><span class="lineno">1942</span>  <span class="p">}</span>
<a name="c0-1943"></a><span class="lineno">1943</span>  <span class="n">cleanup_threaded_search</span><span class="p">();</span>
<a name="c0-1944"></a><span class="lineno">1944</span>  <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c0-1945"></a><span class="lineno">1945</span> <span class="p">}</span>
<a name="c0-1946"></a><span class="lineno">1946</span> 
<a name="c0-1947"></a><span class="lineno">1947</span> <span class="cp">#else</span>
<a name="c0-1948"></a><span class="lineno">1948</span> <span class="cp">#define ll_find_deltas(l, s, w, d, p) find_deltas(l, &amp;s, w, d, p)</span>
<a name="c0-1949"></a><span class="lineno">1949</span> <span class="cp">#endif</span>
<a name="c0-1950"></a><span class="lineno">1950</span> 
<a name="c0-1951"></a><span class="lineno">1951</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">add_ref_tag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<a name="c0-1952"></a><span class="lineno">1952</span> <span class="p">{</span>
<a name="c0-1953"></a><span class="lineno">1953</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">peeled</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-1954"></a><span class="lineno">1954</span> 
<a name="c0-1955"></a><span class="lineno">1955</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"refs/tags/"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="cm">/* is a tag? */</span>
<a name="c0-1956"></a><span class="lineno">1956</span>      <span class="o">!</span><span class="n">peel_ref</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">peeled</span><span class="p">)</span>        <span class="o">&amp;&amp;</span> <span class="cm">/* peelable? */</span>
<a name="c0-1957"></a><span class="lineno">1957</span>      <span class="o">!</span><span class="n">is_null_sha1</span><span class="p">(</span><span class="n">peeled</span><span class="p">)</span>          <span class="o">&amp;&amp;</span> <span class="cm">/* annotated tag? */</span>
<a name="c0-1958"></a><span class="lineno">1958</span>      <span class="n">locate_object_entry</span><span class="p">(</span><span class="n">peeled</span><span class="p">))</span>      <span class="cm">/* object packed? */</span>
<a name="c0-1959"></a><span class="lineno">1959</span>    <span class="n">add_object_entry</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">OBJ_TAG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1960"></a><span class="lineno">1960</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1961"></a><span class="lineno">1961</span> <span class="p">}</span>
<a name="c0-1962"></a><span class="lineno">1962</span> 
<a name="c0-1963"></a><span class="lineno">1963</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_pack</span><span class="p">(</span><span class="kt">int</span> <span class="n">window</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
<a name="c0-1964"></a><span class="lineno">1964</span> <span class="p">{</span>
<a name="c0-1965"></a><span class="lineno">1965</span>  <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">**</span><span class="n">delta_list</span><span class="p">;</span>
<a name="c0-1966"></a><span class="lineno">1966</span>  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_deltas</span><span class="p">;</span>
<a name="c0-1967"></a><span class="lineno">1967</span>  <span class="kt">unsigned</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-1968"></a><span class="lineno">1968</span> 
<a name="c0-1969"></a><span class="lineno">1969</span>  <span class="n">get_object_details</span><span class="p">();</span>
<a name="c0-1970"></a><span class="lineno">1970</span> 
<a name="c0-1971"></a><span class="lineno">1971</span>  <span class="cm">/*</span>
<a name="c0-1972"></a><span class="lineno">1972</span> <span class="cm">   * If we're locally repacking then we need to be doubly careful</span>
<a name="c0-1973"></a><span class="lineno">1973</span> <span class="cm">   * from now on in order to make sure no stealth corruption gets</span>
<a name="c0-1974"></a><span class="lineno">1974</span> <span class="cm">   * propagated to the new pack.  Clients receiving streamed packs</span>
<a name="c0-1975"></a><span class="lineno">1975</span> <span class="cm">   * should validate everything they get anyway so no need to incur</span>
<a name="c0-1976"></a><span class="lineno">1976</span> <span class="cm">   * the additional cost here in that case.</span>
<a name="c0-1977"></a><span class="lineno">1977</span> <span class="cm">   */</span>
<a name="c0-1978"></a><span class="lineno">1978</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-1979"></a><span class="lineno">1979</span>    <span class="n">do_check_packed_object_crc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1980"></a><span class="lineno">1980</span> 
<a name="c0-1981"></a><span class="lineno">1981</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_objects</span> <span class="o">||</span> <span class="o">!</span><span class="n">window</span> <span class="o">||</span> <span class="o">!</span><span class="n">depth</span><span class="p">)</span>
<a name="c0-1982"></a><span class="lineno">1982</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1983"></a><span class="lineno">1983</span> 
<a name="c0-1984"></a><span class="lineno">1984</span>  <span class="n">delta_list</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">nr_objects</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">delta_list</span><span class="p">));</span>
<a name="c0-1985"></a><span class="lineno">1985</span>  <span class="n">nr_deltas</span> <span class="o">=</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1986"></a><span class="lineno">1986</span> 
<a name="c0-1987"></a><span class="lineno">1987</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1988"></a><span class="lineno">1988</span>    <span class="k">struct</span> <span class="n">object_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">objects</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1989"></a><span class="lineno">1989</span> 
<a name="c0-1990"></a><span class="lineno">1990</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">delta</span><span class="p">)</span>
<a name="c0-1991"></a><span class="lineno">1991</span>      <span class="cm">/* This happens if we decided to reuse existing</span>
<a name="c0-1992"></a><span class="lineno">1992</span> <span class="cm">       * delta from a pack.  "reuse_delta &amp;&amp;" is implied.</span>
<a name="c0-1993"></a><span class="lineno">1993</span> <span class="cm">       */</span>
<a name="c0-1994"></a><span class="lineno">1994</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1995"></a><span class="lineno">1995</span> 
<a name="c0-1996"></a><span class="lineno">1996</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
<a name="c0-1997"></a><span class="lineno">1997</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1998"></a><span class="lineno">1998</span> 
<a name="c0-1999"></a><span class="lineno">1999</span>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">no_try_delta</span><span class="p">)</span>
<a name="c0-2000"></a><span class="lineno">2000</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2001"></a><span class="lineno">2001</span> 
<a name="c0-2002"></a><span class="lineno">2002</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">preferred_base</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2003"></a><span class="lineno">2003</span>      <span class="n">nr_deltas</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2004"></a><span class="lineno">2004</span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2005"></a><span class="lineno">2005</span>        <span class="n">die</span><span class="p">(</span><span class="s">"unable to get type of object %s"</span><span class="p">,</span>
<a name="c0-2006"></a><span class="lineno">2006</span>            <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-2007"></a><span class="lineno">2007</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2008"></a><span class="lineno">2008</span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2009"></a><span class="lineno">2009</span>        <span class="cm">/*</span>
<a name="c0-2010"></a><span class="lineno">2010</span> <span class="cm">         * This object is not found, but we</span>
<a name="c0-2011"></a><span class="lineno">2011</span> <span class="cm">         * don't have to include it anyway.</span>
<a name="c0-2012"></a><span class="lineno">2012</span> <span class="cm">         */</span>
<a name="c0-2013"></a><span class="lineno">2013</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c0-2014"></a><span class="lineno">2014</span>      <span class="p">}</span>
<a name="c0-2015"></a><span class="lineno">2015</span>    <span class="p">}</span>
<a name="c0-2016"></a><span class="lineno">2016</span> 
<a name="c0-2017"></a><span class="lineno">2017</span>    <span class="n">delta_list</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<a name="c0-2018"></a><span class="lineno">2018</span>  <span class="p">}</span>
<a name="c0-2019"></a><span class="lineno">2019</span> 
<a name="c0-2020"></a><span class="lineno">2020</span>  <span class="k">if</span> <span class="p">(</span><span class="n">nr_deltas</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2021"></a><span class="lineno">2021</span>    <span class="kt">unsigned</span> <span class="n">nr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2022"></a><span class="lineno">2022</span>    <span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<a name="c0-2023"></a><span class="lineno">2023</span>      <span class="n">progress_state</span> <span class="o">=</span> <span class="n">start_progress</span><span class="p">(</span><span class="s">"Compressing objects"</span><span class="p">,</span>
<a name="c0-2024"></a><span class="lineno">2024</span>              <span class="n">nr_deltas</span><span class="p">);</span>
<a name="c0-2025"></a><span class="lineno">2025</span>    <span class="n">qsort</span><span class="p">(</span><span class="n">delta_list</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">delta_list</span><span class="p">),</span> <span class="n">type_size_sort</span><span class="p">);</span>
<a name="c0-2026"></a><span class="lineno">2026</span>    <span class="n">ll_find_deltas</span><span class="p">(</span><span class="n">delta_list</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr_done</span><span class="p">);</span>
<a name="c0-2027"></a><span class="lineno">2027</span>    <span class="n">stop_progress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_state</span><span class="p">);</span>
<a name="c0-2028"></a><span class="lineno">2028</span>    <span class="k">if</span> <span class="p">(</span><span class="n">nr_done</span> <span class="o">!=</span> <span class="n">nr_deltas</span><span class="p">)</span>
<a name="c0-2029"></a><span class="lineno">2029</span>      <span class="n">die</span><span class="p">(</span><span class="s">"inconsistency with delta count"</span><span class="p">);</span>
<a name="c0-2030"></a><span class="lineno">2030</span>  <span class="p">}</span>
<a name="c0-2031"></a><span class="lineno">2031</span>  <span class="n">free</span><span class="p">(</span><span class="n">delta_list</span><span class="p">);</span>
<a name="c0-2032"></a><span class="lineno">2032</span> <span class="p">}</span>
<a name="c0-2033"></a><span class="lineno">2033</span> 
<a name="c0-2034"></a><span class="lineno">2034</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_pack_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<a name="c0-2035"></a><span class="lineno">2035</span> <span class="p">{</span>
<a name="c0-2036"></a><span class="lineno">2036</span> <span class="hll"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.window"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-2037"></a><span class="lineno">2037</span> <span class="hll">    <span class="n">window</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><a name="c0-2038"></a><span class="lineno">2038</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c0-2039"></a><span class="lineno">2039</span> <span class="hll">  <span class="p">}</span>
</span><a name="c0-2040"></a><span class="lineno">2040</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.windowmemory"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-2041"></a><span class="lineno">2041</span> <span class="hll">    <span class="n">window_memory_limit</span> <span class="o">=</span> <span class="n">git_config_ulong</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><a name="c0-2042"></a><span class="lineno">2042</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c0-2043"></a><span class="lineno">2043</span> <span class="hll">  <span class="p">}</span>
</span><a name="c0-2044"></a><span class="lineno">2044</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.depth"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-2045"></a><span class="lineno">2045</span> <span class="hll">    <span class="n">depth</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><a name="c0-2046"></a><span class="lineno">2046</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c0-2047"></a><span class="lineno">2047</span> <span class="hll">  <span class="p">}</span>
</span><a name="c0-2048"></a><span class="lineno">2048</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.compression"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-2049"></a><span class="lineno">2049</span> <span class="hll">    <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><a name="c0-2050"></a><span class="lineno">2050</span> <span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><a name="c0-2051"></a><span class="lineno">2051</span>       <span class="n">level</span> <span class="o">=</span> <span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">;</span>
<a name="c0-2052"></a><span class="lineno">2052</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">Z_BEST_COMPRESSION</span><span class="p">)</span>
<a name="c0-2053"></a><span class="lineno">2053</span>      <span class="n">die</span><span class="p">(</span><span class="s">"bad pack compression level %d"</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<a name="c0-2054"></a><span class="lineno">2054</span>    <span class="n">pack_compression_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<a name="c0-2055"></a><span class="lineno">2055</span>    <span class="n">pack_compression_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2056"></a><span class="lineno">2056</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2057"></a><span class="lineno">2057</span>  <span class="p">}</span>
<a name="c0-2058"></a><span class="lineno">2058</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.deltacachesize"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2059"></a><span class="lineno">2059</span>    <span class="n">max_delta_cache_size</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<a name="c0-2060"></a><span class="lineno">2060</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2061"></a><span class="lineno">2061</span>  <span class="p">}</span>
<a name="c0-2062"></a><span class="lineno">2062</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.deltacachelimit"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2063"></a><span class="lineno">2063</span>    <span class="n">cache_max_small_delta_size</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<a name="c0-2064"></a><span class="lineno">2064</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2065"></a><span class="lineno">2065</span>  <span class="p">}</span>
<a name="c0-2066"></a><span class="lineno">2066</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.threads"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2067"></a><span class="lineno">2067</span>    <span class="n">delta_search_threads</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<a name="c0-2068"></a><span class="lineno">2068</span>    <span class="k">if</span> <span class="p">(</span><span class="n">delta_search_threads</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2069"></a><span class="lineno">2069</span>      <span class="n">die</span><span class="p">(</span><span class="s">"invalid number of threads specified (%d)"</span><span class="p">,</span>
<a name="c0-2070"></a><span class="lineno">2070</span>          <span class="n">delta_search_threads</span><span class="p">);</span>
<a name="c0-2071"></a><span class="lineno">2071</span> <span class="cp">#ifdef NO_PTHREADS</span>
<a name="c0-2072"></a><span class="lineno">2072</span>    <span class="k">if</span> <span class="p">(</span><span class="n">delta_search_threads</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-2073"></a><span class="lineno">2073</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"no threads support, ignoring %s"</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
<a name="c0-2074"></a><span class="lineno">2074</span> <span class="cp">#endif</span>
<a name="c0-2075"></a><span class="lineno">2075</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2076"></a><span class="lineno">2076</span>  <span class="p">}</span>
<a name="c0-2077"></a><span class="lineno">2077</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">"pack.indexversion"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2078"></a><span class="lineno">2078</span>    <span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<a name="c0-2079"></a><span class="lineno">2079</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<a name="c0-2080"></a><span class="lineno">2080</span>      <span class="n">die</span><span class="p">(</span><span class="s">"bad pack.indexversion=%"</span><span class="n">PRIu32</span><span class="p">,</span>
<a name="c0-2081"></a><span class="lineno">2081</span>          <span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
<a name="c0-2082"></a><span class="lineno">2082</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2083"></a><span class="lineno">2083</span>  <span class="p">}</span>
<a name="c0-2084"></a><span class="lineno">2084</span>  <span class="k">return</span> <span class="n">git_default_config</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<a name="c0-2085"></a><span class="lineno">2085</span> <span class="p">}</span>
<a name="c0-2086"></a><span class="lineno">2086</span> 
<a name="c0-2087"></a><span class="lineno">2087</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">read_object_list_from_stdin</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-2088"></a><span class="lineno">2088</span> <span class="p">{</span>
<a name="c0-2089"></a><span class="lineno">2089</span>  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">40</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">PATH_MAX</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
<a name="c0-2090"></a><span class="lineno">2090</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-2091"></a><span class="lineno">2091</span> 
<a name="c0-2092"></a><span class="lineno">2092</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-2093"></a><span class="lineno">2093</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2094"></a><span class="lineno">2094</span>      <span class="k">if</span> <span class="p">(</span><span class="n">feof</span><span class="p">(</span><span class="n">stdin</span><span class="p">))</span>
<a name="c0-2095"></a><span class="lineno">2095</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-2096"></a><span class="lineno">2096</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ferror</span><span class="p">(</span><span class="n">stdin</span><span class="p">))</span>
<a name="c0-2097"></a><span class="lineno">2097</span>        <span class="n">die</span><span class="p">(</span><span class="s">"fgets returned NULL, not EOF, not error!"</span><span class="p">);</span>
<a name="c0-2098"></a><span class="lineno">2098</span>      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EINTR</span><span class="p">)</span>
<a name="c0-2099"></a><span class="lineno">2099</span>        <span class="n">die_errno</span><span class="p">(</span><span class="s">"fgets"</span><span class="p">);</span>
<a name="c0-2100"></a><span class="lineno">2100</span>      <span class="n">clearerr</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
<a name="c0-2101"></a><span class="lineno">2101</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2102"></a><span class="lineno">2102</span>    <span class="p">}</span>
<a name="c0-2103"></a><span class="lineno">2103</span>    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2104"></a><span class="lineno">2104</span>      <span class="k">if</span> <span class="p">(</span><span class="n">get_sha1_hex</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span>
<a name="c0-2105"></a><span class="lineno">2105</span>        <span class="n">die</span><span class="p">(</span><span class="s">"expected edge sha1, got garbage:</span><span class="se">\n</span><span class="s"> %s"</span><span class="p">,</span>
<a name="c0-2106"></a><span class="lineno">2106</span>            <span class="n">line</span><span class="p">);</span>
<a name="c0-2107"></a><span class="lineno">2107</span>      <span class="n">add_preferred_base</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-2108"></a><span class="lineno">2108</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2109"></a><span class="lineno">2109</span>    <span class="p">}</span>
<a name="c0-2110"></a><span class="lineno">2110</span>    <span class="k">if</span> <span class="p">(</span><span class="n">get_sha1_hex</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span>
<a name="c0-2111"></a><span class="lineno">2111</span>      <span class="n">die</span><span class="p">(</span><span class="s">"expected sha1, got garbage:</span><span class="se">\n</span><span class="s"> %s"</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-2112"></a><span class="lineno">2112</span> 
<a name="c0-2113"></a><span class="lineno">2113</span>    <span class="n">add_preferred_base_object</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="mi">41</span><span class="p">);</span>
<a name="c0-2114"></a><span class="lineno">2114</span>    <span class="n">add_object_entry</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="o">+</span><span class="mi">41</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2115"></a><span class="lineno">2115</span>  <span class="p">}</span>
<a name="c0-2116"></a><span class="lineno">2116</span> <span class="p">}</span>
<a name="c0-2117"></a><span class="lineno">2117</span> 
<a name="c0-2118"></a><span class="lineno">2118</span> <span class="cp">#define OBJECT_ADDED (1u&lt;&lt;20)</span>
<a name="c0-2119"></a><span class="lineno">2119</span> 
<a name="c0-2120"></a><span class="lineno">2120</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c0-2121"></a><span class="lineno">2121</span> <span class="p">{</span>
<a name="c0-2122"></a><span class="lineno">2122</span>  <span class="n">add_object_entry</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">OBJ_COMMIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2123"></a><span class="lineno">2123</span>  <span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OBJECT_ADDED</span><span class="p">;</span>
<a name="c0-2124"></a><span class="lineno">2124</span> <span class="p">}</span>
<a name="c0-2125"></a><span class="lineno">2125</span> 
<a name="c0-2126"></a><span class="lineno">2126</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
<a name="c0-2127"></a><span class="lineno">2127</span>      <span class="k">const</span> <span class="k">struct</span> <span class="n">name_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last</span><span class="p">,</span>
<a name="c0-2128"></a><span class="lineno">2128</span>      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c0-2129"></a><span class="lineno">2129</span> <span class="p">{</span>
<a name="c0-2130"></a><span class="lineno">2130</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">path_name</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
<a name="c0-2131"></a><span class="lineno">2131</span> 
<a name="c0-2132"></a><span class="lineno">2132</span>  <span class="n">add_preferred_base_object</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-2133"></a><span class="lineno">2133</span>  <span class="n">add_object_entry</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2134"></a><span class="lineno">2134</span>  <span class="n">obj</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OBJECT_ADDED</span><span class="p">;</span>
<a name="c0-2135"></a><span class="lineno">2135</span> 
<a name="c0-2136"></a><span class="lineno">2136</span>  <span class="cm">/*</span>
<a name="c0-2137"></a><span class="lineno">2137</span> <span class="cm">   * We will have generated the hash from the name,</span>
<a name="c0-2138"></a><span class="lineno">2138</span> <span class="cm">   * but not saved a pointer to it - we can free it</span>
<a name="c0-2139"></a><span class="lineno">2139</span> <span class="cm">   */</span>
<a name="c0-2140"></a><span class="lineno">2140</span>  <span class="n">free</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">);</span>
<a name="c0-2141"></a><span class="lineno">2141</span> <span class="p">}</span>
<a name="c0-2142"></a><span class="lineno">2142</span> 
<a name="c0-2143"></a><span class="lineno">2143</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">)</span>
<a name="c0-2144"></a><span class="lineno">2144</span> <span class="p">{</span>
<a name="c0-2145"></a><span class="lineno">2145</span>  <span class="n">add_preferred_base</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-2146"></a><span class="lineno">2146</span> <span class="p">}</span>
<a name="c0-2147"></a><span class="lineno">2147</span> 
<a name="c0-2148"></a><span class="lineno">2148</span> <span class="k">struct</span> <span class="n">in_pack_object</span> <span class="p">{</span>
<a name="c0-2149"></a><span class="lineno">2149</span>  <span class="kt">off_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-2150"></a><span class="lineno">2150</span>  <span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">object</span><span class="p">;</span>
<a name="c0-2151"></a><span class="lineno">2151</span> <span class="p">};</span>
<a name="c0-2152"></a><span class="lineno">2152</span> 
<a name="c0-2153"></a><span class="lineno">2153</span> <span class="k">struct</span> <span class="n">in_pack</span> <span class="p">{</span>
<a name="c0-2154"></a><span class="lineno">2154</span>  <span class="kt">int</span> <span class="n">alloc</span><span class="p">;</span>
<a name="c0-2155"></a><span class="lineno">2155</span>  <span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
<a name="c0-2156"></a><span class="lineno">2156</span>  <span class="k">struct</span> <span class="n">in_pack_object</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
<a name="c0-2157"></a><span class="lineno">2157</span> <span class="p">};</span>
<a name="c0-2158"></a><span class="lineno">2158</span> 
<a name="c0-2159"></a><span class="lineno">2159</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">mark_in_pack_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">object</span><span class="p">,</span> <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">in_pack</span> <span class="o">*</span><span class="n">in_pack</span><span class="p">)</span>
<a name="c0-2160"></a><span class="lineno">2160</span> <span class="p">{</span>
<a name="c0-2161"></a><span class="lineno">2161</span>  <span class="n">in_pack</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="n">in_pack</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">find_pack_entry_one</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<a name="c0-2162"></a><span class="lineno">2162</span>  <span class="n">in_pack</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="n">in_pack</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">].</span><span class="n">object</span> <span class="o">=</span> <span class="n">object</span><span class="p">;</span>
<a name="c0-2163"></a><span class="lineno">2163</span>  <span class="n">in_pack</span><span class="o">-&gt;</span><span class="n">nr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2164"></a><span class="lineno">2164</span> <span class="p">}</span>
<a name="c0-2165"></a><span class="lineno">2165</span> 
<a name="c0-2166"></a><span class="lineno">2166</span> <span class="cm">/*</span>
<a name="c0-2167"></a><span class="lineno">2167</span> <span class="cm"> * Compare the objects in the offset order, in order to emulate the</span>
<a name="c0-2168"></a><span class="lineno">2168</span> <span class="cm"> * "git rev-list --objects" output that produced the pack originally.</span>
<a name="c0-2169"></a><span class="lineno">2169</span> <span class="cm"> */</span>
<a name="c0-2170"></a><span class="lineno">2170</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ofscmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a_</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b_</span><span class="p">)</span>
<a name="c0-2171"></a><span class="lineno">2171</span> <span class="p">{</span>
<a name="c0-2172"></a><span class="lineno">2172</span>  <span class="k">struct</span> <span class="n">in_pack_object</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_pack_object</span> <span class="o">*</span><span class="p">)</span><span class="n">a_</span><span class="p">;</span>
<a name="c0-2173"></a><span class="lineno">2173</span>  <span class="k">struct</span> <span class="n">in_pack_object</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_pack_object</span> <span class="o">*</span><span class="p">)</span><span class="n">b_</span><span class="p">;</span>
<a name="c0-2174"></a><span class="lineno">2174</span> 
<a name="c0-2175"></a><span class="lineno">2175</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
<a name="c0-2176"></a><span class="lineno">2176</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2177"></a><span class="lineno">2177</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
<a name="c0-2178"></a><span class="lineno">2178</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2179"></a><span class="lineno">2179</span>  <span class="k">else</span>
<a name="c0-2180"></a><span class="lineno">2180</span>    <span class="k">return</span> <span class="n">hashcmp</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-2181"></a><span class="lineno">2181</span> <span class="p">}</span>
<a name="c0-2182"></a><span class="lineno">2182</span> 
<a name="c0-2183"></a><span class="lineno">2183</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_objects_in_unpacked_packs</span><span class="p">(</span><span class="k">struct</span> <span class="n">rev_info</span> <span class="o">*</span><span class="n">revs</span><span class="p">)</span>
<a name="c0-2184"></a><span class="lineno">2184</span> <span class="p">{</span>
<a name="c0-2185"></a><span class="lineno">2185</span>  <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-2186"></a><span class="lineno">2186</span>  <span class="k">struct</span> <span class="n">in_pack</span> <span class="n">in_pack</span><span class="p">;</span>
<a name="c0-2187"></a><span class="lineno">2187</span>  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-2188"></a><span class="lineno">2188</span> 
<a name="c0-2189"></a><span class="lineno">2189</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_pack</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in_pack</span><span class="p">));</span>
<a name="c0-2190"></a><span class="lineno">2190</span> 
<a name="c0-2191"></a><span class="lineno">2191</span>  <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">packed_git</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2192"></a><span class="lineno">2192</span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">;</span>
<a name="c0-2193"></a><span class="lineno">2193</span>    <span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>
<a name="c0-2194"></a><span class="lineno">2194</span> 
<a name="c0-2195"></a><span class="lineno">2195</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_local</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_keep</span><span class="p">)</span>
<a name="c0-2196"></a><span class="lineno">2196</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2197"></a><span class="lineno">2197</span>    <span class="k">if</span> <span class="p">(</span><span class="n">open_pack_index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a name="c0-2198"></a><span class="lineno">2198</span>      <span class="n">die</span><span class="p">(</span><span class="s">"cannot open pack index"</span><span class="p">);</span>
<a name="c0-2199"></a><span class="lineno">2199</span> 
<a name="c0-2200"></a><span class="lineno">2200</span>    <span class="n">ALLOC_GROW</span><span class="p">(</span><span class="n">in_pack</span><span class="p">.</span><span class="n">array</span><span class="p">,</span>
<a name="c0-2201"></a><span class="lineno">2201</span>         <span class="n">in_pack</span><span class="p">.</span><span class="n">nr</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span><span class="p">,</span>
<a name="c0-2202"></a><span class="lineno">2202</span>         <span class="n">in_pack</span><span class="p">.</span><span class="n">alloc</span><span class="p">);</span>
<a name="c0-2203"></a><span class="lineno">2203</span> 
<a name="c0-2204"></a><span class="lineno">2204</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2205"></a><span class="lineno">2205</span>      <span class="n">sha1</span> <span class="o">=</span> <span class="n">nth_packed_object_sha1</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<a name="c0-2206"></a><span class="lineno">2206</span>      <span class="n">o</span> <span class="o">=</span> <span class="n">lookup_unknown_object</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-2207"></a><span class="lineno">2207</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OBJECT_ADDED</span><span class="p">))</span>
<a name="c0-2208"></a><span class="lineno">2208</span>        <span class="n">mark_in_pack_object</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_pack</span><span class="p">);</span>
<a name="c0-2209"></a><span class="lineno">2209</span>      <span class="n">o</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">OBJECT_ADDED</span><span class="p">;</span>
<a name="c0-2210"></a><span class="lineno">2210</span>    <span class="p">}</span>
<a name="c0-2211"></a><span class="lineno">2211</span>  <span class="p">}</span>
<a name="c0-2212"></a><span class="lineno">2212</span> 
<a name="c0-2213"></a><span class="lineno">2213</span>  <span class="k">if</span> <span class="p">(</span><span class="n">in_pack</span><span class="p">.</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2214"></a><span class="lineno">2214</span>    <span class="n">qsort</span><span class="p">(</span><span class="n">in_pack</span><span class="p">.</span><span class="n">array</span><span class="p">,</span> <span class="n">in_pack</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in_pack</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<a name="c0-2215"></a><span class="lineno">2215</span>          <span class="n">ofscmp</span><span class="p">);</span>
<a name="c0-2216"></a><span class="lineno">2216</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in_pack</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2217"></a><span class="lineno">2217</span>      <span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">in_pack</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">object</span><span class="p">;</span>
<a name="c0-2218"></a><span class="lineno">2218</span>      <span class="n">add_object_entry</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2219"></a><span class="lineno">2219</span>    <span class="p">}</span>
<a name="c0-2220"></a><span class="lineno">2220</span>  <span class="p">}</span>
<a name="c0-2221"></a><span class="lineno">2221</span>  <span class="n">free</span><span class="p">(</span><span class="n">in_pack</span><span class="p">.</span><span class="n">array</span><span class="p">);</span>
<a name="c0-2222"></a><span class="lineno">2222</span> <span class="p">}</span>
<a name="c0-2223"></a><span class="lineno">2223</span> 
<a name="c0-2224"></a><span class="lineno">2224</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">has_sha1_pack_kept_or_nonlocal</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-2225"></a><span class="lineno">2225</span> <span class="p">{</span>
<a name="c0-2226"></a><span class="lineno">2226</span>  <span class="k">static</span> <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">last_found</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2227"></a><span class="lineno">2227</span>  <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-2228"></a><span class="lineno">2228</span> 
<a name="c0-2229"></a><span class="lineno">2229</span>  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_found</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">last_found</span> <span class="o">:</span> <span class="n">packed_git</span><span class="p">;</span>
<a name="c0-2230"></a><span class="lineno">2230</span> 
<a name="c0-2231"></a><span class="lineno">2231</span>  <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2232"></a><span class="lineno">2232</span>    <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_local</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_keep</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2233"></a><span class="lineno">2233</span>      <span class="n">find_pack_entry_one</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2234"></a><span class="lineno">2234</span>      <span class="n">last_found</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<a name="c0-2235"></a><span class="lineno">2235</span>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2236"></a><span class="lineno">2236</span>    <span class="p">}</span>
<a name="c0-2237"></a><span class="lineno">2237</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">last_found</span><span class="p">)</span>
<a name="c0-2238"></a><span class="lineno">2238</span>      <span class="n">p</span> <span class="o">=</span> <span class="n">packed_git</span><span class="p">;</span>
<a name="c0-2239"></a><span class="lineno">2239</span>    <span class="k">else</span>
<a name="c0-2240"></a><span class="lineno">2240</span>      <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-2241"></a><span class="lineno">2241</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">last_found</span><span class="p">)</span>
<a name="c0-2242"></a><span class="lineno">2242</span>      <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-2243"></a><span class="lineno">2243</span>  <span class="p">}</span>
<a name="c0-2244"></a><span class="lineno">2244</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2245"></a><span class="lineno">2245</span> <span class="p">}</span>
<a name="c0-2246"></a><span class="lineno">2246</span> 
<a name="c0-2247"></a><span class="lineno">2247</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">loosen_unused_packed_objects</span><span class="p">(</span><span class="k">struct</span> <span class="n">rev_info</span> <span class="o">*</span><span class="n">revs</span><span class="p">)</span>
<a name="c0-2248"></a><span class="lineno">2248</span> <span class="p">{</span>
<a name="c0-2249"></a><span class="lineno">2249</span>  <span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-2250"></a><span class="lineno">2250</span>  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-2251"></a><span class="lineno">2251</span>  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">;</span>
<a name="c0-2252"></a><span class="lineno">2252</span> 
<a name="c0-2253"></a><span class="lineno">2253</span>  <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">packed_git</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2254"></a><span class="lineno">2254</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_local</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_keep</span><span class="p">)</span>
<a name="c0-2255"></a><span class="lineno">2255</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2256"></a><span class="lineno">2256</span> 
<a name="c0-2257"></a><span class="lineno">2257</span>    <span class="k">if</span> <span class="p">(</span><span class="n">open_pack_index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a name="c0-2258"></a><span class="lineno">2258</span>      <span class="n">die</span><span class="p">(</span><span class="s">"cannot open pack index"</span><span class="p">);</span>
<a name="c0-2259"></a><span class="lineno">2259</span> 
<a name="c0-2260"></a><span class="lineno">2260</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2261"></a><span class="lineno">2261</span>      <span class="n">sha1</span> <span class="o">=</span> <span class="n">nth_packed_object_sha1</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<a name="c0-2262"></a><span class="lineno">2262</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locate_object_entry</span><span class="p">(</span><span class="n">sha1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2263"></a><span class="lineno">2263</span>        <span class="o">!</span><span class="n">has_sha1_pack_kept_or_nonlocal</span><span class="p">(</span><span class="n">sha1</span><span class="p">))</span>
<a name="c0-2264"></a><span class="lineno">2264</span>        <span class="k">if</span> <span class="p">(</span><span class="n">force_object_loose</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">))</span>
<a name="c0-2265"></a><span class="lineno">2265</span>          <span class="n">die</span><span class="p">(</span><span class="s">"unable to force loose object"</span><span class="p">);</span>
<a name="c0-2266"></a><span class="lineno">2266</span>    <span class="p">}</span>
<a name="c0-2267"></a><span class="lineno">2267</span>  <span class="p">}</span>
<a name="c0-2268"></a><span class="lineno">2268</span> <span class="p">}</span>
<a name="c0-2269"></a><span class="lineno">2269</span> 
<a name="c0-2270"></a><span class="lineno">2270</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">get_object_list</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span>
<a name="c0-2271"></a><span class="lineno">2271</span> <span class="p">{</span>
<a name="c0-2272"></a><span class="lineno">2272</span>  <span class="k">struct</span> <span class="n">rev_info</span> <span class="n">revs</span><span class="p">;</span>
<a name="c0-2273"></a><span class="lineno">2273</span>  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<a name="c0-2274"></a><span class="lineno">2274</span>  <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2275"></a><span class="lineno">2275</span> 
<a name="c0-2276"></a><span class="lineno">2276</span>  <span class="n">init_revisions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2277"></a><span class="lineno">2277</span>  <span class="n">save_commit_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2278"></a><span class="lineno">2278</span>  <span class="n">setup_revisions</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2279"></a><span class="lineno">2279</span> 
<a name="c0-2280"></a><span class="lineno">2280</span>  <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2281"></a><span class="lineno">2281</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
<a name="c0-2282"></a><span class="lineno">2282</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-2283"></a><span class="lineno">2283</span>      <span class="n">line</span><span class="p">[</span><span class="o">--</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2284"></a><span class="lineno">2284</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c0-2285"></a><span class="lineno">2285</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2286"></a><span class="lineno">2286</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2287"></a><span class="lineno">2287</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"--not"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2288"></a><span class="lineno">2288</span>        <span class="n">flags</span> <span class="o">^=</span> <span class="n">UNINTERESTING</span><span class="p">;</span>
<a name="c0-2289"></a><span class="lineno">2289</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c0-2290"></a><span class="lineno">2290</span>      <span class="p">}</span>
<a name="c0-2291"></a><span class="lineno">2291</span>      <span class="n">die</span><span class="p">(</span><span class="s">"not a rev '%s'"</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-2292"></a><span class="lineno">2292</span>    <span class="p">}</span>
<a name="c0-2293"></a><span class="lineno">2293</span>    <span class="k">if</span> <span class="p">(</span><span class="n">handle_revision_arg</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="c0-2294"></a><span class="lineno">2294</span>      <span class="n">die</span><span class="p">(</span><span class="s">"bad revision '%s'"</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-2295"></a><span class="lineno">2295</span>  <span class="p">}</span>
<a name="c0-2296"></a><span class="lineno">2296</span> 
<a name="c0-2297"></a><span class="lineno">2297</span>  <span class="k">if</span> <span class="p">(</span><span class="n">prepare_revision_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">))</span>
<a name="c0-2298"></a><span class="lineno">2298</span>    <span class="n">die</span><span class="p">(</span><span class="s">"revision walk setup failed"</span><span class="p">);</span>
<a name="c0-2299"></a><span class="lineno">2299</span>  <span class="n">mark_edges_uninteresting</span><span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">commits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="n">show_edge</span><span class="p">);</span>
<a name="c0-2300"></a><span class="lineno">2300</span>  <span class="n">traverse_commit_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="n">show_commit</span><span class="p">,</span> <span class="n">show_object</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2301"></a><span class="lineno">2301</span> 
<a name="c0-2302"></a><span class="lineno">2302</span>  <span class="k">if</span> <span class="p">(</span><span class="n">keep_unreachable</span><span class="p">)</span>
<a name="c0-2303"></a><span class="lineno">2303</span>    <span class="n">add_objects_in_unpacked_packs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">);</span>
<a name="c0-2304"></a><span class="lineno">2304</span>  <span class="k">if</span> <span class="p">(</span><span class="n">unpack_unreachable</span><span class="p">)</span>
<a name="c0-2305"></a><span class="lineno">2305</span>    <span class="n">loosen_unused_packed_objects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">);</span>
<a name="c0-2306"></a><span class="lineno">2306</span> <span class="p">}</span>
<a name="c0-2307"></a><span class="lineno">2307</span> 
<a name="c0-2308"></a><span class="lineno">2308</span> <span class="kt">int</span> <span class="nf">cmd_pack_objects</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<a name="c0-2309"></a><span class="lineno">2309</span> <span class="p">{</span>
<a name="c0-2310"></a><span class="lineno">2310</span>  <span class="kt">int</span> <span class="n">use_internal_rev_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2311"></a><span class="lineno">2311</span>  <span class="kt">int</span> <span class="n">thin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2312"></a><span class="lineno">2312</span>  <span class="kt">int</span> <span class="n">all_progress_implied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2313"></a><span class="lineno">2313</span>  <span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-2314"></a><span class="lineno">2314</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">rp_av</span><span class="p">;</span>
<a name="c0-2315"></a><span class="lineno">2315</span>  <span class="kt">int</span> <span class="n">rp_ac_alloc</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<a name="c0-2316"></a><span class="lineno">2316</span>  <span class="kt">int</span> <span class="n">rp_ac</span><span class="p">;</span>
<a name="c0-2317"></a><span class="lineno">2317</span> 
<a name="c0-2318"></a><span class="lineno">2318</span>  <span class="n">read_replace_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2319"></a><span class="lineno">2319</span> 
<a name="c0-2320"></a><span class="lineno">2320</span>  <span class="n">rp_av</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="n">rp_ac_alloc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp_av</span><span class="p">));</span>
<a name="c0-2321"></a><span class="lineno">2321</span> 
<a name="c0-2322"></a><span class="lineno">2322</span>  <span class="n">rp_av</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">"pack-objects"</span><span class="p">;</span>
<a name="c0-2323"></a><span class="lineno">2323</span>  <span class="n">rp_av</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--objects"</span><span class="p">;</span> <span class="cm">/* --thin will make it --objects-edge */</span>
<a name="c0-2324"></a><span class="lineno">2324</span>  <span class="n">rp_ac</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-2325"></a><span class="lineno">2325</span> 
<a name="c0-2326"></a><span class="lineno">2326</span>  <span class="n">reset_pack_idx_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pack_idx_opts</span><span class="p">);</span>
<a name="c0-2327"></a><span class="lineno">2327</span>  <span class="n">git_config</span><span class="p">(</span><span class="n">git_pack_config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2328"></a><span class="lineno">2328</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_compression_seen</span> <span class="o">&amp;&amp;</span> <span class="n">core_compression_seen</span><span class="p">)</span>
<a name="c0-2329"></a><span class="lineno">2329</span>    <span class="n">pack_compression_level</span> <span class="o">=</span> <span class="n">core_compression_level</span><span class="p">;</span>
<a name="c0-2330"></a><span class="lineno">2330</span> 
<a name="c0-2331"></a><span class="lineno">2331</span>  <span class="n">progress</span> <span class="o">=</span> <span class="n">isatty</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a name="c0-2332"></a><span class="lineno">2332</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2333"></a><span class="lineno">2333</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-2334"></a><span class="lineno">2334</span> 
<a name="c0-2335"></a><span class="lineno">2335</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">arg</span> <span class="o">!=</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-2336"></a><span class="lineno">2336</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2337"></a><span class="lineno">2337</span> 
<a name="c0-2338"></a><span class="lineno">2338</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--non-empty"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2339"></a><span class="lineno">2339</span>      <span class="n">non_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2340"></a><span class="lineno">2340</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2341"></a><span class="lineno">2341</span>    <span class="p">}</span>
<a name="c0-2342"></a><span class="lineno">2342</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--local"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2343"></a><span class="lineno">2343</span>      <span class="n">local</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2344"></a><span class="lineno">2344</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2345"></a><span class="lineno">2345</span>    <span class="p">}</span>
<a name="c0-2346"></a><span class="lineno">2346</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--incremental"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2347"></a><span class="lineno">2347</span>      <span class="n">incremental</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2348"></a><span class="lineno">2348</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2349"></a><span class="lineno">2349</span>    <span class="p">}</span>
<a name="c0-2350"></a><span class="lineno">2350</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--honor-pack-keep"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2351"></a><span class="lineno">2351</span>      <span class="n">ignore_packed_keep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2352"></a><span class="lineno">2352</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2353"></a><span class="lineno">2353</span>    <span class="p">}</span>
<a name="c0-2354"></a><span class="lineno">2354</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--compression="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2355"></a><span class="lineno">2355</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c0-2356"></a><span class="lineno">2356</span>      <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2357"></a><span class="lineno">2357</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">||</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<a name="c0-2358"></a><span class="lineno">2358</span>        <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2359"></a><span class="lineno">2359</span>      <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-2360"></a><span class="lineno">2360</span>        <span class="n">level</span> <span class="o">=</span> <span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">;</span>
<a name="c0-2361"></a><span class="lineno">2361</span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">Z_BEST_COMPRESSION</span><span class="p">)</span>
<a name="c0-2362"></a><span class="lineno">2362</span>        <span class="n">die</span><span class="p">(</span><span class="s">"bad pack compression level %d"</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<a name="c0-2363"></a><span class="lineno">2363</span>      <span class="n">pack_compression_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<a name="c0-2364"></a><span class="lineno">2364</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2365"></a><span class="lineno">2365</span>    <span class="p">}</span>
<a name="c0-2366"></a><span class="lineno">2366</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--max-pack-size="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2367"></a><span class="lineno">2367</span>      <span class="n">pack_size_limit_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2368"></a><span class="lineno">2368</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">git_parse_ulong</span><span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pack_size_limit</span><span class="p">))</span>
<a name="c0-2369"></a><span class="lineno">2369</span>        <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2370"></a><span class="lineno">2370</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2371"></a><span class="lineno">2371</span>    <span class="p">}</span>
<a name="c0-2372"></a><span class="lineno">2372</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--window="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2373"></a><span class="lineno">2373</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c0-2374"></a><span class="lineno">2374</span>      <span class="n">window</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2375"></a><span class="lineno">2375</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">||</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<a name="c0-2376"></a><span class="lineno">2376</span>        <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2377"></a><span class="lineno">2377</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2378"></a><span class="lineno">2378</span>    <span class="p">}</span>
<a name="c0-2379"></a><span class="lineno">2379</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--window-memory="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2380"></a><span class="lineno">2380</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">git_parse_ulong</span><span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">window_memory_limit</span><span class="p">))</span>
<a name="c0-2381"></a><span class="lineno">2381</span>        <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2382"></a><span class="lineno">2382</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2383"></a><span class="lineno">2383</span>    <span class="p">}</span>
<a name="c0-2384"></a><span class="lineno">2384</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--threads="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2385"></a><span class="lineno">2385</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c0-2386"></a><span class="lineno">2386</span>      <span class="n">delta_search_threads</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2387"></a><span class="lineno">2387</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">||</span> <span class="o">*</span><span class="n">end</span> <span class="o">||</span> <span class="n">delta_search_threads</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2388"></a><span class="lineno">2388</span>        <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2389"></a><span class="lineno">2389</span> <span class="cp">#ifdef NO_PTHREADS</span>
<a name="c0-2390"></a><span class="lineno">2390</span>      <span class="k">if</span> <span class="p">(</span><span class="n">delta_search_threads</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-2391"></a><span class="lineno">2391</span>        <span class="n">warning</span><span class="p">(</span><span class="s">"no threads support, "</span>
<a name="c0-2392"></a><span class="lineno">2392</span>          <span class="s">"ignoring %s"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-2393"></a><span class="lineno">2393</span> <span class="cp">#endif</span>
<a name="c0-2394"></a><span class="lineno">2394</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2395"></a><span class="lineno">2395</span>    <span class="p">}</span>
<a name="c0-2396"></a><span class="lineno">2396</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--depth="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2397"></a><span class="lineno">2397</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c0-2398"></a><span class="lineno">2398</span>      <span class="n">depth</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2399"></a><span class="lineno">2399</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">||</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
<a name="c0-2400"></a><span class="lineno">2400</span>        <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2401"></a><span class="lineno">2401</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2402"></a><span class="lineno">2402</span>    <span class="p">}</span>
<a name="c0-2403"></a><span class="lineno">2403</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--progress"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2404"></a><span class="lineno">2404</span>      <span class="n">progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2405"></a><span class="lineno">2405</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2406"></a><span class="lineno">2406</span>    <span class="p">}</span>
<a name="c0-2407"></a><span class="lineno">2407</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--all-progress"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2408"></a><span class="lineno">2408</span>      <span class="n">progress</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-2409"></a><span class="lineno">2409</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2410"></a><span class="lineno">2410</span>    <span class="p">}</span>
<a name="c0-2411"></a><span class="lineno">2411</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--all-progress-implied"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2412"></a><span class="lineno">2412</span>      <span class="n">all_progress_implied</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2413"></a><span class="lineno">2413</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2414"></a><span class="lineno">2414</span>    <span class="p">}</span>
<a name="c0-2415"></a><span class="lineno">2415</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"-q"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2416"></a><span class="lineno">2416</span>      <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2417"></a><span class="lineno">2417</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2418"></a><span class="lineno">2418</span>    <span class="p">}</span>
<a name="c0-2419"></a><span class="lineno">2419</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--no-reuse-delta"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2420"></a><span class="lineno">2420</span>      <span class="n">reuse_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2421"></a><span class="lineno">2421</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2422"></a><span class="lineno">2422</span>    <span class="p">}</span>
<a name="c0-2423"></a><span class="lineno">2423</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--no-reuse-object"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2424"></a><span class="lineno">2424</span>      <span class="n">reuse_object</span> <span class="o">=</span> <span class="n">reuse_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2425"></a><span class="lineno">2425</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2426"></a><span class="lineno">2426</span>    <span class="p">}</span>
<a name="c0-2427"></a><span class="lineno">2427</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--delta-base-offset"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2428"></a><span class="lineno">2428</span>      <span class="n">allow_ofs_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2429"></a><span class="lineno">2429</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2430"></a><span class="lineno">2430</span>    <span class="p">}</span>
<a name="c0-2431"></a><span class="lineno">2431</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--stdout"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2432"></a><span class="lineno">2432</span>      <span class="n">pack_to_stdout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2433"></a><span class="lineno">2433</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2434"></a><span class="lineno">2434</span>    <span class="p">}</span>
<a name="c0-2435"></a><span class="lineno">2435</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--revs"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2436"></a><span class="lineno">2436</span>      <span class="n">use_internal_rev_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2437"></a><span class="lineno">2437</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2438"></a><span class="lineno">2438</span>    <span class="p">}</span>
<a name="c0-2439"></a><span class="lineno">2439</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--keep-unreachable"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2440"></a><span class="lineno">2440</span>      <span class="n">keep_unreachable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2441"></a><span class="lineno">2441</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2442"></a><span class="lineno">2442</span>    <span class="p">}</span>
<a name="c0-2443"></a><span class="lineno">2443</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--unpack-unreachable"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2444"></a><span class="lineno">2444</span>      <span class="n">unpack_unreachable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2445"></a><span class="lineno">2445</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2446"></a><span class="lineno">2446</span>    <span class="p">}</span>
<a name="c0-2447"></a><span class="lineno">2447</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--include-tag"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2448"></a><span class="lineno">2448</span>      <span class="n">include_tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2449"></a><span class="lineno">2449</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2450"></a><span class="lineno">2450</span>    <span class="p">}</span>
<a name="c0-2451"></a><span class="lineno">2451</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--unpacked"</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-2452"></a><span class="lineno">2452</span>        <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--reflog"</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-2453"></a><span class="lineno">2453</span>        <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--all"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2454"></a><span class="lineno">2454</span>      <span class="n">use_internal_rev_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2455"></a><span class="lineno">2455</span>      <span class="k">if</span> <span class="p">(</span><span class="n">rp_ac</span> <span class="o">&gt;=</span> <span class="n">rp_ac_alloc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2456"></a><span class="lineno">2456</span>        <span class="n">rp_ac_alloc</span> <span class="o">=</span> <span class="n">alloc_nr</span><span class="p">(</span><span class="n">rp_ac_alloc</span><span class="p">);</span>
<a name="c0-2457"></a><span class="lineno">2457</span>        <span class="n">rp_av</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">rp_av</span><span class="p">,</span>
<a name="c0-2458"></a><span class="lineno">2458</span>             <span class="n">rp_ac_alloc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rp_av</span><span class="p">));</span>
<a name="c0-2459"></a><span class="lineno">2459</span>      <span class="p">}</span>
<a name="c0-2460"></a><span class="lineno">2460</span>      <span class="n">rp_av</span><span class="p">[</span><span class="n">rp_ac</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
<a name="c0-2461"></a><span class="lineno">2461</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2462"></a><span class="lineno">2462</span>    <span class="p">}</span>
<a name="c0-2463"></a><span class="lineno">2463</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"--thin"</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2464"></a><span class="lineno">2464</span>      <span class="n">use_internal_rev_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2465"></a><span class="lineno">2465</span>      <span class="n">thin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2466"></a><span class="lineno">2466</span>      <span class="n">rp_av</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--objects-edge"</span><span class="p">;</span>
<a name="c0-2467"></a><span class="lineno">2467</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2468"></a><span class="lineno">2468</span>    <span class="p">}</span>
<a name="c0-2469"></a><span class="lineno">2469</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--index-version="</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2470"></a><span class="lineno">2470</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
<a name="c0-2471"></a><span class="lineno">2471</span>      <span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-2472"></a><span class="lineno">2472</span>      <span class="k">if</span> <span class="p">(</span><span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<a name="c0-2473"></a><span class="lineno">2473</span>        <span class="n">die</span><span class="p">(</span><span class="s">"bad %s"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-2474"></a><span class="lineno">2474</span>      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">==</span> <span class="sc">','</span><span class="p">)</span>
<a name="c0-2475"></a><span class="lineno">2475</span>        <span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">off32_limit</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2476"></a><span class="lineno">2476</span>      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">||</span> <span class="n">pack_idx_opts</span><span class="p">.</span><span class="n">off32_limit</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
<a name="c0-2477"></a><span class="lineno">2477</span>        <span class="n">die</span><span class="p">(</span><span class="s">"bad %s"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-2478"></a><span class="lineno">2478</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2479"></a><span class="lineno">2479</span>    <span class="p">}</span>
<a name="c0-2480"></a><span class="lineno">2480</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--keep-true-parents"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2481"></a><span class="lineno">2481</span>      <span class="n">grafts_replace_parents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2482"></a><span class="lineno">2482</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2483"></a><span class="lineno">2483</span>    <span class="p">}</span>
<a name="c0-2484"></a><span class="lineno">2484</span>    <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2485"></a><span class="lineno">2485</span>  <span class="p">}</span>
<a name="c0-2486"></a><span class="lineno">2486</span> 
<a name="c0-2487"></a><span class="lineno">2487</span>  <span class="cm">/* Traditionally "pack-objects [options] base extra" failed;</span>
<a name="c0-2488"></a><span class="lineno">2488</span> <span class="cm">   * we would however want to take refs parameter that would</span>
<a name="c0-2489"></a><span class="lineno">2489</span> <span class="cm">   * have been given to upstream rev-list ourselves, which means</span>
<a name="c0-2490"></a><span class="lineno">2490</span> <span class="cm">   * we somehow want to say what the base name is.  So the</span>
<a name="c0-2491"></a><span class="lineno">2491</span> <span class="cm">   * syntax would be:</span>
<a name="c0-2492"></a><span class="lineno">2492</span> <span class="cm">   *</span>
<a name="c0-2493"></a><span class="lineno">2493</span> <span class="cm">   * pack-objects [options] base &lt;refs...&gt;</span>
<a name="c0-2494"></a><span class="lineno">2494</span> <span class="cm">   *</span>
<a name="c0-2495"></a><span class="lineno">2495</span> <span class="cm">   * in other words, we would treat the first non-option as the</span>
<a name="c0-2496"></a><span class="lineno">2496</span> <span class="cm">   * base_name and send everything else to the internal revision</span>
<a name="c0-2497"></a><span class="lineno">2497</span> <span class="cm">   * walker.</span>
<a name="c0-2498"></a><span class="lineno">2498</span> <span class="cm">   */</span>
<a name="c0-2499"></a><span class="lineno">2499</span> 
<a name="c0-2500"></a><span class="lineno">2500</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span><span class="p">)</span>
<a name="c0-2501"></a><span class="lineno">2501</span>    <span class="n">base_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
<a name="c0-2502"></a><span class="lineno">2502</span> 
<a name="c0-2503"></a><span class="lineno">2503</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pack_to_stdout</span> <span class="o">!=</span> <span class="o">!</span><span class="n">base_name</span><span class="p">)</span>
<a name="c0-2504"></a><span class="lineno">2504</span>    <span class="n">usage</span><span class="p">(</span><span class="n">pack_usage</span><span class="p">);</span>
<a name="c0-2505"></a><span class="lineno">2505</span> 
<a name="c0-2506"></a><span class="lineno">2506</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pack_size_limit</span><span class="p">)</span>
<a name="c0-2507"></a><span class="lineno">2507</span>    <span class="n">pack_size_limit</span> <span class="o">=</span> <span class="n">pack_size_limit_cfg</span><span class="p">;</span>
<a name="c0-2508"></a><span class="lineno">2508</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pack_to_stdout</span> <span class="o">&amp;&amp;</span> <span class="n">pack_size_limit</span><span class="p">)</span>
<a name="c0-2509"></a><span class="lineno">2509</span>    <span class="n">die</span><span class="p">(</span><span class="s">"--max-pack-size cannot be used to build a pack for transfer."</span><span class="p">);</span>
<a name="c0-2510"></a><span class="lineno">2510</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pack_size_limit</span> <span class="o">&amp;&amp;</span> <span class="n">pack_size_limit</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2511"></a><span class="lineno">2511</span>    <span class="n">warning</span><span class="p">(</span><span class="s">"minimum pack size limit is 1 MiB"</span><span class="p">);</span>
<a name="c0-2512"></a><span class="lineno">2512</span>    <span class="n">pack_size_limit</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<a name="c0-2513"></a><span class="lineno">2513</span>  <span class="p">}</span>
<a name="c0-2514"></a><span class="lineno">2514</span> 
<a name="c0-2515"></a><span class="lineno">2515</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pack_to_stdout</span> <span class="o">&amp;&amp;</span> <span class="n">thin</span><span class="p">)</span>
<a name="c0-2516"></a><span class="lineno">2516</span>    <span class="n">die</span><span class="p">(</span><span class="s">"--thin cannot be used to build an indexable pack."</span><span class="p">);</span>
<a name="c0-2517"></a><span class="lineno">2517</span> 
<a name="c0-2518"></a><span class="lineno">2518</span>  <span class="k">if</span> <span class="p">(</span><span class="n">keep_unreachable</span> <span class="o">&amp;&amp;</span> <span class="n">unpack_unreachable</span><span class="p">)</span>
<a name="c0-2519"></a><span class="lineno">2519</span>    <span class="n">die</span><span class="p">(</span><span class="s">"--keep-unreachable and --unpack-unreachable are incompatible."</span><span class="p">);</span>
<a name="c0-2520"></a><span class="lineno">2520</span> 
<a name="c0-2521"></a><span class="lineno">2521</span>  <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&amp;&amp;</span> <span class="n">all_progress_implied</span><span class="p">)</span>
<a name="c0-2522"></a><span class="lineno">2522</span>    <span class="n">progress</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-2523"></a><span class="lineno">2523</span> 
<a name="c0-2524"></a><span class="lineno">2524</span>  <span class="n">prepare_packed_git</span><span class="p">();</span>
<a name="c0-2525"></a><span class="lineno">2525</span> 
<a name="c0-2526"></a><span class="lineno">2526</span>  <span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<a name="c0-2527"></a><span class="lineno">2527</span>    <span class="n">progress_state</span> <span class="o">=</span> <span class="n">start_progress</span><span class="p">(</span><span class="s">"Counting objects"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2528"></a><span class="lineno">2528</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_internal_rev_list</span><span class="p">)</span>
<a name="c0-2529"></a><span class="lineno">2529</span>    <span class="n">read_object_list_from_stdin</span><span class="p">();</span>
<a name="c0-2530"></a><span class="lineno">2530</span>  <span class="k">else</span> <span class="p">{</span>
<a name="c0-2531"></a><span class="lineno">2531</span>    <span class="n">rp_av</span><span class="p">[</span><span class="n">rp_ac</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-2532"></a><span class="lineno">2532</span>    <span class="n">get_object_list</span><span class="p">(</span><span class="n">rp_ac</span><span class="p">,</span> <span class="n">rp_av</span><span class="p">);</span>
<a name="c0-2533"></a><span class="lineno">2533</span>  <span class="p">}</span>
<a name="c0-2534"></a><span class="lineno">2534</span>  <span class="n">cleanup_preferred_base</span><span class="p">();</span>
<a name="c0-2535"></a><span class="lineno">2535</span>  <span class="k">if</span> <span class="p">(</span><span class="n">include_tag</span> <span class="o">&amp;&amp;</span> <span class="n">nr_result</span><span class="p">)</span>
<a name="c0-2536"></a><span class="lineno">2536</span>    <span class="n">for_each_ref</span><span class="p">(</span><span class="n">add_ref_tag</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2537"></a><span class="lineno">2537</span>  <span class="n">stop_progress</span><span class="p">(</span><span class="o">&amp;</span><span class="n">progress_state</span><span class="p">);</span>
<a name="c0-2538"></a><span class="lineno">2538</span> 
<a name="c0-2539"></a><span class="lineno">2539</span>  <span class="k">if</span> <span class="p">(</span><span class="n">non_empty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nr_result</span><span class="p">)</span>
<a name="c0-2540"></a><span class="lineno">2540</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2541"></a><span class="lineno">2541</span>  <span class="k">if</span> <span class="p">(</span><span class="n">nr_result</span><span class="p">)</span>
<a name="c0-2542"></a><span class="lineno">2542</span>    <span class="n">prepare_pack</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
<a name="c0-2543"></a><span class="lineno">2543</span>  <span class="n">write_pack_file</span><span class="p">();</span>
<a name="c0-2544"></a><span class="lineno">2544</span>  <span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<a name="c0-2545"></a><span class="lineno">2545</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Total %"</span><span class="n">PRIu32</span><span class="s">" (delta %"</span><span class="n">PRIu32</span><span class="s">"),"</span>
<a name="c0-2546"></a><span class="lineno">2546</span>      <span class="s">" reused %"</span><span class="n">PRIu32</span><span class="s">" (delta %"</span><span class="n">PRIu32</span><span class="s">")</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-2547"></a><span class="lineno">2547</span>      <span class="n">written</span><span class="p">,</span> <span class="n">written_delta</span><span class="p">,</span> <span class="n">reused</span><span class="p">,</span> <span class="n">reused_delta</span><span class="p">);</span>
<a name="c0-2548"></a><span class="lineno">2548</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2549"></a><span class="lineno">2549</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> config.c 
                <small> (529,2)-(546,14)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 716px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">   1</span> <span class="cm">/*</span>
<a name="c1-2"></a><span class="lineno">   2</span> <span class="cm"> * GIT - The information manager from hell</span>
<a name="c1-3"></a><span class="lineno">   3</span> <span class="cm"> *</span>
<a name="c1-4"></a><span class="lineno">   4</span> <span class="cm"> * Copyright (C) Linus Torvalds, 2005</span>
<a name="c1-5"></a><span class="lineno">   5</span> <span class="cm"> * Copyright (C) Johannes Schindelin, 2005</span>
<a name="c1-6"></a><span class="lineno">   6</span> <span class="cm"> *</span>
<a name="c1-7"></a><span class="lineno">   7</span> <span class="cm"> */</span>
<a name="c1-8"></a><span class="lineno">   8</span> <span class="cp">#include "cache.h"</span>
<a name="c1-9"></a><span class="lineno">   9</span> <span class="cp">#include "exec_cmd.h"</span>
<a name="c1-10"></a><span class="lineno">  10</span> <span class="cp">#include "strbuf.h"</span>
<a name="c1-11"></a><span class="lineno">  11</span> <span class="cp">#include "quote.h"</span>
<a name="c1-12"></a><span class="lineno">  12</span> 
<a name="c1-13"></a><span class="lineno">  13</span> <span class="cp">#define MAXNAME (256)</span>
<a name="c1-14"></a><span class="lineno">  14</span> 
<a name="c1-15"></a><span class="lineno">  15</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="n">config_file</span> <span class="p">{</span>
<a name="c1-16"></a><span class="lineno">  16</span>  <span class="k">struct</span> <span class="n">config_file</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<a name="c1-17"></a><span class="lineno">  17</span>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
<a name="c1-18"></a><span class="lineno">  18</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-19"></a><span class="lineno">  19</span>  <span class="kt">int</span> <span class="n">linenr</span><span class="p">;</span>
<a name="c1-20"></a><span class="lineno">  20</span>  <span class="kt">int</span> <span class="n">eof</span><span class="p">;</span>
<a name="c1-21"></a><span class="lineno">  21</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">value</span><span class="p">;</span>
<a name="c1-22"></a><span class="lineno">  22</span>  <span class="kt">char</span> <span class="n">var</span><span class="p">[</span><span class="n">MAXNAME</span><span class="p">];</span>
<a name="c1-23"></a><span class="lineno">  23</span> <span class="p">}</span> <span class="n">config_file</span><span class="p">;</span>
<a name="c1-24"></a><span class="lineno">  24</span> 
<a name="c1-25"></a><span class="lineno">  25</span> <span class="k">static</span> <span class="n">config_file</span> <span class="o">*</span><span class="n">cf</span><span class="p">;</span>
<a name="c1-26"></a><span class="lineno">  26</span> 
<a name="c1-27"></a><span class="lineno">  27</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">zlib_compression_seen</span><span class="p">;</span>
<a name="c1-28"></a><span class="lineno">  28</span> 
<a name="c1-29"></a><span class="lineno">  29</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_exclusive_filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-30"></a><span class="lineno">  30</span> 
<a name="c1-31"></a><span class="lineno">  31</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">lowercase</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="c1-32"></a><span class="lineno">  32</span> <span class="p">{</span>
<a name="c1-33"></a><span class="lineno">  33</span>  <span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
<a name="c1-34"></a><span class="lineno">  34</span>    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
<a name="c1-35"></a><span class="lineno">  35</span> <span class="p">}</span>
<a name="c1-36"></a><span class="lineno">  36</span> 
<a name="c1-37"></a><span class="lineno">  37</span> <span class="kt">void</span> <span class="nf">git_config_push_parameter</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">)</span>
<a name="c1-38"></a><span class="lineno">  38</span> <span class="p">{</span>
<a name="c1-39"></a><span class="lineno">  39</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">env</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-40"></a><span class="lineno">  40</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">CONFIG_DATA_ENVIRONMENT</span><span class="p">);</span>
<a name="c1-41"></a><span class="lineno">  41</span>  <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-42"></a><span class="lineno">  42</span>    <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>
<a name="c1-43"></a><span class="lineno">  43</span>    <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
<a name="c1-44"></a><span class="lineno">  44</span>  <span class="p">}</span>
<a name="c1-45"></a><span class="lineno">  45</span>  <span class="n">sq_quote_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
<a name="c1-46"></a><span class="lineno">  46</span>  <span class="n">setenv</span><span class="p">(</span><span class="n">CONFIG_DATA_ENVIRONMENT</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-47"></a><span class="lineno">  47</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">);</span>
<a name="c1-48"></a><span class="lineno">  48</span> <span class="p">}</span>
<a name="c1-49"></a><span class="lineno">  49</span> 
<a name="c1-50"></a><span class="lineno">  50</span> <span class="kt">int</span> <span class="nf">git_config_parse_parameter</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span>
<a name="c1-51"></a><span class="lineno">  51</span>             <span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-52"></a><span class="lineno">  52</span> <span class="p">{</span>
<a name="c1-53"></a><span class="lineno">  53</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">**</span><span class="n">pair</span><span class="p">;</span>
<a name="c1-54"></a><span class="lineno">  54</span>  <span class="n">pair</span> <span class="o">=</span> <span class="n">strbuf_split_str</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="sc">'='</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a name="c1-55"></a><span class="lineno">  55</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a name="c1-56"></a><span class="lineno">  56</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"bogus config parameter: %s"</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
<a name="c1-57"></a><span class="lineno">  57</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span><span class="p">)</span>
<a name="c1-58"></a><span class="lineno">  58</span>    <span class="n">strbuf_setlen</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-59"></a><span class="lineno">  59</span>  <span class="n">strbuf_trim</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-60"></a><span class="lineno">  60</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-61"></a><span class="lineno">  61</span>    <span class="n">strbuf_list_free</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
<a name="c1-62"></a><span class="lineno">  62</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"bogus config parameter: %s"</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
<a name="c1-63"></a><span class="lineno">  63</span>  <span class="p">}</span>
<a name="c1-64"></a><span class="lineno">  64</span>  <span class="n">lowercase</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-65"></a><span class="lineno">  65</span>  <span class="k">if</span> <span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-66"></a><span class="lineno">  66</span>    <span class="n">strbuf_list_free</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
<a name="c1-67"></a><span class="lineno">  67</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-68"></a><span class="lineno">  68</span>  <span class="p">}</span>
<a name="c1-69"></a><span class="lineno">  69</span>  <span class="n">strbuf_list_free</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
<a name="c1-70"></a><span class="lineno">  70</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-71"></a><span class="lineno">  71</span> <span class="p">}</span>
<a name="c1-72"></a><span class="lineno">  72</span> 
<a name="c1-73"></a><span class="lineno">  73</span> <span class="kt">int</span> <span class="nf">git_config_from_parameters</span><span class="p">(</span><span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-74"></a><span class="lineno">  74</span> <span class="p">{</span>
<a name="c1-75"></a><span class="lineno">  75</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">env</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">CONFIG_DATA_ENVIRONMENT</span><span class="p">);</span>
<a name="c1-76"></a><span class="lineno">  76</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">envw</span><span class="p">;</span>
<a name="c1-77"></a><span class="lineno">  77</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-78"></a><span class="lineno">  78</span>  <span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-79"></a><span class="lineno">  79</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-80"></a><span class="lineno">  80</span> 
<a name="c1-81"></a><span class="lineno">  81</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">env</span><span class="p">)</span>
<a name="c1-82"></a><span class="lineno">  82</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-83"></a><span class="lineno">  83</span>  <span class="cm">/* sq_dequote will write over it */</span>
<a name="c1-84"></a><span class="lineno">  84</span>  <span class="n">envw</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<a name="c1-85"></a><span class="lineno">  85</span> 
<a name="c1-86"></a><span class="lineno">  86</span>  <span class="k">if</span> <span class="p">(</span><span class="n">sq_dequote_to_argv</span><span class="p">(</span><span class="n">envw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-87"></a><span class="lineno">  87</span>    <span class="n">free</span><span class="p">(</span><span class="n">envw</span><span class="p">);</span>
<a name="c1-88"></a><span class="lineno">  88</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"bogus format in "</span> <span class="n">CONFIG_DATA_ENVIRONMENT</span><span class="p">);</span>
<a name="c1-89"></a><span class="lineno">  89</span>  <span class="p">}</span>
<a name="c1-90"></a><span class="lineno">  90</span> 
<a name="c1-91"></a><span class="lineno">  91</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-92"></a><span class="lineno">  92</span>    <span class="k">if</span> <span class="p">(</span><span class="n">git_config_parse_parameter</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-93"></a><span class="lineno">  93</span>      <span class="n">free</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
<a name="c1-94"></a><span class="lineno">  94</span>      <span class="n">free</span><span class="p">(</span><span class="n">envw</span><span class="p">);</span>
<a name="c1-95"></a><span class="lineno">  95</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-96"></a><span class="lineno">  96</span>    <span class="p">}</span>
<a name="c1-97"></a><span class="lineno">  97</span>  <span class="p">}</span>
<a name="c1-98"></a><span class="lineno">  98</span> 
<a name="c1-99"></a><span class="lineno">  99</span>  <span class="n">free</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
<a name="c1-100"></a><span class="lineno"> 100</span>   <span class="n">free</span><span class="p">(</span><span class="n">envw</span><span class="p">);</span>
<a name="c1-101"></a><span class="lineno"> 101</span>   <span class="k">return</span> <span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-102"></a><span class="lineno"> 102</span> <span class="p">}</span>
<a name="c1-103"></a><span class="lineno"> 103</span> 
<a name="c1-104"></a><span class="lineno"> 104</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">get_next_char</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c1-105"></a><span class="lineno"> 105</span> <span class="p">{</span>
<a name="c1-106"></a><span class="lineno"> 106</span>   <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-107"></a><span class="lineno"> 107</span>   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
<a name="c1-108"></a><span class="lineno"> 108</span> 
<a name="c1-109"></a><span class="lineno"> 109</span>   <span class="n">c</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c1-110"></a><span class="lineno"> 110</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cf</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-111"></a><span class="lineno"> 111</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-112"></a><span class="lineno"> 112</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-113"></a><span class="lineno"> 113</span>       <span class="cm">/* DOS like systems */</span>
<a name="c1-114"></a><span class="lineno"> 114</span>       <span class="n">c</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-115"></a><span class="lineno"> 115</span>       <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-116"></a><span class="lineno"> 116</span>         <span class="n">ungetc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<a name="c1-117"></a><span class="lineno"> 117</span>         <span class="n">c</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
<a name="c1-118"></a><span class="lineno"> 118</span>       <span class="p">}</span>
<a name="c1-119"></a><span class="lineno"> 119</span>     <span class="p">}</span>
<a name="c1-120"></a><span class="lineno"> 120</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-121"></a><span class="lineno"> 121</span>       <span class="n">cf</span><span class="o">-&gt;</span><span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c1-122"></a><span class="lineno"> 122</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-123"></a><span class="lineno"> 123</span>       <span class="n">cf</span><span class="o">-&gt;</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-124"></a><span class="lineno"> 124</span>       <span class="n">c</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c1-125"></a><span class="lineno"> 125</span>     <span class="p">}</span>
<a name="c1-126"></a><span class="lineno"> 126</span>   <span class="p">}</span>
<a name="c1-127"></a><span class="lineno"> 127</span>   <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-128"></a><span class="lineno"> 128</span> <span class="p">}</span>
<a name="c1-129"></a><span class="lineno"> 129</span> 
<a name="c1-130"></a><span class="lineno"> 130</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">parse_value</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c1-131"></a><span class="lineno"> 131</span> <span class="p">{</span>
<a name="c1-132"></a><span class="lineno"> 132</span>   <span class="kt">int</span> <span class="n">quote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">space</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-133"></a><span class="lineno"> 133</span> 
<a name="c1-134"></a><span class="lineno"> 134</span>   <span class="n">strbuf_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<a name="c1-135"></a><span class="lineno"> 135</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-136"></a><span class="lineno"> 136</span>     <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-137"></a><span class="lineno"> 137</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-138"></a><span class="lineno"> 138</span>       <span class="k">if</span> <span class="p">(</span><span class="n">quote</span><span class="p">)</span>
<a name="c1-139"></a><span class="lineno"> 139</span>         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-140"></a><span class="lineno"> 140</span>       <span class="k">return</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-141"></a><span class="lineno"> 141</span>     <span class="p">}</span>
<a name="c1-142"></a><span class="lineno"> 142</span>     <span class="k">if</span> <span class="p">(</span><span class="n">comment</span><span class="p">)</span>
<a name="c1-143"></a><span class="lineno"> 143</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-144"></a><span class="lineno"> 144</span>     <span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">quote</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-145"></a><span class="lineno"> 145</span>       <span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
<a name="c1-146"></a><span class="lineno"> 146</span>         <span class="n">space</span><span class="o">++</span><span class="p">;</span>
<a name="c1-147"></a><span class="lineno"> 147</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-148"></a><span class="lineno"> 148</span>     <span class="p">}</span>
<a name="c1-149"></a><span class="lineno"> 149</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">quote</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-150"></a><span class="lineno"> 150</span>       <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">';'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'#'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-151"></a><span class="lineno"> 151</span>         <span class="n">comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-152"></a><span class="lineno"> 152</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-153"></a><span class="lineno"> 153</span>       <span class="p">}</span>
<a name="c1-154"></a><span class="lineno"> 154</span>     <span class="p">}</span>
<a name="c1-155"></a><span class="lineno"> 155</span>     <span class="k">for</span> <span class="p">(;</span> <span class="n">space</span><span class="p">;</span> <span class="n">space</span><span class="o">--</span><span class="p">)</span>
<a name="c1-156"></a><span class="lineno"> 156</span>       <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
<a name="c1-157"></a><span class="lineno"> 157</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-158"></a><span class="lineno"> 158</span>       <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-159"></a><span class="lineno"> 159</span>       <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-160"></a><span class="lineno"> 160</span>       <span class="k">case</span> <span class="sc">'\n'</span>:
<a name="c1-161"></a><span class="lineno"> 161</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-162"></a><span class="lineno"> 162</span>       <span class="k">case</span> <span class="sc">'t'</span>:
<a name="c1-163"></a><span class="lineno"> 163</span>         <span class="n">c</span> <span class="o">=</span> <span class="sc">'\t'</span><span class="p">;</span>
<a name="c1-164"></a><span class="lineno"> 164</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-165"></a><span class="lineno"> 165</span>       <span class="k">case</span> <span class="sc">'b'</span>:
<a name="c1-166"></a><span class="lineno"> 166</span>         <span class="n">c</span> <span class="o">=</span> <span class="sc">'\b'</span><span class="p">;</span>
<a name="c1-167"></a><span class="lineno"> 167</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-168"></a><span class="lineno"> 168</span>       <span class="k">case</span> <span class="sc">'n'</span>:
<a name="c1-169"></a><span class="lineno"> 169</span>         <span class="n">c</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c1-170"></a><span class="lineno"> 170</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-171"></a><span class="lineno"> 171</span>       <span class="cm">/* Some characters escape as themselves */</span>
<a name="c1-172"></a><span class="lineno"> 172</span>       <span class="k">case</span> <span class="sc">'\\'</span>: <span class="k">case</span> <span class="sc">'"'</span>:
<a name="c1-173"></a><span class="lineno"> 173</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-174"></a><span class="lineno"> 174</span>       <span class="cm">/* Reject unknown escape sequences */</span>
<a name="c1-175"></a><span class="lineno"> 175</span>       <span class="nl">default:</span>
<a name="c1-176"></a><span class="lineno"> 176</span>         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-177"></a><span class="lineno"> 177</span>       <span class="p">}</span>
<a name="c1-178"></a><span class="lineno"> 178</span>       <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<a name="c1-179"></a><span class="lineno"> 179</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-180"></a><span class="lineno"> 180</span>     <span class="p">}</span>
<a name="c1-181"></a><span class="lineno"> 181</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-182"></a><span class="lineno"> 182</span>       <span class="n">quote</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">quote</span><span class="p">;</span>
<a name="c1-183"></a><span class="lineno"> 183</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-184"></a><span class="lineno"> 184</span>     <span class="p">}</span>
<a name="c1-185"></a><span class="lineno"> 185</span>     <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<a name="c1-186"></a><span class="lineno"> 186</span>   <span class="p">}</span>
<a name="c1-187"></a><span class="lineno"> 187</span> <span class="p">}</span>
<a name="c1-188"></a><span class="lineno"> 188</span> 
<a name="c1-189"></a><span class="lineno"> 189</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">iskeychar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<a name="c1-190"></a><span class="lineno"> 190</span> <span class="p">{</span>
<a name="c1-191"></a><span class="lineno"> 191</span>   <span class="k">return</span> <span class="n">isalnum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">;</span>
<a name="c1-192"></a><span class="lineno"> 192</span> <span class="p">}</span>
<a name="c1-193"></a><span class="lineno"> 193</span> 
<a name="c1-194"></a><span class="lineno"> 194</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="c1-195"></a><span class="lineno"> 195</span> <span class="p">{</span>
<a name="c1-196"></a><span class="lineno"> 196</span>   <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-197"></a><span class="lineno"> 197</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
<a name="c1-198"></a><span class="lineno"> 198</span> 
<a name="c1-199"></a><span class="lineno"> 199</span>   <span class="cm">/* Get the full name */</span>
<a name="c1-200"></a><span class="lineno"> 200</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-201"></a><span class="lineno"> 201</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-202"></a><span class="lineno"> 202</span>     <span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
<a name="c1-203"></a><span class="lineno"> 203</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-204"></a><span class="lineno"> 204</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iskeychar</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<a name="c1-205"></a><span class="lineno"> 205</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-206"></a><span class="lineno"> 206</span>     <span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="c1-207"></a><span class="lineno"> 207</span>     <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">MAXNAME</span><span class="p">)</span>
<a name="c1-208"></a><span class="lineno"> 208</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-209"></a><span class="lineno"> 209</span>   <span class="p">}</span>
<a name="c1-210"></a><span class="lineno"> 210</span>   <span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-211"></a><span class="lineno"> 211</span>   <span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">' '</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span>
<a name="c1-212"></a><span class="lineno"> 212</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-213"></a><span class="lineno"> 213</span> 
<a name="c1-214"></a><span class="lineno"> 214</span>   <span class="n">value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-215"></a><span class="lineno"> 215</span>   <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-216"></a><span class="lineno"> 216</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">'='</span><span class="p">)</span>
<a name="c1-217"></a><span class="lineno"> 217</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-218"></a><span class="lineno"> 218</span>     <span class="n">value</span> <span class="o">=</span> <span class="n">parse_value</span><span class="p">();</span>
<a name="c1-219"></a><span class="lineno"> 219</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-220"></a><span class="lineno"> 220</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-221"></a><span class="lineno"> 221</span>   <span class="p">}</span>
<a name="c1-222"></a><span class="lineno"> 222</span>   <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c1-223"></a><span class="lineno"> 223</span> <span class="p">}</span>
<a name="c1-224"></a><span class="lineno"> 224</span> 
<a name="c1-225"></a><span class="lineno"> 225</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">get_extended_base_var</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baselen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<a name="c1-226"></a><span class="lineno"> 226</span> <span class="p">{</span>
<a name="c1-227"></a><span class="lineno"> 227</span>   <span class="k">do</span> <span class="p">{</span>
<a name="c1-228"></a><span class="lineno"> 228</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-229"></a><span class="lineno"> 229</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-230"></a><span class="lineno"> 230</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-231"></a><span class="lineno"> 231</span>   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<a name="c1-232"></a><span class="lineno"> 232</span> 
<a name="c1-233"></a><span class="lineno"> 233</span>   <span class="cm">/* We require the format to be '[base "extension"]' */</span>
<a name="c1-234"></a><span class="lineno"> 234</span>   <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">'"'</span><span class="p">)</span>
<a name="c1-235"></a><span class="lineno"> 235</span>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-236"></a><span class="lineno"> 236</span>   <span class="n">name</span><span class="p">[</span><span class="n">baselen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
<a name="c1-237"></a><span class="lineno"> 237</span> 
<a name="c1-238"></a><span class="lineno"> 238</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-239"></a><span class="lineno"> 239</span>     <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-240"></a><span class="lineno"> 240</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-241"></a><span class="lineno"> 241</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-242"></a><span class="lineno"> 242</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span>
<a name="c1-243"></a><span class="lineno"> 243</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-244"></a><span class="lineno"> 244</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-245"></a><span class="lineno"> 245</span>       <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-246"></a><span class="lineno"> 246</span>       <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-247"></a><span class="lineno"> 247</span>         <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-248"></a><span class="lineno"> 248</span>     <span class="p">}</span>
<a name="c1-249"></a><span class="lineno"> 249</span>     <span class="n">name</span><span class="p">[</span><span class="n">baselen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-250"></a><span class="lineno"> 250</span>     <span class="k">if</span> <span class="p">(</span><span class="n">baselen</span> <span class="o">&gt;</span> <span class="n">MAXNAME</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a name="c1-251"></a><span class="lineno"> 251</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-252"></a><span class="lineno"> 252</span>   <span class="p">}</span>
<a name="c1-253"></a><span class="lineno"> 253</span> 
<a name="c1-254"></a><span class="lineno"> 254</span>   <span class="cm">/* Final ']' */</span>
<a name="c1-255"></a><span class="lineno"> 255</span>   <span class="k">if</span> <span class="p">(</span><span class="n">get_next_char</span><span class="p">()</span> <span class="o">!=</span> <span class="sc">']'</span><span class="p">)</span>
<a name="c1-256"></a><span class="lineno"> 256</span>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-257"></a><span class="lineno"> 257</span>   <span class="k">return</span> <span class="n">baselen</span><span class="p">;</span>
<a name="c1-258"></a><span class="lineno"> 258</span> <span class="p">}</span>
<a name="c1-259"></a><span class="lineno"> 259</span> 
<a name="c1-260"></a><span class="lineno"> 260</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">get_base_var</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c1-261"></a><span class="lineno"> 261</span> <span class="p">{</span>
<a name="c1-262"></a><span class="lineno"> 262</span>   <span class="kt">int</span> <span class="n">baselen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-263"></a><span class="lineno"> 263</span> 
<a name="c1-264"></a><span class="lineno"> 264</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-265"></a><span class="lineno"> 265</span>     <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-266"></a><span class="lineno"> 266</span>     <span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
<a name="c1-267"></a><span class="lineno"> 267</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-268"></a><span class="lineno"> 268</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">']'</span><span class="p">)</span>
<a name="c1-269"></a><span class="lineno"> 269</span>       <span class="k">return</span> <span class="n">baselen</span><span class="p">;</span>
<a name="c1-270"></a><span class="lineno"> 270</span>     <span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<a name="c1-271"></a><span class="lineno"> 271</span>       <span class="k">return</span> <span class="n">get_extended_base_var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">baselen</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<a name="c1-272"></a><span class="lineno"> 272</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iskeychar</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">'.'</span><span class="p">)</span>
<a name="c1-273"></a><span class="lineno"> 273</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-274"></a><span class="lineno"> 274</span>     <span class="k">if</span> <span class="p">(</span><span class="n">baselen</span> <span class="o">&gt;</span> <span class="n">MAXNAME</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a name="c1-275"></a><span class="lineno"> 275</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-276"></a><span class="lineno"> 276</span>     <span class="n">name</span><span class="p">[</span><span class="n">baselen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="c1-277"></a><span class="lineno"> 277</span>   <span class="p">}</span>
<a name="c1-278"></a><span class="lineno"> 278</span> <span class="p">}</span>
<a name="c1-279"></a><span class="lineno"> 279</span> 
<a name="c1-280"></a><span class="lineno"> 280</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_parse_file</span><span class="p">(</span><span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-281"></a><span class="lineno"> 281</span> <span class="p">{</span>
<a name="c1-282"></a><span class="lineno"> 282</span>   <span class="kt">int</span> <span class="n">comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-283"></a><span class="lineno"> 283</span>   <span class="kt">int</span> <span class="n">baselen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-284"></a><span class="lineno"> 284</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
<a name="c1-285"></a><span class="lineno"> 285</span> 
<a name="c1-286"></a><span class="lineno"> 286</span>   <span class="cm">/* U+FEFF Byte Order Mark in UTF8 */</span>
<a name="c1-287"></a><span class="lineno"> 287</span>   <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">utf8_bom</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="s">"</span><span class="se">\xef\xbb\xbf</span><span class="s">"</span><span class="p">;</span>
<a name="c1-288"></a><span class="lineno"> 288</span>   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bomptr</span> <span class="o">=</span> <span class="n">utf8_bom</span><span class="p">;</span>
<a name="c1-289"></a><span class="lineno"> 289</span> 
<a name="c1-290"></a><span class="lineno"> 290</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-291"></a><span class="lineno"> 291</span>     <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">get_next_char</span><span class="p">();</span>
<a name="c1-292"></a><span class="lineno"> 292</span>     <span class="k">if</span> <span class="p">(</span><span class="n">bomptr</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">bomptr</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-293"></a><span class="lineno"> 293</span>       <span class="cm">/* We are at the file beginning; skip UTF8-encoded BOM</span>
<a name="c1-294"></a><span class="lineno"> 294</span> <span class="cm">      * if present. Sane editors won't put this in on their</span>
<a name="c1-295"></a><span class="lineno"> 295</span> <span class="cm">      * own, but e.g. Windows Notepad will do it happily. */</span>
<a name="c1-296"></a><span class="lineno"> 296</span>       <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">c</span> <span class="o">==</span> <span class="o">*</span><span class="n">bomptr</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-297"></a><span class="lineno"> 297</span>         <span class="n">bomptr</span><span class="o">++</span><span class="p">;</span>
<a name="c1-298"></a><span class="lineno"> 298</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-299"></a><span class="lineno"> 299</span>       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-300"></a><span class="lineno"> 300</span>         <span class="cm">/* Do not tolerate partial BOM. */</span>
<a name="c1-301"></a><span class="lineno"> 301</span>         <span class="k">if</span> <span class="p">(</span><span class="n">bomptr</span> <span class="o">!=</span> <span class="n">utf8_bom</span><span class="p">)</span>
<a name="c1-302"></a><span class="lineno"> 302</span>           <span class="k">break</span><span class="p">;</span>
<a name="c1-303"></a><span class="lineno"> 303</span>         <span class="cm">/* No BOM at file beginning. Cool. */</span>
<a name="c1-304"></a><span class="lineno"> 304</span>         <span class="n">bomptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-305"></a><span class="lineno"> 305</span>       <span class="p">}</span>
<a name="c1-306"></a><span class="lineno"> 306</span>     <span class="p">}</span>
<a name="c1-307"></a><span class="lineno"> 307</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-308"></a><span class="lineno"> 308</span>       <span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">eof</span><span class="p">)</span>
<a name="c1-309"></a><span class="lineno"> 309</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-310"></a><span class="lineno"> 310</span>       <span class="n">comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-311"></a><span class="lineno"> 311</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-312"></a><span class="lineno"> 312</span>     <span class="p">}</span>
<a name="c1-313"></a><span class="lineno"> 313</span>     <span class="k">if</span> <span class="p">(</span><span class="n">comment</span> <span class="o">||</span> <span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<a name="c1-314"></a><span class="lineno"> 314</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-315"></a><span class="lineno"> 315</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'#'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">';'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-316"></a><span class="lineno"> 316</span>       <span class="n">comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-317"></a><span class="lineno"> 317</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-318"></a><span class="lineno"> 318</span>     <span class="p">}</span>
<a name="c1-319"></a><span class="lineno"> 319</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-320"></a><span class="lineno"> 320</span>       <span class="n">baselen</span> <span class="o">=</span> <span class="n">get_base_var</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-321"></a><span class="lineno"> 321</span>       <span class="k">if</span> <span class="p">(</span><span class="n">baselen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-322"></a><span class="lineno"> 322</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-323"></a><span class="lineno"> 323</span>       <span class="n">var</span><span class="p">[</span><span class="n">baselen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
<a name="c1-324"></a><span class="lineno"> 324</span>       <span class="n">var</span><span class="p">[</span><span class="n">baselen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-325"></a><span class="lineno"> 325</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-326"></a><span class="lineno"> 326</span>     <span class="p">}</span>
<a name="c1-327"></a><span class="lineno"> 327</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalpha</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<a name="c1-328"></a><span class="lineno"> 328</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-329"></a><span class="lineno"> 329</span>     <span class="n">var</span><span class="p">[</span><span class="n">baselen</span><span class="p">]</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="c1-330"></a><span class="lineno"> 330</span>     <span class="k">if</span> <span class="p">(</span><span class="n">get_value</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">baselen</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-331"></a><span class="lineno"> 331</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-332"></a><span class="lineno"> 332</span>   <span class="p">}</span>
<a name="c1-333"></a><span class="lineno"> 333</span>   <span class="n">die</span><span class="p">(</span><span class="s">"bad config file line %d in %s"</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">linenr</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c1-334"></a><span class="lineno"> 334</span> <span class="p">}</span>
<a name="c1-335"></a><span class="lineno"> 335</span> 
<a name="c1-336"></a><span class="lineno"> 336</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_unit_factor</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">uintmax_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<a name="c1-337"></a><span class="lineno"> 337</span> <span class="p">{</span>
<a name="c1-338"></a><span class="lineno"> 338</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">end</span><span class="p">)</span>
<a name="c1-339"></a><span class="lineno"> 339</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-340"></a><span class="lineno"> 340</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s">"k"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-341"></a><span class="lineno"> 341</span>     <span class="o">*</span><span class="n">val</span> <span class="o">*=</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c1-342"></a><span class="lineno"> 342</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-343"></a><span class="lineno"> 343</span>   <span class="p">}</span>
<a name="c1-344"></a><span class="lineno"> 344</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s">"m"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-345"></a><span class="lineno"> 345</span>     <span class="o">*</span><span class="n">val</span> <span class="o">*=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c1-346"></a><span class="lineno"> 346</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-347"></a><span class="lineno"> 347</span>   <span class="p">}</span>
<a name="c1-348"></a><span class="lineno"> 348</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s">"g"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-349"></a><span class="lineno"> 349</span>     <span class="o">*</span><span class="n">val</span> <span class="o">*=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<a name="c1-350"></a><span class="lineno"> 350</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-351"></a><span class="lineno"> 351</span>   <span class="p">}</span>
<a name="c1-352"></a><span class="lineno"> 352</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-353"></a><span class="lineno"> 353</span> <span class="p">}</span>
<a name="c1-354"></a><span class="lineno"> 354</span> 
<a name="c1-355"></a><span class="lineno"> 355</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_parse_long</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<a name="c1-356"></a><span class="lineno"> 356</span> <span class="p">{</span>
<a name="c1-357"></a><span class="lineno"> 357</span>   <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-358"></a><span class="lineno"> 358</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c1-359"></a><span class="lineno"> 359</span>     <span class="kt">intmax_t</span> <span class="n">val</span><span class="p">;</span>
<a name="c1-360"></a><span class="lineno"> 360</span>     <span class="kt">uintmax_t</span> <span class="n">uval</span><span class="p">;</span>
<a name="c1-361"></a><span class="lineno"> 361</span>     <span class="kt">uintmax_t</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-362"></a><span class="lineno"> 362</span> 
<a name="c1-363"></a><span class="lineno"> 363</span>     <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-364"></a><span class="lineno"> 364</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">strtoimax</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-365"></a><span class="lineno"> 365</span>     <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ERANGE</span><span class="p">)</span>
<a name="c1-366"></a><span class="lineno"> 366</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-367"></a><span class="lineno"> 367</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_unit_factor</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">factor</span><span class="p">))</span>
<a name="c1-368"></a><span class="lineno"> 368</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-369"></a><span class="lineno"> 369</span>     <span class="n">uval</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a name="c1-370"></a><span class="lineno"> 370</span>     <span class="n">uval</span> <span class="o">*=</span> <span class="n">factor</span><span class="p">;</span>
<a name="c1-371"></a><span class="lineno"> 371</span>     <span class="k">if</span> <span class="p">((</span><span class="n">uval</span> <span class="o">&gt;</span> <span class="n">maximum_signed_value_of_type</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">||</span>
<a name="c1-372"></a><span class="lineno"> 372</span>         <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">uval</span><span class="p">))</span>
<a name="c1-373"></a><span class="lineno"> 373</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-374"></a><span class="lineno"> 374</span>     <span class="n">val</span> <span class="o">*=</span> <span class="n">factor</span><span class="p">;</span>
<a name="c1-375"></a><span class="lineno"> 375</span>     <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<a name="c1-376"></a><span class="lineno"> 376</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-377"></a><span class="lineno"> 377</span>   <span class="p">}</span>
<a name="c1-378"></a><span class="lineno"> 378</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-379"></a><span class="lineno"> 379</span> <span class="p">}</span>
<a name="c1-380"></a><span class="lineno"> 380</span> 
<a name="c1-381"></a><span class="lineno"> 381</span> <span class="kt">int</span> <span class="nf">git_parse_ulong</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<a name="c1-382"></a><span class="lineno"> 382</span> <span class="p">{</span>
<a name="c1-383"></a><span class="lineno"> 383</span>   <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-384"></a><span class="lineno"> 384</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
<a name="c1-385"></a><span class="lineno"> 385</span>     <span class="kt">uintmax_t</span> <span class="n">val</span><span class="p">;</span>
<a name="c1-386"></a><span class="lineno"> 386</span>     <span class="kt">uintmax_t</span> <span class="n">oldval</span><span class="p">;</span>
<a name="c1-387"></a><span class="lineno"> 387</span> 
<a name="c1-388"></a><span class="lineno"> 388</span>     <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-389"></a><span class="lineno"> 389</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">strtoumax</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-390"></a><span class="lineno"> 390</span>     <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ERANGE</span><span class="p">)</span>
<a name="c1-391"></a><span class="lineno"> 391</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-392"></a><span class="lineno"> 392</span>     <span class="n">oldval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<a name="c1-393"></a><span class="lineno"> 393</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parse_unit_factor</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
<a name="c1-394"></a><span class="lineno"> 394</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-395"></a><span class="lineno"> 395</span>     <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">maximum_unsigned_value_of_type</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="o">||</span>
<a name="c1-396"></a><span class="lineno"> 396</span>         <span class="p">(</span><span class="n">oldval</span> <span class="o">&gt;</span> <span class="n">val</span><span class="p">))</span>
<a name="c1-397"></a><span class="lineno"> 397</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-398"></a><span class="lineno"> 398</span>     <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<a name="c1-399"></a><span class="lineno"> 399</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-400"></a><span class="lineno"> 400</span>   <span class="p">}</span>
<a name="c1-401"></a><span class="lineno"> 401</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-402"></a><span class="lineno"> 402</span> <span class="p">}</span>
<a name="c1-403"></a><span class="lineno"> 403</span> 
<a name="c1-404"></a><span class="lineno"> 404</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">die_bad_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c1-405"></a><span class="lineno"> 405</span> <span class="p">{</span>
<a name="c1-406"></a><span class="lineno"> 406</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cf</span> <span class="o">&amp;&amp;</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
<a name="c1-407"></a><span class="lineno"> 407</span>     <span class="n">die</span><span class="p">(</span><span class="s">"bad config value for '%s' in %s"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c1-408"></a><span class="lineno"> 408</span>   <span class="n">die</span><span class="p">(</span><span class="s">"bad config value for '%s'"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c1-409"></a><span class="lineno"> 409</span> <span class="p">}</span>
<a name="c1-410"></a><span class="lineno"> 410</span> 
<a name="c1-411"></a><span class="lineno"> 411</span> <span class="kt">int</span> <span class="nf">git_config_int</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-412"></a><span class="lineno"> 412</span> <span class="p">{</span>
<a name="c1-413"></a><span class="lineno"> 413</span>   <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-414"></a><span class="lineno"> 414</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">git_parse_long</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
<a name="c1-415"></a><span class="lineno"> 415</span>     <span class="n">die_bad_config</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c1-416"></a><span class="lineno"> 416</span>   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-417"></a><span class="lineno"> 417</span> <span class="p">}</span>
<a name="c1-418"></a><span class="lineno"> 418</span> 
<a name="c1-419"></a><span class="lineno"> 419</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">git_config_ulong</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-420"></a><span class="lineno"> 420</span> <span class="p">{</span>
<a name="c1-421"></a><span class="lineno"> 421</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-422"></a><span class="lineno"> 422</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">git_parse_ulong</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
<a name="c1-423"></a><span class="lineno"> 423</span>     <span class="n">die_bad_config</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c1-424"></a><span class="lineno"> 424</span>   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-425"></a><span class="lineno"> 425</span> <span class="p">}</span>
<a name="c1-426"></a><span class="lineno"> 426</span> 
<a name="c1-427"></a><span class="lineno"> 427</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_config_maybe_bool_text</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-428"></a><span class="lineno"> 428</span> <span class="p">{</span>
<a name="c1-429"></a><span class="lineno"> 429</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-430"></a><span class="lineno"> 430</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-431"></a><span class="lineno"> 431</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-432"></a><span class="lineno"> 432</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-433"></a><span class="lineno"> 433</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"true"</span><span class="p">)</span>
<a name="c1-434"></a><span class="lineno"> 434</span>       <span class="o">||</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"yes"</span><span class="p">)</span>
<a name="c1-435"></a><span class="lineno"> 435</span>       <span class="o">||</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"on"</span><span class="p">))</span>
<a name="c1-436"></a><span class="lineno"> 436</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-437"></a><span class="lineno"> 437</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"false"</span><span class="p">)</span>
<a name="c1-438"></a><span class="lineno"> 438</span>       <span class="o">||</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"no"</span><span class="p">)</span>
<a name="c1-439"></a><span class="lineno"> 439</span>       <span class="o">||</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"off"</span><span class="p">))</span>
<a name="c1-440"></a><span class="lineno"> 440</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-441"></a><span class="lineno"> 441</span>   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-442"></a><span class="lineno"> 442</span> <span class="p">}</span>
<a name="c1-443"></a><span class="lineno"> 443</span> 
<a name="c1-444"></a><span class="lineno"> 444</span> <span class="kt">int</span> <span class="nf">git_config_maybe_bool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-445"></a><span class="lineno"> 445</span> <span class="p">{</span>
<a name="c1-446"></a><span class="lineno"> 446</span>   <span class="kt">long</span> <span class="n">v</span> <span class="o">=</span> <span class="n">git_config_maybe_bool_text</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-447"></a><span class="lineno"> 447</span>   <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">)</span>
<a name="c1-448"></a><span class="lineno"> 448</span>     <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<a name="c1-449"></a><span class="lineno"> 449</span>   <span class="k">if</span> <span class="p">(</span><span class="n">git_parse_long</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
<a name="c1-450"></a><span class="lineno"> 450</span>     <span class="k">return</span> <span class="o">!!</span><span class="n">v</span><span class="p">;</span>
<a name="c1-451"></a><span class="lineno"> 451</span>   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-452"></a><span class="lineno"> 452</span> <span class="p">}</span>
<a name="c1-453"></a><span class="lineno"> 453</span> 
<a name="c1-454"></a><span class="lineno"> 454</span> <span class="kt">int</span> <span class="nf">git_config_bool_or_int</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_bool</span><span class="p">)</span>
<a name="c1-455"></a><span class="lineno"> 455</span> <span class="p">{</span>
<a name="c1-456"></a><span class="lineno"> 456</span>   <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">git_config_maybe_bool_text</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-457"></a><span class="lineno"> 457</span>   <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-458"></a><span class="lineno"> 458</span>     <span class="o">*</span><span class="n">is_bool</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-459"></a><span class="lineno"> 459</span>     <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<a name="c1-460"></a><span class="lineno"> 460</span>   <span class="p">}</span>
<a name="c1-461"></a><span class="lineno"> 461</span>   <span class="o">*</span><span class="n">is_bool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-462"></a><span class="lineno"> 462</span>   <span class="k">return</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-463"></a><span class="lineno"> 463</span> <span class="p">}</span>
<a name="c1-464"></a><span class="lineno"> 464</span> 
<a name="c1-465"></a><span class="lineno"> 465</span> <span class="kt">int</span> <span class="nf">git_config_bool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-466"></a><span class="lineno"> 466</span> <span class="p">{</span>
<a name="c1-467"></a><span class="lineno"> 467</span>   <span class="kt">int</span> <span class="n">discard</span><span class="p">;</span>
<a name="c1-468"></a><span class="lineno"> 468</span>   <span class="k">return</span> <span class="o">!!</span><span class="n">git_config_bool_or_int</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard</span><span class="p">);</span>
<a name="c1-469"></a><span class="lineno"> 469</span> <span class="p">}</span>
<a name="c1-470"></a><span class="lineno"> 470</span> 
<a name="c1-471"></a><span class="lineno"> 471</span> <span class="kt">int</span> <span class="nf">git_config_string</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-472"></a><span class="lineno"> 472</span> <span class="p">{</span>
<a name="c1-473"></a><span class="lineno"> 473</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-474"></a><span class="lineno"> 474</span>     <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-475"></a><span class="lineno"> 475</span>   <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="c1-476"></a><span class="lineno"> 476</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-477"></a><span class="lineno"> 477</span> <span class="p">}</span>
<a name="c1-478"></a><span class="lineno"> 478</span> 
<a name="c1-479"></a><span class="lineno"> 479</span> <span class="kt">int</span> <span class="nf">git_config_pathname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-480"></a><span class="lineno"> 480</span> <span class="p">{</span>
<a name="c1-481"></a><span class="lineno"> 481</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-482"></a><span class="lineno"> 482</span>     <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-483"></a><span class="lineno"> 483</span>   <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">expand_user_path</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="c1-484"></a><span class="lineno"> 484</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">dest</span><span class="p">)</span>
<a name="c1-485"></a><span class="lineno"> 485</span>     <span class="n">die</span><span class="p">(</span><span class="s">"Failed to expand user dir in: '%s'"</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-486"></a><span class="lineno"> 486</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-487"></a><span class="lineno"> 487</span> <span class="p">}</span>
<a name="c1-488"></a><span class="lineno"> 488</span> 
<a name="c1-489"></a><span class="lineno"> 489</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_default_core_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-490"></a><span class="lineno"> 490</span> <span class="p">{</span>
<a name="c1-491"></a><span class="lineno"> 491</span>   <span class="cm">/* This needs a better name */</span>
<a name="c1-492"></a><span class="lineno"> 492</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.filemode"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-493"></a><span class="lineno"> 493</span>     <span class="n">trust_executable_bit</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-494"></a><span class="lineno"> 494</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-495"></a><span class="lineno"> 495</span>   <span class="p">}</span>
<a name="c1-496"></a><span class="lineno"> 496</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.trustctime"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-497"></a><span class="lineno"> 497</span>     <span class="n">trust_ctime</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-498"></a><span class="lineno"> 498</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-499"></a><span class="lineno"> 499</span>   <span class="p">}</span>
<a name="c1-500"></a><span class="lineno"> 500</span> 
<a name="c1-501"></a><span class="lineno"> 501</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.quotepath"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-502"></a><span class="lineno"> 502</span>     <span class="n">quote_path_fully</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-503"></a><span class="lineno"> 503</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-504"></a><span class="lineno"> 504</span>   <span class="p">}</span>
<a name="c1-505"></a><span class="lineno"> 505</span> 
<a name="c1-506"></a><span class="lineno"> 506</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.symlinks"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-507"></a><span class="lineno"> 507</span>     <span class="n">has_symlinks</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-508"></a><span class="lineno"> 508</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-509"></a><span class="lineno"> 509</span>   <span class="p">}</span>
<a name="c1-510"></a><span class="lineno"> 510</span> 
<a name="c1-511"></a><span class="lineno"> 511</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.ignorecase"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-512"></a><span class="lineno"> 512</span>     <span class="n">ignore_case</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-513"></a><span class="lineno"> 513</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-514"></a><span class="lineno"> 514</span>   <span class="p">}</span>
<a name="c1-515"></a><span class="lineno"> 515</span> 
<a name="c1-516"></a><span class="lineno"> 516</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.attributesfile"</span><span class="p">))</span>
<a name="c1-517"></a><span class="lineno"> 517</span>     <span class="k">return</span> <span class="n">git_config_pathname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">git_attributes_file</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-518"></a><span class="lineno"> 518</span> 
<a name="c1-519"></a><span class="lineno"> 519</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.bare"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-520"></a><span class="lineno"> 520</span>     <span class="n">is_bare_repository_cfg</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-521"></a><span class="lineno"> 521</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-522"></a><span class="lineno"> 522</span>   <span class="p">}</span>
<a name="c1-523"></a><span class="lineno"> 523</span> 
<a name="c1-524"></a><span class="lineno"> 524</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.ignorestat"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-525"></a><span class="lineno"> 525</span>     <span class="n">assume_unchanged</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-526"></a><span class="lineno"> 526</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-527"></a><span class="lineno"> 527</span>   <span class="p">}</span>
<a name="c1-528"></a><span class="lineno"> 528</span> 
<a name="c1-529"></a><span class="lineno"> 529</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.prefersymlinkrefs"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-530"></a><span class="lineno"> 530</span> <span class="hll">   <span class="n">prefer_symlink_refs</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><a name="c1-531"></a><span class="lineno"> 531</span> <span class="hll">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-532"></a><span class="lineno"> 532</span> <span class="hll"> <span class="p">}</span>
</span><a name="c1-533"></a><span class="lineno"> 533</span> <span class="hll">
</span><a name="c1-534"></a><span class="lineno"> 534</span> <span class="hll"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.logallrefupdates"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-535"></a><span class="lineno"> 535</span> <span class="hll">   <span class="n">log_all_ref_updates</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><a name="c1-536"></a><span class="lineno"> 536</span> <span class="hll">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-537"></a><span class="lineno"> 537</span> <span class="hll"> <span class="p">}</span>
</span><a name="c1-538"></a><span class="lineno"> 538</span> <span class="hll">
</span><a name="c1-539"></a><span class="lineno"> 539</span> <span class="hll"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.warnambiguousrefs"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-540"></a><span class="lineno"> 540</span> <span class="hll">   <span class="n">warn_ambiguous_refs</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><a name="c1-541"></a><span class="lineno"> 541</span> <span class="hll">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-542"></a><span class="lineno"> 542</span> <span class="hll"> <span class="p">}</span>
</span><a name="c1-543"></a><span class="lineno"> 543</span> <span class="hll">
</span><a name="c1-544"></a><span class="lineno"> 544</span> <span class="hll"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.abbrev"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-545"></a><span class="lineno"> 545</span> <span class="hll">   <span class="kt">int</span> <span class="n">abbrev</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><a name="c1-546"></a><span class="lineno"> 546</span> <span class="hll">   <span class="k">if</span> <span class="p">(</span><span class="n">abbrev</span> <span class="o">&lt;</span> <span class="n">minimum_abbrev</span> <span class="o">||</span> <span class="n">abbrev</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
</span><a name="c1-547"></a><span class="lineno"> 547</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-548"></a><span class="lineno"> 548</span>     <span class="n">default_abbrev</span> <span class="o">=</span> <span class="n">abbrev</span><span class="p">;</span>
<a name="c1-549"></a><span class="lineno"> 549</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-550"></a><span class="lineno"> 550</span>   <span class="p">}</span>
<a name="c1-551"></a><span class="lineno"> 551</span> 
<a name="c1-552"></a><span class="lineno"> 552</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.loosecompression"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-553"></a><span class="lineno"> 553</span>     <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-554"></a><span class="lineno"> 554</span>     <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="c1-555"></a><span class="lineno"> 555</span>       <span class="n">level</span> <span class="o">=</span> <span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">;</span>
<a name="c1-556"></a><span class="lineno"> 556</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">Z_BEST_COMPRESSION</span><span class="p">)</span>
<a name="c1-557"></a><span class="lineno"> 557</span>       <span class="n">die</span><span class="p">(</span><span class="s">"bad zlib compression level %d"</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<a name="c1-558"></a><span class="lineno"> 558</span>     <span class="n">zlib_compression_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<a name="c1-559"></a><span class="lineno"> 559</span>     <span class="n">zlib_compression_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-560"></a><span class="lineno"> 560</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-561"></a><span class="lineno"> 561</span>   <span class="p">}</span>
<a name="c1-562"></a><span class="lineno"> 562</span> 
<a name="c1-563"></a><span class="lineno"> 563</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.compression"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-564"></a><span class="lineno"> 564</span>     <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">git_config_int</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-565"></a><span class="lineno"> 565</span>     <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="c1-566"></a><span class="lineno"> 566</span>       <span class="n">level</span> <span class="o">=</span> <span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">;</span>
<a name="c1-567"></a><span class="lineno"> 567</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">Z_BEST_COMPRESSION</span><span class="p">)</span>
<a name="c1-568"></a><span class="lineno"> 568</span>       <span class="n">die</span><span class="p">(</span><span class="s">"bad zlib compression level %d"</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<a name="c1-569"></a><span class="lineno"> 569</span>     <span class="n">core_compression_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<a name="c1-570"></a><span class="lineno"> 570</span>     <span class="n">core_compression_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-571"></a><span class="lineno"> 571</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zlib_compression_seen</span><span class="p">)</span>
<a name="c1-572"></a><span class="lineno"> 572</span>       <span class="n">zlib_compression_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
<a name="c1-573"></a><span class="lineno"> 573</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-574"></a><span class="lineno"> 574</span>   <span class="p">}</span>
<a name="c1-575"></a><span class="lineno"> 575</span> 
<a name="c1-576"></a><span class="lineno"> 576</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.packedgitwindowsize"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-577"></a><span class="lineno"> 577</span>     <span class="kt">int</span> <span class="n">pgsz_x2</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<a name="c1-578"></a><span class="lineno"> 578</span>     <span class="n">packed_git_window_size</span> <span class="o">=</span> <span class="n">git_config_ulong</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-579"></a><span class="lineno"> 579</span> 
<a name="c1-580"></a><span class="lineno"> 580</span>     <span class="cm">/* This value must be multiple of (pagesize * 2) */</span>
<a name="c1-581"></a><span class="lineno"> 581</span>     <span class="n">packed_git_window_size</span> <span class="o">/=</span> <span class="n">pgsz_x2</span><span class="p">;</span>
<a name="c1-582"></a><span class="lineno"> 582</span>     <span class="k">if</span> <span class="p">(</span><span class="n">packed_git_window_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
<a name="c1-583"></a><span class="lineno"> 583</span>       <span class="n">packed_git_window_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-584"></a><span class="lineno"> 584</span>     <span class="n">packed_git_window_size</span> <span class="o">*=</span> <span class="n">pgsz_x2</span><span class="p">;</span>
<a name="c1-585"></a><span class="lineno"> 585</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-586"></a><span class="lineno"> 586</span>   <span class="p">}</span>
<a name="c1-587"></a><span class="lineno"> 587</span> 
<a name="c1-588"></a><span class="lineno"> 588</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.bigfilethreshold"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-589"></a><span class="lineno"> 589</span>     <span class="n">big_file_threshold</span> <span class="o">=</span> <span class="n">git_config_ulong</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-590"></a><span class="lineno"> 590</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-591"></a><span class="lineno"> 591</span>   <span class="p">}</span>
<a name="c1-592"></a><span class="lineno"> 592</span> 
<a name="c1-593"></a><span class="lineno"> 593</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.packedgitlimit"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-594"></a><span class="lineno"> 594</span>     <span class="n">packed_git_limit</span> <span class="o">=</span> <span class="n">git_config_ulong</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-595"></a><span class="lineno"> 595</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-596"></a><span class="lineno"> 596</span>   <span class="p">}</span>
<a name="c1-597"></a><span class="lineno"> 597</span> 
<a name="c1-598"></a><span class="lineno"> 598</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.deltabasecachelimit"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-599"></a><span class="lineno"> 599</span>     <span class="n">delta_base_cache_limit</span> <span class="o">=</span> <span class="n">git_config_ulong</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-600"></a><span class="lineno"> 600</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-601"></a><span class="lineno"> 601</span>   <span class="p">}</span>
<a name="c1-602"></a><span class="lineno"> 602</span> 
<a name="c1-603"></a><span class="lineno"> 603</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.logpackaccess"</span><span class="p">))</span>
<a name="c1-604"></a><span class="lineno"> 604</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">log_pack_access</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-605"></a><span class="lineno"> 605</span> 
<a name="c1-606"></a><span class="lineno"> 606</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.autocrlf"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-607"></a><span class="lineno"> 607</span>     <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"input"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-608"></a><span class="lineno"> 608</span>       <span class="k">if</span> <span class="p">(</span><span class="n">core_eol</span> <span class="o">==</span> <span class="n">EOL_CRLF</span><span class="p">)</span>
<a name="c1-609"></a><span class="lineno"> 609</span>         <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"core.autocrlf=input conflicts with core.eol=crlf"</span><span class="p">);</span>
<a name="c1-610"></a><span class="lineno"> 610</span>       <span class="n">auto_crlf</span> <span class="o">=</span> <span class="n">AUTO_CRLF_INPUT</span><span class="p">;</span>
<a name="c1-611"></a><span class="lineno"> 611</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-612"></a><span class="lineno"> 612</span>     <span class="p">}</span>
<a name="c1-613"></a><span class="lineno"> 613</span>     <span class="n">auto_crlf</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-614"></a><span class="lineno"> 614</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-615"></a><span class="lineno"> 615</span>   <span class="p">}</span>
<a name="c1-616"></a><span class="lineno"> 616</span> 
<a name="c1-617"></a><span class="lineno"> 617</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.safecrlf"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-618"></a><span class="lineno"> 618</span>     <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"warn"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-619"></a><span class="lineno"> 619</span>       <span class="n">safe_crlf</span> <span class="o">=</span> <span class="n">SAFE_CRLF_WARN</span><span class="p">;</span>
<a name="c1-620"></a><span class="lineno"> 620</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-621"></a><span class="lineno"> 621</span>     <span class="p">}</span>
<a name="c1-622"></a><span class="lineno"> 622</span>     <span class="n">safe_crlf</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-623"></a><span class="lineno"> 623</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-624"></a><span class="lineno"> 624</span>   <span class="p">}</span>
<a name="c1-625"></a><span class="lineno"> 625</span> 
<a name="c1-626"></a><span class="lineno"> 626</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.eol"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-627"></a><span class="lineno"> 627</span>     <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"lf"</span><span class="p">))</span>
<a name="c1-628"></a><span class="lineno"> 628</span>       <span class="n">core_eol</span> <span class="o">=</span> <span class="n">EOL_LF</span><span class="p">;</span>
<a name="c1-629"></a><span class="lineno"> 629</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"crlf"</span><span class="p">))</span>
<a name="c1-630"></a><span class="lineno"> 630</span>       <span class="n">core_eol</span> <span class="o">=</span> <span class="n">EOL_CRLF</span><span class="p">;</span>
<a name="c1-631"></a><span class="lineno"> 631</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"native"</span><span class="p">))</span>
<a name="c1-632"></a><span class="lineno"> 632</span>       <span class="n">core_eol</span> <span class="o">=</span> <span class="n">EOL_NATIVE</span><span class="p">;</span>
<a name="c1-633"></a><span class="lineno"> 633</span>     <span class="k">else</span>
<a name="c1-634"></a><span class="lineno"> 634</span>       <span class="n">core_eol</span> <span class="o">=</span> <span class="n">EOL_UNSET</span><span class="p">;</span>
<a name="c1-635"></a><span class="lineno"> 635</span>     <span class="k">if</span> <span class="p">(</span><span class="n">core_eol</span> <span class="o">==</span> <span class="n">EOL_CRLF</span> <span class="o">&amp;&amp;</span> <span class="n">auto_crlf</span> <span class="o">==</span> <span class="n">AUTO_CRLF_INPUT</span><span class="p">)</span>
<a name="c1-636"></a><span class="lineno"> 636</span>       <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"core.autocrlf=input conflicts with core.eol=crlf"</span><span class="p">);</span>
<a name="c1-637"></a><span class="lineno"> 637</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-638"></a><span class="lineno"> 638</span>   <span class="p">}</span>
<a name="c1-639"></a><span class="lineno"> 639</span> 
<a name="c1-640"></a><span class="lineno"> 640</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.notesref"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-641"></a><span class="lineno"> 641</span>     <span class="n">notes_ref_name</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="c1-642"></a><span class="lineno"> 642</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-643"></a><span class="lineno"> 643</span>   <span class="p">}</span>
<a name="c1-644"></a><span class="lineno"> 644</span> 
<a name="c1-645"></a><span class="lineno"> 645</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.pager"</span><span class="p">))</span>
<a name="c1-646"></a><span class="lineno"> 646</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pager_program</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-647"></a><span class="lineno"> 647</span> 
<a name="c1-648"></a><span class="lineno"> 648</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.editor"</span><span class="p">))</span>
<a name="c1-649"></a><span class="lineno"> 649</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">editor_program</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-650"></a><span class="lineno"> 650</span> 
<a name="c1-651"></a><span class="lineno"> 651</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.askpass"</span><span class="p">))</span>
<a name="c1-652"></a><span class="lineno"> 652</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">askpass_program</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-653"></a><span class="lineno"> 653</span> 
<a name="c1-654"></a><span class="lineno"> 654</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.excludesfile"</span><span class="p">))</span>
<a name="c1-655"></a><span class="lineno"> 655</span>     <span class="k">return</span> <span class="n">git_config_pathname</span><span class="p">(</span><span class="o">&amp;</span><span class="n">excludes_file</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-656"></a><span class="lineno"> 656</span> 
<a name="c1-657"></a><span class="lineno"> 657</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.whitespace"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-658"></a><span class="lineno"> 658</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-659"></a><span class="lineno"> 659</span>       <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-660"></a><span class="lineno"> 660</span>     <span class="n">whitespace_rule_cfg</span> <span class="o">=</span> <span class="n">parse_whitespace_rule</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="c1-661"></a><span class="lineno"> 661</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-662"></a><span class="lineno"> 662</span>   <span class="p">}</span>
<a name="c1-663"></a><span class="lineno"> 663</span> 
<a name="c1-664"></a><span class="lineno"> 664</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.fsyncobjectfiles"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-665"></a><span class="lineno"> 665</span>     <span class="n">fsync_object_files</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-666"></a><span class="lineno"> 666</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-667"></a><span class="lineno"> 667</span>   <span class="p">}</span>
<a name="c1-668"></a><span class="lineno"> 668</span> 
<a name="c1-669"></a><span class="lineno"> 669</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.preloadindex"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-670"></a><span class="lineno"> 670</span>     <span class="n">core_preload_index</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-671"></a><span class="lineno"> 671</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-672"></a><span class="lineno"> 672</span>   <span class="p">}</span>
<a name="c1-673"></a><span class="lineno"> 673</span> 
<a name="c1-674"></a><span class="lineno"> 674</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.createobject"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-675"></a><span class="lineno"> 675</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"rename"</span><span class="p">))</span>
<a name="c1-676"></a><span class="lineno"> 676</span>       <span class="n">object_creation_mode</span> <span class="o">=</span> <span class="n">OBJECT_CREATION_USES_RENAMES</span><span class="p">;</span>
<a name="c1-677"></a><span class="lineno"> 677</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"link"</span><span class="p">))</span>
<a name="c1-678"></a><span class="lineno"> 678</span>       <span class="n">object_creation_mode</span> <span class="o">=</span> <span class="n">OBJECT_CREATION_USES_HARDLINKS</span><span class="p">;</span>
<a name="c1-679"></a><span class="lineno"> 679</span>     <span class="k">else</span>
<a name="c1-680"></a><span class="lineno"> 680</span>       <span class="n">die</span><span class="p">(</span><span class="s">"Invalid mode for object creation: %s"</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-681"></a><span class="lineno"> 681</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-682"></a><span class="lineno"> 682</span>   <span class="p">}</span>
<a name="c1-683"></a><span class="lineno"> 683</span> 
<a name="c1-684"></a><span class="lineno"> 684</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core.sparsecheckout"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-685"></a><span class="lineno"> 685</span>     <span class="n">core_apply_sparse_checkout</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-686"></a><span class="lineno"> 686</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-687"></a><span class="lineno"> 687</span>   <span class="p">}</span>
<a name="c1-688"></a><span class="lineno"> 688</span> 
<a name="c1-689"></a><span class="lineno"> 689</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-690"></a><span class="lineno"> 690</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-691"></a><span class="lineno"> 691</span> <span class="p">}</span>
<a name="c1-692"></a><span class="lineno"> 692</span> 
<a name="c1-693"></a><span class="lineno"> 693</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_default_user_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-694"></a><span class="lineno"> 694</span> <span class="p">{</span>
<a name="c1-695"></a><span class="lineno"> 695</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"user.name"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-696"></a><span class="lineno"> 696</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-697"></a><span class="lineno"> 697</span>       <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-698"></a><span class="lineno"> 698</span>     <span class="n">strlcpy</span><span class="p">(</span><span class="n">git_default_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">git_default_name</span><span class="p">));</span>
<a name="c1-699"></a><span class="lineno"> 699</span>     <span class="n">user_ident_explicitly_given</span> <span class="o">|=</span> <span class="n">IDENT_NAME_GIVEN</span><span class="p">;</span>
<a name="c1-700"></a><span class="lineno"> 700</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-701"></a><span class="lineno"> 701</span>   <span class="p">}</span>
<a name="c1-702"></a><span class="lineno"> 702</span> 
<a name="c1-703"></a><span class="lineno"> 703</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"user.email"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-704"></a><span class="lineno"> 704</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-705"></a><span class="lineno"> 705</span>       <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-706"></a><span class="lineno"> 706</span>     <span class="n">strlcpy</span><span class="p">(</span><span class="n">git_default_email</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">git_default_email</span><span class="p">));</span>
<a name="c1-707"></a><span class="lineno"> 707</span>     <span class="n">user_ident_explicitly_given</span> <span class="o">|=</span> <span class="n">IDENT_MAIL_GIVEN</span><span class="p">;</span>
<a name="c1-708"></a><span class="lineno"> 708</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-709"></a><span class="lineno"> 709</span>   <span class="p">}</span>
<a name="c1-710"></a><span class="lineno"> 710</span> 
<a name="c1-711"></a><span class="lineno"> 711</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-712"></a><span class="lineno"> 712</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-713"></a><span class="lineno"> 713</span> <span class="p">}</span>
<a name="c1-714"></a><span class="lineno"> 714</span> 
<a name="c1-715"></a><span class="lineno"> 715</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_default_i18n_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-716"></a><span class="lineno"> 716</span> <span class="p">{</span>
<a name="c1-717"></a><span class="lineno"> 717</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"i18n.commitencoding"</span><span class="p">))</span>
<a name="c1-718"></a><span class="lineno"> 718</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">git_commit_encoding</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-719"></a><span class="lineno"> 719</span> 
<a name="c1-720"></a><span class="lineno"> 720</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"i18n.logoutputencoding"</span><span class="p">))</span>
<a name="c1-721"></a><span class="lineno"> 721</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">git_log_output_encoding</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-722"></a><span class="lineno"> 722</span> 
<a name="c1-723"></a><span class="lineno"> 723</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-724"></a><span class="lineno"> 724</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-725"></a><span class="lineno"> 725</span> <span class="p">}</span>
<a name="c1-726"></a><span class="lineno"> 726</span> 
<a name="c1-727"></a><span class="lineno"> 727</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_default_branch_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-728"></a><span class="lineno"> 728</span> <span class="p">{</span>
<a name="c1-729"></a><span class="lineno"> 729</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"branch.autosetupmerge"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-730"></a><span class="lineno"> 730</span>     <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"always"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-731"></a><span class="lineno"> 731</span>       <span class="n">git_branch_track</span> <span class="o">=</span> <span class="n">BRANCH_TRACK_ALWAYS</span><span class="p">;</span>
<a name="c1-732"></a><span class="lineno"> 732</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-733"></a><span class="lineno"> 733</span>     <span class="p">}</span>
<a name="c1-734"></a><span class="lineno"> 734</span>     <span class="n">git_branch_track</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-735"></a><span class="lineno"> 735</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-736"></a><span class="lineno"> 736</span>   <span class="p">}</span>
<a name="c1-737"></a><span class="lineno"> 737</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"branch.autosetuprebase"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-738"></a><span class="lineno"> 738</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-739"></a><span class="lineno"> 739</span>       <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-740"></a><span class="lineno"> 740</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"never"</span><span class="p">))</span>
<a name="c1-741"></a><span class="lineno"> 741</span>       <span class="n">autorebase</span> <span class="o">=</span> <span class="n">AUTOREBASE_NEVER</span><span class="p">;</span>
<a name="c1-742"></a><span class="lineno"> 742</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"local"</span><span class="p">))</span>
<a name="c1-743"></a><span class="lineno"> 743</span>       <span class="n">autorebase</span> <span class="o">=</span> <span class="n">AUTOREBASE_LOCAL</span><span class="p">;</span>
<a name="c1-744"></a><span class="lineno"> 744</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"remote"</span><span class="p">))</span>
<a name="c1-745"></a><span class="lineno"> 745</span>       <span class="n">autorebase</span> <span class="o">=</span> <span class="n">AUTOREBASE_REMOTE</span><span class="p">;</span>
<a name="c1-746"></a><span class="lineno"> 746</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"always"</span><span class="p">))</span>
<a name="c1-747"></a><span class="lineno"> 747</span>       <span class="n">autorebase</span> <span class="o">=</span> <span class="n">AUTOREBASE_ALWAYS</span><span class="p">;</span>
<a name="c1-748"></a><span class="lineno"> 748</span>     <span class="k">else</span>
<a name="c1-749"></a><span class="lineno"> 749</span>       <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"Malformed value for %s"</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
<a name="c1-750"></a><span class="lineno"> 750</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-751"></a><span class="lineno"> 751</span>   <span class="p">}</span>
<a name="c1-752"></a><span class="lineno"> 752</span> 
<a name="c1-753"></a><span class="lineno"> 753</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-754"></a><span class="lineno"> 754</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-755"></a><span class="lineno"> 755</span> <span class="p">}</span>
<a name="c1-756"></a><span class="lineno"> 756</span> 
<a name="c1-757"></a><span class="lineno"> 757</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_default_push_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-758"></a><span class="lineno"> 758</span> <span class="p">{</span>
<a name="c1-759"></a><span class="lineno"> 759</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"push.default"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-760"></a><span class="lineno"> 760</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
<a name="c1-761"></a><span class="lineno"> 761</span>       <span class="k">return</span> <span class="n">config_error_nonbool</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
<a name="c1-762"></a><span class="lineno"> 762</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"nothing"</span><span class="p">))</span>
<a name="c1-763"></a><span class="lineno"> 763</span>       <span class="n">push_default</span> <span class="o">=</span> <span class="n">PUSH_DEFAULT_NOTHING</span><span class="p">;</span>
<a name="c1-764"></a><span class="lineno"> 764</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"matching"</span><span class="p">))</span>
<a name="c1-765"></a><span class="lineno"> 765</span>       <span class="n">push_default</span> <span class="o">=</span> <span class="n">PUSH_DEFAULT_MATCHING</span><span class="p">;</span>
<a name="c1-766"></a><span class="lineno"> 766</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"upstream"</span><span class="p">))</span>
<a name="c1-767"></a><span class="lineno"> 767</span>       <span class="n">push_default</span> <span class="o">=</span> <span class="n">PUSH_DEFAULT_UPSTREAM</span><span class="p">;</span>
<a name="c1-768"></a><span class="lineno"> 768</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"tracking"</span><span class="p">))</span> <span class="cm">/* deprecated */</span>
<a name="c1-769"></a><span class="lineno"> 769</span>       <span class="n">push_default</span> <span class="o">=</span> <span class="n">PUSH_DEFAULT_UPSTREAM</span><span class="p">;</span>
<a name="c1-770"></a><span class="lineno"> 770</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"current"</span><span class="p">))</span>
<a name="c1-771"></a><span class="lineno"> 771</span>       <span class="n">push_default</span> <span class="o">=</span> <span class="n">PUSH_DEFAULT_CURRENT</span><span class="p">;</span>
<a name="c1-772"></a><span class="lineno"> 772</span>     <span class="k">else</span> <span class="p">{</span>
<a name="c1-773"></a><span class="lineno"> 773</span>       <span class="n">error</span><span class="p">(</span><span class="s">"Malformed value for %s: %s"</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-774"></a><span class="lineno"> 774</span>       <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"Must be one of nothing, matching, "</span>
<a name="c1-775"></a><span class="lineno"> 775</span>              <span class="s">"tracking or current."</span><span class="p">);</span>
<a name="c1-776"></a><span class="lineno"> 776</span>     <span class="p">}</span>
<a name="c1-777"></a><span class="lineno"> 777</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-778"></a><span class="lineno"> 778</span>   <span class="p">}</span>
<a name="c1-779"></a><span class="lineno"> 779</span> 
<a name="c1-780"></a><span class="lineno"> 780</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-781"></a><span class="lineno"> 781</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-782"></a><span class="lineno"> 782</span> <span class="p">}</span>
<a name="c1-783"></a><span class="lineno"> 783</span> 
<a name="c1-784"></a><span class="lineno"> 784</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_default_mailmap_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-785"></a><span class="lineno"> 785</span> <span class="p">{</span>
<a name="c1-786"></a><span class="lineno"> 786</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"mailmap.file"</span><span class="p">))</span>
<a name="c1-787"></a><span class="lineno"> 787</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">git_mailmap_file</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-788"></a><span class="lineno"> 788</span> 
<a name="c1-789"></a><span class="lineno"> 789</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-790"></a><span class="lineno"> 790</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-791"></a><span class="lineno"> 791</span> <span class="p">}</span>
<a name="c1-792"></a><span class="lineno"> 792</span> 
<a name="c1-793"></a><span class="lineno"> 793</span> <span class="kt">int</span> <span class="nf">git_default_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<a name="c1-794"></a><span class="lineno"> 794</span> <span class="p">{</span>
<a name="c1-795"></a><span class="lineno"> 795</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"core."</span><span class="p">))</span>
<a name="c1-796"></a><span class="lineno"> 796</span>     <span class="k">return</span> <span class="n">git_default_core_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-797"></a><span class="lineno"> 797</span> 
<a name="c1-798"></a><span class="lineno"> 798</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"user."</span><span class="p">))</span>
<a name="c1-799"></a><span class="lineno"> 799</span>     <span class="k">return</span> <span class="n">git_default_user_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-800"></a><span class="lineno"> 800</span> 
<a name="c1-801"></a><span class="lineno"> 801</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"i18n."</span><span class="p">))</span>
<a name="c1-802"></a><span class="lineno"> 802</span>     <span class="k">return</span> <span class="n">git_default_i18n_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-803"></a><span class="lineno"> 803</span> 
<a name="c1-804"></a><span class="lineno"> 804</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"branch."</span><span class="p">))</span>
<a name="c1-805"></a><span class="lineno"> 805</span>     <span class="k">return</span> <span class="n">git_default_branch_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-806"></a><span class="lineno"> 806</span> 
<a name="c1-807"></a><span class="lineno"> 807</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"push."</span><span class="p">))</span>
<a name="c1-808"></a><span class="lineno"> 808</span>     <span class="k">return</span> <span class="n">git_default_push_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-809"></a><span class="lineno"> 809</span> 
<a name="c1-810"></a><span class="lineno"> 810</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"mailmap."</span><span class="p">))</span>
<a name="c1-811"></a><span class="lineno"> 811</span>     <span class="k">return</span> <span class="n">git_default_mailmap_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-812"></a><span class="lineno"> 812</span> 
<a name="c1-813"></a><span class="lineno"> 813</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"advice."</span><span class="p">))</span>
<a name="c1-814"></a><span class="lineno"> 814</span>     <span class="k">return</span> <span class="n">git_default_advice_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-815"></a><span class="lineno"> 815</span> 
<a name="c1-816"></a><span class="lineno"> 816</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"pager.color"</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"color.pager"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-817"></a><span class="lineno"> 817</span>     <span class="n">pager_use_color</span> <span class="o">=</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
<a name="c1-818"></a><span class="lineno"> 818</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-819"></a><span class="lineno"> 819</span>   <span class="p">}</span>
<a name="c1-820"></a><span class="lineno"> 820</span> 
<a name="c1-821"></a><span class="lineno"> 821</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"pack.packsizelimit"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-822"></a><span class="lineno"> 822</span>     <span class="n">pack_size_limit_cfg</span> <span class="o">=</span> <span class="n">git_config_ulong</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-823"></a><span class="lineno"> 823</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-824"></a><span class="lineno"> 824</span>   <span class="p">}</span>
<a name="c1-825"></a><span class="lineno"> 825</span>   <span class="cm">/* Add other config variables here and to Documentation/config.txt. */</span>
<a name="c1-826"></a><span class="lineno"> 826</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-827"></a><span class="lineno"> 827</span> <span class="p">}</span>
<a name="c1-828"></a><span class="lineno"> 828</span> 
<a name="c1-829"></a><span class="lineno"> 829</span> <span class="kt">int</span> <span class="nf">git_config_from_file</span><span class="p">(</span><span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-830"></a><span class="lineno"> 830</span> <span class="p">{</span>
<a name="c1-831"></a><span class="lineno"> 831</span>   <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-832"></a><span class="lineno"> 832</span>   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
<a name="c1-833"></a><span class="lineno"> 833</span> 
<a name="c1-834"></a><span class="lineno"> 834</span>   <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-835"></a><span class="lineno"> 835</span>   <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-836"></a><span class="lineno"> 836</span>     <span class="n">config_file</span> <span class="n">top</span><span class="p">;</span>
<a name="c1-837"></a><span class="lineno"> 837</span> 
<a name="c1-838"></a><span class="lineno"> 838</span>     <span class="cm">/* push config-file parsing state stack */</span>
<a name="c1-839"></a><span class="lineno"> 839</span>     <span class="n">top</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cf</span><span class="p">;</span>
<a name="c1-840"></a><span class="lineno"> 840</span>     <span class="n">top</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
<a name="c1-841"></a><span class="lineno"> 841</span>     <span class="n">top</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
<a name="c1-842"></a><span class="lineno"> 842</span>     <span class="n">top</span><span class="p">.</span><span class="n">linenr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-843"></a><span class="lineno"> 843</span>     <span class="n">top</span><span class="p">.</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-844"></a><span class="lineno"> 844</span>     <span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
<a name="c1-845"></a><span class="lineno"> 845</span>     <span class="n">cf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">top</span><span class="p">;</span>
<a name="c1-846"></a><span class="lineno"> 846</span> 
<a name="c1-847"></a><span class="lineno"> 847</span>     <span class="n">ret</span> <span class="o">=</span> <span class="n">git_parse_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c1-848"></a><span class="lineno"> 848</span> 
<a name="c1-849"></a><span class="lineno"> 849</span>     <span class="cm">/* pop config-file parsing state stack */</span>
<a name="c1-850"></a><span class="lineno"> 850</span>     <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">top</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<a name="c1-851"></a><span class="lineno"> 851</span>     <span class="n">cf</span> <span class="o">=</span> <span class="n">top</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
<a name="c1-852"></a><span class="lineno"> 852</span> 
<a name="c1-853"></a><span class="lineno"> 853</span>     <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-854"></a><span class="lineno"> 854</span>   <span class="p">}</span>
<a name="c1-855"></a><span class="lineno"> 855</span>   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-856"></a><span class="lineno"> 856</span> <span class="p">}</span>
<a name="c1-857"></a><span class="lineno"> 857</span> 
<a name="c1-858"></a><span class="lineno"> 858</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">git_etc_gitconfig</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c1-859"></a><span class="lineno"> 859</span> <span class="p">{</span>
<a name="c1-860"></a><span class="lineno"> 860</span>   <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">system_wide</span><span class="p">;</span>
<a name="c1-861"></a><span class="lineno"> 861</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">system_wide</span><span class="p">)</span>
<a name="c1-862"></a><span class="lineno"> 862</span>     <span class="n">system_wide</span> <span class="o">=</span> <span class="n">system_path</span><span class="p">(</span><span class="n">ETC_GITCONFIG</span><span class="p">);</span>
<a name="c1-863"></a><span class="lineno"> 863</span>   <span class="k">return</span> <span class="n">system_wide</span><span class="p">;</span>
<a name="c1-864"></a><span class="lineno"> 864</span> <span class="p">}</span>
<a name="c1-865"></a><span class="lineno"> 865</span> 
<a name="c1-866"></a><span class="lineno"> 866</span> <span class="kt">int</span> <span class="nf">git_env_bool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">k</span><span class="p">,</span> <span class="kt">int</span> <span class="n">def</span><span class="p">)</span>
<a name="c1-867"></a><span class="lineno"> 867</span> <span class="p">{</span>
<a name="c1-868"></a><span class="lineno"> 868</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<a name="c1-869"></a><span class="lineno"> 869</span>   <span class="k">return</span> <span class="n">v</span> <span class="o">?</span> <span class="n">git_config_bool</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span> <span class="n">def</span><span class="p">;</span>
<a name="c1-870"></a><span class="lineno"> 870</span> <span class="p">}</span>
<a name="c1-871"></a><span class="lineno"> 871</span> 
<a name="c1-872"></a><span class="lineno"> 872</span> <span class="kt">int</span> <span class="nf">git_config_system</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c1-873"></a><span class="lineno"> 873</span> <span class="p">{</span>
<a name="c1-874"></a><span class="lineno"> 874</span>   <span class="k">return</span> <span class="o">!</span><span class="n">git_env_bool</span><span class="p">(</span><span class="s">"GIT_CONFIG_NOSYSTEM"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-875"></a><span class="lineno"> 875</span> <span class="p">}</span>
<a name="c1-876"></a><span class="lineno"> 876</span> 
<a name="c1-877"></a><span class="lineno"> 877</span> <span class="kt">int</span> <span class="nf">git_config_early</span><span class="p">(</span><span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">repo_config</span><span class="p">)</span>
<a name="c1-878"></a><span class="lineno"> 878</span> <span class="p">{</span>
<a name="c1-879"></a><span class="lineno"> 879</span>   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-880"></a><span class="lineno"> 880</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">home</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-881"></a><span class="lineno"> 881</span> 
<a name="c1-882"></a><span class="lineno"> 882</span>   <span class="cm">/* Setting $GIT_CONFIG makes git read _only_ the given config file. */</span>
<a name="c1-883"></a><span class="lineno"> 883</span>   <span class="k">if</span> <span class="p">(</span><span class="n">config_exclusive_filename</span><span class="p">)</span>
<a name="c1-884"></a><span class="lineno"> 884</span>     <span class="k">return</span> <span class="n">git_config_from_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">config_exclusive_filename</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c1-885"></a><span class="lineno"> 885</span>   <span class="k">if</span> <span class="p">(</span><span class="n">git_config_system</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access</span><span class="p">(</span><span class="n">git_etc_gitconfig</span><span class="p">(),</span> <span class="n">R_OK</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-886"></a><span class="lineno"> 886</span>     <span class="n">ret</span> <span class="o">+=</span> <span class="n">git_config_from_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">git_etc_gitconfig</span><span class="p">(),</span>
<a name="c1-887"></a><span class="lineno"> 887</span>               <span class="n">data</span><span class="p">);</span>
<a name="c1-888"></a><span class="lineno"> 888</span>     <span class="n">found</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-889"></a><span class="lineno"> 889</span>   <span class="p">}</span>
<a name="c1-890"></a><span class="lineno"> 890</span> 
<a name="c1-891"></a><span class="lineno"> 891</span>   <span class="n">home</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"HOME"</span><span class="p">);</span>
<a name="c1-892"></a><span class="lineno"> 892</span>   <span class="k">if</span> <span class="p">(</span><span class="n">home</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-893"></a><span class="lineno"> 893</span>     <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
<a name="c1-894"></a><span class="lineno"> 894</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">user_config</span> <span class="o">=</span> <span class="n">mksnpath</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"%s/.gitconfig"</span><span class="p">,</span> <span class="n">home</span><span class="p">);</span>
<a name="c1-895"></a><span class="lineno"> 895</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access</span><span class="p">(</span><span class="n">user_config</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-896"></a><span class="lineno"> 896</span>       <span class="n">ret</span> <span class="o">+=</span> <span class="n">git_config_from_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">user_config</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c1-897"></a><span class="lineno"> 897</span>       <span class="n">found</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-898"></a><span class="lineno"> 898</span>     <span class="p">}</span>
<a name="c1-899"></a><span class="lineno"> 899</span>   <span class="p">}</span>
<a name="c1-900"></a><span class="lineno"> 900</span> 
<a name="c1-901"></a><span class="lineno"> 901</span>   <span class="k">if</span> <span class="p">(</span><span class="n">repo_config</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access</span><span class="p">(</span><span class="n">repo_config</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-902"></a><span class="lineno"> 902</span>     <span class="n">ret</span> <span class="o">+=</span> <span class="n">git_config_from_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">repo_config</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c1-903"></a><span class="lineno"> 903</span>     <span class="n">found</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-904"></a><span class="lineno"> 904</span>   <span class="p">}</span>
<a name="c1-905"></a><span class="lineno"> 905</span> 
<a name="c1-906"></a><span class="lineno"> 906</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">git_config_from_parameters</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-907"></a><span class="lineno"> 907</span>   <span class="k">case</span> <span class="o">-</span><span class="mi">1</span>: <span class="cm">/* error */</span>
<a name="c1-908"></a><span class="lineno"> 908</span>     <span class="n">die</span><span class="p">(</span><span class="s">"unable to parse command-line config"</span><span class="p">);</span>
<a name="c1-909"></a><span class="lineno"> 909</span>     <span class="k">break</span><span class="p">;</span>
<a name="c1-910"></a><span class="lineno"> 910</span>   <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* found nothing */</span>
<a name="c1-911"></a><span class="lineno"> 911</span>     <span class="k">break</span><span class="p">;</span>
<a name="c1-912"></a><span class="lineno"> 912</span>   <span class="nl">default:</span> <span class="cm">/* found at least one item */</span>
<a name="c1-913"></a><span class="lineno"> 913</span>     <span class="n">found</span><span class="o">++</span><span class="p">;</span>
<a name="c1-914"></a><span class="lineno"> 914</span>     <span class="k">break</span><span class="p">;</span>
<a name="c1-915"></a><span class="lineno"> 915</span>   <span class="p">}</span>
<a name="c1-916"></a><span class="lineno"> 916</span> 
<a name="c1-917"></a><span class="lineno"> 917</span>   <span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">found</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-918"></a><span class="lineno"> 918</span> <span class="p">}</span>
<a name="c1-919"></a><span class="lineno"> 919</span> 
<a name="c1-920"></a><span class="lineno"> 920</span> <span class="kt">int</span> <span class="nf">git_config</span><span class="p">(</span><span class="n">config_fn_t</span> <span class="n">fn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-921"></a><span class="lineno"> 921</span> <span class="p">{</span>
<a name="c1-922"></a><span class="lineno"> 922</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">repo_config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-923"></a><span class="lineno"> 923</span>   <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-924"></a><span class="lineno"> 924</span> 
<a name="c1-925"></a><span class="lineno"> 925</span>   <span class="n">repo_config</span> <span class="o">=</span> <span class="n">git_pathdup</span><span class="p">(</span><span class="s">"config"</span><span class="p">);</span>
<a name="c1-926"></a><span class="lineno"> 926</span>   <span class="n">ret</span> <span class="o">=</span> <span class="n">git_config_early</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">repo_config</span><span class="p">);</span>
<a name="c1-927"></a><span class="lineno"> 927</span>   <span class="k">if</span> <span class="p">(</span><span class="n">repo_config</span><span class="p">)</span>
<a name="c1-928"></a><span class="lineno"> 928</span>     <span class="n">free</span><span class="p">(</span><span class="n">repo_config</span><span class="p">);</span>
<a name="c1-929"></a><span class="lineno"> 929</span>   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-930"></a><span class="lineno"> 930</span> <span class="p">}</span>
<a name="c1-931"></a><span class="lineno"> 931</span> 
<a name="c1-932"></a><span class="lineno"> 932</span> <span class="cm">/*</span>
<a name="c1-933"></a><span class="lineno"> 933</span> <span class="cm"> * Find all the stuff for git_config_set() below.</span>
<a name="c1-934"></a><span class="lineno"> 934</span> <span class="cm"> */</span>
<a name="c1-935"></a><span class="lineno"> 935</span> 
<a name="c1-936"></a><span class="lineno"> 936</span> <span class="cp">#define MAX_MATCHES 512</span>
<a name="c1-937"></a><span class="lineno"> 937</span> 
<a name="c1-938"></a><span class="lineno"> 938</span> <span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
<a name="c1-939"></a><span class="lineno"> 939</span>   <span class="kt">int</span> <span class="n">baselen</span><span class="p">;</span>
<a name="c1-940"></a><span class="lineno"> 940</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
<a name="c1-941"></a><span class="lineno"> 941</span>   <span class="kt">int</span> <span class="n">do_not_match</span><span class="p">;</span>
<a name="c1-942"></a><span class="lineno"> 942</span>   <span class="n">regex_t</span> <span class="o">*</span><span class="n">value_regex</span><span class="p">;</span>
<a name="c1-943"></a><span class="lineno"> 943</span>   <span class="kt">int</span> <span class="n">multi_replace</span><span class="p">;</span>
<a name="c1-944"></a><span class="lineno"> 944</span>   <span class="kt">size_t</span> <span class="n">offset</span><span class="p">[</span><span class="n">MAX_MATCHES</span><span class="p">];</span>
<a name="c1-945"></a><span class="lineno"> 945</span>   <span class="k">enum</span> <span class="p">{</span> <span class="n">START</span><span class="p">,</span> <span class="n">SECTION_SEEN</span><span class="p">,</span> <span class="n">SECTION_END_SEEN</span><span class="p">,</span> <span class="n">KEY_SEEN</span> <span class="p">}</span> <span class="n">state</span><span class="p">;</span>
<a name="c1-946"></a><span class="lineno"> 946</span>   <span class="kt">int</span> <span class="n">seen</span><span class="p">;</span>
<a name="c1-947"></a><span class="lineno"> 947</span> <span class="p">}</span> <span class="n">store</span><span class="p">;</span>
<a name="c1-948"></a><span class="lineno"> 948</span> 
<a name="c1-949"></a><span class="lineno"> 949</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">matches</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-950"></a><span class="lineno"> 950</span> <span class="p">{</span>
<a name="c1-951"></a><span class="lineno"> 951</span>   <span class="k">return</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-952"></a><span class="lineno"> 952</span>     <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
<a name="c1-953"></a><span class="lineno"> 953</span>      <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">do_not_match</span> <span class="o">^</span>
<a name="c1-954"></a><span class="lineno"> 954</span>       <span class="o">!</span><span class="n">regexec</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
<a name="c1-955"></a><span class="lineno"> 955</span> <span class="p">}</span>
<a name="c1-956"></a><span class="lineno"> 956</span> 
<a name="c1-957"></a><span class="lineno"> 957</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">store_aux</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<a name="c1-958"></a><span class="lineno"> 958</span> <span class="p">{</span>
<a name="c1-959"></a><span class="lineno"> 959</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
<a name="c1-960"></a><span class="lineno"> 960</span>   <span class="kt">size_t</span> <span class="n">section_len</span><span class="p">;</span>
<a name="c1-961"></a><span class="lineno"> 961</span>   <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">;</span>
<a name="c1-962"></a><span class="lineno"> 962</span> 
<a name="c1-963"></a><span class="lineno"> 963</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-964"></a><span class="lineno"> 964</span>   <span class="k">case</span> <span class="n">KEY_SEEN</span>:
<a name="c1-965"></a><span class="lineno"> 965</span>     <span class="k">if</span> <span class="p">(</span><span class="n">matches</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-966"></a><span class="lineno"> 966</span>       <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">store</span><span class="p">.</span><span class="n">multi_replace</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-967"></a><span class="lineno"> 967</span>         <span class="n">warning</span><span class="p">(</span><span class="s">"%s has multiple values"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-968"></a><span class="lineno"> 968</span>       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">&gt;=</span> <span class="n">MAX_MATCHES</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-969"></a><span class="lineno"> 969</span>         <span class="n">error</span><span class="p">(</span><span class="s">"too many matches for %s"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-970"></a><span class="lineno"> 970</span>         <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-971"></a><span class="lineno"> 971</span>       <span class="p">}</span>
<a name="c1-972"></a><span class="lineno"> 972</span> 
<a name="c1-973"></a><span class="lineno"> 973</span>       <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-974"></a><span class="lineno"> 974</span>       <span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="o">++</span><span class="p">;</span>
<a name="c1-975"></a><span class="lineno"> 975</span>     <span class="p">}</span>
<a name="c1-976"></a><span class="lineno"> 976</span>     <span class="k">break</span><span class="p">;</span>
<a name="c1-977"></a><span class="lineno"> 977</span>   <span class="k">case</span> <span class="n">SECTION_SEEN</span>:
<a name="c1-978"></a><span class="lineno"> 978</span>     <span class="cm">/*</span>
<a name="c1-979"></a><span class="lineno"> 979</span> <span class="cm">    * What we are looking for is in store.key (both</span>
<a name="c1-980"></a><span class="lineno"> 980</span> <span class="cm">    * section and var), and its section part is baselen</span>
<a name="c1-981"></a><span class="lineno"> 981</span> <span class="cm">    * long.  We found key (again, both section and var).</span>
<a name="c1-982"></a><span class="lineno"> 982</span> <span class="cm">    * We would want to know if this key is in the same</span>
<a name="c1-983"></a><span class="lineno"> 983</span> <span class="cm">    * section as what we are looking for.  We already</span>
<a name="c1-984"></a><span class="lineno"> 984</span> <span class="cm">    * know we are in the same section as what should</span>
<a name="c1-985"></a><span class="lineno"> 985</span> <span class="cm">    * hold store.key.</span>
<a name="c1-986"></a><span class="lineno"> 986</span> <span class="cm">    */</span>
<a name="c1-987"></a><span class="lineno"> 987</span>     <span class="n">ep</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">);</span>
<a name="c1-988"></a><span class="lineno"> 988</span>     <span class="n">section_len</span> <span class="o">=</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">key</span><span class="p">;</span>
<a name="c1-989"></a><span class="lineno"> 989</span> 
<a name="c1-990"></a><span class="lineno"> 990</span>     <span class="k">if</span> <span class="p">((</span><span class="n">section_len</span> <span class="o">!=</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-991"></a><span class="lineno"> 991</span>         <span class="n">memcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">section_len</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-992"></a><span class="lineno"> 992</span>       <span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SECTION_END_SEEN</span><span class="p">;</span>
<a name="c1-993"></a><span class="lineno"> 993</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-994"></a><span class="lineno"> 994</span>     <span class="p">}</span>
<a name="c1-995"></a><span class="lineno"> 995</span> 
<a name="c1-996"></a><span class="lineno"> 996</span>     <span class="cm">/*</span>
<a name="c1-997"></a><span class="lineno"> 997</span> <span class="cm">    * Do not increment matches: this is no match, but we</span>
<a name="c1-998"></a><span class="lineno"> 998</span> <span class="cm">    * just made sure we are in the desired section.</span>
<a name="c1-999"></a><span class="lineno"> 999</span> <span class="cm">    */</span>
<a name="c1-1000"></a><span class="lineno">1000</span>    <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-1001"></a><span class="lineno">1001</span>    <span class="cm">/* fallthru */</span>
<a name="c1-1002"></a><span class="lineno">1002</span>  <span class="k">case</span> <span class="n">SECTION_END_SEEN</span>:
<a name="c1-1003"></a><span class="lineno">1003</span>  <span class="k">case</span> <span class="n">START</span>:
<a name="c1-1004"></a><span class="lineno">1004</span>    <span class="k">if</span> <span class="p">(</span><span class="n">matches</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1005"></a><span class="lineno">1005</span>      <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-1006"></a><span class="lineno">1006</span>      <span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEY_SEEN</span><span class="p">;</span>
<a name="c1-1007"></a><span class="lineno">1007</span>      <span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1008"></a><span class="lineno">1008</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-1009"></a><span class="lineno">1009</span>      <span class="k">if</span> <span class="p">(</span><span class="n">strrchr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">)</span> <span class="o">-</span> <span class="n">key</span> <span class="o">==</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span> <span class="o">&amp;&amp;</span>
<a name="c1-1010"></a><span class="lineno">1010</span>            <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1011"></a><span class="lineno">1011</span>          <span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SECTION_SEEN</span><span class="p">;</span>
<a name="c1-1012"></a><span class="lineno">1012</span>          <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<a name="c1-1013"></a><span class="lineno">1013</span>      <span class="p">}</span>
<a name="c1-1014"></a><span class="lineno">1014</span>    <span class="p">}</span>
<a name="c1-1015"></a><span class="lineno">1015</span>  <span class="p">}</span>
<a name="c1-1016"></a><span class="lineno">1016</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1017"></a><span class="lineno">1017</span> <span class="p">}</span>
<a name="c1-1018"></a><span class="lineno">1018</span> 
<a name="c1-1019"></a><span class="lineno">1019</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">write_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<a name="c1-1020"></a><span class="lineno">1020</span> <span class="p">{</span>
<a name="c1-1021"></a><span class="lineno">1021</span>  <span class="n">error</span><span class="p">(</span><span class="s">"failed to write new configuration file %s"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
<a name="c1-1022"></a><span class="lineno">1022</span> 
<a name="c1-1023"></a><span class="lineno">1023</span>  <span class="cm">/* Same error code as "failed to rename". */</span>
<a name="c1-1024"></a><span class="lineno">1024</span>  <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<a name="c1-1025"></a><span class="lineno">1025</span> <span class="p">}</span>
<a name="c1-1026"></a><span class="lineno">1026</span> 
<a name="c1-1027"></a><span class="lineno">1027</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">store_write_section</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<a name="c1-1028"></a><span class="lineno">1028</span> <span class="p">{</span>
<a name="c1-1029"></a><span class="lineno">1029</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dot</span><span class="p">;</span>
<a name="c1-1030"></a><span class="lineno">1030</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">success</span><span class="p">;</span>
<a name="c1-1031"></a><span class="lineno">1031</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-1032"></a><span class="lineno">1032</span> 
<a name="c1-1033"></a><span class="lineno">1033</span>  <span class="n">dot</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span><span class="p">);</span>
<a name="c1-1034"></a><span class="lineno">1034</span>  <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1035"></a><span class="lineno">1035</span>    <span class="n">strbuf_addf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"[%.*s </span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dot</span> <span class="o">-</span> <span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-1036"></a><span class="lineno">1036</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dot</span> <span class="o">-</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1037"></a><span class="lineno">1037</span>      <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="p">)</span>
<a name="c1-1038"></a><span class="lineno">1038</span>        <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="sc">'\\'</span><span class="p">);</span>
<a name="c1-1039"></a><span class="lineno">1039</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c1-1040"></a><span class="lineno">1040</span>    <span class="p">}</span>
<a name="c1-1041"></a><span class="lineno">1041</span>    <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"</span><span class="se">\"</span><span class="s">]</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-1042"></a><span class="lineno">1042</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-1043"></a><span class="lineno">1043</span>    <span class="n">strbuf_addf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"[%.*s]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-1044"></a><span class="lineno">1044</span>  <span class="p">}</span>
<a name="c1-1045"></a><span class="lineno">1045</span> 
<a name="c1-1046"></a><span class="lineno">1046</span>  <span class="n">success</span> <span class="o">=</span> <span class="n">write_in_full</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">sb</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c1-1047"></a><span class="lineno">1047</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">);</span>
<a name="c1-1048"></a><span class="lineno">1048</span> 
<a name="c1-1049"></a><span class="lineno">1049</span>  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<a name="c1-1050"></a><span class="lineno">1050</span> <span class="p">}</span>
<a name="c1-1051"></a><span class="lineno">1051</span> 
<a name="c1-1052"></a><span class="lineno">1052</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">store_write_pair</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-1053"></a><span class="lineno">1053</span> <span class="p">{</span>
<a name="c1-1054"></a><span class="lineno">1054</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">success</span><span class="p">;</span>
<a name="c1-1055"></a><span class="lineno">1055</span>  <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1056"></a><span class="lineno">1056</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">quote</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<a name="c1-1057"></a><span class="lineno">1057</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-1058"></a><span class="lineno">1058</span> 
<a name="c1-1059"></a><span class="lineno">1059</span>  <span class="cm">/*</span>
<a name="c1-1060"></a><span class="lineno">1060</span> <span class="cm">   * Check to see if the value needs to be surrounded with a dq pair.</span>
<a name="c1-1061"></a><span class="lineno">1061</span> <span class="cm">   * Note that problematic characters are always backslash-quoted; this</span>
<a name="c1-1062"></a><span class="lineno">1062</span> <span class="cm">   * check is about not losing leading or trailing SP and strings that</span>
<a name="c1-1063"></a><span class="lineno">1063</span> <span class="cm">   * follow beginning-of-comment characters (i.e. ';' and '#') by the</span>
<a name="c1-1064"></a><span class="lineno">1064</span> <span class="cm">   * configuration parser.</span>
<a name="c1-1065"></a><span class="lineno">1065</span> <span class="cm">   */</span>
<a name="c1-1066"></a><span class="lineno">1066</span>  <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span>
<a name="c1-1067"></a><span class="lineno">1067</span>    <span class="n">quote</span> <span class="o">=</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">;</span>
<a name="c1-1068"></a><span class="lineno">1068</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1069"></a><span class="lineno">1069</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">';'</span> <span class="o">||</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'#'</span><span class="p">)</span>
<a name="c1-1070"></a><span class="lineno">1070</span>      <span class="n">quote</span> <span class="o">=</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">;</span>
<a name="c1-1071"></a><span class="lineno">1071</span>  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span>
<a name="c1-1072"></a><span class="lineno">1072</span>    <span class="n">quote</span> <span class="o">=</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">;</span>
<a name="c1-1073"></a><span class="lineno">1073</span> 
<a name="c1-1074"></a><span class="lineno">1074</span>  <span class="n">strbuf_addf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"</span><span class="se">\t</span><span class="s">%.*s = %s"</span><span class="p">,</span>
<a name="c1-1075"></a><span class="lineno">1075</span>        <span class="n">length</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="n">store</span><span class="p">.</span><span class="n">baselen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">quote</span><span class="p">);</span>
<a name="c1-1076"></a><span class="lineno">1076</span> 
<a name="c1-1077"></a><span class="lineno">1077</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1078"></a><span class="lineno">1078</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
<a name="c1-1079"></a><span class="lineno">1079</span>    <span class="k">case</span> <span class="sc">'\n'</span>:
<a name="c1-1080"></a><span class="lineno">1080</span>      <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s">n"</span><span class="p">);</span>
<a name="c1-1081"></a><span class="lineno">1081</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-1082"></a><span class="lineno">1082</span>    <span class="k">case</span> <span class="sc">'\t'</span>:
<a name="c1-1083"></a><span class="lineno">1083</span>      <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s">t"</span><span class="p">);</span>
<a name="c1-1084"></a><span class="lineno">1084</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-1085"></a><span class="lineno">1085</span>    <span class="k">case</span> <span class="sc">'"'</span>:
<a name="c1-1086"></a><span class="lineno">1086</span>    <span class="k">case</span> <span class="sc">'\\'</span>:
<a name="c1-1087"></a><span class="lineno">1087</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="sc">'\\'</span><span class="p">);</span>
<a name="c1-1088"></a><span class="lineno">1088</span>    <span class="nl">default:</span>
<a name="c1-1089"></a><span class="lineno">1089</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c1-1090"></a><span class="lineno">1090</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-1091"></a><span class="lineno">1091</span>    <span class="p">}</span>
<a name="c1-1092"></a><span class="lineno">1092</span>  <span class="n">strbuf_addf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">quote</span><span class="p">);</span>
<a name="c1-1093"></a><span class="lineno">1093</span> 
<a name="c1-1094"></a><span class="lineno">1094</span>  <span class="n">success</span> <span class="o">=</span> <span class="n">write_in_full</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">sb</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c1-1095"></a><span class="lineno">1095</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">);</span>
<a name="c1-1096"></a><span class="lineno">1096</span> 
<a name="c1-1097"></a><span class="lineno">1097</span>  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<a name="c1-1098"></a><span class="lineno">1098</span> <span class="p">}</span>
<a name="c1-1099"></a><span class="lineno">1099</span> 
<a name="c1-1100"></a><span class="lineno">1100</span> <span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">find_beginning_of_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">contents</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
<a name="c1-1101"></a><span class="lineno">1101</span>  <span class="kt">size_t</span> <span class="n">offset_</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">found_bracket</span><span class="p">)</span>
<a name="c1-1102"></a><span class="lineno">1102</span> <span class="p">{</span>
<a name="c1-1103"></a><span class="lineno">1103</span>  <span class="kt">size_t</span> <span class="n">equal_offset</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span> <span class="n">bracket_offset</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c1-1104"></a><span class="lineno">1104</span>  <span class="kt">ssize_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c1-1105"></a><span class="lineno">1105</span> 
<a name="c1-1106"></a><span class="lineno">1106</span> <span class="nl">contline:</span>
<a name="c1-1107"></a><span class="lineno">1107</span>  <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset_</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a name="c1-1108"></a><span class="lineno">1108</span>      <span class="o">&amp;&amp;</span> <span class="n">contents</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">;</span> <span class="n">offset</span><span class="o">--</span><span class="p">)</span>
<a name="c1-1109"></a><span class="lineno">1109</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="n">offset</span><span class="p">])</span> <span class="p">{</span>
<a name="c1-1110"></a><span class="lineno">1110</span>      <span class="k">case</span> <span class="sc">'='</span>: <span class="n">equal_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<a name="c1-1111"></a><span class="lineno">1111</span>      <span class="k">case</span> <span class="sc">']'</span>: <span class="n">bracket_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
<a name="c1-1112"></a><span class="lineno">1112</span>    <span class="p">}</span>
<a name="c1-1113"></a><span class="lineno">1113</span>  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">contents</span><span class="p">[</span><span class="n">offset</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1114"></a><span class="lineno">1114</span>    <span class="n">offset_</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<a name="c1-1115"></a><span class="lineno">1115</span>    <span class="k">goto</span> <span class="n">contline</span><span class="p">;</span>
<a name="c1-1116"></a><span class="lineno">1116</span>  <span class="p">}</span>
<a name="c1-1117"></a><span class="lineno">1117</span>  <span class="k">if</span> <span class="p">(</span><span class="n">bracket_offset</span> <span class="o">&lt;</span> <span class="n">equal_offset</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1118"></a><span class="lineno">1118</span>    <span class="o">*</span><span class="n">found_bracket</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1119"></a><span class="lineno">1119</span>    <span class="n">offset</span> <span class="o">=</span> <span class="n">bracket_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-1120"></a><span class="lineno">1120</span>  <span class="p">}</span> <span class="k">else</span>
<a name="c1-1121"></a><span class="lineno">1121</span>    <span class="n">offset</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1122"></a><span class="lineno">1122</span> 
<a name="c1-1123"></a><span class="lineno">1123</span>  <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c1-1124"></a><span class="lineno">1124</span> <span class="p">}</span>
<a name="c1-1125"></a><span class="lineno">1125</span> 
<a name="c1-1126"></a><span class="lineno">1126</span> <span class="kt">int</span> <span class="nf">git_config_set_in_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_filename</span><span class="p">,</span>
<a name="c1-1127"></a><span class="lineno">1127</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-1128"></a><span class="lineno">1128</span> <span class="p">{</span>
<a name="c1-1129"></a><span class="lineno">1129</span>  <span class="k">return</span> <span class="n">git_config_set_multivar_in_file</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1130"></a><span class="lineno">1130</span> <span class="p">}</span>
<a name="c1-1131"></a><span class="lineno">1131</span> 
<a name="c1-1132"></a><span class="lineno">1132</span> <span class="kt">int</span> <span class="nf">git_config_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<a name="c1-1133"></a><span class="lineno">1133</span> <span class="p">{</span>
<a name="c1-1134"></a><span class="lineno">1134</span>  <span class="k">return</span> <span class="n">git_config_set_multivar</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1135"></a><span class="lineno">1135</span> <span class="p">}</span>
<a name="c1-1136"></a><span class="lineno">1136</span> 
<a name="c1-1137"></a><span class="lineno">1137</span> <span class="cm">/*</span>
<a name="c1-1138"></a><span class="lineno">1138</span> <span class="cm"> * Auxiliary function to sanity-check and split the key into the section</span>
<a name="c1-1139"></a><span class="lineno">1139</span> <span class="cm"> * identifier and variable name.</span>
<a name="c1-1140"></a><span class="lineno">1140</span> <span class="cm"> *</span>
<a name="c1-1141"></a><span class="lineno">1141</span> <span class="cm"> * Returns 0 on success, -1 when there is an invalid character in the key and</span>
<a name="c1-1142"></a><span class="lineno">1142</span> <span class="cm"> * -2 if there is no section name in the key.</span>
<a name="c1-1143"></a><span class="lineno">1143</span> <span class="cm"> *</span>
<a name="c1-1144"></a><span class="lineno">1144</span> <span class="cm"> * store_key - pointer to char* which will hold a copy of the key with</span>
<a name="c1-1145"></a><span class="lineno">1145</span> <span class="cm"> *             lowercase section and variable name</span>
<a name="c1-1146"></a><span class="lineno">1146</span> <span class="cm"> * baselen - pointer to int which will hold the length of the</span>
<a name="c1-1147"></a><span class="lineno">1147</span> <span class="cm"> *           section + subsection part, can be NULL</span>
<a name="c1-1148"></a><span class="lineno">1148</span> <span class="cm"> */</span>
<a name="c1-1149"></a><span class="lineno">1149</span> <span class="kt">int</span> <span class="nf">git_config_parse_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">store_key</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">baselen_</span><span class="p">)</span>
<a name="c1-1150"></a><span class="lineno">1150</span> <span class="p">{</span>
<a name="c1-1151"></a><span class="lineno">1151</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">baselen</span><span class="p">;</span>
<a name="c1-1152"></a><span class="lineno">1152</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last_dot</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">);</span>
<a name="c1-1153"></a><span class="lineno">1153</span> 
<a name="c1-1154"></a><span class="lineno">1154</span>  <span class="cm">/*</span>
<a name="c1-1155"></a><span class="lineno">1155</span> <span class="cm">   * Since "key" actually contains the section name and the real</span>
<a name="c1-1156"></a><span class="lineno">1156</span> <span class="cm">   * key name separated by a dot, we have to know where the dot is.</span>
<a name="c1-1157"></a><span class="lineno">1157</span> <span class="cm">   */</span>
<a name="c1-1158"></a><span class="lineno">1158</span> 
<a name="c1-1159"></a><span class="lineno">1159</span>  <span class="k">if</span> <span class="p">(</span><span class="n">last_dot</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">last_dot</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1160"></a><span class="lineno">1160</span>    <span class="n">error</span><span class="p">(</span><span class="s">"key does not contain a section: %s"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-1161"></a><span class="lineno">1161</span>    <span class="k">return</span> <span class="o">-</span><span class="n">CONFIG_NO_SECTION_OR_NAME</span><span class="p">;</span>
<a name="c1-1162"></a><span class="lineno">1162</span>  <span class="p">}</span>
<a name="c1-1163"></a><span class="lineno">1163</span> 
<a name="c1-1164"></a><span class="lineno">1164</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_dot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
<a name="c1-1165"></a><span class="lineno">1165</span>    <span class="n">error</span><span class="p">(</span><span class="s">"key does not contain variable name: %s"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-1166"></a><span class="lineno">1166</span>    <span class="k">return</span> <span class="o">-</span><span class="n">CONFIG_NO_SECTION_OR_NAME</span><span class="p">;</span>
<a name="c1-1167"></a><span class="lineno">1167</span>  <span class="p">}</span>
<a name="c1-1168"></a><span class="lineno">1168</span> 
<a name="c1-1169"></a><span class="lineno">1169</span>  <span class="n">baselen</span> <span class="o">=</span> <span class="n">last_dot</span> <span class="o">-</span> <span class="n">key</span><span class="p">;</span>
<a name="c1-1170"></a><span class="lineno">1170</span>  <span class="k">if</span> <span class="p">(</span><span class="n">baselen_</span><span class="p">)</span>
<a name="c1-1171"></a><span class="lineno">1171</span>    <span class="o">*</span><span class="n">baselen_</span> <span class="o">=</span> <span class="n">baselen</span><span class="p">;</span>
<a name="c1-1172"></a><span class="lineno">1172</span> 
<a name="c1-1173"></a><span class="lineno">1173</span>  <span class="cm">/*</span>
<a name="c1-1174"></a><span class="lineno">1174</span> <span class="cm">   * Validate the key and while at it, lower case it for matching.</span>
<a name="c1-1175"></a><span class="lineno">1175</span> <span class="cm">   */</span>
<a name="c1-1176"></a><span class="lineno">1176</span>  <span class="o">*</span><span class="n">store_key</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1177"></a><span class="lineno">1177</span> 
<a name="c1-1178"></a><span class="lineno">1178</span>  <span class="n">dot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1179"></a><span class="lineno">1179</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1180"></a><span class="lineno">1180</span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c1-1181"></a><span class="lineno">1181</span>    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">)</span>
<a name="c1-1182"></a><span class="lineno">1182</span>      <span class="n">dot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1183"></a><span class="lineno">1183</span>    <span class="cm">/* Leave the extended basename untouched.. */</span>
<a name="c1-1184"></a><span class="lineno">1184</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dot</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">baselen</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1185"></a><span class="lineno">1185</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iskeychar</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1186"></a><span class="lineno">1186</span>          <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">baselen</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isalpha</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-1187"></a><span class="lineno">1187</span>        <span class="n">error</span><span class="p">(</span><span class="s">"invalid key: %s"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-1188"></a><span class="lineno">1188</span>        <span class="k">goto</span> <span class="n">out_free_ret_1</span><span class="p">;</span>
<a name="c1-1189"></a><span class="lineno">1189</span>      <span class="p">}</span>
<a name="c1-1190"></a><span class="lineno">1190</span>      <span class="n">c</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<a name="c1-1191"></a><span class="lineno">1191</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1192"></a><span class="lineno">1192</span>      <span class="n">error</span><span class="p">(</span><span class="s">"invalid key (newline): %s"</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="c1-1193"></a><span class="lineno">1193</span>      <span class="k">goto</span> <span class="n">out_free_ret_1</span><span class="p">;</span>
<a name="c1-1194"></a><span class="lineno">1194</span>    <span class="p">}</span>
<a name="c1-1195"></a><span class="lineno">1195</span>    <span class="p">(</span><span class="o">*</span><span class="n">store_key</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-1196"></a><span class="lineno">1196</span>  <span class="p">}</span>
<a name="c1-1197"></a><span class="lineno">1197</span>  <span class="p">(</span><span class="o">*</span><span class="n">store_key</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1198"></a><span class="lineno">1198</span> 
<a name="c1-1199"></a><span class="lineno">1199</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1200"></a><span class="lineno">1200</span> 
<a name="c1-1201"></a><span class="lineno">1201</span> <span class="nl">out_free_ret_1:</span>
<a name="c1-1202"></a><span class="lineno">1202</span>  <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">store_key</span><span class="p">);</span>
<a name="c1-1203"></a><span class="lineno">1203</span>  <span class="k">return</span> <span class="o">-</span><span class="n">CONFIG_INVALID_KEY</span><span class="p">;</span>
<a name="c1-1204"></a><span class="lineno">1204</span> <span class="p">}</span>
<a name="c1-1205"></a><span class="lineno">1205</span> 
<a name="c1-1206"></a><span class="lineno">1206</span> <span class="cm">/*</span>
<a name="c1-1207"></a><span class="lineno">1207</span> <span class="cm"> * If value==NULL, unset in (remove from) config,</span>
<a name="c1-1208"></a><span class="lineno">1208</span> <span class="cm"> * if value_regex!=NULL, disregard key/value pairs where value does not match.</span>
<a name="c1-1209"></a><span class="lineno">1209</span> <span class="cm"> * if multi_replace==0, nothing, or only one matching key/value is replaced,</span>
<a name="c1-1210"></a><span class="lineno">1210</span> <span class="cm"> *     else all matching key/values (regardless how many) are removed,</span>
<a name="c1-1211"></a><span class="lineno">1211</span> <span class="cm"> *     before the new pair is written.</span>
<a name="c1-1212"></a><span class="lineno">1212</span> <span class="cm"> *</span>
<a name="c1-1213"></a><span class="lineno">1213</span> <span class="cm"> * Returns 0 on success.</span>
<a name="c1-1214"></a><span class="lineno">1214</span> <span class="cm"> *</span>
<a name="c1-1215"></a><span class="lineno">1215</span> <span class="cm"> * This function does this:</span>
<a name="c1-1216"></a><span class="lineno">1216</span> <span class="cm"> *</span>
<a name="c1-1217"></a><span class="lineno">1217</span> <span class="cm"> * - it locks the config file by creating ".git/config.lock"</span>
<a name="c1-1218"></a><span class="lineno">1218</span> <span class="cm"> *</span>
<a name="c1-1219"></a><span class="lineno">1219</span> <span class="cm"> * - it then parses the config using store_aux() as validator to find</span>
<a name="c1-1220"></a><span class="lineno">1220</span> <span class="cm"> *   the position on the key/value pair to replace. If it is to be unset,</span>
<a name="c1-1221"></a><span class="lineno">1221</span> <span class="cm"> *   it must be found exactly once.</span>
<a name="c1-1222"></a><span class="lineno">1222</span> <span class="cm"> *</span>
<a name="c1-1223"></a><span class="lineno">1223</span> <span class="cm"> * - the config file is mmap()ed and the part before the match (if any) is</span>
<a name="c1-1224"></a><span class="lineno">1224</span> <span class="cm"> *   written to the lock file, then the changed part and the rest.</span>
<a name="c1-1225"></a><span class="lineno">1225</span> <span class="cm"> *</span>
<a name="c1-1226"></a><span class="lineno">1226</span> <span class="cm"> * - the config file is removed and the lock file rename()d to it.</span>
<a name="c1-1227"></a><span class="lineno">1227</span> <span class="cm"> *</span>
<a name="c1-1228"></a><span class="lineno">1228</span> <span class="cm"> */</span>
<a name="c1-1229"></a><span class="lineno">1229</span> <span class="kt">int</span> <span class="nf">git_config_set_multivar_in_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_filename</span><span class="p">,</span>
<a name="c1-1230"></a><span class="lineno">1230</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
<a name="c1-1231"></a><span class="lineno">1231</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value_regex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">multi_replace</span><span class="p">)</span>
<a name="c1-1232"></a><span class="lineno">1232</span> <span class="p">{</span>
<a name="c1-1233"></a><span class="lineno">1233</span>  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">in_fd</span><span class="p">;</span>
<a name="c1-1234"></a><span class="lineno">1234</span>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-1235"></a><span class="lineno">1235</span>  <span class="k">struct</span> <span class="n">lock_file</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1236"></a><span class="lineno">1236</span> 
<a name="c1-1237"></a><span class="lineno">1237</span>  <span class="cm">/* parse-key returns negative; flip the sign to feed exit(3) */</span>
<a name="c1-1238"></a><span class="lineno">1238</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">git_config_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">store</span><span class="p">.</span><span class="n">baselen</span><span class="p">);</span>
<a name="c1-1239"></a><span class="lineno">1239</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<a name="c1-1240"></a><span class="lineno">1240</span>    <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1241"></a><span class="lineno">1241</span> 
<a name="c1-1242"></a><span class="lineno">1242</span>  <span class="n">store</span><span class="p">.</span><span class="n">multi_replace</span> <span class="o">=</span> <span class="n">multi_replace</span><span class="p">;</span>
<a name="c1-1243"></a><span class="lineno">1243</span> 
<a name="c1-1244"></a><span class="lineno">1244</span> 
<a name="c1-1245"></a><span class="lineno">1245</span>  <span class="cm">/*</span>
<a name="c1-1246"></a><span class="lineno">1246</span> <span class="cm">   * The lock serves a purpose in addition to locking: the new</span>
<a name="c1-1247"></a><span class="lineno">1247</span> <span class="cm">   * contents of .git/config will be written into it.</span>
<a name="c1-1248"></a><span class="lineno">1248</span> <span class="cm">   */</span>
<a name="c1-1249"></a><span class="lineno">1249</span>  <span class="n">lock</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lock_file</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1250"></a><span class="lineno">1250</span>  <span class="n">fd</span> <span class="o">=</span> <span class="n">hold_lock_file_for_update</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1251"></a><span class="lineno">1251</span>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1252"></a><span class="lineno">1252</span>    <span class="n">error</span><span class="p">(</span><span class="s">"could not lock config file %s: %s"</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c1-1253"></a><span class="lineno">1253</span>    <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a name="c1-1254"></a><span class="lineno">1254</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_NO_LOCK</span><span class="p">;</span>
<a name="c1-1255"></a><span class="lineno">1255</span>    <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1256"></a><span class="lineno">1256</span>  <span class="p">}</span>
<a name="c1-1257"></a><span class="lineno">1257</span> 
<a name="c1-1258"></a><span class="lineno">1258</span>  <span class="cm">/*</span>
<a name="c1-1259"></a><span class="lineno">1259</span> <span class="cm">   * If .git/config does not exist yet, write a minimal version.</span>
<a name="c1-1260"></a><span class="lineno">1260</span> <span class="cm">   */</span>
<a name="c1-1261"></a><span class="lineno">1261</span>  <span class="n">in_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<a name="c1-1262"></a><span class="lineno">1262</span>  <span class="k">if</span> <span class="p">(</span> <span class="n">in_fd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
<a name="c1-1263"></a><span class="lineno">1263</span>    <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a name="c1-1264"></a><span class="lineno">1264</span> 
<a name="c1-1265"></a><span class="lineno">1265</span>    <span class="k">if</span> <span class="p">(</span> <span class="n">ENOENT</span> <span class="o">!=</span> <span class="n">errno</span> <span class="p">)</span> <span class="p">{</span>
<a name="c1-1266"></a><span class="lineno">1266</span>      <span class="n">error</span><span class="p">(</span><span class="s">"opening %s: %s"</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span>
<a name="c1-1267"></a><span class="lineno">1267</span>            <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c1-1268"></a><span class="lineno">1268</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_INVALID_FILE</span><span class="p">;</span> <span class="cm">/* same as "invalid config file" */</span>
<a name="c1-1269"></a><span class="lineno">1269</span>      <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1270"></a><span class="lineno">1270</span>    <span class="p">}</span>
<a name="c1-1271"></a><span class="lineno">1271</span>    <span class="cm">/* if nothing to unset, error out */</span>
<a name="c1-1272"></a><span class="lineno">1272</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1273"></a><span class="lineno">1273</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_NOTHING_SET</span><span class="p">;</span>
<a name="c1-1274"></a><span class="lineno">1274</span>      <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1275"></a><span class="lineno">1275</span>    <span class="p">}</span>
<a name="c1-1276"></a><span class="lineno">1276</span> 
<a name="c1-1277"></a><span class="lineno">1277</span>    <span class="n">store</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>
<a name="c1-1278"></a><span class="lineno">1278</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_write_section</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1279"></a><span class="lineno">1279</span>        <span class="o">!</span><span class="n">store_write_pair</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a name="c1-1280"></a><span class="lineno">1280</span>      <span class="k">goto</span> <span class="n">write_err_out</span><span class="p">;</span>
<a name="c1-1281"></a><span class="lineno">1281</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-1282"></a><span class="lineno">1282</span>    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c1-1283"></a><span class="lineno">1283</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">contents</span><span class="p">;</span>
<a name="c1-1284"></a><span class="lineno">1284</span>    <span class="kt">size_t</span> <span class="n">contents_sz</span><span class="p">,</span> <span class="n">copy_begin</span><span class="p">,</span> <span class="n">copy_end</span><span class="p">;</span>
<a name="c1-1285"></a><span class="lineno">1285</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1286"></a><span class="lineno">1286</span> 
<a name="c1-1287"></a><span class="lineno">1287</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value_regex</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="c1-1288"></a><span class="lineno">1288</span>      <span class="n">store</span><span class="p">.</span><span class="n">value_regex</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1289"></a><span class="lineno">1289</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c1-1290"></a><span class="lineno">1290</span>      <span class="k">if</span> <span class="p">(</span><span class="n">value_regex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'!'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1291"></a><span class="lineno">1291</span>        <span class="n">store</span><span class="p">.</span><span class="n">do_not_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1292"></a><span class="lineno">1292</span>        <span class="n">value_regex</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1293"></a><span class="lineno">1293</span>      <span class="p">}</span> <span class="k">else</span>
<a name="c1-1294"></a><span class="lineno">1294</span>        <span class="n">store</span><span class="p">.</span><span class="n">do_not_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1295"></a><span class="lineno">1295</span> 
<a name="c1-1296"></a><span class="lineno">1296</span>      <span class="n">store</span><span class="p">.</span><span class="n">value_regex</span> <span class="o">=</span> <span class="p">(</span><span class="n">regex_t</span><span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">regex_t</span><span class="p">));</span>
<a name="c1-1297"></a><span class="lineno">1297</span>      <span class="k">if</span> <span class="p">(</span><span class="n">regcomp</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">,</span> <span class="n">value_regex</span><span class="p">,</span>
<a name="c1-1298"></a><span class="lineno">1298</span>          <span class="n">REG_EXTENDED</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1299"></a><span class="lineno">1299</span>        <span class="n">error</span><span class="p">(</span><span class="s">"invalid pattern: %s"</span><span class="p">,</span> <span class="n">value_regex</span><span class="p">);</span>
<a name="c1-1300"></a><span class="lineno">1300</span>        <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">);</span>
<a name="c1-1301"></a><span class="lineno">1301</span>        <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_INVALID_PATTERN</span><span class="p">;</span>
<a name="c1-1302"></a><span class="lineno">1302</span>        <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1303"></a><span class="lineno">1303</span>      <span class="p">}</span>
<a name="c1-1304"></a><span class="lineno">1304</span>    <span class="p">}</span>
<a name="c1-1305"></a><span class="lineno">1305</span> 
<a name="c1-1306"></a><span class="lineno">1306</span>    <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1307"></a><span class="lineno">1307</span>    <span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">START</span><span class="p">;</span>
<a name="c1-1308"></a><span class="lineno">1308</span>    <span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1309"></a><span class="lineno">1309</span> 
<a name="c1-1310"></a><span class="lineno">1310</span>    <span class="cm">/*</span>
<a name="c1-1311"></a><span class="lineno">1311</span> <span class="cm">     * After this, store.offset will contain the *end* offset</span>
<a name="c1-1312"></a><span class="lineno">1312</span> <span class="cm">     * of the last match, or remain at 0 if no match was found.</span>
<a name="c1-1313"></a><span class="lineno">1313</span> <span class="cm">     * As a side effect, we make sure to transform only a valid</span>
<a name="c1-1314"></a><span class="lineno">1314</span> <span class="cm">     * existing config file.</span>
<a name="c1-1315"></a><span class="lineno">1315</span> <span class="cm">     */</span>
<a name="c1-1316"></a><span class="lineno">1316</span>    <span class="k">if</span> <span class="p">(</span><span class="n">git_config_from_file</span><span class="p">(</span><span class="n">store_aux</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1317"></a><span class="lineno">1317</span>      <span class="n">error</span><span class="p">(</span><span class="s">"invalid config file %s"</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">);</span>
<a name="c1-1318"></a><span class="lineno">1318</span>      <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a name="c1-1319"></a><span class="lineno">1319</span>      <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1320"></a><span class="lineno">1320</span>        <span class="n">regfree</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">);</span>
<a name="c1-1321"></a><span class="lineno">1321</span>        <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">);</span>
<a name="c1-1322"></a><span class="lineno">1322</span>      <span class="p">}</span>
<a name="c1-1323"></a><span class="lineno">1323</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_INVALID_FILE</span><span class="p">;</span>
<a name="c1-1324"></a><span class="lineno">1324</span>      <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1325"></a><span class="lineno">1325</span>    <span class="p">}</span>
<a name="c1-1326"></a><span class="lineno">1326</span> 
<a name="c1-1327"></a><span class="lineno">1327</span>    <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
<a name="c1-1328"></a><span class="lineno">1328</span>    <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1329"></a><span class="lineno">1329</span>      <span class="n">regfree</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">);</span>
<a name="c1-1330"></a><span class="lineno">1330</span>      <span class="n">free</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">value_regex</span><span class="p">);</span>
<a name="c1-1331"></a><span class="lineno">1331</span>    <span class="p">}</span>
<a name="c1-1332"></a><span class="lineno">1332</span> 
<a name="c1-1333"></a><span class="lineno">1333</span>    <span class="cm">/* if nothing to unset, or too many matches, error out */</span>
<a name="c1-1334"></a><span class="lineno">1334</span>    <span class="k">if</span> <span class="p">((</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1335"></a><span class="lineno">1335</span>        <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">multi_replace</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1336"></a><span class="lineno">1336</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_NOTHING_SET</span><span class="p">;</span>
<a name="c1-1337"></a><span class="lineno">1337</span>      <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1338"></a><span class="lineno">1338</span>    <span class="p">}</span>
<a name="c1-1339"></a><span class="lineno">1339</span> 
<a name="c1-1340"></a><span class="lineno">1340</span>    <span class="n">fstat</span><span class="p">(</span><span class="n">in_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<a name="c1-1341"></a><span class="lineno">1341</span>    <span class="n">contents_sz</span> <span class="o">=</span> <span class="n">xsize_t</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
<a name="c1-1342"></a><span class="lineno">1342</span>    <span class="n">contents</span> <span class="o">=</span> <span class="n">xmmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">contents_sz</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
<a name="c1-1343"></a><span class="lineno">1343</span>      <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="n">in_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1344"></a><span class="lineno">1344</span>    <span class="n">close</span><span class="p">(</span><span class="n">in_fd</span><span class="p">);</span>
<a name="c1-1345"></a><span class="lineno">1345</span> 
<a name="c1-1346"></a><span class="lineno">1346</span>    <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1347"></a><span class="lineno">1347</span>      <span class="n">store</span><span class="p">.</span><span class="n">seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1348"></a><span class="lineno">1348</span> 
<a name="c1-1349"></a><span class="lineno">1349</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">copy_begin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">store</span><span class="p">.</span><span class="n">seen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1350"></a><span class="lineno">1350</span>      <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1351"></a><span class="lineno">1351</span>        <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_end</span> <span class="o">=</span> <span class="n">contents_sz</span><span class="p">;</span>
<a name="c1-1352"></a><span class="lineno">1352</span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">KEY_SEEN</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1353"></a><span class="lineno">1353</span>        <span class="n">copy_end</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c1-1354"></a><span class="lineno">1354</span>      <span class="p">}</span> <span class="k">else</span>
<a name="c1-1355"></a><span class="lineno">1355</span>        <span class="n">copy_end</span> <span class="o">=</span> <span class="n">find_beginning_of_line</span><span class="p">(</span>
<a name="c1-1356"></a><span class="lineno">1356</span>          <span class="n">contents</span><span class="p">,</span> <span class="n">contents_sz</span><span class="p">,</span>
<a name="c1-1357"></a><span class="lineno">1357</span>          <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_line</span><span class="p">);</span>
<a name="c1-1358"></a><span class="lineno">1358</span> 
<a name="c1-1359"></a><span class="lineno">1359</span>      <span class="k">if</span> <span class="p">(</span><span class="n">copy_end</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">contents</span><span class="p">[</span><span class="n">copy_end</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-1360"></a><span class="lineno">1360</span>        <span class="n">new_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1361"></a><span class="lineno">1361</span> 
<a name="c1-1362"></a><span class="lineno">1362</span>      <span class="cm">/* write the first part of the config */</span>
<a name="c1-1363"></a><span class="lineno">1363</span>      <span class="k">if</span> <span class="p">(</span><span class="n">copy_end</span> <span class="o">&gt;</span> <span class="n">copy_begin</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1364"></a><span class="lineno">1364</span>        <span class="k">if</span> <span class="p">(</span><span class="n">write_in_full</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">contents</span> <span class="o">+</span> <span class="n">copy_begin</span><span class="p">,</span>
<a name="c1-1365"></a><span class="lineno">1365</span>              <span class="n">copy_end</span> <span class="o">-</span> <span class="n">copy_begin</span><span class="p">)</span> <span class="o">&lt;</span>
<a name="c1-1366"></a><span class="lineno">1366</span>            <span class="n">copy_end</span> <span class="o">-</span> <span class="n">copy_begin</span><span class="p">)</span>
<a name="c1-1367"></a><span class="lineno">1367</span>          <span class="k">goto</span> <span class="n">write_err_out</span><span class="p">;</span>
<a name="c1-1368"></a><span class="lineno">1368</span>        <span class="k">if</span> <span class="p">(</span><span class="n">new_line</span> <span class="o">&amp;&amp;</span>
<a name="c1-1369"></a><span class="lineno">1369</span>            <span class="n">write_str_in_full</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
<a name="c1-1370"></a><span class="lineno">1370</span>          <span class="k">goto</span> <span class="n">write_err_out</span><span class="p">;</span>
<a name="c1-1371"></a><span class="lineno">1371</span>      <span class="p">}</span>
<a name="c1-1372"></a><span class="lineno">1372</span>      <span class="n">copy_begin</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c1-1373"></a><span class="lineno">1373</span>    <span class="p">}</span>
<a name="c1-1374"></a><span class="lineno">1374</span> 
<a name="c1-1375"></a><span class="lineno">1375</span>    <span class="cm">/* write the pair (value == NULL means unset) */</span>
<a name="c1-1376"></a><span class="lineno">1376</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1377"></a><span class="lineno">1377</span>      <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">START</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1378"></a><span class="lineno">1378</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_write_section</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
<a name="c1-1379"></a><span class="lineno">1379</span>          <span class="k">goto</span> <span class="n">write_err_out</span><span class="p">;</span>
<a name="c1-1380"></a><span class="lineno">1380</span>      <span class="p">}</span>
<a name="c1-1381"></a><span class="lineno">1381</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_write_pair</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a name="c1-1382"></a><span class="lineno">1382</span>        <span class="k">goto</span> <span class="n">write_err_out</span><span class="p">;</span>
<a name="c1-1383"></a><span class="lineno">1383</span>    <span class="p">}</span>
<a name="c1-1384"></a><span class="lineno">1384</span> 
<a name="c1-1385"></a><span class="lineno">1385</span>    <span class="cm">/* write the rest of the config */</span>
<a name="c1-1386"></a><span class="lineno">1386</span>    <span class="k">if</span> <span class="p">(</span><span class="n">copy_begin</span> <span class="o">&lt;</span> <span class="n">contents_sz</span><span class="p">)</span>
<a name="c1-1387"></a><span class="lineno">1387</span>      <span class="k">if</span> <span class="p">(</span><span class="n">write_in_full</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">contents</span> <span class="o">+</span> <span class="n">copy_begin</span><span class="p">,</span>
<a name="c1-1388"></a><span class="lineno">1388</span>            <span class="n">contents_sz</span> <span class="o">-</span> <span class="n">copy_begin</span><span class="p">)</span> <span class="o">&lt;</span>
<a name="c1-1389"></a><span class="lineno">1389</span>          <span class="n">contents_sz</span> <span class="o">-</span> <span class="n">copy_begin</span><span class="p">)</span>
<a name="c1-1390"></a><span class="lineno">1390</span>        <span class="k">goto</span> <span class="n">write_err_out</span><span class="p">;</span>
<a name="c1-1391"></a><span class="lineno">1391</span> 
<a name="c1-1392"></a><span class="lineno">1392</span>    <span class="n">munmap</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">contents_sz</span><span class="p">);</span>
<a name="c1-1393"></a><span class="lineno">1393</span>  <span class="p">}</span>
<a name="c1-1394"></a><span class="lineno">1394</span> 
<a name="c1-1395"></a><span class="lineno">1395</span>  <span class="k">if</span> <span class="p">(</span><span class="n">commit_lock_file</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1396"></a><span class="lineno">1396</span>    <span class="n">error</span><span class="p">(</span><span class="s">"could not commit config file %s"</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">);</span>
<a name="c1-1397"></a><span class="lineno">1397</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">CONFIG_NO_WRITE</span><span class="p">;</span>
<a name="c1-1398"></a><span class="lineno">1398</span>    <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1399"></a><span class="lineno">1399</span>  <span class="p">}</span>
<a name="c1-1400"></a><span class="lineno">1400</span> 
<a name="c1-1401"></a><span class="lineno">1401</span>  <span class="cm">/*</span>
<a name="c1-1402"></a><span class="lineno">1402</span> <span class="cm">   * lock is committed, so don't try to roll it back below.</span>
<a name="c1-1403"></a><span class="lineno">1403</span> <span class="cm">   * NOTE: Since lockfile.c keeps a linked list of all created</span>
<a name="c1-1404"></a><span class="lineno">1404</span> <span class="cm">   * lock_file structures, it isn't safe to free(lock).  It's</span>
<a name="c1-1405"></a><span class="lineno">1405</span> <span class="cm">   * better to just leave it hanging around.</span>
<a name="c1-1406"></a><span class="lineno">1406</span> <span class="cm">   */</span>
<a name="c1-1407"></a><span class="lineno">1407</span>  <span class="n">lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1408"></a><span class="lineno">1408</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1409"></a><span class="lineno">1409</span> 
<a name="c1-1410"></a><span class="lineno">1410</span> <span class="nl">out_free:</span>
<a name="c1-1411"></a><span class="lineno">1411</span>  <span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
<a name="c1-1412"></a><span class="lineno">1412</span>    <span class="n">rollback_lock_file</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<a name="c1-1413"></a><span class="lineno">1413</span>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-1414"></a><span class="lineno">1414</span> 
<a name="c1-1415"></a><span class="lineno">1415</span> <span class="nl">write_err_out:</span>
<a name="c1-1416"></a><span class="lineno">1416</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">write_error</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1417"></a><span class="lineno">1417</span>  <span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
<a name="c1-1418"></a><span class="lineno">1418</span> 
<a name="c1-1419"></a><span class="lineno">1419</span> <span class="p">}</span>
<a name="c1-1420"></a><span class="lineno">1420</span> 
<a name="c1-1421"></a><span class="lineno">1421</span> <span class="kt">int</span> <span class="nf">git_config_set_multivar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
<a name="c1-1422"></a><span class="lineno">1422</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value_regex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">multi_replace</span><span class="p">)</span>
<a name="c1-1423"></a><span class="lineno">1423</span> <span class="p">{</span>
<a name="c1-1424"></a><span class="lineno">1424</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">config_filename</span><span class="p">;</span>
<a name="c1-1425"></a><span class="lineno">1425</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1426"></a><span class="lineno">1426</span>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-1427"></a><span class="lineno">1427</span> 
<a name="c1-1428"></a><span class="lineno">1428</span>  <span class="k">if</span> <span class="p">(</span><span class="n">config_exclusive_filename</span><span class="p">)</span>
<a name="c1-1429"></a><span class="lineno">1429</span>    <span class="n">config_filename</span> <span class="o">=</span> <span class="n">config_exclusive_filename</span><span class="p">;</span>
<a name="c1-1430"></a><span class="lineno">1430</span>  <span class="k">else</span>
<a name="c1-1431"></a><span class="lineno">1431</span>    <span class="n">config_filename</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">git_pathdup</span><span class="p">(</span><span class="s">"config"</span><span class="p">);</span>
<a name="c1-1432"></a><span class="lineno">1432</span> 
<a name="c1-1433"></a><span class="lineno">1433</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">git_config_set_multivar_in_file</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
<a name="c1-1434"></a><span class="lineno">1434</span>          <span class="n">value_regex</span><span class="p">,</span> <span class="n">multi_replace</span><span class="p">);</span>
<a name="c1-1435"></a><span class="lineno">1435</span>  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-1436"></a><span class="lineno">1436</span>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-1437"></a><span class="lineno">1437</span> <span class="p">}</span>
<a name="c1-1438"></a><span class="lineno">1438</span> 
<a name="c1-1439"></a><span class="lineno">1439</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">section_name_match</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c1-1440"></a><span class="lineno">1440</span> <span class="p">{</span>
<a name="c1-1441"></a><span class="lineno">1441</span>  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1442"></a><span class="lineno">1442</span>  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'['</span><span class="p">)</span>
<a name="c1-1443"></a><span class="lineno">1443</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1444"></a><span class="lineno">1444</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">']'</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1445"></a><span class="lineno">1445</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dot</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
<a name="c1-1446"></a><span class="lineno">1446</span>      <span class="n">dot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1447"></a><span class="lineno">1447</span>      <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'.'</span><span class="p">)</span>
<a name="c1-1448"></a><span class="lineno">1448</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-1449"></a><span class="lineno">1449</span>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1450"></a><span class="lineno">1450</span>        <span class="p">;</span> <span class="cm">/* do nothing */</span>
<a name="c1-1451"></a><span class="lineno">1451</span>      <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'"'</span><span class="p">)</span>
<a name="c1-1452"></a><span class="lineno">1452</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-1453"></a><span class="lineno">1453</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1454"></a><span class="lineno">1454</span>    <span class="p">}</span>
<a name="c1-1455"></a><span class="lineno">1455</span>    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">dot</span><span class="p">)</span>
<a name="c1-1456"></a><span class="lineno">1456</span>      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1457"></a><span class="lineno">1457</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">&amp;&amp;</span> <span class="n">dot</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1458"></a><span class="lineno">1458</span>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1459"></a><span class="lineno">1459</span>        <span class="p">;</span> <span class="cm">/* do_nothing */</span>
<a name="c1-1460"></a><span class="lineno">1460</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-1461"></a><span class="lineno">1461</span>    <span class="p">}</span>
<a name="c1-1462"></a><span class="lineno">1462</span>    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">])</span>
<a name="c1-1463"></a><span class="lineno">1463</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-1464"></a><span class="lineno">1464</span>  <span class="p">}</span>
<a name="c1-1465"></a><span class="lineno">1465</span>  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">']'</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1466"></a><span class="lineno">1466</span>    <span class="cm">/*</span>
<a name="c1-1467"></a><span class="lineno">1467</span> <span class="cm">     * We match, now just find the right length offset by</span>
<a name="c1-1468"></a><span class="lineno">1468</span> <span class="cm">     * gobbling up any whitespace after it, as well</span>
<a name="c1-1469"></a><span class="lineno">1469</span> <span class="cm">     */</span>
<a name="c1-1470"></a><span class="lineno">1470</span>    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1471"></a><span class="lineno">1471</span>    <span class="k">for</span> <span class="p">(;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1472"></a><span class="lineno">1472</span>      <span class="p">;</span> <span class="cm">/* do nothing */</span>
<a name="c1-1473"></a><span class="lineno">1473</span>    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1474"></a><span class="lineno">1474</span>  <span class="p">}</span>
<a name="c1-1475"></a><span class="lineno">1475</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1476"></a><span class="lineno">1476</span> <span class="p">}</span>
<a name="c1-1477"></a><span class="lineno">1477</span> 
<a name="c1-1478"></a><span class="lineno">1478</span> <span class="cm">/* if new_name == NULL, the section is removed instead */</span>
<a name="c1-1479"></a><span class="lineno">1479</span> <span class="kt">int</span> <span class="nf">git_config_rename_section</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">)</span>
<a name="c1-1480"></a><span class="lineno">1480</span> <span class="p">{</span>
<a name="c1-1481"></a><span class="lineno">1481</span>  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">remove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1482"></a><span class="lineno">1482</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">config_filename</span><span class="p">;</span>
<a name="c1-1483"></a><span class="lineno">1483</span>  <span class="k">struct</span> <span class="n">lock_file</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lock_file</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1484"></a><span class="lineno">1484</span>  <span class="kt">int</span> <span class="n">out_fd</span><span class="p">;</span>
<a name="c1-1485"></a><span class="lineno">1485</span>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<a name="c1-1486"></a><span class="lineno">1486</span>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">config_file</span><span class="p">;</span>
<a name="c1-1487"></a><span class="lineno">1487</span> 
<a name="c1-1488"></a><span class="lineno">1488</span>  <span class="k">if</span> <span class="p">(</span><span class="n">config_exclusive_filename</span><span class="p">)</span>
<a name="c1-1489"></a><span class="lineno">1489</span>    <span class="n">config_filename</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="n">config_exclusive_filename</span><span class="p">);</span>
<a name="c1-1490"></a><span class="lineno">1490</span>  <span class="k">else</span>
<a name="c1-1491"></a><span class="lineno">1491</span>    <span class="n">config_filename</span> <span class="o">=</span> <span class="n">git_pathdup</span><span class="p">(</span><span class="s">"config"</span><span class="p">);</span>
<a name="c1-1492"></a><span class="lineno">1492</span>  <span class="n">out_fd</span> <span class="o">=</span> <span class="n">hold_lock_file_for_update</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1493"></a><span class="lineno">1493</span>  <span class="k">if</span> <span class="p">(</span><span class="n">out_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1494"></a><span class="lineno">1494</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="s">"could not lock config file %s"</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">);</span>
<a name="c1-1495"></a><span class="lineno">1495</span>    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<a name="c1-1496"></a><span class="lineno">1496</span>  <span class="p">}</span>
<a name="c1-1497"></a><span class="lineno">1497</span> 
<a name="c1-1498"></a><span class="lineno">1498</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-1499"></a><span class="lineno">1499</span>    <span class="cm">/* no config file means nothing to rename, no error */</span>
<a name="c1-1500"></a><span class="lineno">1500</span>    <span class="k">goto</span> <span class="n">unlock_and_out</span><span class="p">;</span>
<a name="c1-1501"></a><span class="lineno">1501</span>  <span class="p">}</span>
<a name="c1-1502"></a><span class="lineno">1502</span> 
<a name="c1-1503"></a><span class="lineno">1503</span>  <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">config_file</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1504"></a><span class="lineno">1504</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1505"></a><span class="lineno">1505</span>    <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
<a name="c1-1506"></a><span class="lineno">1506</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<a name="c1-1507"></a><span class="lineno">1507</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1508"></a><span class="lineno">1508</span>      <span class="p">;</span> <span class="cm">/* do nothing */</span>
<a name="c1-1509"></a><span class="lineno">1509</span>    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1510"></a><span class="lineno">1510</span>      <span class="cm">/* it's a section */</span>
<a name="c1-1511"></a><span class="lineno">1511</span>      <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">section_name_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">old_name</span><span class="p">);</span>
<a name="c1-1512"></a><span class="lineno">1512</span>      <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1513"></a><span class="lineno">1513</span>        <span class="n">ret</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1514"></a><span class="lineno">1514</span>        <span class="k">if</span> <span class="p">(</span><span class="n">new_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1515"></a><span class="lineno">1515</span>          <span class="n">remove</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1516"></a><span class="lineno">1516</span>          <span class="k">continue</span><span class="p">;</span>
<a name="c1-1517"></a><span class="lineno">1517</span>        <span class="p">}</span>
<a name="c1-1518"></a><span class="lineno">1518</span>        <span class="n">store</span><span class="p">.</span><span class="n">baselen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">new_name</span><span class="p">);</span>
<a name="c1-1519"></a><span class="lineno">1519</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">store_write_section</span><span class="p">(</span><span class="n">out_fd</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1520"></a><span class="lineno">1520</span>          <span class="n">ret</span> <span class="o">=</span> <span class="n">write_error</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1521"></a><span class="lineno">1521</span>          <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<a name="c1-1522"></a><span class="lineno">1522</span>        <span class="p">}</span>
<a name="c1-1523"></a><span class="lineno">1523</span>        <span class="cm">/*</span>
<a name="c1-1524"></a><span class="lineno">1524</span> <span class="cm">         * We wrote out the new section, with</span>
<a name="c1-1525"></a><span class="lineno">1525</span> <span class="cm">         * a newline, now skip the old</span>
<a name="c1-1526"></a><span class="lineno">1526</span> <span class="cm">         * section's length</span>
<a name="c1-1527"></a><span class="lineno">1527</span> <span class="cm">         */</span>
<a name="c1-1528"></a><span class="lineno">1528</span>        <span class="n">output</span> <span class="o">+=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1529"></a><span class="lineno">1529</span>        <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1530"></a><span class="lineno">1530</span>          <span class="cm">/*</span>
<a name="c1-1531"></a><span class="lineno">1531</span> <span class="cm">           * More content means there's</span>
<a name="c1-1532"></a><span class="lineno">1532</span> <span class="cm">           * a declaration to put on the</span>
<a name="c1-1533"></a><span class="lineno">1533</span> <span class="cm">           * next line; indent with a</span>
<a name="c1-1534"></a><span class="lineno">1534</span> <span class="cm">           * tab</span>
<a name="c1-1535"></a><span class="lineno">1535</span> <span class="cm">           */</span>
<a name="c1-1536"></a><span class="lineno">1536</span>          <span class="n">output</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1537"></a><span class="lineno">1537</span>          <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\t'</span><span class="p">;</span>
<a name="c1-1538"></a><span class="lineno">1538</span>        <span class="p">}</span>
<a name="c1-1539"></a><span class="lineno">1539</span>      <span class="p">}</span>
<a name="c1-1540"></a><span class="lineno">1540</span>      <span class="n">remove</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1541"></a><span class="lineno">1541</span>    <span class="p">}</span>
<a name="c1-1542"></a><span class="lineno">1542</span>    <span class="k">if</span> <span class="p">(</span><span class="n">remove</span><span class="p">)</span>
<a name="c1-1543"></a><span class="lineno">1543</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1544"></a><span class="lineno">1544</span>    <span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>
<a name="c1-1545"></a><span class="lineno">1545</span>    <span class="k">if</span> <span class="p">(</span><span class="n">write_in_full</span><span class="p">(</span><span class="n">out_fd</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1546"></a><span class="lineno">1546</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">write_error</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1547"></a><span class="lineno">1547</span>      <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<a name="c1-1548"></a><span class="lineno">1548</span>    <span class="p">}</span>
<a name="c1-1549"></a><span class="lineno">1549</span>  <span class="p">}</span>
<a name="c1-1550"></a><span class="lineno">1550</span>  <span class="n">fclose</span><span class="p">(</span><span class="n">config_file</span><span class="p">);</span>
<a name="c1-1551"></a><span class="lineno">1551</span> <span class="nl">unlock_and_out:</span>
<a name="c1-1552"></a><span class="lineno">1552</span>  <span class="k">if</span> <span class="p">(</span><span class="n">commit_lock_file</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1553"></a><span class="lineno">1553</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="s">"could not commit config file %s"</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">);</span>
<a name="c1-1554"></a><span class="lineno">1554</span> <span class="nl">out:</span>
<a name="c1-1555"></a><span class="lineno">1555</span>  <span class="n">free</span><span class="p">(</span><span class="n">config_filename</span><span class="p">);</span>
<a name="c1-1556"></a><span class="lineno">1556</span>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-1557"></a><span class="lineno">1557</span> <span class="p">}</span>
<a name="c1-1558"></a><span class="lineno">1558</span> 
<a name="c1-1559"></a><span class="lineno">1559</span> <span class="cm">/*</span>
<a name="c1-1560"></a><span class="lineno">1560</span> <span class="cm"> * Call this to report error for your variable that should not</span>
<a name="c1-1561"></a><span class="lineno">1561</span> <span class="cm"> * get a boolean value (i.e. "[my] var" means "true").</span>
<a name="c1-1562"></a><span class="lineno">1562</span> <span class="cm"> */</span>
<a name="c1-1563"></a><span class="lineno">1563</span> <span class="kt">int</span> <span class="nf">config_error_nonbool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<a name="c1-1564"></a><span class="lineno">1564</span> <span class="p">{</span>
<a name="c1-1565"></a><span class="lineno">1565</span>  <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"Missing value for '%s'"</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
<a name="c1-1566"></a><span class="lineno">1566</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>
    
</body></html>