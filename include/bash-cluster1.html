<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f68ccb61c5411ac0009dd?cs=4f1f68ccb61c5411ac000a38 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <script type="text/javascript" src="./bash-cluster1_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./bash-cluster1_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./bash-cluster1_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./bash-cluster1_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./bash-cluster1_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./bash-cluster1_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./bash-cluster1_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./bash-cluster1_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./bash-cluster1_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./bash-cluster1_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./bash-cluster1_files/chosen.jquery.js"></script>


        <script src="./bash-cluster1_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./bash-cluster1_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./bash-cluster1_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f68ccb61c5411ac0009dd?cs=4f1f68ccb61c5411ac000a38");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./bash-cluster1_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./bash-cluster1_files/bootstrap.css" rel="stylesheet">

        <link href="./bash-cluster1_files/force.css" rel="stylesheet" type="text/css">
        <link href="./bash-cluster1_files/chosen.css" rel="stylesheet" type="text/css">
       
        
<link rel="stylesheet" href="../pygments.css">
<title>Fica -- survey bash-4.2 12-01-25 02:28:20</title>

<script language="javascript">

    var reheight = function(){
        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-124']")[0].scrollIntoView();
        $("a[name='c1-305']")[0].scrollIntoView();
        reheight();
        
        $("#clonesets").accordion({event:"click", autoHeight: false});
        $("#clonesets").accordion("activate","#cs-4f1f68ccb61c5411ac000a38");
        
        $("#cs-4f1f68ccb61c5411ac000a38").scrollintoview();
        

        
        $(".scrollbox").each(function(){
            var scrollbox = $(this);
            scrollbox.scroll(function(){
                var percent = $(this).scrollTop() /
                    (this.scrollHeight-$(this).height()) ;
                $(this).prev().css("opacity", percent * 5 );
                $(this).next().css("opacity", (1 - percent ) * 5 );
            });
        });
        
    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

<body>
<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> execute_cmd.c 
                <small> (127,46)-(138,45)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 752px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">   1</span> <span class="cm">/* execute_cmd.c -- Execute a COMMAND structure. */</span>
<a name="c0-2"></a><span class="lineno">   2</span> 
<a name="c0-3"></a><span class="lineno">   3</span> <span class="cm">/* Copyright (C) 1987-2010 Free Software Foundation, Inc.</span>
<a name="c0-4"></a><span class="lineno">   4</span> 
<a name="c0-5"></a><span class="lineno">   5</span> <span class="cm">   This file is part of GNU Bash, the Bourne Again SHell.</span>
<a name="c0-6"></a><span class="lineno">   6</span> 
<a name="c0-7"></a><span class="lineno">   7</span> <span class="cm">   Bash is free software: you can redistribute it and/or modify</span>
<a name="c0-8"></a><span class="lineno">   8</span> <span class="cm">   it under the terms of the GNU General Public License as published by</span>
<a name="c0-9"></a><span class="lineno">   9</span> <span class="cm">   the Free Software Foundation, either version 3 of the License, or</span>
<a name="c0-10"></a><span class="lineno">  10</span> <span class="cm">   (at your option) any later version.</span>
<a name="c0-11"></a><span class="lineno">  11</span> 
<a name="c0-12"></a><span class="lineno">  12</span> <span class="cm">   Bash is distributed in the hope that it will be useful,</span>
<a name="c0-13"></a><span class="lineno">  13</span> <span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="c0-14"></a><span class="lineno">  14</span> <span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="c0-15"></a><span class="lineno">  15</span> <span class="cm">   GNU General Public License for more details.</span>
<a name="c0-16"></a><span class="lineno">  16</span> 
<a name="c0-17"></a><span class="lineno">  17</span> <span class="cm">   You should have received a copy of the GNU General Public License</span>
<a name="c0-18"></a><span class="lineno">  18</span> <span class="cm">   along with Bash.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="c0-19"></a><span class="lineno">  19</span> <span class="cm">*/</span>
<a name="c0-20"></a><span class="lineno">  20</span> 
<a name="c0-21"></a><span class="lineno">  21</span> <span class="cp">#include "config.h"</span>
<a name="c0-22"></a><span class="lineno">  22</span> 
<a name="c0-23"></a><span class="lineno">  23</span> <span class="cp">#if !defined (__GNUC__) &amp;&amp; !defined (HAVE_ALLOCA_H) &amp;&amp; defined (_AIX)</span>
<a name="c0-24"></a><span class="lineno">  24</span>   <span class="cp">#pragma alloca</span>
<a name="c0-25"></a><span class="lineno">  25</span> <span class="cp">#endif </span><span class="cm">/* _AIX &amp;&amp; RISC6000 &amp;&amp; !__GNUC__ */</span><span class="cp"></span>
<a name="c0-26"></a><span class="lineno">  26</span> 
<a name="c0-27"></a><span class="lineno">  27</span> <span class="cp">#include &lt;stdio.h&gt;</span>
<a name="c0-28"></a><span class="lineno">  28</span> <span class="cp">#include "chartypes.h"</span>
<a name="c0-29"></a><span class="lineno">  29</span> <span class="cp">#include "bashtypes.h"</span>
<a name="c0-30"></a><span class="lineno">  30</span> <span class="cp">#if !defined (_MINIX) &amp;&amp; defined (HAVE_SYS_FILE_H)</span>
<a name="c0-31"></a><span class="lineno">  31</span> <span class="cp">#  include &lt;sys/file.h&gt;</span>
<a name="c0-32"></a><span class="lineno">  32</span> <span class="cp">#endif</span>
<a name="c0-33"></a><span class="lineno">  33</span> <span class="cp">#include "filecntl.h"</span>
<a name="c0-34"></a><span class="lineno">  34</span> <span class="cp">#include "posixstat.h"</span>
<a name="c0-35"></a><span class="lineno">  35</span> <span class="cp">#include &lt;signal.h&gt;</span>
<a name="c0-36"></a><span class="lineno">  36</span> <span class="cp">#ifndef _MINIX</span>
<a name="c0-37"></a><span class="lineno">  37</span> <span class="cp">#  include &lt;sys/param.h&gt;</span>
<a name="c0-38"></a><span class="lineno">  38</span> <span class="cp">#endif</span>
<a name="c0-39"></a><span class="lineno">  39</span> 
<a name="c0-40"></a><span class="lineno">  40</span> <span class="cp">#if defined (HAVE_UNISTD_H)</span>
<a name="c0-41"></a><span class="lineno">  41</span> <span class="cp">#  include &lt;unistd.h&gt;</span>
<a name="c0-42"></a><span class="lineno">  42</span> <span class="cp">#endif</span>
<a name="c0-43"></a><span class="lineno">  43</span> 
<a name="c0-44"></a><span class="lineno">  44</span> <span class="cp">#include "posixtime.h"</span>
<a name="c0-45"></a><span class="lineno">  45</span> 
<a name="c0-46"></a><span class="lineno">  46</span> <span class="cp">#if defined (HAVE_SYS_RESOURCE_H) &amp;&amp; !defined (RLIMTYPE)</span>
<a name="c0-47"></a><span class="lineno">  47</span> <span class="cp">#  include &lt;sys/resource.h&gt;</span>
<a name="c0-48"></a><span class="lineno">  48</span> <span class="cp">#endif</span>
<a name="c0-49"></a><span class="lineno">  49</span> 
<a name="c0-50"></a><span class="lineno">  50</span> <span class="cp">#if defined (HAVE_SYS_TIMES_H) &amp;&amp; defined (HAVE_TIMES)</span>
<a name="c0-51"></a><span class="lineno">  51</span> <span class="cp">#  include &lt;sys/times.h&gt;</span>
<a name="c0-52"></a><span class="lineno">  52</span> <span class="cp">#endif</span>
<a name="c0-53"></a><span class="lineno">  53</span> 
<a name="c0-54"></a><span class="lineno">  54</span> <span class="cp">#include &lt;errno.h&gt;</span>
<a name="c0-55"></a><span class="lineno">  55</span> 
<a name="c0-56"></a><span class="lineno">  56</span> <span class="cp">#if !defined (errno)</span>
<a name="c0-57"></a><span class="lineno">  57</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>
<a name="c0-58"></a><span class="lineno">  58</span> <span class="cp">#endif</span>
<a name="c0-59"></a><span class="lineno">  59</span> 
<a name="c0-60"></a><span class="lineno">  60</span> <span class="cp">#define NEED_FPURGE_DECL</span>
<a name="c0-61"></a><span class="lineno">  61</span> 
<a name="c0-62"></a><span class="lineno">  62</span> <span class="cp">#include "bashansi.h"</span>
<a name="c0-63"></a><span class="lineno">  63</span> <span class="cp">#include "bashintl.h"</span>
<a name="c0-64"></a><span class="lineno">  64</span> 
<a name="c0-65"></a><span class="lineno">  65</span> <span class="cp">#include "memalloc.h"</span>
<a name="c0-66"></a><span class="lineno">  66</span> <span class="cp">#include "shell.h"</span>
<a name="c0-67"></a><span class="lineno">  67</span> <span class="cp">#include &lt;y.tab.h&gt;  </span><span class="cm">/* use &lt;...&gt; so we pick it up from the build directory */</span><span class="cp"></span>
<a name="c0-68"></a><span class="lineno">  68</span> <span class="cp">#include "flags.h"</span>
<a name="c0-69"></a><span class="lineno">  69</span> <span class="cp">#include "builtins.h"</span>
<a name="c0-70"></a><span class="lineno">  70</span> <span class="cp">#include "hashlib.h"</span>
<a name="c0-71"></a><span class="lineno">  71</span> <span class="cp">#include "jobs.h"</span>
<a name="c0-72"></a><span class="lineno">  72</span> <span class="cp">#include "execute_cmd.h"</span>
<a name="c0-73"></a><span class="lineno">  73</span> <span class="cp">#include "findcmd.h"</span>
<a name="c0-74"></a><span class="lineno">  74</span> <span class="cp">#include "redir.h"</span>
<a name="c0-75"></a><span class="lineno">  75</span> <span class="cp">#include "trap.h"</span>
<a name="c0-76"></a><span class="lineno">  76</span> <span class="cp">#include "pathexp.h"</span>
<a name="c0-77"></a><span class="lineno">  77</span> <span class="cp">#include "hashcmd.h"</span>
<a name="c0-78"></a><span class="lineno">  78</span> 
<a name="c0-79"></a><span class="lineno">  79</span> <span class="cp">#if defined (COND_COMMAND)</span>
<a name="c0-80"></a><span class="lineno">  80</span> <span class="cp">#  include "test.h"</span>
<a name="c0-81"></a><span class="lineno">  81</span> <span class="cp">#endif</span>
<a name="c0-82"></a><span class="lineno">  82</span> 
<a name="c0-83"></a><span class="lineno">  83</span> <span class="cp">#include "builtins/common.h"</span>
<a name="c0-84"></a><span class="lineno">  84</span> <span class="cp">#include "builtins/builtext.h"  </span><span class="cm">/* list of builtins */</span><span class="cp"></span>
<a name="c0-85"></a><span class="lineno">  85</span> 
<a name="c0-86"></a><span class="lineno">  86</span> <span class="cp">#include &lt;glob/strmatch.h&gt;</span>
<a name="c0-87"></a><span class="lineno">  87</span> <span class="cp">#include &lt;tilde/tilde.h&gt;</span>
<a name="c0-88"></a><span class="lineno">  88</span> 
<a name="c0-89"></a><span class="lineno">  89</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c0-90"></a><span class="lineno">  90</span> <span class="cp">#  include "input.h"</span>
<a name="c0-91"></a><span class="lineno">  91</span> <span class="cp">#endif</span>
<a name="c0-92"></a><span class="lineno">  92</span> 
<a name="c0-93"></a><span class="lineno">  93</span> <span class="cp">#if defined (ALIAS)</span>
<a name="c0-94"></a><span class="lineno">  94</span> <span class="cp">#  include "alias.h"</span>
<a name="c0-95"></a><span class="lineno">  95</span> <span class="cp">#endif</span>
<a name="c0-96"></a><span class="lineno">  96</span> 
<a name="c0-97"></a><span class="lineno">  97</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c0-98"></a><span class="lineno">  98</span> <span class="cp">#  include "bashhist.h"</span>
<a name="c0-99"></a><span class="lineno">  99</span> <span class="cp">#endif</span>
<a name="c0-100"></a><span class="lineno"> 100</span> 
<a name="c0-101"></a><span class="lineno"> 101</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">dollar_dollar_pid</span><span class="p">;</span>
<a name="c0-102"></a><span class="lineno"> 102</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">posixly_correct</span><span class="p">;</span>
<a name="c0-103"></a><span class="lineno"> 103</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">expand_aliases</span><span class="p">;</span>
<a name="c0-104"></a><span class="lineno"> 104</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">autocd</span><span class="p">;</span>
<a name="c0-105"></a><span class="lineno"> 105</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">breaking</span><span class="p">,</span> <span class="n">continuing</span><span class="p">,</span> <span class="n">loop_level</span><span class="p">;</span>
<a name="c0-106"></a><span class="lineno"> 106</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">parse_and_execute_level</span><span class="p">,</span> <span class="n">running_trap</span><span class="p">,</span> <span class="n">sourcelevel</span><span class="p">;</span>
<a name="c0-107"></a><span class="lineno"> 107</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">command_string_index</span><span class="p">,</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-108"></a><span class="lineno"> 108</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">dot_found_in_search</span><span class="p">;</span>
<a name="c0-109"></a><span class="lineno"> 109</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">already_making_children</span><span class="p">;</span>
<a name="c0-110"></a><span class="lineno"> 110</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">tempenv_assign_error</span><span class="p">;</span>
<a name="c0-111"></a><span class="lineno"> 111</span> <span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">the_printed_command</span><span class="p">,</span> <span class="o">*</span><span class="n">shell_name</span><span class="p">;</span>
<a name="c0-112"></a><span class="lineno"> 112</span> <span class="k">extern</span> <span class="n">pid_t</span> <span class="n">last_command_subst_pid</span><span class="p">;</span>
<a name="c0-113"></a><span class="lineno"> 113</span> <span class="k">extern</span> <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="n">last_shell_builtin</span><span class="p">,</span> <span class="o">*</span><span class="n">this_shell_builtin</span><span class="p">;</span>
<a name="c0-114"></a><span class="lineno"> 114</span> <span class="k">extern</span> <span class="kt">char</span> <span class="o">**</span><span class="n">subshell_argv</span><span class="p">,</span> <span class="o">**</span><span class="n">subshell_envp</span><span class="p">;</span>
<a name="c0-115"></a><span class="lineno"> 115</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">subshell_argc</span><span class="p">;</span>
<a name="c0-116"></a><span class="lineno"> 116</span> <span class="k">extern</span> <span class="kt">time_t</span> <span class="n">shell_start_time</span><span class="p">;</span>
<a name="c0-117"></a><span class="lineno"> 117</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-118"></a><span class="lineno"> 118</span> <span class="c">extern char *glob_argv_flags;</span>
<a name="c0-119"></a><span class="lineno"> 119</span> <span class="cp">#endif</span>
<a name="c0-120"></a><span class="lineno"> 120</span> 
<a name="c0-121"></a><span class="lineno"> 121</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">close</span> <span class="n">__P</span><span class="p">((</span><span class="kt">int</span><span class="p">));</span>
<a name="c0-122"></a><span class="lineno"> 122</span> 
<a name="c0-123"></a><span class="lineno"> 123</span> <span class="cm">/* Static functions defined and used in this file. */</span>
<a name="c0-124"></a><span class="lineno"> 124</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">close_pipes</span> <span class="n">__P</span><span class="p">((</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-125"></a><span class="lineno"> 125</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">do_piping</span> <span class="n">__P</span><span class="p">((</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-126"></a><span class="lineno"> 126</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">bind_lastarg</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-127"></a><span class="lineno"> 127</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">shell_control_structure</span> <span class="n">__P</span><span class="p">((</span><span class="k">enum</span> <span class="n">command_type</span><span class="p">));</span>
</span><a name="c0-128"></a><span class="lineno"> 128</span> <span class="hll"><span class="k">static</span> <span class="kt">void</span> <span class="n">cleanup_redirects</span> <span class="n">__P</span><span class="p">((</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">));</span>
</span><a name="c0-129"></a><span class="lineno"> 129</span> <span class="hll">
</span><a name="c0-130"></a><span class="lineno"> 130</span> <span class="hll"><span class="cp">#if defined (JOB_CONTROL)</span>
</span><a name="c0-131"></a><span class="lineno"> 131</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">restore_signal_mask</span> <span class="n">__P</span><span class="p">((</span><span class="n">sigset_t</span> <span class="o">*</span><span class="p">));</span>
</span><a name="c0-132"></a><span class="lineno"> 132</span> <span class="hll"><span class="cp">#endif</span>
</span><a name="c0-133"></a><span class="lineno"> 133</span> <span class="hll">
</span><a name="c0-134"></a><span class="lineno"> 134</span> <span class="hll"><span class="k">static</span> <span class="kt">void</span> <span class="n">async_redirect_stdin</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
</span><a name="c0-135"></a><span class="lineno"> 135</span> <span class="hll">
</span><a name="c0-136"></a><span class="lineno"> 136</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">builtin_status</span> <span class="n">__P</span><span class="p">((</span><span class="kt">int</span><span class="p">));</span>
</span><a name="c0-137"></a><span class="lineno"> 137</span> <span class="hll">
</span><a name="c0-138"></a><span class="lineno"> 138</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">execute_for_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">FOR_COM</span> <span class="o">*</span><span class="p">));</span>
</span><a name="c0-139"></a><span class="lineno"> 139</span> <span class="cp">#if defined (SELECT_COMMAND)</span>
<a name="c0-140"></a><span class="lineno"> 140</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">displen</span> <span class="n">__P</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-141"></a><span class="lineno"> 141</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">print_index_and_element</span> <span class="n">__P</span><span class="p">((</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-142"></a><span class="lineno"> 142</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">indent</span> <span class="n">__P</span><span class="p">((</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-143"></a><span class="lineno"> 143</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">print_select_list</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-144"></a><span class="lineno"> 144</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">select_query</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-145"></a><span class="lineno"> 145</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_select_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">SELECT_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-146"></a><span class="lineno"> 146</span> <span class="cp">#endif</span>
<a name="c0-147"></a><span class="lineno"> 147</span> <span class="cp">#if defined (DPAREN_ARITHMETIC)</span>
<a name="c0-148"></a><span class="lineno"> 148</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_arith_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">ARITH_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-149"></a><span class="lineno"> 149</span> <span class="cp">#endif</span>
<a name="c0-150"></a><span class="lineno"> 150</span> <span class="cp">#if defined (COND_COMMAND)</span>
<a name="c0-151"></a><span class="lineno"> 151</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_cond_node</span> <span class="n">__P</span><span class="p">((</span><span class="n">COND_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-152"></a><span class="lineno"> 152</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_cond_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">COND_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-153"></a><span class="lineno"> 153</span> <span class="cp">#endif</span>
<a name="c0-154"></a><span class="lineno"> 154</span> <span class="cp">#if defined (COMMAND_TIMING)</span>
<a name="c0-155"></a><span class="lineno"> 155</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">mkfmt</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">time_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-156"></a><span class="lineno"> 156</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">print_formatted_time</span> <span class="n">__P</span><span class="p">((</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-157"></a><span class="lineno"> 157</span>               <span class="kt">time_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">time_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
<a name="c0-158"></a><span class="lineno"> 158</span>               <span class="kt">time_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-159"></a><span class="lineno"> 159</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">time_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-160"></a><span class="lineno"> 160</span> <span class="cp">#endif</span>
<a name="c0-161"></a><span class="lineno"> 161</span> <span class="cp">#if defined (ARITH_FOR_COMMAND)</span>
<a name="c0-162"></a><span class="lineno"> 162</span> <span class="k">static</span> <span class="kt">intmax_t</span> <span class="n">eval_arith_for_expr</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-163"></a><span class="lineno"> 163</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_arith_for_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">ARITH_FOR_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-164"></a><span class="lineno"> 164</span> <span class="cp">#endif</span>
<a name="c0-165"></a><span class="lineno"> 165</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_case_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">CASE_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-166"></a><span class="lineno"> 166</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_while_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">WHILE_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-167"></a><span class="lineno"> 167</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_until_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">WHILE_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-168"></a><span class="lineno"> 168</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_while_or_until</span> <span class="n">__P</span><span class="p">((</span><span class="n">WHILE_COM</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-169"></a><span class="lineno"> 169</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_if_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">IF_COM</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-170"></a><span class="lineno"> 170</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_null_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-171"></a><span class="lineno"> 171</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">fix_assignment_words</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-172"></a><span class="lineno"> 172</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_simple_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">SIMPLE_COM</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-173"></a><span class="lineno"> 173</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_builtin</span> <span class="n">__P</span><span class="p">((</span><span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-174"></a><span class="lineno"> 174</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_function</span> <span class="n">__P</span><span class="p">((</span><span class="n">SHELL_VAR</span> <span class="o">*</span><span class="p">,</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-175"></a><span class="lineno"> 175</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_builtin_or_function</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-176"></a><span class="lineno"> 176</span>               <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-177"></a><span class="lineno"> 177</span>               <span class="n">REDIRECT</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-178"></a><span class="lineno"> 178</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">execute_subshell_builtin_or_function</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="n">REDIRECT</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-179"></a><span class="lineno"> 179</span>                   <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-180"></a><span class="lineno"> 180</span>                   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-181"></a><span class="lineno"> 181</span>                   <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
<a name="c0-182"></a><span class="lineno"> 182</span>                   <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-183"></a><span class="lineno"> 183</span>                   <span class="kt">int</span><span class="p">));</span>
<a name="c0-184"></a><span class="lineno"> 184</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_disk_command</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">,</span> <span class="n">REDIRECT</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span>
<a name="c0-185"></a><span class="lineno"> 185</span>               <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c0-186"></a><span class="lineno"> 186</span> 
<a name="c0-187"></a><span class="lineno"> 187</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">getinterp</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-188"></a><span class="lineno"> 188</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">initialize_subshell</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c0-189"></a><span class="lineno"> 189</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_in_subshell</span> <span class="n">__P</span><span class="p">((</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-190"></a><span class="lineno"> 190</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c0-191"></a><span class="lineno"> 191</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_coproc</span> <span class="n">__P</span><span class="p">((</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-192"></a><span class="lineno"> 192</span> <span class="cp">#endif</span>
<a name="c0-193"></a><span class="lineno"> 193</span> 
<a name="c0-194"></a><span class="lineno"> 194</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_pipeline</span> <span class="n">__P</span><span class="p">((</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-195"></a><span class="lineno"> 195</span> 
<a name="c0-196"></a><span class="lineno"> 196</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_connection</span> <span class="n">__P</span><span class="p">((</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-197"></a><span class="lineno"> 197</span> 
<a name="c0-198"></a><span class="lineno"> 198</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">execute_intern_function</span> <span class="n">__P</span><span class="p">((</span><span class="n">WORD_DESC</span> <span class="o">*</span><span class="p">,</span> <span class="n">COMMAND</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-199"></a><span class="lineno"> 199</span> 
<a name="c0-200"></a><span class="lineno"> 200</span> <span class="cm">/* Set to 1 if fd 0 was the subject of redirection to a subshell.  Global</span>
<a name="c0-201"></a><span class="lineno"> 201</span> <span class="cm">   so that reader_loop can set it to zero before executing a command. */</span>
<a name="c0-202"></a><span class="lineno"> 202</span> <span class="kt">int</span> <span class="n">stdin_redir</span><span class="p">;</span>
<a name="c0-203"></a><span class="lineno"> 203</span> 
<a name="c0-204"></a><span class="lineno"> 204</span> <span class="cm">/* The name of the command that is currently being executed.</span>
<a name="c0-205"></a><span class="lineno"> 205</span> <span class="cm">   `test' needs this, for example. */</span>
<a name="c0-206"></a><span class="lineno"> 206</span> <span class="kt">char</span> <span class="o">*</span><span class="n">this_command_name</span><span class="p">;</span>
<a name="c0-207"></a><span class="lineno"> 207</span> 
<a name="c0-208"></a><span class="lineno"> 208</span> <span class="cm">/* The printed representation of the currently-executing command (same as</span>
<a name="c0-209"></a><span class="lineno"> 209</span> <span class="cm">   the_printed_command), except when a trap is being executed.  Useful for</span>
<a name="c0-210"></a><span class="lineno"> 210</span> <span class="cm">   a debugger to know where exactly the program is currently executing. */</span>
<a name="c0-211"></a><span class="lineno"> 211</span> <span class="kt">char</span> <span class="o">*</span><span class="n">the_printed_command_except_trap</span><span class="p">;</span>
<a name="c0-212"></a><span class="lineno"> 212</span> 
<a name="c0-213"></a><span class="lineno"> 213</span> <span class="cm">/* For catching RETURN in a function. */</span>
<a name="c0-214"></a><span class="lineno"> 214</span> <span class="kt">int</span> <span class="n">return_catch_flag</span><span class="p">;</span>
<a name="c0-215"></a><span class="lineno"> 215</span> <span class="kt">int</span> <span class="n">return_catch_value</span><span class="p">;</span>
<a name="c0-216"></a><span class="lineno"> 216</span> <span class="n">procenv_t</span> <span class="n">return_catch</span><span class="p">;</span>
<a name="c0-217"></a><span class="lineno"> 217</span> 
<a name="c0-218"></a><span class="lineno"> 218</span> <span class="cm">/* The value returned by the last synchronous command. */</span>
<a name="c0-219"></a><span class="lineno"> 219</span> <span class="kt">int</span> <span class="n">last_command_exit_value</span><span class="p">;</span>
<a name="c0-220"></a><span class="lineno"> 220</span> 
<a name="c0-221"></a><span class="lineno"> 221</span> <span class="cm">/* Whether or not the last command (corresponding to last_command_exit_value)</span>
<a name="c0-222"></a><span class="lineno"> 222</span> <span class="cm">   was terminated by a signal, and, if so, which one. */</span>
<a name="c0-223"></a><span class="lineno"> 223</span> <span class="kt">int</span> <span class="n">last_command_exit_signal</span><span class="p">;</span>
<a name="c0-224"></a><span class="lineno"> 224</span> 
<a name="c0-225"></a><span class="lineno"> 225</span> <span class="cm">/* The list of redirections to perform which will undo the redirections</span>
<a name="c0-226"></a><span class="lineno"> 226</span> <span class="cm">   that I made in the shell. */</span>
<a name="c0-227"></a><span class="lineno"> 227</span> <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-228"></a><span class="lineno"> 228</span> 
<a name="c0-229"></a><span class="lineno"> 229</span> <span class="cm">/* The list of redirections to perform which will undo the internal</span>
<a name="c0-230"></a><span class="lineno"> 230</span> <span class="cm">   redirections performed by the `exec' builtin.  These are redirections</span>
<a name="c0-231"></a><span class="lineno"> 231</span> <span class="cm">   that must be undone even when exec discards redirection_undo_list. */</span>
<a name="c0-232"></a><span class="lineno"> 232</span> <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">exec_redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-233"></a><span class="lineno"> 233</span> 
<a name="c0-234"></a><span class="lineno"> 234</span> <span class="cm">/* When greater than zero, value is the `level' of builtins we are</span>
<a name="c0-235"></a><span class="lineno"> 235</span> <span class="cm">   currently executing (e.g. `eval echo a' would have it set to 2). */</span>
<a name="c0-236"></a><span class="lineno"> 236</span> <span class="kt">int</span> <span class="n">executing_builtin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-237"></a><span class="lineno"> 237</span> 
<a name="c0-238"></a><span class="lineno"> 238</span> <span class="cm">/* Non-zero if we are executing a command list (a;b;c, etc.) */</span>
<a name="c0-239"></a><span class="lineno"> 239</span> <span class="kt">int</span> <span class="n">executing_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-240"></a><span class="lineno"> 240</span> 
<a name="c0-241"></a><span class="lineno"> 241</span> <span class="cm">/* Non-zero if failing commands in a command substitution should not exit the</span>
<a name="c0-242"></a><span class="lineno"> 242</span> <span class="cm">   shell even if -e is set.  Used to pass the CMD_IGNORE_RETURN flag down to</span>
<a name="c0-243"></a><span class="lineno"> 243</span> <span class="cm">   commands run in command substitutions by parse_and_execute. */</span>
<a name="c0-244"></a><span class="lineno"> 244</span> <span class="kt">int</span> <span class="n">comsub_ignore_return</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-245"></a><span class="lineno"> 245</span> 
<a name="c0-246"></a><span class="lineno"> 246</span> <span class="cm">/* Non-zero if we have just forked and are currently running in a subshell</span>
<a name="c0-247"></a><span class="lineno"> 247</span> <span class="cm">   environment. */</span>
<a name="c0-248"></a><span class="lineno"> 248</span> <span class="kt">int</span> <span class="n">subshell_environment</span><span class="p">;</span>
<a name="c0-249"></a><span class="lineno"> 249</span> 
<a name="c0-250"></a><span class="lineno"> 250</span> <span class="cm">/* Count of nested subshells, like SHLVL.  Available via $BASH_SUBSHELL */</span>
<a name="c0-251"></a><span class="lineno"> 251</span> <span class="kt">int</span> <span class="n">subshell_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-252"></a><span class="lineno"> 252</span> 
<a name="c0-253"></a><span class="lineno"> 253</span> <span class="cm">/* Currently-executing shell function. */</span>
<a name="c0-254"></a><span class="lineno"> 254</span> <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">this_shell_function</span><span class="p">;</span>
<a name="c0-255"></a><span class="lineno"> 255</span> 
<a name="c0-256"></a><span class="lineno"> 256</span> <span class="cm">/* If non-zero, matches in case and [[ ... ]] are case-insensitive */</span>
<a name="c0-257"></a><span class="lineno"> 257</span> <span class="kt">int</span> <span class="n">match_ignore_case</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-258"></a><span class="lineno"> 258</span> 
<a name="c0-259"></a><span class="lineno"> 259</span> <span class="kt">int</span> <span class="n">executing_command_builtin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-260"></a><span class="lineno"> 260</span> 
<a name="c0-261"></a><span class="lineno"> 261</span> <span class="k">struct</span> <span class="n">stat</span> <span class="n">SB</span><span class="p">;</span>   <span class="cm">/* used for debugging */</span>
<a name="c0-262"></a><span class="lineno"> 262</span> 
<a name="c0-263"></a><span class="lineno"> 263</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">special_builtin_failed</span><span class="p">;</span>
<a name="c0-264"></a><span class="lineno"> 264</span> 
<a name="c0-265"></a><span class="lineno"> 265</span> <span class="k">static</span> <span class="n">COMMAND</span> <span class="o">*</span><span class="n">currently_executing_command</span><span class="p">;</span>
<a name="c0-266"></a><span class="lineno"> 266</span> 
<a name="c0-267"></a><span class="lineno"> 267</span> <span class="cm">/* The line number that the currently executing function starts on. */</span>
<a name="c0-268"></a><span class="lineno"> 268</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">function_line_number</span><span class="p">;</span>
<a name="c0-269"></a><span class="lineno"> 269</span> 
<a name="c0-270"></a><span class="lineno"> 270</span> <span class="cm">/* XXX - set to 1 if we're running the DEBUG trap and we want to show the line</span>
<a name="c0-271"></a><span class="lineno"> 271</span> <span class="cm">   number containing the function name.  Used by executing_line_number to</span>
<a name="c0-272"></a><span class="lineno"> 272</span> <span class="cm">   report the correct line number.  Kind of a hack. */</span>
<a name="c0-273"></a><span class="lineno"> 273</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">showing_function_line</span><span class="p">;</span>
<a name="c0-274"></a><span class="lineno"> 274</span> 
<a name="c0-275"></a><span class="lineno"> 275</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">line_number_for_err_trap</span><span class="p">;</span>
<a name="c0-276"></a><span class="lineno"> 276</span> 
<a name="c0-277"></a><span class="lineno"> 277</span> <span class="cm">/* A sort of function nesting level counter */</span>
<a name="c0-278"></a><span class="lineno"> 278</span> <span class="kt">int</span> <span class="n">funcnest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-279"></a><span class="lineno"> 279</span> <span class="kt">int</span> <span class="n">funcnest_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* XXX - bash-4.2 */</span>
<a name="c0-280"></a><span class="lineno"> 280</span> 
<a name="c0-281"></a><span class="lineno"> 281</span> <span class="kt">int</span> <span class="n">lastpipe_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-282"></a><span class="lineno"> 282</span> 
<a name="c0-283"></a><span class="lineno"> 283</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">current_fds_to_close</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-284"></a><span class="lineno"> 284</span> 
<a name="c0-285"></a><span class="lineno"> 285</span> <span class="cp">#define FD_BITMAP_DEFAULT_SIZE 32</span>
<a name="c0-286"></a><span class="lineno"> 286</span> 
<a name="c0-287"></a><span class="lineno"> 287</span> <span class="cm">/* Functions to allocate and deallocate the structures used to pass</span>
<a name="c0-288"></a><span class="lineno"> 288</span> <span class="cm">   information from the shell to its children about file descriptors</span>
<a name="c0-289"></a><span class="lineno"> 289</span> <span class="cm">   to close. */</span>
<a name="c0-290"></a><span class="lineno"> 290</span> <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span>
<a name="c0-291"></a><span class="lineno"> 291</span> <span class="n">new_fd_bitmap</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
<a name="c0-292"></a><span class="lineno"> 292</span>      <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-293"></a><span class="lineno"> 293</span> <span class="p">{</span>
<a name="c0-294"></a><span class="lineno"> 294</span>   <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
<a name="c0-295"></a><span class="lineno"> 295</span> 
<a name="c0-296"></a><span class="lineno"> 296</span>   <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fd_bitmap</span><span class="p">));</span>
<a name="c0-297"></a><span class="lineno"> 297</span> 
<a name="c0-298"></a><span class="lineno"> 298</span>   <span class="n">ret</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-299"></a><span class="lineno"> 299</span> 
<a name="c0-300"></a><span class="lineno"> 300</span>   <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
<a name="c0-301"></a><span class="lineno"> 301</span>     <span class="p">{</span>
<a name="c0-302"></a><span class="lineno"> 302</span>       <span class="n">ret</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
<a name="c0-303"></a><span class="lineno"> 303</span>       <span class="n">memset</span> <span class="p">(</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-304"></a><span class="lineno"> 304</span>     <span class="p">}</span>
<a name="c0-305"></a><span class="lineno"> 305</span>   <span class="k">else</span>
<a name="c0-306"></a><span class="lineno"> 306</span>     <span class="n">ret</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-307"></a><span class="lineno"> 307</span>   <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<a name="c0-308"></a><span class="lineno"> 308</span> <span class="p">}</span>
<a name="c0-309"></a><span class="lineno"> 309</span> 
<a name="c0-310"></a><span class="lineno"> 310</span> <span class="kt">void</span>
<a name="c0-311"></a><span class="lineno"> 311</span> <span class="n">dispose_fd_bitmap</span> <span class="p">(</span><span class="n">fdbp</span><span class="p">)</span>
<a name="c0-312"></a><span class="lineno"> 312</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fdbp</span><span class="p">;</span>
<a name="c0-313"></a><span class="lineno"> 313</span> <span class="p">{</span>
<a name="c0-314"></a><span class="lineno"> 314</span>   <span class="n">FREE</span> <span class="p">(</span><span class="n">fdbp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>
<a name="c0-315"></a><span class="lineno"> 315</span>   <span class="n">free</span> <span class="p">(</span><span class="n">fdbp</span><span class="p">);</span>
<a name="c0-316"></a><span class="lineno"> 316</span> <span class="p">}</span>
<a name="c0-317"></a><span class="lineno"> 317</span> 
<a name="c0-318"></a><span class="lineno"> 318</span> <span class="kt">void</span>
<a name="c0-319"></a><span class="lineno"> 319</span> <span class="n">close_fd_bitmap</span> <span class="p">(</span><span class="n">fdbp</span><span class="p">)</span>
<a name="c0-320"></a><span class="lineno"> 320</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fdbp</span><span class="p">;</span>
<a name="c0-321"></a><span class="lineno"> 321</span> <span class="p">{</span>
<a name="c0-322"></a><span class="lineno"> 322</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-323"></a><span class="lineno"> 323</span> 
<a name="c0-324"></a><span class="lineno"> 324</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fdbp</span><span class="p">)</span>
<a name="c0-325"></a><span class="lineno"> 325</span>     <span class="p">{</span>
<a name="c0-326"></a><span class="lineno"> 326</span>       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fdbp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-327"></a><span class="lineno"> 327</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fdbp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a name="c0-328"></a><span class="lineno"> 328</span>     <span class="p">{</span>
<a name="c0-329"></a><span class="lineno"> 329</span>       <span class="n">close</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="c0-330"></a><span class="lineno"> 330</span>       <span class="n">fdbp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-331"></a><span class="lineno"> 331</span>     <span class="p">}</span>
<a name="c0-332"></a><span class="lineno"> 332</span>     <span class="p">}</span>
<a name="c0-333"></a><span class="lineno"> 333</span> <span class="p">}</span>
<a name="c0-334"></a><span class="lineno"> 334</span> 
<a name="c0-335"></a><span class="lineno"> 335</span> <span class="cm">/* Return the line number of the currently executing command. */</span>
<a name="c0-336"></a><span class="lineno"> 336</span> <span class="kt">int</span>
<a name="c0-337"></a><span class="lineno"> 337</span> <span class="n">executing_line_number</span> <span class="p">()</span>
<a name="c0-338"></a><span class="lineno"> 338</span> <span class="p">{</span>
<a name="c0-339"></a><span class="lineno"> 339</span>   <span class="k">if</span> <span class="p">(</span><span class="n">executing</span> <span class="o">&amp;&amp;</span> <span class="n">showing_function_line</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-340"></a><span class="lineno"> 340</span>       <span class="p">(</span><span class="n">variable_context</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-341"></a><span class="lineno"> 341</span>       <span class="n">currently_executing_command</span><span class="p">)</span>
<a name="c0-342"></a><span class="lineno"> 342</span>     <span class="p">{</span>
<a name="c0-343"></a><span class="lineno"> 343</span> <span class="cp">#if defined (COND_COMMAND)</span>
<a name="c0-344"></a><span class="lineno"> 344</span>       <span class="k">if</span> <span class="p">(</span><span class="n">currently_executing_command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_cond</span><span class="p">)</span>
<a name="c0-345"></a><span class="lineno"> 345</span>   <span class="k">return</span> <span class="n">currently_executing_command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Cond</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-346"></a><span class="lineno"> 346</span> <span class="cp">#endif</span>
<a name="c0-347"></a><span class="lineno"> 347</span> <span class="cp">#if defined (DPAREN_ARITHMETIC)</span>
<a name="c0-348"></a><span class="lineno"> 348</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currently_executing_command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_arith</span><span class="p">)</span>
<a name="c0-349"></a><span class="lineno"> 349</span>   <span class="k">return</span> <span class="n">currently_executing_command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Arith</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-350"></a><span class="lineno"> 350</span> <span class="cp">#endif</span>
<a name="c0-351"></a><span class="lineno"> 351</span> <span class="cp">#if defined (ARITH_FOR_COMMAND)</span>
<a name="c0-352"></a><span class="lineno"> 352</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currently_executing_command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_arith_for</span><span class="p">)</span>
<a name="c0-353"></a><span class="lineno"> 353</span>   <span class="k">return</span> <span class="n">currently_executing_command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">ArithFor</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-354"></a><span class="lineno"> 354</span> <span class="cp">#endif</span>
<a name="c0-355"></a><span class="lineno"> 355</span> 
<a name="c0-356"></a><span class="lineno"> 356</span>   <span class="k">return</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-357"></a><span class="lineno"> 357</span>     <span class="p">}</span>
<a name="c0-358"></a><span class="lineno"> 358</span>   <span class="k">else</span>
<a name="c0-359"></a><span class="lineno"> 359</span>     <span class="k">return</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-360"></a><span class="lineno"> 360</span> <span class="p">}</span>
<a name="c0-361"></a><span class="lineno"> 361</span> 
<a name="c0-362"></a><span class="lineno"> 362</span> <span class="cm">/* Execute the command passed in COMMAND.  COMMAND is exactly what</span>
<a name="c0-363"></a><span class="lineno"> 363</span> <span class="cm">   read_command () places into GLOBAL_COMMAND.  See "command.h" for the</span>
<a name="c0-364"></a><span class="lineno"> 364</span> <span class="cm">   details of the command structure.</span>
<a name="c0-365"></a><span class="lineno"> 365</span> 
<a name="c0-366"></a><span class="lineno"> 366</span> <span class="cm">   EXECUTION_SUCCESS or EXECUTION_FAILURE are the only possible</span>
<a name="c0-367"></a><span class="lineno"> 367</span> <span class="cm">   return values.  Executing a command with nothing in it returns</span>
<a name="c0-368"></a><span class="lineno"> 368</span> <span class="cm">   EXECUTION_SUCCESS. */</span>
<a name="c0-369"></a><span class="lineno"> 369</span> <span class="kt">int</span>
<a name="c0-370"></a><span class="lineno"> 370</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a name="c0-371"></a><span class="lineno"> 371</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-372"></a><span class="lineno"> 372</span> <span class="p">{</span>
<a name="c0-373"></a><span class="lineno"> 373</span>   <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
<a name="c0-374"></a><span class="lineno"> 374</span>   <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-375"></a><span class="lineno"> 375</span> 
<a name="c0-376"></a><span class="lineno"> 376</span>   <span class="n">current_fds_to_close</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-377"></a><span class="lineno"> 377</span>   <span class="n">bitmap</span> <span class="o">=</span> <span class="n">new_fd_bitmap</span> <span class="p">(</span><span class="n">FD_BITMAP_DEFAULT_SIZE</span><span class="p">);</span>
<a name="c0-378"></a><span class="lineno"> 378</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"execute-command"</span><span class="p">);</span>
<a name="c0-379"></a><span class="lineno"> 379</span>   <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_fd_bitmap</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bitmap</span><span class="p">);</span>
<a name="c0-380"></a><span class="lineno"> 380</span> 
<a name="c0-381"></a><span class="lineno"> 381</span>   <span class="cm">/* Just do the command, but not asynchronously. */</span>
<a name="c0-382"></a><span class="lineno"> 382</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">);</span>
<a name="c0-383"></a><span class="lineno"> 383</span> 
<a name="c0-384"></a><span class="lineno"> 384</span>   <span class="n">dispose_fd_bitmap</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<a name="c0-385"></a><span class="lineno"> 385</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"execute-command"</span><span class="p">);</span>
<a name="c0-386"></a><span class="lineno"> 386</span> 
<a name="c0-387"></a><span class="lineno"> 387</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-388"></a><span class="lineno"> 388</span>   <span class="cm">/* don't unlink fifos if we're in a shell function; wait until the function</span>
<a name="c0-389"></a><span class="lineno"> 389</span> <span class="cm">     returns. */</span>
<a name="c0-390"></a><span class="lineno"> 390</span>   <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-391"></a><span class="lineno"> 391</span>     <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-392"></a><span class="lineno"> 392</span> <span class="cp">#endif </span><span class="cm">/* PROCESS_SUBSTITUTION */</span><span class="cp"></span>
<a name="c0-393"></a><span class="lineno"> 393</span> 
<a name="c0-394"></a><span class="lineno"> 394</span>   <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-395"></a><span class="lineno"> 395</span>   <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-396"></a><span class="lineno"> 396</span> <span class="p">}</span>
<a name="c0-397"></a><span class="lineno"> 397</span> 
<a name="c0-398"></a><span class="lineno"> 398</span> <span class="cm">/* Return 1 if TYPE is a shell control structure type. */</span>
<a name="c0-399"></a><span class="lineno"> 399</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-400"></a><span class="lineno"> 400</span> <span class="n">shell_control_structure</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
<a name="c0-401"></a><span class="lineno"> 401</span>      <span class="k">enum</span> <span class="n">command_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-402"></a><span class="lineno"> 402</span> <span class="p">{</span>
<a name="c0-403"></a><span class="lineno"> 403</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
<a name="c0-404"></a><span class="lineno"> 404</span>     <span class="p">{</span>
<a name="c0-405"></a><span class="lineno"> 405</span> <span class="cp">#if defined (ARITH_FOR_COMMAND)</span>
<a name="c0-406"></a><span class="lineno"> 406</span>     <span class="k">case</span> <span class="n">cm_arith_for</span>:
<a name="c0-407"></a><span class="lineno"> 407</span> <span class="cp">#endif</span>
<a name="c0-408"></a><span class="lineno"> 408</span> <span class="cp">#if defined (SELECT_COMMAND)</span>
<a name="c0-409"></a><span class="lineno"> 409</span>     <span class="k">case</span> <span class="n">cm_select</span>:
<a name="c0-410"></a><span class="lineno"> 410</span> <span class="cp">#endif</span>
<a name="c0-411"></a><span class="lineno"> 411</span> <span class="cp">#if defined (DPAREN_ARITHMETIC)</span>
<a name="c0-412"></a><span class="lineno"> 412</span>     <span class="k">case</span> <span class="n">cm_arith</span>:
<a name="c0-413"></a><span class="lineno"> 413</span> <span class="cp">#endif</span>
<a name="c0-414"></a><span class="lineno"> 414</span> <span class="cp">#if defined (COND_COMMAND)</span>
<a name="c0-415"></a><span class="lineno"> 415</span>     <span class="k">case</span> <span class="n">cm_cond</span>:
<a name="c0-416"></a><span class="lineno"> 416</span> <span class="cp">#endif</span>
<a name="c0-417"></a><span class="lineno"> 417</span>     <span class="k">case</span> <span class="n">cm_case</span>:
<a name="c0-418"></a><span class="lineno"> 418</span>     <span class="k">case</span> <span class="n">cm_while</span>:
<a name="c0-419"></a><span class="lineno"> 419</span>     <span class="k">case</span> <span class="n">cm_until</span>:
<a name="c0-420"></a><span class="lineno"> 420</span>     <span class="k">case</span> <span class="n">cm_if</span>:
<a name="c0-421"></a><span class="lineno"> 421</span>     <span class="k">case</span> <span class="n">cm_for</span>:
<a name="c0-422"></a><span class="lineno"> 422</span>     <span class="k">case</span> <span class="n">cm_group</span>:
<a name="c0-423"></a><span class="lineno"> 423</span>     <span class="k">case</span> <span class="n">cm_function_def</span>:
<a name="c0-424"></a><span class="lineno"> 424</span>       <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-425"></a><span class="lineno"> 425</span> 
<a name="c0-426"></a><span class="lineno"> 426</span>     <span class="nl">default:</span>
<a name="c0-427"></a><span class="lineno"> 427</span>       <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-428"></a><span class="lineno"> 428</span>     <span class="p">}</span>
<a name="c0-429"></a><span class="lineno"> 429</span> <span class="p">}</span>
<a name="c0-430"></a><span class="lineno"> 430</span> 
<a name="c0-431"></a><span class="lineno"> 431</span> <span class="cm">/* A function to use to unwind_protect the redirection undo list</span>
<a name="c0-432"></a><span class="lineno"> 432</span> <span class="cm">   for loops. */</span>
<a name="c0-433"></a><span class="lineno"> 433</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-434"></a><span class="lineno"> 434</span> <span class="n">cleanup_redirects</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span>
<a name="c0-435"></a><span class="lineno"> 435</span>      <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-436"></a><span class="lineno"> 436</span> <span class="p">{</span>
<a name="c0-437"></a><span class="lineno"> 437</span>   <span class="n">do_redirections</span> <span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="p">);</span>
<a name="c0-438"></a><span class="lineno"> 438</span>   <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c0-439"></a><span class="lineno"> 439</span> <span class="p">}</span>
<a name="c0-440"></a><span class="lineno"> 440</span> 
<a name="c0-441"></a><span class="lineno"> 441</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-442"></a><span class="lineno"> 442</span> <span class="c">/* Function to unwind_protect the redirections for functions and builtins. */</span>
<a name="c0-443"></a><span class="lineno"> 443</span> <span class="c">static void</span>
<a name="c0-444"></a><span class="lineno"> 444</span> <span class="c">cleanup_func_redirects (list)</span>
<a name="c0-445"></a><span class="lineno"> 445</span> <span class="c">     REDIRECT *list;</span>
<a name="c0-446"></a><span class="lineno"> 446</span> <span class="c">{</span>
<a name="c0-447"></a><span class="lineno"> 447</span> <span class="c">  do_redirections (list, RX_ACTIVE);</span>
<a name="c0-448"></a><span class="lineno"> 448</span> <span class="c">}</span>
<a name="c0-449"></a><span class="lineno"> 449</span> <span class="cp">#endif</span>
<a name="c0-450"></a><span class="lineno"> 450</span> 
<a name="c0-451"></a><span class="lineno"> 451</span> <span class="kt">void</span>
<a name="c0-452"></a><span class="lineno"> 452</span> <span class="n">dispose_exec_redirects</span> <span class="p">()</span>
<a name="c0-453"></a><span class="lineno"> 453</span> <span class="p">{</span>
<a name="c0-454"></a><span class="lineno"> 454</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exec_redirection_undo_list</span><span class="p">)</span>
<a name="c0-455"></a><span class="lineno"> 455</span>     <span class="p">{</span>
<a name="c0-456"></a><span class="lineno"> 456</span>       <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">exec_redirection_undo_list</span><span class="p">);</span>
<a name="c0-457"></a><span class="lineno"> 457</span>       <span class="n">exec_redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-458"></a><span class="lineno"> 458</span>     <span class="p">}</span>
<a name="c0-459"></a><span class="lineno"> 459</span> <span class="p">}</span>
<a name="c0-460"></a><span class="lineno"> 460</span> 
<a name="c0-461"></a><span class="lineno"> 461</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-462"></a><span class="lineno"> 462</span> <span class="cm">/* A function to restore the signal mask to its proper value when the shell</span>
<a name="c0-463"></a><span class="lineno"> 463</span> <span class="cm">   is interrupted or errors occur while creating a pipeline. */</span>
<a name="c0-464"></a><span class="lineno"> 464</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-465"></a><span class="lineno"> 465</span> <span class="n">restore_signal_mask</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
<a name="c0-466"></a><span class="lineno"> 466</span>      <span class="n">sigset_t</span> <span class="o">*</span><span class="n">set</span><span class="p">;</span>
<a name="c0-467"></a><span class="lineno"> 467</span> <span class="p">{</span>
<a name="c0-468"></a><span class="lineno"> 468</span>   <span class="k">return</span> <span class="p">(</span><span class="n">sigprocmask</span> <span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="p">(</span><span class="n">sigset_t</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">));</span>
<a name="c0-469"></a><span class="lineno"> 469</span> <span class="p">}</span>
<a name="c0-470"></a><span class="lineno"> 470</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-471"></a><span class="lineno"> 471</span> 
<a name="c0-472"></a><span class="lineno"> 472</span> <span class="cp">#ifdef DEBUG</span>
<a name="c0-473"></a><span class="lineno"> 473</span> <span class="cm">/* A debugging function that can be called from gdb, for instance. */</span>
<a name="c0-474"></a><span class="lineno"> 474</span> <span class="kt">void</span>
<a name="c0-475"></a><span class="lineno"> 475</span> <span class="n">open_files</span> <span class="p">()</span>
<a name="c0-476"></a><span class="lineno"> 476</span> <span class="p">{</span>
<a name="c0-477"></a><span class="lineno"> 477</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-478"></a><span class="lineno"> 478</span>   <span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">fd_table_size</span><span class="p">;</span>
<a name="c0-479"></a><span class="lineno"> 479</span> 
<a name="c0-480"></a><span class="lineno"> 480</span>   <span class="n">fd_table_size</span> <span class="o">=</span> <span class="n">getdtablesize</span> <span class="p">();</span>
<a name="c0-481"></a><span class="lineno"> 481</span> 
<a name="c0-482"></a><span class="lineno"> 482</span>   <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"pid %ld open files:"</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">getpid</span> <span class="p">());</span>
<a name="c0-483"></a><span class="lineno"> 483</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-484"></a><span class="lineno"> 484</span>     <span class="p">{</span>
<a name="c0-485"></a><span class="lineno"> 485</span>       <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">fcntl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">F_GETFD</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-486"></a><span class="lineno"> 486</span>   <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">" %d (%s)"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="o">?</span> <span class="s">"close"</span> <span class="o">:</span> <span class="s">"open"</span><span class="p">);</span>
<a name="c0-487"></a><span class="lineno"> 487</span>     <span class="p">}</span>
<a name="c0-488"></a><span class="lineno"> 488</span>   <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c0-489"></a><span class="lineno"> 489</span> <span class="p">}</span>
<a name="c0-490"></a><span class="lineno"> 490</span> <span class="cp">#endif</span>
<a name="c0-491"></a><span class="lineno"> 491</span> 
<a name="c0-492"></a><span class="lineno"> 492</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-493"></a><span class="lineno"> 493</span> <span class="n">async_redirect_stdin</span> <span class="p">()</span>
<a name="c0-494"></a><span class="lineno"> 494</span> <span class="p">{</span>
<a name="c0-495"></a><span class="lineno"> 495</span>   <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-496"></a><span class="lineno"> 496</span> 
<a name="c0-497"></a><span class="lineno"> 497</span>   <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span> <span class="p">(</span><span class="s">"/dev/null"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<a name="c0-498"></a><span class="lineno"> 498</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-499"></a><span class="lineno"> 499</span>     <span class="p">{</span>
<a name="c0-500"></a><span class="lineno"> 500</span>       <span class="n">dup2</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-501"></a><span class="lineno"> 501</span>       <span class="n">close</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c0-502"></a><span class="lineno"> 502</span>     <span class="p">}</span>
<a name="c0-503"></a><span class="lineno"> 503</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-504"></a><span class="lineno"> 504</span>     <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"cannot redirect standard input from /dev/null: %s"</span><span class="p">),</span> <span class="n">strerror</span> <span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-505"></a><span class="lineno"> 505</span> <span class="p">}</span>
<a name="c0-506"></a><span class="lineno"> 506</span> 
<a name="c0-507"></a><span class="lineno"> 507</span> <span class="cp">#define DESCRIBE_PID(pid) do { if (interactive) describe_pid (pid); } while (0)</span>
<a name="c0-508"></a><span class="lineno"> 508</span> 
<a name="c0-509"></a><span class="lineno"> 509</span> <span class="cm">/* Execute the command passed in COMMAND, perhaps doing it asynchrounously.</span>
<a name="c0-510"></a><span class="lineno"> 510</span> <span class="cm">   COMMAND is exactly what read_command () places into GLOBAL_COMMAND.</span>
<a name="c0-511"></a><span class="lineno"> 511</span> <span class="cm">   ASYNCHROUNOUS, if non-zero, says to do this command in the background.</span>
<a name="c0-512"></a><span class="lineno"> 512</span> <span class="cm">   PIPE_IN and PIPE_OUT are file descriptors saying where input comes</span>
<a name="c0-513"></a><span class="lineno"> 513</span> <span class="cm">   from and where it goes.  They can have the value of NO_PIPE, which means</span>
<a name="c0-514"></a><span class="lineno"> 514</span> <span class="cm">   I/O is stdin/stdout.</span>
<a name="c0-515"></a><span class="lineno"> 515</span> <span class="cm">   FDS_TO_CLOSE is a list of file descriptors to close once the child has</span>
<a name="c0-516"></a><span class="lineno"> 516</span> <span class="cm">   been forked.  This list often contains the unusable sides of pipes, etc.</span>
<a name="c0-517"></a><span class="lineno"> 517</span> 
<a name="c0-518"></a><span class="lineno"> 518</span> <span class="cm">   EXECUTION_SUCCESS or EXECUTION_FAILURE are the only possible</span>
<a name="c0-519"></a><span class="lineno"> 519</span> <span class="cm">   return values.  Executing a command with nothing in it returns</span>
<a name="c0-520"></a><span class="lineno"> 520</span> <span class="cm">   EXECUTION_SUCCESS. */</span>
<a name="c0-521"></a><span class="lineno"> 521</span> <span class="kt">int</span>
<a name="c0-522"></a><span class="lineno"> 522</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-523"></a><span class="lineno"> 523</span>         <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-524"></a><span class="lineno"> 524</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-525"></a><span class="lineno"> 525</span>      <span class="kt">int</span> <span class="n">asynchronous</span><span class="p">;</span>
<a name="c0-526"></a><span class="lineno"> 526</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-527"></a><span class="lineno"> 527</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-528"></a><span class="lineno"> 528</span> <span class="p">{</span>
<a name="c0-529"></a><span class="lineno"> 529</span>   <span class="kt">int</span> <span class="n">exec_result</span><span class="p">,</span> <span class="n">user_subshell</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">ignore_return</span><span class="p">,</span> <span class="n">was_error_trap</span><span class="p">;</span>
<a name="c0-530"></a><span class="lineno"> 530</span>   <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">my_undo_list</span><span class="p">,</span> <span class="o">*</span><span class="n">exec_undo_list</span><span class="p">;</span>
<a name="c0-531"></a><span class="lineno"> 531</span>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">last_pid</span><span class="p">;</span>
<a name="c0-532"></a><span class="lineno"> 532</span>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-533"></a><span class="lineno"> 533</span> 
<a name="c0-534"></a><span class="lineno"> 534</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-535"></a><span class="lineno"> 535</span> <span class="c">  if (command == 0 || breaking || continuing || read_but_dont_execute)</span>
<a name="c0-536"></a><span class="lineno"> 536</span> <span class="c">    return (EXECUTION_SUCCESS);</span>
<a name="c0-537"></a><span class="lineno"> 537</span> <span class="cp">#else</span>
<a name="c0-538"></a><span class="lineno"> 538</span>   <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span> <span class="o">||</span> <span class="n">continuing</span><span class="p">)</span>
<a name="c0-539"></a><span class="lineno"> 539</span>     <span class="k">return</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c0-540"></a><span class="lineno"> 540</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">read_but_dont_execute</span><span class="p">)</span>
<a name="c0-541"></a><span class="lineno"> 541</span>     <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-542"></a><span class="lineno"> 542</span> <span class="cp">#endif</span>
<a name="c0-543"></a><span class="lineno"> 543</span> 
<a name="c0-544"></a><span class="lineno"> 544</span>   <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-545"></a><span class="lineno"> 545</span>   <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-546"></a><span class="lineno"> 546</span> 
<a name="c0-547"></a><span class="lineno"> 547</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-548"></a><span class="lineno"> 548</span> <span class="c">  if (running_trap == 0)</span>
<a name="c0-549"></a><span class="lineno"> 549</span> <span class="cp">#endif</span>
<a name="c0-550"></a><span class="lineno"> 550</span>     <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<a name="c0-551"></a><span class="lineno"> 551</span> 
<a name="c0-552"></a><span class="lineno"> 552</span>   <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-553"></a><span class="lineno"> 553</span> 
<a name="c0-554"></a><span class="lineno"> 554</span>   <span class="cm">/* If we're inverting the return value and `set -e' has been executed,</span>
<a name="c0-555"></a><span class="lineno"> 555</span> <span class="cm">     we don't want a failing command to inadvertently cause the shell</span>
<a name="c0-556"></a><span class="lineno"> 556</span> <span class="cm">     to exit. */</span>
<a name="c0-557"></a><span class="lineno"> 557</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exit_immediately_on_error</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span><span class="p">)</span>  <span class="cm">/* XXX */</span>
<a name="c0-558"></a><span class="lineno"> 558</span>     <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span> <span class="cm">/* XXX */</span>
<a name="c0-559"></a><span class="lineno"> 559</span> 
<a name="c0-560"></a><span class="lineno"> 560</span>   <span class="n">exec_result</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-561"></a><span class="lineno"> 561</span> 
<a name="c0-562"></a><span class="lineno"> 562</span>   <span class="cm">/* If a command was being explicitly run in a subshell, or if it is</span>
<a name="c0-563"></a><span class="lineno"> 563</span> <span class="cm">     a shell control-structure, and it has a pipe, then we do the command</span>
<a name="c0-564"></a><span class="lineno"> 564</span> <span class="cm">     in a subshell. */</span>
<a name="c0-565"></a><span class="lineno"> 565</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_subshell</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_NO_FORK</span><span class="p">))</span>
<a name="c0-566"></a><span class="lineno"> 566</span>     <span class="k">return</span> <span class="p">(</span><span class="n">execute_in_subshell</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">));</span>
<a name="c0-567"></a><span class="lineno"> 567</span> 
<a name="c0-568"></a><span class="lineno"> 568</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c0-569"></a><span class="lineno"> 569</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_coproc</span><span class="p">)</span>
<a name="c0-570"></a><span class="lineno"> 570</span>     <span class="k">return</span> <span class="p">(</span><span class="n">execute_coproc</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">));</span>
<a name="c0-571"></a><span class="lineno"> 571</span> <span class="cp">#endif</span>
<a name="c0-572"></a><span class="lineno"> 572</span> 
<a name="c0-573"></a><span class="lineno"> 573</span>   <span class="n">user_subshell</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_subshell</span> <span class="o">||</span> <span class="p">((</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_WANT_SUBSHELL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-574"></a><span class="lineno"> 574</span> 
<a name="c0-575"></a><span class="lineno"> 575</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_subshell</span> <span class="o">||</span>
<a name="c0-576"></a><span class="lineno"> 576</span>       <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CMD_WANT_SUBSHELL</span><span class="o">|</span><span class="n">CMD_FORCE_SUBSHELL</span><span class="p">))</span> <span class="o">||</span>
<a name="c0-577"></a><span class="lineno"> 577</span>       <span class="p">(</span><span class="n">shell_control_structure</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-578"></a><span class="lineno"> 578</span>        <span class="p">(</span><span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">asynchronous</span><span class="p">)))</span>
<a name="c0-579"></a><span class="lineno"> 579</span>     <span class="p">{</span>
<a name="c0-580"></a><span class="lineno"> 580</span>       <span class="n">pid_t</span> <span class="n">paren_pid</span><span class="p">;</span>
<a name="c0-581"></a><span class="lineno"> 581</span> 
<a name="c0-582"></a><span class="lineno"> 582</span>       <span class="cm">/* Fork a subshell, turn off the subshell bit, turn off job</span>
<a name="c0-583"></a><span class="lineno"> 583</span> <span class="cm">  control and call execute_command () on the command again. */</span>
<a name="c0-584"></a><span class="lineno"> 584</span>       <span class="n">line_number_for_err_trap</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-585"></a><span class="lineno"> 585</span>       <span class="n">paren_pid</span> <span class="o">=</span> <span class="n">make_child</span> <span class="p">(</span><span class="n">savestring</span> <span class="p">(</span><span class="n">make_command_string</span> <span class="p">(</span><span class="n">command</span><span class="p">)),</span>
<a name="c0-586"></a><span class="lineno"> 586</span>             <span class="n">asynchronous</span><span class="p">);</span>
<a name="c0-587"></a><span class="lineno"> 587</span>       <span class="k">if</span> <span class="p">(</span><span class="n">paren_pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-588"></a><span class="lineno"> 588</span>   <span class="n">exit</span> <span class="p">(</span><span class="n">execute_in_subshell</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">));</span>
<a name="c0-589"></a><span class="lineno"> 589</span>   <span class="cm">/* NOTREACHED */</span>
<a name="c0-590"></a><span class="lineno"> 590</span>       <span class="k">else</span>
<a name="c0-591"></a><span class="lineno"> 591</span>   <span class="p">{</span>
<a name="c0-592"></a><span class="lineno"> 592</span>     <span class="n">close_pipes</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-593"></a><span class="lineno"> 593</span> 
<a name="c0-594"></a><span class="lineno"> 594</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION) &amp;&amp; defined (HAVE_DEV_FD)</span>
<a name="c0-595"></a><span class="lineno"> 595</span>     <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-596"></a><span class="lineno"> 596</span> <span class="cp">#endif</span>
<a name="c0-597"></a><span class="lineno"> 597</span>     <span class="cm">/* If we are part of a pipeline, and not the end of the pipeline,</span>
<a name="c0-598"></a><span class="lineno"> 598</span> <span class="cm">      then we should simply return and let the last command in the</span>
<a name="c0-599"></a><span class="lineno"> 599</span> <span class="cm">      pipe be waited for.  If we are not in a pipeline, or are the</span>
<a name="c0-600"></a><span class="lineno"> 600</span> <span class="cm">      last command in the pipeline, then we wait for the subshell</span>
<a name="c0-601"></a><span class="lineno"> 601</span> <span class="cm">      and return its exit status as usual. */</span>
<a name="c0-602"></a><span class="lineno"> 602</span>     <span class="k">if</span> <span class="p">(</span><span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-603"></a><span class="lineno"> 603</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-604"></a><span class="lineno"> 604</span> 
<a name="c0-605"></a><span class="lineno"> 605</span>     <span class="n">stop_pipeline</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">,</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-606"></a><span class="lineno"> 606</span> 
<a name="c0-607"></a><span class="lineno"> 607</span>     <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-608"></a><span class="lineno"> 608</span>       <span class="p">{</span>
<a name="c0-609"></a><span class="lineno"> 609</span>         <span class="n">was_error_trap</span> <span class="o">=</span> <span class="n">signal_is_trapped</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signal_is_ignored</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-610"></a><span class="lineno"> 610</span>         <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-611"></a><span class="lineno"> 611</span>         <span class="n">ignore_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-612"></a><span class="lineno"> 612</span> 
<a name="c0-613"></a><span class="lineno"> 613</span>         <span class="n">exec_result</span> <span class="o">=</span> <span class="n">wait_for</span> <span class="p">(</span><span class="n">paren_pid</span><span class="p">);</span>
<a name="c0-614"></a><span class="lineno"> 614</span> 
<a name="c0-615"></a><span class="lineno"> 615</span>         <span class="cm">/* If we have to, invert the return value. */</span>
<a name="c0-616"></a><span class="lineno"> 616</span>         <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
<a name="c0-617"></a><span class="lineno"> 617</span>     <span class="n">exec_result</span> <span class="o">=</span> <span class="p">((</span><span class="n">exec_result</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-618"></a><span class="lineno"> 618</span>         <span class="o">?</span> <span class="n">EXECUTION_FAILURE</span>
<a name="c0-619"></a><span class="lineno"> 619</span>         <span class="o">:</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-620"></a><span class="lineno"> 620</span> 
<a name="c0-621"></a><span class="lineno"> 621</span>         <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-622"></a><span class="lineno"> 622</span>         <span class="k">if</span> <span class="p">(</span><span class="n">user_subshell</span> <span class="o">&amp;&amp;</span> <span class="n">was_error_trap</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-623"></a><span class="lineno"> 623</span>     <span class="p">{</span>
<a name="c0-624"></a><span class="lineno"> 624</span>       <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-625"></a><span class="lineno"> 625</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">line_number_for_err_trap</span><span class="p">;</span>
<a name="c0-626"></a><span class="lineno"> 626</span>       <span class="n">run_error_trap</span> <span class="p">();</span>
<a name="c0-627"></a><span class="lineno"> 627</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-628"></a><span class="lineno"> 628</span>     <span class="p">}</span>
<a name="c0-629"></a><span class="lineno"> 629</span> 
<a name="c0-630"></a><span class="lineno"> 630</span>         <span class="k">if</span> <span class="p">(</span><span class="n">user_subshell</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exit_immediately_on_error</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-631"></a><span class="lineno"> 631</span>     <span class="p">{</span>
<a name="c0-632"></a><span class="lineno"> 632</span>       <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-633"></a><span class="lineno"> 633</span>       <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-634"></a><span class="lineno"> 634</span>     <span class="p">}</span>
<a name="c0-635"></a><span class="lineno"> 635</span> 
<a name="c0-636"></a><span class="lineno"> 636</span>         <span class="k">return</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c0-637"></a><span class="lineno"> 637</span>       <span class="p">}</span>
<a name="c0-638"></a><span class="lineno"> 638</span>     <span class="k">else</span>
<a name="c0-639"></a><span class="lineno"> 639</span>       <span class="p">{</span>
<a name="c0-640"></a><span class="lineno"> 640</span>         <span class="n">DESCRIBE_PID</span> <span class="p">(</span><span class="n">paren_pid</span><span class="p">);</span>
<a name="c0-641"></a><span class="lineno"> 641</span> 
<a name="c0-642"></a><span class="lineno"> 642</span>         <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-643"></a><span class="lineno"> 643</span> 
<a name="c0-644"></a><span class="lineno"> 644</span>         <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-645"></a><span class="lineno"> 645</span>       <span class="p">}</span>
<a name="c0-646"></a><span class="lineno"> 646</span>   <span class="p">}</span>
<a name="c0-647"></a><span class="lineno"> 647</span>     <span class="p">}</span>
<a name="c0-648"></a><span class="lineno"> 648</span> 
<a name="c0-649"></a><span class="lineno"> 649</span> <span class="cp">#if defined (COMMAND_TIMING)</span>
<a name="c0-650"></a><span class="lineno"> 650</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_TIME_PIPELINE</span><span class="p">)</span>
<a name="c0-651"></a><span class="lineno"> 651</span>     <span class="p">{</span>
<a name="c0-652"></a><span class="lineno"> 652</span>       <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-653"></a><span class="lineno"> 653</span>   <span class="p">{</span>
<a name="c0-654"></a><span class="lineno"> 654</span>     <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_FORCE_SUBSHELL</span><span class="p">;</span>
<a name="c0-655"></a><span class="lineno"> 655</span>     <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-656"></a><span class="lineno"> 656</span>   <span class="p">}</span>
<a name="c0-657"></a><span class="lineno"> 657</span>       <span class="k">else</span>
<a name="c0-658"></a><span class="lineno"> 658</span>   <span class="p">{</span>
<a name="c0-659"></a><span class="lineno"> 659</span>     <span class="n">exec_result</span> <span class="o">=</span> <span class="n">time_command</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-660"></a><span class="lineno"> 660</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-661"></a><span class="lineno"> 661</span> <span class="c">    if (running_trap == 0)</span>
<a name="c0-662"></a><span class="lineno"> 662</span> <span class="cp">#endif</span>
<a name="c0-663"></a><span class="lineno"> 663</span>       <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-664"></a><span class="lineno"> 664</span>   <span class="p">}</span>
<a name="c0-665"></a><span class="lineno"> 665</span>       <span class="k">return</span> <span class="p">(</span><span class="n">exec_result</span><span class="p">);</span>
<a name="c0-666"></a><span class="lineno"> 666</span>     <span class="p">}</span>
<a name="c0-667"></a><span class="lineno"> 667</span> <span class="cp">#endif </span><span class="cm">/* COMMAND_TIMING */</span><span class="cp"></span>
<a name="c0-668"></a><span class="lineno"> 668</span> 
<a name="c0-669"></a><span class="lineno"> 669</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shell_control_structure</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">)</span>
<a name="c0-670"></a><span class="lineno"> 670</span>     <span class="n">stdin_redir</span> <span class="o">=</span> <span class="n">stdin_redirects</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">);</span>
<a name="c0-671"></a><span class="lineno"> 671</span> 
<a name="c0-672"></a><span class="lineno"> 672</span>   <span class="cm">/* Handle WHILE FOR CASE etc. with redirections.  (Also '&amp;' input</span>
<a name="c0-673"></a><span class="lineno"> 673</span> <span class="cm">     redirection.)  */</span>
<a name="c0-674"></a><span class="lineno"> 674</span>   <span class="k">if</span> <span class="p">(</span><span class="n">do_redirections</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="o">|</span><span class="n">RX_UNDOABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-675"></a><span class="lineno"> 675</span>     <span class="p">{</span>
<a name="c0-676"></a><span class="lineno"> 676</span>       <span class="n">cleanup_redirects</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">);</span>
<a name="c0-677"></a><span class="lineno"> 677</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-678"></a><span class="lineno"> 678</span>       <span class="n">dispose_exec_redirects</span> <span class="p">();</span>
<a name="c0-679"></a><span class="lineno"> 679</span>       <span class="k">return</span> <span class="p">(</span><span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-680"></a><span class="lineno"> 680</span>     <span class="p">}</span>
<a name="c0-681"></a><span class="lineno"> 681</span> 
<a name="c0-682"></a><span class="lineno"> 682</span>   <span class="k">if</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">)</span>
<a name="c0-683"></a><span class="lineno"> 683</span>     <span class="p">{</span>
<a name="c0-684"></a><span class="lineno"> 684</span>       <span class="cm">/* XXX - why copy here? */</span>
<a name="c0-685"></a><span class="lineno"> 685</span>       <span class="n">my_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="n">copy_redirects</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">);</span>
<a name="c0-686"></a><span class="lineno"> 686</span>       <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">);</span>
<a name="c0-687"></a><span class="lineno"> 687</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-688"></a><span class="lineno"> 688</span>     <span class="p">}</span>
<a name="c0-689"></a><span class="lineno"> 689</span>   <span class="k">else</span>
<a name="c0-690"></a><span class="lineno"> 690</span>     <span class="n">my_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-691"></a><span class="lineno"> 691</span> 
<a name="c0-692"></a><span class="lineno"> 692</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exec_redirection_undo_list</span><span class="p">)</span>
<a name="c0-693"></a><span class="lineno"> 693</span>     <span class="p">{</span>
<a name="c0-694"></a><span class="lineno"> 694</span>       <span class="cm">/* XXX - why copy here? */</span>
<a name="c0-695"></a><span class="lineno"> 695</span>       <span class="n">exec_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="n">copy_redirects</span> <span class="p">(</span><span class="n">exec_redirection_undo_list</span><span class="p">);</span>
<a name="c0-696"></a><span class="lineno"> 696</span>       <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">exec_redirection_undo_list</span><span class="p">);</span>
<a name="c0-697"></a><span class="lineno"> 697</span>       <span class="n">exec_redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-698"></a><span class="lineno"> 698</span>     <span class="p">}</span>
<a name="c0-699"></a><span class="lineno"> 699</span>   <span class="k">else</span>
<a name="c0-700"></a><span class="lineno"> 700</span>     <span class="n">exec_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-701"></a><span class="lineno"> 701</span> 
<a name="c0-702"></a><span class="lineno"> 702</span>   <span class="k">if</span> <span class="p">(</span><span class="n">my_undo_list</span> <span class="o">||</span> <span class="n">exec_undo_list</span><span class="p">)</span>
<a name="c0-703"></a><span class="lineno"> 703</span>     <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"loop_redirections"</span><span class="p">);</span>
<a name="c0-704"></a><span class="lineno"> 704</span> 
<a name="c0-705"></a><span class="lineno"> 705</span>   <span class="k">if</span> <span class="p">(</span><span class="n">my_undo_list</span><span class="p">)</span>
<a name="c0-706"></a><span class="lineno"> 706</span>     <span class="n">add_unwind_protect</span> <span class="p">((</span><span class="n">Function</span> <span class="o">*</span><span class="p">)</span><span class="n">cleanup_redirects</span><span class="p">,</span> <span class="n">my_undo_list</span><span class="p">);</span>
<a name="c0-707"></a><span class="lineno"> 707</span> 
<a name="c0-708"></a><span class="lineno"> 708</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exec_undo_list</span><span class="p">)</span>
<a name="c0-709"></a><span class="lineno"> 709</span>     <span class="n">add_unwind_protect</span> <span class="p">((</span><span class="n">Function</span> <span class="o">*</span><span class="p">)</span><span class="n">dispose_redirects</span><span class="p">,</span> <span class="n">exec_undo_list</span><span class="p">);</span>
<a name="c0-710"></a><span class="lineno"> 710</span> 
<a name="c0-711"></a><span class="lineno"> 711</span>   <span class="n">ignore_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-712"></a><span class="lineno"> 712</span> 
<a name="c0-713"></a><span class="lineno"> 713</span>   <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-714"></a><span class="lineno"> 714</span> 
<a name="c0-715"></a><span class="lineno"> 715</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
<a name="c0-716"></a><span class="lineno"> 716</span>     <span class="p">{</span>
<a name="c0-717"></a><span class="lineno"> 717</span>     <span class="k">case</span> <span class="n">cm_simple</span>:
<a name="c0-718"></a><span class="lineno"> 718</span>       <span class="p">{</span>
<a name="c0-719"></a><span class="lineno"> 719</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-720"></a><span class="lineno"> 720</span>   <span class="cm">/* We can't rely on variables retaining their values across a</span>
<a name="c0-721"></a><span class="lineno"> 721</span> <span class="cm">    call to execute_simple_command if a longjmp occurs as the</span>
<a name="c0-722"></a><span class="lineno"> 722</span> <span class="cm">    result of a `return' builtin.  This is true for sure with gcc. */</span>
<a name="c0-723"></a><span class="lineno"> 723</span> <span class="cp">#if defined (RECYCLES_PIDS)</span>
<a name="c0-724"></a><span class="lineno"> 724</span>   <span class="n">last_made_pid</span> <span class="o">=</span> <span class="n">NO_PID</span><span class="p">;</span>
<a name="c0-725"></a><span class="lineno"> 725</span> <span class="cp">#endif</span>
<a name="c0-726"></a><span class="lineno"> 726</span>   <span class="n">last_pid</span> <span class="o">=</span> <span class="n">last_made_pid</span><span class="p">;</span>
<a name="c0-727"></a><span class="lineno"> 727</span>   <span class="n">was_error_trap</span> <span class="o">=</span> <span class="n">signal_is_trapped</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signal_is_ignored</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-728"></a><span class="lineno"> 728</span> 
<a name="c0-729"></a><span class="lineno"> 729</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="p">)</span>
<a name="c0-730"></a><span class="lineno"> 730</span>     <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-731"></a><span class="lineno"> 731</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">)</span>
<a name="c0-732"></a><span class="lineno"> 732</span>     <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">;</span>
<a name="c0-733"></a><span class="lineno"> 733</span> 
<a name="c0-734"></a><span class="lineno"> 734</span>   <span class="n">line_number_for_err_trap</span> <span class="o">=</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-735"></a><span class="lineno"> 735</span>   <span class="n">exec_result</span> <span class="o">=</span>
<a name="c0-736"></a><span class="lineno"> 736</span>     <span class="n">execute_simple_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-737"></a><span class="lineno"> 737</span>           <span class="n">asynchronous</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-738"></a><span class="lineno"> 738</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-739"></a><span class="lineno"> 739</span> 
<a name="c0-740"></a><span class="lineno"> 740</span>   <span class="cm">/* The temporary environment should be used for only the simple</span>
<a name="c0-741"></a><span class="lineno"> 741</span> <span class="cm">    command immediately following its definition. */</span>
<a name="c0-742"></a><span class="lineno"> 742</span>   <span class="n">dispose_used_env_vars</span> <span class="p">();</span>
<a name="c0-743"></a><span class="lineno"> 743</span> 
<a name="c0-744"></a><span class="lineno"> 744</span> <span class="cp">#if (defined (ultrix) &amp;&amp; defined (mips)) || defined (C_ALLOCA)</span>
<a name="c0-745"></a><span class="lineno"> 745</span>   <span class="cm">/* Reclaim memory allocated with alloca () on machines which</span>
<a name="c0-746"></a><span class="lineno"> 746</span> <span class="cm">    may be using the alloca emulation code. */</span>
<a name="c0-747"></a><span class="lineno"> 747</span>   <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">alloca</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-748"></a><span class="lineno"> 748</span> <span class="cp">#endif </span><span class="cm">/* (ultrix &amp;&amp; mips) || C_ALLOCA */</span><span class="cp"></span>
<a name="c0-749"></a><span class="lineno"> 749</span> 
<a name="c0-750"></a><span class="lineno"> 750</span>   <span class="cm">/* If we forked to do the command, then we must wait_for ()</span>
<a name="c0-751"></a><span class="lineno"> 751</span> <span class="cm">    the child. */</span>
<a name="c0-752"></a><span class="lineno"> 752</span> 
<a name="c0-753"></a><span class="lineno"> 753</span>   <span class="cm">/* XXX - this is something to watch out for if there are problems</span>
<a name="c0-754"></a><span class="lineno"> 754</span> <span class="cm">    when the shell is compiled without job control. */</span>
<a name="c0-755"></a><span class="lineno"> 755</span>   <span class="k">if</span> <span class="p">(</span><span class="n">already_making_children</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-756"></a><span class="lineno"> 756</span>       <span class="n">last_made_pid</span> <span class="o">!=</span> <span class="n">last_pid</span><span class="p">)</span>
<a name="c0-757"></a><span class="lineno"> 757</span>     <span class="p">{</span>
<a name="c0-758"></a><span class="lineno"> 758</span>       <span class="n">stop_pipeline</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">,</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-759"></a><span class="lineno"> 759</span> 
<a name="c0-760"></a><span class="lineno"> 760</span>       <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-761"></a><span class="lineno"> 761</span>         <span class="p">{</span>
<a name="c0-762"></a><span class="lineno"> 762</span>     <span class="n">DESCRIBE_PID</span> <span class="p">(</span><span class="n">last_made_pid</span><span class="p">);</span>
<a name="c0-763"></a><span class="lineno"> 763</span>         <span class="p">}</span>
<a name="c0-764"></a><span class="lineno"> 764</span>       <span class="k">else</span>
<a name="c0-765"></a><span class="lineno"> 765</span> <span class="cp">#if !defined (JOB_CONTROL)</span>
<a name="c0-766"></a><span class="lineno"> 766</span>         <span class="cm">/* Do not wait for asynchronous processes started from</span>
<a name="c0-767"></a><span class="lineno"> 767</span> <span class="cm">    startup files. */</span>
<a name="c0-768"></a><span class="lineno"> 768</span>       <span class="k">if</span> <span class="p">(</span><span class="n">last_made_pid</span> <span class="o">!=</span> <span class="n">last_asynchronous_pid</span><span class="p">)</span>
<a name="c0-769"></a><span class="lineno"> 769</span> <span class="cp">#endif</span>
<a name="c0-770"></a><span class="lineno"> 770</span>       <span class="cm">/* When executing a shell function that executes other</span>
<a name="c0-771"></a><span class="lineno"> 771</span> <span class="cm">        commands, this causes the last simple command in</span>
<a name="c0-772"></a><span class="lineno"> 772</span> <span class="cm">        the function to be waited for twice.  This also causes</span>
<a name="c0-773"></a><span class="lineno"> 773</span> <span class="cm">        subshells forked to execute builtin commands (e.g., in</span>
<a name="c0-774"></a><span class="lineno"> 774</span> <span class="cm">        pipelines) to be waited for twice. */</span>
<a name="c0-775"></a><span class="lineno"> 775</span>         <span class="n">exec_result</span> <span class="o">=</span> <span class="n">wait_for</span> <span class="p">(</span><span class="n">last_made_pid</span><span class="p">);</span>
<a name="c0-776"></a><span class="lineno"> 776</span>     <span class="p">}</span>
<a name="c0-777"></a><span class="lineno"> 777</span>       <span class="p">}</span>
<a name="c0-778"></a><span class="lineno"> 778</span> 
<a name="c0-779"></a><span class="lineno"> 779</span>       <span class="cm">/* 2009/02/13 -- pipeline failure is processed elsewhere.  This handles</span>
<a name="c0-780"></a><span class="lineno"> 780</span> <span class="cm">  only the failure of a simple command. */</span>
<a name="c0-781"></a><span class="lineno"> 781</span>       <span class="k">if</span> <span class="p">(</span><span class="n">was_error_trap</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-782"></a><span class="lineno"> 782</span>   <span class="p">{</span>
<a name="c0-783"></a><span class="lineno"> 783</span>     <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-784"></a><span class="lineno"> 784</span>     <span class="n">line_number</span> <span class="o">=</span> <span class="n">line_number_for_err_trap</span><span class="p">;</span>
<a name="c0-785"></a><span class="lineno"> 785</span>     <span class="n">run_error_trap</span> <span class="p">();</span>
<a name="c0-786"></a><span class="lineno"> 786</span>     <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-787"></a><span class="lineno"> 787</span>   <span class="p">}</span>
<a name="c0-788"></a><span class="lineno"> 788</span> 
<a name="c0-789"></a><span class="lineno"> 789</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-790"></a><span class="lineno"> 790</span>     <span class="p">((</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">interactive</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">special_builtin_failed</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-791"></a><span class="lineno"> 791</span>      <span class="p">(</span><span class="n">exit_immediately_on_error</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)))</span>
<a name="c0-792"></a><span class="lineno"> 792</span>   <span class="p">{</span>
<a name="c0-793"></a><span class="lineno"> 793</span>     <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-794"></a><span class="lineno"> 794</span>     <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-795"></a><span class="lineno"> 795</span>     <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-796"></a><span class="lineno"> 796</span>   <span class="p">}</span>
<a name="c0-797"></a><span class="lineno"> 797</span> 
<a name="c0-798"></a><span class="lineno"> 798</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-799"></a><span class="lineno"> 799</span> 
<a name="c0-800"></a><span class="lineno"> 800</span>     <span class="k">case</span> <span class="n">cm_for</span>:
<a name="c0-801"></a><span class="lineno"> 801</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-802"></a><span class="lineno"> 802</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">For</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-803"></a><span class="lineno"> 803</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_for_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">For</span><span class="p">);</span>
<a name="c0-804"></a><span class="lineno"> 804</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-805"></a><span class="lineno"> 805</span> 
<a name="c0-806"></a><span class="lineno"> 806</span> <span class="cp">#if defined (ARITH_FOR_COMMAND)</span>
<a name="c0-807"></a><span class="lineno"> 807</span>     <span class="k">case</span> <span class="n">cm_arith_for</span>:
<a name="c0-808"></a><span class="lineno"> 808</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-809"></a><span class="lineno"> 809</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">ArithFor</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-810"></a><span class="lineno"> 810</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_arith_for_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">ArithFor</span><span class="p">);</span>
<a name="c0-811"></a><span class="lineno"> 811</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-812"></a><span class="lineno"> 812</span> <span class="cp">#endif</span>
<a name="c0-813"></a><span class="lineno"> 813</span> 
<a name="c0-814"></a><span class="lineno"> 814</span> <span class="cp">#if defined (SELECT_COMMAND)</span>
<a name="c0-815"></a><span class="lineno"> 815</span>     <span class="k">case</span> <span class="n">cm_select</span>:
<a name="c0-816"></a><span class="lineno"> 816</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-817"></a><span class="lineno"> 817</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Select</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-818"></a><span class="lineno"> 818</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_select_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Select</span><span class="p">);</span>
<a name="c0-819"></a><span class="lineno"> 819</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-820"></a><span class="lineno"> 820</span> <span class="cp">#endif</span>
<a name="c0-821"></a><span class="lineno"> 821</span> 
<a name="c0-822"></a><span class="lineno"> 822</span>     <span class="k">case</span> <span class="n">cm_case</span>:
<a name="c0-823"></a><span class="lineno"> 823</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-824"></a><span class="lineno"> 824</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Case</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-825"></a><span class="lineno"> 825</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_case_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Case</span><span class="p">);</span>
<a name="c0-826"></a><span class="lineno"> 826</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-827"></a><span class="lineno"> 827</span> 
<a name="c0-828"></a><span class="lineno"> 828</span>     <span class="k">case</span> <span class="n">cm_while</span>:
<a name="c0-829"></a><span class="lineno"> 829</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-830"></a><span class="lineno"> 830</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">While</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-831"></a><span class="lineno"> 831</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_while_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">While</span><span class="p">);</span>
<a name="c0-832"></a><span class="lineno"> 832</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-833"></a><span class="lineno"> 833</span> 
<a name="c0-834"></a><span class="lineno"> 834</span>     <span class="k">case</span> <span class="n">cm_until</span>:
<a name="c0-835"></a><span class="lineno"> 835</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-836"></a><span class="lineno"> 836</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">While</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-837"></a><span class="lineno"> 837</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_until_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">While</span><span class="p">);</span>
<a name="c0-838"></a><span class="lineno"> 838</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-839"></a><span class="lineno"> 839</span> 
<a name="c0-840"></a><span class="lineno"> 840</span>     <span class="k">case</span> <span class="n">cm_if</span>:
<a name="c0-841"></a><span class="lineno"> 841</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-842"></a><span class="lineno"> 842</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">If</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-843"></a><span class="lineno"> 843</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_if_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">If</span><span class="p">);</span>
<a name="c0-844"></a><span class="lineno"> 844</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-845"></a><span class="lineno"> 845</span> 
<a name="c0-846"></a><span class="lineno"> 846</span>     <span class="k">case</span> <span class="n">cm_group</span>:
<a name="c0-847"></a><span class="lineno"> 847</span> 
<a name="c0-848"></a><span class="lineno"> 848</span>       <span class="cm">/* This code can be executed from either of two paths: an explicit</span>
<a name="c0-849"></a><span class="lineno"> 849</span> <span class="cm">  '{}' command, or via a function call.  If we are executed via a</span>
<a name="c0-850"></a><span class="lineno"> 850</span> <span class="cm">  function call, we have already taken care of the function being</span>
<a name="c0-851"></a><span class="lineno"> 851</span> <span class="cm">  executed in the background (down there in execute_simple_command ()),</span>
<a name="c0-852"></a><span class="lineno"> 852</span> <span class="cm">  and this command should *not* be marked as asynchronous.  If we</span>
<a name="c0-853"></a><span class="lineno"> 853</span> <span class="cm">  are executing a regular '{}' group command, and asynchronous == 1,</span>
<a name="c0-854"></a><span class="lineno"> 854</span> <span class="cm">  we must want to execute the whole command in the background, so we</span>
<a name="c0-855"></a><span class="lineno"> 855</span> <span class="cm">  need a subshell, and we want the stuff executed in that subshell</span>
<a name="c0-856"></a><span class="lineno"> 856</span> <span class="cm">  (this group command) to be executed in the foreground of that</span>
<a name="c0-857"></a><span class="lineno"> 857</span> <span class="cm">  subshell (i.e. there will not be *another* subshell forked).</span>
<a name="c0-858"></a><span class="lineno"> 858</span> 
<a name="c0-859"></a><span class="lineno"> 859</span> <span class="cm">  What we do is to force a subshell if asynchronous, and then call</span>
<a name="c0-860"></a><span class="lineno"> 860</span> <span class="cm">  execute_command_internal again with asynchronous still set to 1,</span>
<a name="c0-861"></a><span class="lineno"> 861</span> <span class="cm">  but with the original group command, so the printed command will</span>
<a name="c0-862"></a><span class="lineno"> 862</span> <span class="cm">  look right.</span>
<a name="c0-863"></a><span class="lineno"> 863</span> 
<a name="c0-864"></a><span class="lineno"> 864</span> <span class="cm">  The code above that handles forking off subshells will note that</span>
<a name="c0-865"></a><span class="lineno"> 865</span> <span class="cm">  both subshell and async are on, and turn off async in the child</span>
<a name="c0-866"></a><span class="lineno"> 866</span> <span class="cm">  after forking the subshell (but leave async set in the parent, so</span>
<a name="c0-867"></a><span class="lineno"> 867</span> <span class="cm">  the normal call to describe_pid is made).  This turning off</span>
<a name="c0-868"></a><span class="lineno"> 868</span> <span class="cm">  async is *crucial*; if it is not done, this will fall into an</span>
<a name="c0-869"></a><span class="lineno"> 869</span> <span class="cm">  infinite loop of executions through this spot in subshell after</span>
<a name="c0-870"></a><span class="lineno"> 870</span> <span class="cm">  subshell until the process limit is exhausted. */</span>
<a name="c0-871"></a><span class="lineno"> 871</span> 
<a name="c0-872"></a><span class="lineno"> 872</span>       <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-873"></a><span class="lineno"> 873</span>   <span class="p">{</span>
<a name="c0-874"></a><span class="lineno"> 874</span>     <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_FORCE_SUBSHELL</span><span class="p">;</span>
<a name="c0-875"></a><span class="lineno"> 875</span>     <span class="n">exec_result</span> <span class="o">=</span>
<a name="c0-876"></a><span class="lineno"> 876</span>       <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-877"></a><span class="lineno"> 877</span>               <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-878"></a><span class="lineno"> 878</span>   <span class="p">}</span>
<a name="c0-879"></a><span class="lineno"> 879</span>       <span class="k">else</span>
<a name="c0-880"></a><span class="lineno"> 880</span>   <span class="p">{</span>
<a name="c0-881"></a><span class="lineno"> 881</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Group</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
<a name="c0-882"></a><span class="lineno"> 882</span>       <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Group</span><span class="o">-&gt;</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-883"></a><span class="lineno"> 883</span>     <span class="n">exec_result</span> <span class="o">=</span>
<a name="c0-884"></a><span class="lineno"> 884</span>       <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Group</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span>
<a name="c0-885"></a><span class="lineno"> 885</span>               <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-886"></a><span class="lineno"> 886</span>               <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-887"></a><span class="lineno"> 887</span>   <span class="p">}</span>
<a name="c0-888"></a><span class="lineno"> 888</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-889"></a><span class="lineno"> 889</span> 
<a name="c0-890"></a><span class="lineno"> 890</span>     <span class="k">case</span> <span class="n">cm_connection</span>:
<a name="c0-891"></a><span class="lineno"> 891</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_connection</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span>
<a name="c0-892"></a><span class="lineno"> 892</span>           <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-893"></a><span class="lineno"> 893</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-894"></a><span class="lineno"> 894</span> 
<a name="c0-895"></a><span class="lineno"> 895</span> <span class="cp">#if defined (DPAREN_ARITHMETIC)</span>
<a name="c0-896"></a><span class="lineno"> 896</span>     <span class="k">case</span> <span class="n">cm_arith</span>:
<a name="c0-897"></a><span class="lineno"> 897</span>       <span class="n">was_error_trap</span> <span class="o">=</span> <span class="n">signal_is_trapped</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signal_is_ignored</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-898"></a><span class="lineno"> 898</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-899"></a><span class="lineno"> 899</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Arith</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-900"></a><span class="lineno"> 900</span>       <span class="n">line_number_for_err_trap</span> <span class="o">=</span> <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-901"></a><span class="lineno"> 901</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_arith_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Arith</span><span class="p">);</span>
<a name="c0-902"></a><span class="lineno"> 902</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-903"></a><span class="lineno"> 903</span> 
<a name="c0-904"></a><span class="lineno"> 904</span>       <span class="k">if</span> <span class="p">(</span><span class="n">was_error_trap</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-905"></a><span class="lineno"> 905</span>   <span class="p">{</span>
<a name="c0-906"></a><span class="lineno"> 906</span>     <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-907"></a><span class="lineno"> 907</span>     <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-908"></a><span class="lineno"> 908</span>     <span class="n">line_number</span> <span class="o">=</span> <span class="n">line_number_for_err_trap</span><span class="p">;</span>
<a name="c0-909"></a><span class="lineno"> 909</span>     <span class="n">run_error_trap</span> <span class="p">();</span>
<a name="c0-910"></a><span class="lineno"> 910</span>     <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-911"></a><span class="lineno"> 911</span>   <span class="p">}</span>
<a name="c0-912"></a><span class="lineno"> 912</span> 
<a name="c0-913"></a><span class="lineno"> 913</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exit_immediately_on_error</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-914"></a><span class="lineno"> 914</span>   <span class="p">{</span>
<a name="c0-915"></a><span class="lineno"> 915</span>     <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-916"></a><span class="lineno"> 916</span>     <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-917"></a><span class="lineno"> 917</span>     <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-918"></a><span class="lineno"> 918</span>   <span class="p">}</span>
<a name="c0-919"></a><span class="lineno"> 919</span> 
<a name="c0-920"></a><span class="lineno"> 920</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-921"></a><span class="lineno"> 921</span> <span class="cp">#endif</span>
<a name="c0-922"></a><span class="lineno"> 922</span> 
<a name="c0-923"></a><span class="lineno"> 923</span> <span class="cp">#if defined (COND_COMMAND)</span>
<a name="c0-924"></a><span class="lineno"> 924</span>     <span class="k">case</span> <span class="n">cm_cond</span>:
<a name="c0-925"></a><span class="lineno"> 925</span>       <span class="n">was_error_trap</span> <span class="o">=</span> <span class="n">signal_is_trapped</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signal_is_ignored</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-926"></a><span class="lineno"> 926</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-927"></a><span class="lineno"> 927</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Cond</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-928"></a><span class="lineno"> 928</span> 
<a name="c0-929"></a><span class="lineno"> 929</span>       <span class="n">line_number_for_err_trap</span> <span class="o">=</span> <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-930"></a><span class="lineno"> 930</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_cond_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Cond</span><span class="p">);</span>
<a name="c0-931"></a><span class="lineno"> 931</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-932"></a><span class="lineno"> 932</span> 
<a name="c0-933"></a><span class="lineno"> 933</span>       <span class="k">if</span> <span class="p">(</span><span class="n">was_error_trap</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-934"></a><span class="lineno"> 934</span>   <span class="p">{</span>
<a name="c0-935"></a><span class="lineno"> 935</span>     <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-936"></a><span class="lineno"> 936</span>     <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-937"></a><span class="lineno"> 937</span>     <span class="n">line_number</span> <span class="o">=</span> <span class="n">line_number_for_err_trap</span><span class="p">;</span>
<a name="c0-938"></a><span class="lineno"> 938</span>     <span class="n">run_error_trap</span> <span class="p">();</span>
<a name="c0-939"></a><span class="lineno"> 939</span>     <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-940"></a><span class="lineno"> 940</span>   <span class="p">}</span>
<a name="c0-941"></a><span class="lineno"> 941</span> 
<a name="c0-942"></a><span class="lineno"> 942</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exit_immediately_on_error</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-943"></a><span class="lineno"> 943</span>   <span class="p">{</span>
<a name="c0-944"></a><span class="lineno"> 944</span>     <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-945"></a><span class="lineno"> 945</span>     <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-946"></a><span class="lineno"> 946</span>     <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-947"></a><span class="lineno"> 947</span>   <span class="p">}</span>
<a name="c0-948"></a><span class="lineno"> 948</span> 
<a name="c0-949"></a><span class="lineno"> 949</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-950"></a><span class="lineno"> 950</span> <span class="cp">#endif</span>
<a name="c0-951"></a><span class="lineno"> 951</span>     
<a name="c0-952"></a><span class="lineno"> 952</span>     <span class="k">case</span> <span class="n">cm_function_def</span>:
<a name="c0-953"></a><span class="lineno"> 953</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_intern_function</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Function_def</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
<a name="c0-954"></a><span class="lineno"> 954</span>                <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Function_def</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
<a name="c0-955"></a><span class="lineno"> 955</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-956"></a><span class="lineno"> 956</span> 
<a name="c0-957"></a><span class="lineno"> 957</span>     <span class="nl">default:</span>
<a name="c0-958"></a><span class="lineno"> 958</span>       <span class="n">command_error</span> <span class="p">(</span><span class="s">"execute_command"</span><span class="p">,</span> <span class="n">CMDERR_BADTYPE</span><span class="p">,</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-959"></a><span class="lineno"> 959</span>     <span class="p">}</span>
<a name="c0-960"></a><span class="lineno"> 960</span> 
<a name="c0-961"></a><span class="lineno"> 961</span>   <span class="k">if</span> <span class="p">(</span><span class="n">my_undo_list</span><span class="p">)</span>
<a name="c0-962"></a><span class="lineno"> 962</span>     <span class="p">{</span>
<a name="c0-963"></a><span class="lineno"> 963</span>       <span class="n">do_redirections</span> <span class="p">(</span><span class="n">my_undo_list</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="p">);</span>
<a name="c0-964"></a><span class="lineno"> 964</span>       <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">my_undo_list</span><span class="p">);</span>
<a name="c0-965"></a><span class="lineno"> 965</span>     <span class="p">}</span>
<a name="c0-966"></a><span class="lineno"> 966</span> 
<a name="c0-967"></a><span class="lineno"> 967</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exec_undo_list</span><span class="p">)</span>
<a name="c0-968"></a><span class="lineno"> 968</span>     <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">exec_undo_list</span><span class="p">);</span>
<a name="c0-969"></a><span class="lineno"> 969</span> 
<a name="c0-970"></a><span class="lineno"> 970</span>   <span class="k">if</span> <span class="p">(</span><span class="n">my_undo_list</span> <span class="o">||</span> <span class="n">exec_undo_list</span><span class="p">)</span>
<a name="c0-971"></a><span class="lineno"> 971</span>     <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"loop_redirections"</span><span class="p">);</span>
<a name="c0-972"></a><span class="lineno"> 972</span> 
<a name="c0-973"></a><span class="lineno"> 973</span>   <span class="cm">/* Invert the return value if we have to */</span>
<a name="c0-974"></a><span class="lineno"> 974</span>   <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
<a name="c0-975"></a><span class="lineno"> 975</span>     <span class="n">exec_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">exec_result</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-976"></a><span class="lineno"> 976</span>         <span class="o">?</span> <span class="n">EXECUTION_FAILURE</span>
<a name="c0-977"></a><span class="lineno"> 977</span>         <span class="o">:</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-978"></a><span class="lineno"> 978</span> 
<a name="c0-979"></a><span class="lineno"> 979</span> <span class="cp">#if defined (DPAREN_ARITHMETIC) || defined (COND_COMMAND)</span>
<a name="c0-980"></a><span class="lineno"> 980</span>   <span class="cm">/* This is where we set PIPESTATUS from the exit status of the appropriate</span>
<a name="c0-981"></a><span class="lineno"> 981</span> <span class="cm">     compound commands (the ones that look enough like simple commands to</span>
<a name="c0-982"></a><span class="lineno"> 982</span> <span class="cm">     cause confusion).  We might be able to optimize by not doing this if</span>
<a name="c0-983"></a><span class="lineno"> 983</span> <span class="cm">     subshell_environment != 0. */</span>
<a name="c0-984"></a><span class="lineno"> 984</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
<a name="c0-985"></a><span class="lineno"> 985</span>     <span class="p">{</span>
<a name="c0-986"></a><span class="lineno"> 986</span> <span class="cp">#  if defined (DPAREN_ARITHMETIC)</span>
<a name="c0-987"></a><span class="lineno"> 987</span>     <span class="k">case</span> <span class="n">cm_arith</span>:
<a name="c0-988"></a><span class="lineno"> 988</span> <span class="cp">#  endif</span>
<a name="c0-989"></a><span class="lineno"> 989</span> <span class="cp">#  if defined (COND_COMMAND)</span>
<a name="c0-990"></a><span class="lineno"> 990</span>     <span class="k">case</span> <span class="n">cm_cond</span>:
<a name="c0-991"></a><span class="lineno"> 991</span> <span class="cp">#  endif</span>
<a name="c0-992"></a><span class="lineno"> 992</span>       <span class="n">set_pipestatus_from_exit</span> <span class="p">(</span><span class="n">exec_result</span><span class="p">);</span>
<a name="c0-993"></a><span class="lineno"> 993</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-994"></a><span class="lineno"> 994</span>     <span class="p">}</span>
<a name="c0-995"></a><span class="lineno"> 995</span> <span class="cp">#endif</span>
<a name="c0-996"></a><span class="lineno"> 996</span> 
<a name="c0-997"></a><span class="lineno"> 997</span>   <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-998"></a><span class="lineno"> 998</span>   <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-999"></a><span class="lineno"> 999</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-1000"></a><span class="lineno">1000</span> <span class="c">  if (running_trap == 0)</span>
<a name="c0-1001"></a><span class="lineno">1001</span> <span class="cp">#endif</span>
<a name="c0-1002"></a><span class="lineno">1002</span>     <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1003"></a><span class="lineno">1003</span>   <span class="k">return</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c0-1004"></a><span class="lineno">1004</span> <span class="p">}</span>
<a name="c0-1005"></a><span class="lineno">1005</span> 
<a name="c0-1006"></a><span class="lineno">1006</span> <span class="cp">#if defined (COMMAND_TIMING)</span>
<a name="c0-1007"></a><span class="lineno">1007</span> 
<a name="c0-1008"></a><span class="lineno">1008</span> <span class="cp">#if defined (HAVE_GETRUSAGE) &amp;&amp; defined (HAVE_GETTIMEOFDAY)</span>
<a name="c0-1009"></a><span class="lineno">1009</span> <span class="k">extern</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">difftimeval</span> <span class="n">__P</span><span class="p">((</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1010"></a><span class="lineno">1010</span> <span class="k">extern</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">addtimeval</span> <span class="n">__P</span><span class="p">((</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1011"></a><span class="lineno">1011</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">timeval_to_cpu</span> <span class="n">__P</span><span class="p">((</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1012"></a><span class="lineno">1012</span> <span class="cp">#endif</span>
<a name="c0-1013"></a><span class="lineno">1013</span> 
<a name="c0-1014"></a><span class="lineno">1014</span> <span class="cp">#define POSIX_TIMEFORMAT "real %2R\nuser %2U\nsys %2S"</span>
<a name="c0-1015"></a><span class="lineno">1015</span> <span class="cp">#define BASH_TIMEFORMAT  "\nreal\t%3lR\nuser\t%3lU\nsys\t%3lS"</span>
<a name="c0-1016"></a><span class="lineno">1016</span> 
<a name="c0-1017"></a><span class="lineno">1017</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">precs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
<a name="c0-1018"></a><span class="lineno">1018</span> 
<a name="c0-1019"></a><span class="lineno">1019</span> <span class="cm">/* Expand one `%'-prefixed escape sequence from a time format string. */</span>
<a name="c0-1020"></a><span class="lineno">1020</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-1021"></a><span class="lineno">1021</span> <span class="n">mkfmt</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">sec_fraction</span><span class="p">)</span>
<a name="c0-1022"></a><span class="lineno">1022</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-1023"></a><span class="lineno">1023</span>      <span class="kt">int</span> <span class="n">prec</span><span class="p">,</span> <span class="n">lng</span><span class="p">;</span>
<a name="c0-1024"></a><span class="lineno">1024</span>      <span class="kt">time_t</span> <span class="n">sec</span><span class="p">;</span>
<a name="c0-1025"></a><span class="lineno">1025</span>      <span class="kt">int</span> <span class="n">sec_fraction</span><span class="p">;</span>
<a name="c0-1026"></a><span class="lineno">1026</span> <span class="p">{</span>
<a name="c0-1027"></a><span class="lineno">1027</span>   <span class="kt">time_t</span> <span class="n">min</span><span class="p">;</span>
<a name="c0-1028"></a><span class="lineno">1028</span>   <span class="kt">char</span> <span class="n">abuf</span><span class="p">[</span><span class="n">INT_STRLEN_BOUND</span><span class="p">(</span><span class="kt">time_t</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<a name="c0-1029"></a><span class="lineno">1029</span>   <span class="kt">int</span> <span class="n">ind</span><span class="p">,</span> <span class="n">aind</span><span class="p">;</span>
<a name="c0-1030"></a><span class="lineno">1030</span> 
<a name="c0-1031"></a><span class="lineno">1031</span>   <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1032"></a><span class="lineno">1032</span>   <span class="n">abuf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">abuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-1033"></a><span class="lineno">1033</span> 
<a name="c0-1034"></a><span class="lineno">1034</span>   <span class="cm">/* If LNG is non-zero, we want to decompose SEC into minutes and seconds. */</span>
<a name="c0-1035"></a><span class="lineno">1035</span>   <span class="k">if</span> <span class="p">(</span><span class="n">lng</span><span class="p">)</span>
<a name="c0-1036"></a><span class="lineno">1036</span>     <span class="p">{</span>
<a name="c0-1037"></a><span class="lineno">1037</span>       <span class="n">min</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
<a name="c0-1038"></a><span class="lineno">1038</span>       <span class="n">sec</span> <span class="o">%=</span> <span class="mi">60</span><span class="p">;</span>
<a name="c0-1039"></a><span class="lineno">1039</span>       <span class="n">aind</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">abuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1040"></a><span class="lineno">1040</span>       <span class="k">do</span>
<a name="c0-1041"></a><span class="lineno">1041</span>  <span class="n">abuf</span><span class="p">[</span><span class="n">aind</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">;</span>
<a name="c0-1042"></a><span class="lineno">1042</span>       <span class="k">while</span> <span class="p">(</span><span class="n">min</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-1043"></a><span class="lineno">1043</span>       <span class="n">aind</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1044"></a><span class="lineno">1044</span>       <span class="k">while</span> <span class="p">(</span><span class="n">abuf</span><span class="p">[</span><span class="n">aind</span><span class="p">])</span>
<a name="c0-1045"></a><span class="lineno">1045</span>  <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">abuf</span><span class="p">[</span><span class="n">aind</span><span class="o">++</span><span class="p">];</span>
<a name="c0-1046"></a><span class="lineno">1046</span>       <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'m'</span><span class="p">;</span>
<a name="c0-1047"></a><span class="lineno">1047</span>     <span class="p">}</span>
<a name="c0-1048"></a><span class="lineno">1048</span> 
<a name="c0-1049"></a><span class="lineno">1049</span>   <span class="cm">/* Now add the seconds. */</span>
<a name="c0-1050"></a><span class="lineno">1050</span>   <span class="n">aind</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">abuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1051"></a><span class="lineno">1051</span>   <span class="k">do</span>
<a name="c0-1052"></a><span class="lineno">1052</span>     <span class="n">abuf</span><span class="p">[</span><span class="n">aind</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sec</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">;</span>
<a name="c0-1053"></a><span class="lineno">1053</span>   <span class="k">while</span> <span class="p">(</span><span class="n">sec</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-1054"></a><span class="lineno">1054</span>   <span class="n">aind</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1055"></a><span class="lineno">1055</span>   <span class="k">while</span> <span class="p">(</span><span class="n">abuf</span><span class="p">[</span><span class="n">aind</span><span class="p">])</span>
<a name="c0-1056"></a><span class="lineno">1056</span>     <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">abuf</span><span class="p">[</span><span class="n">aind</span><span class="o">++</span><span class="p">];</span>
<a name="c0-1057"></a><span class="lineno">1057</span> 
<a name="c0-1058"></a><span class="lineno">1058</span>   <span class="cm">/* We want to add a decimal point and PREC places after it if PREC is</span>
<a name="c0-1059"></a><span class="lineno">1059</span> <span class="cm">     nonzero.  PREC is not greater than 3.  SEC_FRACTION is between 0</span>
<a name="c0-1060"></a><span class="lineno">1060</span> <span class="cm">     and 999. */</span>
<a name="c0-1061"></a><span class="lineno">1061</span>   <span class="k">if</span> <span class="p">(</span><span class="n">prec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1062"></a><span class="lineno">1062</span>     <span class="p">{</span>
<a name="c0-1063"></a><span class="lineno">1063</span>       <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
<a name="c0-1064"></a><span class="lineno">1064</span>       <span class="k">for</span> <span class="p">(</span><span class="n">aind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">aind</span> <span class="o">&lt;=</span> <span class="n">prec</span><span class="p">;</span> <span class="n">aind</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1065"></a><span class="lineno">1065</span>  <span class="p">{</span>
<a name="c0-1066"></a><span class="lineno">1066</span>    <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sec_fraction</span> <span class="o">/</span> <span class="n">precs</span><span class="p">[</span><span class="n">aind</span><span class="p">])</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">;</span>
<a name="c0-1067"></a><span class="lineno">1067</span>    <span class="n">sec_fraction</span> <span class="o">%=</span> <span class="n">precs</span><span class="p">[</span><span class="n">aind</span><span class="p">];</span>
<a name="c0-1068"></a><span class="lineno">1068</span>  <span class="p">}</span>
<a name="c0-1069"></a><span class="lineno">1069</span>     <span class="p">}</span>
<a name="c0-1070"></a><span class="lineno">1070</span> 
<a name="c0-1071"></a><span class="lineno">1071</span>   <span class="k">if</span> <span class="p">(</span><span class="n">lng</span><span class="p">)</span>
<a name="c0-1072"></a><span class="lineno">1072</span>     <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'s'</span><span class="p">;</span>
<a name="c0-1073"></a><span class="lineno">1073</span>   <span class="n">buf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-1074"></a><span class="lineno">1074</span> 
<a name="c0-1075"></a><span class="lineno">1075</span>   <span class="k">return</span> <span class="p">(</span><span class="n">ind</span><span class="p">);</span>
<a name="c0-1076"></a><span class="lineno">1076</span> <span class="p">}</span>
<a name="c0-1077"></a><span class="lineno">1077</span> 
<a name="c0-1078"></a><span class="lineno">1078</span> <span class="cm">/* Interpret the format string FORMAT, interpolating the following escape</span>
<a name="c0-1079"></a><span class="lineno">1079</span> <span class="cm">   sequences:</span>
<a name="c0-1080"></a><span class="lineno">1080</span> <span class="cm">    %[prec][l][RUS]</span>
<a name="c0-1081"></a><span class="lineno">1081</span> 
<a name="c0-1082"></a><span class="lineno">1082</span> <span class="cm">   where the optional `prec' is a precision, meaning the number of</span>
<a name="c0-1083"></a><span class="lineno">1083</span> <span class="cm">   characters after the decimal point, the optional `l' means to format</span>
<a name="c0-1084"></a><span class="lineno">1084</span> <span class="cm">   using minutes and seconds (MMmNN[.FF]s), like the `times' builtin',</span>
<a name="c0-1085"></a><span class="lineno">1085</span> <span class="cm">   and the last character is one of</span>
<a name="c0-1086"></a><span class="lineno">1086</span> <span class="cm">   </span>
<a name="c0-1087"></a><span class="lineno">1087</span> <span class="cm">    R number of seconds of `real' time</span>
<a name="c0-1088"></a><span class="lineno">1088</span> <span class="cm">    U number of seconds of `user' time</span>
<a name="c0-1089"></a><span class="lineno">1089</span> <span class="cm">    S number of seconds of `system' time</span>
<a name="c0-1090"></a><span class="lineno">1090</span> 
<a name="c0-1091"></a><span class="lineno">1091</span> <span class="cm">   An occurrence of `%%' in the format string is translated to a `%'.  The</span>
<a name="c0-1092"></a><span class="lineno">1092</span> <span class="cm">   result is printed to FP, a pointer to a FILE.  The other variables are</span>
<a name="c0-1093"></a><span class="lineno">1093</span> <span class="cm">   the seconds and thousandths of a second of real, user, and system time,</span>
<a name="c0-1094"></a><span class="lineno">1094</span> <span class="cm">   resectively. */</span>
<a name="c0-1095"></a><span class="lineno">1095</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-1096"></a><span class="lineno">1096</span> <span class="n">print_formatted_time</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rsf</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">usf</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ssf</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span>
<a name="c0-1097"></a><span class="lineno">1097</span>      <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
<a name="c0-1098"></a><span class="lineno">1098</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
<a name="c0-1099"></a><span class="lineno">1099</span>      <span class="kt">time_t</span> <span class="n">rs</span><span class="p">;</span>
<a name="c0-1100"></a><span class="lineno">1100</span>      <span class="kt">int</span> <span class="n">rsf</span><span class="p">;</span>
<a name="c0-1101"></a><span class="lineno">1101</span>      <span class="kt">time_t</span> <span class="n">us</span><span class="p">;</span>
<a name="c0-1102"></a><span class="lineno">1102</span>      <span class="kt">int</span> <span class="n">usf</span><span class="p">;</span>
<a name="c0-1103"></a><span class="lineno">1103</span>      <span class="kt">time_t</span> <span class="n">ss</span><span class="p">;</span>
<a name="c0-1104"></a><span class="lineno">1104</span>      <span class="kt">int</span> <span class="n">ssf</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>
<a name="c0-1105"></a><span class="lineno">1105</span> <span class="p">{</span>
<a name="c0-1106"></a><span class="lineno">1106</span>   <span class="kt">int</span> <span class="n">prec</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1107"></a><span class="lineno">1107</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="n">INT_STRLEN_BOUND</span> <span class="p">(</span><span class="kt">time_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="s">"mSS.FFFF"</span><span class="p">)];</span>
<a name="c0-1108"></a><span class="lineno">1108</span>   <span class="kt">time_t</span> <span class="n">sum</span><span class="p">;</span>
<a name="c0-1109"></a><span class="lineno">1109</span>   <span class="kt">int</span> <span class="n">sum_frac</span><span class="p">;</span>
<a name="c0-1110"></a><span class="lineno">1110</span>   <span class="kt">int</span> <span class="n">sindex</span><span class="p">,</span> <span class="n">ssize</span><span class="p">;</span>
<a name="c0-1111"></a><span class="lineno">1111</span> 
<a name="c0-1112"></a><span class="lineno">1112</span>   <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">format</span><span class="p">);</span>
<a name="c0-1113"></a><span class="lineno">1113</span>   <span class="n">ssize</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">64</span><span class="p">);</span>
<a name="c0-1114"></a><span class="lineno">1114</span>   <span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span> <span class="p">(</span><span class="n">ssize</span><span class="p">);</span>
<a name="c0-1115"></a><span class="lineno">1115</span>   <span class="n">sindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1116"></a><span class="lineno">1116</span> 
<a name="c0-1117"></a><span class="lineno">1117</span>   <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1118"></a><span class="lineno">1118</span>     <span class="p">{</span>
<a name="c0-1119"></a><span class="lineno">1119</span>       <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="sc">'%'</span> <span class="o">||</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
<a name="c0-1120"></a><span class="lineno">1120</span>  <span class="p">{</span>
<a name="c0-1121"></a><span class="lineno">1121</span>    <span class="n">RESIZE_MALLOCED_BUFFER</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">sindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ssize</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<a name="c0-1122"></a><span class="lineno">1122</span>    <span class="n">str</span><span class="p">[</span><span class="n">sindex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="c0-1123"></a><span class="lineno">1123</span>  <span class="p">}</span>
<a name="c0-1124"></a><span class="lineno">1124</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span>
<a name="c0-1125"></a><span class="lineno">1125</span>  <span class="p">{</span>
<a name="c0-1126"></a><span class="lineno">1126</span>    <span class="n">s</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1127"></a><span class="lineno">1127</span>    <span class="n">RESIZE_MALLOCED_BUFFER</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">sindex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ssize</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<a name="c0-1128"></a><span class="lineno">1128</span>    <span class="n">str</span><span class="p">[</span><span class="n">sindex</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="c0-1129"></a><span class="lineno">1129</span>  <span class="p">}</span>
<a name="c0-1130"></a><span class="lineno">1130</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'P'</span><span class="p">)</span>
<a name="c0-1131"></a><span class="lineno">1131</span>  <span class="p">{</span>
<a name="c0-1132"></a><span class="lineno">1132</span>    <span class="n">s</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1133"></a><span class="lineno">1133</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-1134"></a><span class="lineno">1134</span> <span class="c">   /* clamp CPU usage at 100% */</span>
<a name="c0-1135"></a><span class="lineno">1135</span> <span class="c">   if (cpu &gt; 10000)</span>
<a name="c0-1136"></a><span class="lineno">1136</span> <span class="c">     cpu = 10000;</span>
<a name="c0-1137"></a><span class="lineno">1137</span> <span class="cp">#endif</span>
<a name="c0-1138"></a><span class="lineno">1138</span>    <span class="n">sum</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
<a name="c0-1139"></a><span class="lineno">1139</span>    <span class="n">sum_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
<a name="c0-1140"></a><span class="lineno">1140</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">mkfmt</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="n">sum_frac</span><span class="p">);</span>
<a name="c0-1141"></a><span class="lineno">1141</span>    <span class="n">RESIZE_MALLOCED_BUFFER</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">sindex</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ssize</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<a name="c0-1142"></a><span class="lineno">1142</span>    <span class="n">strcpy</span> <span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">sindex</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
<a name="c0-1143"></a><span class="lineno">1143</span>    <span class="n">sindex</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1144"></a><span class="lineno">1144</span>  <span class="p">}</span>
<a name="c0-1145"></a><span class="lineno">1145</span>       <span class="k">else</span>
<a name="c0-1146"></a><span class="lineno">1146</span>  <span class="p">{</span>
<a name="c0-1147"></a><span class="lineno">1147</span>    <span class="n">prec</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* default is three places past the decimal point. */</span>
<a name="c0-1148"></a><span class="lineno">1148</span>    <span class="n">lng</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* default is to not use minutes or append `s' */</span>
<a name="c0-1149"></a><span class="lineno">1149</span>    <span class="n">s</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1150"></a><span class="lineno">1150</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DIGIT</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">))</span>    <span class="cm">/* `precision' */</span>
<a name="c0-1151"></a><span class="lineno">1151</span>      <span class="p">{</span>
<a name="c0-1152"></a><span class="lineno">1152</span>        <span class="n">prec</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">;</span>
<a name="c0-1153"></a><span class="lineno">1153</span>        <span class="k">if</span> <span class="p">(</span><span class="n">prec</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="n">prec</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c0-1154"></a><span class="lineno">1154</span>      <span class="p">}</span>
<a name="c0-1155"></a><span class="lineno">1155</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'l'</span><span class="p">)</span>    <span class="cm">/* `length extender' */</span>
<a name="c0-1156"></a><span class="lineno">1156</span>      <span class="p">{</span>
<a name="c0-1157"></a><span class="lineno">1157</span>        <span class="n">lng</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1158"></a><span class="lineno">1158</span>        <span class="n">s</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1159"></a><span class="lineno">1159</span>      <span class="p">}</span>
<a name="c0-1160"></a><span class="lineno">1160</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'R'</span> <span class="o">||</span> <span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'E'</span><span class="p">)</span>
<a name="c0-1161"></a><span class="lineno">1161</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">mkfmt</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rsf</span><span class="p">);</span>
<a name="c0-1162"></a><span class="lineno">1162</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'U'</span><span class="p">)</span>
<a name="c0-1163"></a><span class="lineno">1163</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">mkfmt</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">usf</span><span class="p">);</span>
<a name="c0-1164"></a><span class="lineno">1164</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'S'</span><span class="p">)</span>
<a name="c0-1165"></a><span class="lineno">1165</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">mkfmt</span> <span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ssf</span><span class="p">);</span>
<a name="c0-1166"></a><span class="lineno">1166</span>    <span class="k">else</span>
<a name="c0-1167"></a><span class="lineno">1167</span>      <span class="p">{</span>
<a name="c0-1168"></a><span class="lineno">1168</span>        <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"TIMEFORMAT: `%c': invalid format character"</span><span class="p">),</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<a name="c0-1169"></a><span class="lineno">1169</span>        <span class="n">free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
<a name="c0-1170"></a><span class="lineno">1170</span>        <span class="k">return</span><span class="p">;</span>
<a name="c0-1171"></a><span class="lineno">1171</span>      <span class="p">}</span>
<a name="c0-1172"></a><span class="lineno">1172</span>    <span class="n">RESIZE_MALLOCED_BUFFER</span> <span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">sindex</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ssize</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<a name="c0-1173"></a><span class="lineno">1173</span>    <span class="n">strcpy</span> <span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">sindex</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
<a name="c0-1174"></a><span class="lineno">1174</span>    <span class="n">sindex</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1175"></a><span class="lineno">1175</span>  <span class="p">}</span>
<a name="c0-1176"></a><span class="lineno">1176</span>     <span class="p">}</span>
<a name="c0-1177"></a><span class="lineno">1177</span> 
<a name="c0-1178"></a><span class="lineno">1178</span>   <span class="n">str</span><span class="p">[</span><span class="n">sindex</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-1179"></a><span class="lineno">1179</span>   <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<a name="c0-1180"></a><span class="lineno">1180</span>   <span class="n">fflush</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<a name="c0-1181"></a><span class="lineno">1181</span> 
<a name="c0-1182"></a><span class="lineno">1182</span>   <span class="n">free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
<a name="c0-1183"></a><span class="lineno">1183</span> <span class="p">}</span>
<a name="c0-1184"></a><span class="lineno">1184</span> 
<a name="c0-1185"></a><span class="lineno">1185</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-1186"></a><span class="lineno">1186</span> <span class="n">time_command</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-1187"></a><span class="lineno">1187</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-1188"></a><span class="lineno">1188</span>      <span class="kt">int</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-1189"></a><span class="lineno">1189</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-1190"></a><span class="lineno">1190</span> <span class="p">{</span>
<a name="c0-1191"></a><span class="lineno">1191</span>   <span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">posix_time</span><span class="p">,</span> <span class="n">old_flags</span><span class="p">,</span> <span class="n">nullcmd</span><span class="p">;</span>
<a name="c0-1192"></a><span class="lineno">1192</span>   <span class="kt">time_t</span> <span class="n">rs</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">ss</span><span class="p">;</span>
<a name="c0-1193"></a><span class="lineno">1193</span>   <span class="kt">int</span> <span class="n">rsf</span><span class="p">,</span> <span class="n">usf</span><span class="p">,</span> <span class="n">ssf</span><span class="p">;</span>
<a name="c0-1194"></a><span class="lineno">1194</span>   <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
<a name="c0-1195"></a><span class="lineno">1195</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">time_format</span><span class="p">;</span>
<a name="c0-1196"></a><span class="lineno">1196</span> 
<a name="c0-1197"></a><span class="lineno">1197</span> <span class="cp">#if defined (HAVE_GETRUSAGE) &amp;&amp; defined (HAVE_GETTIMEOFDAY)</span>
<a name="c0-1198"></a><span class="lineno">1198</span>   <span class="k">struct</span> <span class="n">timeval</span> <span class="n">real</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">sys</span><span class="p">;</span>
<a name="c0-1199"></a><span class="lineno">1199</span>   <span class="k">struct</span> <span class="n">timeval</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">;</span>
<a name="c0-1200"></a><span class="lineno">1200</span> <span class="cp">#  if defined (HAVE_STRUCT_TIMEZONE)</span>
<a name="c0-1201"></a><span class="lineno">1201</span>   <span class="k">struct</span> <span class="n">timezone</span> <span class="n">dtz</span><span class="p">;</span>       <span class="cm">/* posix doesn't define this */</span>
<a name="c0-1202"></a><span class="lineno">1202</span> <span class="cp">#  endif</span>
<a name="c0-1203"></a><span class="lineno">1203</span>   <span class="k">struct</span> <span class="n">rusage</span> <span class="n">selfb</span><span class="p">,</span> <span class="n">selfa</span><span class="p">,</span> <span class="n">kidsb</span><span class="p">,</span> <span class="n">kidsa</span><span class="p">;</span>  <span class="cm">/* a = after, b = before */</span>
<a name="c0-1204"></a><span class="lineno">1204</span> <span class="cp">#else</span>
<a name="c0-1205"></a><span class="lineno">1205</span> <span class="cp">#  if defined (HAVE_TIMES)</span>
<a name="c0-1206"></a><span class="lineno">1206</span>   <span class="kt">clock_t</span> <span class="n">tbefore</span><span class="p">,</span> <span class="n">tafter</span><span class="p">,</span> <span class="n">real</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">sys</span><span class="p">;</span>
<a name="c0-1207"></a><span class="lineno">1207</span>   <span class="k">struct</span> <span class="n">tms</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">;</span>
<a name="c0-1208"></a><span class="lineno">1208</span> <span class="cp">#  endif</span>
<a name="c0-1209"></a><span class="lineno">1209</span> <span class="cp">#endif</span>
<a name="c0-1210"></a><span class="lineno">1210</span> 
<a name="c0-1211"></a><span class="lineno">1211</span> <span class="cp">#if defined (HAVE_GETRUSAGE) &amp;&amp; defined (HAVE_GETTIMEOFDAY)</span>
<a name="c0-1212"></a><span class="lineno">1212</span> <span class="cp">#  if defined (HAVE_STRUCT_TIMEZONE)</span>
<a name="c0-1213"></a><span class="lineno">1213</span>   <span class="n">gettimeofday</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">before</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtz</span><span class="p">);</span>
<a name="c0-1214"></a><span class="lineno">1214</span> <span class="cp">#  else</span>
<a name="c0-1215"></a><span class="lineno">1215</span>   <span class="n">gettimeofday</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">before</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1216"></a><span class="lineno">1216</span> <span class="cp">#  endif </span><span class="cm">/* !HAVE_STRUCT_TIMEZONE */</span><span class="cp"></span>
<a name="c0-1217"></a><span class="lineno">1217</span>   <span class="n">getrusage</span> <span class="p">(</span><span class="n">RUSAGE_SELF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selfb</span><span class="p">);</span>
<a name="c0-1218"></a><span class="lineno">1218</span>   <span class="n">getrusage</span> <span class="p">(</span><span class="n">RUSAGE_CHILDREN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kidsb</span><span class="p">);</span>
<a name="c0-1219"></a><span class="lineno">1219</span> <span class="cp">#else</span>
<a name="c0-1220"></a><span class="lineno">1220</span> <span class="cp">#  if defined (HAVE_TIMES)</span>
<a name="c0-1221"></a><span class="lineno">1221</span>   <span class="n">tbefore</span> <span class="o">=</span> <span class="n">times</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">before</span><span class="p">);</span>
<a name="c0-1222"></a><span class="lineno">1222</span> <span class="cp">#  endif</span>
<a name="c0-1223"></a><span class="lineno">1223</span> <span class="cp">#endif</span>
<a name="c0-1224"></a><span class="lineno">1224</span> 
<a name="c0-1225"></a><span class="lineno">1225</span>   <span class="n">posix_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_TIME_POSIX</span><span class="p">);</span>
<a name="c0-1226"></a><span class="lineno">1226</span> 
<a name="c0-1227"></a><span class="lineno">1227</span>   <span class="n">nullcmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_simple</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">redirects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1228"></a><span class="lineno">1228</span>   <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">nullcmd</span><span class="p">)</span>
<a name="c0-1229"></a><span class="lineno">1229</span>     <span class="p">{</span>
<a name="c0-1230"></a><span class="lineno">1230</span> <span class="cp">#if defined (HAVE_GETRUSAGE)</span>
<a name="c0-1231"></a><span class="lineno">1231</span>       <span class="n">selfb</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">kidsb</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">selfb</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">kidsb</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1232"></a><span class="lineno">1232</span>       <span class="n">selfb</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">kidsb</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">selfb</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">kidsb</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1233"></a><span class="lineno">1233</span>       <span class="n">before</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">shell_start_time</span><span class="p">;</span>
<a name="c0-1234"></a><span class="lineno">1234</span>       <span class="n">before</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1235"></a><span class="lineno">1235</span> <span class="cp">#else</span>
<a name="c0-1236"></a><span class="lineno">1236</span>       <span class="n">before</span><span class="p">.</span><span class="n">tms_utime</span> <span class="o">=</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_stime</span> <span class="o">=</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_cutime</span> <span class="o">=</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_cstime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1237"></a><span class="lineno">1237</span>       <span class="n">tbefore</span> <span class="o">=</span> <span class="n">shell_start_time</span><span class="p">;</span>
<a name="c0-1238"></a><span class="lineno">1238</span> <span class="cp">#endif</span>
<a name="c0-1239"></a><span class="lineno">1239</span>     <span class="p">}</span>
<a name="c0-1240"></a><span class="lineno">1240</span> 
<a name="c0-1241"></a><span class="lineno">1241</span>   <span class="n">old_flags</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
<a name="c0-1242"></a><span class="lineno">1242</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_TIME_PIPELINE</span><span class="o">|</span><span class="n">CMD_TIME_POSIX</span><span class="p">);</span>
<a name="c0-1243"></a><span class="lineno">1243</span>   <span class="n">rv</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-1244"></a><span class="lineno">1244</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">old_flags</span><span class="p">;</span>
<a name="c0-1245"></a><span class="lineno">1245</span> 
<a name="c0-1246"></a><span class="lineno">1246</span>   <span class="n">rs</span> <span class="o">=</span> <span class="n">us</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1247"></a><span class="lineno">1247</span>   <span class="n">rsf</span> <span class="o">=</span> <span class="n">usf</span> <span class="o">=</span> <span class="n">ssf</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1248"></a><span class="lineno">1248</span> 
<a name="c0-1249"></a><span class="lineno">1249</span> <span class="cp">#if defined (HAVE_GETRUSAGE) &amp;&amp; defined (HAVE_GETTIMEOFDAY)</span>
<a name="c0-1250"></a><span class="lineno">1250</span> <span class="cp">#  if defined (HAVE_STRUCT_TIMEZONE)</span>
<a name="c0-1251"></a><span class="lineno">1251</span>   <span class="n">gettimeofday</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">after</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtz</span><span class="p">);</span>
<a name="c0-1252"></a><span class="lineno">1252</span> <span class="cp">#  else</span>
<a name="c0-1253"></a><span class="lineno">1253</span>   <span class="n">gettimeofday</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">after</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1254"></a><span class="lineno">1254</span> <span class="cp">#  endif </span><span class="cm">/* !HAVE_STRUCT_TIMEZONE */</span><span class="cp"></span>
<a name="c0-1255"></a><span class="lineno">1255</span>   <span class="n">getrusage</span> <span class="p">(</span><span class="n">RUSAGE_SELF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selfa</span><span class="p">);</span>
<a name="c0-1256"></a><span class="lineno">1256</span>   <span class="n">getrusage</span> <span class="p">(</span><span class="n">RUSAGE_CHILDREN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kidsa</span><span class="p">);</span>
<a name="c0-1257"></a><span class="lineno">1257</span> 
<a name="c0-1258"></a><span class="lineno">1258</span>   <span class="n">difftimeval</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">real</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">before</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">after</span><span class="p">);</span>
<a name="c0-1259"></a><span class="lineno">1259</span>   <span class="n">timeval_to_secs</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">real</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsf</span><span class="p">);</span>
<a name="c0-1260"></a><span class="lineno">1260</span> 
<a name="c0-1261"></a><span class="lineno">1261</span>   <span class="n">addtimeval</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="n">difftimeval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">after</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selfb</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selfa</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">),</span>
<a name="c0-1262"></a><span class="lineno">1262</span>         <span class="n">difftimeval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">before</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kidsb</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kidsa</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">));</span>
<a name="c0-1263"></a><span class="lineno">1263</span>   <span class="n">timeval_to_secs</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usf</span><span class="p">);</span>
<a name="c0-1264"></a><span class="lineno">1264</span> 
<a name="c0-1265"></a><span class="lineno">1265</span>   <span class="n">addtimeval</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sys</span><span class="p">,</span> <span class="n">difftimeval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">after</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selfb</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">selfa</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">),</span>
<a name="c0-1266"></a><span class="lineno">1266</span>        <span class="n">difftimeval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">before</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kidsb</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kidsa</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">));</span>
<a name="c0-1267"></a><span class="lineno">1267</span>   <span class="n">timeval_to_secs</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssf</span><span class="p">);</span>
<a name="c0-1268"></a><span class="lineno">1268</span> 
<a name="c0-1269"></a><span class="lineno">1269</span>   <span class="n">cpu</span> <span class="o">=</span> <span class="n">timeval_to_cpu</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">real</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys</span><span class="p">);</span>
<a name="c0-1270"></a><span class="lineno">1270</span> <span class="cp">#else</span>
<a name="c0-1271"></a><span class="lineno">1271</span> <span class="cp">#  if defined (HAVE_TIMES)</span>
<a name="c0-1272"></a><span class="lineno">1272</span>   <span class="n">tafter</span> <span class="o">=</span> <span class="n">times</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">after</span><span class="p">);</span>
<a name="c0-1273"></a><span class="lineno">1273</span> 
<a name="c0-1274"></a><span class="lineno">1274</span>   <span class="n">real</span> <span class="o">=</span> <span class="n">tafter</span> <span class="o">-</span> <span class="n">tbefore</span><span class="p">;</span>
<a name="c0-1275"></a><span class="lineno">1275</span>   <span class="n">clock_t_to_secs</span> <span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsf</span><span class="p">);</span>
<a name="c0-1276"></a><span class="lineno">1276</span> 
<a name="c0-1277"></a><span class="lineno">1277</span>   <span class="n">user</span> <span class="o">=</span> <span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="n">tms_utime</span> <span class="o">-</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_utime</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="n">tms_cutime</span> <span class="o">-</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_cutime</span><span class="p">);</span>
<a name="c0-1278"></a><span class="lineno">1278</span>   <span class="n">clock_t_to_secs</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usf</span><span class="p">);</span>
<a name="c0-1279"></a><span class="lineno">1279</span> 
<a name="c0-1280"></a><span class="lineno">1280</span>   <span class="n">sys</span> <span class="o">=</span> <span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="n">tms_stime</span> <span class="o">-</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_stime</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="n">tms_cstime</span> <span class="o">-</span> <span class="n">before</span><span class="p">.</span><span class="n">tms_cstime</span><span class="p">);</span>
<a name="c0-1281"></a><span class="lineno">1281</span>   <span class="n">clock_t_to_secs</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssf</span><span class="p">);</span>
<a name="c0-1282"></a><span class="lineno">1282</span> 
<a name="c0-1283"></a><span class="lineno">1283</span>   <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="n">real</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">user</span> <span class="o">+</span> <span class="n">sys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">/</span> <span class="n">real</span><span class="p">;</span>
<a name="c0-1284"></a><span class="lineno">1284</span> 
<a name="c0-1285"></a><span class="lineno">1285</span> <span class="cp">#  else</span>
<a name="c0-1286"></a><span class="lineno">1286</span>   <span class="n">rs</span> <span class="o">=</span> <span class="n">us</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1287"></a><span class="lineno">1287</span>   <span class="n">rsf</span> <span class="o">=</span> <span class="n">usf</span> <span class="o">=</span> <span class="n">ssf</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1288"></a><span class="lineno">1288</span> <span class="cp">#  endif</span>
<a name="c0-1289"></a><span class="lineno">1289</span> <span class="cp">#endif</span>
<a name="c0-1290"></a><span class="lineno">1290</span> 
<a name="c0-1291"></a><span class="lineno">1291</span>   <span class="k">if</span> <span class="p">(</span><span class="n">posix_time</span><span class="p">)</span>
<a name="c0-1292"></a><span class="lineno">1292</span>     <span class="n">time_format</span> <span class="o">=</span> <span class="n">POSIX_TIMEFORMAT</span><span class="p">;</span>
<a name="c0-1293"></a><span class="lineno">1293</span>   <span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">time_format</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"TIMEFORMAT"</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1294"></a><span class="lineno">1294</span>     <span class="p">{</span>
<a name="c0-1295"></a><span class="lineno">1295</span>       <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">nullcmd</span><span class="p">)</span>
<a name="c0-1296"></a><span class="lineno">1296</span>  <span class="n">time_format</span> <span class="o">=</span> <span class="s">"user</span><span class="se">\t</span><span class="s">%2lU</span><span class="se">\n</span><span class="s">sys</span><span class="se">\t</span><span class="s">%2lS"</span><span class="p">;</span>
<a name="c0-1297"></a><span class="lineno">1297</span>       <span class="k">else</span>
<a name="c0-1298"></a><span class="lineno">1298</span>  <span class="n">time_format</span> <span class="o">=</span> <span class="n">BASH_TIMEFORMAT</span><span class="p">;</span>
<a name="c0-1299"></a><span class="lineno">1299</span>     <span class="p">}</span>
<a name="c0-1300"></a><span class="lineno">1300</span>   <span class="k">if</span> <span class="p">(</span><span class="n">time_format</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">time_format</span><span class="p">)</span>
<a name="c0-1301"></a><span class="lineno">1301</span>     <span class="n">print_formatted_time</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">time_format</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rsf</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">usf</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ssf</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<a name="c0-1302"></a><span class="lineno">1302</span> 
<a name="c0-1303"></a><span class="lineno">1303</span>   <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<a name="c0-1304"></a><span class="lineno">1304</span> <span class="p">}</span>
<a name="c0-1305"></a><span class="lineno">1305</span> <span class="cp">#endif </span><span class="cm">/* COMMAND_TIMING */</span><span class="cp"></span>
<a name="c0-1306"></a><span class="lineno">1306</span> 
<a name="c0-1307"></a><span class="lineno">1307</span> <span class="cm">/* Execute a command that's supposed to be in a subshell.  This must be</span>
<a name="c0-1308"></a><span class="lineno">1308</span> <span class="cm">   called after make_child and we must be running in the child process.</span>
<a name="c0-1309"></a><span class="lineno">1309</span> <span class="cm">   The caller will return or exit() immediately with the value this returns. */</span>
<a name="c0-1310"></a><span class="lineno">1310</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-1311"></a><span class="lineno">1311</span> <span class="n">execute_in_subshell</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-1312"></a><span class="lineno">1312</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-1313"></a><span class="lineno">1313</span>      <span class="kt">int</span> <span class="n">asynchronous</span><span class="p">;</span>
<a name="c0-1314"></a><span class="lineno">1314</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-1315"></a><span class="lineno">1315</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-1316"></a><span class="lineno">1316</span> <span class="p">{</span>
<a name="c0-1317"></a><span class="lineno">1317</span>   <span class="kt">int</span> <span class="n">user_subshell</span><span class="p">,</span> <span class="n">return_code</span><span class="p">,</span> <span class="n">function_value</span><span class="p">,</span> <span class="n">should_redir_stdin</span><span class="p">,</span> <span class="n">invert</span><span class="p">;</span>
<a name="c0-1318"></a><span class="lineno">1318</span>   <span class="kt">int</span> <span class="n">ois</span><span class="p">,</span> <span class="n">user_coproc</span><span class="p">;</span>
<a name="c0-1319"></a><span class="lineno">1319</span>   <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-1320"></a><span class="lineno">1320</span>   <span class="k">volatile</span> <span class="n">COMMAND</span> <span class="o">*</span><span class="n">tcom</span><span class="p">;</span>
<a name="c0-1321"></a><span class="lineno">1321</span> 
<a name="c0-1322"></a><span class="lineno">1322</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">user_subshell</span><span class="p">);</span>
<a name="c0-1323"></a><span class="lineno">1323</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">user_coproc</span><span class="p">);</span>
<a name="c0-1324"></a><span class="lineno">1324</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">invert</span><span class="p">);</span>
<a name="c0-1325"></a><span class="lineno">1325</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">tcom</span><span class="p">);</span>
<a name="c0-1326"></a><span class="lineno">1326</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">asynchronous</span><span class="p">);</span>
<a name="c0-1327"></a><span class="lineno">1327</span> 
<a name="c0-1328"></a><span class="lineno">1328</span>   <span class="n">subshell_level</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1329"></a><span class="lineno">1329</span>   <span class="n">should_redir_stdin</span> <span class="o">=</span> <span class="p">(</span><span class="n">asynchronous</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-1330"></a><span class="lineno">1330</span>        <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-1331"></a><span class="lineno">1331</span>        <span class="n">stdin_redirects</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1332"></a><span class="lineno">1332</span> 
<a name="c0-1333"></a><span class="lineno">1333</span>   <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1334"></a><span class="lineno">1334</span>   <span class="n">user_subshell</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_subshell</span> <span class="o">||</span> <span class="p">((</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_WANT_SUBSHELL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1335"></a><span class="lineno">1335</span>   <span class="n">user_coproc</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_coproc</span><span class="p">;</span>
<a name="c0-1336"></a><span class="lineno">1336</span> 
<a name="c0-1337"></a><span class="lineno">1337</span>   <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_FORCE_SUBSHELL</span> <span class="o">|</span> <span class="n">CMD_WANT_SUBSHELL</span> <span class="o">|</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">);</span>
<a name="c0-1338"></a><span class="lineno">1338</span> 
<a name="c0-1339"></a><span class="lineno">1339</span>   <span class="cm">/* If a command is asynchronous in a subshell (like ( foo ) &amp; or</span>
<a name="c0-1340"></a><span class="lineno">1340</span> <span class="cm">     the special case of an asynchronous GROUP command where the</span>
<a name="c0-1341"></a><span class="lineno">1341</span> <span class="cm">     the subshell bit is turned on down in case cm_group: below),</span>
<a name="c0-1342"></a><span class="lineno">1342</span> <span class="cm">     turn off `asynchronous', so that two subshells aren't spawned.</span>
<a name="c0-1343"></a><span class="lineno">1343</span> <span class="cm">     XXX - asynchronous used to be set to 0 in this block, but that</span>
<a name="c0-1344"></a><span class="lineno">1344</span> <span class="cm">     means that setup_async_signals was never run.  Now it's set to</span>
<a name="c0-1345"></a><span class="lineno">1345</span> <span class="cm">     0 after subshell_environment is set appropriately and setup_async_signals</span>
<a name="c0-1346"></a><span class="lineno">1346</span> <span class="cm">     is run.</span>
<a name="c0-1347"></a><span class="lineno">1347</span> 
<a name="c0-1348"></a><span class="lineno">1348</span> <span class="cm">     This seems semantically correct to me.  For example,</span>
<a name="c0-1349"></a><span class="lineno">1349</span> <span class="cm">     ( foo ) &amp; seems to say ``do the command `foo' in a subshell</span>
<a name="c0-1350"></a><span class="lineno">1350</span> <span class="cm">     environment, but don't wait for that subshell to finish'',</span>
<a name="c0-1351"></a><span class="lineno">1351</span> <span class="cm">     and "{ foo ; bar ; } &amp;" seems to me to be like functions or</span>
<a name="c0-1352"></a><span class="lineno">1352</span> <span class="cm">     builtins in the background, which executed in a subshell</span>
<a name="c0-1353"></a><span class="lineno">1353</span> <span class="cm">     environment.  I just don't see the need to fork two subshells. */</span>
<a name="c0-1354"></a><span class="lineno">1354</span> 
<a name="c0-1355"></a><span class="lineno">1355</span>   <span class="cm">/* Don't fork again, we are already in a subshell.  A `doubly</span>
<a name="c0-1356"></a><span class="lineno">1356</span> <span class="cm">     async' shell is not interactive, however. */</span>
<a name="c0-1357"></a><span class="lineno">1357</span>   <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-1358"></a><span class="lineno">1358</span>     <span class="p">{</span>
<a name="c0-1359"></a><span class="lineno">1359</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-1360"></a><span class="lineno">1360</span>       <span class="cm">/* If a construct like ( exec xxx yyy ) &amp; is given while job</span>
<a name="c0-1361"></a><span class="lineno">1361</span> <span class="cm">   control is active, we want to prevent exec from putting the</span>
<a name="c0-1362"></a><span class="lineno">1362</span> <span class="cm">   subshell back into the original process group, carefully</span>
<a name="c0-1363"></a><span class="lineno">1363</span> <span class="cm">   undoing all the work we just did in make_child. */</span>
<a name="c0-1364"></a><span class="lineno">1364</span>       <span class="n">original_pgrp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1365"></a><span class="lineno">1365</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-1366"></a><span class="lineno">1366</span>       <span class="n">ois</span> <span class="o">=</span> <span class="n">interactive_shell</span><span class="p">;</span>
<a name="c0-1367"></a><span class="lineno">1367</span>       <span class="n">interactive_shell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1368"></a><span class="lineno">1368</span>       <span class="cm">/* This test is to prevent alias expansion by interactive shells that</span>
<a name="c0-1369"></a><span class="lineno">1369</span> <span class="cm">   run `(command) &amp;' but to allow scripts that have enabled alias</span>
<a name="c0-1370"></a><span class="lineno">1370</span> <span class="cm">   expansion with `shopt -s expand_alias' to continue to expand</span>
<a name="c0-1371"></a><span class="lineno">1371</span> <span class="cm">   aliases. */</span>
<a name="c0-1372"></a><span class="lineno">1372</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ois</span> <span class="o">!=</span> <span class="n">interactive_shell</span><span class="p">)</span>
<a name="c0-1373"></a><span class="lineno">1373</span>  <span class="n">expand_aliases</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1374"></a><span class="lineno">1374</span>     <span class="p">}</span>
<a name="c0-1375"></a><span class="lineno">1375</span> 
<a name="c0-1376"></a><span class="lineno">1376</span>   <span class="cm">/* Subshells are neither login nor interactive. */</span>
<a name="c0-1377"></a><span class="lineno">1377</span>   <span class="n">login_shell</span> <span class="o">=</span> <span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1378"></a><span class="lineno">1378</span> 
<a name="c0-1379"></a><span class="lineno">1379</span>   <span class="k">if</span> <span class="p">(</span><span class="n">user_subshell</span><span class="p">)</span>
<a name="c0-1380"></a><span class="lineno">1380</span>     <span class="n">subshell_environment</span> <span class="o">=</span> <span class="n">SUBSHELL_PAREN</span><span class="p">;</span>
<a name="c0-1381"></a><span class="lineno">1381</span>   <span class="k">else</span>
<a name="c0-1382"></a><span class="lineno">1382</span>     <span class="p">{</span>
<a name="c0-1383"></a><span class="lineno">1383</span>       <span class="n">subshell_environment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="cm">/* XXX */</span>
<a name="c0-1384"></a><span class="lineno">1384</span>       <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-1385"></a><span class="lineno">1385</span>  <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_ASYNC</span><span class="p">;</span>
<a name="c0-1386"></a><span class="lineno">1386</span>       <span class="k">if</span> <span class="p">(</span><span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-1387"></a><span class="lineno">1387</span>  <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_PIPE</span><span class="p">;</span>
<a name="c0-1388"></a><span class="lineno">1388</span>       <span class="k">if</span> <span class="p">(</span><span class="n">user_coproc</span><span class="p">)</span>
<a name="c0-1389"></a><span class="lineno">1389</span>  <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_COPROC</span><span class="p">;</span>
<a name="c0-1390"></a><span class="lineno">1390</span>     <span class="p">}</span>
<a name="c0-1391"></a><span class="lineno">1391</span> 
<a name="c0-1392"></a><span class="lineno">1392</span>   <span class="n">reset_terminating_signals</span> <span class="p">();</span>    <span class="cm">/* in sig.c */</span>
<a name="c0-1393"></a><span class="lineno">1393</span>   <span class="cm">/* Cancel traps, in trap.c. */</span>
<a name="c0-1394"></a><span class="lineno">1394</span>   <span class="cm">/* Reset the signal handlers in the child, but don't free the</span>
<a name="c0-1395"></a><span class="lineno">1395</span> <span class="cm">     trap strings.  Set a flag noting that we have to free the</span>
<a name="c0-1396"></a><span class="lineno">1396</span> <span class="cm">     trap strings if we run trap to change a signal disposition. */</span>
<a name="c0-1397"></a><span class="lineno">1397</span>   <span class="n">reset_signal_handlers</span> <span class="p">();</span>
<a name="c0-1398"></a><span class="lineno">1398</span>   <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_RESETTRAP</span><span class="p">;</span>
<a name="c0-1399"></a><span class="lineno">1399</span> 
<a name="c0-1400"></a><span class="lineno">1400</span>   <span class="cm">/* Make sure restore_original_signals doesn't undo the work done by</span>
<a name="c0-1401"></a><span class="lineno">1401</span> <span class="cm">     make_child to ensure that asynchronous children are immune to SIGINT</span>
<a name="c0-1402"></a><span class="lineno">1402</span> <span class="cm">     and SIGQUIT.  Turn off asynchronous to make sure more subshells are</span>
<a name="c0-1403"></a><span class="lineno">1403</span> <span class="cm">     not spawned. */</span>
<a name="c0-1404"></a><span class="lineno">1404</span>   <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-1405"></a><span class="lineno">1405</span>     <span class="p">{</span>
<a name="c0-1406"></a><span class="lineno">1406</span>       <span class="n">setup_async_signals</span> <span class="p">();</span>
<a name="c0-1407"></a><span class="lineno">1407</span>       <span class="n">asynchronous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1408"></a><span class="lineno">1408</span>     <span class="p">}</span>
<a name="c0-1409"></a><span class="lineno">1409</span> 
<a name="c0-1410"></a><span class="lineno">1410</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-1411"></a><span class="lineno">1411</span>   <span class="n">set_sigchld_handler</span> <span class="p">();</span>
<a name="c0-1412"></a><span class="lineno">1412</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-1413"></a><span class="lineno">1413</span> 
<a name="c0-1414"></a><span class="lineno">1414</span>   <span class="n">set_sigint_handler</span> <span class="p">();</span>
<a name="c0-1415"></a><span class="lineno">1415</span> 
<a name="c0-1416"></a><span class="lineno">1416</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-1417"></a><span class="lineno">1417</span>   <span class="cm">/* Delete all traces that there were any jobs running.  This is</span>
<a name="c0-1418"></a><span class="lineno">1418</span> <span class="cm">     only for subshells. */</span>
<a name="c0-1419"></a><span class="lineno">1419</span>   <span class="n">without_job_control</span> <span class="p">();</span>
<a name="c0-1420"></a><span class="lineno">1420</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-1421"></a><span class="lineno">1421</span> 
<a name="c0-1422"></a><span class="lineno">1422</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-1423"></a><span class="lineno">1423</span>     <span class="n">close_fd_bitmap</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-1424"></a><span class="lineno">1424</span> 
<a name="c0-1425"></a><span class="lineno">1425</span>   <span class="n">do_piping</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-1426"></a><span class="lineno">1426</span> 
<a name="c0-1427"></a><span class="lineno">1427</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c0-1428"></a><span class="lineno">1428</span>   <span class="n">coproc_closeall</span> <span class="p">();</span>
<a name="c0-1429"></a><span class="lineno">1429</span> <span class="cp">#endif</span>
<a name="c0-1430"></a><span class="lineno">1430</span> 
<a name="c0-1431"></a><span class="lineno">1431</span>   <span class="cm">/* If this is a user subshell, set a flag if stdin was redirected.</span>
<a name="c0-1432"></a><span class="lineno">1432</span> <span class="cm">     This is used later to decide whether to redirect fd 0 to</span>
<a name="c0-1433"></a><span class="lineno">1433</span> <span class="cm">     /dev/null for async commands in the subshell.  This adds more</span>
<a name="c0-1434"></a><span class="lineno">1434</span> <span class="cm">     sh compatibility, but I'm not sure it's the right thing to do. */</span>
<a name="c0-1435"></a><span class="lineno">1435</span>   <span class="k">if</span> <span class="p">(</span><span class="n">user_subshell</span><span class="p">)</span>
<a name="c0-1436"></a><span class="lineno">1436</span>     <span class="p">{</span>
<a name="c0-1437"></a><span class="lineno">1437</span>       <span class="n">stdin_redir</span> <span class="o">=</span> <span class="n">stdin_redirects</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">);</span>
<a name="c0-1438"></a><span class="lineno">1438</span>       <span class="n">restore_default_signal</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-1439"></a><span class="lineno">1439</span>     <span class="p">}</span>
<a name="c0-1440"></a><span class="lineno">1440</span> 
<a name="c0-1441"></a><span class="lineno">1441</span>   <span class="cm">/* If this is an asynchronous command (command &amp;), we want to</span>
<a name="c0-1442"></a><span class="lineno">1442</span> <span class="cm">     redirect the standard input from /dev/null in the absence of</span>
<a name="c0-1443"></a><span class="lineno">1443</span> <span class="cm">     any specific redirection involving stdin. */</span>
<a name="c0-1444"></a><span class="lineno">1444</span>   <span class="k">if</span> <span class="p">(</span><span class="n">should_redir_stdin</span> <span class="o">&amp;&amp;</span> <span class="n">stdin_redir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1445"></a><span class="lineno">1445</span>     <span class="n">async_redirect_stdin</span> <span class="p">();</span>
<a name="c0-1446"></a><span class="lineno">1446</span> 
<a name="c0-1447"></a><span class="lineno">1447</span>   <span class="cm">/* Do redirections, then dispose of them before recursive call. */</span>
<a name="c0-1448"></a><span class="lineno">1448</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">)</span>
<a name="c0-1449"></a><span class="lineno">1449</span>     <span class="p">{</span>
<a name="c0-1450"></a><span class="lineno">1450</span>       <span class="k">if</span> <span class="p">(</span><span class="n">do_redirections</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1451"></a><span class="lineno">1451</span>  <span class="n">exit</span> <span class="p">(</span><span class="n">invert</span> <span class="o">?</span> <span class="n">EXECUTION_SUCCESS</span> <span class="o">:</span> <span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-1452"></a><span class="lineno">1452</span> 
<a name="c0-1453"></a><span class="lineno">1453</span>       <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">);</span>
<a name="c0-1454"></a><span class="lineno">1454</span>       <span class="n">command</span><span class="o">-&gt;</span><span class="n">redirects</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1455"></a><span class="lineno">1455</span>     <span class="p">}</span>
<a name="c0-1456"></a><span class="lineno">1456</span> 
<a name="c0-1457"></a><span class="lineno">1457</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_subshell</span><span class="p">)</span>
<a name="c0-1458"></a><span class="lineno">1458</span>     <span class="n">tcom</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Subshell</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
<a name="c0-1459"></a><span class="lineno">1459</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">user_coproc</span><span class="p">)</span>
<a name="c0-1460"></a><span class="lineno">1460</span>     <span class="n">tcom</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Coproc</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
<a name="c0-1461"></a><span class="lineno">1461</span>   <span class="k">else</span>
<a name="c0-1462"></a><span class="lineno">1462</span>     <span class="n">tcom</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<a name="c0-1463"></a><span class="lineno">1463</span> 
<a name="c0-1464"></a><span class="lineno">1464</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_TIME_PIPELINE</span><span class="p">)</span>
<a name="c0-1465"></a><span class="lineno">1465</span>     <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_TIME_PIPELINE</span><span class="p">;</span>
<a name="c0-1466"></a><span class="lineno">1466</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_TIME_POSIX</span><span class="p">)</span>
<a name="c0-1467"></a><span class="lineno">1467</span>     <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_TIME_POSIX</span><span class="p">;</span>
<a name="c0-1468"></a><span class="lineno">1468</span>   
<a name="c0-1469"></a><span class="lineno">1469</span>   <span class="cm">/* Make sure the subshell inherits any CMD_IGNORE_RETURN flag. */</span>
<a name="c0-1470"></a><span class="lineno">1470</span>   <span class="k">if</span> <span class="p">((</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tcom</span> <span class="o">!=</span> <span class="n">command</span><span class="p">)</span>
<a name="c0-1471"></a><span class="lineno">1471</span>     <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-1472"></a><span class="lineno">1472</span> 
<a name="c0-1473"></a><span class="lineno">1473</span>   <span class="cm">/* If this is a simple command, tell execute_disk_command that it</span>
<a name="c0-1474"></a><span class="lineno">1474</span> <span class="cm">     might be able to get away without forking and simply exec.</span>
<a name="c0-1475"></a><span class="lineno">1475</span> <span class="cm">     This means things like ( sleep 10 ) will only cause one fork.</span>
<a name="c0-1476"></a><span class="lineno">1476</span> <span class="cm">     If we're timing the command or inverting its return value, however,</span>
<a name="c0-1477"></a><span class="lineno">1477</span> <span class="cm">     we cannot do this optimization. */</span>
<a name="c0-1478"></a><span class="lineno">1478</span>   <span class="k">if</span> <span class="p">((</span><span class="n">user_subshell</span> <span class="o">||</span> <span class="n">user_coproc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tcom</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_simple</span> <span class="o">||</span> <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_subshell</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-1479"></a><span class="lineno">1479</span>       <span class="p">((</span><span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_TIME_PIPELINE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-1480"></a><span class="lineno">1480</span>       <span class="p">((</span><span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a name="c0-1481"></a><span class="lineno">1481</span>     <span class="p">{</span>
<a name="c0-1482"></a><span class="lineno">1482</span>       <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_NO_FORK</span><span class="p">;</span>
<a name="c0-1483"></a><span class="lineno">1483</span>       <span class="k">if</span> <span class="p">(</span><span class="n">tcom</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_simple</span><span class="p">)</span>
<a name="c0-1484"></a><span class="lineno">1484</span>  <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_NO_FORK</span><span class="p">;</span>
<a name="c0-1485"></a><span class="lineno">1485</span>     <span class="p">}</span>
<a name="c0-1486"></a><span class="lineno">1486</span> 
<a name="c0-1487"></a><span class="lineno">1487</span>   <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1488"></a><span class="lineno">1488</span>   <span class="n">tcom</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_INVERT_RETURN</span><span class="p">;</span>
<a name="c0-1489"></a><span class="lineno">1489</span> 
<a name="c0-1490"></a><span class="lineno">1490</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">);</span>
<a name="c0-1491"></a><span class="lineno">1491</span> 
<a name="c0-1492"></a><span class="lineno">1492</span>   <span class="cm">/* If we're inside a function while executing this subshell, we</span>
<a name="c0-1493"></a><span class="lineno">1493</span> <span class="cm">     need to handle a possible `return'. */</span>
<a name="c0-1494"></a><span class="lineno">1494</span>   <span class="n">function_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1495"></a><span class="lineno">1495</span>   <span class="k">if</span> <span class="p">(</span><span class="n">return_catch_flag</span><span class="p">)</span>
<a name="c0-1496"></a><span class="lineno">1496</span>     <span class="n">function_value</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">return_catch</span><span class="p">);</span>
<a name="c0-1497"></a><span class="lineno">1497</span> 
<a name="c0-1498"></a><span class="lineno">1498</span>   <span class="cm">/* If we're going to exit the shell, we don't want to invert the return</span>
<a name="c0-1499"></a><span class="lineno">1499</span> <span class="cm">     status. */</span>
<a name="c0-1500"></a><span class="lineno">1500</span>   <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">EXITPROG</span><span class="p">)</span>
<a name="c0-1501"></a><span class="lineno">1501</span>     <span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">last_command_exit_value</span><span class="p">;</span>
<a name="c0-1502"></a><span class="lineno">1502</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a name="c0-1503"></a><span class="lineno">1503</span>     <span class="n">return_code</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-1504"></a><span class="lineno">1504</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">function_value</span><span class="p">)</span>
<a name="c0-1505"></a><span class="lineno">1505</span>     <span class="n">return_code</span> <span class="o">=</span> <span class="n">return_catch_value</span><span class="p">;</span>
<a name="c0-1506"></a><span class="lineno">1506</span>   <span class="k">else</span>
<a name="c0-1507"></a><span class="lineno">1507</span>     <span class="n">return_code</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">tcom</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-1508"></a><span class="lineno">1508</span> 
<a name="c0-1509"></a><span class="lineno">1509</span>   <span class="cm">/* If we are asked to, invert the return value. */</span>
<a name="c0-1510"></a><span class="lineno">1510</span>   <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
<a name="c0-1511"></a><span class="lineno">1511</span>     <span class="n">return_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">return_code</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="n">EXECUTION_FAILURE</span>
<a name="c0-1512"></a><span class="lineno">1512</span>                 <span class="o">:</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-1513"></a><span class="lineno">1513</span> 
<a name="c0-1514"></a><span class="lineno">1514</span>   <span class="cm">/* If we were explicitly placed in a subshell with (), we need</span>
<a name="c0-1515"></a><span class="lineno">1515</span> <span class="cm">     to do the `shell cleanup' things, such as running traps[0]. */</span>
<a name="c0-1516"></a><span class="lineno">1516</span>   <span class="k">if</span> <span class="p">(</span><span class="n">user_subshell</span> <span class="o">&amp;&amp;</span> <span class="n">signal_is_trapped</span> <span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a name="c0-1517"></a><span class="lineno">1517</span>     <span class="p">{</span>
<a name="c0-1518"></a><span class="lineno">1518</span>       <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">return_code</span><span class="p">;</span>
<a name="c0-1519"></a><span class="lineno">1519</span>       <span class="n">return_code</span> <span class="o">=</span> <span class="n">run_exit_trap</span> <span class="p">();</span>
<a name="c0-1520"></a><span class="lineno">1520</span>     <span class="p">}</span>
<a name="c0-1521"></a><span class="lineno">1521</span> 
<a name="c0-1522"></a><span class="lineno">1522</span>   <span class="n">subshell_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1523"></a><span class="lineno">1523</span>   <span class="k">return</span> <span class="p">(</span><span class="n">return_code</span><span class="p">);</span>
<a name="c0-1524"></a><span class="lineno">1524</span>   <span class="cm">/* NOTREACHED */</span>
<a name="c0-1525"></a><span class="lineno">1525</span> <span class="p">}</span>
<a name="c0-1526"></a><span class="lineno">1526</span> 
<a name="c0-1527"></a><span class="lineno">1527</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c0-1528"></a><span class="lineno">1528</span> <span class="cp">#define COPROC_MAX  16</span>
<a name="c0-1529"></a><span class="lineno">1529</span> 
<a name="c0-1530"></a><span class="lineno">1530</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="n">cpelement</span>
<a name="c0-1531"></a><span class="lineno">1531</span>   <span class="p">{</span>
<a name="c0-1532"></a><span class="lineno">1532</span>     <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-1533"></a><span class="lineno">1533</span>     <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">coproc</span><span class="p">;</span>
<a name="c0-1534"></a><span class="lineno">1534</span>   <span class="p">}</span>
<a name="c0-1535"></a><span class="lineno">1535</span> <span class="n">cpelement_t</span><span class="p">;</span>
<a name="c0-1536"></a><span class="lineno">1536</span>     
<a name="c0-1537"></a><span class="lineno">1537</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="n">cplist</span>
<a name="c0-1538"></a><span class="lineno">1538</span>   <span class="p">{</span>
<a name="c0-1539"></a><span class="lineno">1539</span>     <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
<a name="c0-1540"></a><span class="lineno">1540</span>     <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
<a name="c0-1541"></a><span class="lineno">1541</span>     <span class="kt">int</span> <span class="n">ncoproc</span><span class="p">;</span>
<a name="c0-1542"></a><span class="lineno">1542</span>   <span class="p">}</span>
<a name="c0-1543"></a><span class="lineno">1543</span> <span class="n">cplist_t</span><span class="p">;</span>
<a name="c0-1544"></a><span class="lineno">1544</span> 
<a name="c0-1545"></a><span class="lineno">1545</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpe_alloc</span> <span class="n">__P</span><span class="p">((</span><span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1546"></a><span class="lineno">1546</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">cpe_dispose</span> <span class="n">__P</span><span class="p">((</span><span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1547"></a><span class="lineno">1547</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpl_add</span> <span class="n">__P</span><span class="p">((</span><span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1548"></a><span class="lineno">1548</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpl_delete</span> <span class="n">__P</span><span class="p">((</span><span class="n">pid_t</span><span class="p">));</span>
<a name="c0-1549"></a><span class="lineno">1549</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">cpl_reap</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c0-1550"></a><span class="lineno">1550</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">cpl_flush</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c0-1551"></a><span class="lineno">1551</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpl_search</span> <span class="n">__P</span><span class="p">((</span><span class="n">pid_t</span><span class="p">));</span>
<a name="c0-1552"></a><span class="lineno">1552</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpl_searchbyname</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c0-1553"></a><span class="lineno">1553</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">cpl_prune</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c0-1554"></a><span class="lineno">1554</span> 
<a name="c0-1555"></a><span class="lineno">1555</span> <span class="n">Coproc</span> <span class="n">sh_coproc</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_PID</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<a name="c0-1556"></a><span class="lineno">1556</span> 
<a name="c0-1557"></a><span class="lineno">1557</span> <span class="n">cplist_t</span> <span class="n">coproc_list</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<a name="c0-1558"></a><span class="lineno">1558</span> 
<a name="c0-1559"></a><span class="lineno">1559</span> <span class="cm">/* Functions to manage the list of coprocs */</span>
<a name="c0-1560"></a><span class="lineno">1560</span> 
<a name="c0-1561"></a><span class="lineno">1561</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span>
<a name="c0-1562"></a><span class="lineno">1562</span> <span class="n">cpe_alloc</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1563"></a><span class="lineno">1563</span>      <span class="n">Coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1564"></a><span class="lineno">1564</span> <span class="p">{</span>
<a name="c0-1565"></a><span class="lineno">1565</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpe</span><span class="p">;</span>
<a name="c0-1566"></a><span class="lineno">1566</span> 
<a name="c0-1567"></a><span class="lineno">1567</span>   <span class="n">cpe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpelement</span><span class="p">));</span>
<a name="c0-1568"></a><span class="lineno">1568</span>   <span class="n">cpe</span><span class="o">-&gt;</span><span class="n">coproc</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<a name="c0-1569"></a><span class="lineno">1569</span>   <span class="n">cpe</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<a name="c0-1570"></a><span class="lineno">1570</span>   <span class="k">return</span> <span class="n">cpe</span><span class="p">;</span>
<a name="c0-1571"></a><span class="lineno">1571</span> <span class="p">}</span>
<a name="c0-1572"></a><span class="lineno">1572</span> 
<a name="c0-1573"></a><span class="lineno">1573</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-1574"></a><span class="lineno">1574</span> <span class="n">cpe_dispose</span> <span class="p">(</span><span class="n">cpe</span><span class="p">)</span>
<a name="c0-1575"></a><span class="lineno">1575</span>       <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpe</span><span class="p">;</span>
<a name="c0-1576"></a><span class="lineno">1576</span> <span class="p">{</span>
<a name="c0-1577"></a><span class="lineno">1577</span>   <span class="n">free</span> <span class="p">(</span><span class="n">cpe</span><span class="p">);</span>
<a name="c0-1578"></a><span class="lineno">1578</span> <span class="p">}</span>
<a name="c0-1579"></a><span class="lineno">1579</span> 
<a name="c0-1580"></a><span class="lineno">1580</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span>
<a name="c0-1581"></a><span class="lineno">1581</span> <span class="n">cpl_add</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1582"></a><span class="lineno">1582</span>      <span class="n">Coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1583"></a><span class="lineno">1583</span> <span class="p">{</span>
<a name="c0-1584"></a><span class="lineno">1584</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpe</span><span class="p">;</span>
<a name="c0-1585"></a><span class="lineno">1585</span> 
<a name="c0-1586"></a><span class="lineno">1586</span>   <span class="n">cpe</span> <span class="o">=</span> <span class="n">cpe_alloc</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1587"></a><span class="lineno">1587</span> 
<a name="c0-1588"></a><span class="lineno">1588</span>   <span class="k">if</span> <span class="p">(</span><span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1589"></a><span class="lineno">1589</span>     <span class="p">{</span>
<a name="c0-1590"></a><span class="lineno">1590</span>       <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">cpe</span><span class="p">;</span>
<a name="c0-1591"></a><span class="lineno">1591</span>       <span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* just to make sure */</span>
<a name="c0-1592"></a><span class="lineno">1592</span>     <span class="p">}</span>
<a name="c0-1593"></a><span class="lineno">1593</span>   <span class="k">else</span>
<a name="c0-1594"></a><span class="lineno">1594</span>     <span class="p">{</span>
<a name="c0-1595"></a><span class="lineno">1595</span>       <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpe</span><span class="p">;</span>
<a name="c0-1596"></a><span class="lineno">1596</span>       <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">cpe</span><span class="p">;</span>
<a name="c0-1597"></a><span class="lineno">1597</span>     <span class="p">}</span>
<a name="c0-1598"></a><span class="lineno">1598</span>   <span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1599"></a><span class="lineno">1599</span> 
<a name="c0-1600"></a><span class="lineno">1600</span>   <span class="k">return</span> <span class="n">cpe</span><span class="p">;</span>
<a name="c0-1601"></a><span class="lineno">1601</span> <span class="p">}</span>
<a name="c0-1602"></a><span class="lineno">1602</span> 
<a name="c0-1603"></a><span class="lineno">1603</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span>
<a name="c0-1604"></a><span class="lineno">1604</span> <span class="n">cpl_delete</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<a name="c0-1605"></a><span class="lineno">1605</span>      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-1606"></a><span class="lineno">1606</span> <span class="p">{</span>
<a name="c0-1607"></a><span class="lineno">1607</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-1608"></a><span class="lineno">1608</span> 
<a name="c0-1609"></a><span class="lineno">1609</span>   <span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-1610"></a><span class="lineno">1610</span>     <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">c_pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
<a name="c0-1611"></a><span class="lineno">1611</span>       <span class="p">{</span>
<a name="c0-1612"></a><span class="lineno">1612</span>         <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>  <span class="cm">/* remove from list */</span>
<a name="c0-1613"></a><span class="lineno">1613</span>         <span class="k">break</span><span class="p">;</span>
<a name="c0-1614"></a><span class="lineno">1614</span>       <span class="p">}</span>
<a name="c0-1615"></a><span class="lineno">1615</span> 
<a name="c0-1616"></a><span class="lineno">1616</span>   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1617"></a><span class="lineno">1617</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* not found */</span>
<a name="c0-1618"></a><span class="lineno">1618</span> 
<a name="c0-1619"></a><span class="lineno">1619</span> <span class="cp">#if defined (DEBUG)</span>
<a name="c0-1620"></a><span class="lineno">1620</span>   <span class="n">itrace</span><span class="p">(</span><span class="s">"cpl_delete: deleting %d"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
<a name="c0-1621"></a><span class="lineno">1621</span> <span class="cp">#endif</span>
<a name="c0-1622"></a><span class="lineno">1622</span> 
<a name="c0-1623"></a><span class="lineno">1623</span>   <span class="cm">/* Housekeeping in the border cases. */</span>
<a name="c0-1624"></a><span class="lineno">1624</span>   <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
<a name="c0-1625"></a><span class="lineno">1625</span>     <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-1626"></a><span class="lineno">1626</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span>
<a name="c0-1627"></a><span class="lineno">1627</span>     <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
<a name="c0-1628"></a><span class="lineno">1628</span> 
<a name="c0-1629"></a><span class="lineno">1629</span>   <span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1630"></a><span class="lineno">1630</span>   <span class="k">if</span> <span class="p">(</span><span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1631"></a><span class="lineno">1631</span>     <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1632"></a><span class="lineno">1632</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-1633"></a><span class="lineno">1633</span>     <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>   <span class="cm">/* just to make sure */</span>
<a name="c0-1634"></a><span class="lineno">1634</span> 
<a name="c0-1635"></a><span class="lineno">1635</span>   <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c0-1636"></a><span class="lineno">1636</span> <span class="p">}</span>
<a name="c0-1637"></a><span class="lineno">1637</span> 
<a name="c0-1638"></a><span class="lineno">1638</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-1639"></a><span class="lineno">1639</span> <span class="n">cpl_reap</span> <span class="p">()</span>
<a name="c0-1640"></a><span class="lineno">1640</span> <span class="p">{</span>
<a name="c0-1641"></a><span class="lineno">1641</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-1642"></a><span class="lineno">1642</span> 
<a name="c0-1643"></a><span class="lineno">1643</span>   <span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-1644"></a><span class="lineno">1644</span>     <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">c_flags</span> <span class="o">&amp;</span> <span class="n">COPROC_DEAD</span><span class="p">)</span>
<a name="c0-1645"></a><span class="lineno">1645</span>       <span class="p">{</span>
<a name="c0-1646"></a><span class="lineno">1646</span>         <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>  <span class="cm">/* remove from list */</span>
<a name="c0-1647"></a><span class="lineno">1647</span> 
<a name="c0-1648"></a><span class="lineno">1648</span>  <span class="cm">/* Housekeeping in the border cases. */</span>
<a name="c0-1649"></a><span class="lineno">1649</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
<a name="c0-1650"></a><span class="lineno">1650</span>    <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-1651"></a><span class="lineno">1651</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span>
<a name="c0-1652"></a><span class="lineno">1652</span>    <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
<a name="c0-1653"></a><span class="lineno">1653</span> 
<a name="c0-1654"></a><span class="lineno">1654</span>  <span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1655"></a><span class="lineno">1655</span>  <span class="k">if</span> <span class="p">(</span><span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1656"></a><span class="lineno">1656</span>    <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1657"></a><span class="lineno">1657</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-1658"></a><span class="lineno">1658</span>    <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>    <span class="cm">/* just to make sure */</span>
<a name="c0-1659"></a><span class="lineno">1659</span> 
<a name="c0-1660"></a><span class="lineno">1660</span> <span class="cp">#if defined (DEBUG)</span>
<a name="c0-1661"></a><span class="lineno">1661</span>  <span class="n">itrace</span><span class="p">(</span><span class="s">"cpl_reap: deleting %d"</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">c_pid</span><span class="p">);</span>
<a name="c0-1662"></a><span class="lineno">1662</span> <span class="cp">#endif</span>
<a name="c0-1663"></a><span class="lineno">1663</span> 
<a name="c0-1664"></a><span class="lineno">1664</span>  <span class="n">coproc_dispose</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="p">);</span>
<a name="c0-1665"></a><span class="lineno">1665</span>  <span class="n">cpe_dispose</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c0-1666"></a><span class="lineno">1666</span>       <span class="p">}</span>
<a name="c0-1667"></a><span class="lineno">1667</span> <span class="p">}</span>
<a name="c0-1668"></a><span class="lineno">1668</span> 
<a name="c0-1669"></a><span class="lineno">1669</span> <span class="cm">/* Clear out the list of saved statuses */</span>
<a name="c0-1670"></a><span class="lineno">1670</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-1671"></a><span class="lineno">1671</span> <span class="n">cpl_flush</span> <span class="p">()</span>
<a name="c0-1672"></a><span class="lineno">1672</span> <span class="p">{</span>
<a name="c0-1673"></a><span class="lineno">1673</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cpe</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-1674"></a><span class="lineno">1674</span> 
<a name="c0-1675"></a><span class="lineno">1675</span>   <span class="k">for</span> <span class="p">(</span><span class="n">cpe</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span><span class="p">;</span> <span class="n">cpe</span><span class="p">;</span> <span class="p">)</span>
<a name="c0-1676"></a><span class="lineno">1676</span>     <span class="p">{</span>
<a name="c0-1677"></a><span class="lineno">1677</span>       <span class="n">p</span> <span class="o">=</span> <span class="n">cpe</span><span class="p">;</span>
<a name="c0-1678"></a><span class="lineno">1678</span>       <span class="n">cpe</span> <span class="o">=</span> <span class="n">cpe</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-1679"></a><span class="lineno">1679</span> 
<a name="c0-1680"></a><span class="lineno">1680</span>       <span class="n">coproc_dispose</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="p">);</span>
<a name="c0-1681"></a><span class="lineno">1681</span>       <span class="n">cpe_dispose</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c0-1682"></a><span class="lineno">1682</span>     <span class="p">}</span>
<a name="c0-1683"></a><span class="lineno">1683</span> 
<a name="c0-1684"></a><span class="lineno">1684</span>   <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1685"></a><span class="lineno">1685</span>   <span class="n">coproc_list</span><span class="p">.</span><span class="n">ncoproc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1686"></a><span class="lineno">1686</span> <span class="p">}</span>
<a name="c0-1687"></a><span class="lineno">1687</span> 
<a name="c0-1688"></a><span class="lineno">1688</span> <span class="cm">/* Search for PID in the list of coprocs; return the cpelement struct if</span>
<a name="c0-1689"></a><span class="lineno">1689</span> <span class="cm">   found.  If not found, return NULL. */</span>
<a name="c0-1690"></a><span class="lineno">1690</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span>
<a name="c0-1691"></a><span class="lineno">1691</span> <span class="n">cpl_search</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<a name="c0-1692"></a><span class="lineno">1692</span>      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-1693"></a><span class="lineno">1693</span> <span class="p">{</span>
<a name="c0-1694"></a><span class="lineno">1694</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1695"></a><span class="lineno">1695</span> 
<a name="c0-1696"></a><span class="lineno">1696</span>   <span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="p">;</span> <span class="n">cp</span><span class="p">;</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-1697"></a><span class="lineno">1697</span>     <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">c_pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
<a name="c0-1698"></a><span class="lineno">1698</span>       <span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<a name="c0-1699"></a><span class="lineno">1699</span>   <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1700"></a><span class="lineno">1700</span> <span class="p">}</span>
<a name="c0-1701"></a><span class="lineno">1701</span> 
<a name="c0-1702"></a><span class="lineno">1702</span> <span class="cm">/* Search for the coproc named NAME in the list of coprocs; return the</span>
<a name="c0-1703"></a><span class="lineno">1703</span> <span class="cm">   cpelement struct if found.  If not found, return NULL. */</span>
<a name="c0-1704"></a><span class="lineno">1704</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span>
<a name="c0-1705"></a><span class="lineno">1705</span> <span class="n">cpl_searchbyname</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a name="c0-1706"></a><span class="lineno">1706</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-1707"></a><span class="lineno">1707</span> <span class="p">{</span>
<a name="c0-1708"></a><span class="lineno">1708</span>   <span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1709"></a><span class="lineno">1709</span> 
<a name="c0-1710"></a><span class="lineno">1710</span>   <span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">coproc_list</span><span class="p">.</span><span class="n">head</span> <span class="p">;</span> <span class="n">cp</span><span class="p">;</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-1711"></a><span class="lineno">1711</span>     <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
<a name="c0-1712"></a><span class="lineno">1712</span>       <span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<a name="c0-1713"></a><span class="lineno">1713</span>   <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpelement</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1714"></a><span class="lineno">1714</span> <span class="p">}</span>
<a name="c0-1715"></a><span class="lineno">1715</span> 
<a name="c0-1716"></a><span class="lineno">1716</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-1717"></a><span class="lineno">1717</span> <span class="c">static void</span>
<a name="c0-1718"></a><span class="lineno">1718</span> <span class="c">cpl_prune ()</span>
<a name="c0-1719"></a><span class="lineno">1719</span> <span class="c">{</span>
<a name="c0-1720"></a><span class="lineno">1720</span> <span class="c">  struct cpelement *cp;</span>
<a name="c0-1721"></a><span class="lineno">1721</span> 
<a name="c0-1722"></a><span class="lineno">1722</span> <span class="c">  while (coproc_list.head &amp;&amp; coproc_list.ncoproc &gt; COPROC_MAX)</span>
<a name="c0-1723"></a><span class="lineno">1723</span> <span class="c">    {</span>
<a name="c0-1724"></a><span class="lineno">1724</span> <span class="c">      cp = coproc_list.head;</span>
<a name="c0-1725"></a><span class="lineno">1725</span> <span class="c">      coproc_list.head = coproc_list.head-&gt;next;</span>
<a name="c0-1726"></a><span class="lineno">1726</span> <span class="c">      coproc_dispose (cp-&gt;coproc);</span>
<a name="c0-1727"></a><span class="lineno">1727</span> <span class="c">      cpe_dispose (cp);</span>
<a name="c0-1728"></a><span class="lineno">1728</span> <span class="c">      coproc_list.ncoproc--;</span>
<a name="c0-1729"></a><span class="lineno">1729</span> <span class="c">    }</span>
<a name="c0-1730"></a><span class="lineno">1730</span> <span class="c">}</span>
<a name="c0-1731"></a><span class="lineno">1731</span> <span class="cp">#endif</span>
<a name="c0-1732"></a><span class="lineno">1732</span> 
<a name="c0-1733"></a><span class="lineno">1733</span> <span class="cm">/* These currently use a single global "shell coproc" but are written in a</span>
<a name="c0-1734"></a><span class="lineno">1734</span> <span class="cm">   way to not preclude additional coprocs later (using the list management</span>
<a name="c0-1735"></a><span class="lineno">1735</span> <span class="cm">   package above). */</span>
<a name="c0-1736"></a><span class="lineno">1736</span> 
<a name="c0-1737"></a><span class="lineno">1737</span> <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span>
<a name="c0-1738"></a><span class="lineno">1738</span> <span class="n">getcoprocbypid</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<a name="c0-1739"></a><span class="lineno">1739</span>      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-1740"></a><span class="lineno">1740</span> <span class="p">{</span>
<a name="c0-1741"></a><span class="lineno">1741</span>   <span class="k">return</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">sh_coproc</span><span class="p">.</span><span class="n">c_pid</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sh_coproc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1742"></a><span class="lineno">1742</span> <span class="p">}</span>
<a name="c0-1743"></a><span class="lineno">1743</span> 
<a name="c0-1744"></a><span class="lineno">1744</span> <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span>
<a name="c0-1745"></a><span class="lineno">1745</span> <span class="n">getcoprocbyname</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a name="c0-1746"></a><span class="lineno">1746</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-1747"></a><span class="lineno">1747</span> <span class="p">{</span>
<a name="c0-1748"></a><span class="lineno">1748</span>   <span class="k">return</span> <span class="p">((</span><span class="n">sh_coproc</span><span class="p">.</span><span class="n">c_name</span> <span class="o">&amp;&amp;</span> <span class="n">STREQ</span> <span class="p">(</span><span class="n">sh_coproc</span><span class="p">.</span><span class="n">c_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">sh_coproc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1749"></a><span class="lineno">1749</span> <span class="p">}</span>
<a name="c0-1750"></a><span class="lineno">1750</span> 
<a name="c0-1751"></a><span class="lineno">1751</span> <span class="kt">void</span>
<a name="c0-1752"></a><span class="lineno">1752</span> <span class="n">coproc_init</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1753"></a><span class="lineno">1753</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1754"></a><span class="lineno">1754</span> <span class="p">{</span>
<a name="c0-1755"></a><span class="lineno">1755</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1756"></a><span class="lineno">1756</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_pid</span> <span class="o">=</span> <span class="n">NO_PID</span><span class="p">;</span>
<a name="c0-1757"></a><span class="lineno">1757</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1758"></a><span class="lineno">1758</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rsave</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wsave</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1759"></a><span class="lineno">1759</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_flags</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
<a name="c0-1760"></a><span class="lineno">1760</span> <span class="p">}</span>
<a name="c0-1761"></a><span class="lineno">1761</span> 
<a name="c0-1762"></a><span class="lineno">1762</span> <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span>
<a name="c0-1763"></a><span class="lineno">1763</span> <span class="n">coproc_alloc</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
<a name="c0-1764"></a><span class="lineno">1764</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-1765"></a><span class="lineno">1765</span>      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-1766"></a><span class="lineno">1766</span> <span class="p">{</span>
<a name="c0-1767"></a><span class="lineno">1767</span>   <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1768"></a><span class="lineno">1768</span> 
<a name="c0-1769"></a><span class="lineno">1769</span>   <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_coproc</span><span class="p">;</span>    <span class="cm">/* XXX */</span>
<a name="c0-1770"></a><span class="lineno">1770</span>   <span class="n">coproc_init</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1771"></a><span class="lineno">1771</span> 
<a name="c0-1772"></a><span class="lineno">1772</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-1773"></a><span class="lineno">1773</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-1774"></a><span class="lineno">1774</span> 
<a name="c0-1775"></a><span class="lineno">1775</span>   <span class="k">return</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1776"></a><span class="lineno">1776</span> <span class="p">}</span>
<a name="c0-1777"></a><span class="lineno">1777</span> 
<a name="c0-1778"></a><span class="lineno">1778</span> <span class="kt">void</span>
<a name="c0-1779"></a><span class="lineno">1779</span> <span class="n">coproc_dispose</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1780"></a><span class="lineno">1780</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1781"></a><span class="lineno">1781</span> <span class="p">{</span>
<a name="c0-1782"></a><span class="lineno">1782</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1783"></a><span class="lineno">1783</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-1784"></a><span class="lineno">1784</span> 
<a name="c0-1785"></a><span class="lineno">1785</span>   <span class="n">coproc_unsetvars</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1786"></a><span class="lineno">1786</span>   <span class="n">FREE</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1787"></a><span class="lineno">1787</span>   <span class="n">coproc_close</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1788"></a><span class="lineno">1788</span>   <span class="n">coproc_init</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1789"></a><span class="lineno">1789</span> <span class="p">}</span>
<a name="c0-1790"></a><span class="lineno">1790</span> 
<a name="c0-1791"></a><span class="lineno">1791</span> <span class="cm">/* Placeholder for now. */</span>
<a name="c0-1792"></a><span class="lineno">1792</span> <span class="kt">void</span>
<a name="c0-1793"></a><span class="lineno">1793</span> <span class="n">coproc_flush</span> <span class="p">()</span>
<a name="c0-1794"></a><span class="lineno">1794</span> <span class="p">{</span>
<a name="c0-1795"></a><span class="lineno">1795</span>   <span class="n">coproc_dispose</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sh_coproc</span><span class="p">);</span>
<a name="c0-1796"></a><span class="lineno">1796</span> <span class="p">}</span>
<a name="c0-1797"></a><span class="lineno">1797</span> 
<a name="c0-1798"></a><span class="lineno">1798</span> <span class="kt">void</span>
<a name="c0-1799"></a><span class="lineno">1799</span> <span class="n">coproc_close</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1800"></a><span class="lineno">1800</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1801"></a><span class="lineno">1801</span> <span class="p">{</span>
<a name="c0-1802"></a><span class="lineno">1802</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1803"></a><span class="lineno">1803</span>     <span class="p">{</span>
<a name="c0-1804"></a><span class="lineno">1804</span>       <span class="n">close</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span><span class="p">);</span>
<a name="c0-1805"></a><span class="lineno">1805</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1806"></a><span class="lineno">1806</span>     <span class="p">}</span>
<a name="c0-1807"></a><span class="lineno">1807</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1808"></a><span class="lineno">1808</span>     <span class="p">{</span>
<a name="c0-1809"></a><span class="lineno">1809</span>       <span class="n">close</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span><span class="p">);</span>
<a name="c0-1810"></a><span class="lineno">1810</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1811"></a><span class="lineno">1811</span>     <span class="p">}</span>
<a name="c0-1812"></a><span class="lineno">1812</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rsave</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wsave</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1813"></a><span class="lineno">1813</span> <span class="p">}</span>
<a name="c0-1814"></a><span class="lineno">1814</span> 
<a name="c0-1815"></a><span class="lineno">1815</span> <span class="kt">void</span>
<a name="c0-1816"></a><span class="lineno">1816</span> <span class="n">coproc_closeall</span> <span class="p">()</span>
<a name="c0-1817"></a><span class="lineno">1817</span> <span class="p">{</span>
<a name="c0-1818"></a><span class="lineno">1818</span>   <span class="n">coproc_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sh_coproc</span><span class="p">);</span>
<a name="c0-1819"></a><span class="lineno">1819</span> <span class="p">}</span>
<a name="c0-1820"></a><span class="lineno">1820</span> 
<a name="c0-1821"></a><span class="lineno">1821</span> <span class="kt">void</span>
<a name="c0-1822"></a><span class="lineno">1822</span> <span class="n">coproc_reap</span> <span class="p">()</span>
<a name="c0-1823"></a><span class="lineno">1823</span> <span class="p">{</span>
<a name="c0-1824"></a><span class="lineno">1824</span>   <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1825"></a><span class="lineno">1825</span> 
<a name="c0-1826"></a><span class="lineno">1826</span>   <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_coproc</span><span class="p">;</span>
<a name="c0-1827"></a><span class="lineno">1827</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_flags</span> <span class="o">&amp;</span> <span class="n">COPROC_DEAD</span><span class="p">))</span>
<a name="c0-1828"></a><span class="lineno">1828</span>     <span class="n">coproc_dispose</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1829"></a><span class="lineno">1829</span> <span class="p">}</span>
<a name="c0-1830"></a><span class="lineno">1830</span> 
<a name="c0-1831"></a><span class="lineno">1831</span> <span class="kt">void</span>
<a name="c0-1832"></a><span class="lineno">1832</span> <span class="n">coproc_rclose</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1833"></a><span class="lineno">1833</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1834"></a><span class="lineno">1834</span>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-1835"></a><span class="lineno">1835</span> <span class="p">{</span>
<a name="c0-1836"></a><span class="lineno">1836</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">==</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1837"></a><span class="lineno">1837</span>     <span class="p">{</span>
<a name="c0-1838"></a><span class="lineno">1838</span>       <span class="n">close</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span><span class="p">);</span>
<a name="c0-1839"></a><span class="lineno">1839</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1840"></a><span class="lineno">1840</span>     <span class="p">}</span>
<a name="c0-1841"></a><span class="lineno">1841</span> <span class="p">}</span>
<a name="c0-1842"></a><span class="lineno">1842</span> 
<a name="c0-1843"></a><span class="lineno">1843</span> <span class="kt">void</span>
<a name="c0-1844"></a><span class="lineno">1844</span> <span class="n">coproc_wclose</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1845"></a><span class="lineno">1845</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1846"></a><span class="lineno">1846</span>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-1847"></a><span class="lineno">1847</span> <span class="p">{</span>
<a name="c0-1848"></a><span class="lineno">1848</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">==</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1849"></a><span class="lineno">1849</span>     <span class="p">{</span>
<a name="c0-1850"></a><span class="lineno">1850</span>       <span class="n">close</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span><span class="p">);</span>
<a name="c0-1851"></a><span class="lineno">1851</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1852"></a><span class="lineno">1852</span>     <span class="p">}</span>
<a name="c0-1853"></a><span class="lineno">1853</span> <span class="p">}</span>
<a name="c0-1854"></a><span class="lineno">1854</span> 
<a name="c0-1855"></a><span class="lineno">1855</span> <span class="kt">void</span>
<a name="c0-1856"></a><span class="lineno">1856</span> <span class="n">coproc_checkfd</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1857"></a><span class="lineno">1857</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1858"></a><span class="lineno">1858</span>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-1859"></a><span class="lineno">1859</span> <span class="p">{</span>
<a name="c0-1860"></a><span class="lineno">1860</span>   <span class="kt">int</span> <span class="n">update</span><span class="p">;</span>
<a name="c0-1861"></a><span class="lineno">1861</span> 
<a name="c0-1862"></a><span class="lineno">1862</span>   <span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1863"></a><span class="lineno">1863</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">==</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1864"></a><span class="lineno">1864</span>     <span class="n">update</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1865"></a><span class="lineno">1865</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">==</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1866"></a><span class="lineno">1866</span>     <span class="n">update</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1867"></a><span class="lineno">1867</span>   <span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>
<a name="c0-1868"></a><span class="lineno">1868</span>     <span class="n">coproc_setvars</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1869"></a><span class="lineno">1869</span> <span class="p">}</span>
<a name="c0-1870"></a><span class="lineno">1870</span> 
<a name="c0-1871"></a><span class="lineno">1871</span> <span class="kt">void</span>
<a name="c0-1872"></a><span class="lineno">1872</span> <span class="n">coproc_fdchk</span> <span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<a name="c0-1873"></a><span class="lineno">1873</span>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-1874"></a><span class="lineno">1874</span> <span class="p">{</span>
<a name="c0-1875"></a><span class="lineno">1875</span>   <span class="n">coproc_checkfd</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sh_coproc</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
<a name="c0-1876"></a><span class="lineno">1876</span> <span class="p">}</span>
<a name="c0-1877"></a><span class="lineno">1877</span> 
<a name="c0-1878"></a><span class="lineno">1878</span> <span class="kt">void</span>
<a name="c0-1879"></a><span class="lineno">1879</span> <span class="n">coproc_fdclose</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-1880"></a><span class="lineno">1880</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1881"></a><span class="lineno">1881</span>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-1882"></a><span class="lineno">1882</span> <span class="p">{</span>
<a name="c0-1883"></a><span class="lineno">1883</span>   <span class="n">coproc_rclose</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
<a name="c0-1884"></a><span class="lineno">1884</span>   <span class="n">coproc_wclose</span> <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
<a name="c0-1885"></a><span class="lineno">1885</span>   <span class="n">coproc_setvars</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-1886"></a><span class="lineno">1886</span> <span class="p">}</span>
<a name="c0-1887"></a><span class="lineno">1887</span> 
<a name="c0-1888"></a><span class="lineno">1888</span> <span class="kt">void</span>
<a name="c0-1889"></a><span class="lineno">1889</span> <span class="n">coproc_fdsave</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1890"></a><span class="lineno">1890</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1891"></a><span class="lineno">1891</span> <span class="p">{</span>
<a name="c0-1892"></a><span class="lineno">1892</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rsave</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span><span class="p">;</span>
<a name="c0-1893"></a><span class="lineno">1893</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wsave</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span><span class="p">;</span>
<a name="c0-1894"></a><span class="lineno">1894</span> <span class="p">}</span>
<a name="c0-1895"></a><span class="lineno">1895</span> 
<a name="c0-1896"></a><span class="lineno">1896</span> <span class="kt">void</span>
<a name="c0-1897"></a><span class="lineno">1897</span> <span class="n">coproc_fdrestore</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1898"></a><span class="lineno">1898</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1899"></a><span class="lineno">1899</span> <span class="p">{</span>
<a name="c0-1900"></a><span class="lineno">1900</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rsave</span><span class="p">;</span>
<a name="c0-1901"></a><span class="lineno">1901</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wsave</span><span class="p">;</span>
<a name="c0-1902"></a><span class="lineno">1902</span> <span class="p">}</span>
<a name="c0-1903"></a><span class="lineno">1903</span> 
<a name="c0-1904"></a><span class="lineno">1904</span> <span class="kt">void</span>
<a name="c0-1905"></a><span class="lineno">1905</span> <span class="n">coproc_pidchk</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
<a name="c0-1906"></a><span class="lineno">1906</span>      <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-1907"></a><span class="lineno">1907</span> <span class="p">{</span>
<a name="c0-1908"></a><span class="lineno">1908</span>   <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1909"></a><span class="lineno">1909</span> 
<a name="c0-1910"></a><span class="lineno">1910</span>   <span class="n">cp</span> <span class="o">=</span> <span class="n">getcoprocbypid</span> <span class="p">(</span><span class="n">pid</span><span class="p">);</span>
<a name="c0-1911"></a><span class="lineno">1911</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-1912"></a><span class="lineno">1912</span> <span class="c">  if (cp)</span>
<a name="c0-1913"></a><span class="lineno">1913</span> <span class="c">    itrace("coproc_pidchk: pid %d has died", pid);</span>
<a name="c0-1914"></a><span class="lineno">1914</span> <span class="cp">#endif</span>
<a name="c0-1915"></a><span class="lineno">1915</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1916"></a><span class="lineno">1916</span>     <span class="p">{</span>
<a name="c0-1917"></a><span class="lineno">1917</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-1918"></a><span class="lineno">1918</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_flags</span> <span class="o">|=</span> <span class="n">COPROC_DEAD</span><span class="p">;</span>
<a name="c0-1919"></a><span class="lineno">1919</span>       <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">COPROC_RUNNING</span><span class="p">;</span>
<a name="c0-1920"></a><span class="lineno">1920</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-1921"></a><span class="lineno">1921</span> <span class="c">      coproc_dispose (cp);</span>
<a name="c0-1922"></a><span class="lineno">1922</span> <span class="cp">#endif</span>
<a name="c0-1923"></a><span class="lineno">1923</span>     <span class="p">}</span>
<a name="c0-1924"></a><span class="lineno">1924</span> <span class="p">}</span>
<a name="c0-1925"></a><span class="lineno">1925</span> 
<a name="c0-1926"></a><span class="lineno">1926</span> <span class="kt">void</span>
<a name="c0-1927"></a><span class="lineno">1927</span> <span class="n">coproc_setvars</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1928"></a><span class="lineno">1928</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1929"></a><span class="lineno">1929</span> <span class="p">{</span>
<a name="c0-1930"></a><span class="lineno">1930</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
<a name="c0-1931"></a><span class="lineno">1931</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">namevar</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
<a name="c0-1932"></a><span class="lineno">1932</span>   <span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
<a name="c0-1933"></a><span class="lineno">1933</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-1934"></a><span class="lineno">1934</span>   <span class="n">arrayind_t</span> <span class="n">ind</span><span class="p">;</span>
<a name="c0-1935"></a><span class="lineno">1935</span> <span class="cp">#endif</span>
<a name="c0-1936"></a><span class="lineno">1936</span> 
<a name="c0-1937"></a><span class="lineno">1937</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1938"></a><span class="lineno">1938</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-1939"></a><span class="lineno">1939</span> 
<a name="c0-1940"></a><span class="lineno">1940</span>   <span class="n">l</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1941"></a><span class="lineno">1941</span>   <span class="n">namevar</span> <span class="o">=</span> <span class="n">xmalloc</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
<a name="c0-1942"></a><span class="lineno">1942</span> 
<a name="c0-1943"></a><span class="lineno">1943</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-1944"></a><span class="lineno">1944</span>   <span class="n">v</span> <span class="o">=</span> <span class="n">find_variable</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1945"></a><span class="lineno">1945</span>   <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1946"></a><span class="lineno">1946</span>     <span class="n">v</span> <span class="o">=</span> <span class="n">make_new_array_variable</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1947"></a><span class="lineno">1947</span>   <span class="k">if</span> <span class="p">(</span><span class="n">array_p</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1948"></a><span class="lineno">1948</span>     <span class="n">v</span> <span class="o">=</span> <span class="n">convert_var_to_array</span> <span class="p">(</span><span class="n">v</span><span class="p">);</span>
<a name="c0-1949"></a><span class="lineno">1949</span> 
<a name="c0-1950"></a><span class="lineno">1950</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span><span class="p">);</span>
<a name="c0-1951"></a><span class="lineno">1951</span>   <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1952"></a><span class="lineno">1952</span>   <span class="n">v</span> <span class="o">=</span> <span class="n">bind_array_variable</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1953"></a><span class="lineno">1953</span>   <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c0-1954"></a><span class="lineno">1954</span> 
<a name="c0-1955"></a><span class="lineno">1955</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span><span class="p">);</span>
<a name="c0-1956"></a><span class="lineno">1956</span>   <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1957"></a><span class="lineno">1957</span>   <span class="n">bind_array_variable</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1958"></a><span class="lineno">1958</span>   <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c0-1959"></a><span class="lineno">1959</span> <span class="cp">#else</span>
<a name="c0-1960"></a><span class="lineno">1960</span>   <span class="n">sprintf</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="s">"%s_READ"</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1961"></a><span class="lineno">1961</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span><span class="p">);</span>
<a name="c0-1962"></a><span class="lineno">1962</span>   <span class="n">bind_variable</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1963"></a><span class="lineno">1963</span>   <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c0-1964"></a><span class="lineno">1964</span>   <span class="n">sprintf</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="s">"%s_WRITE"</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1965"></a><span class="lineno">1965</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span><span class="p">);</span>
<a name="c0-1966"></a><span class="lineno">1966</span>   <span class="n">bind_variable</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1967"></a><span class="lineno">1967</span>   <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c0-1968"></a><span class="lineno">1968</span> <span class="cp">#endif</span>
<a name="c0-1969"></a><span class="lineno">1969</span> 
<a name="c0-1970"></a><span class="lineno">1970</span>   <span class="n">sprintf</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="s">"%s_PID"</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1971"></a><span class="lineno">1971</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_pid</span><span class="p">);</span>
<a name="c0-1972"></a><span class="lineno">1972</span>   <span class="n">bind_variable</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1973"></a><span class="lineno">1973</span>   <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c0-1974"></a><span class="lineno">1974</span> 
<a name="c0-1975"></a><span class="lineno">1975</span>   <span class="n">free</span> <span class="p">(</span><span class="n">namevar</span><span class="p">);</span>
<a name="c0-1976"></a><span class="lineno">1976</span> <span class="p">}</span>
<a name="c0-1977"></a><span class="lineno">1977</span> 
<a name="c0-1978"></a><span class="lineno">1978</span> <span class="kt">void</span>
<a name="c0-1979"></a><span class="lineno">1979</span> <span class="n">coproc_unsetvars</span> <span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1980"></a><span class="lineno">1980</span>      <span class="k">struct</span> <span class="n">coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1981"></a><span class="lineno">1981</span> <span class="p">{</span>
<a name="c0-1982"></a><span class="lineno">1982</span>   <span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
<a name="c0-1983"></a><span class="lineno">1983</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">namevar</span><span class="p">;</span>
<a name="c0-1984"></a><span class="lineno">1984</span> 
<a name="c0-1985"></a><span class="lineno">1985</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1986"></a><span class="lineno">1986</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-1987"></a><span class="lineno">1987</span> 
<a name="c0-1988"></a><span class="lineno">1988</span>   <span class="n">l</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1989"></a><span class="lineno">1989</span>   <span class="n">namevar</span> <span class="o">=</span> <span class="n">xmalloc</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
<a name="c0-1990"></a><span class="lineno">1990</span> 
<a name="c0-1991"></a><span class="lineno">1991</span>   <span class="n">sprintf</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="s">"%s_PID"</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1992"></a><span class="lineno">1992</span>   <span class="n">unbind_variable</span> <span class="p">(</span><span class="n">namevar</span><span class="p">);</span>  
<a name="c0-1993"></a><span class="lineno">1993</span> 
<a name="c0-1994"></a><span class="lineno">1994</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-1995"></a><span class="lineno">1995</span>   <span class="n">unbind_variable</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1996"></a><span class="lineno">1996</span> <span class="cp">#else</span>
<a name="c0-1997"></a><span class="lineno">1997</span>   <span class="n">sprintf</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="s">"%s_READ"</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-1998"></a><span class="lineno">1998</span>   <span class="n">unbind_variable</span> <span class="p">(</span><span class="n">namevar</span><span class="p">);</span>
<a name="c0-1999"></a><span class="lineno">1999</span>   <span class="n">sprintf</span> <span class="p">(</span><span class="n">namevar</span><span class="p">,</span> <span class="s">"%s_WRITE"</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-2000"></a><span class="lineno">2000</span>   <span class="n">unbind_variable</span> <span class="p">(</span><span class="n">namevar</span><span class="p">);</span>
<a name="c0-2001"></a><span class="lineno">2001</span> <span class="cp">#endif  </span>
<a name="c0-2002"></a><span class="lineno">2002</span> 
<a name="c0-2003"></a><span class="lineno">2003</span>   <span class="n">free</span> <span class="p">(</span><span class="n">namevar</span><span class="p">);</span>
<a name="c0-2004"></a><span class="lineno">2004</span> <span class="p">}</span>
<a name="c0-2005"></a><span class="lineno">2005</span> 
<a name="c0-2006"></a><span class="lineno">2006</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2007"></a><span class="lineno">2007</span> <span class="n">execute_coproc</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-2008"></a><span class="lineno">2008</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-2009"></a><span class="lineno">2009</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-2010"></a><span class="lineno">2010</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-2011"></a><span class="lineno">2011</span> <span class="p">{</span>
<a name="c0-2012"></a><span class="lineno">2012</span>   <span class="kt">int</span> <span class="n">rpipe</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wpipe</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">estat</span><span class="p">;</span>
<a name="c0-2013"></a><span class="lineno">2013</span>   <span class="n">pid_t</span> <span class="n">coproc_pid</span><span class="p">;</span>
<a name="c0-2014"></a><span class="lineno">2014</span>   <span class="n">Coproc</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-2015"></a><span class="lineno">2015</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">tcmd</span><span class="p">;</span>
<a name="c0-2016"></a><span class="lineno">2016</span> 
<a name="c0-2017"></a><span class="lineno">2017</span>   <span class="cm">/* XXX -- will require changes to handle multiple coprocs */</span>
<a name="c0-2018"></a><span class="lineno">2018</span>   <span class="k">if</span> <span class="p">(</span><span class="n">sh_coproc</span><span class="p">.</span><span class="n">c_pid</span> <span class="o">!=</span> <span class="n">NO_PID</span><span class="p">)</span>
<a name="c0-2019"></a><span class="lineno">2019</span>     <span class="p">{</span>
<a name="c0-2020"></a><span class="lineno">2020</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2021"></a><span class="lineno">2021</span> <span class="c">      internal_error ("execute_coproc: coproc [%d:%s] already exists", sh_coproc.c_pid, sh_coproc.c_name);</span>
<a name="c0-2022"></a><span class="lineno">2022</span> <span class="c">      return (last_command_exit_value = EXECUTION_FAILURE);</span>
<a name="c0-2023"></a><span class="lineno">2023</span> <span class="cp">#else</span>
<a name="c0-2024"></a><span class="lineno">2024</span>       <span class="n">internal_warning</span> <span class="p">(</span><span class="s">"execute_coproc: coproc [%d:%s] still exists"</span><span class="p">,</span> <span class="n">sh_coproc</span><span class="p">.</span><span class="n">c_pid</span><span class="p">,</span> <span class="n">sh_coproc</span><span class="p">.</span><span class="n">c_name</span><span class="p">);</span>
<a name="c0-2025"></a><span class="lineno">2025</span> <span class="cp">#endif</span>
<a name="c0-2026"></a><span class="lineno">2026</span>     <span class="p">}</span>
<a name="c0-2027"></a><span class="lineno">2027</span>   <span class="n">coproc_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">sh_coproc</span><span class="p">);</span>
<a name="c0-2028"></a><span class="lineno">2028</span> 
<a name="c0-2029"></a><span class="lineno">2029</span>   <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2030"></a><span class="lineno">2030</span>   <span class="n">tcmd</span> <span class="o">=</span> <span class="n">make_command_string</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
<a name="c0-2031"></a><span class="lineno">2031</span> 
<a name="c0-2032"></a><span class="lineno">2032</span>   <span class="n">sh_openpipe</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rpipe</span><span class="p">);</span>  <span class="cm">/* 0 = parent read, 1 = child write */</span>
<a name="c0-2033"></a><span class="lineno">2033</span>   <span class="n">sh_openpipe</span> <span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wpipe</span><span class="p">);</span> <span class="cm">/* 0 = child read, 1 = parent write */</span>
<a name="c0-2034"></a><span class="lineno">2034</span> 
<a name="c0-2035"></a><span class="lineno">2035</span>   <span class="n">coproc_pid</span> <span class="o">=</span> <span class="n">make_child</span> <span class="p">(</span><span class="n">savestring</span> <span class="p">(</span><span class="n">tcmd</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-2036"></a><span class="lineno">2036</span>   <span class="k">if</span> <span class="p">(</span><span class="n">coproc_pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2037"></a><span class="lineno">2037</span>     <span class="p">{</span>
<a name="c0-2038"></a><span class="lineno">2038</span>       <span class="n">close</span> <span class="p">(</span><span class="n">rpipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c0-2039"></a><span class="lineno">2039</span>       <span class="n">close</span> <span class="p">(</span><span class="n">wpipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="c0-2040"></a><span class="lineno">2040</span> 
<a name="c0-2041"></a><span class="lineno">2041</span>       <span class="n">estat</span> <span class="o">=</span> <span class="n">execute_in_subshell</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wpipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rpipe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2042"></a><span class="lineno">2042</span> 
<a name="c0-2043"></a><span class="lineno">2043</span>       <span class="n">fflush</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c0-2044"></a><span class="lineno">2044</span>       <span class="n">fflush</span> <span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
<a name="c0-2045"></a><span class="lineno">2045</span> 
<a name="c0-2046"></a><span class="lineno">2046</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">estat</span><span class="p">);</span>
<a name="c0-2047"></a><span class="lineno">2047</span>     <span class="p">}</span>
<a name="c0-2048"></a><span class="lineno">2048</span> 
<a name="c0-2049"></a><span class="lineno">2049</span>   <span class="n">close</span> <span class="p">(</span><span class="n">rpipe</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="c0-2050"></a><span class="lineno">2050</span>   <span class="n">close</span> <span class="p">(</span><span class="n">wpipe</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c0-2051"></a><span class="lineno">2051</span> 
<a name="c0-2052"></a><span class="lineno">2052</span>   <span class="n">cp</span> <span class="o">=</span> <span class="n">coproc_alloc</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Coproc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">coproc_pid</span><span class="p">);</span>
<a name="c0-2053"></a><span class="lineno">2053</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span> <span class="o">=</span> <span class="n">rpipe</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="c0-2054"></a><span class="lineno">2054</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span> <span class="o">=</span> <span class="n">wpipe</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="c0-2055"></a><span class="lineno">2055</span> 
<a name="c0-2056"></a><span class="lineno">2056</span>   <span class="n">SET_CLOSE_ON_EXEC</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_rfd</span><span class="p">);</span>
<a name="c0-2057"></a><span class="lineno">2057</span>   <span class="n">SET_CLOSE_ON_EXEC</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">c_wfd</span><span class="p">);</span>
<a name="c0-2058"></a><span class="lineno">2058</span> 
<a name="c0-2059"></a><span class="lineno">2059</span>   <span class="n">coproc_setvars</span> <span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<a name="c0-2060"></a><span class="lineno">2060</span> 
<a name="c0-2061"></a><span class="lineno">2061</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2062"></a><span class="lineno">2062</span> <span class="c">  itrace ("execute_coproc: [%d] %s", coproc_pid, the_printed_command);</span>
<a name="c0-2063"></a><span class="lineno">2063</span> <span class="cp">#endif</span>
<a name="c0-2064"></a><span class="lineno">2064</span> 
<a name="c0-2065"></a><span class="lineno">2065</span>   <span class="n">close_pipes</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-2066"></a><span class="lineno">2066</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION) &amp;&amp; defined (HAVE_DEV_FD)</span>
<a name="c0-2067"></a><span class="lineno">2067</span>   <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-2068"></a><span class="lineno">2068</span> <span class="cp">#endif</span>
<a name="c0-2069"></a><span class="lineno">2069</span>   <span class="n">stop_pipeline</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2070"></a><span class="lineno">2070</span>   <span class="n">DESCRIBE_PID</span> <span class="p">(</span><span class="n">coproc_pid</span><span class="p">);</span>
<a name="c0-2071"></a><span class="lineno">2071</span>   <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-2072"></a><span class="lineno">2072</span> 
<a name="c0-2073"></a><span class="lineno">2073</span>   <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-2074"></a><span class="lineno">2074</span> <span class="p">}</span>
<a name="c0-2075"></a><span class="lineno">2075</span> <span class="cp">#endif</span>
<a name="c0-2076"></a><span class="lineno">2076</span> 
<a name="c0-2077"></a><span class="lineno">2077</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-2078"></a><span class="lineno">2078</span> <span class="n">restore_stdin</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a name="c0-2079"></a><span class="lineno">2079</span>      <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
<a name="c0-2080"></a><span class="lineno">2080</span> <span class="p">{</span>
<a name="c0-2081"></a><span class="lineno">2081</span>   <span class="n">dup2</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2082"></a><span class="lineno">2082</span>   <span class="n">close</span> <span class="p">(</span><span class="n">s</span><span class="p">);</span>
<a name="c0-2083"></a><span class="lineno">2083</span> <span class="p">}</span>
<a name="c0-2084"></a><span class="lineno">2084</span> 
<a name="c0-2085"></a><span class="lineno">2085</span> <span class="cm">/* Catch-all cleanup function for lastpipe code for unwind-protects */</span>
<a name="c0-2086"></a><span class="lineno">2086</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-2087"></a><span class="lineno">2087</span> <span class="n">lastpipe_cleanup</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a name="c0-2088"></a><span class="lineno">2088</span>      <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
<a name="c0-2089"></a><span class="lineno">2089</span> <span class="p">{</span>
<a name="c0-2090"></a><span class="lineno">2090</span>   <span class="n">unfreeze_jobs_list</span> <span class="p">();</span>
<a name="c0-2091"></a><span class="lineno">2091</span> <span class="p">}</span>
<a name="c0-2092"></a><span class="lineno">2092</span> 
<a name="c0-2093"></a><span class="lineno">2093</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2094"></a><span class="lineno">2094</span> <span class="n">execute_pipeline</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-2095"></a><span class="lineno">2095</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-2096"></a><span class="lineno">2096</span>      <span class="kt">int</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-2097"></a><span class="lineno">2097</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-2098"></a><span class="lineno">2098</span> <span class="p">{</span>
<a name="c0-2099"></a><span class="lineno">2099</span>   <span class="kt">int</span> <span class="n">prev</span><span class="p">,</span> <span class="n">fildes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">new_bitmap_size</span><span class="p">,</span> <span class="n">dummyfd</span><span class="p">,</span> <span class="n">ignore_return</span><span class="p">,</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-2100"></a><span class="lineno">2100</span>   <span class="kt">int</span> <span class="n">lstdin</span><span class="p">,</span> <span class="n">lastpipe_flag</span><span class="p">,</span> <span class="n">lastpipe_jid</span><span class="p">;</span>
<a name="c0-2101"></a><span class="lineno">2101</span>   <span class="n">COMMAND</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
<a name="c0-2102"></a><span class="lineno">2102</span>   <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fd_bitmap</span><span class="p">;</span>
<a name="c0-2103"></a><span class="lineno">2103</span>   <span class="n">pid_t</span> <span class="n">lastpid</span><span class="p">;</span>
<a name="c0-2104"></a><span class="lineno">2104</span> 
<a name="c0-2105"></a><span class="lineno">2105</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2106"></a><span class="lineno">2106</span>   <span class="n">sigset_t</span> <span class="n">set</span><span class="p">,</span> <span class="n">oset</span><span class="p">;</span>
<a name="c0-2107"></a><span class="lineno">2107</span>   <span class="n">BLOCK_CHILD</span> <span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">oset</span><span class="p">);</span>
<a name="c0-2108"></a><span class="lineno">2108</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-2109"></a><span class="lineno">2109</span> 
<a name="c0-2110"></a><span class="lineno">2110</span>   <span class="n">ignore_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2111"></a><span class="lineno">2111</span> 
<a name="c0-2112"></a><span class="lineno">2112</span>   <span class="n">prev</span> <span class="o">=</span> <span class="n">pipe_in</span><span class="p">;</span>
<a name="c0-2113"></a><span class="lineno">2113</span>   <span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<a name="c0-2114"></a><span class="lineno">2114</span> 
<a name="c0-2115"></a><span class="lineno">2115</span>   <span class="k">while</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">cm_connection</span> <span class="o">&amp;&amp;</span>
<a name="c0-2116"></a><span class="lineno">2116</span>   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">connector</span> <span class="o">==</span> <span class="sc">'|'</span><span class="p">)</span>
<a name="c0-2117"></a><span class="lineno">2117</span>     <span class="p">{</span>
<a name="c0-2118"></a><span class="lineno">2118</span>       <span class="cm">/* Make a pipeline between the two commands. */</span>
<a name="c0-2119"></a><span class="lineno">2119</span>       <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="p">(</span><span class="n">fildes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2120"></a><span class="lineno">2120</span>  <span class="p">{</span>
<a name="c0-2121"></a><span class="lineno">2121</span>    <span class="n">sys_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"pipe error"</span><span class="p">));</span>
<a name="c0-2122"></a><span class="lineno">2122</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2123"></a><span class="lineno">2123</span>    <span class="n">terminate_current_pipeline</span> <span class="p">();</span>
<a name="c0-2124"></a><span class="lineno">2124</span>    <span class="n">kill_current_pipeline</span> <span class="p">();</span>
<a name="c0-2125"></a><span class="lineno">2125</span>    <span class="n">UNBLOCK_CHILD</span> <span class="p">(</span><span class="n">oset</span><span class="p">);</span>
<a name="c0-2126"></a><span class="lineno">2126</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-2127"></a><span class="lineno">2127</span>    <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2128"></a><span class="lineno">2128</span>    <span class="cm">/* The unwind-protects installed below will take care</span>
<a name="c0-2129"></a><span class="lineno">2129</span> <span class="cm">       of closing all of the open file descriptors. */</span>
<a name="c0-2130"></a><span class="lineno">2130</span>    <span class="n">throw_to_top_level</span> <span class="p">();</span>
<a name="c0-2131"></a><span class="lineno">2131</span>    <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span> <span class="cm">/* XXX */</span>
<a name="c0-2132"></a><span class="lineno">2132</span>  <span class="p">}</span>
<a name="c0-2133"></a><span class="lineno">2133</span> 
<a name="c0-2134"></a><span class="lineno">2134</span>       <span class="cm">/* Here is a problem: with the new file close-on-exec</span>
<a name="c0-2135"></a><span class="lineno">2135</span> <span class="cm">   code, the read end of the pipe (fildes[0]) stays open</span>
<a name="c0-2136"></a><span class="lineno">2136</span> <span class="cm">   in the first process, so that process will never get a</span>
<a name="c0-2137"></a><span class="lineno">2137</span> <span class="cm">   SIGPIPE.  There is no way to signal the first process</span>
<a name="c0-2138"></a><span class="lineno">2138</span> <span class="cm">   that it should close fildes[0] after forking, so it</span>
<a name="c0-2139"></a><span class="lineno">2139</span> <span class="cm">   remains open.  No SIGPIPE is ever sent because there</span>
<a name="c0-2140"></a><span class="lineno">2140</span> <span class="cm">   is still a file descriptor open for reading connected</span>
<a name="c0-2141"></a><span class="lineno">2141</span> <span class="cm">   to the pipe.  We take care of that here.  This passes</span>
<a name="c0-2142"></a><span class="lineno">2142</span> <span class="cm">   around a bitmap of file descriptors that must be</span>
<a name="c0-2143"></a><span class="lineno">2143</span> <span class="cm">   closed after making a child process in execute_simple_command. */</span>
<a name="c0-2144"></a><span class="lineno">2144</span> 
<a name="c0-2145"></a><span class="lineno">2145</span>       <span class="cm">/* We need fd_bitmap to be at least as big as fildes[0].</span>
<a name="c0-2146"></a><span class="lineno">2146</span> <span class="cm">   If fildes[0] is less than fds_to_close-&gt;size, then</span>
<a name="c0-2147"></a><span class="lineno">2147</span> <span class="cm">   use fds_to_close-&gt;size. */</span>
<a name="c0-2148"></a><span class="lineno">2148</span>       <span class="n">new_bitmap_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">fildes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fds_to_close</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
<a name="c0-2149"></a><span class="lineno">2149</span>        <span class="o">?</span> <span class="n">fds_to_close</span><span class="o">-&gt;</span><span class="n">size</span>
<a name="c0-2150"></a><span class="lineno">2150</span>        <span class="o">:</span> <span class="n">fildes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
<a name="c0-2151"></a><span class="lineno">2151</span> 
<a name="c0-2152"></a><span class="lineno">2152</span>       <span class="n">fd_bitmap</span> <span class="o">=</span> <span class="n">new_fd_bitmap</span> <span class="p">(</span><span class="n">new_bitmap_size</span><span class="p">);</span>
<a name="c0-2153"></a><span class="lineno">2153</span> 
<a name="c0-2154"></a><span class="lineno">2154</span>       <span class="cm">/* Now copy the old information into the new bitmap. */</span>
<a name="c0-2155"></a><span class="lineno">2155</span>       <span class="n">xbcopy</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fds_to_close</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_bitmap</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-2156"></a><span class="lineno">2156</span> 
<a name="c0-2157"></a><span class="lineno">2157</span>       <span class="cm">/* And mark the pipe file descriptors to be closed. */</span>
<a name="c0-2158"></a><span class="lineno">2158</span>       <span class="n">fd_bitmap</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">[</span><span class="n">fildes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2159"></a><span class="lineno">2159</span> 
<a name="c0-2160"></a><span class="lineno">2160</span>       <span class="cm">/* In case there are pipe or out-of-processes errors, we</span>
<a name="c0-2161"></a><span class="lineno">2161</span> <span class="cm">   want all these file descriptors to be closed when</span>
<a name="c0-2162"></a><span class="lineno">2162</span> <span class="cm">   unwind-protects are run, and the storage used for the</span>
<a name="c0-2163"></a><span class="lineno">2163</span> <span class="cm">   bitmaps freed up. */</span>
<a name="c0-2164"></a><span class="lineno">2164</span>       <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"pipe-file-descriptors"</span><span class="p">);</span>
<a name="c0-2165"></a><span class="lineno">2165</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_fd_bitmap</span><span class="p">,</span> <span class="n">fd_bitmap</span><span class="p">);</span>
<a name="c0-2166"></a><span class="lineno">2166</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">close_fd_bitmap</span><span class="p">,</span> <span class="n">fd_bitmap</span><span class="p">);</span>
<a name="c0-2167"></a><span class="lineno">2167</span>       <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2168"></a><span class="lineno">2168</span>  <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
<a name="c0-2169"></a><span class="lineno">2169</span>       <span class="n">dummyfd</span> <span class="o">=</span> <span class="n">fildes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="c0-2170"></a><span class="lineno">2170</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">dummyfd</span><span class="p">);</span>
<a name="c0-2171"></a><span class="lineno">2171</span> 
<a name="c0-2172"></a><span class="lineno">2172</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2173"></a><span class="lineno">2173</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">restore_signal_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oset</span><span class="p">);</span>
<a name="c0-2174"></a><span class="lineno">2174</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-2175"></a><span class="lineno">2175</span> 
<a name="c0-2176"></a><span class="lineno">2176</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a name="c0-2177"></a><span class="lineno">2177</span>  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2178"></a><span class="lineno">2178</span>       <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span>
<a name="c0-2179"></a><span class="lineno">2179</span>        <span class="n">prev</span><span class="p">,</span> <span class="n">fildes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fd_bitmap</span><span class="p">);</span>
<a name="c0-2180"></a><span class="lineno">2180</span> 
<a name="c0-2181"></a><span class="lineno">2181</span>       <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2182"></a><span class="lineno">2182</span>  <span class="n">close</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
<a name="c0-2183"></a><span class="lineno">2183</span> 
<a name="c0-2184"></a><span class="lineno">2184</span>       <span class="n">prev</span> <span class="o">=</span> <span class="n">fildes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="c0-2185"></a><span class="lineno">2185</span>       <span class="n">close</span> <span class="p">(</span><span class="n">fildes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="c0-2186"></a><span class="lineno">2186</span> 
<a name="c0-2187"></a><span class="lineno">2187</span>       <span class="n">dispose_fd_bitmap</span> <span class="p">(</span><span class="n">fd_bitmap</span><span class="p">);</span>
<a name="c0-2188"></a><span class="lineno">2188</span>       <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"pipe-file-descriptors"</span><span class="p">);</span>
<a name="c0-2189"></a><span class="lineno">2189</span> 
<a name="c0-2190"></a><span class="lineno">2190</span>       <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a name="c0-2191"></a><span class="lineno">2191</span>     <span class="p">}</span>
<a name="c0-2192"></a><span class="lineno">2192</span> 
<a name="c0-2193"></a><span class="lineno">2193</span>   <span class="n">lastpid</span> <span class="o">=</span> <span class="n">last_made_pid</span><span class="p">;</span>
<a name="c0-2194"></a><span class="lineno">2194</span> 
<a name="c0-2195"></a><span class="lineno">2195</span>   <span class="cm">/* Now execute the rightmost command in the pipeline.  */</span>
<a name="c0-2196"></a><span class="lineno">2196</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">)</span>
<a name="c0-2197"></a><span class="lineno">2197</span>     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2198"></a><span class="lineno">2198</span> 
<a name="c0-2199"></a><span class="lineno">2199</span>   <span class="n">lastpipe_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2200"></a><span class="lineno">2200</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"lastpipe-exec"</span><span class="p">);</span>
<a name="c0-2201"></a><span class="lineno">2201</span>   <span class="n">lstdin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2202"></a><span class="lineno">2202</span>   <span class="cm">/* If the `lastpipe' option is set with shopt, and job control is not</span>
<a name="c0-2203"></a><span class="lineno">2203</span> <span class="cm">     enabled, execute the last element of non-async pipelines in the</span>
<a name="c0-2204"></a><span class="lineno">2204</span> <span class="cm">     current shell environment. */</span>
<a name="c0-2205"></a><span class="lineno">2205</span>   <span class="k">if</span> <span class="p">(</span><span class="n">lastpipe_opt</span> <span class="o">&amp;&amp;</span> <span class="n">job_control</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">asynchronous</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2206"></a><span class="lineno">2206</span>     <span class="p">{</span>
<a name="c0-2207"></a><span class="lineno">2207</span>       <span class="n">lstdin</span> <span class="o">=</span> <span class="n">move_to_high_fd</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
<a name="c0-2208"></a><span class="lineno">2208</span>       <span class="k">if</span> <span class="p">(</span><span class="n">lstdin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2209"></a><span class="lineno">2209</span>  <span class="p">{</span>
<a name="c0-2210"></a><span class="lineno">2210</span>    <span class="n">do_piping</span> <span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-2211"></a><span class="lineno">2211</span>    <span class="n">prev</span> <span class="o">=</span> <span class="n">NO_PIPE</span><span class="p">;</span>
<a name="c0-2212"></a><span class="lineno">2212</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">restore_stdin</span><span class="p">,</span> <span class="n">lstdin</span><span class="p">);</span>
<a name="c0-2213"></a><span class="lineno">2213</span>    <span class="n">lastpipe_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2214"></a><span class="lineno">2214</span>    <span class="n">freeze_jobs_list</span> <span class="p">();</span>
<a name="c0-2215"></a><span class="lineno">2215</span>    <span class="n">lastpipe_jid</span> <span class="o">=</span> <span class="n">stop_pipeline</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>  <span class="cm">/* XXX */</span>
<a name="c0-2216"></a><span class="lineno">2216</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">lastpipe_cleanup</span><span class="p">,</span> <span class="n">lastpipe_jid</span><span class="p">);</span>
<a name="c0-2217"></a><span class="lineno">2217</span>  <span class="p">}</span>
<a name="c0-2218"></a><span class="lineno">2218</span>       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_LASTPIPE</span><span class="p">;</span>
<a name="c0-2219"></a><span class="lineno">2219</span>     <span class="p">}</span>   
<a name="c0-2220"></a><span class="lineno">2220</span>   <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2221"></a><span class="lineno">2221</span>     <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
<a name="c0-2222"></a><span class="lineno">2222</span> 
<a name="c0-2223"></a><span class="lineno">2223</span>   <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2224"></a><span class="lineno">2224</span> 
<a name="c0-2225"></a><span class="lineno">2225</span>   <span class="k">if</span> <span class="p">(</span><span class="n">lstdin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2226"></a><span class="lineno">2226</span>     <span class="n">restore_stdin</span> <span class="p">(</span><span class="n">lstdin</span><span class="p">);</span>
<a name="c0-2227"></a><span class="lineno">2227</span> 
<a name="c0-2228"></a><span class="lineno">2228</span>   <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2229"></a><span class="lineno">2229</span>     <span class="n">close</span> <span class="p">(</span><span class="n">prev</span><span class="p">);</span>
<a name="c0-2230"></a><span class="lineno">2230</span> 
<a name="c0-2231"></a><span class="lineno">2231</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2232"></a><span class="lineno">2232</span>   <span class="n">UNBLOCK_CHILD</span> <span class="p">(</span><span class="n">oset</span><span class="p">);</span>
<a name="c0-2233"></a><span class="lineno">2233</span> <span class="cp">#endif</span>
<a name="c0-2234"></a><span class="lineno">2234</span> 
<a name="c0-2235"></a><span class="lineno">2235</span>   <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2236"></a><span class="lineno">2236</span> 
<a name="c0-2237"></a><span class="lineno">2237</span>   <span class="k">if</span> <span class="p">(</span><span class="n">lastpipe_flag</span><span class="p">)</span>
<a name="c0-2238"></a><span class="lineno">2238</span>     <span class="p">{</span>
<a name="c0-2239"></a><span class="lineno">2239</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2240"></a><span class="lineno">2240</span>       <span class="n">append_process</span> <span class="p">(</span><span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">),</span> <span class="n">dollar_dollar_pid</span><span class="p">,</span> <span class="n">exec_result</span><span class="p">,</span> <span class="n">lastpipe_jid</span><span class="p">);</span>
<a name="c0-2241"></a><span class="lineno">2241</span> <span class="cp">#endif</span>
<a name="c0-2242"></a><span class="lineno">2242</span>       <span class="n">lstdin</span> <span class="o">=</span> <span class="n">wait_for</span> <span class="p">(</span><span class="n">lastpid</span><span class="p">);</span>
<a name="c0-2243"></a><span class="lineno">2243</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2244"></a><span class="lineno">2244</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">job_exit_status</span> <span class="p">(</span><span class="n">lastpipe_jid</span><span class="p">);</span>
<a name="c0-2245"></a><span class="lineno">2245</span> <span class="cp">#endif</span>
<a name="c0-2246"></a><span class="lineno">2246</span>       <span class="n">unfreeze_jobs_list</span> <span class="p">();</span>
<a name="c0-2247"></a><span class="lineno">2247</span>     <span class="p">}</span>
<a name="c0-2248"></a><span class="lineno">2248</span> 
<a name="c0-2249"></a><span class="lineno">2249</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"lastpipe-exec"</span><span class="p">);</span>
<a name="c0-2250"></a><span class="lineno">2250</span> 
<a name="c0-2251"></a><span class="lineno">2251</span>   <span class="k">return</span> <span class="p">(</span><span class="n">exec_result</span><span class="p">);</span>
<a name="c0-2252"></a><span class="lineno">2252</span> <span class="p">}</span>
<a name="c0-2253"></a><span class="lineno">2253</span> 
<a name="c0-2254"></a><span class="lineno">2254</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2255"></a><span class="lineno">2255</span> <span class="n">execute_connection</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-2256"></a><span class="lineno">2256</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-2257"></a><span class="lineno">2257</span>      <span class="kt">int</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-2258"></a><span class="lineno">2258</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-2259"></a><span class="lineno">2259</span> <span class="p">{</span>
<a name="c0-2260"></a><span class="lineno">2260</span>   <span class="n">COMMAND</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="o">*</span><span class="n">second</span><span class="p">;</span>
<a name="c0-2261"></a><span class="lineno">2261</span>   <span class="kt">int</span> <span class="n">ignore_return</span><span class="p">,</span> <span class="n">exec_result</span><span class="p">,</span> <span class="n">was_error_trap</span><span class="p">,</span> <span class="n">invert</span><span class="p">;</span>
<a name="c0-2262"></a><span class="lineno">2262</span>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2263"></a><span class="lineno">2263</span> 
<a name="c0-2264"></a><span class="lineno">2264</span>   <span class="n">ignore_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2265"></a><span class="lineno">2265</span> 
<a name="c0-2266"></a><span class="lineno">2266</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">)</span>
<a name="c0-2267"></a><span class="lineno">2267</span>     <span class="p">{</span>
<a name="c0-2268"></a><span class="lineno">2268</span>     <span class="cm">/* Do the first command asynchronously. */</span>
<a name="c0-2269"></a><span class="lineno">2269</span>     <span class="k">case</span> <span class="sc">'&amp;'</span>:
<a name="c0-2270"></a><span class="lineno">2270</span>       <span class="n">tc</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
<a name="c0-2271"></a><span class="lineno">2271</span>       <span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2272"></a><span class="lineno">2272</span>  <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-2273"></a><span class="lineno">2273</span> 
<a name="c0-2274"></a><span class="lineno">2274</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-2275"></a><span class="lineno">2275</span>  <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2276"></a><span class="lineno">2276</span>       <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_AMPERSAND</span><span class="p">;</span>
<a name="c0-2277"></a><span class="lineno">2277</span> 
<a name="c0-2278"></a><span class="lineno">2278</span>       <span class="cm">/* If this shell was compiled without job control support,</span>
<a name="c0-2279"></a><span class="lineno">2279</span> <span class="cm">   if we are currently in a subshell via `( xxx )', or if job</span>
<a name="c0-2280"></a><span class="lineno">2280</span> <span class="cm">   control is not active then the standard input for an</span>
<a name="c0-2281"></a><span class="lineno">2281</span> <span class="cm">   asynchronous command is forced to /dev/null. */</span>
<a name="c0-2282"></a><span class="lineno">2282</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-2283"></a><span class="lineno">2283</span>       <span class="k">if</span> <span class="p">((</span><span class="n">subshell_environment</span> <span class="o">||</span> <span class="o">!</span><span class="n">job_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stdin_redir</span><span class="p">)</span>
<a name="c0-2284"></a><span class="lineno">2284</span> <span class="cp">#else</span>
<a name="c0-2285"></a><span class="lineno">2285</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stdin_redir</span><span class="p">)</span>
<a name="c0-2286"></a><span class="lineno">2286</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-2287"></a><span class="lineno">2287</span>  <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">;</span>
<a name="c0-2288"></a><span class="lineno">2288</span> 
<a name="c0-2289"></a><span class="lineno">2289</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2290"></a><span class="lineno">2290</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2291"></a><span class="lineno">2291</span> 
<a name="c0-2292"></a><span class="lineno">2292</span>       <span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">)</span>
<a name="c0-2293"></a><span class="lineno">2293</span>  <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_STDIN_REDIR</span><span class="p">;</span>
<a name="c0-2294"></a><span class="lineno">2294</span> 
<a name="c0-2295"></a><span class="lineno">2295</span>       <span class="n">second</span> <span class="o">=</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<a name="c0-2296"></a><span class="lineno">2296</span>       <span class="k">if</span> <span class="p">(</span><span class="n">second</span><span class="p">)</span>
<a name="c0-2297"></a><span class="lineno">2297</span>  <span class="p">{</span>
<a name="c0-2298"></a><span class="lineno">2298</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-2299"></a><span class="lineno">2299</span>      <span class="n">second</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2300"></a><span class="lineno">2300</span> 
<a name="c0-2301"></a><span class="lineno">2301</span>    <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2302"></a><span class="lineno">2302</span>  <span class="p">}</span>
<a name="c0-2303"></a><span class="lineno">2303</span> 
<a name="c0-2304"></a><span class="lineno">2304</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-2305"></a><span class="lineno">2305</span> 
<a name="c0-2306"></a><span class="lineno">2306</span>     <span class="cm">/* Just call execute command on both sides. */</span>
<a name="c0-2307"></a><span class="lineno">2307</span>     <span class="k">case</span> <span class="sc">';'</span>:
<a name="c0-2308"></a><span class="lineno">2308</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-2309"></a><span class="lineno">2309</span>  <span class="p">{</span>
<a name="c0-2310"></a><span class="lineno">2310</span>    <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a name="c0-2311"></a><span class="lineno">2311</span>      <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2312"></a><span class="lineno">2312</span>    <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
<a name="c0-2313"></a><span class="lineno">2313</span>      <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2314"></a><span class="lineno">2314</span>  <span class="p">}</span>
<a name="c0-2315"></a><span class="lineno">2315</span>       <span class="n">executing_list</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2316"></a><span class="lineno">2316</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2317"></a><span class="lineno">2317</span>       <span class="n">execute_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a name="c0-2318"></a><span class="lineno">2318</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2319"></a><span class="lineno">2319</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span>
<a name="c0-2320"></a><span class="lineno">2320</span>              <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-2321"></a><span class="lineno">2321</span>              <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2322"></a><span class="lineno">2322</span>       <span class="n">executing_list</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2323"></a><span class="lineno">2323</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-2324"></a><span class="lineno">2324</span> 
<a name="c0-2325"></a><span class="lineno">2325</span>     <span class="k">case</span> <span class="sc">'|'</span>:
<a name="c0-2326"></a><span class="lineno">2326</span>       <span class="n">was_error_trap</span> <span class="o">=</span> <span class="n">signal_is_trapped</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">signal_is_ignored</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2327"></a><span class="lineno">2327</span>       <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2328"></a><span class="lineno">2328</span>       <span class="n">ignore_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2329"></a><span class="lineno">2329</span> 
<a name="c0-2330"></a><span class="lineno">2330</span>       <span class="n">line_number_for_err_trap</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-2331"></a><span class="lineno">2331</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_pipeline</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2332"></a><span class="lineno">2332</span> 
<a name="c0-2333"></a><span class="lineno">2333</span>       <span class="k">if</span> <span class="p">(</span><span class="n">was_error_trap</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-2334"></a><span class="lineno">2334</span>  <span class="p">{</span>
<a name="c0-2335"></a><span class="lineno">2335</span>    <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-2336"></a><span class="lineno">2336</span>    <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-2337"></a><span class="lineno">2337</span>    <span class="n">line_number</span> <span class="o">=</span> <span class="n">line_number_for_err_trap</span><span class="p">;</span>
<a name="c0-2338"></a><span class="lineno">2338</span>    <span class="n">run_error_trap</span> <span class="p">();</span>
<a name="c0-2339"></a><span class="lineno">2339</span>    <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2340"></a><span class="lineno">2340</span>  <span class="p">}</span>
<a name="c0-2341"></a><span class="lineno">2341</span> 
<a name="c0-2342"></a><span class="lineno">2342</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">invert</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exit_immediately_on_error</span> <span class="o">&amp;&amp;</span> <span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-2343"></a><span class="lineno">2343</span>  <span class="p">{</span>
<a name="c0-2344"></a><span class="lineno">2344</span>    <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-2345"></a><span class="lineno">2345</span>    <span class="n">run_pending_traps</span> <span class="p">();</span>
<a name="c0-2346"></a><span class="lineno">2346</span>    <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-2347"></a><span class="lineno">2347</span>  <span class="p">}</span>
<a name="c0-2348"></a><span class="lineno">2348</span> 
<a name="c0-2349"></a><span class="lineno">2349</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-2350"></a><span class="lineno">2350</span> 
<a name="c0-2351"></a><span class="lineno">2351</span>     <span class="k">case</span> <span class="n">AND_AND</span>:
<a name="c0-2352"></a><span class="lineno">2352</span>     <span class="k">case</span> <span class="n">OR_OR</span>:
<a name="c0-2353"></a><span class="lineno">2353</span>       <span class="k">if</span> <span class="p">(</span><span class="n">asynchronous</span><span class="p">)</span>
<a name="c0-2354"></a><span class="lineno">2354</span>  <span class="p">{</span>
<a name="c0-2355"></a><span class="lineno">2355</span>    <span class="cm">/* If we have something like `a &amp;&amp; b &amp;' or `a || b &amp;', run the</span>
<a name="c0-2356"></a><span class="lineno">2356</span> <span class="cm">       &amp;&amp; or || stuff in a subshell.  Force a subshell and just call</span>
<a name="c0-2357"></a><span class="lineno">2357</span> <span class="cm">       execute_command_internal again.  Leave asynchronous on</span>
<a name="c0-2358"></a><span class="lineno">2358</span> <span class="cm">       so that we get a report from the parent shell about the</span>
<a name="c0-2359"></a><span class="lineno">2359</span> <span class="cm">       background job. */</span>
<a name="c0-2360"></a><span class="lineno">2360</span>    <span class="n">command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_FORCE_SUBSHELL</span><span class="p">;</span>
<a name="c0-2361"></a><span class="lineno">2361</span>    <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-2362"></a><span class="lineno">2362</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-2363"></a><span class="lineno">2363</span>  <span class="p">}</span>
<a name="c0-2364"></a><span class="lineno">2364</span> 
<a name="c0-2365"></a><span class="lineno">2365</span>       <span class="cm">/* Execute the first command.  If the result of that is successful</span>
<a name="c0-2366"></a><span class="lineno">2366</span> <span class="cm">   and the connector is AND_AND, or the result is not successful</span>
<a name="c0-2367"></a><span class="lineno">2367</span> <span class="cm">   and the connector is OR_OR, then execute the second command,</span>
<a name="c0-2368"></a><span class="lineno">2368</span> <span class="cm">   otherwise return. */</span>
<a name="c0-2369"></a><span class="lineno">2369</span> 
<a name="c0-2370"></a><span class="lineno">2370</span>       <span class="n">executing_list</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2371"></a><span class="lineno">2371</span>       <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a name="c0-2372"></a><span class="lineno">2372</span>  <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2373"></a><span class="lineno">2373</span> 
<a name="c0-2374"></a><span class="lineno">2374</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
<a name="c0-2375"></a><span class="lineno">2375</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2376"></a><span class="lineno">2376</span>       <span class="k">if</span> <span class="p">(((</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">connector</span> <span class="o">==</span> <span class="n">AND_AND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2377"></a><span class="lineno">2377</span>     <span class="p">(</span><span class="n">exec_result</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">))</span> <span class="o">||</span>
<a name="c0-2378"></a><span class="lineno">2378</span>    <span class="p">((</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">connector</span> <span class="o">==</span> <span class="n">OR_OR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2379"></a><span class="lineno">2379</span>     <span class="p">(</span><span class="n">exec_result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)))</span>
<a name="c0-2380"></a><span class="lineno">2380</span>  <span class="p">{</span>
<a name="c0-2381"></a><span class="lineno">2381</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ignore_return</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
<a name="c0-2382"></a><span class="lineno">2382</span>      <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2383"></a><span class="lineno">2383</span> 
<a name="c0-2384"></a><span class="lineno">2384</span>    <span class="n">exec_result</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
<a name="c0-2385"></a><span class="lineno">2385</span>  <span class="p">}</span>
<a name="c0-2386"></a><span class="lineno">2386</span>       <span class="n">executing_list</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2387"></a><span class="lineno">2387</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-2388"></a><span class="lineno">2388</span> 
<a name="c0-2389"></a><span class="lineno">2389</span>     <span class="nl">default:</span>
<a name="c0-2390"></a><span class="lineno">2390</span>       <span class="n">command_error</span> <span class="p">(</span><span class="s">"execute_connection"</span><span class="p">,</span> <span class="n">CMDERR_BADCONN</span><span class="p">,</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Connection</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2391"></a><span class="lineno">2391</span>       <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">DISCARD</span><span class="p">);</span>
<a name="c0-2392"></a><span class="lineno">2392</span>       <span class="n">exec_result</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2393"></a><span class="lineno">2393</span>     <span class="p">}</span>
<a name="c0-2394"></a><span class="lineno">2394</span> 
<a name="c0-2395"></a><span class="lineno">2395</span>   <span class="k">return</span> <span class="n">exec_result</span><span class="p">;</span>
<a name="c0-2396"></a><span class="lineno">2396</span> <span class="p">}</span>
<a name="c0-2397"></a><span class="lineno">2397</span> 
<a name="c0-2398"></a><span class="lineno">2398</span> <span class="cp">#define REAP() \</span>
<a name="c0-2399"></a><span class="lineno">2399</span> <span class="cp">  do \</span>
<a name="c0-2400"></a><span class="lineno">2400</span> <span class="cp">    { \</span>
<a name="c0-2401"></a><span class="lineno">2401</span> <span class="cp">      if (!interactive_shell) \</span>
<a name="c0-2402"></a><span class="lineno">2402</span> <span class="cp">  reap_dead_jobs (); \</span>
<a name="c0-2403"></a><span class="lineno">2403</span> <span class="cp">    } \</span>
<a name="c0-2404"></a><span class="lineno">2404</span> <span class="cp">  while (0)</span>
<a name="c0-2405"></a><span class="lineno">2405</span> 
<a name="c0-2406"></a><span class="lineno">2406</span> <span class="cm">/* Execute a FOR command.  The syntax is: FOR word_desc IN word_list;</span>
<a name="c0-2407"></a><span class="lineno">2407</span> <span class="cm">   DO command; DONE */</span>
<a name="c0-2408"></a><span class="lineno">2408</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2409"></a><span class="lineno">2409</span> <span class="n">execute_for_command</span> <span class="p">(</span><span class="n">for_command</span><span class="p">)</span>
<a name="c0-2410"></a><span class="lineno">2410</span>      <span class="n">FOR_COM</span> <span class="o">*</span><span class="n">for_command</span><span class="p">;</span>
<a name="c0-2411"></a><span class="lineno">2411</span> <span class="p">{</span>
<a name="c0-2412"></a><span class="lineno">2412</span>   <span class="k">register</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">releaser</span><span class="p">,</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-2413"></a><span class="lineno">2413</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
<a name="c0-2414"></a><span class="lineno">2414</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">identifier</span><span class="p">;</span>
<a name="c0-2415"></a><span class="lineno">2415</span>   <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2416"></a><span class="lineno">2416</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2417"></a><span class="lineno">2417</span> <span class="c">  SHELL_VAR *old_value = (SHELL_VAR *)NULL; /* Remember the old value of x. */</span>
<a name="c0-2418"></a><span class="lineno">2418</span> <span class="cp">#endif</span>
<a name="c0-2419"></a><span class="lineno">2419</span> 
<a name="c0-2420"></a><span class="lineno">2420</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-2421"></a><span class="lineno">2421</span>   <span class="k">if</span> <span class="p">(</span><span class="n">check_identifier</span> <span class="p">(</span><span class="n">for_command</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2422"></a><span class="lineno">2422</span>     <span class="p">{</span>
<a name="c0-2423"></a><span class="lineno">2423</span>       <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2424"></a><span class="lineno">2424</span>  <span class="p">{</span>
<a name="c0-2425"></a><span class="lineno">2425</span>    <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EX_BADUSAGE</span><span class="p">;</span>
<a name="c0-2426"></a><span class="lineno">2426</span>    <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-2427"></a><span class="lineno">2427</span>  <span class="p">}</span>
<a name="c0-2428"></a><span class="lineno">2428</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-2429"></a><span class="lineno">2429</span>     <span class="p">}</span>
<a name="c0-2430"></a><span class="lineno">2430</span> 
<a name="c0-2431"></a><span class="lineno">2431</span>   <span class="n">loop_level</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2432"></a><span class="lineno">2432</span>   <span class="n">identifier</span> <span class="o">=</span> <span class="n">for_command</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">;</span>
<a name="c0-2433"></a><span class="lineno">2433</span> 
<a name="c0-2434"></a><span class="lineno">2434</span>   <span class="n">list</span> <span class="o">=</span> <span class="n">releaser</span> <span class="o">=</span> <span class="n">expand_words_no_vars</span> <span class="p">(</span><span class="n">for_command</span><span class="o">-&gt;</span><span class="n">map_list</span><span class="p">);</span>
<a name="c0-2435"></a><span class="lineno">2435</span> 
<a name="c0-2436"></a><span class="lineno">2436</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"for"</span><span class="p">);</span>
<a name="c0-2437"></a><span class="lineno">2437</span>   <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_words</span><span class="p">,</span> <span class="n">releaser</span><span class="p">);</span>
<a name="c0-2438"></a><span class="lineno">2438</span> 
<a name="c0-2439"></a><span class="lineno">2439</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2440"></a><span class="lineno">2440</span> <span class="c">  if (lexical_scoping)</span>
<a name="c0-2441"></a><span class="lineno">2441</span> <span class="c">    {</span>
<a name="c0-2442"></a><span class="lineno">2442</span> <span class="c">      old_value = copy_variable (find_variable (identifier));</span>
<a name="c0-2443"></a><span class="lineno">2443</span> <span class="c">      if (old_value)</span>
<a name="c0-2444"></a><span class="lineno">2444</span> <span class="c"> add_unwind_protect (dispose_variable, old_value);</span>
<a name="c0-2445"></a><span class="lineno">2445</span> <span class="c">    }</span>
<a name="c0-2446"></a><span class="lineno">2446</span> <span class="cp">#endif</span>
<a name="c0-2447"></a><span class="lineno">2447</span> 
<a name="c0-2448"></a><span class="lineno">2448</span>   <span class="k">if</span> <span class="p">(</span><span class="n">for_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span>
<a name="c0-2449"></a><span class="lineno">2449</span>     <span class="n">for_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2450"></a><span class="lineno">2450</span> 
<a name="c0-2451"></a><span class="lineno">2451</span>   <span class="k">for</span> <span class="p">(</span><span class="n">retval</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span> <span class="n">list</span><span class="p">;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-2452"></a><span class="lineno">2452</span>     <span class="p">{</span>
<a name="c0-2453"></a><span class="lineno">2453</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2454"></a><span class="lineno">2454</span> 
<a name="c0-2455"></a><span class="lineno">2455</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">for_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-2456"></a><span class="lineno">2456</span> 
<a name="c0-2457"></a><span class="lineno">2457</span>       <span class="cm">/* Remember what this command looks like, for debugger. */</span>
<a name="c0-2458"></a><span class="lineno">2458</span>       <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2459"></a><span class="lineno">2459</span>       <span class="n">print_for_command_head</span> <span class="p">(</span><span class="n">for_command</span><span class="p">);</span>
<a name="c0-2460"></a><span class="lineno">2460</span> 
<a name="c0-2461"></a><span class="lineno">2461</span>       <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-2462"></a><span class="lineno">2462</span>  <span class="n">xtrace_print_for_command_head</span> <span class="p">(</span><span class="n">for_command</span><span class="p">);</span>
<a name="c0-2463"></a><span class="lineno">2463</span> 
<a name="c0-2464"></a><span class="lineno">2464</span>       <span class="cm">/* Save this command unless it's a trap command and we're not running</span>
<a name="c0-2465"></a><span class="lineno">2465</span> <span class="cm">   a debug trap. */</span>
<a name="c0-2466"></a><span class="lineno">2466</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2467"></a><span class="lineno">2467</span> <span class="c">      if (signal_in_progress (DEBUG_TRAP) == 0 &amp;&amp; (this_command_name == 0 || (STREQ (this_command_name, "trap") == 0)))</span>
<a name="c0-2468"></a><span class="lineno">2468</span> <span class="cp">#else</span>
<a name="c0-2469"></a><span class="lineno">2469</span>       <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">running_trap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2470"></a><span class="lineno">2470</span> <span class="cp">#endif</span>
<a name="c0-2471"></a><span class="lineno">2471</span>  <span class="p">{</span>
<a name="c0-2472"></a><span class="lineno">2472</span>    <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-2473"></a><span class="lineno">2473</span>    <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">);</span>
<a name="c0-2474"></a><span class="lineno">2474</span>  <span class="p">}</span>
<a name="c0-2475"></a><span class="lineno">2475</span> 
<a name="c0-2476"></a><span class="lineno">2476</span>       <span class="n">retval</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-2477"></a><span class="lineno">2477</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-2478"></a><span class="lineno">2478</span>       <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-2479"></a><span class="lineno">2479</span> <span class="cm">   skip the command. */</span>
<a name="c0-2480"></a><span class="lineno">2480</span>       <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-2481"></a><span class="lineno">2481</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c0-2482"></a><span class="lineno">2482</span> <span class="cp">#endif</span>
<a name="c0-2483"></a><span class="lineno">2483</span> 
<a name="c0-2484"></a><span class="lineno">2484</span>       <span class="n">this_command_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-2485"></a><span class="lineno">2485</span>       <span class="n">v</span> <span class="o">=</span> <span class="n">bind_variable</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2486"></a><span class="lineno">2486</span>       <span class="k">if</span> <span class="p">(</span><span class="n">readonly_p</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">||</span> <span class="n">noassign_p</span> <span class="p">(</span><span class="n">v</span><span class="p">))</span>
<a name="c0-2487"></a><span class="lineno">2487</span>  <span class="p">{</span>
<a name="c0-2488"></a><span class="lineno">2488</span>    <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2489"></a><span class="lineno">2489</span>    <span class="k">if</span> <span class="p">(</span><span class="n">readonly_p</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">posixly_correct</span><span class="p">)</span>
<a name="c0-2490"></a><span class="lineno">2490</span>      <span class="p">{</span>
<a name="c0-2491"></a><span class="lineno">2491</span>        <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2492"></a><span class="lineno">2492</span>        <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">FORCE_EOF</span><span class="p">);</span>
<a name="c0-2493"></a><span class="lineno">2493</span>      <span class="p">}</span>
<a name="c0-2494"></a><span class="lineno">2494</span>    <span class="k">else</span>
<a name="c0-2495"></a><span class="lineno">2495</span>      <span class="p">{</span>
<a name="c0-2496"></a><span class="lineno">2496</span>        <span class="n">dispose_words</span> <span class="p">(</span><span class="n">releaser</span><span class="p">);</span>
<a name="c0-2497"></a><span class="lineno">2497</span>        <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"for"</span><span class="p">);</span>
<a name="c0-2498"></a><span class="lineno">2498</span>        <span class="n">loop_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2499"></a><span class="lineno">2499</span>        <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-2500"></a><span class="lineno">2500</span>      <span class="p">}</span>
<a name="c0-2501"></a><span class="lineno">2501</span>  <span class="p">}</span>
<a name="c0-2502"></a><span class="lineno">2502</span>       <span class="n">retval</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">for_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
<a name="c0-2503"></a><span class="lineno">2503</span>       <span class="n">REAP</span> <span class="p">();</span>
<a name="c0-2504"></a><span class="lineno">2504</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2505"></a><span class="lineno">2505</span> 
<a name="c0-2506"></a><span class="lineno">2506</span>       <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span><span class="p">)</span>
<a name="c0-2507"></a><span class="lineno">2507</span>  <span class="p">{</span>
<a name="c0-2508"></a><span class="lineno">2508</span>    <span class="n">breaking</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2509"></a><span class="lineno">2509</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-2510"></a><span class="lineno">2510</span>  <span class="p">}</span>
<a name="c0-2511"></a><span class="lineno">2511</span> 
<a name="c0-2512"></a><span class="lineno">2512</span>       <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-2513"></a><span class="lineno">2513</span>  <span class="p">{</span>
<a name="c0-2514"></a><span class="lineno">2514</span>    <span class="n">continuing</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2515"></a><span class="lineno">2515</span>    <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-2516"></a><span class="lineno">2516</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2517"></a><span class="lineno">2517</span>  <span class="p">}</span>
<a name="c0-2518"></a><span class="lineno">2518</span>     <span class="p">}</span>
<a name="c0-2519"></a><span class="lineno">2519</span> 
<a name="c0-2520"></a><span class="lineno">2520</span>   <span class="n">loop_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2521"></a><span class="lineno">2521</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2522"></a><span class="lineno">2522</span> 
<a name="c0-2523"></a><span class="lineno">2523</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2524"></a><span class="lineno">2524</span> <span class="c">  if (lexical_scoping)</span>
<a name="c0-2525"></a><span class="lineno">2525</span> <span class="c">    {</span>
<a name="c0-2526"></a><span class="lineno">2526</span> <span class="c">      if (!old_value)</span>
<a name="c0-2527"></a><span class="lineno">2527</span> <span class="c">        unbind_variable (identifier);</span>
<a name="c0-2528"></a><span class="lineno">2528</span> <span class="c">      else</span>
<a name="c0-2529"></a><span class="lineno">2529</span> <span class="c"> {</span>
<a name="c0-2530"></a><span class="lineno">2530</span> <span class="c">   SHELL_VAR *new_value;</span>
<a name="c0-2531"></a><span class="lineno">2531</span> 
<a name="c0-2532"></a><span class="lineno">2532</span> <span class="c">   new_value = bind_variable (identifier, value_cell(old_value), 0);</span>
<a name="c0-2533"></a><span class="lineno">2533</span> <span class="c">   new_value-&gt;attributes = old_value-&gt;attributes;</span>
<a name="c0-2534"></a><span class="lineno">2534</span> <span class="c">   dispose_variable (old_value);</span>
<a name="c0-2535"></a><span class="lineno">2535</span> <span class="c"> }</span>
<a name="c0-2536"></a><span class="lineno">2536</span> <span class="c">    }</span>
<a name="c0-2537"></a><span class="lineno">2537</span> <span class="cp">#endif</span>
<a name="c0-2538"></a><span class="lineno">2538</span> 
<a name="c0-2539"></a><span class="lineno">2539</span>   <span class="n">dispose_words</span> <span class="p">(</span><span class="n">releaser</span><span class="p">);</span>
<a name="c0-2540"></a><span class="lineno">2540</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"for"</span><span class="p">);</span>
<a name="c0-2541"></a><span class="lineno">2541</span>   <span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a name="c0-2542"></a><span class="lineno">2542</span> <span class="p">}</span>
<a name="c0-2543"></a><span class="lineno">2543</span> 
<a name="c0-2544"></a><span class="lineno">2544</span> <span class="cp">#if defined (ARITH_FOR_COMMAND)</span>
<a name="c0-2545"></a><span class="lineno">2545</span> <span class="cm">/* Execute an arithmetic for command.  The syntax is</span>
<a name="c0-2546"></a><span class="lineno">2546</span> 
<a name="c0-2547"></a><span class="lineno">2547</span> <span class="cm">  for (( init ; step ; test ))</span>
<a name="c0-2548"></a><span class="lineno">2548</span> <span class="cm">  do</span>
<a name="c0-2549"></a><span class="lineno">2549</span> <span class="cm">    body</span>
<a name="c0-2550"></a><span class="lineno">2550</span> <span class="cm">  done</span>
<a name="c0-2551"></a><span class="lineno">2551</span> 
<a name="c0-2552"></a><span class="lineno">2552</span> <span class="cm">   The execution should be exactly equivalent to</span>
<a name="c0-2553"></a><span class="lineno">2553</span> 
<a name="c0-2554"></a><span class="lineno">2554</span> <span class="cm">  eval \(\( init \)\)</span>
<a name="c0-2555"></a><span class="lineno">2555</span> <span class="cm">  while eval \(\( test \)\) ; do</span>
<a name="c0-2556"></a><span class="lineno">2556</span> <span class="cm">    body;</span>
<a name="c0-2557"></a><span class="lineno">2557</span> <span class="cm">    eval \(\( step \)\)</span>
<a name="c0-2558"></a><span class="lineno">2558</span> <span class="cm">  done</span>
<a name="c0-2559"></a><span class="lineno">2559</span> <span class="cm">*/</span>
<a name="c0-2560"></a><span class="lineno">2560</span> <span class="k">static</span> <span class="kt">intmax_t</span>
<a name="c0-2561"></a><span class="lineno">2561</span> <span class="n">eval_arith_for_expr</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">okp</span><span class="p">)</span>
<a name="c0-2562"></a><span class="lineno">2562</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
<a name="c0-2563"></a><span class="lineno">2563</span>      <span class="kt">int</span> <span class="o">*</span><span class="n">okp</span><span class="p">;</span>
<a name="c0-2564"></a><span class="lineno">2564</span> <span class="p">{</span>
<a name="c0-2565"></a><span class="lineno">2565</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
<a name="c0-2566"></a><span class="lineno">2566</span>   <span class="kt">intmax_t</span> <span class="n">expresult</span><span class="p">;</span>
<a name="c0-2567"></a><span class="lineno">2567</span>   <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
<a name="c0-2568"></a><span class="lineno">2568</span> 
<a name="c0-2569"></a><span class="lineno">2569</span>   <span class="n">new</span> <span class="o">=</span> <span class="n">expand_words_no_vars</span> <span class="p">(</span><span class="n">l</span><span class="p">);</span>
<a name="c0-2570"></a><span class="lineno">2570</span>   <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
<a name="c0-2571"></a><span class="lineno">2571</span>     <span class="p">{</span>
<a name="c0-2572"></a><span class="lineno">2572</span>       <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-2573"></a><span class="lineno">2573</span>  <span class="n">xtrace_print_arith_cmd</span> <span class="p">(</span><span class="n">new</span><span class="p">);</span>
<a name="c0-2574"></a><span class="lineno">2574</span>       <span class="n">this_command_name</span> <span class="o">=</span> <span class="s">"(("</span><span class="p">;</span>    <span class="cm">/* )) for expression error messages */</span>
<a name="c0-2575"></a><span class="lineno">2575</span> 
<a name="c0-2576"></a><span class="lineno">2576</span>       <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2577"></a><span class="lineno">2577</span>       <span class="n">print_arith_command</span> <span class="p">(</span><span class="n">new</span><span class="p">);</span>
<a name="c0-2578"></a><span class="lineno">2578</span>       <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2579"></a><span class="lineno">2579</span>  <span class="p">{</span>
<a name="c0-2580"></a><span class="lineno">2580</span>    <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-2581"></a><span class="lineno">2581</span>    <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">);</span>
<a name="c0-2582"></a><span class="lineno">2582</span>  <span class="p">}</span>
<a name="c0-2583"></a><span class="lineno">2583</span> 
<a name="c0-2584"></a><span class="lineno">2584</span>       <span class="n">r</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-2585"></a><span class="lineno">2585</span>       <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-2586"></a><span class="lineno">2586</span> <span class="cm">   skip the command. */</span>
<a name="c0-2587"></a><span class="lineno">2587</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-2588"></a><span class="lineno">2588</span>       <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-2589"></a><span class="lineno">2589</span>  <span class="n">expresult</span> <span class="o">=</span> <span class="n">evalexp</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">okp</span><span class="p">);</span>
<a name="c0-2590"></a><span class="lineno">2590</span>       <span class="k">else</span>
<a name="c0-2591"></a><span class="lineno">2591</span>  <span class="p">{</span>
<a name="c0-2592"></a><span class="lineno">2592</span>    <span class="n">expresult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2593"></a><span class="lineno">2593</span>    <span class="k">if</span> <span class="p">(</span><span class="n">okp</span><span class="p">)</span>
<a name="c0-2594"></a><span class="lineno">2594</span>      <span class="o">*</span><span class="n">okp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2595"></a><span class="lineno">2595</span>  <span class="p">}</span>
<a name="c0-2596"></a><span class="lineno">2596</span> <span class="cp">#else</span>
<a name="c0-2597"></a><span class="lineno">2597</span>       <span class="n">expresult</span> <span class="o">=</span> <span class="n">evalexp</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">okp</span><span class="p">);</span>
<a name="c0-2598"></a><span class="lineno">2598</span> <span class="cp">#endif</span>
<a name="c0-2599"></a><span class="lineno">2599</span>       <span class="n">dispose_words</span> <span class="p">(</span><span class="n">new</span><span class="p">);</span>
<a name="c0-2600"></a><span class="lineno">2600</span>     <span class="p">}</span>
<a name="c0-2601"></a><span class="lineno">2601</span>   <span class="k">else</span>
<a name="c0-2602"></a><span class="lineno">2602</span>     <span class="p">{</span>
<a name="c0-2603"></a><span class="lineno">2603</span>       <span class="n">expresult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2604"></a><span class="lineno">2604</span>       <span class="k">if</span> <span class="p">(</span><span class="n">okp</span><span class="p">)</span>
<a name="c0-2605"></a><span class="lineno">2605</span>  <span class="o">*</span><span class="n">okp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2606"></a><span class="lineno">2606</span>     <span class="p">}</span>
<a name="c0-2607"></a><span class="lineno">2607</span>   <span class="k">return</span> <span class="p">(</span><span class="n">expresult</span><span class="p">);</span>
<a name="c0-2608"></a><span class="lineno">2608</span> <span class="p">}</span>
<a name="c0-2609"></a><span class="lineno">2609</span> 
<a name="c0-2610"></a><span class="lineno">2610</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2611"></a><span class="lineno">2611</span> <span class="n">execute_arith_for_command</span> <span class="p">(</span><span class="n">arith_for_command</span><span class="p">)</span>
<a name="c0-2612"></a><span class="lineno">2612</span>      <span class="n">ARITH_FOR_COM</span> <span class="o">*</span><span class="n">arith_for_command</span><span class="p">;</span>
<a name="c0-2613"></a><span class="lineno">2613</span> <span class="p">{</span>
<a name="c0-2614"></a><span class="lineno">2614</span>   <span class="kt">intmax_t</span> <span class="n">expresult</span><span class="p">;</span>
<a name="c0-2615"></a><span class="lineno">2615</span>   <span class="kt">int</span> <span class="n">expok</span><span class="p">,</span> <span class="n">body_status</span><span class="p">,</span> <span class="n">arith_lineno</span><span class="p">,</span> <span class="n">save_lineno</span><span class="p">;</span>
<a name="c0-2616"></a><span class="lineno">2616</span> 
<a name="c0-2617"></a><span class="lineno">2617</span>   <span class="n">body_status</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-2618"></a><span class="lineno">2618</span>   <span class="n">loop_level</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2619"></a><span class="lineno">2619</span>   <span class="n">save_lineno</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-2620"></a><span class="lineno">2620</span> 
<a name="c0-2621"></a><span class="lineno">2621</span>   <span class="k">if</span> <span class="p">(</span><span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span>
<a name="c0-2622"></a><span class="lineno">2622</span>     <span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2623"></a><span class="lineno">2623</span> 
<a name="c0-2624"></a><span class="lineno">2624</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="s">"(("</span><span class="p">;</span>  <span class="cm">/* )) for expression error messages */</span>
<a name="c0-2625"></a><span class="lineno">2625</span> 
<a name="c0-2626"></a><span class="lineno">2626</span>   <span class="cm">/* save the starting line number of the command so we can reset</span>
<a name="c0-2627"></a><span class="lineno">2627</span> <span class="cm">     line_number before executing each expression -- for $LINENO</span>
<a name="c0-2628"></a><span class="lineno">2628</span> <span class="cm">     and the DEBUG trap. */</span>
<a name="c0-2629"></a><span class="lineno">2629</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">arith_lineno</span> <span class="o">=</span> <span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-2630"></a><span class="lineno">2630</span>   <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span><span class="p">)</span>
<a name="c0-2631"></a><span class="lineno">2631</span>     <span class="n">line_number</span> <span class="o">-=</span> <span class="n">function_line_number</span><span class="p">;</span>
<a name="c0-2632"></a><span class="lineno">2632</span> 
<a name="c0-2633"></a><span class="lineno">2633</span>   <span class="cm">/* Evaluate the initialization expression. */</span>
<a name="c0-2634"></a><span class="lineno">2634</span>   <span class="n">expresult</span> <span class="o">=</span> <span class="n">eval_arith_for_expr</span> <span class="p">(</span><span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expok</span><span class="p">);</span>
<a name="c0-2635"></a><span class="lineno">2635</span>   <span class="k">if</span> <span class="p">(</span><span class="n">expok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2636"></a><span class="lineno">2636</span>     <span class="p">{</span>
<a name="c0-2637"></a><span class="lineno">2637</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_lineno</span><span class="p">;</span>
<a name="c0-2638"></a><span class="lineno">2638</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-2639"></a><span class="lineno">2639</span>     <span class="p">}</span>
<a name="c0-2640"></a><span class="lineno">2640</span> 
<a name="c0-2641"></a><span class="lineno">2641</span>   <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-2642"></a><span class="lineno">2642</span>     <span class="p">{</span>
<a name="c0-2643"></a><span class="lineno">2643</span>       <span class="cm">/* Evaluate the test expression. */</span>
<a name="c0-2644"></a><span class="lineno">2644</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">arith_lineno</span><span class="p">;</span>
<a name="c0-2645"></a><span class="lineno">2645</span>       <span class="n">expresult</span> <span class="o">=</span> <span class="n">eval_arith_for_expr</span> <span class="p">(</span><span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expok</span><span class="p">);</span>
<a name="c0-2646"></a><span class="lineno">2646</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_lineno</span><span class="p">;</span>
<a name="c0-2647"></a><span class="lineno">2647</span> 
<a name="c0-2648"></a><span class="lineno">2648</span>       <span class="k">if</span> <span class="p">(</span><span class="n">expok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2649"></a><span class="lineno">2649</span>  <span class="p">{</span>
<a name="c0-2650"></a><span class="lineno">2650</span>    <span class="n">body_status</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2651"></a><span class="lineno">2651</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-2652"></a><span class="lineno">2652</span>  <span class="p">}</span>
<a name="c0-2653"></a><span class="lineno">2653</span>       <span class="n">REAP</span> <span class="p">();</span>
<a name="c0-2654"></a><span class="lineno">2654</span>       <span class="k">if</span> <span class="p">(</span><span class="n">expresult</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2655"></a><span class="lineno">2655</span>  <span class="k">break</span><span class="p">;</span>
<a name="c0-2656"></a><span class="lineno">2656</span> 
<a name="c0-2657"></a><span class="lineno">2657</span>       <span class="cm">/* Execute the body of the arithmetic for command. */</span>
<a name="c0-2658"></a><span class="lineno">2658</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2659"></a><span class="lineno">2659</span>       <span class="n">body_status</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
<a name="c0-2660"></a><span class="lineno">2660</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2661"></a><span class="lineno">2661</span> 
<a name="c0-2662"></a><span class="lineno">2662</span>       <span class="cm">/* Handle any `break' or `continue' commands executed by the body. */</span>
<a name="c0-2663"></a><span class="lineno">2663</span>       <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span><span class="p">)</span>
<a name="c0-2664"></a><span class="lineno">2664</span>  <span class="p">{</span>
<a name="c0-2665"></a><span class="lineno">2665</span>    <span class="n">breaking</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2666"></a><span class="lineno">2666</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-2667"></a><span class="lineno">2667</span>  <span class="p">}</span>
<a name="c0-2668"></a><span class="lineno">2668</span> 
<a name="c0-2669"></a><span class="lineno">2669</span>       <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-2670"></a><span class="lineno">2670</span>  <span class="p">{</span>
<a name="c0-2671"></a><span class="lineno">2671</span>    <span class="n">continuing</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2672"></a><span class="lineno">2672</span>    <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-2673"></a><span class="lineno">2673</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2674"></a><span class="lineno">2674</span>  <span class="p">}</span>
<a name="c0-2675"></a><span class="lineno">2675</span> 
<a name="c0-2676"></a><span class="lineno">2676</span>       <span class="cm">/* Evaluate the step expression. */</span>
<a name="c0-2677"></a><span class="lineno">2677</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">arith_lineno</span><span class="p">;</span>
<a name="c0-2678"></a><span class="lineno">2678</span>       <span class="n">expresult</span> <span class="o">=</span> <span class="n">eval_arith_for_expr</span> <span class="p">(</span><span class="n">arith_for_command</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expok</span><span class="p">);</span>
<a name="c0-2679"></a><span class="lineno">2679</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_lineno</span><span class="p">;</span>
<a name="c0-2680"></a><span class="lineno">2680</span> 
<a name="c0-2681"></a><span class="lineno">2681</span>       <span class="k">if</span> <span class="p">(</span><span class="n">expok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2682"></a><span class="lineno">2682</span>  <span class="p">{</span>
<a name="c0-2683"></a><span class="lineno">2683</span>    <span class="n">body_status</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2684"></a><span class="lineno">2684</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-2685"></a><span class="lineno">2685</span>  <span class="p">}</span>
<a name="c0-2686"></a><span class="lineno">2686</span>     <span class="p">}</span>
<a name="c0-2687"></a><span class="lineno">2687</span> 
<a name="c0-2688"></a><span class="lineno">2688</span>   <span class="n">loop_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2689"></a><span class="lineno">2689</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_lineno</span><span class="p">;</span>
<a name="c0-2690"></a><span class="lineno">2690</span> 
<a name="c0-2691"></a><span class="lineno">2691</span>   <span class="k">return</span> <span class="p">(</span><span class="n">body_status</span><span class="p">);</span>
<a name="c0-2692"></a><span class="lineno">2692</span> <span class="p">}</span>
<a name="c0-2693"></a><span class="lineno">2693</span> <span class="cp">#endif</span>
<a name="c0-2694"></a><span class="lineno">2694</span> 
<a name="c0-2695"></a><span class="lineno">2695</span> <span class="cp">#if defined (SELECT_COMMAND)</span>
<a name="c0-2696"></a><span class="lineno">2696</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">LINES</span><span class="p">,</span> <span class="n">COLS</span><span class="p">,</span> <span class="n">tabsize</span><span class="p">;</span>
<a name="c0-2697"></a><span class="lineno">2697</span> 
<a name="c0-2698"></a><span class="lineno">2698</span> <span class="cp">#define RP_SPACE ") "</span>
<a name="c0-2699"></a><span class="lineno">2699</span> <span class="cp">#define RP_SPACE_LEN 2</span>
<a name="c0-2700"></a><span class="lineno">2700</span> 
<a name="c0-2701"></a><span class="lineno">2701</span> <span class="cm">/* XXX - does not handle numbers &gt; 1000000 at all. */</span>
<a name="c0-2702"></a><span class="lineno">2702</span> <span class="cp">#define NUMBER_LEN(s) \</span>
<a name="c0-2703"></a><span class="lineno">2703</span> <span class="cp">((s &lt; 10) ? 1 \</span>
<a name="c0-2704"></a><span class="lineno">2704</span> <span class="cp">    : ((s &lt; 100) ? 2 \</span>
<a name="c0-2705"></a><span class="lineno">2705</span> <span class="cp">          : ((s &lt; 1000) ? 3 \</span>
<a name="c0-2706"></a><span class="lineno">2706</span> <span class="cp">           : ((s &lt; 10000) ? 4 \</span>
<a name="c0-2707"></a><span class="lineno">2707</span> <span class="cp">             : ((s &lt; 100000) ? 5 \</span>
<a name="c0-2708"></a><span class="lineno">2708</span> <span class="cp">                : 6)))))</span>
<a name="c0-2709"></a><span class="lineno">2709</span> 
<a name="c0-2710"></a><span class="lineno">2710</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2711"></a><span class="lineno">2711</span> <span class="n">displen</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a name="c0-2712"></a><span class="lineno">2712</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<a name="c0-2713"></a><span class="lineno">2713</span> <span class="p">{</span>
<a name="c0-2714"></a><span class="lineno">2714</span> <span class="cp">#if defined (HANDLE_MULTIBYTE)</span>
<a name="c0-2715"></a><span class="lineno">2715</span>   <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">wcstr</span><span class="p">;</span>
<a name="c0-2716"></a><span class="lineno">2716</span>   <span class="kt">size_t</span> <span class="n">wclen</span><span class="p">,</span> <span class="n">slen</span><span class="p">;</span>
<a name="c0-2717"></a><span class="lineno">2717</span> 
<a name="c0-2718"></a><span class="lineno">2718</span>   <span class="n">wcstr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2719"></a><span class="lineno">2719</span>   <span class="n">slen</span> <span class="o">=</span> <span class="n">mbstowcs</span> <span class="p">(</span><span class="n">wcstr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2720"></a><span class="lineno">2720</span>   <span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-2721"></a><span class="lineno">2721</span>     <span class="n">slen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2722"></a><span class="lineno">2722</span>   <span class="n">wcstr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">slen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<a name="c0-2723"></a><span class="lineno">2723</span>   <span class="n">mbstowcs</span> <span class="p">(</span><span class="n">wcstr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">slen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-2724"></a><span class="lineno">2724</span>   <span class="n">wclen</span> <span class="o">=</span> <span class="n">wcswidth</span> <span class="p">(</span><span class="n">wcstr</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>
<a name="c0-2725"></a><span class="lineno">2725</span>   <span class="n">free</span> <span class="p">(</span><span class="n">wcstr</span><span class="p">);</span>
<a name="c0-2726"></a><span class="lineno">2726</span>   <span class="k">return</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">wclen</span><span class="p">);</span>
<a name="c0-2727"></a><span class="lineno">2727</span> <span class="cp">#else</span>
<a name="c0-2728"></a><span class="lineno">2728</span>   <span class="k">return</span> <span class="p">(</span><span class="n">STRLEN</span> <span class="p">(</span><span class="n">s</span><span class="p">));</span>
<a name="c0-2729"></a><span class="lineno">2729</span> <span class="cp">#endif</span>
<a name="c0-2730"></a><span class="lineno">2730</span> <span class="p">}</span>
<a name="c0-2731"></a><span class="lineno">2731</span> 
<a name="c0-2732"></a><span class="lineno">2732</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2733"></a><span class="lineno">2733</span> <span class="n">print_index_and_element</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
<a name="c0-2734"></a><span class="lineno">2734</span>       <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ind</span><span class="p">;</span>
<a name="c0-2735"></a><span class="lineno">2735</span>       <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-2736"></a><span class="lineno">2736</span> <span class="p">{</span>
<a name="c0-2737"></a><span class="lineno">2737</span>   <span class="k">register</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
<a name="c0-2738"></a><span class="lineno">2738</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-2739"></a><span class="lineno">2739</span> 
<a name="c0-2740"></a><span class="lineno">2740</span>   <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2741"></a><span class="lineno">2741</span>     <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-2742"></a><span class="lineno">2742</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ind</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-2743"></a><span class="lineno">2743</span>     <span class="p">;</span>
<a name="c0-2744"></a><span class="lineno">2744</span>   <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%*d%s%s"</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">RP_SPACE</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c0-2745"></a><span class="lineno">2745</span>   <span class="k">return</span> <span class="p">(</span><span class="n">displen</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">));</span>
<a name="c0-2746"></a><span class="lineno">2746</span> <span class="p">}</span>
<a name="c0-2747"></a><span class="lineno">2747</span> 
<a name="c0-2748"></a><span class="lineno">2748</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-2749"></a><span class="lineno">2749</span> <span class="n">indent</span> <span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
<a name="c0-2750"></a><span class="lineno">2750</span>      <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
<a name="c0-2751"></a><span class="lineno">2751</span> <span class="p">{</span>
<a name="c0-2752"></a><span class="lineno">2752</span>   <span class="k">while</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">)</span>
<a name="c0-2753"></a><span class="lineno">2753</span>     <span class="p">{</span>
<a name="c0-2754"></a><span class="lineno">2754</span>       <span class="k">if</span> <span class="p">((</span><span class="n">to</span> <span class="o">/</span> <span class="n">tabsize</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">from</span> <span class="o">/</span> <span class="n">tabsize</span><span class="p">))</span>
<a name="c0-2755"></a><span class="lineno">2755</span>  <span class="p">{</span>
<a name="c0-2756"></a><span class="lineno">2756</span>    <span class="n">putc</span> <span class="p">(</span><span class="sc">'\t'</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
<a name="c0-2757"></a><span class="lineno">2757</span>    <span class="n">from</span> <span class="o">+=</span> <span class="n">tabsize</span> <span class="o">-</span> <span class="n">from</span> <span class="o">%</span> <span class="n">tabsize</span><span class="p">;</span>
<a name="c0-2758"></a><span class="lineno">2758</span>  <span class="p">}</span>
<a name="c0-2759"></a><span class="lineno">2759</span>       <span class="k">else</span>
<a name="c0-2760"></a><span class="lineno">2760</span>  <span class="p">{</span>
<a name="c0-2761"></a><span class="lineno">2761</span>    <span class="n">putc</span> <span class="p">(</span><span class="sc">' '</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
<a name="c0-2762"></a><span class="lineno">2762</span>    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2763"></a><span class="lineno">2763</span>  <span class="p">}</span>
<a name="c0-2764"></a><span class="lineno">2764</span>     <span class="p">}</span>
<a name="c0-2765"></a><span class="lineno">2765</span> <span class="p">}</span>
<a name="c0-2766"></a><span class="lineno">2766</span> 
<a name="c0-2767"></a><span class="lineno">2767</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-2768"></a><span class="lineno">2768</span> <span class="n">print_select_list</span> <span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">max_elem_len</span><span class="p">,</span> <span class="n">indices_len</span><span class="p">)</span>
<a name="c0-2769"></a><span class="lineno">2769</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-2770"></a><span class="lineno">2770</span>      <span class="kt">int</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">max_elem_len</span><span class="p">,</span> <span class="n">indices_len</span><span class="p">;</span>
<a name="c0-2771"></a><span class="lineno">2771</span> <span class="p">{</span>
<a name="c0-2772"></a><span class="lineno">2772</span>   <span class="kt">int</span> <span class="n">ind</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">elem_len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">;</span>
<a name="c0-2773"></a><span class="lineno">2773</span>   <span class="kt">int</span> <span class="n">first_column_indices_len</span><span class="p">,</span> <span class="n">other_indices_len</span><span class="p">;</span>
<a name="c0-2774"></a><span class="lineno">2774</span> 
<a name="c0-2775"></a><span class="lineno">2775</span>   <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2776"></a><span class="lineno">2776</span>     <span class="p">{</span>
<a name="c0-2777"></a><span class="lineno">2777</span>       <span class="n">putc</span> <span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
<a name="c0-2778"></a><span class="lineno">2778</span>       <span class="k">return</span><span class="p">;</span>
<a name="c0-2779"></a><span class="lineno">2779</span>     <span class="p">}</span>
<a name="c0-2780"></a><span class="lineno">2780</span> 
<a name="c0-2781"></a><span class="lineno">2781</span>   <span class="n">cols</span> <span class="o">=</span> <span class="n">max_elem_len</span> <span class="o">?</span> <span class="n">COLS</span> <span class="o">/</span> <span class="n">max_elem_len</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2782"></a><span class="lineno">2782</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2783"></a><span class="lineno">2783</span>     <span class="n">cols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2784"></a><span class="lineno">2784</span>   <span class="n">rows</span> <span class="o">=</span> <span class="n">list_len</span> <span class="o">?</span> <span class="n">list_len</span> <span class="o">/</span> <span class="n">cols</span> <span class="o">+</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">%</span> <span class="n">cols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2785"></a><span class="lineno">2785</span>   <span class="n">cols</span> <span class="o">=</span> <span class="n">list_len</span> <span class="o">?</span> <span class="n">list_len</span> <span class="o">/</span> <span class="n">rows</span> <span class="o">+</span> <span class="p">(</span><span class="n">list_len</span> <span class="o">%</span> <span class="n">rows</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2786"></a><span class="lineno">2786</span> 
<a name="c0-2787"></a><span class="lineno">2787</span>   <span class="k">if</span> <span class="p">(</span><span class="n">rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-2788"></a><span class="lineno">2788</span>     <span class="p">{</span>
<a name="c0-2789"></a><span class="lineno">2789</span>       <span class="n">rows</span> <span class="o">=</span> <span class="n">cols</span><span class="p">;</span>
<a name="c0-2790"></a><span class="lineno">2790</span>       <span class="n">cols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2791"></a><span class="lineno">2791</span>     <span class="p">}</span>
<a name="c0-2792"></a><span class="lineno">2792</span> 
<a name="c0-2793"></a><span class="lineno">2793</span>   <span class="n">first_column_indices_len</span> <span class="o">=</span> <span class="n">NUMBER_LEN</span> <span class="p">(</span><span class="n">rows</span><span class="p">);</span>
<a name="c0-2794"></a><span class="lineno">2794</span>   <span class="n">other_indices_len</span> <span class="o">=</span> <span class="n">indices_len</span><span class="p">;</span>
<a name="c0-2795"></a><span class="lineno">2795</span> 
<a name="c0-2796"></a><span class="lineno">2796</span>   <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2797"></a><span class="lineno">2797</span>     <span class="p">{</span>
<a name="c0-2798"></a><span class="lineno">2798</span>       <span class="n">ind</span> <span class="o">=</span> <span class="n">row</span><span class="p">;</span>
<a name="c0-2799"></a><span class="lineno">2799</span>       <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2800"></a><span class="lineno">2800</span>       <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-2801"></a><span class="lineno">2801</span>  <span class="p">{</span>
<a name="c0-2802"></a><span class="lineno">2802</span>    <span class="n">indices_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">first_column_indices_len</span> <span class="o">:</span> <span class="n">other_indices_len</span><span class="p">;</span>
<a name="c0-2803"></a><span class="lineno">2803</span>    <span class="n">elem_len</span> <span class="o">=</span> <span class="n">print_index_and_element</span> <span class="p">(</span><span class="n">indices_len</span><span class="p">,</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<a name="c0-2804"></a><span class="lineno">2804</span>    <span class="n">elem_len</span> <span class="o">+=</span> <span class="n">indices_len</span> <span class="o">+</span> <span class="n">RP_SPACE_LEN</span><span class="p">;</span>
<a name="c0-2805"></a><span class="lineno">2805</span>    <span class="n">ind</span> <span class="o">+=</span> <span class="n">rows</span><span class="p">;</span>
<a name="c0-2806"></a><span class="lineno">2806</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="n">list_len</span><span class="p">)</span>
<a name="c0-2807"></a><span class="lineno">2807</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2808"></a><span class="lineno">2808</span>    <span class="n">indent</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">elem_len</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">max_elem_len</span><span class="p">);</span>
<a name="c0-2809"></a><span class="lineno">2809</span>    <span class="n">pos</span> <span class="o">+=</span> <span class="n">max_elem_len</span><span class="p">;</span>
<a name="c0-2810"></a><span class="lineno">2810</span>  <span class="p">}</span>
<a name="c0-2811"></a><span class="lineno">2811</span>       <span class="n">putc</span> <span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">stderr</span><span class="p">);</span>
<a name="c0-2812"></a><span class="lineno">2812</span>     <span class="p">}</span>
<a name="c0-2813"></a><span class="lineno">2813</span> <span class="p">}</span>
<a name="c0-2814"></a><span class="lineno">2814</span> 
<a name="c0-2815"></a><span class="lineno">2815</span> <span class="cm">/* Print the elements of LIST, one per line, preceded by an index from 1 to</span>
<a name="c0-2816"></a><span class="lineno">2816</span> <span class="cm">   LIST_LEN.  Then display PROMPT and wait for the user to enter a number.</span>
<a name="c0-2817"></a><span class="lineno">2817</span> <span class="cm">   If the number is between 1 and LIST_LEN, return that selection.  If EOF</span>
<a name="c0-2818"></a><span class="lineno">2818</span> <span class="cm">   is read, return a null string.  If a blank line is entered, or an invalid</span>
<a name="c0-2819"></a><span class="lineno">2819</span> <span class="cm">   number is entered, the loop is executed again. */</span>
<a name="c0-2820"></a><span class="lineno">2820</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<a name="c0-2821"></a><span class="lineno">2821</span> <span class="n">select_query</span> <span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">print_menu</span><span class="p">)</span>
<a name="c0-2822"></a><span class="lineno">2822</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-2823"></a><span class="lineno">2823</span>      <span class="kt">int</span> <span class="n">list_len</span><span class="p">;</span>
<a name="c0-2824"></a><span class="lineno">2824</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">;</span>
<a name="c0-2825"></a><span class="lineno">2825</span>      <span class="kt">int</span> <span class="n">print_menu</span><span class="p">;</span>
<a name="c0-2826"></a><span class="lineno">2826</span> <span class="p">{</span>
<a name="c0-2827"></a><span class="lineno">2827</span>   <span class="kt">int</span> <span class="n">max_elem_len</span><span class="p">,</span> <span class="n">indices_len</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2828"></a><span class="lineno">2828</span>   <span class="kt">intmax_t</span> <span class="n">reply</span><span class="p">;</span>
<a name="c0-2829"></a><span class="lineno">2829</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
<a name="c0-2830"></a><span class="lineno">2830</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">repl_string</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
<a name="c0-2831"></a><span class="lineno">2831</span> 
<a name="c0-2832"></a><span class="lineno">2832</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2833"></a><span class="lineno">2833</span> <span class="c">  t = get_string_value ("LINES");</span>
<a name="c0-2834"></a><span class="lineno">2834</span> <span class="c">  LINES = (t &amp;&amp; *t) ? atoi (t) : 24;</span>
<a name="c0-2835"></a><span class="lineno">2835</span> <span class="cp">#endif</span>
<a name="c0-2836"></a><span class="lineno">2836</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"COLUMNS"</span><span class="p">);</span>
<a name="c0-2837"></a><span class="lineno">2837</span>   <span class="n">COLS</span> <span class="o">=</span>  <span class="p">(</span><span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">?</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">:</span> <span class="mi">80</span><span class="p">;</span>
<a name="c0-2838"></a><span class="lineno">2838</span> 
<a name="c0-2839"></a><span class="lineno">2839</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2840"></a><span class="lineno">2840</span> <span class="c">  t = get_string_value ("TABSIZE");</span>
<a name="c0-2841"></a><span class="lineno">2841</span> <span class="c">  tabsize = (t &amp;&amp; *t) ? atoi (t) : 8;</span>
<a name="c0-2842"></a><span class="lineno">2842</span> <span class="c">  if (tabsize &lt;= 0)</span>
<a name="c0-2843"></a><span class="lineno">2843</span> <span class="c">    tabsize = 8;</span>
<a name="c0-2844"></a><span class="lineno">2844</span> <span class="cp">#else</span>
<a name="c0-2845"></a><span class="lineno">2845</span>   <span class="n">tabsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<a name="c0-2846"></a><span class="lineno">2846</span> <span class="cp">#endif</span>
<a name="c0-2847"></a><span class="lineno">2847</span> 
<a name="c0-2848"></a><span class="lineno">2848</span>   <span class="n">max_elem_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2849"></a><span class="lineno">2849</span>   <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-2850"></a><span class="lineno">2850</span>     <span class="p">{</span>
<a name="c0-2851"></a><span class="lineno">2851</span>       <span class="n">len</span> <span class="o">=</span> <span class="n">displen</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c0-2852"></a><span class="lineno">2852</span>       <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_elem_len</span><span class="p">)</span>
<a name="c0-2853"></a><span class="lineno">2853</span>  <span class="n">max_elem_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2854"></a><span class="lineno">2854</span>     <span class="p">}</span>
<a name="c0-2855"></a><span class="lineno">2855</span>   <span class="n">indices_len</span> <span class="o">=</span> <span class="n">NUMBER_LEN</span> <span class="p">(</span><span class="n">list_len</span><span class="p">);</span>
<a name="c0-2856"></a><span class="lineno">2856</span>   <span class="n">max_elem_len</span> <span class="o">+=</span> <span class="n">indices_len</span> <span class="o">+</span> <span class="n">RP_SPACE_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-2857"></a><span class="lineno">2857</span> 
<a name="c0-2858"></a><span class="lineno">2858</span>   <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-2859"></a><span class="lineno">2859</span>     <span class="p">{</span>
<a name="c0-2860"></a><span class="lineno">2860</span>       <span class="k">if</span> <span class="p">(</span><span class="n">print_menu</span><span class="p">)</span>
<a name="c0-2861"></a><span class="lineno">2861</span>  <span class="n">print_select_list</span> <span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">max_elem_len</span><span class="p">,</span> <span class="n">indices_len</span><span class="p">);</span>
<a name="c0-2862"></a><span class="lineno">2862</span>       <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">prompt</span><span class="p">);</span>
<a name="c0-2863"></a><span class="lineno">2863</span>       <span class="n">fflush</span> <span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
<a name="c0-2864"></a><span class="lineno">2864</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2865"></a><span class="lineno">2865</span> 
<a name="c0-2866"></a><span class="lineno">2866</span>       <span class="k">if</span> <span class="p">(</span><span class="n">read_builtin</span> <span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-2867"></a><span class="lineno">2867</span>  <span class="p">{</span>
<a name="c0-2868"></a><span class="lineno">2868</span>    <span class="n">putchar</span> <span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-2869"></a><span class="lineno">2869</span>    <span class="k">return</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2870"></a><span class="lineno">2870</span>  <span class="p">}</span>
<a name="c0-2871"></a><span class="lineno">2871</span>       <span class="n">repl_string</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"REPLY"</span><span class="p">);</span>
<a name="c0-2872"></a><span class="lineno">2872</span>       <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">repl_string</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2873"></a><span class="lineno">2873</span>  <span class="p">{</span>
<a name="c0-2874"></a><span class="lineno">2874</span>    <span class="n">print_menu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2875"></a><span class="lineno">2875</span>    <span class="k">continue</span><span class="p">;</span>
<a name="c0-2876"></a><span class="lineno">2876</span>  <span class="p">}</span>
<a name="c0-2877"></a><span class="lineno">2877</span>       <span class="k">if</span> <span class="p">(</span><span class="n">legal_number</span> <span class="p">(</span><span class="n">repl_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2878"></a><span class="lineno">2878</span>  <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-2879"></a><span class="lineno">2879</span>       <span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">reply</span> <span class="o">&gt;</span> <span class="n">list_len</span><span class="p">)</span>
<a name="c0-2880"></a><span class="lineno">2880</span>  <span class="k">return</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-2881"></a><span class="lineno">2881</span> 
<a name="c0-2882"></a><span class="lineno">2882</span>       <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">reply</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-2883"></a><span class="lineno">2883</span>  <span class="p">;</span>
<a name="c0-2884"></a><span class="lineno">2884</span>       <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c0-2885"></a><span class="lineno">2885</span>     <span class="p">}</span>
<a name="c0-2886"></a><span class="lineno">2886</span> <span class="p">}</span>
<a name="c0-2887"></a><span class="lineno">2887</span> 
<a name="c0-2888"></a><span class="lineno">2888</span> <span class="cm">/* Execute a SELECT command.  The syntax is:</span>
<a name="c0-2889"></a><span class="lineno">2889</span> <span class="cm">   SELECT word IN list DO command_list DONE</span>
<a name="c0-2890"></a><span class="lineno">2890</span> <span class="cm">   Only `break' or `return' in command_list will terminate</span>
<a name="c0-2891"></a><span class="lineno">2891</span> <span class="cm">   the command. */</span>
<a name="c0-2892"></a><span class="lineno">2892</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-2893"></a><span class="lineno">2893</span> <span class="n">execute_select_command</span> <span class="p">(</span><span class="n">select_command</span><span class="p">)</span>
<a name="c0-2894"></a><span class="lineno">2894</span>      <span class="n">SELECT_COM</span> <span class="o">*</span><span class="n">select_command</span><span class="p">;</span>
<a name="c0-2895"></a><span class="lineno">2895</span> <span class="p">{</span>
<a name="c0-2896"></a><span class="lineno">2896</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">releaser</span><span class="p">,</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-2897"></a><span class="lineno">2897</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
<a name="c0-2898"></a><span class="lineno">2898</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">identifier</span><span class="p">,</span> <span class="o">*</span><span class="n">ps3_prompt</span><span class="p">,</span> <span class="o">*</span><span class="n">selection</span><span class="p">;</span>
<a name="c0-2899"></a><span class="lineno">2899</span>   <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">show_menu</span><span class="p">,</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2900"></a><span class="lineno">2900</span> 
<a name="c0-2901"></a><span class="lineno">2901</span>   <span class="k">if</span> <span class="p">(</span><span class="n">check_identifier</span> <span class="p">(</span><span class="n">select_command</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2902"></a><span class="lineno">2902</span>     <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-2903"></a><span class="lineno">2903</span> 
<a name="c0-2904"></a><span class="lineno">2904</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-2905"></a><span class="lineno">2905</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">select_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-2906"></a><span class="lineno">2906</span> 
<a name="c0-2907"></a><span class="lineno">2907</span>   <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2908"></a><span class="lineno">2908</span>   <span class="n">print_select_command_head</span> <span class="p">(</span><span class="n">select_command</span><span class="p">);</span>
<a name="c0-2909"></a><span class="lineno">2909</span> 
<a name="c0-2910"></a><span class="lineno">2910</span>   <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-2911"></a><span class="lineno">2911</span>     <span class="n">xtrace_print_select_command_head</span> <span class="p">(</span><span class="n">select_command</span><span class="p">);</span>
<a name="c0-2912"></a><span class="lineno">2912</span> 
<a name="c0-2913"></a><span class="lineno">2913</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-2914"></a><span class="lineno">2914</span> <span class="c">  if (signal_in_progress (DEBUG_TRAP) == 0 &amp;&amp; (this_command_name == 0 || (STREQ (this_command_name, "trap") == 0)))</span>
<a name="c0-2915"></a><span class="lineno">2915</span> <span class="cp">#else</span>
<a name="c0-2916"></a><span class="lineno">2916</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">running_trap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2917"></a><span class="lineno">2917</span> <span class="cp">#endif</span>
<a name="c0-2918"></a><span class="lineno">2918</span>     <span class="p">{</span>
<a name="c0-2919"></a><span class="lineno">2919</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-2920"></a><span class="lineno">2920</span>       <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">);</span>
<a name="c0-2921"></a><span class="lineno">2921</span>     <span class="p">}</span>
<a name="c0-2922"></a><span class="lineno">2922</span> 
<a name="c0-2923"></a><span class="lineno">2923</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-2924"></a><span class="lineno">2924</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-2925"></a><span class="lineno">2925</span>   <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-2926"></a><span class="lineno">2926</span> <span class="cm">     skip the command. */</span>
<a name="c0-2927"></a><span class="lineno">2927</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-2928"></a><span class="lineno">2928</span>     <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-2929"></a><span class="lineno">2929</span> <span class="cp">#endif</span>
<a name="c0-2930"></a><span class="lineno">2930</span> 
<a name="c0-2931"></a><span class="lineno">2931</span>   <span class="n">loop_level</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2932"></a><span class="lineno">2932</span>   <span class="n">identifier</span> <span class="o">=</span> <span class="n">select_command</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">;</span>
<a name="c0-2933"></a><span class="lineno">2933</span> 
<a name="c0-2934"></a><span class="lineno">2934</span>   <span class="cm">/* command and arithmetic substitution, parameter and variable expansion,</span>
<a name="c0-2935"></a><span class="lineno">2935</span> <span class="cm">     word splitting, pathname expansion, and quote removal. */</span>
<a name="c0-2936"></a><span class="lineno">2936</span>   <span class="n">list</span> <span class="o">=</span> <span class="n">releaser</span> <span class="o">=</span> <span class="n">expand_words_no_vars</span> <span class="p">(</span><span class="n">select_command</span><span class="o">-&gt;</span><span class="n">map_list</span><span class="p">);</span>
<a name="c0-2937"></a><span class="lineno">2937</span>   <span class="n">list_len</span> <span class="o">=</span> <span class="n">list_length</span> <span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c0-2938"></a><span class="lineno">2938</span>   <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">list_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2939"></a><span class="lineno">2939</span>     <span class="p">{</span>
<a name="c0-2940"></a><span class="lineno">2940</span>       <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span>
<a name="c0-2941"></a><span class="lineno">2941</span>  <span class="n">dispose_words</span> <span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c0-2942"></a><span class="lineno">2942</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2943"></a><span class="lineno">2943</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-2944"></a><span class="lineno">2944</span>     <span class="p">}</span>
<a name="c0-2945"></a><span class="lineno">2945</span> 
<a name="c0-2946"></a><span class="lineno">2946</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"select"</span><span class="p">);</span>
<a name="c0-2947"></a><span class="lineno">2947</span>   <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_words</span><span class="p">,</span> <span class="n">releaser</span><span class="p">);</span>
<a name="c0-2948"></a><span class="lineno">2948</span> 
<a name="c0-2949"></a><span class="lineno">2949</span>   <span class="k">if</span> <span class="p">(</span><span class="n">select_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span>
<a name="c0-2950"></a><span class="lineno">2950</span>     <span class="n">select_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-2951"></a><span class="lineno">2951</span> 
<a name="c0-2952"></a><span class="lineno">2952</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-2953"></a><span class="lineno">2953</span>   <span class="n">show_menu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2954"></a><span class="lineno">2954</span> 
<a name="c0-2955"></a><span class="lineno">2955</span>   <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-2956"></a><span class="lineno">2956</span>     <span class="p">{</span>
<a name="c0-2957"></a><span class="lineno">2957</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">select_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-2958"></a><span class="lineno">2958</span>       <span class="n">ps3_prompt</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"PS3"</span><span class="p">);</span>
<a name="c0-2959"></a><span class="lineno">2959</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ps3_prompt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2960"></a><span class="lineno">2960</span>  <span class="n">ps3_prompt</span> <span class="o">=</span> <span class="s">"#? "</span><span class="p">;</span>
<a name="c0-2961"></a><span class="lineno">2961</span> 
<a name="c0-2962"></a><span class="lineno">2962</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2963"></a><span class="lineno">2963</span>       <span class="n">selection</span> <span class="o">=</span> <span class="n">select_query</span> <span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">ps3_prompt</span><span class="p">,</span> <span class="n">show_menu</span><span class="p">);</span>
<a name="c0-2964"></a><span class="lineno">2964</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2965"></a><span class="lineno">2965</span>       <span class="k">if</span> <span class="p">(</span><span class="n">selection</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2966"></a><span class="lineno">2966</span>  <span class="p">{</span>
<a name="c0-2967"></a><span class="lineno">2967</span>    <span class="cm">/* select_query returns EXECUTION_FAILURE if the read builtin</span>
<a name="c0-2968"></a><span class="lineno">2968</span> <span class="cm">       fails, so we want to return failure in this case. */</span>
<a name="c0-2969"></a><span class="lineno">2969</span>    <span class="n">retval</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2970"></a><span class="lineno">2970</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-2971"></a><span class="lineno">2971</span>  <span class="p">}</span>
<a name="c0-2972"></a><span class="lineno">2972</span> 
<a name="c0-2973"></a><span class="lineno">2973</span>       <span class="n">v</span> <span class="o">=</span> <span class="n">bind_variable</span> <span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2974"></a><span class="lineno">2974</span>       <span class="k">if</span> <span class="p">(</span><span class="n">readonly_p</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">||</span> <span class="n">noassign_p</span> <span class="p">(</span><span class="n">v</span><span class="p">))</span>
<a name="c0-2975"></a><span class="lineno">2975</span>  <span class="p">{</span>
<a name="c0-2976"></a><span class="lineno">2976</span>    <span class="k">if</span> <span class="p">(</span><span class="n">readonly_p</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">posixly_correct</span><span class="p">)</span>
<a name="c0-2977"></a><span class="lineno">2977</span>      <span class="p">{</span>
<a name="c0-2978"></a><span class="lineno">2978</span>        <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-2979"></a><span class="lineno">2979</span>        <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">FORCE_EOF</span><span class="p">);</span>
<a name="c0-2980"></a><span class="lineno">2980</span>      <span class="p">}</span>
<a name="c0-2981"></a><span class="lineno">2981</span>    <span class="k">else</span>
<a name="c0-2982"></a><span class="lineno">2982</span>      <span class="p">{</span>
<a name="c0-2983"></a><span class="lineno">2983</span>        <span class="n">dispose_words</span> <span class="p">(</span><span class="n">releaser</span><span class="p">);</span>
<a name="c0-2984"></a><span class="lineno">2984</span>        <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"select"</span><span class="p">);</span>
<a name="c0-2985"></a><span class="lineno">2985</span>        <span class="n">loop_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2986"></a><span class="lineno">2986</span>        <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-2987"></a><span class="lineno">2987</span>        <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-2988"></a><span class="lineno">2988</span>      <span class="p">}</span>
<a name="c0-2989"></a><span class="lineno">2989</span>  <span class="p">}</span>
<a name="c0-2990"></a><span class="lineno">2990</span> 
<a name="c0-2991"></a><span class="lineno">2991</span>       <span class="n">retval</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">select_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
<a name="c0-2992"></a><span class="lineno">2992</span> 
<a name="c0-2993"></a><span class="lineno">2993</span>       <span class="n">REAP</span> <span class="p">();</span>
<a name="c0-2994"></a><span class="lineno">2994</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-2995"></a><span class="lineno">2995</span> 
<a name="c0-2996"></a><span class="lineno">2996</span>       <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span><span class="p">)</span>
<a name="c0-2997"></a><span class="lineno">2997</span>  <span class="p">{</span>
<a name="c0-2998"></a><span class="lineno">2998</span>    <span class="n">breaking</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2999"></a><span class="lineno">2999</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-3000"></a><span class="lineno">3000</span>  <span class="p">}</span>
<a name="c0-3001"></a><span class="lineno">3001</span> 
<a name="c0-3002"></a><span class="lineno">3002</span>       <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-3003"></a><span class="lineno">3003</span>  <span class="p">{</span>
<a name="c0-3004"></a><span class="lineno">3004</span>    <span class="n">continuing</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3005"></a><span class="lineno">3005</span>    <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-3006"></a><span class="lineno">3006</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-3007"></a><span class="lineno">3007</span>  <span class="p">}</span>
<a name="c0-3008"></a><span class="lineno">3008</span> 
<a name="c0-3009"></a><span class="lineno">3009</span> <span class="cp">#if defined (KSH_COMPATIBLE_SELECT)</span>
<a name="c0-3010"></a><span class="lineno">3010</span>       <span class="n">show_menu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3011"></a><span class="lineno">3011</span>       <span class="n">selection</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"REPLY"</span><span class="p">);</span>
<a name="c0-3012"></a><span class="lineno">3012</span>       <span class="k">if</span> <span class="p">(</span><span class="n">selection</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">selection</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
<a name="c0-3013"></a><span class="lineno">3013</span>         <span class="n">show_menu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3014"></a><span class="lineno">3014</span> <span class="cp">#endif</span>
<a name="c0-3015"></a><span class="lineno">3015</span>     <span class="p">}</span>
<a name="c0-3016"></a><span class="lineno">3016</span> 
<a name="c0-3017"></a><span class="lineno">3017</span>   <span class="n">loop_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3018"></a><span class="lineno">3018</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3019"></a><span class="lineno">3019</span> 
<a name="c0-3020"></a><span class="lineno">3020</span>   <span class="n">dispose_words</span> <span class="p">(</span><span class="n">releaser</span><span class="p">);</span>
<a name="c0-3021"></a><span class="lineno">3021</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"select"</span><span class="p">);</span>
<a name="c0-3022"></a><span class="lineno">3022</span>   <span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a name="c0-3023"></a><span class="lineno">3023</span> <span class="p">}</span>
<a name="c0-3024"></a><span class="lineno">3024</span> <span class="cp">#endif </span><span class="cm">/* SELECT_COMMAND */</span><span class="cp"></span>
<a name="c0-3025"></a><span class="lineno">3025</span> 
<a name="c0-3026"></a><span class="lineno">3026</span> <span class="cm">/* Execute a CASE command.  The syntax is: CASE word_desc IN pattern_list ESAC.</span>
<a name="c0-3027"></a><span class="lineno">3027</span> <span class="cm">   The pattern_list is a linked list of pattern clauses; each clause contains</span>
<a name="c0-3028"></a><span class="lineno">3028</span> <span class="cm">   some patterns to compare word_desc against, and an associated command to</span>
<a name="c0-3029"></a><span class="lineno">3029</span> <span class="cm">   execute. */</span>
<a name="c0-3030"></a><span class="lineno">3030</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3031"></a><span class="lineno">3031</span> <span class="n">execute_case_command</span> <span class="p">(</span><span class="n">case_command</span><span class="p">)</span>
<a name="c0-3032"></a><span class="lineno">3032</span>      <span class="n">CASE_COM</span> <span class="o">*</span><span class="n">case_command</span><span class="p">;</span>
<a name="c0-3033"></a><span class="lineno">3033</span> <span class="p">{</span>
<a name="c0-3034"></a><span class="lineno">3034</span>   <span class="k">register</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c0-3035"></a><span class="lineno">3035</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">wlist</span><span class="p">,</span> <span class="o">*</span><span class="n">es</span><span class="p">;</span>
<a name="c0-3036"></a><span class="lineno">3036</span>   <span class="n">PATTERN_LIST</span> <span class="o">*</span><span class="n">clauses</span><span class="p">;</span>
<a name="c0-3037"></a><span class="lineno">3037</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">word</span><span class="p">,</span> <span class="o">*</span><span class="n">pattern</span><span class="p">;</span>
<a name="c0-3038"></a><span class="lineno">3038</span>   <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">ignore_return</span><span class="p">,</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3039"></a><span class="lineno">3039</span> 
<a name="c0-3040"></a><span class="lineno">3040</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-3041"></a><span class="lineno">3041</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">case_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-3042"></a><span class="lineno">3042</span> 
<a name="c0-3043"></a><span class="lineno">3043</span>   <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3044"></a><span class="lineno">3044</span>   <span class="n">print_case_command_head</span> <span class="p">(</span><span class="n">case_command</span><span class="p">);</span>
<a name="c0-3045"></a><span class="lineno">3045</span> 
<a name="c0-3046"></a><span class="lineno">3046</span>   <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-3047"></a><span class="lineno">3047</span>     <span class="n">xtrace_print_case_command_head</span> <span class="p">(</span><span class="n">case_command</span><span class="p">);</span>
<a name="c0-3048"></a><span class="lineno">3048</span> 
<a name="c0-3049"></a><span class="lineno">3049</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-3050"></a><span class="lineno">3050</span> <span class="c">  if (signal_in_progress (DEBUG_TRAP) == 0 &amp;&amp; (this_command_name == 0 || (STREQ (this_command_name, "trap") == 0)))</span>
<a name="c0-3051"></a><span class="lineno">3051</span> <span class="cp">#else</span>
<a name="c0-3052"></a><span class="lineno">3052</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">running_trap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3053"></a><span class="lineno">3053</span> <span class="cp">#endif</span>
<a name="c0-3054"></a><span class="lineno">3054</span>     <span class="p">{</span>
<a name="c0-3055"></a><span class="lineno">3055</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-3056"></a><span class="lineno">3056</span>       <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">);</span>
<a name="c0-3057"></a><span class="lineno">3057</span>     <span class="p">}</span>
<a name="c0-3058"></a><span class="lineno">3058</span> 
<a name="c0-3059"></a><span class="lineno">3059</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">run_debug_trap</span><span class="p">();</span>
<a name="c0-3060"></a><span class="lineno">3060</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-3061"></a><span class="lineno">3061</span>   <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-3062"></a><span class="lineno">3062</span> <span class="cm">     skip the command. */</span>
<a name="c0-3063"></a><span class="lineno">3063</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3064"></a><span class="lineno">3064</span>     <span class="p">{</span>
<a name="c0-3065"></a><span class="lineno">3065</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3066"></a><span class="lineno">3066</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3067"></a><span class="lineno">3067</span>     <span class="p">}</span>
<a name="c0-3068"></a><span class="lineno">3068</span> <span class="cp">#endif</span>
<a name="c0-3069"></a><span class="lineno">3069</span> 
<a name="c0-3070"></a><span class="lineno">3070</span>   <span class="n">wlist</span> <span class="o">=</span> <span class="n">expand_word_unsplit</span> <span class="p">(</span><span class="n">case_command</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3071"></a><span class="lineno">3071</span>   <span class="n">word</span> <span class="o">=</span> <span class="n">wlist</span> <span class="o">?</span> <span class="n">string_list</span> <span class="p">(</span><span class="n">wlist</span><span class="p">)</span> <span class="o">:</span> <span class="n">savestring</span> <span class="p">(</span><span class="s">""</span><span class="p">);</span>
<a name="c0-3072"></a><span class="lineno">3072</span>   <span class="n">dispose_words</span> <span class="p">(</span><span class="n">wlist</span><span class="p">);</span>
<a name="c0-3073"></a><span class="lineno">3073</span> 
<a name="c0-3074"></a><span class="lineno">3074</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-3075"></a><span class="lineno">3075</span>   <span class="n">ignore_return</span> <span class="o">=</span> <span class="n">case_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3076"></a><span class="lineno">3076</span> 
<a name="c0-3077"></a><span class="lineno">3077</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"case"</span><span class="p">);</span>
<a name="c0-3078"></a><span class="lineno">3078</span>   <span class="n">add_unwind_protect</span> <span class="p">((</span><span class="n">Function</span> <span class="o">*</span><span class="p">)</span><span class="n">xfree</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
<a name="c0-3079"></a><span class="lineno">3079</span> 
<a name="c0-3080"></a><span class="lineno">3080</span> <span class="cp">#define EXIT_CASE()  goto exit_case_command</span>
<a name="c0-3081"></a><span class="lineno">3081</span> 
<a name="c0-3082"></a><span class="lineno">3082</span>   <span class="k">for</span> <span class="p">(</span><span class="n">clauses</span> <span class="o">=</span> <span class="n">case_command</span><span class="o">-&gt;</span><span class="n">clauses</span><span class="p">;</span> <span class="n">clauses</span><span class="p">;</span> <span class="n">clauses</span> <span class="o">=</span> <span class="n">clauses</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-3083"></a><span class="lineno">3083</span>     <span class="p">{</span>
<a name="c0-3084"></a><span class="lineno">3084</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3085"></a><span class="lineno">3085</span>       <span class="k">for</span> <span class="p">(</span><span class="n">list</span> <span class="o">=</span> <span class="n">clauses</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">;</span> <span class="n">list</span><span class="p">;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-3086"></a><span class="lineno">3086</span>  <span class="p">{</span>
<a name="c0-3087"></a><span class="lineno">3087</span>    <span class="n">es</span> <span class="o">=</span> <span class="n">expand_word_leave_quoted</span> <span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3088"></a><span class="lineno">3088</span> 
<a name="c0-3089"></a><span class="lineno">3089</span>    <span class="k">if</span> <span class="p">(</span><span class="n">es</span> <span class="o">&amp;&amp;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">&amp;&amp;</span> <span class="n">es</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">))</span>
<a name="c0-3090"></a><span class="lineno">3090</span>      <span class="n">pattern</span> <span class="o">=</span> <span class="n">quote_string_for_globbing</span> <span class="p">(</span><span class="n">es</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">QGLOB_CVTNULL</span><span class="p">);</span>
<a name="c0-3091"></a><span class="lineno">3091</span>    <span class="k">else</span>
<a name="c0-3092"></a><span class="lineno">3092</span>      <span class="p">{</span>
<a name="c0-3093"></a><span class="lineno">3093</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">xmalloc</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-3094"></a><span class="lineno">3094</span>        <span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-3095"></a><span class="lineno">3095</span>      <span class="p">}</span>
<a name="c0-3096"></a><span class="lineno">3096</span> 
<a name="c0-3097"></a><span class="lineno">3097</span>    <span class="cm">/* Since the pattern does not undergo quote removal (as per</span>
<a name="c0-3098"></a><span class="lineno">3098</span> <span class="cm">       Posix.2, section 3.9.4.3), the strmatch () call must be able</span>
<a name="c0-3099"></a><span class="lineno">3099</span> <span class="cm">       to recognize backslashes as escape characters. */</span>
<a name="c0-3100"></a><span class="lineno">3100</span>    <span class="n">match</span> <span class="o">=</span> <span class="n">strmatch</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">FNMATCH_EXTFLAG</span><span class="o">|</span><span class="n">FNMATCH_IGNCASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FNM_NOMATCH</span><span class="p">;</span>
<a name="c0-3101"></a><span class="lineno">3101</span>    <span class="n">free</span> <span class="p">(</span><span class="n">pattern</span><span class="p">);</span>
<a name="c0-3102"></a><span class="lineno">3102</span> 
<a name="c0-3103"></a><span class="lineno">3103</span>    <span class="n">dispose_words</span> <span class="p">(</span><span class="n">es</span><span class="p">);</span>
<a name="c0-3104"></a><span class="lineno">3104</span> 
<a name="c0-3105"></a><span class="lineno">3105</span>    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span>
<a name="c0-3106"></a><span class="lineno">3106</span>      <span class="p">{</span>
<a name="c0-3107"></a><span class="lineno">3107</span>        <span class="k">do</span>
<a name="c0-3108"></a><span class="lineno">3108</span>    <span class="p">{</span>
<a name="c0-3109"></a><span class="lineno">3109</span>      <span class="k">if</span> <span class="p">(</span><span class="n">clauses</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&amp;&amp;</span> <span class="n">ignore_return</span><span class="p">)</span>
<a name="c0-3110"></a><span class="lineno">3110</span>        <span class="n">clauses</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3111"></a><span class="lineno">3111</span>      <span class="n">retval</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">clauses</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
<a name="c0-3112"></a><span class="lineno">3112</span>    <span class="p">}</span>
<a name="c0-3113"></a><span class="lineno">3113</span>        <span class="k">while</span> <span class="p">((</span><span class="n">clauses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CASEPAT_FALLTHROUGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clauses</span> <span class="o">=</span> <span class="n">clauses</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
<a name="c0-3114"></a><span class="lineno">3114</span>        <span class="k">if</span> <span class="p">(</span><span class="n">clauses</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">clauses</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CASEPAT_TESTNEXT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3115"></a><span class="lineno">3115</span>    <span class="n">EXIT_CASE</span> <span class="p">();</span>
<a name="c0-3116"></a><span class="lineno">3116</span>        <span class="k">else</span>
<a name="c0-3117"></a><span class="lineno">3117</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-3118"></a><span class="lineno">3118</span>      <span class="p">}</span>
<a name="c0-3119"></a><span class="lineno">3119</span> 
<a name="c0-3120"></a><span class="lineno">3120</span>    <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3121"></a><span class="lineno">3121</span>  <span class="p">}</span>
<a name="c0-3122"></a><span class="lineno">3122</span>     <span class="p">}</span>
<a name="c0-3123"></a><span class="lineno">3123</span> 
<a name="c0-3124"></a><span class="lineno">3124</span> <span class="nl">exit_case_command:</span>
<a name="c0-3125"></a><span class="lineno">3125</span>   <span class="n">free</span> <span class="p">(</span><span class="n">word</span><span class="p">);</span>
<a name="c0-3126"></a><span class="lineno">3126</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"case"</span><span class="p">);</span>
<a name="c0-3127"></a><span class="lineno">3127</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3128"></a><span class="lineno">3128</span>   <span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a name="c0-3129"></a><span class="lineno">3129</span> <span class="p">}</span>
<a name="c0-3130"></a><span class="lineno">3130</span> 
<a name="c0-3131"></a><span class="lineno">3131</span> <span class="cp">#define CMD_WHILE 0</span>
<a name="c0-3132"></a><span class="lineno">3132</span> <span class="cp">#define CMD_UNTIL 1</span>
<a name="c0-3133"></a><span class="lineno">3133</span> 
<a name="c0-3134"></a><span class="lineno">3134</span> <span class="cm">/* The WHILE command.  Syntax: WHILE test DO action; DONE.</span>
<a name="c0-3135"></a><span class="lineno">3135</span> <span class="cm">   Repeatedly execute action while executing test produces</span>
<a name="c0-3136"></a><span class="lineno">3136</span> <span class="cm">   EXECUTION_SUCCESS. */</span>
<a name="c0-3137"></a><span class="lineno">3137</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3138"></a><span class="lineno">3138</span> <span class="n">execute_while_command</span> <span class="p">(</span><span class="n">while_command</span><span class="p">)</span>
<a name="c0-3139"></a><span class="lineno">3139</span>      <span class="n">WHILE_COM</span> <span class="o">*</span><span class="n">while_command</span><span class="p">;</span>
<a name="c0-3140"></a><span class="lineno">3140</span> <span class="p">{</span>
<a name="c0-3141"></a><span class="lineno">3141</span>   <span class="k">return</span> <span class="p">(</span><span class="n">execute_while_or_until</span> <span class="p">(</span><span class="n">while_command</span><span class="p">,</span> <span class="n">CMD_WHILE</span><span class="p">));</span>
<a name="c0-3142"></a><span class="lineno">3142</span> <span class="p">}</span>
<a name="c0-3143"></a><span class="lineno">3143</span> 
<a name="c0-3144"></a><span class="lineno">3144</span> <span class="cm">/* UNTIL is just like WHILE except that the test result is negated. */</span>
<a name="c0-3145"></a><span class="lineno">3145</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3146"></a><span class="lineno">3146</span> <span class="n">execute_until_command</span> <span class="p">(</span><span class="n">while_command</span><span class="p">)</span>
<a name="c0-3147"></a><span class="lineno">3147</span>      <span class="n">WHILE_COM</span> <span class="o">*</span><span class="n">while_command</span><span class="p">;</span>
<a name="c0-3148"></a><span class="lineno">3148</span> <span class="p">{</span>
<a name="c0-3149"></a><span class="lineno">3149</span>   <span class="k">return</span> <span class="p">(</span><span class="n">execute_while_or_until</span> <span class="p">(</span><span class="n">while_command</span><span class="p">,</span> <span class="n">CMD_UNTIL</span><span class="p">));</span>
<a name="c0-3150"></a><span class="lineno">3150</span> <span class="p">}</span>
<a name="c0-3151"></a><span class="lineno">3151</span> 
<a name="c0-3152"></a><span class="lineno">3152</span> <span class="cm">/* The body for both while and until.  The only difference between the</span>
<a name="c0-3153"></a><span class="lineno">3153</span> <span class="cm">   two is that the test value is treated differently.  TYPE is</span>
<a name="c0-3154"></a><span class="lineno">3154</span> <span class="cm">   CMD_WHILE or CMD_UNTIL.  The return value for both commands should</span>
<a name="c0-3155"></a><span class="lineno">3155</span> <span class="cm">   be EXECUTION_SUCCESS if no commands in the body are executed, and</span>
<a name="c0-3156"></a><span class="lineno">3156</span> <span class="cm">   the status of the last command executed in the body otherwise. */</span>
<a name="c0-3157"></a><span class="lineno">3157</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3158"></a><span class="lineno">3158</span> <span class="n">execute_while_or_until</span> <span class="p">(</span><span class="n">while_command</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
<a name="c0-3159"></a><span class="lineno">3159</span>      <span class="n">WHILE_COM</span> <span class="o">*</span><span class="n">while_command</span><span class="p">;</span>
<a name="c0-3160"></a><span class="lineno">3160</span>      <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-3161"></a><span class="lineno">3161</span> <span class="p">{</span>
<a name="c0-3162"></a><span class="lineno">3162</span>   <span class="kt">int</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">body_status</span><span class="p">;</span>
<a name="c0-3163"></a><span class="lineno">3163</span> 
<a name="c0-3164"></a><span class="lineno">3164</span>   <span class="n">body_status</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-3165"></a><span class="lineno">3165</span>   <span class="n">loop_level</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3166"></a><span class="lineno">3166</span> 
<a name="c0-3167"></a><span class="lineno">3167</span>   <span class="n">while_command</span><span class="o">-&gt;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3168"></a><span class="lineno">3168</span>   <span class="k">if</span> <span class="p">(</span><span class="n">while_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span>
<a name="c0-3169"></a><span class="lineno">3169</span>     <span class="n">while_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3170"></a><span class="lineno">3170</span> 
<a name="c0-3171"></a><span class="lineno">3171</span>   <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="c0-3172"></a><span class="lineno">3172</span>     <span class="p">{</span>
<a name="c0-3173"></a><span class="lineno">3173</span>       <span class="n">return_value</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">while_command</span><span class="o">-&gt;</span><span class="n">test</span><span class="p">);</span>
<a name="c0-3174"></a><span class="lineno">3174</span>       <span class="n">REAP</span> <span class="p">();</span>
<a name="c0-3175"></a><span class="lineno">3175</span> 
<a name="c0-3176"></a><span class="lineno">3176</span>       <span class="cm">/* Need to handle `break' in the test when we would break out of the</span>
<a name="c0-3177"></a><span class="lineno">3177</span> <span class="cm">         loop.  The job control code will set `breaking' to loop_level</span>
<a name="c0-3178"></a><span class="lineno">3178</span> <span class="cm">         when a job in a loop is stopped with SIGTSTP.  If the stopped job</span>
<a name="c0-3179"></a><span class="lineno">3179</span> <span class="cm">         is in the loop test, `breaking' will not be reset unless we do</span>
<a name="c0-3180"></a><span class="lineno">3180</span> <span class="cm">         this, and the shell will cease to execute commands. */</span>
<a name="c0-3181"></a><span class="lineno">3181</span>       <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMD_WHILE</span> <span class="o">&amp;&amp;</span> <span class="n">return_value</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3182"></a><span class="lineno">3182</span>  <span class="p">{</span>
<a name="c0-3183"></a><span class="lineno">3183</span>    <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span><span class="p">)</span>
<a name="c0-3184"></a><span class="lineno">3184</span>      <span class="n">breaking</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3185"></a><span class="lineno">3185</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-3186"></a><span class="lineno">3186</span>  <span class="p">}</span>
<a name="c0-3187"></a><span class="lineno">3187</span>       <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMD_UNTIL</span> <span class="o">&amp;&amp;</span> <span class="n">return_value</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3188"></a><span class="lineno">3188</span>  <span class="p">{</span>
<a name="c0-3189"></a><span class="lineno">3189</span>    <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span><span class="p">)</span>
<a name="c0-3190"></a><span class="lineno">3190</span>      <span class="n">breaking</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3191"></a><span class="lineno">3191</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-3192"></a><span class="lineno">3192</span>  <span class="p">}</span>
<a name="c0-3193"></a><span class="lineno">3193</span> 
<a name="c0-3194"></a><span class="lineno">3194</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3195"></a><span class="lineno">3195</span>       <span class="n">body_status</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">while_command</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
<a name="c0-3196"></a><span class="lineno">3196</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3197"></a><span class="lineno">3197</span> 
<a name="c0-3198"></a><span class="lineno">3198</span>       <span class="k">if</span> <span class="p">(</span><span class="n">breaking</span><span class="p">)</span>
<a name="c0-3199"></a><span class="lineno">3199</span>  <span class="p">{</span>
<a name="c0-3200"></a><span class="lineno">3200</span>    <span class="n">breaking</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3201"></a><span class="lineno">3201</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-3202"></a><span class="lineno">3202</span>  <span class="p">}</span>
<a name="c0-3203"></a><span class="lineno">3203</span> 
<a name="c0-3204"></a><span class="lineno">3204</span>       <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-3205"></a><span class="lineno">3205</span>  <span class="p">{</span>
<a name="c0-3206"></a><span class="lineno">3206</span>    <span class="n">continuing</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3207"></a><span class="lineno">3207</span>    <span class="k">if</span> <span class="p">(</span><span class="n">continuing</span><span class="p">)</span>
<a name="c0-3208"></a><span class="lineno">3208</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-3209"></a><span class="lineno">3209</span>  <span class="p">}</span>
<a name="c0-3210"></a><span class="lineno">3210</span>     <span class="p">}</span>
<a name="c0-3211"></a><span class="lineno">3211</span>   <span class="n">loop_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3212"></a><span class="lineno">3212</span> 
<a name="c0-3213"></a><span class="lineno">3213</span>   <span class="k">return</span> <span class="p">(</span><span class="n">body_status</span><span class="p">);</span>
<a name="c0-3214"></a><span class="lineno">3214</span> <span class="p">}</span>
<a name="c0-3215"></a><span class="lineno">3215</span> 
<a name="c0-3216"></a><span class="lineno">3216</span> <span class="cm">/* IF test THEN command [ELSE command].</span>
<a name="c0-3217"></a><span class="lineno">3217</span> <span class="cm">   IF also allows ELIF in the place of ELSE IF, but</span>
<a name="c0-3218"></a><span class="lineno">3218</span> <span class="cm">   the parser makes *that* stupidity transparent. */</span>
<a name="c0-3219"></a><span class="lineno">3219</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3220"></a><span class="lineno">3220</span> <span class="n">execute_if_command</span> <span class="p">(</span><span class="n">if_command</span><span class="p">)</span>
<a name="c0-3221"></a><span class="lineno">3221</span>      <span class="n">IF_COM</span> <span class="o">*</span><span class="n">if_command</span><span class="p">;</span>
<a name="c0-3222"></a><span class="lineno">3222</span> <span class="p">{</span>
<a name="c0-3223"></a><span class="lineno">3223</span>   <span class="kt">int</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3224"></a><span class="lineno">3224</span> 
<a name="c0-3225"></a><span class="lineno">3225</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-3226"></a><span class="lineno">3226</span>   <span class="n">if_command</span><span class="o">-&gt;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3227"></a><span class="lineno">3227</span>   <span class="n">return_value</span> <span class="o">=</span> <span class="n">execute_command</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">test</span><span class="p">);</span>
<a name="c0-3228"></a><span class="lineno">3228</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3229"></a><span class="lineno">3229</span> 
<a name="c0-3230"></a><span class="lineno">3230</span>   <span class="k">if</span> <span class="p">(</span><span class="n">return_value</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3231"></a><span class="lineno">3231</span>     <span class="p">{</span>
<a name="c0-3232"></a><span class="lineno">3232</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3233"></a><span class="lineno">3233</span> 
<a name="c0-3234"></a><span class="lineno">3234</span>       <span class="k">if</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">true_case</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">))</span>
<a name="c0-3235"></a><span class="lineno">3235</span>  <span class="n">if_command</span><span class="o">-&gt;</span><span class="n">true_case</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3236"></a><span class="lineno">3236</span> 
<a name="c0-3237"></a><span class="lineno">3237</span>       <span class="k">return</span> <span class="p">(</span><span class="n">execute_command</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">true_case</span><span class="p">));</span>
<a name="c0-3238"></a><span class="lineno">3238</span>     <span class="p">}</span>
<a name="c0-3239"></a><span class="lineno">3239</span>   <span class="k">else</span>
<a name="c0-3240"></a><span class="lineno">3240</span>     <span class="p">{</span>
<a name="c0-3241"></a><span class="lineno">3241</span>       <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3242"></a><span class="lineno">3242</span> 
<a name="c0-3243"></a><span class="lineno">3243</span>       <span class="k">if</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">false_case</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">))</span>
<a name="c0-3244"></a><span class="lineno">3244</span>  <span class="n">if_command</span><span class="o">-&gt;</span><span class="n">false_case</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3245"></a><span class="lineno">3245</span> 
<a name="c0-3246"></a><span class="lineno">3246</span>       <span class="k">return</span> <span class="p">(</span><span class="n">execute_command</span> <span class="p">(</span><span class="n">if_command</span><span class="o">-&gt;</span><span class="n">false_case</span><span class="p">));</span>
<a name="c0-3247"></a><span class="lineno">3247</span>     <span class="p">}</span>
<a name="c0-3248"></a><span class="lineno">3248</span> <span class="p">}</span>
<a name="c0-3249"></a><span class="lineno">3249</span> 
<a name="c0-3250"></a><span class="lineno">3250</span> <span class="cp">#if defined (DPAREN_ARITHMETIC)</span>
<a name="c0-3251"></a><span class="lineno">3251</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3252"></a><span class="lineno">3252</span> <span class="n">execute_arith_command</span> <span class="p">(</span><span class="n">arith_command</span><span class="p">)</span>
<a name="c0-3253"></a><span class="lineno">3253</span>      <span class="n">ARITH_COM</span> <span class="o">*</span><span class="n">arith_command</span><span class="p">;</span>
<a name="c0-3254"></a><span class="lineno">3254</span> <span class="p">{</span>
<a name="c0-3255"></a><span class="lineno">3255</span>   <span class="kt">int</span> <span class="n">expok</span><span class="p">,</span> <span class="n">save_line_number</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
<a name="c0-3256"></a><span class="lineno">3256</span>   <span class="kt">intmax_t</span> <span class="n">expresult</span><span class="p">;</span>
<a name="c0-3257"></a><span class="lineno">3257</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
<a name="c0-3258"></a><span class="lineno">3258</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">exp</span><span class="p">;</span>
<a name="c0-3259"></a><span class="lineno">3259</span> 
<a name="c0-3260"></a><span class="lineno">3260</span>   <span class="n">expresult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3261"></a><span class="lineno">3261</span> 
<a name="c0-3262"></a><span class="lineno">3262</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-3263"></a><span class="lineno">3263</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="s">"(("</span><span class="p">;</span>  <span class="cm">/* )) */</span>
<a name="c0-3264"></a><span class="lineno">3264</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">arith_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-3265"></a><span class="lineno">3265</span>   <span class="cm">/* If we're in a function, update the line number information. */</span>
<a name="c0-3266"></a><span class="lineno">3266</span>   <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span><span class="p">)</span>
<a name="c0-3267"></a><span class="lineno">3267</span>     <span class="n">line_number</span> <span class="o">-=</span> <span class="n">function_line_number</span><span class="p">;</span>
<a name="c0-3268"></a><span class="lineno">3268</span> 
<a name="c0-3269"></a><span class="lineno">3269</span>   <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3270"></a><span class="lineno">3270</span>   <span class="n">print_arith_command</span> <span class="p">(</span><span class="n">arith_command</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">);</span>
<a name="c0-3271"></a><span class="lineno">3271</span> 
<a name="c0-3272"></a><span class="lineno">3272</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3273"></a><span class="lineno">3273</span>     <span class="p">{</span>
<a name="c0-3274"></a><span class="lineno">3274</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-3275"></a><span class="lineno">3275</span>       <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">);</span>
<a name="c0-3276"></a><span class="lineno">3276</span>     <span class="p">}</span>
<a name="c0-3277"></a><span class="lineno">3277</span> 
<a name="c0-3278"></a><span class="lineno">3278</span>   <span class="cm">/* Run the debug trap before each arithmetic command, but do it after we</span>
<a name="c0-3279"></a><span class="lineno">3279</span> <span class="cm">     update the line number information and before we expand the various</span>
<a name="c0-3280"></a><span class="lineno">3280</span> <span class="cm">     words in the expression. */</span>
<a name="c0-3281"></a><span class="lineno">3281</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-3282"></a><span class="lineno">3282</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-3283"></a><span class="lineno">3283</span>   <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-3284"></a><span class="lineno">3284</span> <span class="cm">     skip the command. */</span>
<a name="c0-3285"></a><span class="lineno">3285</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3286"></a><span class="lineno">3286</span>     <span class="p">{</span>
<a name="c0-3287"></a><span class="lineno">3287</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3288"></a><span class="lineno">3288</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3289"></a><span class="lineno">3289</span>     <span class="p">}</span>
<a name="c0-3290"></a><span class="lineno">3290</span> <span class="cp">#endif</span>
<a name="c0-3291"></a><span class="lineno">3291</span> 
<a name="c0-3292"></a><span class="lineno">3292</span>   <span class="n">new</span> <span class="o">=</span> <span class="n">expand_words_no_vars</span> <span class="p">(</span><span class="n">arith_command</span><span class="o">-&gt;</span><span class="n">exp</span><span class="p">);</span>
<a name="c0-3293"></a><span class="lineno">3293</span> 
<a name="c0-3294"></a><span class="lineno">3294</span>   <span class="cm">/* If we're tracing, make a new word list with `((' at the front and `))'</span>
<a name="c0-3295"></a><span class="lineno">3295</span> <span class="cm">     at the back and print it. */</span>
<a name="c0-3296"></a><span class="lineno">3296</span>   <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-3297"></a><span class="lineno">3297</span>     <span class="n">xtrace_print_arith_cmd</span> <span class="p">(</span><span class="n">new</span><span class="p">);</span>
<a name="c0-3298"></a><span class="lineno">3298</span> 
<a name="c0-3299"></a><span class="lineno">3299</span>   <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
<a name="c0-3300"></a><span class="lineno">3300</span>     <span class="p">{</span>
<a name="c0-3301"></a><span class="lineno">3301</span>       <span class="n">exp</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">?</span> <span class="n">string_list</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">:</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">;</span>
<a name="c0-3302"></a><span class="lineno">3302</span>       <span class="n">expresult</span> <span class="o">=</span> <span class="n">evalexp</span> <span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expok</span><span class="p">);</span>
<a name="c0-3303"></a><span class="lineno">3303</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3304"></a><span class="lineno">3304</span>       <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">)</span>
<a name="c0-3305"></a><span class="lineno">3305</span>  <span class="n">free</span> <span class="p">(</span><span class="n">exp</span><span class="p">);</span>
<a name="c0-3306"></a><span class="lineno">3306</span>       <span class="n">dispose_words</span> <span class="p">(</span><span class="n">new</span><span class="p">);</span>
<a name="c0-3307"></a><span class="lineno">3307</span>     <span class="p">}</span>
<a name="c0-3308"></a><span class="lineno">3308</span>   <span class="k">else</span>
<a name="c0-3309"></a><span class="lineno">3309</span>     <span class="p">{</span>
<a name="c0-3310"></a><span class="lineno">3310</span>       <span class="n">expresult</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3311"></a><span class="lineno">3311</span>       <span class="n">expok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3312"></a><span class="lineno">3312</span>     <span class="p">}</span>
<a name="c0-3313"></a><span class="lineno">3313</span> 
<a name="c0-3314"></a><span class="lineno">3314</span>   <span class="k">if</span> <span class="p">(</span><span class="n">expok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3315"></a><span class="lineno">3315</span>     <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-3316"></a><span class="lineno">3316</span> 
<a name="c0-3317"></a><span class="lineno">3317</span>   <span class="k">return</span> <span class="p">(</span><span class="n">expresult</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">EXECUTION_FAILURE</span> <span class="o">:</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3318"></a><span class="lineno">3318</span> <span class="p">}</span>
<a name="c0-3319"></a><span class="lineno">3319</span> <span class="cp">#endif </span><span class="cm">/* DPAREN_ARITHMETIC */</span><span class="cp"></span>
<a name="c0-3320"></a><span class="lineno">3320</span> 
<a name="c0-3321"></a><span class="lineno">3321</span> <span class="cp">#if defined (COND_COMMAND)</span>
<a name="c0-3322"></a><span class="lineno">3322</span> 
<a name="c0-3323"></a><span class="lineno">3323</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">nullstr</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-3324"></a><span class="lineno">3324</span> 
<a name="c0-3325"></a><span class="lineno">3325</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3326"></a><span class="lineno">3326</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond</span><span class="p">)</span>
<a name="c0-3327"></a><span class="lineno">3327</span>      <span class="n">COND_COM</span> <span class="o">*</span><span class="n">cond</span><span class="p">;</span>
<a name="c0-3328"></a><span class="lineno">3328</span> <span class="p">{</span>
<a name="c0-3329"></a><span class="lineno">3329</span>   <span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">patmatch</span><span class="p">,</span> <span class="n">rmatch</span><span class="p">,</span> <span class="n">mflags</span><span class="p">,</span> <span class="n">ignore</span><span class="p">;</span>
<a name="c0-3330"></a><span class="lineno">3330</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">arg1</span><span class="p">,</span> <span class="o">*</span><span class="n">arg2</span><span class="p">;</span>
<a name="c0-3331"></a><span class="lineno">3331</span> 
<a name="c0-3332"></a><span class="lineno">3332</span>   <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INVERT_RETURN</span><span class="p">);</span>
<a name="c0-3333"></a><span class="lineno">3333</span>   <span class="n">ignore</span> <span class="o">=</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">);</span>
<a name="c0-3334"></a><span class="lineno">3334</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3335"></a><span class="lineno">3335</span>     <span class="p">{</span>
<a name="c0-3336"></a><span class="lineno">3336</span>       <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
<a name="c0-3337"></a><span class="lineno">3337</span>  <span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3338"></a><span class="lineno">3338</span>       <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
<a name="c0-3339"></a><span class="lineno">3339</span>  <span class="n">cond</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-3340"></a><span class="lineno">3340</span>     <span class="p">}</span>
<a name="c0-3341"></a><span class="lineno">3341</span>       
<a name="c0-3342"></a><span class="lineno">3342</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COND_EXPR</span><span class="p">)</span>
<a name="c0-3343"></a><span class="lineno">3343</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
<a name="c0-3344"></a><span class="lineno">3344</span>   <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COND_OR</span><span class="p">)</span>
<a name="c0-3345"></a><span class="lineno">3345</span>     <span class="p">{</span>
<a name="c0-3346"></a><span class="lineno">3346</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
<a name="c0-3347"></a><span class="lineno">3347</span>       <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3348"></a><span class="lineno">3348</span>  <span class="n">result</span> <span class="o">=</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
<a name="c0-3349"></a><span class="lineno">3349</span>     <span class="p">}</span>
<a name="c0-3350"></a><span class="lineno">3350</span>   <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COND_AND</span><span class="p">)</span>
<a name="c0-3351"></a><span class="lineno">3351</span>     <span class="p">{</span>
<a name="c0-3352"></a><span class="lineno">3352</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
<a name="c0-3353"></a><span class="lineno">3353</span>       <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3354"></a><span class="lineno">3354</span>  <span class="n">result</span> <span class="o">=</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
<a name="c0-3355"></a><span class="lineno">3355</span>     <span class="p">}</span>
<a name="c0-3356"></a><span class="lineno">3356</span>   <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COND_UNARY</span><span class="p">)</span>
<a name="c0-3357"></a><span class="lineno">3357</span>     <span class="p">{</span>
<a name="c0-3358"></a><span class="lineno">3358</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3359"></a><span class="lineno">3359</span>  <span class="n">comsub_ignore_return</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3360"></a><span class="lineno">3360</span>       <span class="n">arg1</span> <span class="o">=</span> <span class="n">cond_expand_word</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3361"></a><span class="lineno">3361</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3362"></a><span class="lineno">3362</span>  <span class="n">comsub_ignore_return</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3363"></a><span class="lineno">3363</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3364"></a><span class="lineno">3364</span>  <span class="n">arg1</span> <span class="o">=</span> <span class="n">nullstr</span><span class="p">;</span>
<a name="c0-3365"></a><span class="lineno">3365</span>       <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-3366"></a><span class="lineno">3366</span>  <span class="n">xtrace_print_cond_term</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-3367"></a><span class="lineno">3367</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">unary_test</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span> <span class="o">?</span> <span class="n">EXECUTION_SUCCESS</span> <span class="o">:</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-3368"></a><span class="lineno">3368</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg1</span> <span class="o">!=</span> <span class="n">nullstr</span><span class="p">)</span>
<a name="c0-3369"></a><span class="lineno">3369</span>  <span class="n">free</span> <span class="p">(</span><span class="n">arg1</span><span class="p">);</span>
<a name="c0-3370"></a><span class="lineno">3370</span>     <span class="p">}</span>
<a name="c0-3371"></a><span class="lineno">3371</span>   <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COND_BINARY</span><span class="p">)</span>
<a name="c0-3372"></a><span class="lineno">3372</span>     <span class="p">{</span>
<a name="c0-3373"></a><span class="lineno">3373</span>       <span class="n">rmatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3374"></a><span class="lineno">3374</span>       <span class="n">patmatch</span> <span class="o">=</span> <span class="p">((</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-3375"></a><span class="lineno">3375</span>      <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'!'</span> <span class="o">||</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-3376"></a><span class="lineno">3376</span>      <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span> <span class="o">&amp;&amp;</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">));</span>
<a name="c0-3377"></a><span class="lineno">3377</span> <span class="cp">#if defined (COND_REGEXP)</span>
<a name="c0-3378"></a><span class="lineno">3378</span>       <span class="n">rmatch</span> <span class="o">=</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'='</span> <span class="o">&amp;&amp;</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'~'</span> <span class="o">&amp;&amp;</span>
<a name="c0-3379"></a><span class="lineno">3379</span>    <span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">);</span>
<a name="c0-3380"></a><span class="lineno">3380</span> <span class="cp">#endif</span>
<a name="c0-3381"></a><span class="lineno">3381</span> 
<a name="c0-3382"></a><span class="lineno">3382</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3383"></a><span class="lineno">3383</span>  <span class="n">comsub_ignore_return</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3384"></a><span class="lineno">3384</span>       <span class="n">arg1</span> <span class="o">=</span> <span class="n">cond_expand_word</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3385"></a><span class="lineno">3385</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3386"></a><span class="lineno">3386</span>  <span class="n">comsub_ignore_return</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3387"></a><span class="lineno">3387</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3388"></a><span class="lineno">3388</span>  <span class="n">arg1</span> <span class="o">=</span> <span class="n">nullstr</span><span class="p">;</span>
<a name="c0-3389"></a><span class="lineno">3389</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3390"></a><span class="lineno">3390</span>  <span class="n">comsub_ignore_return</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3391"></a><span class="lineno">3391</span>       <span class="n">arg2</span> <span class="o">=</span> <span class="n">cond_expand_word</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span>
<a name="c0-3392"></a><span class="lineno">3392</span>             <span class="p">(</span><span class="n">rmatch</span> <span class="o">&amp;&amp;</span> <span class="n">shell_compatibility_level</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">(</span><span class="n">patmatch</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<a name="c0-3393"></a><span class="lineno">3393</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
<a name="c0-3394"></a><span class="lineno">3394</span>  <span class="n">comsub_ignore_return</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3395"></a><span class="lineno">3395</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3396"></a><span class="lineno">3396</span>  <span class="n">arg2</span> <span class="o">=</span> <span class="n">nullstr</span><span class="p">;</span>
<a name="c0-3397"></a><span class="lineno">3397</span> 
<a name="c0-3398"></a><span class="lineno">3398</span>       <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-3399"></a><span class="lineno">3399</span>  <span class="n">xtrace_print_cond_term</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">);</span>
<a name="c0-3400"></a><span class="lineno">3400</span> 
<a name="c0-3401"></a><span class="lineno">3401</span> <span class="cp">#if defined (COND_REGEXP)</span>
<a name="c0-3402"></a><span class="lineno">3402</span>       <span class="k">if</span> <span class="p">(</span><span class="n">rmatch</span><span class="p">)</span>
<a name="c0-3403"></a><span class="lineno">3403</span>  <span class="p">{</span>
<a name="c0-3404"></a><span class="lineno">3404</span>    <span class="n">mflags</span> <span class="o">=</span> <span class="n">SHMAT_PWARN</span><span class="p">;</span>
<a name="c0-3405"></a><span class="lineno">3405</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-3406"></a><span class="lineno">3406</span>    <span class="n">mflags</span> <span class="o">|=</span> <span class="n">SHMAT_SUBEXP</span><span class="p">;</span>
<a name="c0-3407"></a><span class="lineno">3407</span> <span class="cp">#endif</span>
<a name="c0-3408"></a><span class="lineno">3408</span> 
<a name="c0-3409"></a><span class="lineno">3409</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">sh_regmatch</span> <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">mflags</span><span class="p">);</span>
<a name="c0-3410"></a><span class="lineno">3410</span>  <span class="p">}</span>
<a name="c0-3411"></a><span class="lineno">3411</span>       <span class="k">else</span>
<a name="c0-3412"></a><span class="lineno">3412</span> <span class="cp">#endif </span><span class="cm">/* COND_REGEXP */</span><span class="cp"></span>
<a name="c0-3413"></a><span class="lineno">3413</span>  <span class="p">{</span>
<a name="c0-3414"></a><span class="lineno">3414</span>    <span class="kt">int</span> <span class="n">oe</span><span class="p">;</span>
<a name="c0-3415"></a><span class="lineno">3415</span>    <span class="n">oe</span> <span class="o">=</span> <span class="n">extended_glob</span><span class="p">;</span>
<a name="c0-3416"></a><span class="lineno">3416</span>    <span class="n">extended_glob</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3417"></a><span class="lineno">3417</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">binary_test</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">TEST_PATMATCH</span><span class="o">|</span><span class="n">TEST_ARITHEXP</span><span class="o">|</span><span class="n">TEST_LOCALE</span><span class="p">)</span>
<a name="c0-3418"></a><span class="lineno">3418</span>          <span class="o">?</span> <span class="n">EXECUTION_SUCCESS</span>
<a name="c0-3419"></a><span class="lineno">3419</span>          <span class="o">:</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-3420"></a><span class="lineno">3420</span>    <span class="n">extended_glob</span> <span class="o">=</span> <span class="n">oe</span><span class="p">;</span>
<a name="c0-3421"></a><span class="lineno">3421</span>  <span class="p">}</span>
<a name="c0-3422"></a><span class="lineno">3422</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg1</span> <span class="o">!=</span> <span class="n">nullstr</span><span class="p">)</span>
<a name="c0-3423"></a><span class="lineno">3423</span>  <span class="n">free</span> <span class="p">(</span><span class="n">arg1</span><span class="p">);</span>
<a name="c0-3424"></a><span class="lineno">3424</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg2</span> <span class="o">!=</span> <span class="n">nullstr</span><span class="p">)</span>
<a name="c0-3425"></a><span class="lineno">3425</span>  <span class="n">free</span> <span class="p">(</span><span class="n">arg2</span><span class="p">);</span>
<a name="c0-3426"></a><span class="lineno">3426</span>     <span class="p">}</span>
<a name="c0-3427"></a><span class="lineno">3427</span>   <span class="k">else</span>
<a name="c0-3428"></a><span class="lineno">3428</span>     <span class="p">{</span>
<a name="c0-3429"></a><span class="lineno">3429</span>       <span class="n">command_error</span> <span class="p">(</span><span class="s">"execute_cond_node"</span><span class="p">,</span> <span class="n">CMDERR_BADTYPE</span><span class="p">,</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3430"></a><span class="lineno">3430</span>       <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">DISCARD</span><span class="p">);</span>
<a name="c0-3431"></a><span class="lineno">3431</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-3432"></a><span class="lineno">3432</span>     <span class="p">}</span>
<a name="c0-3433"></a><span class="lineno">3433</span> 
<a name="c0-3434"></a><span class="lineno">3434</span>   <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
<a name="c0-3435"></a><span class="lineno">3435</span>     <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="n">EXECUTION_FAILURE</span> <span class="o">:</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-3436"></a><span class="lineno">3436</span> 
<a name="c0-3437"></a><span class="lineno">3437</span>   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-3438"></a><span class="lineno">3438</span> <span class="p">}</span>
<a name="c0-3439"></a><span class="lineno">3439</span> 
<a name="c0-3440"></a><span class="lineno">3440</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3441"></a><span class="lineno">3441</span> <span class="n">execute_cond_command</span> <span class="p">(</span><span class="n">cond_command</span><span class="p">)</span>
<a name="c0-3442"></a><span class="lineno">3442</span>      <span class="n">COND_COM</span> <span class="o">*</span><span class="n">cond_command</span><span class="p">;</span>
<a name="c0-3443"></a><span class="lineno">3443</span> <span class="p">{</span>
<a name="c0-3444"></a><span class="lineno">3444</span>   <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3445"></a><span class="lineno">3445</span> 
<a name="c0-3446"></a><span class="lineno">3446</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-3447"></a><span class="lineno">3447</span>   <span class="n">save_line_number</span> <span class="o">=</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c0-3448"></a><span class="lineno">3448</span> 
<a name="c0-3449"></a><span class="lineno">3449</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="s">"[["</span><span class="p">;</span>
<a name="c0-3450"></a><span class="lineno">3450</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">cond_command</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-3451"></a><span class="lineno">3451</span>   <span class="cm">/* If we're in a function, update the line number information. */</span>
<a name="c0-3452"></a><span class="lineno">3452</span>   <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span><span class="p">)</span>
<a name="c0-3453"></a><span class="lineno">3453</span>     <span class="n">line_number</span> <span class="o">-=</span> <span class="n">function_line_number</span><span class="p">;</span>
<a name="c0-3454"></a><span class="lineno">3454</span>   <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3455"></a><span class="lineno">3455</span>   <span class="n">print_cond_command</span> <span class="p">(</span><span class="n">cond_command</span><span class="p">);</span>
<a name="c0-3456"></a><span class="lineno">3456</span> 
<a name="c0-3457"></a><span class="lineno">3457</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3458"></a><span class="lineno">3458</span>     <span class="p">{</span>
<a name="c0-3459"></a><span class="lineno">3459</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-3460"></a><span class="lineno">3460</span>       <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">);</span>
<a name="c0-3461"></a><span class="lineno">3461</span>     <span class="p">}</span>
<a name="c0-3462"></a><span class="lineno">3462</span> 
<a name="c0-3463"></a><span class="lineno">3463</span>   <span class="cm">/* Run the debug trap before each conditional command, but do it after we</span>
<a name="c0-3464"></a><span class="lineno">3464</span> <span class="cm">     update the line number information. */</span>
<a name="c0-3465"></a><span class="lineno">3465</span>   <span class="n">retval</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-3466"></a><span class="lineno">3466</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-3467"></a><span class="lineno">3467</span>   <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-3468"></a><span class="lineno">3468</span> <span class="cm">     skip the command. */</span>
<a name="c0-3469"></a><span class="lineno">3469</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3470"></a><span class="lineno">3470</span>     <span class="p">{</span>
<a name="c0-3471"></a><span class="lineno">3471</span>       <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3472"></a><span class="lineno">3472</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3473"></a><span class="lineno">3473</span>     <span class="p">}</span>
<a name="c0-3474"></a><span class="lineno">3474</span> <span class="cp">#endif</span>
<a name="c0-3475"></a><span class="lineno">3475</span> 
<a name="c0-3476"></a><span class="lineno">3476</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-3477"></a><span class="lineno">3477</span> <span class="c">  debug_print_cond_command (cond_command);</span>
<a name="c0-3478"></a><span class="lineno">3478</span> <span class="cp">#endif</span>
<a name="c0-3479"></a><span class="lineno">3479</span> 
<a name="c0-3480"></a><span class="lineno">3480</span>   <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">execute_cond_node</span> <span class="p">(</span><span class="n">cond_command</span><span class="p">);</span>
<a name="c0-3481"></a><span class="lineno">3481</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">save_line_number</span><span class="p">;</span>
<a name="c0-3482"></a><span class="lineno">3482</span>   <span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<a name="c0-3483"></a><span class="lineno">3483</span> <span class="p">}</span>
<a name="c0-3484"></a><span class="lineno">3484</span> <span class="cp">#endif </span><span class="cm">/* COND_COMMAND */</span><span class="cp"></span>
<a name="c0-3485"></a><span class="lineno">3485</span> 
<a name="c0-3486"></a><span class="lineno">3486</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-3487"></a><span class="lineno">3487</span> <span class="n">bind_lastarg</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<a name="c0-3488"></a><span class="lineno">3488</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
<a name="c0-3489"></a><span class="lineno">3489</span> <span class="p">{</span>
<a name="c0-3490"></a><span class="lineno">3490</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<a name="c0-3491"></a><span class="lineno">3491</span> 
<a name="c0-3492"></a><span class="lineno">3492</span>   <span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3493"></a><span class="lineno">3493</span>     <span class="n">arg</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-3494"></a><span class="lineno">3494</span>   <span class="n">var</span> <span class="o">=</span> <span class="n">bind_variable</span> <span class="p">(</span><span class="s">"_"</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3495"></a><span class="lineno">3495</span>   <span class="n">VUNSETATTR</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">att_exported</span><span class="p">);</span>
<a name="c0-3496"></a><span class="lineno">3496</span> <span class="p">}</span>
<a name="c0-3497"></a><span class="lineno">3497</span> 
<a name="c0-3498"></a><span class="lineno">3498</span> <span class="cm">/* Execute a null command.  Fork a subshell if the command uses pipes or is</span>
<a name="c0-3499"></a><span class="lineno">3499</span> <span class="cm">   to be run asynchronously.  This handles all the side effects that are</span>
<a name="c0-3500"></a><span class="lineno">3500</span> <span class="cm">   supposed to take place. */</span>
<a name="c0-3501"></a><span class="lineno">3501</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3502"></a><span class="lineno">3502</span> <span class="n">execute_null_command</span> <span class="p">(</span><span class="n">redirects</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">)</span>
<a name="c0-3503"></a><span class="lineno">3503</span>      <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">redirects</span><span class="p">;</span>
<a name="c0-3504"></a><span class="lineno">3504</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">;</span>
<a name="c0-3505"></a><span class="lineno">3505</span> <span class="p">{</span>
<a name="c0-3506"></a><span class="lineno">3506</span>   <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
<a name="c0-3507"></a><span class="lineno">3507</span>   <span class="kt">int</span> <span class="n">forcefork</span><span class="p">;</span>
<a name="c0-3508"></a><span class="lineno">3508</span>   <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
<a name="c0-3509"></a><span class="lineno">3509</span> 
<a name="c0-3510"></a><span class="lineno">3510</span>   <span class="k">for</span> <span class="p">(</span><span class="n">forcefork</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">redirects</span><span class="p">;</span> <span class="n">rd</span><span class="p">;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-3511"></a><span class="lineno">3511</span>     <span class="n">forcefork</span> <span class="o">+=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">rflags</span> <span class="o">&amp;</span> <span class="n">REDIR_VARASSIGN</span><span class="p">;</span>
<a name="c0-3512"></a><span class="lineno">3512</span> 
<a name="c0-3513"></a><span class="lineno">3513</span>   <span class="k">if</span> <span class="p">(</span><span class="n">forcefork</span> <span class="o">||</span> <span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">async</span><span class="p">)</span>
<a name="c0-3514"></a><span class="lineno">3514</span>     <span class="p">{</span>
<a name="c0-3515"></a><span class="lineno">3515</span>       <span class="cm">/* We have a null command, but we really want a subshell to take</span>
<a name="c0-3516"></a><span class="lineno">3516</span> <span class="cm">   care of it.  Just fork, do piping and redirections, and exit. */</span>
<a name="c0-3517"></a><span class="lineno">3517</span>       <span class="k">if</span> <span class="p">(</span><span class="n">make_child</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">async</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3518"></a><span class="lineno">3518</span>  <span class="p">{</span>
<a name="c0-3519"></a><span class="lineno">3519</span>    <span class="cm">/* Cancel traps, in trap.c. */</span>
<a name="c0-3520"></a><span class="lineno">3520</span>    <span class="n">restore_original_signals</span> <span class="p">();</span>    <span class="cm">/* XXX */</span>
<a name="c0-3521"></a><span class="lineno">3521</span> 
<a name="c0-3522"></a><span class="lineno">3522</span>    <span class="n">do_piping</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-3523"></a><span class="lineno">3523</span> 
<a name="c0-3524"></a><span class="lineno">3524</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c0-3525"></a><span class="lineno">3525</span>    <span class="n">coproc_closeall</span> <span class="p">();</span>
<a name="c0-3526"></a><span class="lineno">3526</span> <span class="cp">#endif</span>
<a name="c0-3527"></a><span class="lineno">3527</span> 
<a name="c0-3528"></a><span class="lineno">3528</span>    <span class="n">subshell_environment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3529"></a><span class="lineno">3529</span>    <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-3530"></a><span class="lineno">3530</span>      <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_ASYNC</span><span class="p">;</span>
<a name="c0-3531"></a><span class="lineno">3531</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-3532"></a><span class="lineno">3532</span>      <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_PIPE</span><span class="p">;</span>
<a name="c0-3533"></a><span class="lineno">3533</span> 
<a name="c0-3534"></a><span class="lineno">3534</span>    <span class="k">if</span> <span class="p">(</span><span class="n">do_redirections</span> <span class="p">(</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3535"></a><span class="lineno">3535</span>      <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3536"></a><span class="lineno">3536</span>    <span class="k">else</span>
<a name="c0-3537"></a><span class="lineno">3537</span>      <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-3538"></a><span class="lineno">3538</span>  <span class="p">}</span>
<a name="c0-3539"></a><span class="lineno">3539</span>       <span class="k">else</span>
<a name="c0-3540"></a><span class="lineno">3540</span>  <span class="p">{</span>
<a name="c0-3541"></a><span class="lineno">3541</span>    <span class="n">close_pipes</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-3542"></a><span class="lineno">3542</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION) &amp;&amp; defined (HAVE_DEV_FD)</span>
<a name="c0-3543"></a><span class="lineno">3543</span>    <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-3544"></a><span class="lineno">3544</span> <span class="cp">#endif</span>
<a name="c0-3545"></a><span class="lineno">3545</span>    <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3546"></a><span class="lineno">3546</span>  <span class="p">}</span>
<a name="c0-3547"></a><span class="lineno">3547</span>     <span class="p">}</span>
<a name="c0-3548"></a><span class="lineno">3548</span>   <span class="k">else</span>
<a name="c0-3549"></a><span class="lineno">3549</span>     <span class="p">{</span>
<a name="c0-3550"></a><span class="lineno">3550</span>       <span class="cm">/* Even if there aren't any command names, pretend to do the</span>
<a name="c0-3551"></a><span class="lineno">3551</span> <span class="cm">   redirections that are specified.  The user expects the side</span>
<a name="c0-3552"></a><span class="lineno">3552</span> <span class="cm">   effects to take place.  If the redirections fail, then return</span>
<a name="c0-3553"></a><span class="lineno">3553</span> <span class="cm">   failure.  Otherwise, if a command substitution took place while</span>
<a name="c0-3554"></a><span class="lineno">3554</span> <span class="cm">   expanding the command or a redirection, return the value of that</span>
<a name="c0-3555"></a><span class="lineno">3555</span> <span class="cm">   substitution.  Otherwise, return EXECUTION_SUCCESS. */</span>
<a name="c0-3556"></a><span class="lineno">3556</span> 
<a name="c0-3557"></a><span class="lineno">3557</span>       <span class="n">r</span> <span class="o">=</span> <span class="n">do_redirections</span> <span class="p">(</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="o">|</span><span class="n">RX_UNDOABLE</span><span class="p">);</span>
<a name="c0-3558"></a><span class="lineno">3558</span>       <span class="n">cleanup_redirects</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">);</span>
<a name="c0-3559"></a><span class="lineno">3559</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3560"></a><span class="lineno">3560</span> 
<a name="c0-3561"></a><span class="lineno">3561</span>       <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3562"></a><span class="lineno">3562</span>  <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-3563"></a><span class="lineno">3563</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">last_command_subst_pid</span> <span class="o">!=</span> <span class="n">NO_PID</span><span class="p">)</span>
<a name="c0-3564"></a><span class="lineno">3564</span>  <span class="k">return</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c0-3565"></a><span class="lineno">3565</span>       <span class="k">else</span>
<a name="c0-3566"></a><span class="lineno">3566</span>  <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3567"></a><span class="lineno">3567</span>     <span class="p">}</span>
<a name="c0-3568"></a><span class="lineno">3568</span> <span class="p">}</span>
<a name="c0-3569"></a><span class="lineno">3569</span> 
<a name="c0-3570"></a><span class="lineno">3570</span> <span class="cm">/* This is a hack to suppress word splitting for assignment statements</span>
<a name="c0-3571"></a><span class="lineno">3571</span> <span class="cm">   given as arguments to builtins with the ASSIGNMENT_BUILTIN flag set. */</span>
<a name="c0-3572"></a><span class="lineno">3572</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-3573"></a><span class="lineno">3573</span> <span class="n">fix_assignment_words</span> <span class="p">(</span><span class="n">words</span><span class="p">)</span>
<a name="c0-3574"></a><span class="lineno">3574</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-3575"></a><span class="lineno">3575</span> <span class="p">{</span>
<a name="c0-3576"></a><span class="lineno">3576</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
<a name="c0-3577"></a><span class="lineno">3577</span>   <span class="k">struct</span> <span class="n">builtin</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
<a name="c0-3578"></a><span class="lineno">3578</span>   <span class="kt">int</span> <span class="n">assoc</span><span class="p">;</span>
<a name="c0-3579"></a><span class="lineno">3579</span> 
<a name="c0-3580"></a><span class="lineno">3580</span>   <span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3581"></a><span class="lineno">3581</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-3582"></a><span class="lineno">3582</span> 
<a name="c0-3583"></a><span class="lineno">3583</span>   <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3584"></a><span class="lineno">3584</span>   <span class="n">assoc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3585"></a><span class="lineno">3585</span> 
<a name="c0-3586"></a><span class="lineno">3586</span>   <span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">words</span><span class="p">;</span> <span class="n">w</span><span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-3587"></a><span class="lineno">3587</span>     <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">W_ASSIGNMENT</span><span class="p">)</span>
<a name="c0-3588"></a><span class="lineno">3588</span>       <span class="p">{</span>
<a name="c0-3589"></a><span class="lineno">3589</span>  <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3590"></a><span class="lineno">3590</span>    <span class="p">{</span>
<a name="c0-3591"></a><span class="lineno">3591</span>      <span class="n">b</span> <span class="o">=</span> <span class="n">builtin_address_internal</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3592"></a><span class="lineno">3592</span>      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASSIGNMENT_BUILTIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3593"></a><span class="lineno">3593</span>        <span class="k">return</span><span class="p">;</span>
<a name="c0-3594"></a><span class="lineno">3594</span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASSIGNMENT_BUILTIN</span><span class="p">))</span>
<a name="c0-3595"></a><span class="lineno">3595</span>        <span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">W_ASSNBLTIN</span><span class="p">;</span>
<a name="c0-3596"></a><span class="lineno">3596</span>    <span class="p">}</span>
<a name="c0-3597"></a><span class="lineno">3597</span>  <span class="n">w</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">W_NOSPLIT</span><span class="o">|</span><span class="n">W_NOGLOB</span><span class="o">|</span><span class="n">W_TILDEEXP</span><span class="o">|</span><span class="n">W_ASSIGNARG</span><span class="p">);</span>
<a name="c0-3598"></a><span class="lineno">3598</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-3599"></a><span class="lineno">3599</span>  <span class="k">if</span> <span class="p">(</span><span class="n">assoc</span><span class="p">)</span>
<a name="c0-3600"></a><span class="lineno">3600</span>    <span class="n">w</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">W_ASSIGNASSOC</span><span class="p">;</span>
<a name="c0-3601"></a><span class="lineno">3601</span> <span class="cp">#endif</span>
<a name="c0-3602"></a><span class="lineno">3602</span>       <span class="p">}</span>
<a name="c0-3603"></a><span class="lineno">3603</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-3604"></a><span class="lineno">3604</span>     <span class="cm">/* Note that we saw an associative array option to a builtin that takes</span>
<a name="c0-3605"></a><span class="lineno">3605</span> <span class="cm">       assignment statements.  This is a bit of a kludge. */</span>
<a name="c0-3606"></a><span class="lineno">3606</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">))</span>
<a name="c0-3607"></a><span class="lineno">3607</span>       <span class="p">{</span>
<a name="c0-3608"></a><span class="lineno">3608</span>  <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3609"></a><span class="lineno">3609</span>    <span class="p">{</span>
<a name="c0-3610"></a><span class="lineno">3610</span>      <span class="n">b</span> <span class="o">=</span> <span class="n">builtin_address_internal</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3611"></a><span class="lineno">3611</span>      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASSIGNMENT_BUILTIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3612"></a><span class="lineno">3612</span>        <span class="k">return</span><span class="p">;</span>
<a name="c0-3613"></a><span class="lineno">3613</span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASSIGNMENT_BUILTIN</span><span class="p">))</span>
<a name="c0-3614"></a><span class="lineno">3614</span>        <span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">W_ASSNBLTIN</span><span class="p">;</span>
<a name="c0-3615"></a><span class="lineno">3615</span>    <span class="p">}</span>
<a name="c0-3616"></a><span class="lineno">3616</span>  <span class="k">if</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">W_ASSNBLTIN</span><span class="p">)</span>
<a name="c0-3617"></a><span class="lineno">3617</span>    <span class="n">assoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3618"></a><span class="lineno">3618</span>       <span class="p">}</span>
<a name="c0-3619"></a><span class="lineno">3619</span> <span class="cp">#endif</span>
<a name="c0-3620"></a><span class="lineno">3620</span> <span class="p">}</span>
<a name="c0-3621"></a><span class="lineno">3621</span> 
<a name="c0-3622"></a><span class="lineno">3622</span> <span class="cm">/* Return 1 if the file found by searching $PATH for PATHNAME, defaulting</span>
<a name="c0-3623"></a><span class="lineno">3623</span> <span class="cm">   to PATHNAME, is a directory.  Used by the autocd code below. */</span>
<a name="c0-3624"></a><span class="lineno">3624</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3625"></a><span class="lineno">3625</span> <span class="n">is_dirname</span> <span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
<a name="c0-3626"></a><span class="lineno">3626</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">;</span>
<a name="c0-3627"></a><span class="lineno">3627</span> <span class="p">{</span>
<a name="c0-3628"></a><span class="lineno">3628</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<a name="c0-3629"></a><span class="lineno">3629</span>   <span class="n">temp</span> <span class="o">=</span> <span class="n">search_for_command</span> <span class="p">(</span><span class="n">pathname</span><span class="p">);</span>
<a name="c0-3630"></a><span class="lineno">3630</span>   <span class="k">return</span> <span class="p">(</span><span class="n">temp</span> <span class="o">?</span> <span class="n">file_isdir</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">:</span> <span class="n">file_isdir</span> <span class="p">(</span><span class="n">pathname</span><span class="p">));</span>
<a name="c0-3631"></a><span class="lineno">3631</span> <span class="p">}</span>
<a name="c0-3632"></a><span class="lineno">3632</span> 
<a name="c0-3633"></a><span class="lineno">3633</span> <span class="cm">/* The meaty part of all the executions.  We have to start hacking the</span>
<a name="c0-3634"></a><span class="lineno">3634</span> <span class="cm">   real execution of commands here.  Fork a process, set things up,</span>
<a name="c0-3635"></a><span class="lineno">3635</span> <span class="cm">   execute the command. */</span>
<a name="c0-3636"></a><span class="lineno">3636</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3637"></a><span class="lineno">3637</span> <span class="n">execute_simple_command</span> <span class="p">(</span><span class="n">simple_command</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-3638"></a><span class="lineno">3638</span>      <span class="n">SIMPLE_COM</span> <span class="o">*</span><span class="n">simple_command</span><span class="p">;</span>
<a name="c0-3639"></a><span class="lineno">3639</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">;</span>
<a name="c0-3640"></a><span class="lineno">3640</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-3641"></a><span class="lineno">3641</span> <span class="p">{</span>
<a name="c0-3642"></a><span class="lineno">3642</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">,</span> <span class="o">*</span><span class="n">lastword</span><span class="p">;</span>
<a name="c0-3643"></a><span class="lineno">3643</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">command_line</span><span class="p">,</span> <span class="o">*</span><span class="n">lastarg</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<a name="c0-3644"></a><span class="lineno">3644</span>   <span class="kt">int</span> <span class="n">first_word_quoted</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">builtin_is_special</span><span class="p">,</span> <span class="n">already_forked</span><span class="p">,</span> <span class="n">dofork</span><span class="p">;</span>
<a name="c0-3645"></a><span class="lineno">3645</span>   <span class="n">pid_t</span> <span class="n">old_last_async_pid</span><span class="p">;</span>
<a name="c0-3646"></a><span class="lineno">3646</span>   <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="n">builtin</span><span class="p">;</span>
<a name="c0-3647"></a><span class="lineno">3647</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
<a name="c0-3648"></a><span class="lineno">3648</span>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">old_builtin</span><span class="p">,</span> <span class="n">old_command_builtin</span><span class="p">;</span>
<a name="c0-3649"></a><span class="lineno">3649</span> 
<a name="c0-3650"></a><span class="lineno">3650</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-3651"></a><span class="lineno">3651</span>   <span class="n">special_builtin_failed</span> <span class="o">=</span> <span class="n">builtin_is_special</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3652"></a><span class="lineno">3652</span>   <span class="n">command_line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<a name="c0-3653"></a><span class="lineno">3653</span> 
<a name="c0-3654"></a><span class="lineno">3654</span>   <span class="cm">/* If we're in a function, update the line number information. */</span>
<a name="c0-3655"></a><span class="lineno">3655</span>   <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span> <span class="o">&amp;&amp;</span> <span class="n">sourcelevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3656"></a><span class="lineno">3656</span>     <span class="n">line_number</span> <span class="o">-=</span> <span class="n">function_line_number</span><span class="p">;</span>
<a name="c0-3657"></a><span class="lineno">3657</span> 
<a name="c0-3658"></a><span class="lineno">3658</span>   <span class="cm">/* Remember what this command line looks like at invocation. */</span>
<a name="c0-3659"></a><span class="lineno">3659</span>   <span class="n">command_string_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3660"></a><span class="lineno">3660</span>   <span class="n">print_simple_command</span> <span class="p">(</span><span class="n">simple_command</span><span class="p">);</span>
<a name="c0-3661"></a><span class="lineno">3661</span> 
<a name="c0-3662"></a><span class="lineno">3662</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-3663"></a><span class="lineno">3663</span> <span class="c">  if (signal_in_progress (DEBUG_TRAP) == 0 &amp;&amp; (this_command_name == 0 || (STREQ (this_command_name, "trap") == 0)))</span>
<a name="c0-3664"></a><span class="lineno">3664</span> <span class="cp">#else</span>
<a name="c0-3665"></a><span class="lineno">3665</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">running_trap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3666"></a><span class="lineno">3666</span> <span class="cp">#endif</span>
<a name="c0-3667"></a><span class="lineno">3667</span>     <span class="p">{</span>
<a name="c0-3668"></a><span class="lineno">3668</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-3669"></a><span class="lineno">3669</span>       <span class="n">the_printed_command_except_trap</span> <span class="o">=</span> <span class="n">the_printed_command</span> <span class="o">?</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<a name="c0-3670"></a><span class="lineno">3670</span>     <span class="p">}</span>
<a name="c0-3671"></a><span class="lineno">3671</span> 
<a name="c0-3672"></a><span class="lineno">3672</span>   <span class="cm">/* Run the debug trap before each simple command, but do it after we</span>
<a name="c0-3673"></a><span class="lineno">3673</span> <span class="cm">     update the line number information. */</span>
<a name="c0-3674"></a><span class="lineno">3674</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-3675"></a><span class="lineno">3675</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-3676"></a><span class="lineno">3676</span>   <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-3677"></a><span class="lineno">3677</span> <span class="cm">     skip the command. */</span>
<a name="c0-3678"></a><span class="lineno">3678</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-3679"></a><span class="lineno">3679</span>     <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-3680"></a><span class="lineno">3680</span> <span class="cp">#endif</span>
<a name="c0-3681"></a><span class="lineno">3681</span> 
<a name="c0-3682"></a><span class="lineno">3682</span>   <span class="n">first_word_quoted</span> <span class="o">=</span>
<a name="c0-3683"></a><span class="lineno">3683</span>     <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">?</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">W_QUOTED</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3684"></a><span class="lineno">3684</span> 
<a name="c0-3685"></a><span class="lineno">3685</span>   <span class="n">last_command_subst_pid</span> <span class="o">=</span> <span class="n">NO_PID</span><span class="p">;</span>
<a name="c0-3686"></a><span class="lineno">3686</span>   <span class="n">old_last_async_pid</span> <span class="o">=</span> <span class="n">last_asynchronous_pid</span><span class="p">;</span>
<a name="c0-3687"></a><span class="lineno">3687</span> 
<a name="c0-3688"></a><span class="lineno">3688</span>   <span class="n">already_forked</span> <span class="o">=</span> <span class="n">dofork</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3689"></a><span class="lineno">3689</span> 
<a name="c0-3690"></a><span class="lineno">3690</span>   <span class="cm">/* If we're in a pipeline or run in the background, set DOFORK so we</span>
<a name="c0-3691"></a><span class="lineno">3691</span> <span class="cm">     make the child early, before word expansion.  This keeps assignment</span>
<a name="c0-3692"></a><span class="lineno">3692</span> <span class="cm">     statements from affecting the parent shell's environment when they</span>
<a name="c0-3693"></a><span class="lineno">3693</span> <span class="cm">     should not. */</span>
<a name="c0-3694"></a><span class="lineno">3694</span>   <span class="n">dofork</span> <span class="o">=</span> <span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">async</span><span class="p">;</span>
<a name="c0-3695"></a><span class="lineno">3695</span> 
<a name="c0-3696"></a><span class="lineno">3696</span>   <span class="cm">/* Something like `%2 &amp;' should restart job 2 in the background, not cause</span>
<a name="c0-3697"></a><span class="lineno">3697</span> <span class="cm">     the shell to fork here. */</span>
<a name="c0-3698"></a><span class="lineno">3698</span>   <span class="k">if</span> <span class="p">(</span><span class="n">dofork</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-3699"></a><span class="lineno">3699</span>  <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">&amp;&amp;</span> <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">&amp;&amp;</span>
<a name="c0-3700"></a><span class="lineno">3700</span>  <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">&amp;&amp;</span>
<a name="c0-3701"></a><span class="lineno">3701</span>  <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">))</span>
<a name="c0-3702"></a><span class="lineno">3702</span>     <span class="n">dofork</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3703"></a><span class="lineno">3703</span> 
<a name="c0-3704"></a><span class="lineno">3704</span>   <span class="k">if</span> <span class="p">(</span><span class="n">dofork</span><span class="p">)</span>
<a name="c0-3705"></a><span class="lineno">3705</span>     <span class="p">{</span>
<a name="c0-3706"></a><span class="lineno">3706</span>       <span class="cm">/* Do this now, because execute_disk_command will do it anyway in the</span>
<a name="c0-3707"></a><span class="lineno">3707</span> <span class="cm">   vast majority of cases. */</span>
<a name="c0-3708"></a><span class="lineno">3708</span>       <span class="n">maybe_make_export_env</span> <span class="p">();</span>
<a name="c0-3709"></a><span class="lineno">3709</span> 
<a name="c0-3710"></a><span class="lineno">3710</span>       <span class="cm">/* Don't let a DEBUG trap overwrite the command string to be saved with</span>
<a name="c0-3711"></a><span class="lineno">3711</span> <span class="cm">   the process/job associated with this child. */</span>
<a name="c0-3712"></a><span class="lineno">3712</span>       <span class="k">if</span> <span class="p">(</span><span class="n">make_child</span> <span class="p">(</span><span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">),</span> <span class="n">async</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3713"></a><span class="lineno">3713</span>  <span class="p">{</span>
<a name="c0-3714"></a><span class="lineno">3714</span>    <span class="n">already_forked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3715"></a><span class="lineno">3715</span>    <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_NO_FORK</span><span class="p">;</span>
<a name="c0-3716"></a><span class="lineno">3716</span> 
<a name="c0-3717"></a><span class="lineno">3717</span>    <span class="n">subshell_environment</span> <span class="o">=</span> <span class="n">SUBSHELL_FORK</span><span class="p">;</span>
<a name="c0-3718"></a><span class="lineno">3718</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-3719"></a><span class="lineno">3719</span>      <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_PIPE</span><span class="p">;</span>
<a name="c0-3720"></a><span class="lineno">3720</span>    <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-3721"></a><span class="lineno">3721</span>      <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_ASYNC</span><span class="p">;</span>
<a name="c0-3722"></a><span class="lineno">3722</span> 
<a name="c0-3723"></a><span class="lineno">3723</span>    <span class="cm">/* We need to do this before piping to handle some really</span>
<a name="c0-3724"></a><span class="lineno">3724</span> <span class="cm">       pathological cases where one of the pipe file descriptors</span>
<a name="c0-3725"></a><span class="lineno">3725</span> <span class="cm">       is &lt; 2. */</span>
<a name="c0-3726"></a><span class="lineno">3726</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-3727"></a><span class="lineno">3727</span>      <span class="n">close_fd_bitmap</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-3728"></a><span class="lineno">3728</span> 
<a name="c0-3729"></a><span class="lineno">3729</span>    <span class="n">do_piping</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-3730"></a><span class="lineno">3730</span>    <span class="n">pipe_in</span> <span class="o">=</span> <span class="n">pipe_out</span> <span class="o">=</span> <span class="n">NO_PIPE</span><span class="p">;</span>
<a name="c0-3731"></a><span class="lineno">3731</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c0-3732"></a><span class="lineno">3732</span>    <span class="n">coproc_closeall</span> <span class="p">();</span>
<a name="c0-3733"></a><span class="lineno">3733</span> <span class="cp">#endif</span>
<a name="c0-3734"></a><span class="lineno">3734</span> 
<a name="c0-3735"></a><span class="lineno">3735</span>    <span class="n">last_asynchronous_pid</span> <span class="o">=</span> <span class="n">old_last_async_pid</span><span class="p">;</span>
<a name="c0-3736"></a><span class="lineno">3736</span>  <span class="p">}</span>
<a name="c0-3737"></a><span class="lineno">3737</span>       <span class="k">else</span>
<a name="c0-3738"></a><span class="lineno">3738</span>  <span class="p">{</span>
<a name="c0-3739"></a><span class="lineno">3739</span>    <span class="cm">/* Don't let simple commands that aren't the last command in a</span>
<a name="c0-3740"></a><span class="lineno">3740</span> <span class="cm">       pipeline change $? for the rest of the pipeline (or at all). */</span>
<a name="c0-3741"></a><span class="lineno">3741</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-3742"></a><span class="lineno">3742</span>      <span class="n">result</span> <span class="o">=</span> <span class="n">last_command_exit_value</span><span class="p">;</span>
<a name="c0-3743"></a><span class="lineno">3743</span>    <span class="n">close_pipes</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-3744"></a><span class="lineno">3744</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION) &amp;&amp; defined (HAVE_DEV_FD)</span>
<a name="c0-3745"></a><span class="lineno">3745</span>    <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-3746"></a><span class="lineno">3746</span> <span class="cp">#endif</span>
<a name="c0-3747"></a><span class="lineno">3747</span>    <span class="n">command_line</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>      <span class="cm">/* don't free this. */</span>
<a name="c0-3748"></a><span class="lineno">3748</span>    <span class="n">bind_lastarg</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-3749"></a><span class="lineno">3749</span>    <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3750"></a><span class="lineno">3750</span>  <span class="p">}</span>
<a name="c0-3751"></a><span class="lineno">3751</span>     <span class="p">}</span>
<a name="c0-3752"></a><span class="lineno">3752</span> 
<a name="c0-3753"></a><span class="lineno">3753</span>   <span class="cm">/* If we are re-running this as the result of executing the `command'</span>
<a name="c0-3754"></a><span class="lineno">3754</span> <span class="cm">     builtin, do not expand the command words a second time. */</span>
<a name="c0-3755"></a><span class="lineno">3755</span>   <span class="k">if</span> <span class="p">((</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_INHIBIT_EXPANSION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3756"></a><span class="lineno">3756</span>     <span class="p">{</span>
<a name="c0-3757"></a><span class="lineno">3757</span>       <span class="n">current_fds_to_close</span> <span class="o">=</span> <span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-3758"></a><span class="lineno">3758</span>       <span class="n">fix_assignment_words</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">);</span>
<a name="c0-3759"></a><span class="lineno">3759</span>       <span class="cm">/* Pass the ignore return flag down to command substitutions */</span>
<a name="c0-3760"></a><span class="lineno">3760</span>       <span class="k">if</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span>  <span class="cm">/* XXX */</span>
<a name="c0-3761"></a><span class="lineno">3761</span>  <span class="n">comsub_ignore_return</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3762"></a><span class="lineno">3762</span>       <span class="n">words</span> <span class="o">=</span> <span class="n">expand_words</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">);</span>
<a name="c0-3763"></a><span class="lineno">3763</span>       <span class="k">if</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span>
<a name="c0-3764"></a><span class="lineno">3764</span>  <span class="n">comsub_ignore_return</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3765"></a><span class="lineno">3765</span>       <span class="n">current_fds_to_close</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3766"></a><span class="lineno">3766</span>     <span class="p">}</span>
<a name="c0-3767"></a><span class="lineno">3767</span>   <span class="k">else</span>
<a name="c0-3768"></a><span class="lineno">3768</span>     <span class="n">words</span> <span class="o">=</span> <span class="n">copy_word_list</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">);</span>
<a name="c0-3769"></a><span class="lineno">3769</span> 
<a name="c0-3770"></a><span class="lineno">3770</span>   <span class="cm">/* It is possible for WORDS not to have anything left in it.</span>
<a name="c0-3771"></a><span class="lineno">3771</span> <span class="cm">     Perhaps all the words consisted of `$foo', and there was</span>
<a name="c0-3772"></a><span class="lineno">3772</span> <span class="cm">     no variable `$foo'. */</span>
<a name="c0-3773"></a><span class="lineno">3773</span>   <span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3774"></a><span class="lineno">3774</span>     <span class="p">{</span>
<a name="c0-3775"></a><span class="lineno">3775</span>       <span class="n">this_command_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3776"></a><span class="lineno">3776</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">execute_null_command</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">,</span>
<a name="c0-3777"></a><span class="lineno">3777</span>             <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-3778"></a><span class="lineno">3778</span>             <span class="n">already_forked</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">async</span><span class="p">);</span>
<a name="c0-3779"></a><span class="lineno">3779</span>       <span class="k">if</span> <span class="p">(</span><span class="n">already_forked</span><span class="p">)</span>
<a name="c0-3780"></a><span class="lineno">3780</span>  <span class="n">exit</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3781"></a><span class="lineno">3781</span>       <span class="k">else</span>
<a name="c0-3782"></a><span class="lineno">3782</span>  <span class="p">{</span>
<a name="c0-3783"></a><span class="lineno">3783</span>    <span class="n">bind_lastarg</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-3784"></a><span class="lineno">3784</span>    <span class="n">set_pipestatus_from_exit</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3785"></a><span class="lineno">3785</span>    <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3786"></a><span class="lineno">3786</span>  <span class="p">}</span>
<a name="c0-3787"></a><span class="lineno">3787</span>     <span class="p">}</span>
<a name="c0-3788"></a><span class="lineno">3788</span> 
<a name="c0-3789"></a><span class="lineno">3789</span>   <span class="n">lastarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3790"></a><span class="lineno">3790</span> 
<a name="c0-3791"></a><span class="lineno">3791</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"simple-command"</span><span class="p">);</span>
<a name="c0-3792"></a><span class="lineno">3792</span> 
<a name="c0-3793"></a><span class="lineno">3793</span>   <span class="k">if</span> <span class="p">(</span><span class="n">echo_command_at_execute</span><span class="p">)</span>
<a name="c0-3794"></a><span class="lineno">3794</span>     <span class="n">xtrace_print_word_list</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-3795"></a><span class="lineno">3795</span> 
<a name="c0-3796"></a><span class="lineno">3796</span>   <span class="n">builtin</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3797"></a><span class="lineno">3797</span>   <span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHELL_VAR</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3798"></a><span class="lineno">3798</span>   <span class="k">if</span> <span class="p">((</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_NO_FUNCTIONS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3799"></a><span class="lineno">3799</span>     <span class="p">{</span>
<a name="c0-3800"></a><span class="lineno">3800</span>       <span class="cm">/* Posix.2 says special builtins are found before functions.  We</span>
<a name="c0-3801"></a><span class="lineno">3801</span> <span class="cm">   don't set builtin_is_special anywhere other than here, because</span>
<a name="c0-3802"></a><span class="lineno">3802</span> <span class="cm">   this path is followed only when the `command' builtin is *not*</span>
<a name="c0-3803"></a><span class="lineno">3803</span> <span class="cm">   being used, and we don't want to exit the shell if a special</span>
<a name="c0-3804"></a><span class="lineno">3804</span> <span class="cm">   builtin executed with `command builtin' fails.  `command' is not</span>
<a name="c0-3805"></a><span class="lineno">3805</span> <span class="cm">   a special builtin. */</span>
<a name="c0-3806"></a><span class="lineno">3806</span>       <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span><span class="p">)</span>
<a name="c0-3807"></a><span class="lineno">3807</span>  <span class="p">{</span>
<a name="c0-3808"></a><span class="lineno">3808</span>    <span class="n">builtin</span> <span class="o">=</span> <span class="n">find_special_builtin</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c0-3809"></a><span class="lineno">3809</span>    <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a name="c0-3810"></a><span class="lineno">3810</span>      <span class="n">builtin_is_special</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3811"></a><span class="lineno">3811</span>  <span class="p">}</span>
<a name="c0-3812"></a><span class="lineno">3812</span>       <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3813"></a><span class="lineno">3813</span>  <span class="n">func</span> <span class="o">=</span> <span class="n">find_function</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c0-3814"></a><span class="lineno">3814</span>     <span class="p">}</span>
<a name="c0-3815"></a><span class="lineno">3815</span> 
<a name="c0-3816"></a><span class="lineno">3816</span>   <span class="cm">/* In POSIX mode, assignment errors in the temporary environment cause a</span>
<a name="c0-3817"></a><span class="lineno">3817</span> <span class="cm">     non-interactive shell to exit. */</span>
<a name="c0-3818"></a><span class="lineno">3818</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin_is_special</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tempenv_assign_error</span><span class="p">)</span>
<a name="c0-3819"></a><span class="lineno">3819</span>     <span class="p">{</span>
<a name="c0-3820"></a><span class="lineno">3820</span>       <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-3821"></a><span class="lineno">3821</span>       <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-3822"></a><span class="lineno">3822</span>     <span class="p">}</span>
<a name="c0-3823"></a><span class="lineno">3823</span> 
<a name="c0-3824"></a><span class="lineno">3824</span>   <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_words</span><span class="p">,</span> <span class="n">words</span><span class="p">);</span>
<a name="c0-3825"></a><span class="lineno">3825</span>   <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3826"></a><span class="lineno">3826</span> 
<a name="c0-3827"></a><span class="lineno">3827</span>   <span class="cm">/* Bind the last word in this command to "$_" after execution. */</span>
<a name="c0-3828"></a><span class="lineno">3828</span>   <span class="k">for</span> <span class="p">(</span><span class="n">lastword</span> <span class="o">=</span> <span class="n">words</span><span class="p">;</span> <span class="n">lastword</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">lastword</span> <span class="o">=</span> <span class="n">lastword</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-3829"></a><span class="lineno">3829</span>     <span class="p">;</span>
<a name="c0-3830"></a><span class="lineno">3830</span>   <span class="n">lastarg</span> <span class="o">=</span> <span class="n">lastword</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">;</span>
<a name="c0-3831"></a><span class="lineno">3831</span> 
<a name="c0-3832"></a><span class="lineno">3832</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-3833"></a><span class="lineno">3833</span>   <span class="cm">/* Is this command a job control related thing? */</span>
<a name="c0-3834"></a><span class="lineno">3834</span>   <span class="k">if</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'%'</span> <span class="o">&amp;&amp;</span> <span class="n">already_forked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3835"></a><span class="lineno">3835</span>     <span class="p">{</span>
<a name="c0-3836"></a><span class="lineno">3836</span>       <span class="n">this_command_name</span> <span class="o">=</span> <span class="n">async</span> <span class="o">?</span> <span class="s">"bg"</span> <span class="o">:</span> <span class="s">"fg"</span><span class="p">;</span>
<a name="c0-3837"></a><span class="lineno">3837</span>       <span class="n">last_shell_builtin</span> <span class="o">=</span> <span class="n">this_shell_builtin</span><span class="p">;</span>
<a name="c0-3838"></a><span class="lineno">3838</span>       <span class="n">this_shell_builtin</span> <span class="o">=</span> <span class="n">builtin_address</span> <span class="p">(</span><span class="n">this_command_name</span><span class="p">);</span>
<a name="c0-3839"></a><span class="lineno">3839</span>       <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">this_shell_builtin</span><span class="p">)</span> <span class="p">(</span><span class="n">words</span><span class="p">);</span>
<a name="c0-3840"></a><span class="lineno">3840</span>       <span class="k">goto</span> <span class="n">return_result</span><span class="p">;</span>
<a name="c0-3841"></a><span class="lineno">3841</span>     <span class="p">}</span>
<a name="c0-3842"></a><span class="lineno">3842</span> 
<a name="c0-3843"></a><span class="lineno">3843</span>   <span class="cm">/* One other possiblilty.  The user may want to resume an existing job.</span>
<a name="c0-3844"></a><span class="lineno">3844</span> <span class="cm">     If they do, find out whether this word is a candidate for a running</span>
<a name="c0-3845"></a><span class="lineno">3845</span> <span class="cm">     job. */</span>
<a name="c0-3846"></a><span class="lineno">3846</span>   <span class="k">if</span> <span class="p">(</span><span class="n">job_control</span> <span class="o">&amp;&amp;</span> <span class="n">already_forked</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">async</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-3847"></a><span class="lineno">3847</span>  <span class="o">!</span><span class="n">first_word_quoted</span> <span class="o">&amp;&amp;</span>
<a name="c0-3848"></a><span class="lineno">3848</span>  <span class="o">!</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">&amp;&amp;</span>
<a name="c0-3849"></a><span class="lineno">3849</span>  <span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
<a name="c0-3850"></a><span class="lineno">3850</span>  <span class="o">!</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">redirects</span> <span class="o">&amp;&amp;</span>
<a name="c0-3851"></a><span class="lineno">3851</span>  <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-3852"></a><span class="lineno">3852</span>  <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-3853"></a><span class="lineno">3853</span>  <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"auto_resume"</span><span class="p">)))</span>
<a name="c0-3854"></a><span class="lineno">3854</span>     <span class="p">{</span>
<a name="c0-3855"></a><span class="lineno">3855</span>       <span class="kt">int</span> <span class="n">job</span><span class="p">,</span> <span class="n">jflags</span><span class="p">,</span> <span class="n">started_status</span><span class="p">;</span>
<a name="c0-3856"></a><span class="lineno">3856</span> 
<a name="c0-3857"></a><span class="lineno">3857</span>       <span class="n">jflags</span> <span class="o">=</span> <span class="n">JM_STOPPED</span><span class="o">|</span><span class="n">JM_FIRSTMATCH</span><span class="p">;</span>
<a name="c0-3858"></a><span class="lineno">3858</span>       <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s">"exact"</span><span class="p">))</span>
<a name="c0-3859"></a><span class="lineno">3859</span>  <span class="n">jflags</span> <span class="o">|=</span> <span class="n">JM_EXACT</span><span class="p">;</span>
<a name="c0-3860"></a><span class="lineno">3860</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="s">"substring"</span><span class="p">))</span>
<a name="c0-3861"></a><span class="lineno">3861</span>  <span class="n">jflags</span> <span class="o">|=</span> <span class="n">JM_SUBSTRING</span><span class="p">;</span>
<a name="c0-3862"></a><span class="lineno">3862</span>       <span class="k">else</span>
<a name="c0-3863"></a><span class="lineno">3863</span>  <span class="n">jflags</span> <span class="o">|=</span> <span class="n">JM_PREFIX</span><span class="p">;</span>
<a name="c0-3864"></a><span class="lineno">3864</span>       <span class="n">job</span> <span class="o">=</span> <span class="n">get_job_by_name</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">jflags</span><span class="p">);</span>
<a name="c0-3865"></a><span class="lineno">3865</span>       <span class="k">if</span> <span class="p">(</span><span class="n">job</span> <span class="o">!=</span> <span class="n">NO_JOB</span><span class="p">)</span>
<a name="c0-3866"></a><span class="lineno">3866</span>  <span class="p">{</span>
<a name="c0-3867"></a><span class="lineno">3867</span>    <span class="n">run_unwind_frame</span> <span class="p">(</span><span class="s">"simple-command"</span><span class="p">);</span>
<a name="c0-3868"></a><span class="lineno">3868</span>    <span class="n">this_command_name</span> <span class="o">=</span> <span class="s">"fg"</span><span class="p">;</span>
<a name="c0-3869"></a><span class="lineno">3869</span>    <span class="n">last_shell_builtin</span> <span class="o">=</span> <span class="n">this_shell_builtin</span><span class="p">;</span>
<a name="c0-3870"></a><span class="lineno">3870</span>    <span class="n">this_shell_builtin</span> <span class="o">=</span> <span class="n">builtin_address</span> <span class="p">(</span><span class="s">"fg"</span><span class="p">);</span>
<a name="c0-3871"></a><span class="lineno">3871</span> 
<a name="c0-3872"></a><span class="lineno">3872</span>    <span class="n">started_status</span> <span class="o">=</span> <span class="n">start_job</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-3873"></a><span class="lineno">3873</span>    <span class="k">return</span> <span class="p">((</span><span class="n">started_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">EXECUTION_FAILURE</span> <span class="o">:</span> <span class="n">started_status</span><span class="p">);</span>
<a name="c0-3874"></a><span class="lineno">3874</span>  <span class="p">}</span>
<a name="c0-3875"></a><span class="lineno">3875</span>     <span class="p">}</span>
<a name="c0-3876"></a><span class="lineno">3876</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-3877"></a><span class="lineno">3877</span> 
<a name="c0-3878"></a><span class="lineno">3878</span> <span class="nl">run_builtin:</span>
<a name="c0-3879"></a><span class="lineno">3879</span>   <span class="cm">/* Remember the name of this command globally. */</span>
<a name="c0-3880"></a><span class="lineno">3880</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">;</span>
<a name="c0-3881"></a><span class="lineno">3881</span> 
<a name="c0-3882"></a><span class="lineno">3882</span>   <span class="n">QUIT</span><span class="p">;</span>
<a name="c0-3883"></a><span class="lineno">3883</span> 
<a name="c0-3884"></a><span class="lineno">3884</span>   <span class="cm">/* This command could be a shell builtin or a user-defined function.</span>
<a name="c0-3885"></a><span class="lineno">3885</span> <span class="cm">     We have already found special builtins by this time, so we do not</span>
<a name="c0-3886"></a><span class="lineno">3886</span> <span class="cm">     set builtin_is_special.  If this is a function or builtin, and we</span>
<a name="c0-3887"></a><span class="lineno">3887</span> <span class="cm">     have pipes, then fork a subshell in here.  Otherwise, just execute</span>
<a name="c0-3888"></a><span class="lineno">3888</span> <span class="cm">     the command directly. */</span>
<a name="c0-3889"></a><span class="lineno">3889</span>   <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">builtin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3890"></a><span class="lineno">3890</span>     <span class="n">builtin</span> <span class="o">=</span> <span class="n">find_shell_builtin</span> <span class="p">(</span><span class="n">this_command_name</span><span class="p">);</span>
<a name="c0-3891"></a><span class="lineno">3891</span> 
<a name="c0-3892"></a><span class="lineno">3892</span>   <span class="n">last_shell_builtin</span> <span class="o">=</span> <span class="n">this_shell_builtin</span><span class="p">;</span>
<a name="c0-3893"></a><span class="lineno">3893</span>   <span class="n">this_shell_builtin</span> <span class="o">=</span> <span class="n">builtin</span><span class="p">;</span>
<a name="c0-3894"></a><span class="lineno">3894</span> 
<a name="c0-3895"></a><span class="lineno">3895</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span> <span class="o">||</span> <span class="n">func</span><span class="p">)</span>
<a name="c0-3896"></a><span class="lineno">3896</span>     <span class="p">{</span>
<a name="c0-3897"></a><span class="lineno">3897</span>       <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a name="c0-3898"></a><span class="lineno">3898</span>         <span class="p">{</span>
<a name="c0-3899"></a><span class="lineno">3899</span>    <span class="n">old_builtin</span> <span class="o">=</span> <span class="n">executing_builtin</span><span class="p">;</span>
<a name="c0-3900"></a><span class="lineno">3900</span>    <span class="n">old_command_builtin</span> <span class="o">=</span> <span class="n">executing_command_builtin</span><span class="p">;</span>
<a name="c0-3901"></a><span class="lineno">3901</span>    <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">executing_builtin</span><span class="p">);</span> <span class="cm">/* modified in execute_builtin */</span>
<a name="c0-3902"></a><span class="lineno">3902</span>    <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">executing_command_builtin</span><span class="p">);</span> <span class="cm">/* ditto */</span>
<a name="c0-3903"></a><span class="lineno">3903</span>         <span class="p">}</span>
<a name="c0-3904"></a><span class="lineno">3904</span>       <span class="k">if</span> <span class="p">(</span><span class="n">already_forked</span><span class="p">)</span>
<a name="c0-3905"></a><span class="lineno">3905</span>  <span class="p">{</span>
<a name="c0-3906"></a><span class="lineno">3906</span>    <span class="cm">/* reset_terminating_signals (); */</span> <span class="cm">/* XXX */</span>
<a name="c0-3907"></a><span class="lineno">3907</span>    <span class="cm">/* Reset the signal handlers in the child, but don't free the</span>
<a name="c0-3908"></a><span class="lineno">3908</span> <span class="cm">       trap strings.  Set a flag noting that we have to free the</span>
<a name="c0-3909"></a><span class="lineno">3909</span> <span class="cm">       trap strings if we run trap to change a signal disposition. */</span>
<a name="c0-3910"></a><span class="lineno">3910</span>    <span class="n">reset_signal_handlers</span> <span class="p">();</span>
<a name="c0-3911"></a><span class="lineno">3911</span>    <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_RESETTRAP</span><span class="p">;</span>
<a name="c0-3912"></a><span class="lineno">3912</span> 
<a name="c0-3913"></a><span class="lineno">3913</span>    <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-3914"></a><span class="lineno">3914</span>      <span class="p">{</span>
<a name="c0-3915"></a><span class="lineno">3915</span>        <span class="k">if</span> <span class="p">((</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-3916"></a><span class="lineno">3916</span>        <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-3917"></a><span class="lineno">3917</span>        <span class="p">(</span><span class="n">stdin_redirects</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a name="c0-3918"></a><span class="lineno">3918</span>    <span class="n">async_redirect_stdin</span> <span class="p">();</span>
<a name="c0-3919"></a><span class="lineno">3919</span>        <span class="n">setup_async_signals</span> <span class="p">();</span>
<a name="c0-3920"></a><span class="lineno">3920</span>      <span class="p">}</span>
<a name="c0-3921"></a><span class="lineno">3921</span> 
<a name="c0-3922"></a><span class="lineno">3922</span>    <span class="n">subshell_level</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3923"></a><span class="lineno">3923</span>    <span class="n">execute_subshell_builtin_or_function</span>
<a name="c0-3924"></a><span class="lineno">3924</span>      <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">,</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span>
<a name="c0-3925"></a><span class="lineno">3925</span>       <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span>
<a name="c0-3926"></a><span class="lineno">3926</span>       <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<a name="c0-3927"></a><span class="lineno">3927</span>    <span class="n">subshell_level</span><span class="o">--</span><span class="p">;</span>
<a name="c0-3928"></a><span class="lineno">3928</span>  <span class="p">}</span>
<a name="c0-3929"></a><span class="lineno">3929</span>       <span class="k">else</span>
<a name="c0-3930"></a><span class="lineno">3930</span>  <span class="p">{</span>
<a name="c0-3931"></a><span class="lineno">3931</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">execute_builtin_or_function</span>
<a name="c0-3932"></a><span class="lineno">3932</span>      <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span>
<a name="c0-3933"></a><span class="lineno">3933</span>       <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<a name="c0-3934"></a><span class="lineno">3934</span>    <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a name="c0-3935"></a><span class="lineno">3935</span>      <span class="p">{</span>
<a name="c0-3936"></a><span class="lineno">3936</span>        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">EX_SHERRBASE</span><span class="p">)</span>
<a name="c0-3937"></a><span class="lineno">3937</span>    <span class="p">{</span>
<a name="c0-3938"></a><span class="lineno">3938</span>      <span class="n">result</span> <span class="o">=</span> <span class="n">builtin_status</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3939"></a><span class="lineno">3939</span>      <span class="k">if</span> <span class="p">(</span><span class="n">builtin_is_special</span><span class="p">)</span>
<a name="c0-3940"></a><span class="lineno">3940</span>        <span class="n">special_builtin_failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3941"></a><span class="lineno">3941</span>    <span class="p">}</span>
<a name="c0-3942"></a><span class="lineno">3942</span>        <span class="cm">/* In POSIX mode, if there are assignment statements preceding</span>
<a name="c0-3943"></a><span class="lineno">3943</span> <span class="cm">     a special builtin, they persist after the builtin</span>
<a name="c0-3944"></a><span class="lineno">3944</span> <span class="cm">     completes. */</span>
<a name="c0-3945"></a><span class="lineno">3945</span>        <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">builtin_is_special</span> <span class="o">&amp;&amp;</span> <span class="n">temporary_env</span><span class="p">)</span>
<a name="c0-3946"></a><span class="lineno">3946</span>    <span class="n">merge_temporary_env</span> <span class="p">();</span>
<a name="c0-3947"></a><span class="lineno">3947</span>      <span class="p">}</span>
<a name="c0-3948"></a><span class="lineno">3948</span>    <span class="k">else</span>   <span class="cm">/* function */</span>
<a name="c0-3949"></a><span class="lineno">3949</span>      <span class="p">{</span>
<a name="c0-3950"></a><span class="lineno">3950</span>        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">EX_USAGE</span><span class="p">)</span>
<a name="c0-3951"></a><span class="lineno">3951</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">EX_BADUSAGE</span><span class="p">;</span>
<a name="c0-3952"></a><span class="lineno">3952</span>        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">EX_SHERRBASE</span><span class="p">)</span>
<a name="c0-3953"></a><span class="lineno">3953</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-3954"></a><span class="lineno">3954</span>      <span class="p">}</span>
<a name="c0-3955"></a><span class="lineno">3955</span> 
<a name="c0-3956"></a><span class="lineno">3956</span>    <span class="n">set_pipestatus_from_exit</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3957"></a><span class="lineno">3957</span> 
<a name="c0-3958"></a><span class="lineno">3958</span>    <span class="k">goto</span> <span class="n">return_result</span><span class="p">;</span>
<a name="c0-3959"></a><span class="lineno">3959</span>  <span class="p">}</span>
<a name="c0-3960"></a><span class="lineno">3960</span>     <span class="p">}</span>
<a name="c0-3961"></a><span class="lineno">3961</span> 
<a name="c0-3962"></a><span class="lineno">3962</span>   <span class="k">if</span> <span class="p">(</span><span class="n">autocd</span> <span class="o">&amp;&amp;</span> <span class="n">interactive</span> <span class="o">&amp;&amp;</span> <span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span> <span class="o">&amp;&amp;</span> <span class="n">is_dirname</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">))</span>
<a name="c0-3963"></a><span class="lineno">3963</span>     <span class="p">{</span>
<a name="c0-3964"></a><span class="lineno">3964</span>       <span class="n">words</span> <span class="o">=</span> <span class="n">make_word_list</span> <span class="p">(</span><span class="n">make_word</span> <span class="p">(</span><span class="s">"cd"</span><span class="p">),</span> <span class="n">words</span><span class="p">);</span>
<a name="c0-3965"></a><span class="lineno">3965</span>       <span class="n">xtrace_print_word_list</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3966"></a><span class="lineno">3966</span>       <span class="k">goto</span> <span class="n">run_builtin</span><span class="p">;</span>
<a name="c0-3967"></a><span class="lineno">3967</span>     <span class="p">}</span>
<a name="c0-3968"></a><span class="lineno">3968</span> 
<a name="c0-3969"></a><span class="lineno">3969</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command_line</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3970"></a><span class="lineno">3970</span>     <span class="n">command_line</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">the_printed_command_except_trap</span><span class="p">);</span>
<a name="c0-3971"></a><span class="lineno">3971</span> 
<a name="c0-3972"></a><span class="lineno">3972</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-3973"></a><span class="lineno">3973</span>   <span class="k">if</span> <span class="p">((</span><span class="n">subshell_environment</span> <span class="o">&amp;</span> <span class="n">SUBSHELL_COMSUB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_NO_FORK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fifos_pending</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3974"></a><span class="lineno">3974</span>     <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_NO_FORK</span><span class="p">;</span>
<a name="c0-3975"></a><span class="lineno">3975</span> <span class="cp">#endif</span>
<a name="c0-3976"></a><span class="lineno">3976</span> 
<a name="c0-3977"></a><span class="lineno">3977</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">execute_disk_command</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">redirects</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span>
<a name="c0-3978"></a><span class="lineno">3978</span>      <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span>
<a name="c0-3979"></a><span class="lineno">3979</span>      <span class="n">simple_command</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<a name="c0-3980"></a><span class="lineno">3980</span> 
<a name="c0-3981"></a><span class="lineno">3981</span>  <span class="nl">return_result:</span>
<a name="c0-3982"></a><span class="lineno">3982</span>   <span class="n">bind_lastarg</span> <span class="p">(</span><span class="n">lastarg</span><span class="p">);</span>
<a name="c0-3983"></a><span class="lineno">3983</span>   <span class="n">FREE</span> <span class="p">(</span><span class="n">command_line</span><span class="p">);</span>
<a name="c0-3984"></a><span class="lineno">3984</span>   <span class="n">dispose_words</span> <span class="p">(</span><span class="n">words</span><span class="p">);</span>
<a name="c0-3985"></a><span class="lineno">3985</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a name="c0-3986"></a><span class="lineno">3986</span>     <span class="p">{</span>
<a name="c0-3987"></a><span class="lineno">3987</span>       <span class="n">executing_builtin</span> <span class="o">=</span> <span class="n">old_builtin</span><span class="p">;</span>
<a name="c0-3988"></a><span class="lineno">3988</span>       <span class="n">executing_command_builtin</span> <span class="o">=</span> <span class="n">old_command_builtin</span><span class="p">;</span>
<a name="c0-3989"></a><span class="lineno">3989</span>     <span class="p">}</span>
<a name="c0-3990"></a><span class="lineno">3990</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"simple-command"</span><span class="p">);</span>
<a name="c0-3991"></a><span class="lineno">3991</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* points to freed memory now */</span>
<a name="c0-3992"></a><span class="lineno">3992</span>   <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3993"></a><span class="lineno">3993</span> <span class="p">}</span>
<a name="c0-3994"></a><span class="lineno">3994</span> 
<a name="c0-3995"></a><span class="lineno">3995</span> <span class="cm">/* Translate the special builtin exit statuses.  We don't really need a</span>
<a name="c0-3996"></a><span class="lineno">3996</span> <span class="cm">   function for this; it's a placeholder for future work. */</span>
<a name="c0-3997"></a><span class="lineno">3997</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-3998"></a><span class="lineno">3998</span> <span class="n">builtin_status</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a name="c0-3999"></a><span class="lineno">3999</span>      <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-4000"></a><span class="lineno">4000</span> <span class="p">{</span>
<a name="c0-4001"></a><span class="lineno">4001</span>   <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
<a name="c0-4002"></a><span class="lineno">4002</span> 
<a name="c0-4003"></a><span class="lineno">4003</span>   <span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a name="c0-4004"></a><span class="lineno">4004</span>     <span class="p">{</span>
<a name="c0-4005"></a><span class="lineno">4005</span>     <span class="k">case</span> <span class="n">EX_USAGE</span>:
<a name="c0-4006"></a><span class="lineno">4006</span>       <span class="n">r</span> <span class="o">=</span> <span class="n">EX_BADUSAGE</span><span class="p">;</span>
<a name="c0-4007"></a><span class="lineno">4007</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-4008"></a><span class="lineno">4008</span>     <span class="k">case</span> <span class="n">EX_REDIRFAIL</span>:
<a name="c0-4009"></a><span class="lineno">4009</span>     <span class="k">case</span> <span class="n">EX_BADSYNTAX</span>:
<a name="c0-4010"></a><span class="lineno">4010</span>     <span class="k">case</span> <span class="n">EX_BADASSIGN</span>:
<a name="c0-4011"></a><span class="lineno">4011</span>     <span class="k">case</span> <span class="n">EX_EXPFAIL</span>:
<a name="c0-4012"></a><span class="lineno">4012</span>       <span class="n">r</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-4013"></a><span class="lineno">4013</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-4014"></a><span class="lineno">4014</span>     <span class="nl">default:</span>
<a name="c0-4015"></a><span class="lineno">4015</span>       <span class="n">r</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-4016"></a><span class="lineno">4016</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-4017"></a><span class="lineno">4017</span>     <span class="p">}</span>
<a name="c0-4018"></a><span class="lineno">4018</span>   <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">);</span>
<a name="c0-4019"></a><span class="lineno">4019</span> <span class="p">}</span>
<a name="c0-4020"></a><span class="lineno">4020</span> 
<a name="c0-4021"></a><span class="lineno">4021</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-4022"></a><span class="lineno">4022</span> <span class="n">execute_builtin</span> <span class="p">(</span><span class="n">builtin</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">subshell</span><span class="p">)</span>
<a name="c0-4023"></a><span class="lineno">4023</span>      <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="n">builtin</span><span class="p">;</span>
<a name="c0-4024"></a><span class="lineno">4024</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-4025"></a><span class="lineno">4025</span>      <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">subshell</span><span class="p">;</span>
<a name="c0-4026"></a><span class="lineno">4026</span> <span class="p">{</span>
<a name="c0-4027"></a><span class="lineno">4027</span>   <span class="kt">int</span> <span class="n">old_e_flag</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">eval_unwind</span><span class="p">;</span>
<a name="c0-4028"></a><span class="lineno">4028</span>   <span class="kt">int</span> <span class="n">isbltinenv</span><span class="p">;</span>
<a name="c0-4029"></a><span class="lineno">4029</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">error_trap</span><span class="p">;</span>
<a name="c0-4030"></a><span class="lineno">4030</span> 
<a name="c0-4031"></a><span class="lineno">4031</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-4032"></a><span class="lineno">4032</span> <span class="c">  /* XXX -- added 12/11 */</span>
<a name="c0-4033"></a><span class="lineno">4033</span> <span class="c">  terminate_immediately++;</span>
<a name="c0-4034"></a><span class="lineno">4034</span> <span class="cp">#endif</span>
<a name="c0-4035"></a><span class="lineno">4035</span> 
<a name="c0-4036"></a><span class="lineno">4036</span>   <span class="n">error_trap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4037"></a><span class="lineno">4037</span>   <span class="n">old_e_flag</span> <span class="o">=</span> <span class="n">exit_immediately_on_error</span><span class="p">;</span>
<a name="c0-4038"></a><span class="lineno">4038</span>   <span class="cm">/* The eval builtin calls parse_and_execute, which does not know about</span>
<a name="c0-4039"></a><span class="lineno">4039</span> <span class="cm">     the setting of flags, and always calls the execution functions with</span>
<a name="c0-4040"></a><span class="lineno">4040</span> <span class="cm">     flags that will exit the shell on an error if -e is set.  If the</span>
<a name="c0-4041"></a><span class="lineno">4041</span> <span class="cm">     eval builtin is being called, and we're supposed to ignore the exit</span>
<a name="c0-4042"></a><span class="lineno">4042</span> <span class="cm">     value of the command, we turn the -e flag off ourselves and disable</span>
<a name="c0-4043"></a><span class="lineno">4043</span> <span class="cm">     the ERR trap, then restore them when the command completes.  This is</span>
<a name="c0-4044"></a><span class="lineno">4044</span> <span class="cm">     also a problem (as below) for the command and source/. builtins. */</span>
<a name="c0-4045"></a><span class="lineno">4045</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-4046"></a><span class="lineno">4046</span>  <span class="p">(</span><span class="n">builtin</span> <span class="o">==</span> <span class="n">eval_builtin</span> <span class="o">||</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">command_builtin</span> <span class="o">||</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">source_builtin</span><span class="p">))</span>
<a name="c0-4047"></a><span class="lineno">4047</span>     <span class="p">{</span>
<a name="c0-4048"></a><span class="lineno">4048</span>       <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"eval_builtin"</span><span class="p">);</span>
<a name="c0-4049"></a><span class="lineno">4049</span>       <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">exit_immediately_on_error</span><span class="p">);</span>
<a name="c0-4050"></a><span class="lineno">4050</span>       <span class="n">error_trap</span> <span class="o">=</span> <span class="n">TRAP_STRING</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">);</span>
<a name="c0-4051"></a><span class="lineno">4051</span>       <span class="k">if</span> <span class="p">(</span><span class="n">error_trap</span><span class="p">)</span>
<a name="c0-4052"></a><span class="lineno">4052</span>  <span class="p">{</span>
<a name="c0-4053"></a><span class="lineno">4053</span>    <span class="n">error_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4054"></a><span class="lineno">4054</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">xfree</span><span class="p">,</span> <span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4055"></a><span class="lineno">4055</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">set_error_trap</span><span class="p">,</span> <span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4056"></a><span class="lineno">4056</span>    <span class="n">restore_default_signal</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">);</span>
<a name="c0-4057"></a><span class="lineno">4057</span>  <span class="p">}</span>
<a name="c0-4058"></a><span class="lineno">4058</span>       <span class="n">exit_immediately_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4059"></a><span class="lineno">4059</span>       <span class="n">eval_unwind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-4060"></a><span class="lineno">4060</span>     <span class="p">}</span>
<a name="c0-4061"></a><span class="lineno">4061</span>   <span class="k">else</span>
<a name="c0-4062"></a><span class="lineno">4062</span>     <span class="n">eval_unwind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4063"></a><span class="lineno">4063</span> 
<a name="c0-4064"></a><span class="lineno">4064</span>   <span class="cm">/* The temporary environment for a builtin is supposed to apply to</span>
<a name="c0-4065"></a><span class="lineno">4065</span> <span class="cm">     all commands executed by that builtin.  Currently, this is a</span>
<a name="c0-4066"></a><span class="lineno">4066</span> <span class="cm">     problem only with the `unset', `source' and `eval' builtins. */</span>
<a name="c0-4067"></a><span class="lineno">4067</span> 
<a name="c0-4068"></a><span class="lineno">4068</span>   <span class="n">isbltinenv</span> <span class="o">=</span> <span class="p">(</span><span class="n">builtin</span> <span class="o">==</span> <span class="n">source_builtin</span> <span class="o">||</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">eval_builtin</span> <span class="o">||</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">unset_builtin</span><span class="p">);</span>
<a name="c0-4069"></a><span class="lineno">4069</span> 
<a name="c0-4070"></a><span class="lineno">4070</span>   <span class="k">if</span> <span class="p">(</span><span class="n">isbltinenv</span><span class="p">)</span>
<a name="c0-4071"></a><span class="lineno">4071</span>     <span class="p">{</span>
<a name="c0-4072"></a><span class="lineno">4072</span>       <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4073"></a><span class="lineno">4073</span>  <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"builtin_env"</span><span class="p">);</span>
<a name="c0-4074"></a><span class="lineno">4074</span> 
<a name="c0-4075"></a><span class="lineno">4075</span>       <span class="k">if</span> <span class="p">(</span><span class="n">temporary_env</span><span class="p">)</span>
<a name="c0-4076"></a><span class="lineno">4076</span>  <span class="p">{</span>
<a name="c0-4077"></a><span class="lineno">4077</span>    <span class="n">push_scope</span> <span class="p">(</span><span class="n">VC_BLTNENV</span><span class="p">,</span> <span class="n">temporary_env</span><span class="p">);</span>
<a name="c0-4078"></a><span class="lineno">4078</span>    <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4079"></a><span class="lineno">4079</span>      <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">pop_scope</span><span class="p">,</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_COMMAND_BUILTIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="s">"1"</span><span class="p">);</span>
<a name="c0-4080"></a><span class="lineno">4080</span>           <span class="n">temporary_env</span> <span class="o">=</span> <span class="p">(</span><span class="n">HASH_TABLE</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>   
<a name="c0-4081"></a><span class="lineno">4081</span>  <span class="p">}</span>
<a name="c0-4082"></a><span class="lineno">4082</span>     <span class="p">}</span>
<a name="c0-4083"></a><span class="lineno">4083</span> 
<a name="c0-4084"></a><span class="lineno">4084</span>   <span class="cm">/* `return' does a longjmp() back to a saved environment in execute_function.</span>
<a name="c0-4085"></a><span class="lineno">4085</span> <span class="cm">     If a variable assignment list preceded the command, and the shell is</span>
<a name="c0-4086"></a><span class="lineno">4086</span> <span class="cm">     running in POSIX mode, we need to merge that into the shell_variables</span>
<a name="c0-4087"></a><span class="lineno">4087</span> <span class="cm">     table, since `return' is a POSIX special builtin. */</span>
<a name="c0-4088"></a><span class="lineno">4088</span>   <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">return_builtin</span> <span class="o">&amp;&amp;</span> <span class="n">temporary_env</span><span class="p">)</span>
<a name="c0-4089"></a><span class="lineno">4089</span>     <span class="p">{</span>
<a name="c0-4090"></a><span class="lineno">4090</span>       <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"return_temp_env"</span><span class="p">);</span>
<a name="c0-4091"></a><span class="lineno">4091</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">merge_temporary_env</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-4092"></a><span class="lineno">4092</span>     <span class="p">}</span>
<a name="c0-4093"></a><span class="lineno">4093</span> 
<a name="c0-4094"></a><span class="lineno">4094</span>   <span class="n">executing_builtin</span><span class="o">++</span><span class="p">;</span>
<a name="c0-4095"></a><span class="lineno">4095</span>   <span class="n">executing_command_builtin</span> <span class="o">|=</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">command_builtin</span><span class="p">;</span>
<a name="c0-4096"></a><span class="lineno">4096</span>   <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">builtin</span><span class="p">)</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
<a name="c0-4097"></a><span class="lineno">4097</span> 
<a name="c0-4098"></a><span class="lineno">4098</span>   <span class="cm">/* This shouldn't happen, but in case `return' comes back instead of</span>
<a name="c0-4099"></a><span class="lineno">4099</span> <span class="cm">     longjmp'ing, we need to unwind. */</span>
<a name="c0-4100"></a><span class="lineno">4100</span>   <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">return_builtin</span> <span class="o">&amp;&amp;</span> <span class="n">temporary_env</span><span class="p">)</span>
<a name="c0-4101"></a><span class="lineno">4101</span>     <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"return_temp_env"</span><span class="p">);</span>
<a name="c0-4102"></a><span class="lineno">4102</span> 
<a name="c0-4103"></a><span class="lineno">4103</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">isbltinenv</span><span class="p">)</span>
<a name="c0-4104"></a><span class="lineno">4104</span>     <span class="n">run_unwind_frame</span> <span class="p">(</span><span class="s">"builtin_env"</span><span class="p">);</span>
<a name="c0-4105"></a><span class="lineno">4105</span> 
<a name="c0-4106"></a><span class="lineno">4106</span>   <span class="k">if</span> <span class="p">(</span><span class="n">eval_unwind</span><span class="p">)</span>
<a name="c0-4107"></a><span class="lineno">4107</span>     <span class="p">{</span>
<a name="c0-4108"></a><span class="lineno">4108</span>       <span class="n">exit_immediately_on_error</span> <span class="o">+=</span> <span class="n">old_e_flag</span><span class="p">;</span>
<a name="c0-4109"></a><span class="lineno">4109</span>       <span class="k">if</span> <span class="p">(</span><span class="n">error_trap</span><span class="p">)</span>
<a name="c0-4110"></a><span class="lineno">4110</span>  <span class="p">{</span>
<a name="c0-4111"></a><span class="lineno">4111</span>    <span class="n">set_error_trap</span> <span class="p">(</span><span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4112"></a><span class="lineno">4112</span>    <span class="n">xfree</span> <span class="p">(</span><span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4113"></a><span class="lineno">4113</span>  <span class="p">}</span>
<a name="c0-4114"></a><span class="lineno">4114</span>       <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"eval_builtin"</span><span class="p">);</span>
<a name="c0-4115"></a><span class="lineno">4115</span>     <span class="p">}</span>
<a name="c0-4116"></a><span class="lineno">4116</span> 
<a name="c0-4117"></a><span class="lineno">4117</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-4118"></a><span class="lineno">4118</span> <span class="c">  /* XXX -- added 12/11 */</span>
<a name="c0-4119"></a><span class="lineno">4119</span> <span class="c">  terminate_immediately--;</span>
<a name="c0-4120"></a><span class="lineno">4120</span> <span class="cp">#endif</span>
<a name="c0-4121"></a><span class="lineno">4121</span> 
<a name="c0-4122"></a><span class="lineno">4122</span>   <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-4123"></a><span class="lineno">4123</span> <span class="p">}</span>
<a name="c0-4124"></a><span class="lineno">4124</span> 
<a name="c0-4125"></a><span class="lineno">4125</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-4126"></a><span class="lineno">4126</span> <span class="n">execute_function</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">subshell</span><span class="p">)</span>
<a name="c0-4127"></a><span class="lineno">4127</span>      <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<a name="c0-4128"></a><span class="lineno">4128</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-4129"></a><span class="lineno">4129</span>      <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="c0-4130"></a><span class="lineno">4130</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-4131"></a><span class="lineno">4131</span>      <span class="kt">int</span> <span class="n">async</span><span class="p">,</span> <span class="n">subshell</span><span class="p">;</span>
<a name="c0-4132"></a><span class="lineno">4132</span> <span class="p">{</span>
<a name="c0-4133"></a><span class="lineno">4133</span>   <span class="kt">int</span> <span class="n">return_val</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-4134"></a><span class="lineno">4134</span>   <span class="n">COMMAND</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span> <span class="o">*</span><span class="n">save_current</span><span class="p">;</span>
<a name="c0-4135"></a><span class="lineno">4135</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">debug_trap</span><span class="p">,</span> <span class="o">*</span><span class="n">error_trap</span><span class="p">,</span> <span class="o">*</span><span class="n">return_trap</span><span class="p">;</span>
<a name="c0-4136"></a><span class="lineno">4136</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-4137"></a><span class="lineno">4137</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">funcname_v</span><span class="p">,</span> <span class="o">*</span><span class="n">nfv</span><span class="p">,</span> <span class="o">*</span><span class="n">bash_source_v</span><span class="p">,</span> <span class="o">*</span><span class="n">bash_lineno_v</span><span class="p">;</span>
<a name="c0-4138"></a><span class="lineno">4138</span>   <span class="n">ARRAY</span> <span class="o">*</span><span class="n">funcname_a</span><span class="p">;</span>
<a name="c0-4139"></a><span class="lineno">4139</span>   <span class="k">volatile</span> <span class="n">ARRAY</span> <span class="o">*</span><span class="n">bash_source_a</span><span class="p">;</span>
<a name="c0-4140"></a><span class="lineno">4140</span>   <span class="k">volatile</span> <span class="n">ARRAY</span> <span class="o">*</span><span class="n">bash_lineno_a</span><span class="p">;</span>
<a name="c0-4141"></a><span class="lineno">4141</span> <span class="cp">#endif</span>
<a name="c0-4142"></a><span class="lineno">4142</span>   <span class="n">FUNCTION_DEF</span> <span class="o">*</span><span class="n">shell_fn</span><span class="p">;</span>
<a name="c0-4143"></a><span class="lineno">4143</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">sfile</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
<a name="c0-4144"></a><span class="lineno">4144</span> 
<a name="c0-4145"></a><span class="lineno">4145</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
<a name="c0-4146"></a><span class="lineno">4146</span> 
<a name="c0-4147"></a><span class="lineno">4147</span>   <span class="k">if</span> <span class="p">(</span><span class="n">funcnest_max</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">funcnest</span> <span class="o">&gt;=</span> <span class="n">funcnest_max</span><span class="p">)</span>
<a name="c0-4148"></a><span class="lineno">4148</span>     <span class="p">{</span>
<a name="c0-4149"></a><span class="lineno">4149</span>       <span class="n">internal_error</span> <span class="p">(</span><span class="s">"%s: maximum function nesting level exceeded (%d)"</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">funcnest</span><span class="p">);</span>
<a name="c0-4150"></a><span class="lineno">4150</span>       <span class="n">funcnest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XXX - should we reset it somewhere else? */</span>
<a name="c0-4151"></a><span class="lineno">4151</span>       <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">DISCARD</span><span class="p">);</span>
<a name="c0-4152"></a><span class="lineno">4152</span>     <span class="p">}</span>
<a name="c0-4153"></a><span class="lineno">4153</span> 
<a name="c0-4154"></a><span class="lineno">4154</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-4155"></a><span class="lineno">4155</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"FUNCNAME"</span><span class="p">,</span> <span class="n">funcname_v</span><span class="p">,</span> <span class="n">funcname_a</span><span class="p">);</span>
<a name="c0-4156"></a><span class="lineno">4156</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"BASH_SOURCE"</span><span class="p">,</span> <span class="n">bash_source_v</span><span class="p">,</span> <span class="n">bash_source_a</span><span class="p">);</span>
<a name="c0-4157"></a><span class="lineno">4157</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"BASH_LINENO"</span><span class="p">,</span> <span class="n">bash_lineno_v</span><span class="p">,</span> <span class="n">bash_lineno_a</span><span class="p">);</span>
<a name="c0-4158"></a><span class="lineno">4158</span> <span class="cp">#endif</span>
<a name="c0-4159"></a><span class="lineno">4159</span> 
<a name="c0-4160"></a><span class="lineno">4160</span>   <span class="n">tc</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="n">copy_command</span> <span class="p">(</span><span class="n">function_cell</span> <span class="p">(</span><span class="n">var</span><span class="p">));</span>
<a name="c0-4161"></a><span class="lineno">4161</span>   <span class="k">if</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">))</span>
<a name="c0-4162"></a><span class="lineno">4162</span>     <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_IGNORE_RETURN</span><span class="p">;</span>
<a name="c0-4163"></a><span class="lineno">4163</span> 
<a name="c0-4164"></a><span class="lineno">4164</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4165"></a><span class="lineno">4165</span>     <span class="p">{</span>
<a name="c0-4166"></a><span class="lineno">4166</span>       <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"function_calling"</span><span class="p">);</span>
<a name="c0-4167"></a><span class="lineno">4167</span>       <span class="n">push_context</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">subshell</span><span class="p">,</span> <span class="n">temporary_env</span><span class="p">);</span>
<a name="c0-4168"></a><span class="lineno">4168</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">pop_context</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-4169"></a><span class="lineno">4169</span>       <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">line_number</span><span class="p">);</span>
<a name="c0-4170"></a><span class="lineno">4170</span>       <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">return_catch_flag</span><span class="p">);</span>
<a name="c0-4171"></a><span class="lineno">4171</span>       <span class="n">unwind_protect_jmp_buf</span> <span class="p">(</span><span class="n">return_catch</span><span class="p">);</span>
<a name="c0-4172"></a><span class="lineno">4172</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_command</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tc</span><span class="p">);</span>
<a name="c0-4173"></a><span class="lineno">4173</span>       <span class="n">unwind_protect_pointer</span> <span class="p">(</span><span class="n">this_shell_function</span><span class="p">);</span>
<a name="c0-4174"></a><span class="lineno">4174</span>       <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">loop_level</span><span class="p">);</span>
<a name="c0-4175"></a><span class="lineno">4175</span>       <span class="n">unwind_protect_int</span> <span class="p">(</span><span class="n">funcnest</span><span class="p">);</span>
<a name="c0-4176"></a><span class="lineno">4176</span>     <span class="p">}</span>
<a name="c0-4177"></a><span class="lineno">4177</span>   <span class="k">else</span>
<a name="c0-4178"></a><span class="lineno">4178</span>     <span class="n">push_context</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">subshell</span><span class="p">,</span> <span class="n">temporary_env</span><span class="p">);</span>  <span class="cm">/* don't unwind-protect for subshells */</span>
<a name="c0-4179"></a><span class="lineno">4179</span> 
<a name="c0-4180"></a><span class="lineno">4180</span>   <span class="n">temporary_env</span> <span class="o">=</span> <span class="p">(</span><span class="n">HASH_TABLE</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4181"></a><span class="lineno">4181</span> 
<a name="c0-4182"></a><span class="lineno">4182</span>   <span class="n">this_shell_function</span> <span class="o">=</span> <span class="n">var</span><span class="p">;</span>
<a name="c0-4183"></a><span class="lineno">4183</span>   <span class="n">make_funcname_visible</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-4184"></a><span class="lineno">4184</span> 
<a name="c0-4185"></a><span class="lineno">4185</span>   <span class="n">debug_trap</span> <span class="o">=</span> <span class="n">TRAP_STRING</span><span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">);</span>
<a name="c0-4186"></a><span class="lineno">4186</span>   <span class="n">error_trap</span> <span class="o">=</span> <span class="n">TRAP_STRING</span><span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">);</span>
<a name="c0-4187"></a><span class="lineno">4187</span>   <span class="n">return_trap</span> <span class="o">=</span> <span class="n">TRAP_STRING</span><span class="p">(</span><span class="n">RETURN_TRAP</span><span class="p">);</span>
<a name="c0-4188"></a><span class="lineno">4188</span>   
<a name="c0-4189"></a><span class="lineno">4189</span>   <span class="cm">/* The order of the unwind protects for debug_trap, error_trap and</span>
<a name="c0-4190"></a><span class="lineno">4190</span> <span class="cm">     return_trap is important here!  unwind-protect commands are run</span>
<a name="c0-4191"></a><span class="lineno">4191</span> <span class="cm">     in reverse order of registration.  If this causes problems, take</span>
<a name="c0-4192"></a><span class="lineno">4192</span> <span class="cm">     out the xfree unwind-protect calls and live with the small memory leak. */</span>
<a name="c0-4193"></a><span class="lineno">4193</span> 
<a name="c0-4194"></a><span class="lineno">4194</span>   <span class="cm">/* function_trace_mode != 0 means that all functions inherit the DEBUG trap.</span>
<a name="c0-4195"></a><span class="lineno">4195</span> <span class="cm">     if the function has the trace attribute set, it inherits the DEBUG trap */</span>
<a name="c0-4196"></a><span class="lineno">4196</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debug_trap</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">trace_p</span> <span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">function_trace_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a name="c0-4197"></a><span class="lineno">4197</span>     <span class="p">{</span>
<a name="c0-4198"></a><span class="lineno">4198</span>       <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4199"></a><span class="lineno">4199</span>  <span class="p">{</span>
<a name="c0-4200"></a><span class="lineno">4200</span>    <span class="n">debug_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">debug_trap</span><span class="p">);</span>
<a name="c0-4201"></a><span class="lineno">4201</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">xfree</span><span class="p">,</span> <span class="n">debug_trap</span><span class="p">);</span>
<a name="c0-4202"></a><span class="lineno">4202</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">set_debug_trap</span><span class="p">,</span> <span class="n">debug_trap</span><span class="p">);</span>
<a name="c0-4203"></a><span class="lineno">4203</span>  <span class="p">}</span>
<a name="c0-4204"></a><span class="lineno">4204</span>       <span class="n">restore_default_signal</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">);</span>
<a name="c0-4205"></a><span class="lineno">4205</span>     <span class="p">}</span>
<a name="c0-4206"></a><span class="lineno">4206</span> 
<a name="c0-4207"></a><span class="lineno">4207</span>   <span class="cm">/* error_trace_mode != 0 means that functions inherit the ERR trap. */</span>
<a name="c0-4208"></a><span class="lineno">4208</span>   <span class="k">if</span> <span class="p">(</span><span class="n">error_trap</span> <span class="o">&amp;&amp;</span> <span class="n">error_trace_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4209"></a><span class="lineno">4209</span>     <span class="p">{</span>
<a name="c0-4210"></a><span class="lineno">4210</span>       <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4211"></a><span class="lineno">4211</span>  <span class="p">{</span>
<a name="c0-4212"></a><span class="lineno">4212</span>    <span class="n">error_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4213"></a><span class="lineno">4213</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">xfree</span><span class="p">,</span> <span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4214"></a><span class="lineno">4214</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">set_error_trap</span><span class="p">,</span> <span class="n">error_trap</span><span class="p">);</span>
<a name="c0-4215"></a><span class="lineno">4215</span>  <span class="p">}</span>
<a name="c0-4216"></a><span class="lineno">4216</span>       <span class="n">restore_default_signal</span> <span class="p">(</span><span class="n">ERROR_TRAP</span><span class="p">);</span>
<a name="c0-4217"></a><span class="lineno">4217</span>     <span class="p">}</span>
<a name="c0-4218"></a><span class="lineno">4218</span> 
<a name="c0-4219"></a><span class="lineno">4219</span>   <span class="cm">/* Shell functions inherit the RETURN trap if function tracing is on</span>
<a name="c0-4220"></a><span class="lineno">4220</span> <span class="cm">     globally or on individually for this function. */</span>
<a name="c0-4221"></a><span class="lineno">4221</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-4222"></a><span class="lineno">4222</span> <span class="c">  if (return_trap &amp;&amp; ((trace_p (var) == 0) &amp;&amp; function_trace_mode == 0))</span>
<a name="c0-4223"></a><span class="lineno">4223</span> <span class="cp">#else</span>
<a name="c0-4224"></a><span class="lineno">4224</span>   <span class="k">if</span> <span class="p">(</span><span class="n">return_trap</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">signal_in_progress</span> <span class="p">(</span><span class="n">DEBUG_TRAP</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">trace_p</span> <span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">function_trace_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
<a name="c0-4225"></a><span class="lineno">4225</span> <span class="cp">#endif</span>
<a name="c0-4226"></a><span class="lineno">4226</span>     <span class="p">{</span>
<a name="c0-4227"></a><span class="lineno">4227</span>       <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4228"></a><span class="lineno">4228</span>  <span class="p">{</span>
<a name="c0-4229"></a><span class="lineno">4229</span>    <span class="n">return_trap</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">return_trap</span><span class="p">);</span>
<a name="c0-4230"></a><span class="lineno">4230</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">xfree</span><span class="p">,</span> <span class="n">return_trap</span><span class="p">);</span>
<a name="c0-4231"></a><span class="lineno">4231</span>    <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">set_return_trap</span><span class="p">,</span> <span class="n">return_trap</span><span class="p">);</span>
<a name="c0-4232"></a><span class="lineno">4232</span>  <span class="p">}</span>
<a name="c0-4233"></a><span class="lineno">4233</span>       <span class="n">restore_default_signal</span> <span class="p">(</span><span class="n">RETURN_TRAP</span><span class="p">);</span>
<a name="c0-4234"></a><span class="lineno">4234</span>     <span class="p">}</span>
<a name="c0-4235"></a><span class="lineno">4235</span>   
<a name="c0-4236"></a><span class="lineno">4236</span>   <span class="n">funcnest</span><span class="o">++</span><span class="p">;</span>
<a name="c0-4237"></a><span class="lineno">4237</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-4238"></a><span class="lineno">4238</span>   <span class="cm">/* This is quite similar to the code in shell.c and elsewhere. */</span>
<a name="c0-4239"></a><span class="lineno">4239</span>   <span class="n">shell_fn</span> <span class="o">=</span> <span class="n">find_function_def</span> <span class="p">(</span><span class="n">this_shell_function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-4240"></a><span class="lineno">4240</span>   <span class="n">sfile</span> <span class="o">=</span> <span class="n">shell_fn</span> <span class="o">?</span> <span class="n">shell_fn</span><span class="o">-&gt;</span><span class="n">source_file</span> <span class="o">:</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-4241"></a><span class="lineno">4241</span>   <span class="n">array_push</span> <span class="p">(</span><span class="n">funcname_a</span><span class="p">,</span> <span class="n">this_shell_function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-4242"></a><span class="lineno">4242</span> 
<a name="c0-4243"></a><span class="lineno">4243</span>   <span class="n">array_push</span> <span class="p">(</span><span class="n">bash_source_a</span><span class="p">,</span> <span class="n">sfile</span><span class="p">);</span>
<a name="c0-4244"></a><span class="lineno">4244</span>   <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">executing_line_number</span> <span class="p">());</span>
<a name="c0-4245"></a><span class="lineno">4245</span>   <span class="n">array_push</span> <span class="p">(</span><span class="n">bash_lineno_a</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<a name="c0-4246"></a><span class="lineno">4246</span>   <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c0-4247"></a><span class="lineno">4247</span> <span class="cp">#endif</span>
<a name="c0-4248"></a><span class="lineno">4248</span> 
<a name="c0-4249"></a><span class="lineno">4249</span>   <span class="cm">/* The temporary environment for a function is supposed to apply to</span>
<a name="c0-4250"></a><span class="lineno">4250</span> <span class="cm">     all commands executed within the function body. */</span>
<a name="c0-4251"></a><span class="lineno">4251</span> 
<a name="c0-4252"></a><span class="lineno">4252</span>   <span class="n">remember_args</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-4253"></a><span class="lineno">4253</span> 
<a name="c0-4254"></a><span class="lineno">4254</span>   <span class="cm">/* Update BASH_ARGV and BASH_ARGC */</span>
<a name="c0-4255"></a><span class="lineno">4255</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span><span class="p">)</span>
<a name="c0-4256"></a><span class="lineno">4256</span>     <span class="n">push_args</span> <span class="p">(</span><span class="n">words</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
<a name="c0-4257"></a><span class="lineno">4257</span> 
<a name="c0-4258"></a><span class="lineno">4258</span>   <span class="cm">/* Number of the line on which the function body starts. */</span>
<a name="c0-4259"></a><span class="lineno">4259</span>   <span class="n">line_number</span> <span class="o">=</span> <span class="n">function_line_number</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-4260"></a><span class="lineno">4260</span> 
<a name="c0-4261"></a><span class="lineno">4261</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-4262"></a><span class="lineno">4262</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span><span class="p">)</span>
<a name="c0-4263"></a><span class="lineno">4263</span>     <span class="n">stop_pipeline</span> <span class="p">(</span><span class="n">async</span><span class="p">,</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-4264"></a><span class="lineno">4264</span> <span class="cp">#endif</span>
<a name="c0-4265"></a><span class="lineno">4265</span> 
<a name="c0-4266"></a><span class="lineno">4266</span>   <span class="n">fc</span> <span class="o">=</span> <span class="n">tc</span><span class="p">;</span>
<a name="c0-4267"></a><span class="lineno">4267</span> 
<a name="c0-4268"></a><span class="lineno">4268</span>   <span class="n">return_catch_flag</span><span class="o">++</span><span class="p">;</span>
<a name="c0-4269"></a><span class="lineno">4269</span>   <span class="n">return_val</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">return_catch</span><span class="p">);</span>
<a name="c0-4270"></a><span class="lineno">4270</span> 
<a name="c0-4271"></a><span class="lineno">4271</span>   <span class="k">if</span> <span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
<a name="c0-4272"></a><span class="lineno">4272</span>     <span class="p">{</span>
<a name="c0-4273"></a><span class="lineno">4273</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">return_catch_value</span><span class="p">;</span>
<a name="c0-4274"></a><span class="lineno">4274</span>       <span class="cm">/* Run the RETURN trap in the function's context. */</span>
<a name="c0-4275"></a><span class="lineno">4275</span>       <span class="n">save_current</span> <span class="o">=</span> <span class="n">currently_executing_command</span><span class="p">;</span>
<a name="c0-4276"></a><span class="lineno">4276</span>       <span class="n">run_return_trap</span> <span class="p">();</span>
<a name="c0-4277"></a><span class="lineno">4277</span>       <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="n">save_current</span><span class="p">;</span>
<a name="c0-4278"></a><span class="lineno">4278</span>     <span class="p">}</span>
<a name="c0-4279"></a><span class="lineno">4279</span>   <span class="k">else</span>
<a name="c0-4280"></a><span class="lineno">4280</span>     <span class="p">{</span>
<a name="c0-4281"></a><span class="lineno">4281</span>       <span class="cm">/* Run the debug trap here so we can trap at the start of a function's</span>
<a name="c0-4282"></a><span class="lineno">4282</span> <span class="cm">   execution rather than the execution of the body's first command. */</span>
<a name="c0-4283"></a><span class="lineno">4283</span>       <span class="n">showing_function_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-4284"></a><span class="lineno">4284</span>       <span class="n">save_current</span> <span class="o">=</span> <span class="n">currently_executing_command</span><span class="p">;</span>
<a name="c0-4285"></a><span class="lineno">4285</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">run_debug_trap</span> <span class="p">();</span>
<a name="c0-4286"></a><span class="lineno">4286</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c0-4287"></a><span class="lineno">4287</span>       <span class="cm">/* In debugging mode, if the DEBUG trap returns a non-zero status, we</span>
<a name="c0-4288"></a><span class="lineno">4288</span> <span class="cm">   skip the command. */</span>
<a name="c0-4289"></a><span class="lineno">4289</span>       <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">result</span> <span class="o">==</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c0-4290"></a><span class="lineno">4290</span>  <span class="p">{</span>
<a name="c0-4291"></a><span class="lineno">4291</span>    <span class="n">showing_function_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4292"></a><span class="lineno">4292</span>    <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="n">save_current</span><span class="p">;</span>
<a name="c0-4293"></a><span class="lineno">4293</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-4294"></a><span class="lineno">4294</span> 
<a name="c0-4295"></a><span class="lineno">4295</span>    <span class="cm">/* Run the RETURN trap in the function's context */</span>
<a name="c0-4296"></a><span class="lineno">4296</span>    <span class="n">save_current</span> <span class="o">=</span> <span class="n">currently_executing_command</span><span class="p">;</span>
<a name="c0-4297"></a><span class="lineno">4297</span>    <span class="n">run_return_trap</span> <span class="p">();</span>
<a name="c0-4298"></a><span class="lineno">4298</span>    <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="n">save_current</span><span class="p">;</span>
<a name="c0-4299"></a><span class="lineno">4299</span>  <span class="p">}</span>
<a name="c0-4300"></a><span class="lineno">4300</span> <span class="cp">#else</span>
<a name="c0-4301"></a><span class="lineno">4301</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">execute_command_internal</span> <span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">NO_PIPE</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-4302"></a><span class="lineno">4302</span> 
<a name="c0-4303"></a><span class="lineno">4303</span>       <span class="n">save_current</span> <span class="o">=</span> <span class="n">currently_executing_command</span><span class="p">;</span>
<a name="c0-4304"></a><span class="lineno">4304</span>       <span class="n">run_return_trap</span> <span class="p">();</span>
<a name="c0-4305"></a><span class="lineno">4305</span>       <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="n">save_current</span><span class="p">;</span>
<a name="c0-4306"></a><span class="lineno">4306</span> <span class="cp">#endif</span>
<a name="c0-4307"></a><span class="lineno">4307</span>       <span class="n">showing_function_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4308"></a><span class="lineno">4308</span>     <span class="p">}</span>
<a name="c0-4309"></a><span class="lineno">4309</span> 
<a name="c0-4310"></a><span class="lineno">4310</span>   <span class="cm">/* Restore BASH_ARGC and BASH_ARGV */</span>
<a name="c0-4311"></a><span class="lineno">4311</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span><span class="p">)</span>
<a name="c0-4312"></a><span class="lineno">4312</span>     <span class="n">pop_args</span> <span class="p">();</span>
<a name="c0-4313"></a><span class="lineno">4313</span> 
<a name="c0-4314"></a><span class="lineno">4314</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4315"></a><span class="lineno">4315</span>     <span class="n">run_unwind_frame</span> <span class="p">(</span><span class="s">"function_calling"</span><span class="p">);</span>
<a name="c0-4316"></a><span class="lineno">4316</span> 
<a name="c0-4317"></a><span class="lineno">4317</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c0-4318"></a><span class="lineno">4318</span>   <span class="cm">/* These two variables cannot be unset, and cannot be affected by the</span>
<a name="c0-4319"></a><span class="lineno">4319</span> <span class="cm">     function. */</span>
<a name="c0-4320"></a><span class="lineno">4320</span>   <span class="n">array_pop</span> <span class="p">(</span><span class="n">bash_source_a</span><span class="p">);</span>
<a name="c0-4321"></a><span class="lineno">4321</span>   <span class="n">array_pop</span> <span class="p">(</span><span class="n">bash_lineno_a</span><span class="p">);</span>
<a name="c0-4322"></a><span class="lineno">4322</span> 
<a name="c0-4323"></a><span class="lineno">4323</span>   <span class="cm">/* FUNCNAME can be unset, and so can potentially be changed by the</span>
<a name="c0-4324"></a><span class="lineno">4324</span> <span class="cm">     function. */</span>
<a name="c0-4325"></a><span class="lineno">4325</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"FUNCNAME"</span><span class="p">,</span> <span class="n">nfv</span><span class="p">,</span> <span class="n">funcname_a</span><span class="p">);</span>
<a name="c0-4326"></a><span class="lineno">4326</span>   <span class="k">if</span> <span class="p">(</span><span class="n">nfv</span> <span class="o">==</span> <span class="n">funcname_v</span><span class="p">)</span>
<a name="c0-4327"></a><span class="lineno">4327</span>     <span class="n">array_pop</span> <span class="p">(</span><span class="n">funcname_a</span><span class="p">);</span>
<a name="c0-4328"></a><span class="lineno">4328</span> <span class="cp">#endif</span>
<a name="c0-4329"></a><span class="lineno">4329</span>   
<a name="c0-4330"></a><span class="lineno">4330</span>   <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">this_shell_function</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4331"></a><span class="lineno">4331</span>     <span class="p">{</span>
<a name="c0-4332"></a><span class="lineno">4332</span>       <span class="n">make_funcname_visible</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-4333"></a><span class="lineno">4333</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-4334"></a><span class="lineno">4334</span>       <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-4335"></a><span class="lineno">4335</span> <span class="cp">#endif</span>
<a name="c0-4336"></a><span class="lineno">4336</span>     <span class="p">}</span>
<a name="c0-4337"></a><span class="lineno">4337</span>   
<a name="c0-4338"></a><span class="lineno">4338</span>   <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-4339"></a><span class="lineno">4339</span> <span class="p">}</span>
<a name="c0-4340"></a><span class="lineno">4340</span> 
<a name="c0-4341"></a><span class="lineno">4341</span> <span class="cm">/* A convenience routine for use by other parts of the shell to execute</span>
<a name="c0-4342"></a><span class="lineno">4342</span> <span class="cm">   a particular shell function. */</span>
<a name="c0-4343"></a><span class="lineno">4343</span> <span class="kt">int</span>
<a name="c0-4344"></a><span class="lineno">4344</span> <span class="n">execute_shell_function</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">words</span><span class="p">)</span>
<a name="c0-4345"></a><span class="lineno">4345</span>      <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<a name="c0-4346"></a><span class="lineno">4346</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-4347"></a><span class="lineno">4347</span> <span class="p">{</span>
<a name="c0-4348"></a><span class="lineno">4348</span>   <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c0-4349"></a><span class="lineno">4349</span>   <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
<a name="c0-4350"></a><span class="lineno">4350</span> 
<a name="c0-4351"></a><span class="lineno">4351</span>   <span class="n">bitmap</span> <span class="o">=</span> <span class="n">new_fd_bitmap</span> <span class="p">(</span><span class="n">FD_BITMAP_DEFAULT_SIZE</span><span class="p">);</span>
<a name="c0-4352"></a><span class="lineno">4352</span>   <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"execute-shell-function"</span><span class="p">);</span>
<a name="c0-4353"></a><span class="lineno">4353</span>   <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">dispose_fd_bitmap</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bitmap</span><span class="p">);</span>
<a name="c0-4354"></a><span class="lineno">4354</span>       
<a name="c0-4355"></a><span class="lineno">4355</span>   <span class="n">ret</span> <span class="o">=</span> <span class="n">execute_function</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-4356"></a><span class="lineno">4356</span> 
<a name="c0-4357"></a><span class="lineno">4357</span>   <span class="n">dispose_fd_bitmap</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">);</span>
<a name="c0-4358"></a><span class="lineno">4358</span>   <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"execute-shell-function"</span><span class="p">);</span>
<a name="c0-4359"></a><span class="lineno">4359</span> 
<a name="c0-4360"></a><span class="lineno">4360</span>   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c0-4361"></a><span class="lineno">4361</span> <span class="p">}</span>
<a name="c0-4362"></a><span class="lineno">4362</span> 
<a name="c0-4363"></a><span class="lineno">4363</span> <span class="cm">/* Execute a shell builtin or function in a subshell environment.  This</span>
<a name="c0-4364"></a><span class="lineno">4364</span> <span class="cm">   routine does not return; it only calls exit().  If BUILTIN is non-null,</span>
<a name="c0-4365"></a><span class="lineno">4365</span> <span class="cm">   it points to a function to call to execute a shell builtin; otherwise</span>
<a name="c0-4366"></a><span class="lineno">4366</span> <span class="cm">   VAR points at the body of a function to execute.  WORDS is the arguments</span>
<a name="c0-4367"></a><span class="lineno">4367</span> <span class="cm">   to the command, REDIRECTS specifies redirections to perform before the</span>
<a name="c0-4368"></a><span class="lineno">4368</span> <span class="cm">   command is executed. */</span>
<a name="c0-4369"></a><span class="lineno">4369</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-4370"></a><span class="lineno">4370</span> <span class="n">execute_subshell_builtin_or_function</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">redirects</span><span class="p">,</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span>
<a name="c0-4371"></a><span class="lineno">4371</span>              <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span>
<a name="c0-4372"></a><span class="lineno">4372</span>              <span class="n">flags</span><span class="p">)</span>
<a name="c0-4373"></a><span class="lineno">4373</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-4374"></a><span class="lineno">4374</span>      <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">redirects</span><span class="p">;</span>
<a name="c0-4375"></a><span class="lineno">4375</span>      <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="n">builtin</span><span class="p">;</span>
<a name="c0-4376"></a><span class="lineno">4376</span>      <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<a name="c0-4377"></a><span class="lineno">4377</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">;</span>
<a name="c0-4378"></a><span class="lineno">4378</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-4379"></a><span class="lineno">4379</span>      <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="c0-4380"></a><span class="lineno">4380</span> <span class="p">{</span>
<a name="c0-4381"></a><span class="lineno">4381</span>   <span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">funcvalue</span><span class="p">;</span>
<a name="c0-4382"></a><span class="lineno">4382</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-4383"></a><span class="lineno">4383</span>   <span class="kt">int</span> <span class="n">jobs_hack</span><span class="p">;</span>
<a name="c0-4384"></a><span class="lineno">4384</span> 
<a name="c0-4385"></a><span class="lineno">4385</span>   <span class="n">jobs_hack</span> <span class="o">=</span> <span class="p">(</span><span class="n">builtin</span> <span class="o">==</span> <span class="n">jobs_builtin</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-4386"></a><span class="lineno">4386</span>    <span class="p">((</span><span class="n">subshell_environment</span> <span class="o">&amp;</span> <span class="n">SUBSHELL_ASYNC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">);</span>
<a name="c0-4387"></a><span class="lineno">4387</span> <span class="cp">#endif</span>
<a name="c0-4388"></a><span class="lineno">4388</span> 
<a name="c0-4389"></a><span class="lineno">4389</span>   <span class="cm">/* A subshell is neither a login shell nor interactive. */</span>
<a name="c0-4390"></a><span class="lineno">4390</span>   <span class="n">login_shell</span> <span class="o">=</span> <span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4391"></a><span class="lineno">4391</span> 
<a name="c0-4392"></a><span class="lineno">4392</span>   <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-4393"></a><span class="lineno">4393</span>     <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_ASYNC</span><span class="p">;</span>
<a name="c0-4394"></a><span class="lineno">4394</span>   <span class="k">if</span> <span class="p">(</span><span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-4395"></a><span class="lineno">4395</span>     <span class="n">subshell_environment</span> <span class="o">|=</span> <span class="n">SUBSHELL_PIPE</span><span class="p">;</span>
<a name="c0-4396"></a><span class="lineno">4396</span> 
<a name="c0-4397"></a><span class="lineno">4397</span>   <span class="n">maybe_make_export_env</span> <span class="p">();</span>  <span class="cm">/* XXX - is this needed? */</span>
<a name="c0-4398"></a><span class="lineno">4398</span> 
<a name="c0-4399"></a><span class="lineno">4399</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-4400"></a><span class="lineno">4400</span>   <span class="cm">/* Eradicate all traces of job control after we fork the subshell, so</span>
<a name="c0-4401"></a><span class="lineno">4401</span> <span class="cm">     all jobs begun by this subshell are in the same process group as</span>
<a name="c0-4402"></a><span class="lineno">4402</span> <span class="cm">     the shell itself. */</span>
<a name="c0-4403"></a><span class="lineno">4403</span> 
<a name="c0-4404"></a><span class="lineno">4404</span>   <span class="cm">/* Allow the output of `jobs' to be piped. */</span>
<a name="c0-4405"></a><span class="lineno">4405</span>   <span class="k">if</span> <span class="p">(</span><span class="n">jobs_hack</span><span class="p">)</span>
<a name="c0-4406"></a><span class="lineno">4406</span>     <span class="n">kill_current_pipeline</span> <span class="p">();</span>
<a name="c0-4407"></a><span class="lineno">4407</span>   <span class="k">else</span>
<a name="c0-4408"></a><span class="lineno">4408</span>     <span class="n">without_job_control</span> <span class="p">();</span>
<a name="c0-4409"></a><span class="lineno">4409</span> 
<a name="c0-4410"></a><span class="lineno">4410</span>   <span class="n">set_sigchld_handler</span> <span class="p">();</span>
<a name="c0-4411"></a><span class="lineno">4411</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-4412"></a><span class="lineno">4412</span> 
<a name="c0-4413"></a><span class="lineno">4413</span>   <span class="n">set_sigint_handler</span> <span class="p">();</span>
<a name="c0-4414"></a><span class="lineno">4414</span> 
<a name="c0-4415"></a><span class="lineno">4415</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-4416"></a><span class="lineno">4416</span>     <span class="n">close_fd_bitmap</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-4417"></a><span class="lineno">4417</span> 
<a name="c0-4418"></a><span class="lineno">4418</span>   <span class="n">do_piping</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-4419"></a><span class="lineno">4419</span> 
<a name="c0-4420"></a><span class="lineno">4420</span>   <span class="k">if</span> <span class="p">(</span><span class="n">do_redirections</span> <span class="p">(</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4421"></a><span class="lineno">4421</span>     <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-4422"></a><span class="lineno">4422</span> 
<a name="c0-4423"></a><span class="lineno">4423</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a name="c0-4424"></a><span class="lineno">4424</span>     <span class="p">{</span>
<a name="c0-4425"></a><span class="lineno">4425</span>       <span class="cm">/* Give builtins a place to jump back to on failure,</span>
<a name="c0-4426"></a><span class="lineno">4426</span> <span class="cm">   so we don't go back up to main(). */</span>
<a name="c0-4427"></a><span class="lineno">4427</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">);</span>
<a name="c0-4428"></a><span class="lineno">4428</span> 
<a name="c0-4429"></a><span class="lineno">4429</span>       <span class="cm">/* Give the return builtin a place to jump to when executed in a subshell</span>
<a name="c0-4430"></a><span class="lineno">4430</span> <span class="cm">         or pipeline */</span>
<a name="c0-4431"></a><span class="lineno">4431</span>       <span class="n">funcvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4432"></a><span class="lineno">4432</span>       <span class="k">if</span> <span class="p">(</span><span class="n">return_catch_flag</span> <span class="o">&amp;&amp;</span> <span class="n">builtin</span> <span class="o">==</span> <span class="n">return_builtin</span><span class="p">)</span>
<a name="c0-4433"></a><span class="lineno">4433</span>         <span class="n">funcvalue</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">return_catch</span><span class="p">);</span>
<a name="c0-4434"></a><span class="lineno">4434</span> 
<a name="c0-4435"></a><span class="lineno">4435</span>       <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">EXITPROG</span><span class="p">)</span>
<a name="c0-4436"></a><span class="lineno">4436</span>  <span class="n">exit</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c0-4437"></a><span class="lineno">4437</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a name="c0-4438"></a><span class="lineno">4438</span>  <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-4439"></a><span class="lineno">4439</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">funcvalue</span><span class="p">)</span>
<a name="c0-4440"></a><span class="lineno">4440</span>  <span class="n">exit</span> <span class="p">(</span><span class="n">return_catch_value</span><span class="p">);</span>
<a name="c0-4441"></a><span class="lineno">4441</span>       <span class="k">else</span>
<a name="c0-4442"></a><span class="lineno">4442</span>  <span class="p">{</span>
<a name="c0-4443"></a><span class="lineno">4443</span>    <span class="n">r</span> <span class="o">=</span> <span class="n">execute_builtin</span> <span class="p">(</span><span class="n">builtin</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-4444"></a><span class="lineno">4444</span>    <span class="n">fflush</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c0-4445"></a><span class="lineno">4445</span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">EX_USAGE</span><span class="p">)</span>
<a name="c0-4446"></a><span class="lineno">4446</span>      <span class="n">r</span> <span class="o">=</span> <span class="n">EX_BADUSAGE</span><span class="p">;</span>
<a name="c0-4447"></a><span class="lineno">4447</span>    <span class="n">exit</span> <span class="p">(</span><span class="n">r</span><span class="p">);</span>
<a name="c0-4448"></a><span class="lineno">4448</span>  <span class="p">}</span>
<a name="c0-4449"></a><span class="lineno">4449</span>     <span class="p">}</span>
<a name="c0-4450"></a><span class="lineno">4450</span>   <span class="k">else</span>
<a name="c0-4451"></a><span class="lineno">4451</span>     <span class="p">{</span>
<a name="c0-4452"></a><span class="lineno">4452</span>       <span class="n">r</span> <span class="o">=</span> <span class="n">execute_function</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span> <span class="n">async</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-4453"></a><span class="lineno">4453</span>       <span class="n">fflush</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c0-4454"></a><span class="lineno">4454</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">r</span><span class="p">);</span>
<a name="c0-4455"></a><span class="lineno">4455</span>     <span class="p">}</span>
<a name="c0-4456"></a><span class="lineno">4456</span> <span class="p">}</span>
<a name="c0-4457"></a><span class="lineno">4457</span> 
<a name="c0-4458"></a><span class="lineno">4458</span> <span class="cm">/* Execute a builtin or function in the current shell context.  If BUILTIN</span>
<a name="c0-4459"></a><span class="lineno">4459</span> <span class="cm">   is non-null, it is the builtin command to execute, otherwise VAR points</span>
<a name="c0-4460"></a><span class="lineno">4460</span> <span class="cm">   to the body of a function.  WORDS are the command's arguments, REDIRECTS</span>
<a name="c0-4461"></a><span class="lineno">4461</span> <span class="cm">   are the redirections to perform.  FDS_TO_CLOSE is the usual bitmap of</span>
<a name="c0-4462"></a><span class="lineno">4462</span> <span class="cm">   file descriptors to close.</span>
<a name="c0-4463"></a><span class="lineno">4463</span> 
<a name="c0-4464"></a><span class="lineno">4464</span> <span class="cm">   If BUILTIN is exec_builtin, the redirections specified in REDIRECTS are</span>
<a name="c0-4465"></a><span class="lineno">4465</span> <span class="cm">   not undone before this function returns. */</span>
<a name="c0-4466"></a><span class="lineno">4466</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-4467"></a><span class="lineno">4467</span> <span class="n">execute_builtin_or_function</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">redirects</span><span class="p">,</span>
<a name="c0-4468"></a><span class="lineno">4468</span>           <span class="n">fds_to_close</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
<a name="c0-4469"></a><span class="lineno">4469</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-4470"></a><span class="lineno">4470</span>      <span class="n">sh_builtin_func_t</span> <span class="o">*</span><span class="n">builtin</span><span class="p">;</span>
<a name="c0-4471"></a><span class="lineno">4471</span>      <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<a name="c0-4472"></a><span class="lineno">4472</span>      <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">redirects</span><span class="p">;</span>
<a name="c0-4473"></a><span class="lineno">4473</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-4474"></a><span class="lineno">4474</span>      <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="c0-4475"></a><span class="lineno">4475</span> <span class="p">{</span>
<a name="c0-4476"></a><span class="lineno">4476</span>   <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-4477"></a><span class="lineno">4477</span>   <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">saved_undo_list</span><span class="p">;</span>
<a name="c0-4478"></a><span class="lineno">4478</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-4479"></a><span class="lineno">4479</span>   <span class="kt">int</span> <span class="n">ofifo</span><span class="p">,</span> <span class="n">nfifo</span><span class="p">,</span> <span class="n">osize</span><span class="p">;</span>
<a name="c0-4480"></a><span class="lineno">4480</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">ofifo_list</span><span class="p">;</span>
<a name="c0-4481"></a><span class="lineno">4481</span> <span class="cp">#endif</span>
<a name="c0-4482"></a><span class="lineno">4482</span> 
<a name="c0-4483"></a><span class="lineno">4483</span> 
<a name="c0-4484"></a><span class="lineno">4484</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)  </span>
<a name="c0-4485"></a><span class="lineno">4485</span>   <span class="n">ofifo</span> <span class="o">=</span> <span class="n">num_fifos</span> <span class="p">();</span>
<a name="c0-4486"></a><span class="lineno">4486</span>   <span class="n">ofifo_list</span> <span class="o">=</span> <span class="n">copy_fifo_list</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">osize</span><span class="p">);</span>
<a name="c0-4487"></a><span class="lineno">4487</span> <span class="cp">#endif</span>
<a name="c0-4488"></a><span class="lineno">4488</span> 
<a name="c0-4489"></a><span class="lineno">4489</span>   <span class="k">if</span> <span class="p">(</span><span class="n">do_redirections</span> <span class="p">(</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="o">|</span><span class="n">RX_UNDOABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4490"></a><span class="lineno">4490</span>     <span class="p">{</span>
<a name="c0-4491"></a><span class="lineno">4491</span>       <span class="n">cleanup_redirects</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">);</span>
<a name="c0-4492"></a><span class="lineno">4492</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4493"></a><span class="lineno">4493</span>       <span class="n">dispose_exec_redirects</span> <span class="p">();</span>
<a name="c0-4494"></a><span class="lineno">4494</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-4495"></a><span class="lineno">4495</span>       <span class="n">free</span> <span class="p">(</span><span class="n">ofifo_list</span><span class="p">);</span>
<a name="c0-4496"></a><span class="lineno">4496</span> <span class="cp">#endif</span>
<a name="c0-4497"></a><span class="lineno">4497</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EX_REDIRFAIL</span><span class="p">);</span> <span class="cm">/* was EXECUTION_FAILURE */</span>
<a name="c0-4498"></a><span class="lineno">4498</span>     <span class="p">}</span>
<a name="c0-4499"></a><span class="lineno">4499</span> 
<a name="c0-4500"></a><span class="lineno">4500</span>   <span class="n">saved_undo_list</span> <span class="o">=</span> <span class="n">redirection_undo_list</span><span class="p">;</span>
<a name="c0-4501"></a><span class="lineno">4501</span> 
<a name="c0-4502"></a><span class="lineno">4502</span>   <span class="cm">/* Calling the "exec" builtin changes redirections forever. */</span>
<a name="c0-4503"></a><span class="lineno">4503</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span> <span class="o">==</span> <span class="n">exec_builtin</span><span class="p">)</span>
<a name="c0-4504"></a><span class="lineno">4504</span>     <span class="p">{</span>
<a name="c0-4505"></a><span class="lineno">4505</span>       <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">saved_undo_list</span><span class="p">);</span>
<a name="c0-4506"></a><span class="lineno">4506</span>       <span class="n">saved_undo_list</span> <span class="o">=</span> <span class="n">exec_redirection_undo_list</span><span class="p">;</span>
<a name="c0-4507"></a><span class="lineno">4507</span>       <span class="n">exec_redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4508"></a><span class="lineno">4508</span>     <span class="p">}</span>
<a name="c0-4509"></a><span class="lineno">4509</span>   <span class="k">else</span>
<a name="c0-4510"></a><span class="lineno">4510</span>     <span class="n">dispose_exec_redirects</span> <span class="p">();</span>
<a name="c0-4511"></a><span class="lineno">4511</span> 
<a name="c0-4512"></a><span class="lineno">4512</span>   <span class="k">if</span> <span class="p">(</span><span class="n">saved_undo_list</span><span class="p">)</span>
<a name="c0-4513"></a><span class="lineno">4513</span>     <span class="p">{</span>
<a name="c0-4514"></a><span class="lineno">4514</span>       <span class="n">begin_unwind_frame</span> <span class="p">(</span><span class="s">"saved redirects"</span><span class="p">);</span>
<a name="c0-4515"></a><span class="lineno">4515</span>       <span class="n">add_unwind_protect</span> <span class="p">(</span><span class="n">cleanup_redirects</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">saved_undo_list</span><span class="p">);</span>
<a name="c0-4516"></a><span class="lineno">4516</span>     <span class="p">}</span>
<a name="c0-4517"></a><span class="lineno">4517</span> 
<a name="c0-4518"></a><span class="lineno">4518</span>   <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4519"></a><span class="lineno">4519</span> 
<a name="c0-4520"></a><span class="lineno">4520</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
<a name="c0-4521"></a><span class="lineno">4521</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">execute_builtin</span> <span class="p">(</span><span class="n">builtin</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-4522"></a><span class="lineno">4522</span>   <span class="k">else</span>
<a name="c0-4523"></a><span class="lineno">4523</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">execute_function</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-4524"></a><span class="lineno">4524</span> 
<a name="c0-4525"></a><span class="lineno">4525</span>   <span class="cm">/* We do this before undoing the effects of any redirections. */</span>
<a name="c0-4526"></a><span class="lineno">4526</span>   <span class="n">fflush</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c0-4527"></a><span class="lineno">4527</span>   <span class="n">fpurge</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c0-4528"></a><span class="lineno">4528</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ferror</span> <span class="p">(</span><span class="n">stdout</span><span class="p">))</span>
<a name="c0-4529"></a><span class="lineno">4529</span>     <span class="n">clearerr</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>  
<a name="c0-4530"></a><span class="lineno">4530</span> 
<a name="c0-4531"></a><span class="lineno">4531</span>   <span class="cm">/* If we are executing the `command' builtin, but this_shell_builtin is</span>
<a name="c0-4532"></a><span class="lineno">4532</span> <span class="cm">     set to `exec_builtin', we know that we have something like</span>
<a name="c0-4533"></a><span class="lineno">4533</span> <span class="cm">     `command exec [redirection]', since otherwise `exec' would have</span>
<a name="c0-4534"></a><span class="lineno">4534</span> <span class="cm">     overwritten the shell and we wouldn't get here.  In this case, we</span>
<a name="c0-4535"></a><span class="lineno">4535</span> <span class="cm">     want to behave as if the `command' builtin had not been specified</span>
<a name="c0-4536"></a><span class="lineno">4536</span> <span class="cm">     and preserve the redirections. */</span>
<a name="c0-4537"></a><span class="lineno">4537</span>   <span class="k">if</span> <span class="p">(</span><span class="n">builtin</span> <span class="o">==</span> <span class="n">command_builtin</span> <span class="o">&amp;&amp;</span> <span class="n">this_shell_builtin</span> <span class="o">==</span> <span class="n">exec_builtin</span><span class="p">)</span>
<a name="c0-4538"></a><span class="lineno">4538</span>     <span class="p">{</span>
<a name="c0-4539"></a><span class="lineno">4539</span>       <span class="kt">int</span> <span class="n">discard</span><span class="p">;</span>
<a name="c0-4540"></a><span class="lineno">4540</span> 
<a name="c0-4541"></a><span class="lineno">4541</span>       <span class="n">discard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4542"></a><span class="lineno">4542</span>       <span class="k">if</span> <span class="p">(</span><span class="n">saved_undo_list</span><span class="p">)</span>
<a name="c0-4543"></a><span class="lineno">4543</span>  <span class="p">{</span>
<a name="c0-4544"></a><span class="lineno">4544</span>    <span class="n">dispose_redirects</span> <span class="p">(</span><span class="n">saved_undo_list</span><span class="p">);</span>
<a name="c0-4545"></a><span class="lineno">4545</span>    <span class="n">discard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-4546"></a><span class="lineno">4546</span>  <span class="p">}</span>
<a name="c0-4547"></a><span class="lineno">4547</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="n">exec_redirection_undo_list</span><span class="p">;</span>
<a name="c0-4548"></a><span class="lineno">4548</span>       <span class="n">saved_undo_list</span> <span class="o">=</span> <span class="n">exec_redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>      
<a name="c0-4549"></a><span class="lineno">4549</span>       <span class="k">if</span> <span class="p">(</span><span class="n">discard</span><span class="p">)</span>
<a name="c0-4550"></a><span class="lineno">4550</span>  <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"saved redirects"</span><span class="p">);</span>
<a name="c0-4551"></a><span class="lineno">4551</span>     <span class="p">}</span>
<a name="c0-4552"></a><span class="lineno">4552</span> 
<a name="c0-4553"></a><span class="lineno">4553</span>   <span class="k">if</span> <span class="p">(</span><span class="n">saved_undo_list</span><span class="p">)</span>
<a name="c0-4554"></a><span class="lineno">4554</span>     <span class="p">{</span>
<a name="c0-4555"></a><span class="lineno">4555</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="n">saved_undo_list</span><span class="p">;</span>
<a name="c0-4556"></a><span class="lineno">4556</span>       <span class="n">discard_unwind_frame</span> <span class="p">(</span><span class="s">"saved redirects"</span><span class="p">);</span>
<a name="c0-4557"></a><span class="lineno">4557</span>     <span class="p">}</span>
<a name="c0-4558"></a><span class="lineno">4558</span> 
<a name="c0-4559"></a><span class="lineno">4559</span>   <span class="k">if</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">)</span>
<a name="c0-4560"></a><span class="lineno">4560</span>     <span class="p">{</span>
<a name="c0-4561"></a><span class="lineno">4561</span>       <span class="n">cleanup_redirects</span> <span class="p">(</span><span class="n">redirection_undo_list</span><span class="p">);</span>
<a name="c0-4562"></a><span class="lineno">4562</span>       <span class="n">redirection_undo_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">REDIRECT</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4563"></a><span class="lineno">4563</span>     <span class="p">}</span>
<a name="c0-4564"></a><span class="lineno">4564</span> 
<a name="c0-4565"></a><span class="lineno">4565</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-4566"></a><span class="lineno">4566</span>   <span class="cm">/* Close any FIFOs created by this builtin or function. */</span>
<a name="c0-4567"></a><span class="lineno">4567</span>   <span class="n">nfifo</span> <span class="o">=</span> <span class="n">num_fifos</span> <span class="p">();</span>
<a name="c0-4568"></a><span class="lineno">4568</span>   <span class="k">if</span> <span class="p">(</span><span class="n">nfifo</span> <span class="o">&gt;</span> <span class="n">ofifo</span><span class="p">)</span>
<a name="c0-4569"></a><span class="lineno">4569</span>     <span class="n">close_new_fifos</span> <span class="p">(</span><span class="n">ofifo_list</span><span class="p">,</span> <span class="n">osize</span><span class="p">);</span>
<a name="c0-4570"></a><span class="lineno">4570</span>   <span class="n">free</span> <span class="p">(</span><span class="n">ofifo_list</span><span class="p">);</span>
<a name="c0-4571"></a><span class="lineno">4571</span> <span class="cp">#endif</span>
<a name="c0-4572"></a><span class="lineno">4572</span> 
<a name="c0-4573"></a><span class="lineno">4573</span>   <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-4574"></a><span class="lineno">4574</span> <span class="p">}</span>
<a name="c0-4575"></a><span class="lineno">4575</span> 
<a name="c0-4576"></a><span class="lineno">4576</span> <span class="kt">void</span>
<a name="c0-4577"></a><span class="lineno">4577</span> <span class="n">setup_async_signals</span> <span class="p">()</span>
<a name="c0-4578"></a><span class="lineno">4578</span> <span class="p">{</span>
<a name="c0-4579"></a><span class="lineno">4579</span> <span class="cp">#if defined (__BEOS__)</span>
<a name="c0-4580"></a><span class="lineno">4580</span>   <span class="n">set_signal_handler</span> <span class="p">(</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>  <span class="cm">/* they want csh-like behavior */</span>
<a name="c0-4581"></a><span class="lineno">4581</span> <span class="cp">#endif</span>
<a name="c0-4582"></a><span class="lineno">4582</span> 
<a name="c0-4583"></a><span class="lineno">4583</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-4584"></a><span class="lineno">4584</span>   <span class="k">if</span> <span class="p">(</span><span class="n">job_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4585"></a><span class="lineno">4585</span> <span class="cp">#endif</span>
<a name="c0-4586"></a><span class="lineno">4586</span>     <span class="p">{</span>
<a name="c0-4587"></a><span class="lineno">4587</span>       <span class="n">set_signal_handler</span> <span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
<a name="c0-4588"></a><span class="lineno">4588</span>       <span class="n">set_signal_ignored</span> <span class="p">(</span><span class="n">SIGINT</span><span class="p">);</span>
<a name="c0-4589"></a><span class="lineno">4589</span>       <span class="n">set_signal_handler</span> <span class="p">(</span><span class="n">SIGQUIT</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
<a name="c0-4590"></a><span class="lineno">4590</span>       <span class="n">set_signal_ignored</span> <span class="p">(</span><span class="n">SIGQUIT</span><span class="p">);</span>
<a name="c0-4591"></a><span class="lineno">4591</span>     <span class="p">}</span>
<a name="c0-4592"></a><span class="lineno">4592</span> <span class="p">}</span>
<a name="c0-4593"></a><span class="lineno">4593</span> 
<a name="c0-4594"></a><span class="lineno">4594</span> <span class="cm">/* Execute a simple command that is hopefully defined in a disk file</span>
<a name="c0-4595"></a><span class="lineno">4595</span> <span class="cm">   somewhere.</span>
<a name="c0-4596"></a><span class="lineno">4596</span> 
<a name="c0-4597"></a><span class="lineno">4597</span> <span class="cm">   1) fork ()</span>
<a name="c0-4598"></a><span class="lineno">4598</span> <span class="cm">   2) connect pipes</span>
<a name="c0-4599"></a><span class="lineno">4599</span> <span class="cm">   3) look up the command</span>
<a name="c0-4600"></a><span class="lineno">4600</span> <span class="cm">   4) do redirections</span>
<a name="c0-4601"></a><span class="lineno">4601</span> <span class="cm">   5) execve ()</span>
<a name="c0-4602"></a><span class="lineno">4602</span> <span class="cm">   6) If the execve failed, see if the file has executable mode set.</span>
<a name="c0-4603"></a><span class="lineno">4603</span> <span class="cm">   If so, and it isn't a directory, then execute its contents as</span>
<a name="c0-4604"></a><span class="lineno">4604</span> <span class="cm">   a shell script.</span>
<a name="c0-4605"></a><span class="lineno">4605</span> 
<a name="c0-4606"></a><span class="lineno">4606</span> <span class="cm">   Note that the filename hashing stuff has to take place up here,</span>
<a name="c0-4607"></a><span class="lineno">4607</span> <span class="cm">   in the parent.  This is probably why the Bourne style shells</span>
<a name="c0-4608"></a><span class="lineno">4608</span> <span class="cm">   don't handle it, since that would require them to go through</span>
<a name="c0-4609"></a><span class="lineno">4609</span> <span class="cm">   this gnarly hair, for no good reason.</span>
<a name="c0-4610"></a><span class="lineno">4610</span> 
<a name="c0-4611"></a><span class="lineno">4611</span> <span class="cm">   NOTE: callers expect this to fork or exit(). */</span>
<a name="c0-4612"></a><span class="lineno">4612</span> 
<a name="c0-4613"></a><span class="lineno">4613</span> <span class="cm">/* Name of a shell function to call when a command name is not found. */</span>
<a name="c0-4614"></a><span class="lineno">4614</span> <span class="cp">#ifndef NOTFOUND_HOOK</span>
<a name="c0-4615"></a><span class="lineno">4615</span> <span class="cp">#  define NOTFOUND_HOOK "command_not_found_handle"</span>
<a name="c0-4616"></a><span class="lineno">4616</span> <span class="cp">#endif</span>
<a name="c0-4617"></a><span class="lineno">4617</span> 
<a name="c0-4618"></a><span class="lineno">4618</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-4619"></a><span class="lineno">4619</span> <span class="n">execute_disk_command</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">redirects</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span>
<a name="c0-4620"></a><span class="lineno">4620</span>          <span class="n">async</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span> <span class="n">cmdflags</span><span class="p">)</span>
<a name="c0-4621"></a><span class="lineno">4621</span>      <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c0-4622"></a><span class="lineno">4622</span>      <span class="n">REDIRECT</span> <span class="o">*</span><span class="n">redirects</span><span class="p">;</span>
<a name="c0-4623"></a><span class="lineno">4623</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">command_line</span><span class="p">;</span>
<a name="c0-4624"></a><span class="lineno">4624</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">,</span> <span class="n">async</span><span class="p">;</span>
<a name="c0-4625"></a><span class="lineno">4625</span>      <span class="k">struct</span> <span class="n">fd_bitmap</span> <span class="o">*</span><span class="n">fds_to_close</span><span class="p">;</span>
<a name="c0-4626"></a><span class="lineno">4626</span>      <span class="kt">int</span> <span class="n">cmdflags</span><span class="p">;</span>
<a name="c0-4627"></a><span class="lineno">4627</span> <span class="p">{</span>
<a name="c0-4628"></a><span class="lineno">4628</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">;</span>
<a name="c0-4629"></a><span class="lineno">4629</span>   <span class="kt">int</span> <span class="n">nofork</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-4630"></a><span class="lineno">4630</span>   <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<a name="c0-4631"></a><span class="lineno">4631</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">hookf</span><span class="p">;</span>
<a name="c0-4632"></a><span class="lineno">4632</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
<a name="c0-4633"></a><span class="lineno">4633</span> 
<a name="c0-4634"></a><span class="lineno">4634</span>   <span class="n">nofork</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdflags</span> <span class="o">&amp;</span> <span class="n">CMD_NO_FORK</span><span class="p">);</span>  <span class="cm">/* Don't fork, just exec, if no pipes */</span>
<a name="c0-4635"></a><span class="lineno">4635</span>   <span class="n">pathname</span> <span class="o">=</span> <span class="n">words</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">;</span>
<a name="c0-4636"></a><span class="lineno">4636</span> 
<a name="c0-4637"></a><span class="lineno">4637</span>   <span class="n">result</span> <span class="o">=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">;</span>
<a name="c0-4638"></a><span class="lineno">4638</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c0-4639"></a><span class="lineno">4639</span>   <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4640"></a><span class="lineno">4640</span>   <span class="k">if</span> <span class="p">(</span><span class="k">restricted</span> <span class="o">&amp;&amp;</span> <span class="n">mbschr</span> <span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">))</span>
<a name="c0-4641"></a><span class="lineno">4641</span>     <span class="p">{</span>
<a name="c0-4642"></a><span class="lineno">4642</span>       <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: restricted: cannot specify `/' in command names"</span><span class="p">),</span>
<a name="c0-4643"></a><span class="lineno">4643</span>        <span class="n">pathname</span><span class="p">);</span>
<a name="c0-4644"></a><span class="lineno">4644</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EXECUTION_FAILURE</span><span class="p">;</span>
<a name="c0-4645"></a><span class="lineno">4645</span> 
<a name="c0-4646"></a><span class="lineno">4646</span>       <span class="cm">/* If we're not going to fork below, we must already be in a child</span>
<a name="c0-4647"></a><span class="lineno">4647</span> <span class="cm">         process or a context in which it's safe to call exit(2).  */</span>
<a name="c0-4648"></a><span class="lineno">4648</span>       <span class="k">if</span> <span class="p">(</span><span class="n">nofork</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-4649"></a><span class="lineno">4649</span>  <span class="n">exit</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c0-4650"></a><span class="lineno">4650</span>       <span class="k">else</span>
<a name="c0-4651"></a><span class="lineno">4651</span>  <span class="k">goto</span> <span class="n">parent_return</span><span class="p">;</span>
<a name="c0-4652"></a><span class="lineno">4652</span>     <span class="p">}</span>
<a name="c0-4653"></a><span class="lineno">4653</span> <span class="cp">#endif </span><span class="cm">/* RESTRICTED_SHELL */</span><span class="cp"></span>
<a name="c0-4654"></a><span class="lineno">4654</span> 
<a name="c0-4655"></a><span class="lineno">4655</span>   <span class="n">command</span> <span class="o">=</span> <span class="n">search_for_command</span> <span class="p">(</span><span class="n">pathname</span><span class="p">);</span>
<a name="c0-4656"></a><span class="lineno">4656</span> 
<a name="c0-4657"></a><span class="lineno">4657</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a name="c0-4658"></a><span class="lineno">4658</span>     <span class="p">{</span>
<a name="c0-4659"></a><span class="lineno">4659</span>       <span class="n">maybe_make_export_env</span> <span class="p">();</span>
<a name="c0-4660"></a><span class="lineno">4660</span>       <span class="n">put_command_name_into_env</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
<a name="c0-4661"></a><span class="lineno">4661</span>     <span class="p">}</span>
<a name="c0-4662"></a><span class="lineno">4662</span> 
<a name="c0-4663"></a><span class="lineno">4663</span>   <span class="cm">/* We have to make the child before we check for the non-existence</span>
<a name="c0-4664"></a><span class="lineno">4664</span> <span class="cm">     of COMMAND, since we want the error messages to be redirected. */</span>
<a name="c0-4665"></a><span class="lineno">4665</span>   <span class="cm">/* If we can get away without forking and there are no pipes to deal with,</span>
<a name="c0-4666"></a><span class="lineno">4666</span> <span class="cm">     don't bother to fork, just directly exec the command. */</span>
<a name="c0-4667"></a><span class="lineno">4667</span>   <span class="k">if</span> <span class="p">(</span><span class="n">nofork</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span> <span class="n">pipe_out</span> <span class="o">==</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-4668"></a><span class="lineno">4668</span>     <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4669"></a><span class="lineno">4669</span>   <span class="k">else</span>
<a name="c0-4670"></a><span class="lineno">4670</span>     <span class="n">pid</span> <span class="o">=</span> <span class="n">make_child</span> <span class="p">(</span><span class="n">savestring</span> <span class="p">(</span><span class="n">command_line</span><span class="p">),</span> <span class="n">async</span><span class="p">);</span>
<a name="c0-4671"></a><span class="lineno">4671</span> 
<a name="c0-4672"></a><span class="lineno">4672</span>   <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4673"></a><span class="lineno">4673</span>     <span class="p">{</span>
<a name="c0-4674"></a><span class="lineno">4674</span>       <span class="kt">int</span> <span class="n">old_interactive</span><span class="p">;</span>
<a name="c0-4675"></a><span class="lineno">4675</span> 
<a name="c0-4676"></a><span class="lineno">4676</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c0-4677"></a><span class="lineno">4677</span> <span class="c">      /* This has been disabled for the time being. */</span>
<a name="c0-4678"></a><span class="lineno">4678</span> <span class="cp">#if !defined (ARG_MAX) || ARG_MAX &gt;= 10240</span>
<a name="c0-4679"></a><span class="lineno">4679</span> <span class="c">      if (posixly_correct == 0)</span>
<a name="c0-4680"></a><span class="lineno">4680</span> <span class="c"> put_gnu_argv_flags_into_env ((long)getpid (), glob_argv_flags);</span>
<a name="c0-4681"></a><span class="lineno">4681</span> <span class="cp">#endif</span>
<a name="c0-4682"></a><span class="lineno">4682</span> <span class="cp">#endif</span>
<a name="c0-4683"></a><span class="lineno">4683</span> 
<a name="c0-4684"></a><span class="lineno">4684</span>       <span class="n">reset_terminating_signals</span> <span class="p">();</span>  <span class="cm">/* XXX */</span>
<a name="c0-4685"></a><span class="lineno">4685</span>       <span class="cm">/* Cancel traps, in trap.c. */</span>
<a name="c0-4686"></a><span class="lineno">4686</span>       <span class="n">restore_original_signals</span> <span class="p">();</span>
<a name="c0-4687"></a><span class="lineno">4687</span> 
<a name="c0-4688"></a><span class="lineno">4688</span>       <span class="cm">/* restore_original_signals may have undone the work done</span>
<a name="c0-4689"></a><span class="lineno">4689</span> <span class="cm">   by make_child to ensure that SIGINT and SIGQUIT are ignored</span>
<a name="c0-4690"></a><span class="lineno">4690</span> <span class="cm">   in asynchronous children. */</span>
<a name="c0-4691"></a><span class="lineno">4691</span>       <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-4692"></a><span class="lineno">4692</span>  <span class="p">{</span>
<a name="c0-4693"></a><span class="lineno">4693</span>    <span class="k">if</span> <span class="p">((</span><span class="n">cmdflags</span> <span class="o">&amp;</span> <span class="n">CMD_STDIN_REDIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-4694"></a><span class="lineno">4694</span>    <span class="n">pipe_in</span> <span class="o">==</span> <span class="n">NO_PIPE</span> <span class="o">&amp;&amp;</span>
<a name="c0-4695"></a><span class="lineno">4695</span>    <span class="p">(</span><span class="n">stdin_redirects</span> <span class="p">(</span><span class="n">redirects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a name="c0-4696"></a><span class="lineno">4696</span>      <span class="n">async_redirect_stdin</span> <span class="p">();</span>
<a name="c0-4697"></a><span class="lineno">4697</span>    <span class="n">setup_async_signals</span> <span class="p">();</span>
<a name="c0-4698"></a><span class="lineno">4698</span>  <span class="p">}</span>
<a name="c0-4699"></a><span class="lineno">4699</span> 
<a name="c0-4700"></a><span class="lineno">4700</span>       <span class="cm">/* This functionality is now provided by close-on-exec of the</span>
<a name="c0-4701"></a><span class="lineno">4701</span> <span class="cm">   file descriptors manipulated by redirection and piping.</span>
<a name="c0-4702"></a><span class="lineno">4702</span> <span class="cm">   Some file descriptors still need to be closed in all children</span>
<a name="c0-4703"></a><span class="lineno">4703</span> <span class="cm">   because of the way bash does pipes; fds_to_close is a</span>
<a name="c0-4704"></a><span class="lineno">4704</span> <span class="cm">   bitmap of all such file descriptors. */</span>
<a name="c0-4705"></a><span class="lineno">4705</span>       <span class="k">if</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">)</span>
<a name="c0-4706"></a><span class="lineno">4706</span>  <span class="n">close_fd_bitmap</span> <span class="p">(</span><span class="n">fds_to_close</span><span class="p">);</span>
<a name="c0-4707"></a><span class="lineno">4707</span> 
<a name="c0-4708"></a><span class="lineno">4708</span>       <span class="n">do_piping</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-4709"></a><span class="lineno">4709</span> 
<a name="c0-4710"></a><span class="lineno">4710</span>       <span class="n">old_interactive</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">;</span>
<a name="c0-4711"></a><span class="lineno">4711</span>       <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-4712"></a><span class="lineno">4712</span>  <span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4713"></a><span class="lineno">4713</span> 
<a name="c0-4714"></a><span class="lineno">4714</span>       <span class="n">subshell_environment</span> <span class="o">=</span> <span class="n">SUBSHELL_FORK</span><span class="p">;</span>
<a name="c0-4715"></a><span class="lineno">4715</span> 
<a name="c0-4716"></a><span class="lineno">4716</span>       <span class="k">if</span> <span class="p">(</span><span class="n">redirects</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">do_redirections</span> <span class="p">(</span><span class="n">redirects</span><span class="p">,</span> <span class="n">RX_ACTIVE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
<a name="c0-4717"></a><span class="lineno">4717</span>  <span class="p">{</span>
<a name="c0-4718"></a><span class="lineno">4718</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-4719"></a><span class="lineno">4719</span>    <span class="cm">/* Try to remove named pipes that may have been created as the</span>
<a name="c0-4720"></a><span class="lineno">4720</span> <span class="cm">       result of redirections. */</span>
<a name="c0-4721"></a><span class="lineno">4721</span>    <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-4722"></a><span class="lineno">4722</span> <span class="cp">#endif </span><span class="cm">/* PROCESS_SUBSTITUTION */</span><span class="cp"></span>
<a name="c0-4723"></a><span class="lineno">4723</span>    <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-4724"></a><span class="lineno">4724</span>  <span class="p">}</span>
<a name="c0-4725"></a><span class="lineno">4725</span> 
<a name="c0-4726"></a><span class="lineno">4726</span>       <span class="k">if</span> <span class="p">(</span><span class="n">async</span><span class="p">)</span>
<a name="c0-4727"></a><span class="lineno">4727</span>  <span class="n">interactive</span> <span class="o">=</span> <span class="n">old_interactive</span><span class="p">;</span>
<a name="c0-4728"></a><span class="lineno">4728</span> 
<a name="c0-4729"></a><span class="lineno">4729</span>       <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4730"></a><span class="lineno">4730</span>  <span class="p">{</span>
<a name="c0-4731"></a><span class="lineno">4731</span>    <span class="n">hookf</span> <span class="o">=</span> <span class="n">find_function</span> <span class="p">(</span><span class="n">NOTFOUND_HOOK</span><span class="p">);</span>
<a name="c0-4732"></a><span class="lineno">4732</span>    <span class="k">if</span> <span class="p">(</span><span class="n">hookf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4733"></a><span class="lineno">4733</span>      <span class="p">{</span>
<a name="c0-4734"></a><span class="lineno">4734</span>        <span class="cm">/* Make sure filenames are displayed using printable characters */</span>
<a name="c0-4735"></a><span class="lineno">4735</span>        <span class="k">if</span> <span class="p">(</span><span class="n">ansic_shouldquote</span> <span class="p">(</span><span class="n">pathname</span><span class="p">))</span>
<a name="c0-4736"></a><span class="lineno">4736</span>    <span class="n">pathname</span> <span class="o">=</span> <span class="n">ansic_quote</span> <span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-4737"></a><span class="lineno">4737</span>        <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: command not found"</span><span class="p">),</span> <span class="n">pathname</span><span class="p">);</span>
<a name="c0-4738"></a><span class="lineno">4738</span>        <span class="n">exit</span> <span class="p">(</span><span class="n">EX_NOTFOUND</span><span class="p">);</span> <span class="cm">/* Posix.2 says the exit status is 127 */</span>
<a name="c0-4739"></a><span class="lineno">4739</span>      <span class="p">}</span>
<a name="c0-4740"></a><span class="lineno">4740</span> 
<a name="c0-4741"></a><span class="lineno">4741</span>    <span class="n">wl</span> <span class="o">=</span> <span class="n">make_word_list</span> <span class="p">(</span><span class="n">make_word</span> <span class="p">(</span><span class="n">NOTFOUND_HOOK</span><span class="p">),</span> <span class="n">words</span><span class="p">);</span>
<a name="c0-4742"></a><span class="lineno">4742</span>    <span class="n">exit</span> <span class="p">(</span><span class="n">execute_shell_function</span> <span class="p">(</span><span class="n">hookf</span><span class="p">,</span> <span class="n">wl</span><span class="p">));</span>
<a name="c0-4743"></a><span class="lineno">4743</span>  <span class="p">}</span>
<a name="c0-4744"></a><span class="lineno">4744</span> 
<a name="c0-4745"></a><span class="lineno">4745</span>       <span class="cm">/* Execve expects the command name to be in args[0].  So we</span>
<a name="c0-4746"></a><span class="lineno">4746</span> <span class="cm">   leave it there, in the same format that the user used to</span>
<a name="c0-4747"></a><span class="lineno">4747</span> <span class="cm">   type it in. */</span>
<a name="c0-4748"></a><span class="lineno">4748</span>       <span class="n">args</span> <span class="o">=</span> <span class="n">strvec_from_word_list</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-4749"></a><span class="lineno">4749</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">shell_execve</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">export_env</span><span class="p">));</span>
<a name="c0-4750"></a><span class="lineno">4750</span>     <span class="p">}</span>
<a name="c0-4751"></a><span class="lineno">4751</span>   <span class="k">else</span>
<a name="c0-4752"></a><span class="lineno">4752</span>     <span class="p">{</span>
<a name="c0-4753"></a><span class="lineno">4753</span> <span class="nl">parent_return:</span>
<a name="c0-4754"></a><span class="lineno">4754</span>       <span class="cm">/* Make sure that the pipes are closed in the parent. */</span>
<a name="c0-4755"></a><span class="lineno">4755</span>       <span class="n">close_pipes</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-4756"></a><span class="lineno">4756</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION) &amp;&amp; defined (HAVE_DEV_FD)</span>
<a name="c0-4757"></a><span class="lineno">4757</span>       <span class="k">if</span> <span class="p">(</span><span class="n">variable_context</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4758"></a><span class="lineno">4758</span>         <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c0-4759"></a><span class="lineno">4759</span> <span class="cp">#endif</span>
<a name="c0-4760"></a><span class="lineno">4760</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
<a name="c0-4761"></a><span class="lineno">4761</span>       <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-4762"></a><span class="lineno">4762</span>     <span class="p">}</span>
<a name="c0-4763"></a><span class="lineno">4763</span> <span class="p">}</span>
<a name="c0-4764"></a><span class="lineno">4764</span> 
<a name="c0-4765"></a><span class="lineno">4765</span> <span class="cm">/* CPP defines to decide whether a particular index into the #! line</span>
<a name="c0-4766"></a><span class="lineno">4766</span> <span class="cm">   corresponds to a valid interpreter name or argument character, or</span>
<a name="c0-4767"></a><span class="lineno">4767</span> <span class="cm">   whitespace.  The MSDOS define is to allow \r to be treated the same</span>
<a name="c0-4768"></a><span class="lineno">4768</span> <span class="cm">   as \n. */</span>
<a name="c0-4769"></a><span class="lineno">4769</span> 
<a name="c0-4770"></a><span class="lineno">4770</span> <span class="cp">#if !defined (MSDOS)</span>
<a name="c0-4771"></a><span class="lineno">4771</span> <span class="cp">#  define STRINGCHAR(ind) \</span>
<a name="c0-4772"></a><span class="lineno">4772</span> <span class="cp">    (ind &lt; sample_len &amp;&amp; !whitespace (sample[ind]) &amp;&amp; sample[ind] != '\n')</span>
<a name="c0-4773"></a><span class="lineno">4773</span> <span class="cp">#  define WHITECHAR(ind) \</span>
<a name="c0-4774"></a><span class="lineno">4774</span> <span class="cp">    (ind &lt; sample_len &amp;&amp; whitespace (sample[ind]))</span>
<a name="c0-4775"></a><span class="lineno">4775</span> <span class="cp">#else </span><span class="cm">/* MSDOS */</span><span class="cp"></span>
<a name="c0-4776"></a><span class="lineno">4776</span> <span class="cp">#  define STRINGCHAR(ind) \</span>
<a name="c0-4777"></a><span class="lineno">4777</span> <span class="cp">    (ind &lt; sample_len &amp;&amp; !whitespace (sample[ind]) &amp;&amp; sample[ind] != '\n' &amp;&amp; sample[ind] != '\r')</span>
<a name="c0-4778"></a><span class="lineno">4778</span> <span class="cp">#  define WHITECHAR(ind) \</span>
<a name="c0-4779"></a><span class="lineno">4779</span> <span class="cp">    (ind &lt; sample_len &amp;&amp; whitespace (sample[ind]))</span>
<a name="c0-4780"></a><span class="lineno">4780</span> <span class="cp">#endif  </span><span class="cm">/* MSDOS */</span><span class="cp"></span>
<a name="c0-4781"></a><span class="lineno">4781</span> 
<a name="c0-4782"></a><span class="lineno">4782</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<a name="c0-4783"></a><span class="lineno">4783</span> <span class="n">getinterp</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="n">endp</span><span class="p">)</span>
<a name="c0-4784"></a><span class="lineno">4784</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">sample</span><span class="p">;</span>
<a name="c0-4785"></a><span class="lineno">4785</span>      <span class="kt">int</span> <span class="n">sample_len</span><span class="p">,</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
<a name="c0-4786"></a><span class="lineno">4786</span> <span class="p">{</span>
<a name="c0-4787"></a><span class="lineno">4787</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-4788"></a><span class="lineno">4788</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">execname</span><span class="p">;</span>
<a name="c0-4789"></a><span class="lineno">4789</span>   <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
<a name="c0-4790"></a><span class="lineno">4790</span> 
<a name="c0-4791"></a><span class="lineno">4791</span>   <span class="cm">/* Find the name of the interpreter to exec. */</span>
<a name="c0-4792"></a><span class="lineno">4792</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sample_len</span> <span class="o">&amp;&amp;</span> <span class="n">whitespace</span> <span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-4793"></a><span class="lineno">4793</span>     <span class="p">;</span>
<a name="c0-4794"></a><span class="lineno">4794</span> 
<a name="c0-4795"></a><span class="lineno">4795</span>   <span class="k">for</span> <span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">STRINGCHAR</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-4796"></a><span class="lineno">4796</span>     <span class="p">;</span>
<a name="c0-4797"></a><span class="lineno">4797</span> 
<a name="c0-4798"></a><span class="lineno">4798</span>   <span class="n">execname</span> <span class="o">=</span> <span class="n">substring</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<a name="c0-4799"></a><span class="lineno">4799</span> 
<a name="c0-4800"></a><span class="lineno">4800</span>   <span class="k">if</span> <span class="p">(</span><span class="n">endp</span><span class="p">)</span>
<a name="c0-4801"></a><span class="lineno">4801</span>     <span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-4802"></a><span class="lineno">4802</span>   <span class="k">return</span> <span class="n">execname</span><span class="p">;</span>
<a name="c0-4803"></a><span class="lineno">4803</span> <span class="p">}</span>
<a name="c0-4804"></a><span class="lineno">4804</span> 
<a name="c0-4805"></a><span class="lineno">4805</span> <span class="cp">#if !defined (HAVE_HASH_BANG_EXEC)</span>
<a name="c0-4806"></a><span class="lineno">4806</span> <span class="cm">/* If the operating system on which we're running does not handle</span>
<a name="c0-4807"></a><span class="lineno">4807</span> <span class="cm">   the #! executable format, then help out.  SAMPLE is the text read</span>
<a name="c0-4808"></a><span class="lineno">4808</span> <span class="cm">   from the file, SAMPLE_LEN characters.  COMMAND is the name of</span>
<a name="c0-4809"></a><span class="lineno">4809</span> <span class="cm">   the script; it and ARGS, the arguments given by the user, will</span>
<a name="c0-4810"></a><span class="lineno">4810</span> <span class="cm">   become arguments to the specified interpreter.  ENV is the environment</span>
<a name="c0-4811"></a><span class="lineno">4811</span> <span class="cm">   to pass to the interpreter.</span>
<a name="c0-4812"></a><span class="lineno">4812</span> 
<a name="c0-4813"></a><span class="lineno">4813</span> <span class="cm">   The word immediately following the #! is the interpreter to execute.</span>
<a name="c0-4814"></a><span class="lineno">4814</span> <span class="cm">   A single argument to the interpreter is allowed. */</span>
<a name="c0-4815"></a><span class="lineno">4815</span> 
<a name="c0-4816"></a><span class="lineno">4816</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-4817"></a><span class="lineno">4817</span> <span class="n">execute_shell_script</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
<a name="c0-4818"></a><span class="lineno">4818</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">sample</span><span class="p">;</span>
<a name="c0-4819"></a><span class="lineno">4819</span>      <span class="kt">int</span> <span class="n">sample_len</span><span class="p">;</span>
<a name="c0-4820"></a><span class="lineno">4820</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-4821"></a><span class="lineno">4821</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">env</span><span class="p">;</span>
<a name="c0-4822"></a><span class="lineno">4822</span> <span class="p">{</span>
<a name="c0-4823"></a><span class="lineno">4823</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">execname</span><span class="p">,</span> <span class="o">*</span><span class="n">firstarg</span><span class="p">;</span>
<a name="c0-4824"></a><span class="lineno">4824</span>   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size_increment</span><span class="p">,</span> <span class="n">larry</span><span class="p">;</span>
<a name="c0-4825"></a><span class="lineno">4825</span> 
<a name="c0-4826"></a><span class="lineno">4826</span>   <span class="cm">/* Find the name of the interpreter to exec. */</span>
<a name="c0-4827"></a><span class="lineno">4827</span>   <span class="n">execname</span> <span class="o">=</span> <span class="n">getinterp</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
<a name="c0-4828"></a><span class="lineno">4828</span>   <span class="n">size_increment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-4829"></a><span class="lineno">4829</span> 
<a name="c0-4830"></a><span class="lineno">4830</span>   <span class="cm">/* Now the argument, if any. */</span>
<a name="c0-4831"></a><span class="lineno">4831</span>   <span class="k">for</span> <span class="p">(</span><span class="n">firstarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">WHITECHAR</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-4832"></a><span class="lineno">4832</span>     <span class="p">;</span>
<a name="c0-4833"></a><span class="lineno">4833</span> 
<a name="c0-4834"></a><span class="lineno">4834</span>   <span class="cm">/* If there is more text on the line, then it is an argument for the</span>
<a name="c0-4835"></a><span class="lineno">4835</span> <span class="cm">     interpreter. */</span>
<a name="c0-4836"></a><span class="lineno">4836</span> 
<a name="c0-4837"></a><span class="lineno">4837</span>   <span class="k">if</span> <span class="p">(</span><span class="n">STRINGCHAR</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  
<a name="c0-4838"></a><span class="lineno">4838</span>     <span class="p">{</span>
<a name="c0-4839"></a><span class="lineno">4839</span>       <span class="k">for</span> <span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">STRINGCHAR</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-4840"></a><span class="lineno">4840</span>  <span class="p">;</span>
<a name="c0-4841"></a><span class="lineno">4841</span>       <span class="n">firstarg</span> <span class="o">=</span> <span class="n">substring</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sample</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<a name="c0-4842"></a><span class="lineno">4842</span>       <span class="n">size_increment</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-4843"></a><span class="lineno">4843</span>     <span class="p">}</span>
<a name="c0-4844"></a><span class="lineno">4844</span> 
<a name="c0-4845"></a><span class="lineno">4845</span>   <span class="n">larry</span> <span class="o">=</span> <span class="n">strvec_len</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_increment</span><span class="p">;</span>
<a name="c0-4846"></a><span class="lineno">4846</span>   <span class="n">args</span> <span class="o">=</span> <span class="n">strvec_resize</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">larry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-4847"></a><span class="lineno">4847</span> 
<a name="c0-4848"></a><span class="lineno">4848</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">larry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
<a name="c0-4849"></a><span class="lineno">4849</span>     <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">size_increment</span><span class="p">];</span>
<a name="c0-4850"></a><span class="lineno">4850</span> 
<a name="c0-4851"></a><span class="lineno">4851</span>   <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">execname</span><span class="p">;</span>
<a name="c0-4852"></a><span class="lineno">4852</span>   <span class="k">if</span> <span class="p">(</span><span class="n">firstarg</span><span class="p">)</span>
<a name="c0-4853"></a><span class="lineno">4853</span>     <span class="p">{</span>
<a name="c0-4854"></a><span class="lineno">4854</span>       <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">firstarg</span><span class="p">;</span>
<a name="c0-4855"></a><span class="lineno">4855</span>       <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<a name="c0-4856"></a><span class="lineno">4856</span>     <span class="p">}</span>
<a name="c0-4857"></a><span class="lineno">4857</span>   <span class="k">else</span>
<a name="c0-4858"></a><span class="lineno">4858</span>     <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<a name="c0-4859"></a><span class="lineno">4859</span> 
<a name="c0-4860"></a><span class="lineno">4860</span>   <span class="n">args</span><span class="p">[</span><span class="n">larry</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-4861"></a><span class="lineno">4861</span> 
<a name="c0-4862"></a><span class="lineno">4862</span>   <span class="k">return</span> <span class="p">(</span><span class="n">shell_execve</span> <span class="p">(</span><span class="n">execname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">));</span>
<a name="c0-4863"></a><span class="lineno">4863</span> <span class="p">}</span>
<a name="c0-4864"></a><span class="lineno">4864</span> <span class="cp">#undef STRINGCHAR</span>
<a name="c0-4865"></a><span class="lineno">4865</span> <span class="cp">#undef WHITECHAR</span>
<a name="c0-4866"></a><span class="lineno">4866</span> 
<a name="c0-4867"></a><span class="lineno">4867</span> <span class="cp">#endif </span><span class="cm">/* !HAVE_HASH_BANG_EXEC */</span><span class="cp"></span>
<a name="c0-4868"></a><span class="lineno">4868</span> 
<a name="c0-4869"></a><span class="lineno">4869</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-4870"></a><span class="lineno">4870</span> <span class="n">initialize_subshell</span> <span class="p">()</span>
<a name="c0-4871"></a><span class="lineno">4871</span> <span class="p">{</span>
<a name="c0-4872"></a><span class="lineno">4872</span> <span class="cp">#if defined (ALIAS)</span>
<a name="c0-4873"></a><span class="lineno">4873</span>   <span class="cm">/* Forget about any aliases that we knew of.  We are in a subshell. */</span>
<a name="c0-4874"></a><span class="lineno">4874</span>   <span class="n">delete_all_aliases</span> <span class="p">();</span>
<a name="c0-4875"></a><span class="lineno">4875</span> <span class="cp">#endif </span><span class="cm">/* ALIAS */</span><span class="cp"></span>
<a name="c0-4876"></a><span class="lineno">4876</span> 
<a name="c0-4877"></a><span class="lineno">4877</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c0-4878"></a><span class="lineno">4878</span>   <span class="cm">/* Forget about the history lines we have read.  This is a non-interactive</span>
<a name="c0-4879"></a><span class="lineno">4879</span> <span class="cm">     subshell. */</span>
<a name="c0-4880"></a><span class="lineno">4880</span>   <span class="n">history_lines_this_session</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4881"></a><span class="lineno">4881</span> <span class="cp">#endif</span>
<a name="c0-4882"></a><span class="lineno">4882</span> 
<a name="c0-4883"></a><span class="lineno">4883</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c0-4884"></a><span class="lineno">4884</span>   <span class="cm">/* Forget about the way job control was working. We are in a subshell. */</span>
<a name="c0-4885"></a><span class="lineno">4885</span>   <span class="n">without_job_control</span> <span class="p">();</span>
<a name="c0-4886"></a><span class="lineno">4886</span>   <span class="n">set_sigchld_handler</span> <span class="p">();</span>
<a name="c0-4887"></a><span class="lineno">4887</span>   <span class="n">init_job_stats</span> <span class="p">();</span>
<a name="c0-4888"></a><span class="lineno">4888</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c0-4889"></a><span class="lineno">4889</span> 
<a name="c0-4890"></a><span class="lineno">4890</span>   <span class="cm">/* Reset the values of the shell flags and options. */</span>
<a name="c0-4891"></a><span class="lineno">4891</span>   <span class="n">reset_shell_flags</span> <span class="p">();</span>
<a name="c0-4892"></a><span class="lineno">4892</span>   <span class="n">reset_shell_options</span> <span class="p">();</span>
<a name="c0-4893"></a><span class="lineno">4893</span>   <span class="n">reset_shopt_options</span> <span class="p">();</span>
<a name="c0-4894"></a><span class="lineno">4894</span> 
<a name="c0-4895"></a><span class="lineno">4895</span>   <span class="cm">/* Zero out builtin_env, since this could be a shell script run from a</span>
<a name="c0-4896"></a><span class="lineno">4896</span> <span class="cm">     sourced file with a temporary environment supplied to the `source/.'</span>
<a name="c0-4897"></a><span class="lineno">4897</span> <span class="cm">     builtin.  Such variables are not supposed to be exported (empirical</span>
<a name="c0-4898"></a><span class="lineno">4898</span> <span class="cm">     testing with sh and ksh).  Just throw it away; don't worry about a</span>
<a name="c0-4899"></a><span class="lineno">4899</span> <span class="cm">     memory leak. */</span>
<a name="c0-4900"></a><span class="lineno">4900</span>   <span class="k">if</span> <span class="p">(</span><span class="n">vc_isbltnenv</span> <span class="p">(</span><span class="n">shell_variables</span><span class="p">))</span>
<a name="c0-4901"></a><span class="lineno">4901</span>     <span class="n">shell_variables</span> <span class="o">=</span> <span class="n">shell_variables</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
<a name="c0-4902"></a><span class="lineno">4902</span> 
<a name="c0-4903"></a><span class="lineno">4903</span>   <span class="n">clear_unwind_protect_list</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-4904"></a><span class="lineno">4904</span>   <span class="cm">/* XXX -- are there other things we should be resetting here? */</span>
<a name="c0-4905"></a><span class="lineno">4905</span>   <span class="n">parse_and_execute_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* nothing left to restore it */</span>
<a name="c0-4906"></a><span class="lineno">4906</span> 
<a name="c0-4907"></a><span class="lineno">4907</span>   <span class="cm">/* We're no longer inside a shell function. */</span>
<a name="c0-4908"></a><span class="lineno">4908</span>   <span class="n">variable_context</span> <span class="o">=</span> <span class="n">return_catch_flag</span> <span class="o">=</span> <span class="n">funcnest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-4909"></a><span class="lineno">4909</span> 
<a name="c0-4910"></a><span class="lineno">4910</span>   <span class="n">executing_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* XXX */</span>
<a name="c0-4911"></a><span class="lineno">4911</span> 
<a name="c0-4912"></a><span class="lineno">4912</span>   <span class="cm">/* If we're not interactive, close the file descriptor from which we're</span>
<a name="c0-4913"></a><span class="lineno">4913</span> <span class="cm">     reading the current shell script. */</span>
<a name="c0-4914"></a><span class="lineno">4914</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4915"></a><span class="lineno">4915</span>     <span class="n">unset_bash_input</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c0-4916"></a><span class="lineno">4916</span> <span class="p">}</span>
<a name="c0-4917"></a><span class="lineno">4917</span> 
<a name="c0-4918"></a><span class="lineno">4918</span> <span class="cp">#if defined (HAVE_SETOSTYPE) &amp;&amp; defined (_POSIX_SOURCE)</span>
<a name="c0-4919"></a><span class="lineno">4919</span> <span class="cp">#  define SETOSTYPE(x)  __setostype(x)</span>
<a name="c0-4920"></a><span class="lineno">4920</span> <span class="cp">#else</span>
<a name="c0-4921"></a><span class="lineno">4921</span> <span class="cp">#  define SETOSTYPE(x)</span>
<a name="c0-4922"></a><span class="lineno">4922</span> <span class="cp">#endif</span>
<a name="c0-4923"></a><span class="lineno">4923</span> 
<a name="c0-4924"></a><span class="lineno">4924</span> <span class="cp">#define READ_SAMPLE_BUF(file, buf, len) \</span>
<a name="c0-4925"></a><span class="lineno">4925</span> <span class="cp">  do \</span>
<a name="c0-4926"></a><span class="lineno">4926</span> <span class="cp">    { \</span>
<a name="c0-4927"></a><span class="lineno">4927</span> <span class="cp">      fd = open(file, O_RDONLY); \</span>
<a name="c0-4928"></a><span class="lineno">4928</span> <span class="cp">      if (fd &gt;= 0) \</span>
<a name="c0-4929"></a><span class="lineno">4929</span> <span class="cp">  { \</span>
<a name="c0-4930"></a><span class="lineno">4930</span> <span class="cp">    len = read (fd, buf, 80); \</span>
<a name="c0-4931"></a><span class="lineno">4931</span> <span class="cp">    close (fd); \</span>
<a name="c0-4932"></a><span class="lineno">4932</span> <span class="cp">  } \</span>
<a name="c0-4933"></a><span class="lineno">4933</span> <span class="cp">      else \</span>
<a name="c0-4934"></a><span class="lineno">4934</span> <span class="cp">  len = -1; \</span>
<a name="c0-4935"></a><span class="lineno">4935</span> <span class="cp">    } \</span>
<a name="c0-4936"></a><span class="lineno">4936</span> <span class="cp">  while (0)</span>
<a name="c0-4937"></a><span class="lineno">4937</span>       
<a name="c0-4938"></a><span class="lineno">4938</span> <span class="cm">/* Call execve (), handling interpreting shell scripts, and handling</span>
<a name="c0-4939"></a><span class="lineno">4939</span> <span class="cm">   exec failures. */</span>
<a name="c0-4940"></a><span class="lineno">4940</span> <span class="kt">int</span>
<a name="c0-4941"></a><span class="lineno">4941</span> <span class="n">shell_execve</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
<a name="c0-4942"></a><span class="lineno">4942</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c0-4943"></a><span class="lineno">4943</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">env</span><span class="p">;</span>
<a name="c0-4944"></a><span class="lineno">4944</span> <span class="p">{</span>
<a name="c0-4945"></a><span class="lineno">4945</span>   <span class="kt">int</span> <span class="n">larray</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-4946"></a><span class="lineno">4946</span>   <span class="kt">char</span> <span class="n">sample</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
<a name="c0-4947"></a><span class="lineno">4947</span>   <span class="kt">int</span> <span class="n">sample_len</span><span class="p">;</span>
<a name="c0-4948"></a><span class="lineno">4948</span> 
<a name="c0-4949"></a><span class="lineno">4949</span>   <span class="n">SETOSTYPE</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>    <span class="cm">/* Some systems use for USG/POSIX semantics */</span>
<a name="c0-4950"></a><span class="lineno">4950</span>   <span class="n">execve</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
<a name="c0-4951"></a><span class="lineno">4951</span>   <span class="n">i</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>     <span class="cm">/* error from execve() */</span>
<a name="c0-4952"></a><span class="lineno">4952</span>   <span class="n">CHECK_TERMSIG</span><span class="p">;</span>
<a name="c0-4953"></a><span class="lineno">4953</span>   <span class="n">SETOSTYPE</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-4954"></a><span class="lineno">4954</span> 
<a name="c0-4955"></a><span class="lineno">4955</span>   <span class="cm">/* If we get to this point, then start checking out the file.</span>
<a name="c0-4956"></a><span class="lineno">4956</span> <span class="cm">     Maybe it is something we can hack ourselves. */</span>
<a name="c0-4957"></a><span class="lineno">4957</span>   <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ENOEXEC</span><span class="p">)</span>
<a name="c0-4958"></a><span class="lineno">4958</span>     <span class="p">{</span>
<a name="c0-4959"></a><span class="lineno">4959</span>       <span class="k">if</span> <span class="p">(</span><span class="n">file_isdir</span> <span class="p">(</span><span class="n">command</span><span class="p">))</span>
<a name="c0-4960"></a><span class="lineno">4960</span> <span class="cp">#if defined (EISDIR)</span>
<a name="c0-4961"></a><span class="lineno">4961</span>  <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">),</span> <span class="n">command</span><span class="p">,</span> <span class="n">strerror</span> <span class="p">(</span><span class="n">EISDIR</span><span class="p">));</span>
<a name="c0-4962"></a><span class="lineno">4962</span> <span class="cp">#else</span>
<a name="c0-4963"></a><span class="lineno">4963</span>  <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: is a directory"</span><span class="p">),</span> <span class="n">command</span><span class="p">);</span>
<a name="c0-4964"></a><span class="lineno">4964</span> <span class="cp">#endif</span>
<a name="c0-4965"></a><span class="lineno">4965</span>       <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">executable_file</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-4966"></a><span class="lineno">4966</span>  <span class="p">{</span>
<a name="c0-4967"></a><span class="lineno">4967</span>    <span class="n">errno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-4968"></a><span class="lineno">4968</span>    <span class="n">file_error</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
<a name="c0-4969"></a><span class="lineno">4969</span>  <span class="p">}</span>
<a name="c0-4970"></a><span class="lineno">4970</span>       <span class="cm">/* errors not involving the path argument to execve. */</span>
<a name="c0-4971"></a><span class="lineno">4971</span>       <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">E2BIG</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ENOMEM</span><span class="p">)</span>
<a name="c0-4972"></a><span class="lineno">4972</span>  <span class="p">{</span>
<a name="c0-4973"></a><span class="lineno">4973</span>    <span class="n">errno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-4974"></a><span class="lineno">4974</span>    <span class="n">file_error</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
<a name="c0-4975"></a><span class="lineno">4975</span>  <span class="p">}</span>
<a name="c0-4976"></a><span class="lineno">4976</span>       <span class="k">else</span>
<a name="c0-4977"></a><span class="lineno">4977</span>  <span class="p">{</span>
<a name="c0-4978"></a><span class="lineno">4978</span>    <span class="cm">/* The file has the execute bits set, but the kernel refuses to</span>
<a name="c0-4979"></a><span class="lineno">4979</span> <span class="cm">       run it for some reason.  See why. */</span>
<a name="c0-4980"></a><span class="lineno">4980</span> <span class="cp">#if defined (HAVE_HASH_BANG_EXEC)</span>
<a name="c0-4981"></a><span class="lineno">4981</span>    <span class="n">READ_SAMPLE_BUF</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">);</span>
<a name="c0-4982"></a><span class="lineno">4982</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sample_len</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'#'</span> <span class="o">&amp;&amp;</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'!'</span><span class="p">)</span>
<a name="c0-4983"></a><span class="lineno">4983</span>      <span class="p">{</span>
<a name="c0-4984"></a><span class="lineno">4984</span>        <span class="kt">char</span> <span class="o">*</span><span class="n">interp</span><span class="p">;</span>
<a name="c0-4985"></a><span class="lineno">4985</span>        <span class="kt">int</span> <span class="n">ilen</span><span class="p">;</span>
<a name="c0-4986"></a><span class="lineno">4986</span> 
<a name="c0-4987"></a><span class="lineno">4987</span>        <span class="n">interp</span> <span class="o">=</span> <span class="n">getinterp</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c0-4988"></a><span class="lineno">4988</span>        <span class="n">ilen</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">interp</span><span class="p">);</span>
<a name="c0-4989"></a><span class="lineno">4989</span>        <span class="n">errno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-4990"></a><span class="lineno">4990</span>        <span class="k">if</span> <span class="p">(</span><span class="n">interp</span><span class="p">[</span><span class="n">ilen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span>
<a name="c0-4991"></a><span class="lineno">4991</span>    <span class="p">{</span>
<a name="c0-4992"></a><span class="lineno">4992</span>      <span class="n">interp</span> <span class="o">=</span> <span class="n">xrealloc</span> <span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">ilen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<a name="c0-4993"></a><span class="lineno">4993</span>      <span class="n">interp</span><span class="p">[</span><span class="n">ilen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'^'</span><span class="p">;</span>
<a name="c0-4994"></a><span class="lineno">4994</span>      <span class="n">interp</span><span class="p">[</span><span class="n">ilen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'M'</span><span class="p">;</span>
<a name="c0-4995"></a><span class="lineno">4995</span>      <span class="n">interp</span><span class="p">[</span><span class="n">ilen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-4996"></a><span class="lineno">4996</span>    <span class="p">}</span>
<a name="c0-4997"></a><span class="lineno">4997</span>        <span class="n">sys_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: %s: bad interpreter"</span><span class="p">),</span> <span class="n">command</span><span class="p">,</span> <span class="n">interp</span> <span class="o">?</span> <span class="n">interp</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
<a name="c0-4998"></a><span class="lineno">4998</span>        <span class="n">FREE</span> <span class="p">(</span><span class="n">interp</span><span class="p">);</span>
<a name="c0-4999"></a><span class="lineno">4999</span>        <span class="k">return</span> <span class="p">(</span><span class="n">EX_NOEXEC</span><span class="p">);</span>
<a name="c0-5000"></a><span class="lineno">5000</span>      <span class="p">}</span>
<a name="c0-5001"></a><span class="lineno">5001</span> <span class="cp">#endif</span>
<a name="c0-5002"></a><span class="lineno">5002</span>    <span class="n">errno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-5003"></a><span class="lineno">5003</span>    <span class="n">file_error</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
<a name="c0-5004"></a><span class="lineno">5004</span>  <span class="p">}</span>
<a name="c0-5005"></a><span class="lineno">5005</span>       <span class="k">return</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="o">?</span> <span class="n">EX_NOTFOUND</span> <span class="o">:</span> <span class="n">EX_NOEXEC</span><span class="p">);</span> <span class="cm">/* XXX Posix.2 says that exit status is 126 */</span>
<a name="c0-5006"></a><span class="lineno">5006</span>     <span class="p">}</span>
<a name="c0-5007"></a><span class="lineno">5007</span> 
<a name="c0-5008"></a><span class="lineno">5008</span>   <span class="cm">/* This file is executable.</span>
<a name="c0-5009"></a><span class="lineno">5009</span> <span class="cm">     If it begins with #!, then help out people with losing operating</span>
<a name="c0-5010"></a><span class="lineno">5010</span> <span class="cm">     systems.  Otherwise, check to see if it is a binary file by seeing</span>
<a name="c0-5011"></a><span class="lineno">5011</span> <span class="cm">     if the contents of the first line (or up to 80 characters) are in the</span>
<a name="c0-5012"></a><span class="lineno">5012</span> <span class="cm">     ASCII set.  If it's a text file, execute the contents as shell commands,</span>
<a name="c0-5013"></a><span class="lineno">5013</span> <span class="cm">     otherwise return 126 (EX_BINARY_FILE). */</span>
<a name="c0-5014"></a><span class="lineno">5014</span>   <span class="n">READ_SAMPLE_BUF</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">);</span>
<a name="c0-5015"></a><span class="lineno">5015</span> 
<a name="c0-5016"></a><span class="lineno">5016</span>   <span class="k">if</span> <span class="p">(</span><span class="n">sample_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5017"></a><span class="lineno">5017</span>     <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-5018"></a><span class="lineno">5018</span> 
<a name="c0-5019"></a><span class="lineno">5019</span>   <span class="cm">/* Is this supposed to be an executable script?</span>
<a name="c0-5020"></a><span class="lineno">5020</span> <span class="cm">     If so, the format of the line is "#! interpreter [argument]".</span>
<a name="c0-5021"></a><span class="lineno">5021</span> <span class="cm">     A single argument is allowed.  The BSD kernel restricts</span>
<a name="c0-5022"></a><span class="lineno">5022</span> <span class="cm">     the length of the entire line to 32 characters (32 bytes</span>
<a name="c0-5023"></a><span class="lineno">5023</span> <span class="cm">     being the size of the BSD exec header), but we allow 80</span>
<a name="c0-5024"></a><span class="lineno">5024</span> <span class="cm">     characters. */</span>
<a name="c0-5025"></a><span class="lineno">5025</span>   <span class="k">if</span> <span class="p">(</span><span class="n">sample_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5026"></a><span class="lineno">5026</span>     <span class="p">{</span>
<a name="c0-5027"></a><span class="lineno">5027</span> <span class="cp">#if !defined (HAVE_HASH_BANG_EXEC)</span>
<a name="c0-5028"></a><span class="lineno">5028</span>       <span class="k">if</span> <span class="p">(</span><span class="n">sample_len</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'#'</span> <span class="o">&amp;&amp;</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'!'</span><span class="p">)</span>
<a name="c0-5029"></a><span class="lineno">5029</span>  <span class="k">return</span> <span class="p">(</span><span class="n">execute_shell_script</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">));</span>
<a name="c0-5030"></a><span class="lineno">5030</span>       <span class="k">else</span>
<a name="c0-5031"></a><span class="lineno">5031</span> <span class="cp">#endif</span>
<a name="c0-5032"></a><span class="lineno">5032</span>       <span class="k">if</span> <span class="p">(</span><span class="n">check_binary_file</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">))</span>
<a name="c0-5033"></a><span class="lineno">5033</span>  <span class="p">{</span>
<a name="c0-5034"></a><span class="lineno">5034</span>    <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: cannot execute binary file"</span><span class="p">),</span> <span class="n">command</span><span class="p">);</span>
<a name="c0-5035"></a><span class="lineno">5035</span>    <span class="k">return</span> <span class="p">(</span><span class="n">EX_BINARY_FILE</span><span class="p">);</span>
<a name="c0-5036"></a><span class="lineno">5036</span>  <span class="p">}</span>
<a name="c0-5037"></a><span class="lineno">5037</span>     <span class="p">}</span>
<a name="c0-5038"></a><span class="lineno">5038</span> 
<a name="c0-5039"></a><span class="lineno">5039</span>   <span class="cm">/* We have committed to attempting to execute the contents of this file</span>
<a name="c0-5040"></a><span class="lineno">5040</span> <span class="cm">     as shell commands. */</span>
<a name="c0-5041"></a><span class="lineno">5041</span> 
<a name="c0-5042"></a><span class="lineno">5042</span>   <span class="n">initialize_subshell</span> <span class="p">();</span>
<a name="c0-5043"></a><span class="lineno">5043</span> 
<a name="c0-5044"></a><span class="lineno">5044</span>   <span class="n">set_sigint_handler</span> <span class="p">();</span>
<a name="c0-5045"></a><span class="lineno">5045</span> 
<a name="c0-5046"></a><span class="lineno">5046</span>   <span class="cm">/* Insert the name of this shell into the argument list. */</span>
<a name="c0-5047"></a><span class="lineno">5047</span>   <span class="n">larray</span> <span class="o">=</span> <span class="n">strvec_len</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-5048"></a><span class="lineno">5048</span>   <span class="n">args</span> <span class="o">=</span> <span class="n">strvec_resize</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">larray</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-5049"></a><span class="lineno">5049</span> 
<a name="c0-5050"></a><span class="lineno">5050</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">larray</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
<a name="c0-5051"></a><span class="lineno">5051</span>     <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<a name="c0-5052"></a><span class="lineno">5052</span> 
<a name="c0-5053"></a><span class="lineno">5053</span>   <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell_name</span><span class="p">;</span>
<a name="c0-5054"></a><span class="lineno">5054</span>   <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
<a name="c0-5055"></a><span class="lineno">5055</span>   <span class="n">args</span><span class="p">[</span><span class="n">larray</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-5056"></a><span class="lineno">5056</span> 
<a name="c0-5057"></a><span class="lineno">5057</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-5058"></a><span class="lineno">5058</span>     <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<a name="c0-5059"></a><span class="lineno">5059</span> 
<a name="c0-5060"></a><span class="lineno">5060</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c0-5061"></a><span class="lineno">5061</span>   <span class="k">if</span> <span class="p">(</span><span class="k">restricted</span><span class="p">)</span>
<a name="c0-5062"></a><span class="lineno">5062</span>     <span class="n">change_flag</span> <span class="p">(</span><span class="sc">'r'</span><span class="p">,</span> <span class="n">FLAG_OFF</span><span class="p">);</span>
<a name="c0-5063"></a><span class="lineno">5063</span> <span class="cp">#endif</span>
<a name="c0-5064"></a><span class="lineno">5064</span> 
<a name="c0-5065"></a><span class="lineno">5065</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell_argv</span><span class="p">)</span>
<a name="c0-5066"></a><span class="lineno">5066</span>     <span class="p">{</span>
<a name="c0-5067"></a><span class="lineno">5067</span>       <span class="cm">/* Can't free subshell_argv[0]; that is shell_name. */</span>
<a name="c0-5068"></a><span class="lineno">5068</span>       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">subshell_argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-5069"></a><span class="lineno">5069</span>  <span class="n">free</span> <span class="p">(</span><span class="n">subshell_argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-5070"></a><span class="lineno">5070</span>       <span class="n">free</span> <span class="p">(</span><span class="n">subshell_argv</span><span class="p">);</span>
<a name="c0-5071"></a><span class="lineno">5071</span>     <span class="p">}</span>
<a name="c0-5072"></a><span class="lineno">5072</span> 
<a name="c0-5073"></a><span class="lineno">5073</span>   <span class="n">dispose_command</span> <span class="p">(</span><span class="n">currently_executing_command</span><span class="p">);</span> <span class="cm">/* XXX */</span>
<a name="c0-5074"></a><span class="lineno">5074</span>   <span class="n">currently_executing_command</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c0-5075"></a><span class="lineno">5075</span> 
<a name="c0-5076"></a><span class="lineno">5076</span>   <span class="n">subshell_argc</span> <span class="o">=</span> <span class="n">larray</span><span class="p">;</span>
<a name="c0-5077"></a><span class="lineno">5077</span>   <span class="n">subshell_argv</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
<a name="c0-5078"></a><span class="lineno">5078</span>   <span class="n">subshell_envp</span> <span class="o">=</span> <span class="n">env</span><span class="p">;</span>
<a name="c0-5079"></a><span class="lineno">5079</span> 
<a name="c0-5080"></a><span class="lineno">5080</span>   <span class="n">unbind_args</span> <span class="p">();</span>  <span class="cm">/* remove the positional parameters */</span>
<a name="c0-5081"></a><span class="lineno">5081</span> 
<a name="c0-5082"></a><span class="lineno">5082</span>   <span class="n">longjmp</span> <span class="p">(</span><span class="n">subshell_top_level</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-5083"></a><span class="lineno">5083</span>   <span class="cm">/*NOTREACHED*/</span>
<a name="c0-5084"></a><span class="lineno">5084</span> <span class="p">}</span>
<a name="c0-5085"></a><span class="lineno">5085</span> 
<a name="c0-5086"></a><span class="lineno">5086</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c0-5087"></a><span class="lineno">5087</span> <span class="n">execute_intern_function</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
<a name="c0-5088"></a><span class="lineno">5088</span>      <span class="n">WORD_DESC</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-5089"></a><span class="lineno">5089</span>      <span class="n">COMMAND</span> <span class="o">*</span><span class="n">function</span><span class="p">;</span>
<a name="c0-5090"></a><span class="lineno">5090</span> <span class="p">{</span>
<a name="c0-5091"></a><span class="lineno">5091</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<a name="c0-5092"></a><span class="lineno">5092</span> 
<a name="c0-5093"></a><span class="lineno">5093</span>   <span class="k">if</span> <span class="p">(</span><span class="n">check_identifier</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">posixly_correct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5094"></a><span class="lineno">5094</span>     <span class="p">{</span>
<a name="c0-5095"></a><span class="lineno">5095</span>       <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5096"></a><span class="lineno">5096</span>  <span class="p">{</span>
<a name="c0-5097"></a><span class="lineno">5097</span>    <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">EX_BADUSAGE</span><span class="p">;</span>
<a name="c0-5098"></a><span class="lineno">5098</span>    <span class="n">jump_to_top_level</span> <span class="p">(</span><span class="n">ERREXIT</span><span class="p">);</span>
<a name="c0-5099"></a><span class="lineno">5099</span>  <span class="p">}</span>
<a name="c0-5100"></a><span class="lineno">5100</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-5101"></a><span class="lineno">5101</span>     <span class="p">}</span>
<a name="c0-5102"></a><span class="lineno">5102</span> 
<a name="c0-5103"></a><span class="lineno">5103</span>   <span class="n">var</span> <span class="o">=</span> <span class="n">find_function</span> <span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c0-5104"></a><span class="lineno">5104</span>   <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readonly_p</span> <span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">||</span> <span class="n">noassign_p</span> <span class="p">(</span><span class="n">var</span><span class="p">)))</span>
<a name="c0-5105"></a><span class="lineno">5105</span>     <span class="p">{</span>
<a name="c0-5106"></a><span class="lineno">5106</span>       <span class="k">if</span> <span class="p">(</span><span class="n">readonly_p</span> <span class="p">(</span><span class="n">var</span><span class="p">))</span>
<a name="c0-5107"></a><span class="lineno">5107</span>  <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: readonly function"</span><span class="p">),</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-5108"></a><span class="lineno">5108</span>       <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_FAILURE</span><span class="p">);</span>
<a name="c0-5109"></a><span class="lineno">5109</span>     <span class="p">}</span>
<a name="c0-5110"></a><span class="lineno">5110</span> 
<a name="c0-5111"></a><span class="lineno">5111</span>   <span class="n">bind_function</span> <span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
<a name="c0-5112"></a><span class="lineno">5112</span>   <span class="k">return</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c0-5113"></a><span class="lineno">5113</span> <span class="p">}</span>
<a name="c0-5114"></a><span class="lineno">5114</span> 
<a name="c0-5115"></a><span class="lineno">5115</span> <span class="cp">#if defined (INCLUDE_UNUSED)</span>
<a name="c0-5116"></a><span class="lineno">5116</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c0-5117"></a><span class="lineno">5117</span> <span class="kt">void</span>
<a name="c0-5118"></a><span class="lineno">5118</span> <span class="n">close_all_files</span> <span class="p">()</span>
<a name="c0-5119"></a><span class="lineno">5119</span> <span class="p">{</span>
<a name="c0-5120"></a><span class="lineno">5120</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fd_table_size</span><span class="p">;</span>
<a name="c0-5121"></a><span class="lineno">5121</span> 
<a name="c0-5122"></a><span class="lineno">5122</span>   <span class="n">fd_table_size</span> <span class="o">=</span> <span class="n">getdtablesize</span> <span class="p">();</span>
<a name="c0-5123"></a><span class="lineno">5123</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fd_table_size</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="cm">/* clamp to a reasonable value */</span>
<a name="c0-5124"></a><span class="lineno">5124</span>     <span class="n">fd_table_size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<a name="c0-5125"></a><span class="lineno">5125</span> 
<a name="c0-5126"></a><span class="lineno">5126</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-5127"></a><span class="lineno">5127</span>     <span class="n">close</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="c0-5128"></a><span class="lineno">5128</span> <span class="p">}</span>
<a name="c0-5129"></a><span class="lineno">5129</span> <span class="cp">#endif </span><span class="cm">/* PROCESS_SUBSTITUTION */</span><span class="cp"></span>
<a name="c0-5130"></a><span class="lineno">5130</span> <span class="cp">#endif</span>
<a name="c0-5131"></a><span class="lineno">5131</span> 
<a name="c0-5132"></a><span class="lineno">5132</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-5133"></a><span class="lineno">5133</span> <span class="n">close_pipes</span> <span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<a name="c0-5134"></a><span class="lineno">5134</span>      <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">;</span>
<a name="c0-5135"></a><span class="lineno">5135</span> <span class="p">{</span>
<a name="c0-5136"></a><span class="lineno">5136</span>   <span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5137"></a><span class="lineno">5137</span>     <span class="n">close</span> <span class="p">(</span><span class="n">in</span><span class="p">);</span>
<a name="c0-5138"></a><span class="lineno">5138</span>   <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5139"></a><span class="lineno">5139</span>     <span class="n">close</span> <span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c0-5140"></a><span class="lineno">5140</span> <span class="p">}</span>
<a name="c0-5141"></a><span class="lineno">5141</span> 
<a name="c0-5142"></a><span class="lineno">5142</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-5143"></a><span class="lineno">5143</span> <span class="n">dup_error</span> <span class="p">(</span><span class="n">oldd</span><span class="p">,</span> <span class="n">newd</span><span class="p">)</span>
<a name="c0-5144"></a><span class="lineno">5144</span>      <span class="kt">int</span> <span class="n">oldd</span><span class="p">,</span> <span class="n">newd</span><span class="p">;</span>
<a name="c0-5145"></a><span class="lineno">5145</span> <span class="p">{</span>
<a name="c0-5146"></a><span class="lineno">5146</span>   <span class="n">sys_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"cannot duplicate fd %d to fd %d"</span><span class="p">),</span> <span class="n">oldd</span><span class="p">,</span> <span class="n">newd</span><span class="p">);</span>
<a name="c0-5147"></a><span class="lineno">5147</span> <span class="p">}</span>
<a name="c0-5148"></a><span class="lineno">5148</span> 
<a name="c0-5149"></a><span class="lineno">5149</span> <span class="cm">/* Redirect input and output to be from and to the specified pipes.</span>
<a name="c0-5150"></a><span class="lineno">5150</span> <span class="cm">   NO_PIPE and REDIRECT_BOTH are handled correctly. */</span>
<a name="c0-5151"></a><span class="lineno">5151</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c0-5152"></a><span class="lineno">5152</span> <span class="n">do_piping</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">)</span>
<a name="c0-5153"></a><span class="lineno">5153</span>      <span class="kt">int</span> <span class="n">pipe_in</span><span class="p">,</span> <span class="n">pipe_out</span><span class="p">;</span>
<a name="c0-5154"></a><span class="lineno">5154</span> <span class="p">{</span>
<a name="c0-5155"></a><span class="lineno">5155</span>   <span class="k">if</span> <span class="p">(</span><span class="n">pipe_in</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-5156"></a><span class="lineno">5156</span>     <span class="p">{</span>
<a name="c0-5157"></a><span class="lineno">5157</span>       <span class="k">if</span> <span class="p">(</span><span class="n">dup2</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5158"></a><span class="lineno">5158</span>  <span class="n">dup_error</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-5159"></a><span class="lineno">5159</span>       <span class="k">if</span> <span class="p">(</span><span class="n">pipe_in</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5160"></a><span class="lineno">5160</span>  <span class="n">close</span> <span class="p">(</span><span class="n">pipe_in</span><span class="p">);</span>
<a name="c0-5161"></a><span class="lineno">5161</span> <span class="cp">#ifdef __CYGWIN__</span>
<a name="c0-5162"></a><span class="lineno">5162</span>       <span class="cm">/* Let stdio know the fd may have changed from text to binary mode. */</span>
<a name="c0-5163"></a><span class="lineno">5163</span>       <span class="n">freopen</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"r"</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
<a name="c0-5164"></a><span class="lineno">5164</span> <span class="cp">#endif </span><span class="cm">/* __CYGWIN__ */</span><span class="cp"></span>
<a name="c0-5165"></a><span class="lineno">5165</span>     <span class="p">}</span>
<a name="c0-5166"></a><span class="lineno">5166</span>   <span class="k">if</span> <span class="p">(</span><span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">NO_PIPE</span><span class="p">)</span>
<a name="c0-5167"></a><span class="lineno">5167</span>     <span class="p">{</span>
<a name="c0-5168"></a><span class="lineno">5168</span>       <span class="k">if</span> <span class="p">(</span><span class="n">pipe_out</span> <span class="o">!=</span> <span class="n">REDIRECT_BOTH</span><span class="p">)</span>
<a name="c0-5169"></a><span class="lineno">5169</span>  <span class="p">{</span>
<a name="c0-5170"></a><span class="lineno">5170</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dup2</span> <span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5171"></a><span class="lineno">5171</span>      <span class="n">dup_error</span> <span class="p">(</span><span class="n">pipe_out</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-5172"></a><span class="lineno">5172</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe_out</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe_out</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-5173"></a><span class="lineno">5173</span>      <span class="n">close</span> <span class="p">(</span><span class="n">pipe_out</span><span class="p">);</span>
<a name="c0-5174"></a><span class="lineno">5174</span>  <span class="p">}</span>
<a name="c0-5175"></a><span class="lineno">5175</span>       <span class="k">else</span>
<a name="c0-5176"></a><span class="lineno">5176</span>  <span class="p">{</span>
<a name="c0-5177"></a><span class="lineno">5177</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dup2</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-5178"></a><span class="lineno">5178</span>      <span class="n">dup_error</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a name="c0-5179"></a><span class="lineno">5179</span>  <span class="p">}</span>
<a name="c0-5180"></a><span class="lineno">5180</span> <span class="cp">#ifdef __CYGWIN__</span>
<a name="c0-5181"></a><span class="lineno">5181</span>       <span class="cm">/* Let stdio know the fd may have changed from text to binary mode, and</span>
<a name="c0-5182"></a><span class="lineno">5182</span> <span class="cm">   make sure to preserve stdout line buffering. */</span>
<a name="c0-5183"></a><span class="lineno">5183</span>       <span class="n">freopen</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
<a name="c0-5184"></a><span class="lineno">5184</span>       <span class="n">sh_setlinebuf</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c0-5185"></a><span class="lineno">5185</span> <span class="cp">#endif </span><span class="cm">/* __CYGWIN__ */</span><span class="cp"></span>
<a name="c0-5186"></a><span class="lineno">5186</span>     <span class="p">}</span>
<a name="c0-5187"></a><span class="lineno">5187</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> shell.c 
                <small> (308,33)-(317,42)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 752px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">   1</span> <span class="cm">/* shell.c -- GNU's idea of the POSIX shell specification. */</span>
<a name="c1-2"></a><span class="lineno">   2</span> 
<a name="c1-3"></a><span class="lineno">   3</span> <span class="cm">/* Copyright (C) 1987-2010 Free Software Foundation, Inc.</span>
<a name="c1-4"></a><span class="lineno">   4</span> 
<a name="c1-5"></a><span class="lineno">   5</span> <span class="cm">   This file is part of GNU Bash, the Bourne Again SHell.</span>
<a name="c1-6"></a><span class="lineno">   6</span> 
<a name="c1-7"></a><span class="lineno">   7</span> <span class="cm">   Bash is free software: you can redistribute it and/or modify</span>
<a name="c1-8"></a><span class="lineno">   8</span> <span class="cm">   it under the terms of the GNU General Public License as published by</span>
<a name="c1-9"></a><span class="lineno">   9</span> <span class="cm">   the Free Software Foundation, either version 3 of the License, or</span>
<a name="c1-10"></a><span class="lineno">  10</span> <span class="cm">   (at your option) any later version.</span>
<a name="c1-11"></a><span class="lineno">  11</span> 
<a name="c1-12"></a><span class="lineno">  12</span> <span class="cm">   Bash is distributed in the hope that it will be useful,</span>
<a name="c1-13"></a><span class="lineno">  13</span> <span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="c1-14"></a><span class="lineno">  14</span> <span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="c1-15"></a><span class="lineno">  15</span> <span class="cm">   GNU General Public License for more details.</span>
<a name="c1-16"></a><span class="lineno">  16</span> 
<a name="c1-17"></a><span class="lineno">  17</span> <span class="cm">   You should have received a copy of the GNU General Public License</span>
<a name="c1-18"></a><span class="lineno">  18</span> <span class="cm">   along with Bash.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="c1-19"></a><span class="lineno">  19</span> <span class="cm">*/</span>
<a name="c1-20"></a><span class="lineno">  20</span> 
<a name="c1-21"></a><span class="lineno">  21</span> <span class="cm">/*</span>
<a name="c1-22"></a><span class="lineno">  22</span> <span class="cm">  Birthdate:</span>
<a name="c1-23"></a><span class="lineno">  23</span> <span class="cm">  Sunday, January 10th, 1988.</span>
<a name="c1-24"></a><span class="lineno">  24</span> <span class="cm">  Initial author: Brian Fox</span>
<a name="c1-25"></a><span class="lineno">  25</span> <span class="cm">*/</span>
<a name="c1-26"></a><span class="lineno">  26</span> <span class="cp">#define INSTALL_DEBUG_MODE</span>
<a name="c1-27"></a><span class="lineno">  27</span> 
<a name="c1-28"></a><span class="lineno">  28</span> <span class="cp">#include "config.h"</span>
<a name="c1-29"></a><span class="lineno">  29</span> 
<a name="c1-30"></a><span class="lineno">  30</span> <span class="cp">#include "bashtypes.h"</span>
<a name="c1-31"></a><span class="lineno">  31</span> <span class="cp">#if !defined (_MINIX) &amp;&amp; defined (HAVE_SYS_FILE_H)</span>
<a name="c1-32"></a><span class="lineno">  32</span> <span class="cp">#  include &lt;sys/file.h&gt;</span>
<a name="c1-33"></a><span class="lineno">  33</span> <span class="cp">#endif</span>
<a name="c1-34"></a><span class="lineno">  34</span> <span class="cp">#include "posixstat.h"</span>
<a name="c1-35"></a><span class="lineno">  35</span> <span class="cp">#include "posixtime.h"</span>
<a name="c1-36"></a><span class="lineno">  36</span> <span class="cp">#include "bashansi.h"</span>
<a name="c1-37"></a><span class="lineno">  37</span> <span class="cp">#include &lt;stdio.h&gt;</span>
<a name="c1-38"></a><span class="lineno">  38</span> <span class="cp">#include &lt;signal.h&gt;</span>
<a name="c1-39"></a><span class="lineno">  39</span> <span class="cp">#include &lt;errno.h&gt;</span>
<a name="c1-40"></a><span class="lineno">  40</span> <span class="cp">#include "filecntl.h"</span>
<a name="c1-41"></a><span class="lineno">  41</span> <span class="cp">#include &lt;pwd.h&gt;</span>
<a name="c1-42"></a><span class="lineno">  42</span> 
<a name="c1-43"></a><span class="lineno">  43</span> <span class="cp">#if defined (HAVE_UNISTD_H)</span>
<a name="c1-44"></a><span class="lineno">  44</span> <span class="cp">#  include &lt;unistd.h&gt;</span>
<a name="c1-45"></a><span class="lineno">  45</span> <span class="cp">#endif</span>
<a name="c1-46"></a><span class="lineno">  46</span> 
<a name="c1-47"></a><span class="lineno">  47</span> <span class="cp">#include "bashintl.h"</span>
<a name="c1-48"></a><span class="lineno">  48</span> 
<a name="c1-49"></a><span class="lineno">  49</span> <span class="cp">#define NEED_SH_SETLINEBUF_DECL   </span><span class="cm">/* used in externs.h */</span><span class="cp"></span>
<a name="c1-50"></a><span class="lineno">  50</span> 
<a name="c1-51"></a><span class="lineno">  51</span> <span class="cp">#include "shell.h"</span>
<a name="c1-52"></a><span class="lineno">  52</span> <span class="cp">#include "flags.h"</span>
<a name="c1-53"></a><span class="lineno">  53</span> <span class="cp">#include "trap.h"</span>
<a name="c1-54"></a><span class="lineno">  54</span> <span class="cp">#include "mailcheck.h"</span>
<a name="c1-55"></a><span class="lineno">  55</span> <span class="cp">#include "builtins.h"</span>
<a name="c1-56"></a><span class="lineno">  56</span> <span class="cp">#include "builtins/common.h"</span>
<a name="c1-57"></a><span class="lineno">  57</span> 
<a name="c1-58"></a><span class="lineno">  58</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-59"></a><span class="lineno">  59</span> <span class="cp">#include "jobs.h"</span>
<a name="c1-60"></a><span class="lineno">  60</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c1-61"></a><span class="lineno">  61</span> 
<a name="c1-62"></a><span class="lineno">  62</span> <span class="cp">#include "input.h"</span>
<a name="c1-63"></a><span class="lineno">  63</span> <span class="cp">#include "execute_cmd.h"</span>
<a name="c1-64"></a><span class="lineno">  64</span> <span class="cp">#include "findcmd.h"</span>
<a name="c1-65"></a><span class="lineno">  65</span> 
<a name="c1-66"></a><span class="lineno">  66</span> <span class="cp">#if defined (USING_BASH_MALLOC) &amp;&amp; defined (DEBUG) &amp;&amp; !defined (DISABLE_MALLOC_WRAPPERS)</span>
<a name="c1-67"></a><span class="lineno">  67</span> <span class="cp">#  include &lt;malloc/shmalloc.h&gt;</span>
<a name="c1-68"></a><span class="lineno">  68</span> <span class="cp">#endif</span>
<a name="c1-69"></a><span class="lineno">  69</span> 
<a name="c1-70"></a><span class="lineno">  70</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c1-71"></a><span class="lineno">  71</span> <span class="cp">#  include "bashhist.h"</span>
<a name="c1-72"></a><span class="lineno">  72</span> <span class="cp">#  include &lt;readline/history.h&gt;</span>
<a name="c1-73"></a><span class="lineno">  73</span> <span class="cp">#endif</span>
<a name="c1-74"></a><span class="lineno">  74</span> 
<a name="c1-75"></a><span class="lineno">  75</span> <span class="cp">#if defined (READLINE)</span>
<a name="c1-76"></a><span class="lineno">  76</span> <span class="cp">#  include "bashline.h"</span>
<a name="c1-77"></a><span class="lineno">  77</span> <span class="cp">#endif</span>
<a name="c1-78"></a><span class="lineno">  78</span> 
<a name="c1-79"></a><span class="lineno">  79</span> <span class="cp">#include &lt;tilde/tilde.h&gt;</span>
<a name="c1-80"></a><span class="lineno">  80</span> <span class="cp">#include &lt;glob/strmatch.h&gt;</span>
<a name="c1-81"></a><span class="lineno">  81</span> 
<a name="c1-82"></a><span class="lineno">  82</span> <span class="cp">#if defined (__OPENNT)</span>
<a name="c1-83"></a><span class="lineno">  83</span> <span class="cp">#  include &lt;opennt/opennt.h&gt;</span>
<a name="c1-84"></a><span class="lineno">  84</span> <span class="cp">#endif</span>
<a name="c1-85"></a><span class="lineno">  85</span> 
<a name="c1-86"></a><span class="lineno">  86</span> <span class="cp">#if !defined (HAVE_GETPW_DECLS)</span>
<a name="c1-87"></a><span class="lineno">  87</span> <span class="k">extern</span> <span class="k">struct</span> <span class="n">passwd</span> <span class="o">*</span><span class="n">getpwuid</span> <span class="p">();</span>
<a name="c1-88"></a><span class="lineno">  88</span> <span class="cp">#endif </span><span class="cm">/* !HAVE_GETPW_DECLS */</span><span class="cp"></span>
<a name="c1-89"></a><span class="lineno">  89</span> 
<a name="c1-90"></a><span class="lineno">  90</span> <span class="cp">#if !defined (errno)</span>
<a name="c1-91"></a><span class="lineno">  91</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-92"></a><span class="lineno">  92</span> <span class="cp">#endif</span>
<a name="c1-93"></a><span class="lineno">  93</span> 
<a name="c1-94"></a><span class="lineno">  94</span> <span class="cp">#if defined (NO_MAIN_ENV_ARG)</span>
<a name="c1-95"></a><span class="lineno">  95</span> <span class="k">extern</span> <span class="kt">char</span> <span class="o">**</span><span class="n">environ</span><span class="p">;</span> <span class="cm">/* used if no third argument to main() */</span>
<a name="c1-96"></a><span class="lineno">  96</span> <span class="cp">#endif</span>
<a name="c1-97"></a><span class="lineno">  97</span> 
<a name="c1-98"></a><span class="lineno">  98</span> <span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dist_version</span><span class="p">,</span> <span class="o">*</span><span class="n">release_status</span><span class="p">;</span>
<a name="c1-99"></a><span class="lineno">  99</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">patch_level</span><span class="p">,</span> <span class="n">build_version</span><span class="p">;</span>
<a name="c1-100"></a><span class="lineno"> 100</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">shell_level</span><span class="p">;</span>
<a name="c1-101"></a><span class="lineno"> 101</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">subshell_environment</span><span class="p">;</span>
<a name="c1-102"></a><span class="lineno"> 102</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">last_command_exit_value</span><span class="p">;</span>
<a name="c1-103"></a><span class="lineno"> 103</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">line_number</span><span class="p">;</span>
<a name="c1-104"></a><span class="lineno"> 104</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">expand_aliases</span><span class="p">;</span>
<a name="c1-105"></a><span class="lineno"> 105</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">array_needs_making</span><span class="p">;</span>
<a name="c1-106"></a><span class="lineno"> 106</span> <span class="k">extern</span> <span class="kt">int</span> <span class="n">gnu_error_format</span><span class="p">;</span>
<a name="c1-107"></a><span class="lineno"> 107</span> <span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">primary_prompt</span><span class="p">,</span> <span class="o">*</span><span class="n">secondary_prompt</span><span class="p">;</span>
<a name="c1-108"></a><span class="lineno"> 108</span> <span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">this_command_name</span><span class="p">;</span>
<a name="c1-109"></a><span class="lineno"> 109</span> 
<a name="c1-110"></a><span class="lineno"> 110</span> <span class="cm">/* Non-zero means that this shell has already been run; i.e. you should</span>
<a name="c1-111"></a><span class="lineno"> 111</span> <span class="cm">   call shell_reinitialize () if you need to start afresh. */</span>
<a name="c1-112"></a><span class="lineno"> 112</span> <span class="kt">int</span> <span class="n">shell_initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-113"></a><span class="lineno"> 113</span> 
<a name="c1-114"></a><span class="lineno"> 114</span> <span class="n">COMMAND</span> <span class="o">*</span><span class="n">global_command</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMMAND</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-115"></a><span class="lineno"> 115</span> 
<a name="c1-116"></a><span class="lineno"> 116</span> <span class="cm">/* Information about the current user. */</span>
<a name="c1-117"></a><span class="lineno"> 117</span> <span class="k">struct</span> <span class="n">user_info</span> <span class="n">current_user</span> <span class="o">=</span>
<a name="c1-118"></a><span class="lineno"> 118</span> <span class="p">{</span>
<a name="c1-119"></a><span class="lineno"> 119</span>   <span class="p">(</span><span class="n">uid_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">uid_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">gid_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">gid_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<a name="c1-120"></a><span class="lineno"> 120</span>   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span>
<a name="c1-121"></a><span class="lineno"> 121</span> <span class="p">};</span>
<a name="c1-122"></a><span class="lineno"> 122</span> 
<a name="c1-123"></a><span class="lineno"> 123</span> <span class="cm">/* The current host's name. */</span>
<a name="c1-124"></a><span class="lineno"> 124</span> <span class="kt">char</span> <span class="o">*</span><span class="n">current_host_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-125"></a><span class="lineno"> 125</span> 
<a name="c1-126"></a><span class="lineno"> 126</span> <span class="cm">/* Non-zero means that this shell is a login shell.</span>
<a name="c1-127"></a><span class="lineno"> 127</span> <span class="cm">   Specifically:</span>
<a name="c1-128"></a><span class="lineno"> 128</span> <span class="cm">   0 = not login shell.</span>
<a name="c1-129"></a><span class="lineno"> 129</span> <span class="cm">   1 = login shell from getty (or equivalent fake out)</span>
<a name="c1-130"></a><span class="lineno"> 130</span> <span class="cm">  -1 = login shell from "--login" (or -l) flag.</span>
<a name="c1-131"></a><span class="lineno"> 131</span> <span class="cm">  -2 = both from getty, and from flag.</span>
<a name="c1-132"></a><span class="lineno"> 132</span> <span class="cm"> */</span>
<a name="c1-133"></a><span class="lineno"> 133</span> <span class="kt">int</span> <span class="n">login_shell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-134"></a><span class="lineno"> 134</span> 
<a name="c1-135"></a><span class="lineno"> 135</span> <span class="cm">/* Non-zero means that at this moment, the shell is interactive.  In</span>
<a name="c1-136"></a><span class="lineno"> 136</span> <span class="cm">   general, this means that the shell is at this moment reading input</span>
<a name="c1-137"></a><span class="lineno"> 137</span> <span class="cm">   from the keyboard. */</span>
<a name="c1-138"></a><span class="lineno"> 138</span> <span class="kt">int</span> <span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-139"></a><span class="lineno"> 139</span> 
<a name="c1-140"></a><span class="lineno"> 140</span> <span class="cm">/* Non-zero means that the shell was started as an interactive shell. */</span>
<a name="c1-141"></a><span class="lineno"> 141</span> <span class="kt">int</span> <span class="n">interactive_shell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-142"></a><span class="lineno"> 142</span> 
<a name="c1-143"></a><span class="lineno"> 143</span> <span class="cm">/* Non-zero means to send a SIGHUP to all jobs when an interactive login</span>
<a name="c1-144"></a><span class="lineno"> 144</span> <span class="cm">   shell exits. */</span>
<a name="c1-145"></a><span class="lineno"> 145</span> <span class="kt">int</span> <span class="n">hup_on_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-146"></a><span class="lineno"> 146</span> 
<a name="c1-147"></a><span class="lineno"> 147</span> <span class="cm">/* Non-zero means to list status of running and stopped jobs at shell exit */</span>
<a name="c1-148"></a><span class="lineno"> 148</span> <span class="kt">int</span> <span class="n">check_jobs_at_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-149"></a><span class="lineno"> 149</span> 
<a name="c1-150"></a><span class="lineno"> 150</span> <span class="cm">/* Non-zero means to change to a directory name supplied as a command name */</span>
<a name="c1-151"></a><span class="lineno"> 151</span> <span class="kt">int</span> <span class="n">autocd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-152"></a><span class="lineno"> 152</span> 
<a name="c1-153"></a><span class="lineno"> 153</span> <span class="cm">/* Tells what state the shell was in when it started:</span>
<a name="c1-154"></a><span class="lineno"> 154</span> <span class="cm"> 0 = non-interactive shell script</span>
<a name="c1-155"></a><span class="lineno"> 155</span> <span class="cm"> 1 = interactive</span>
<a name="c1-156"></a><span class="lineno"> 156</span> <span class="cm"> 2 = -c command</span>
<a name="c1-157"></a><span class="lineno"> 157</span> <span class="cm"> 3 = wordexp evaluation</span>
<a name="c1-158"></a><span class="lineno"> 158</span> <span class="cm">   This is a superset of the information provided by interactive_shell.</span>
<a name="c1-159"></a><span class="lineno"> 159</span> <span class="cm">*/</span>
<a name="c1-160"></a><span class="lineno"> 160</span> <span class="kt">int</span> <span class="n">startup_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-161"></a><span class="lineno"> 161</span> 
<a name="c1-162"></a><span class="lineno"> 162</span> <span class="cm">/* Special debugging helper. */</span>
<a name="c1-163"></a><span class="lineno"> 163</span> <span class="kt">int</span> <span class="n">debugging_login_shell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-164"></a><span class="lineno"> 164</span> 
<a name="c1-165"></a><span class="lineno"> 165</span> <span class="cm">/* The environment that the shell passes to other commands. */</span>
<a name="c1-166"></a><span class="lineno"> 166</span> <span class="kt">char</span> <span class="o">**</span><span class="n">shell_environment</span><span class="p">;</span>
<a name="c1-167"></a><span class="lineno"> 167</span> 
<a name="c1-168"></a><span class="lineno"> 168</span> <span class="cm">/* Non-zero when we are executing a top-level command. */</span>
<a name="c1-169"></a><span class="lineno"> 169</span> <span class="kt">int</span> <span class="n">executing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-170"></a><span class="lineno"> 170</span> 
<a name="c1-171"></a><span class="lineno"> 171</span> <span class="cm">/* The number of commands executed so far. */</span>
<a name="c1-172"></a><span class="lineno"> 172</span> <span class="kt">int</span> <span class="n">current_command_number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-173"></a><span class="lineno"> 173</span> 
<a name="c1-174"></a><span class="lineno"> 174</span> <span class="cm">/* Non-zero is the recursion depth for commands. */</span>
<a name="c1-175"></a><span class="lineno"> 175</span> <span class="kt">int</span> <span class="n">indirection_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-176"></a><span class="lineno"> 176</span> 
<a name="c1-177"></a><span class="lineno"> 177</span> <span class="cm">/* The name of this shell, as taken from argv[0]. */</span>
<a name="c1-178"></a><span class="lineno"> 178</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shell_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-179"></a><span class="lineno"> 179</span> 
<a name="c1-180"></a><span class="lineno"> 180</span> <span class="cm">/* time in seconds when the shell was started */</span>
<a name="c1-181"></a><span class="lineno"> 181</span> <span class="kt">time_t</span> <span class="n">shell_start_time</span><span class="p">;</span>
<a name="c1-182"></a><span class="lineno"> 182</span> 
<a name="c1-183"></a><span class="lineno"> 183</span> <span class="cm">/* Are we running in an emacs shell window? */</span>
<a name="c1-184"></a><span class="lineno"> 184</span> <span class="kt">int</span> <span class="n">running_under_emacs</span><span class="p">;</span>
<a name="c1-185"></a><span class="lineno"> 185</span> 
<a name="c1-186"></a><span class="lineno"> 186</span> <span class="cm">/* Do we have /dev/fd? */</span>
<a name="c1-187"></a><span class="lineno"> 187</span> <span class="cp">#ifdef HAVE_DEV_FD</span>
<a name="c1-188"></a><span class="lineno"> 188</span> <span class="kt">int</span> <span class="n">have_devfd</span> <span class="o">=</span> <span class="n">HAVE_DEV_FD</span><span class="p">;</span>
<a name="c1-189"></a><span class="lineno"> 189</span> <span class="cp">#else</span>
<a name="c1-190"></a><span class="lineno"> 190</span> <span class="kt">int</span> <span class="n">have_devfd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-191"></a><span class="lineno"> 191</span> <span class="cp">#endif</span>
<a name="c1-192"></a><span class="lineno"> 192</span> 
<a name="c1-193"></a><span class="lineno"> 193</span> <span class="cm">/* The name of the .(shell)rc file. */</span>
<a name="c1-194"></a><span class="lineno"> 194</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bashrc_file</span> <span class="o">=</span> <span class="s">"~/.bashrc"</span><span class="p">;</span>
<a name="c1-195"></a><span class="lineno"> 195</span> 
<a name="c1-196"></a><span class="lineno"> 196</span> <span class="cm">/* Non-zero means to act more like the Bourne shell on startup. */</span>
<a name="c1-197"></a><span class="lineno"> 197</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">act_like_sh</span><span class="p">;</span>
<a name="c1-198"></a><span class="lineno"> 198</span> 
<a name="c1-199"></a><span class="lineno"> 199</span> <span class="cm">/* Non-zero if this shell is being run by `su'. */</span>
<a name="c1-200"></a><span class="lineno"> 200</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">su_shell</span><span class="p">;</span>
<a name="c1-201"></a><span class="lineno"> 201</span> 
<a name="c1-202"></a><span class="lineno"> 202</span> <span class="cm">/* Non-zero if we have already expanded and sourced $ENV. */</span>
<a name="c1-203"></a><span class="lineno"> 203</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">sourced_env</span><span class="p">;</span>
<a name="c1-204"></a><span class="lineno"> 204</span> 
<a name="c1-205"></a><span class="lineno"> 205</span> <span class="cm">/* Is this shell running setuid? */</span>
<a name="c1-206"></a><span class="lineno"> 206</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">running_setuid</span><span class="p">;</span>
<a name="c1-207"></a><span class="lineno"> 207</span> 
<a name="c1-208"></a><span class="lineno"> 208</span> <span class="cm">/* Values for the long-winded argument names. */</span>
<a name="c1-209"></a><span class="lineno"> 209</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">debugging</span><span class="p">;</span>      <span class="cm">/* Do debugging things. */</span>
<a name="c1-210"></a><span class="lineno"> 210</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">no_rc</span><span class="p">;</span>      <span class="cm">/* Don't execute ~/.bashrc */</span>
<a name="c1-211"></a><span class="lineno"> 211</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">no_profile</span><span class="p">;</span>     <span class="cm">/* Don't execute .profile */</span>
<a name="c1-212"></a><span class="lineno"> 212</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">do_version</span><span class="p">;</span>     <span class="cm">/* Display interesting version info. */</span>
<a name="c1-213"></a><span class="lineno"> 213</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">make_login_shell</span><span class="p">;</span>   <span class="cm">/* Make this shell be a `-bash' shell. */</span>
<a name="c1-214"></a><span class="lineno"> 214</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">want_initial_help</span><span class="p">;</span>    <span class="cm">/* --help option */</span>
<a name="c1-215"></a><span class="lineno"> 215</span> 
<a name="c1-216"></a><span class="lineno"> 216</span> <span class="kt">int</span> <span class="n">debugging_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* In debugging mode with --debugger */</span>
<a name="c1-217"></a><span class="lineno"> 217</span> <span class="kt">int</span> <span class="n">no_line_editing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Don't do fancy line editing. */</span>
<a name="c1-218"></a><span class="lineno"> 218</span> <span class="kt">int</span> <span class="n">dump_translatable_strings</span><span class="p">;</span>  <span class="cm">/* Dump strings in $"...", don't execute. */</span>
<a name="c1-219"></a><span class="lineno"> 219</span> <span class="kt">int</span> <span class="n">dump_po_strings</span><span class="p">;</span>    <span class="cm">/* Dump strings in $"..." in po format */</span>
<a name="c1-220"></a><span class="lineno"> 220</span> <span class="kt">int</span> <span class="n">wordexp_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* Do word expansion only */</span>
<a name="c1-221"></a><span class="lineno"> 221</span> <span class="kt">int</span> <span class="n">protected_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* No command substitution with --wordexp */</span>
<a name="c1-222"></a><span class="lineno"> 222</span> 
<a name="c1-223"></a><span class="lineno"> 223</span> <span class="cp">#if defined (STRICT_POSIX)</span>
<a name="c1-224"></a><span class="lineno"> 224</span> <span class="kt">int</span> <span class="n">posixly_correct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Non-zero means posix.2 superset. */</span>
<a name="c1-225"></a><span class="lineno"> 225</span> <span class="cp">#else</span>
<a name="c1-226"></a><span class="lineno"> 226</span> <span class="kt">int</span> <span class="n">posixly_correct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Non-zero means posix.2 superset. */</span>
<a name="c1-227"></a><span class="lineno"> 227</span> <span class="cp">#endif</span>
<a name="c1-228"></a><span class="lineno"> 228</span> 
<a name="c1-229"></a><span class="lineno"> 229</span> <span class="cm">/* Some long-winded argument names.  These are obviously new. */</span>
<a name="c1-230"></a><span class="lineno"> 230</span> <span class="cp">#define Int 1</span>
<a name="c1-231"></a><span class="lineno"> 231</span> <span class="cp">#define Charp 2</span>
<a name="c1-232"></a><span class="lineno"> 232</span> <span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
<a name="c1-233"></a><span class="lineno"> 233</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-234"></a><span class="lineno"> 234</span>   <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
<a name="c1-235"></a><span class="lineno"> 235</span>   <span class="kt">int</span> <span class="o">*</span><span class="n">int_value</span><span class="p">;</span>
<a name="c1-236"></a><span class="lineno"> 236</span>   <span class="kt">char</span> <span class="o">**</span><span class="n">char_value</span><span class="p">;</span>
<a name="c1-237"></a><span class="lineno"> 237</span> <span class="p">}</span> <span class="n">long_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-238"></a><span class="lineno"> 238</span>   <span class="p">{</span> <span class="s">"debug"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debugging</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-239"></a><span class="lineno"> 239</span> <span class="cp">#if defined (DEBUGGER)</span>
<a name="c1-240"></a><span class="lineno"> 240</span>   <span class="p">{</span> <span class="s">"debugger"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debugging_mode</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-241"></a><span class="lineno"> 241</span> <span class="cp">#endif</span>
<a name="c1-242"></a><span class="lineno"> 242</span>   <span class="p">{</span> <span class="s">"dump-po-strings"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dump_po_strings</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-243"></a><span class="lineno"> 243</span>   <span class="p">{</span> <span class="s">"dump-strings"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dump_translatable_strings</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-244"></a><span class="lineno"> 244</span>   <span class="p">{</span> <span class="s">"help"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">want_initial_help</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-245"></a><span class="lineno"> 245</span>   <span class="p">{</span> <span class="s">"init-file"</span><span class="p">,</span> <span class="n">Charp</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bashrc_file</span> <span class="p">},</span>
<a name="c1-246"></a><span class="lineno"> 246</span>   <span class="p">{</span> <span class="s">"login"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">make_login_shell</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-247"></a><span class="lineno"> 247</span>   <span class="p">{</span> <span class="s">"noediting"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_line_editing</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-248"></a><span class="lineno"> 248</span>   <span class="p">{</span> <span class="s">"noprofile"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_profile</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-249"></a><span class="lineno"> 249</span>   <span class="p">{</span> <span class="s">"norc"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_rc</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-250"></a><span class="lineno"> 250</span>   <span class="p">{</span> <span class="s">"posix"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">posixly_correct</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-251"></a><span class="lineno"> 251</span>   <span class="p">{</span> <span class="s">"protected"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">protected_mode</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-252"></a><span class="lineno"> 252</span>   <span class="p">{</span> <span class="s">"rcfile"</span><span class="p">,</span> <span class="n">Charp</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bashrc_file</span> <span class="p">},</span>
<a name="c1-253"></a><span class="lineno"> 253</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-254"></a><span class="lineno"> 254</span>   <span class="p">{</span> <span class="s">"restricted"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">restricted</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-255"></a><span class="lineno"> 255</span> <span class="cp">#endif</span>
<a name="c1-256"></a><span class="lineno"> 256</span>   <span class="p">{</span> <span class="s">"verbose"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">echo_input_at_read</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-257"></a><span class="lineno"> 257</span>   <span class="p">{</span> <span class="s">"version"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">do_version</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-258"></a><span class="lineno"> 258</span> <span class="cp">#if defined (WORDEXP_OPTION)</span>
<a name="c1-259"></a><span class="lineno"> 259</span>   <span class="p">{</span> <span class="s">"wordexp"</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wordexp_only</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">},</span>
<a name="c1-260"></a><span class="lineno"> 260</span> <span class="cp">#endif</span>
<a name="c1-261"></a><span class="lineno"> 261</span>   <span class="p">{</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="mh">0x0</span> <span class="p">}</span>
<a name="c1-262"></a><span class="lineno"> 262</span> <span class="p">};</span>
<a name="c1-263"></a><span class="lineno"> 263</span> 
<a name="c1-264"></a><span class="lineno"> 264</span> <span class="cm">/* These are extern so execute_simple_command can set them, and then</span>
<a name="c1-265"></a><span class="lineno"> 265</span> <span class="cm">   longjmp back to main to execute a shell script, instead of calling</span>
<a name="c1-266"></a><span class="lineno"> 266</span> <span class="cm">   main () again and resulting in indefinite, possibly fatal, stack</span>
<a name="c1-267"></a><span class="lineno"> 267</span> <span class="cm">   growth. */</span>
<a name="c1-268"></a><span class="lineno"> 268</span> <span class="n">procenv_t</span> <span class="n">subshell_top_level</span><span class="p">;</span>
<a name="c1-269"></a><span class="lineno"> 269</span> <span class="kt">int</span> <span class="n">subshell_argc</span><span class="p">;</span>
<a name="c1-270"></a><span class="lineno"> 270</span> <span class="kt">char</span> <span class="o">**</span><span class="n">subshell_argv</span><span class="p">;</span>
<a name="c1-271"></a><span class="lineno"> 271</span> <span class="kt">char</span> <span class="o">**</span><span class="n">subshell_envp</span><span class="p">;</span>
<a name="c1-272"></a><span class="lineno"> 272</span> 
<a name="c1-273"></a><span class="lineno"> 273</span> <span class="kt">char</span> <span class="o">*</span><span class="n">exec_argv0</span><span class="p">;</span>
<a name="c1-274"></a><span class="lineno"> 274</span> 
<a name="c1-275"></a><span class="lineno"> 275</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-276"></a><span class="lineno"> 276</span> <span class="cm">/* The file descriptor from which the shell is reading input. */</span>
<a name="c1-277"></a><span class="lineno"> 277</span> <span class="kt">int</span> <span class="n">default_buffered_input</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-278"></a><span class="lineno"> 278</span> <span class="cp">#endif</span>
<a name="c1-279"></a><span class="lineno"> 279</span> 
<a name="c1-280"></a><span class="lineno"> 280</span> <span class="cm">/* The following two variables are not static so they can show up in $-. */</span>
<a name="c1-281"></a><span class="lineno"> 281</span> <span class="kt">int</span> <span class="n">read_from_stdin</span><span class="p">;</span>    <span class="cm">/* -s flag supplied */</span>
<a name="c1-282"></a><span class="lineno"> 282</span> <span class="kt">int</span> <span class="n">want_pending_command</span><span class="p">;</span> <span class="cm">/* -c flag supplied */</span>
<a name="c1-283"></a><span class="lineno"> 283</span> 
<a name="c1-284"></a><span class="lineno"> 284</span> <span class="cm">/* This variable is not static so it can be bound to $BASH_EXECUTION_STRING */</span>
<a name="c1-285"></a><span class="lineno"> 285</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command_execution_string</span><span class="p">;</span>  <span class="cm">/* argument to -c option */</span>
<a name="c1-286"></a><span class="lineno"> 286</span> 
<a name="c1-287"></a><span class="lineno"> 287</span> <span class="kt">int</span> <span class="n">malloc_trace_at_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-288"></a><span class="lineno"> 288</span> 
<a name="c1-289"></a><span class="lineno"> 289</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">shell_reinitialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-290"></a><span class="lineno"> 290</span> 
<a name="c1-291"></a><span class="lineno"> 291</span> <span class="k">static</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">default_input</span><span class="p">;</span>
<a name="c1-292"></a><span class="lineno"> 292</span> 
<a name="c1-293"></a><span class="lineno"> 293</span> <span class="k">static</span> <span class="n">STRING_INT_ALIST</span> <span class="o">*</span><span class="n">shopt_alist</span><span class="p">;</span>
<a name="c1-294"></a><span class="lineno"> 294</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">shopt_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shopt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-295"></a><span class="lineno"> 295</span> 
<a name="c1-296"></a><span class="lineno"> 296</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">parse_long_options</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c1-297"></a><span class="lineno"> 297</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">parse_shell_options</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c1-298"></a><span class="lineno"> 298</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">bind_args</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c1-299"></a><span class="lineno"> 299</span> 
<a name="c1-300"></a><span class="lineno"> 300</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">start_debugger</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c1-301"></a><span class="lineno"> 301</span> 
<a name="c1-302"></a><span class="lineno"> 302</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">add_shopt_to_alist</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c1-303"></a><span class="lineno"> 303</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">run_shopt_alist</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c1-304"></a><span class="lineno"> 304</span> 
<a name="c1-305"></a><span class="lineno"> 305</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">execute_env_file</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c1-306"></a><span class="lineno"> 306</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">run_startup_files</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c1-307"></a><span class="lineno"> 307</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">open_shell_script</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c1-308"></a><span class="lineno"> 308</span> <span class="hll"><span class="k">static</span> <span class="kt">void</span> <span class="n">set_bash_input</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
</span><a name="c1-309"></a><span class="lineno"> 309</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">run_one_command</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
</span><a name="c1-310"></a><span class="lineno"> 310</span> <span class="hll"><span class="cp">#if defined (WORDEXP_OPTION)</span>
</span><a name="c1-311"></a><span class="lineno"> 311</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">run_wordexp</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
</span><a name="c1-312"></a><span class="lineno"> 312</span> <span class="hll"><span class="cp">#endif</span>
</span><a name="c1-313"></a><span class="lineno"> 313</span> <span class="hll">
</span><a name="c1-314"></a><span class="lineno"> 314</span> <span class="hll"><span class="k">static</span> <span class="kt">int</span> <span class="n">uidget</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
</span><a name="c1-315"></a><span class="lineno"> 315</span> <span class="hll">
</span><a name="c1-316"></a><span class="lineno"> 316</span> <span class="hll"><span class="k">static</span> <span class="kt">void</span> <span class="n">init_interactive</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
</span><a name="c1-317"></a><span class="lineno"> 317</span> <span class="hll"><span class="k">static</span> <span class="kt">void</span> <span class="n">init_noninteractive</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
</span><a name="c1-318"></a><span class="lineno"> 318</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">init_interactive_script</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c1-319"></a><span class="lineno"> 319</span> 
<a name="c1-320"></a><span class="lineno"> 320</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">set_shell_name</span> <span class="n">__P</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c1-321"></a><span class="lineno"> 321</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">shell_initialize</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c1-322"></a><span class="lineno"> 322</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">shell_reinitialize</span> <span class="n">__P</span><span class="p">((</span><span class="kt">void</span><span class="p">));</span>
<a name="c1-323"></a><span class="lineno"> 323</span> 
<a name="c1-324"></a><span class="lineno"> 324</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">show_shell_usage</span> <span class="n">__P</span><span class="p">((</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">));</span>
<a name="c1-325"></a><span class="lineno"> 325</span> 
<a name="c1-326"></a><span class="lineno"> 326</span> <span class="cp">#ifdef __CYGWIN__</span>
<a name="c1-327"></a><span class="lineno"> 327</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-328"></a><span class="lineno"> 328</span> <span class="nf">_cygwin32_check_tmp</span> <span class="p">()</span>
<a name="c1-329"></a><span class="lineno"> 329</span> <span class="p">{</span>
<a name="c1-330"></a><span class="lineno"> 330</span>   <span class="k">struct</span> <span class="n">stat</span> <span class="n">sb</span><span class="p">;</span>
<a name="c1-331"></a><span class="lineno"> 331</span> 
<a name="c1-332"></a><span class="lineno"> 332</span>   <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="p">(</span><span class="s">"/tmp"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-333"></a><span class="lineno"> 333</span>     <span class="n">internal_warning</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"could not find /tmp, please create!"</span><span class="p">));</span>
<a name="c1-334"></a><span class="lineno"> 334</span>   <span class="k">else</span>
<a name="c1-335"></a><span class="lineno"> 335</span>     <span class="p">{</span>
<a name="c1-336"></a><span class="lineno"> 336</span>       <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span> <span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-337"></a><span class="lineno"> 337</span>   <span class="n">internal_warning</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"/tmp must be a valid directory name"</span><span class="p">));</span>
<a name="c1-338"></a><span class="lineno"> 338</span>     <span class="p">}</span>
<a name="c1-339"></a><span class="lineno"> 339</span> <span class="p">}</span>
<a name="c1-340"></a><span class="lineno"> 340</span> <span class="cp">#endif </span><span class="cm">/* __CYGWIN__ */</span><span class="cp"></span>
<a name="c1-341"></a><span class="lineno"> 341</span> 
<a name="c1-342"></a><span class="lineno"> 342</span> <span class="cp">#if defined (NO_MAIN_ENV_ARG)</span>
<a name="c1-343"></a><span class="lineno"> 343</span> <span class="cm">/* systems without third argument to main() */</span>
<a name="c1-344"></a><span class="lineno"> 344</span> <span class="kt">int</span>
<a name="c1-345"></a><span class="lineno"> 345</span> <span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span>
<a name="c1-346"></a><span class="lineno"> 346</span>      <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
<a name="c1-347"></a><span class="lineno"> 347</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
<a name="c1-348"></a><span class="lineno"> 348</span> <span class="cp">#else </span><span class="cm">/* !NO_MAIN_ENV_ARG */</span><span class="cp"></span>
<a name="c1-349"></a><span class="lineno"> 349</span> <span class="kt">int</span>
<a name="c1-350"></a><span class="lineno"> 350</span> <span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
<a name="c1-351"></a><span class="lineno"> 351</span>      <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
<a name="c1-352"></a><span class="lineno"> 352</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="o">**</span><span class="n">env</span><span class="p">;</span>
<a name="c1-353"></a><span class="lineno"> 353</span> <span class="cp">#endif </span><span class="cm">/* !NO_MAIN_ENV_ARG */</span><span class="cp"></span>
<a name="c1-354"></a><span class="lineno"> 354</span> <span class="p">{</span>
<a name="c1-355"></a><span class="lineno"> 355</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-356"></a><span class="lineno"> 356</span>   <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">old_errexit_flag</span><span class="p">;</span>
<a name="c1-357"></a><span class="lineno"> 357</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-358"></a><span class="lineno"> 358</span>   <span class="kt">int</span> <span class="n">saverst</span><span class="p">;</span>
<a name="c1-359"></a><span class="lineno"> 359</span> <span class="cp">#endif</span>
<a name="c1-360"></a><span class="lineno"> 360</span>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">locally_skip_execution</span><span class="p">;</span>
<a name="c1-361"></a><span class="lineno"> 361</span>   <span class="k">volatile</span> <span class="kt">int</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">top_level_arg_index</span><span class="p">;</span>
<a name="c1-362"></a><span class="lineno"> 362</span> <span class="cp">#ifdef __OPENNT</span>
<a name="c1-363"></a><span class="lineno"> 363</span>   <span class="kt">char</span> <span class="o">**</span><span class="n">env</span><span class="p">;</span>
<a name="c1-364"></a><span class="lineno"> 364</span> 
<a name="c1-365"></a><span class="lineno"> 365</span>   <span class="n">env</span> <span class="o">=</span> <span class="n">environ</span><span class="p">;</span>
<a name="c1-366"></a><span class="lineno"> 366</span> <span class="cp">#endif </span><span class="cm">/* __OPENNT */</span><span class="cp"></span>
<a name="c1-367"></a><span class="lineno"> 367</span> 
<a name="c1-368"></a><span class="lineno"> 368</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">argc</span><span class="p">);</span>
<a name="c1-369"></a><span class="lineno"> 369</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
<a name="c1-370"></a><span class="lineno"> 370</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
<a name="c1-371"></a><span class="lineno"> 371</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
<a name="c1-372"></a><span class="lineno"> 372</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">old_errexit_flag</span><span class="p">);</span>
<a name="c1-373"></a><span class="lineno"> 373</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-374"></a><span class="lineno"> 374</span>   <span class="n">USE_VAR</span><span class="p">(</span><span class="n">saverst</span><span class="p">);</span>
<a name="c1-375"></a><span class="lineno"> 375</span> <span class="cp">#endif</span>
<a name="c1-376"></a><span class="lineno"> 376</span> 
<a name="c1-377"></a><span class="lineno"> 377</span>   <span class="cm">/* Catch early SIGINTs. */</span>
<a name="c1-378"></a><span class="lineno"> 378</span>   <span class="n">code</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">);</span>
<a name="c1-379"></a><span class="lineno"> 379</span>   <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a name="c1-380"></a><span class="lineno"> 380</span>     <span class="n">exit</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a name="c1-381"></a><span class="lineno"> 381</span> 
<a name="c1-382"></a><span class="lineno"> 382</span>   <span class="n">xtrace_init</span> <span class="p">();</span>
<a name="c1-383"></a><span class="lineno"> 383</span> 
<a name="c1-384"></a><span class="lineno"> 384</span> <span class="cp">#if defined (USING_BASH_MALLOC) &amp;&amp; defined (DEBUG) &amp;&amp; !defined (DISABLE_MALLOC_WRAPPERS)</span>
<a name="c1-385"></a><span class="lineno"> 385</span> <span class="cp">#  if 1</span>
<a name="c1-386"></a><span class="lineno"> 386</span>   <span class="n">malloc_set_register</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c1-387"></a><span class="lineno"> 387</span> <span class="cp">#  endif</span>
<a name="c1-388"></a><span class="lineno"> 388</span> <span class="cp">#endif</span>
<a name="c1-389"></a><span class="lineno"> 389</span> 
<a name="c1-390"></a><span class="lineno"> 390</span>   <span class="n">check_dev_tty</span> <span class="p">();</span>
<a name="c1-391"></a><span class="lineno"> 391</span> 
<a name="c1-392"></a><span class="lineno"> 392</span> <span class="cp">#ifdef __CYGWIN__</span>
<a name="c1-393"></a><span class="lineno"> 393</span>   <span class="n">_cygwin32_check_tmp</span> <span class="p">();</span>
<a name="c1-394"></a><span class="lineno"> 394</span> <span class="cp">#endif </span><span class="cm">/* __CYGWIN__ */</span><span class="cp"></span>
<a name="c1-395"></a><span class="lineno"> 395</span> 
<a name="c1-396"></a><span class="lineno"> 396</span>   <span class="cm">/* Wait forever if we are debugging a login shell. */</span>
<a name="c1-397"></a><span class="lineno"> 397</span>   <span class="k">while</span> <span class="p">(</span><span class="n">debugging_login_shell</span><span class="p">)</span> <span class="n">sleep</span> <span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a name="c1-398"></a><span class="lineno"> 398</span> 
<a name="c1-399"></a><span class="lineno"> 399</span>   <span class="n">set_default_locale</span> <span class="p">();</span>
<a name="c1-400"></a><span class="lineno"> 400</span> 
<a name="c1-401"></a><span class="lineno"> 401</span>   <span class="n">running_setuid</span> <span class="o">=</span> <span class="n">uidget</span> <span class="p">();</span>
<a name="c1-402"></a><span class="lineno"> 402</span> 
<a name="c1-403"></a><span class="lineno"> 403</span>   <span class="k">if</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">"POSIXLY_CORRECT"</span><span class="p">)</span> <span class="o">||</span> <span class="n">getenv</span> <span class="p">(</span><span class="s">"POSIX_PEDANTIC"</span><span class="p">))</span>
<a name="c1-404"></a><span class="lineno"> 404</span>     <span class="n">posixly_correct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-405"></a><span class="lineno"> 405</span> 
<a name="c1-406"></a><span class="lineno"> 406</span> <span class="cp">#if defined (USE_GNU_MALLOC_LIBRARY)</span>
<a name="c1-407"></a><span class="lineno"> 407</span>   <span class="n">mcheck</span> <span class="p">(</span><span class="n">programming_error</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">())</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-408"></a><span class="lineno"> 408</span> <span class="cp">#endif </span><span class="cm">/* USE_GNU_MALLOC_LIBRARY */</span><span class="cp"></span>
<a name="c1-409"></a><span class="lineno"> 409</span> 
<a name="c1-410"></a><span class="lineno"> 410</span>   <span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span> <span class="p">(</span><span class="n">subshell_top_level</span><span class="p">))</span>
<a name="c1-411"></a><span class="lineno"> 411</span>     <span class="p">{</span>
<a name="c1-412"></a><span class="lineno"> 412</span>       <span class="n">argc</span> <span class="o">=</span> <span class="n">subshell_argc</span><span class="p">;</span>
<a name="c1-413"></a><span class="lineno"> 413</span>       <span class="n">argv</span> <span class="o">=</span> <span class="n">subshell_argv</span><span class="p">;</span>
<a name="c1-414"></a><span class="lineno"> 414</span>       <span class="n">env</span> <span class="o">=</span> <span class="n">subshell_envp</span><span class="p">;</span>
<a name="c1-415"></a><span class="lineno"> 415</span>       <span class="n">sourced_env</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-416"></a><span class="lineno"> 416</span>     <span class="p">}</span>
<a name="c1-417"></a><span class="lineno"> 417</span> 
<a name="c1-418"></a><span class="lineno"> 418</span>   <span class="n">shell_reinitialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-419"></a><span class="lineno"> 419</span> 
<a name="c1-420"></a><span class="lineno"> 420</span>   <span class="cm">/* Initialize `local' variables for all `invocations' of main (). */</span>
<a name="c1-421"></a><span class="lineno"> 421</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-422"></a><span class="lineno"> 422</span>   <span class="k">if</span> <span class="p">(</span><span class="n">arg_index</span> <span class="o">&gt;</span> <span class="n">argc</span><span class="p">)</span>
<a name="c1-423"></a><span class="lineno"> 423</span>     <span class="n">arg_index</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
<a name="c1-424"></a><span class="lineno"> 424</span>   <span class="n">command_execution_string</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-425"></a><span class="lineno"> 425</span>   <span class="n">want_pending_command</span> <span class="o">=</span> <span class="n">locally_skip_execution</span> <span class="o">=</span> <span class="n">read_from_stdin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-426"></a><span class="lineno"> 426</span>   <span class="n">default_input</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">;</span>
<a name="c1-427"></a><span class="lineno"> 427</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-428"></a><span class="lineno"> 428</span>   <span class="n">default_buffered_input</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-429"></a><span class="lineno"> 429</span> <span class="cp">#endif</span>
<a name="c1-430"></a><span class="lineno"> 430</span> 
<a name="c1-431"></a><span class="lineno"> 431</span>   <span class="cm">/* Fix for the `infinite process creation' bug when running shell scripts</span>
<a name="c1-432"></a><span class="lineno"> 432</span> <span class="cm">     from startup files on System V. */</span>
<a name="c1-433"></a><span class="lineno"> 433</span>   <span class="n">login_shell</span> <span class="o">=</span> <span class="n">make_login_shell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-434"></a><span class="lineno"> 434</span> 
<a name="c1-435"></a><span class="lineno"> 435</span>   <span class="cm">/* If this shell has already been run, then reinitialize it to a</span>
<a name="c1-436"></a><span class="lineno"> 436</span> <span class="cm">     vanilla state. */</span>
<a name="c1-437"></a><span class="lineno"> 437</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shell_initialized</span> <span class="o">||</span> <span class="n">shell_name</span><span class="p">)</span>
<a name="c1-438"></a><span class="lineno"> 438</span>     <span class="p">{</span>
<a name="c1-439"></a><span class="lineno"> 439</span>       <span class="cm">/* Make sure that we do not infinitely recurse as a login shell. */</span>
<a name="c1-440"></a><span class="lineno"> 440</span>       <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">shell_name</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c1-441"></a><span class="lineno"> 441</span>   <span class="n">shell_name</span><span class="o">++</span><span class="p">;</span>
<a name="c1-442"></a><span class="lineno"> 442</span> 
<a name="c1-443"></a><span class="lineno"> 443</span>       <span class="n">shell_reinitialize</span> <span class="p">();</span>
<a name="c1-444"></a><span class="lineno"> 444</span>       <span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">))</span>
<a name="c1-445"></a><span class="lineno"> 445</span>   <span class="n">exit</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a name="c1-446"></a><span class="lineno"> 446</span>     <span class="p">}</span>
<a name="c1-447"></a><span class="lineno"> 447</span> 
<a name="c1-448"></a><span class="lineno"> 448</span>   <span class="n">shell_environment</span> <span class="o">=</span> <span class="n">env</span><span class="p">;</span>
<a name="c1-449"></a><span class="lineno"> 449</span>   <span class="n">set_shell_name</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-450"></a><span class="lineno"> 450</span>   <span class="n">shell_start_time</span> <span class="o">=</span> <span class="n">NOW</span><span class="p">;</span> <span class="cm">/* NOW now defined in general.h */</span>
<a name="c1-451"></a><span class="lineno"> 451</span> 
<a name="c1-452"></a><span class="lineno"> 452</span>   <span class="cm">/* Parse argument flags from the input line. */</span>
<a name="c1-453"></a><span class="lineno"> 453</span> 
<a name="c1-454"></a><span class="lineno"> 454</span>   <span class="cm">/* Find full word arguments first. */</span>
<a name="c1-455"></a><span class="lineno"> 455</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="n">parse_long_options</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>
<a name="c1-456"></a><span class="lineno"> 456</span> 
<a name="c1-457"></a><span class="lineno"> 457</span>   <span class="k">if</span> <span class="p">(</span><span class="n">want_initial_help</span><span class="p">)</span>
<a name="c1-458"></a><span class="lineno"> 458</span>     <span class="p">{</span>
<a name="c1-459"></a><span class="lineno"> 459</span>       <span class="n">show_shell_usage</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-460"></a><span class="lineno"> 460</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c1-461"></a><span class="lineno"> 461</span>     <span class="p">}</span>
<a name="c1-462"></a><span class="lineno"> 462</span> 
<a name="c1-463"></a><span class="lineno"> 463</span>   <span class="k">if</span> <span class="p">(</span><span class="n">do_version</span><span class="p">)</span>
<a name="c1-464"></a><span class="lineno"> 464</span>     <span class="p">{</span>
<a name="c1-465"></a><span class="lineno"> 465</span>       <span class="n">show_shell_version</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c1-466"></a><span class="lineno"> 466</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">EXECUTION_SUCCESS</span><span class="p">);</span>
<a name="c1-467"></a><span class="lineno"> 467</span>     <span class="p">}</span>
<a name="c1-468"></a><span class="lineno"> 468</span> 
<a name="c1-469"></a><span class="lineno"> 469</span>   <span class="cm">/* All done with full word options; do standard shell option parsing.*/</span>
<a name="c1-470"></a><span class="lineno"> 470</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="n">shell_name</span><span class="p">;</span> <span class="cm">/* for error reporting */</span>
<a name="c1-471"></a><span class="lineno"> 471</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="n">parse_shell_options</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>
<a name="c1-472"></a><span class="lineno"> 472</span> 
<a name="c1-473"></a><span class="lineno"> 473</span>   <span class="cm">/* If user supplied the "--login" (or -l) flag, then set and invert</span>
<a name="c1-474"></a><span class="lineno"> 474</span> <span class="cm">     LOGIN_SHELL. */</span>
<a name="c1-475"></a><span class="lineno"> 475</span>   <span class="k">if</span> <span class="p">(</span><span class="n">make_login_shell</span><span class="p">)</span>
<a name="c1-476"></a><span class="lineno"> 476</span>     <span class="p">{</span>
<a name="c1-477"></a><span class="lineno"> 477</span>       <span class="n">login_shell</span><span class="o">++</span><span class="p">;</span>
<a name="c1-478"></a><span class="lineno"> 478</span>       <span class="n">login_shell</span> <span class="o">=</span> <span class="o">-</span><span class="n">login_shell</span><span class="p">;</span>
<a name="c1-479"></a><span class="lineno"> 479</span>     <span class="p">}</span>
<a name="c1-480"></a><span class="lineno"> 480</span> 
<a name="c1-481"></a><span class="lineno"> 481</span>   <span class="n">set_login_shell</span> <span class="p">(</span><span class="s">"login_shell"</span><span class="p">,</span> <span class="n">login_shell</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-482"></a><span class="lineno"> 482</span> 
<a name="c1-483"></a><span class="lineno"> 483</span>   <span class="k">if</span> <span class="p">(</span><span class="n">dump_po_strings</span><span class="p">)</span>
<a name="c1-484"></a><span class="lineno"> 484</span>     <span class="n">dump_translatable_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-485"></a><span class="lineno"> 485</span> 
<a name="c1-486"></a><span class="lineno"> 486</span>   <span class="k">if</span> <span class="p">(</span><span class="n">dump_translatable_strings</span><span class="p">)</span>
<a name="c1-487"></a><span class="lineno"> 487</span>     <span class="n">read_but_dont_execute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-488"></a><span class="lineno"> 488</span> 
<a name="c1-489"></a><span class="lineno"> 489</span>   <span class="k">if</span> <span class="p">(</span><span class="n">running_setuid</span> <span class="o">&amp;&amp;</span> <span class="n">privileged_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-490"></a><span class="lineno"> 490</span>     <span class="n">disable_priv_mode</span> <span class="p">();</span>
<a name="c1-491"></a><span class="lineno"> 491</span> 
<a name="c1-492"></a><span class="lineno"> 492</span>   <span class="cm">/* Need to get the argument to a -c option processed in the</span>
<a name="c1-493"></a><span class="lineno"> 493</span> <span class="cm">     above loop.  The next arg is a command to execute, and the</span>
<a name="c1-494"></a><span class="lineno"> 494</span> <span class="cm">     following args are $0...$n respectively. */</span>
<a name="c1-495"></a><span class="lineno"> 495</span>   <span class="k">if</span> <span class="p">(</span><span class="n">want_pending_command</span><span class="p">)</span>
<a name="c1-496"></a><span class="lineno"> 496</span>     <span class="p">{</span>
<a name="c1-497"></a><span class="lineno"> 497</span>       <span class="n">command_execution_string</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">];</span>
<a name="c1-498"></a><span class="lineno"> 498</span>       <span class="k">if</span> <span class="p">(</span><span class="n">command_execution_string</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-499"></a><span class="lineno"> 499</span>   <span class="p">{</span>
<a name="c1-500"></a><span class="lineno"> 500</span>     <span class="n">report_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: option requires an argument"</span><span class="p">),</span> <span class="s">"-c"</span><span class="p">);</span>
<a name="c1-501"></a><span class="lineno"> 501</span>     <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BADUSAGE</span><span class="p">);</span>
<a name="c1-502"></a><span class="lineno"> 502</span>   <span class="p">}</span>
<a name="c1-503"></a><span class="lineno"> 503</span>       <span class="n">arg_index</span><span class="o">++</span><span class="p">;</span>
<a name="c1-504"></a><span class="lineno"> 504</span>     <span class="p">}</span>
<a name="c1-505"></a><span class="lineno"> 505</span>   <span class="n">this_command_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-506"></a><span class="lineno"> 506</span> 
<a name="c1-507"></a><span class="lineno"> 507</span>   <span class="n">cmd_init</span><span class="p">();</span>   <span class="cm">/* initialize the command object caches */</span>
<a name="c1-508"></a><span class="lineno"> 508</span> 
<a name="c1-509"></a><span class="lineno"> 509</span>   <span class="cm">/* First, let the outside world know about our interactive status.</span>
<a name="c1-510"></a><span class="lineno"> 510</span> <span class="cm">     A shell is interactive if the `-i' flag was given, or if all of</span>
<a name="c1-511"></a><span class="lineno"> 511</span> <span class="cm">     the following conditions are met:</span>
<a name="c1-512"></a><span class="lineno"> 512</span> <span class="cm"> no -c command</span>
<a name="c1-513"></a><span class="lineno"> 513</span> <span class="cm"> no arguments remaining or the -s flag given</span>
<a name="c1-514"></a><span class="lineno"> 514</span> <span class="cm"> standard input is a terminal</span>
<a name="c1-515"></a><span class="lineno"> 515</span> <span class="cm"> standard error is a terminal</span>
<a name="c1-516"></a><span class="lineno"> 516</span> <span class="cm">     Refer to Posix.2, the description of the `sh' utility. */</span>
<a name="c1-517"></a><span class="lineno"> 517</span> 
<a name="c1-518"></a><span class="lineno"> 518</span>   <span class="k">if</span> <span class="p">(</span><span class="n">forced_interactive</span> <span class="o">||</span>   <span class="cm">/* -i flag */</span>
<a name="c1-519"></a><span class="lineno"> 519</span>       <span class="p">(</span><span class="o">!</span><span class="n">command_execution_string</span> <span class="o">&amp;&amp;</span> <span class="cm">/* No -c command and ... */</span>
<a name="c1-520"></a><span class="lineno"> 520</span>        <span class="n">wordexp_only</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>    <span class="cm">/* No --wordexp and ... */</span>
<a name="c1-521"></a><span class="lineno"> 521</span>        <span class="p">((</span><span class="n">arg_index</span> <span class="o">==</span> <span class="n">argc</span><span class="p">)</span> <span class="o">||</span>    <span class="cm">/*   no remaining args or... */</span>
<a name="c1-522"></a><span class="lineno"> 522</span>   <span class="n">read_from_stdin</span><span class="p">)</span> <span class="o">&amp;&amp;</span>    <span class="cm">/*   -s flag with args, and */</span>
<a name="c1-523"></a><span class="lineno"> 523</span>        <span class="n">isatty</span> <span class="p">(</span><span class="n">fileno</span> <span class="p">(</span><span class="n">stdin</span><span class="p">))</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* Input is a terminal and */</span>
<a name="c1-524"></a><span class="lineno"> 524</span>        <span class="n">isatty</span> <span class="p">(</span><span class="n">fileno</span> <span class="p">(</span><span class="n">stderr</span><span class="p">))))</span> <span class="cm">/* error output is a terminal. */</span>
<a name="c1-525"></a><span class="lineno"> 525</span>     <span class="n">init_interactive</span> <span class="p">();</span>
<a name="c1-526"></a><span class="lineno"> 526</span>   <span class="k">else</span>
<a name="c1-527"></a><span class="lineno"> 527</span>     <span class="n">init_noninteractive</span> <span class="p">();</span>
<a name="c1-528"></a><span class="lineno"> 528</span> 
<a name="c1-529"></a><span class="lineno"> 529</span>   <span class="cm">/*</span>
<a name="c1-530"></a><span class="lineno"> 530</span> <span class="cm">   * Some systems have the bad habit of starting login shells with lots of open</span>
<a name="c1-531"></a><span class="lineno"> 531</span> <span class="cm">   * file descriptors.  For instance, most systems that have picked up the</span>
<a name="c1-532"></a><span class="lineno"> 532</span> <span class="cm">   * pre-4.0 Sun YP code leave a file descriptor open each time you call one</span>
<a name="c1-533"></a><span class="lineno"> 533</span> <span class="cm">   * of the getpw* functions, and it's set to be open across execs.  That</span>
<a name="c1-534"></a><span class="lineno"> 534</span> <span class="cm">   * means one for login, one for xterm, one for shelltool, etc.  There are</span>
<a name="c1-535"></a><span class="lineno"> 535</span> <span class="cm">   * also systems that open persistent FDs to other agents or files as part</span>
<a name="c1-536"></a><span class="lineno"> 536</span> <span class="cm">   * of process startup; these need to be set to be close-on-exec.</span>
<a name="c1-537"></a><span class="lineno"> 537</span> <span class="cm">   */</span>
<a name="c1-538"></a><span class="lineno"> 538</span>   <span class="k">if</span> <span class="p">(</span><span class="n">login_shell</span> <span class="o">&amp;&amp;</span> <span class="n">interactive_shell</span><span class="p">)</span>
<a name="c1-539"></a><span class="lineno"> 539</span>     <span class="p">{</span>
<a name="c1-540"></a><span class="lineno"> 540</span>       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-541"></a><span class="lineno"> 541</span>   <span class="n">SET_CLOSE_ON_EXEC</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="c1-542"></a><span class="lineno"> 542</span>     <span class="p">}</span>
<a name="c1-543"></a><span class="lineno"> 543</span> 
<a name="c1-544"></a><span class="lineno"> 544</span>   <span class="cm">/* If we're in a strict Posix.2 mode, turn on interactive comments,</span>
<a name="c1-545"></a><span class="lineno"> 545</span> <span class="cm">     alias expansion in non-interactive shells, and other Posix.2 things. */</span>
<a name="c1-546"></a><span class="lineno"> 546</span>   <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span><span class="p">)</span>
<a name="c1-547"></a><span class="lineno"> 547</span>     <span class="p">{</span>
<a name="c1-548"></a><span class="lineno"> 548</span>       <span class="n">bind_variable</span> <span class="p">(</span><span class="s">"POSIXLY_CORRECT"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-549"></a><span class="lineno"> 549</span>       <span class="n">sv_strict_posix</span> <span class="p">(</span><span class="s">"POSIXLY_CORRECT"</span><span class="p">);</span>
<a name="c1-550"></a><span class="lineno"> 550</span>     <span class="p">}</span>
<a name="c1-551"></a><span class="lineno"> 551</span> 
<a name="c1-552"></a><span class="lineno"> 552</span>   <span class="cm">/* Now we run the shopt_alist and process the options. */</span>
<a name="c1-553"></a><span class="lineno"> 553</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shopt_alist</span><span class="p">)</span>
<a name="c1-554"></a><span class="lineno"> 554</span>     <span class="n">run_shopt_alist</span> <span class="p">();</span>
<a name="c1-555"></a><span class="lineno"> 555</span> 
<a name="c1-556"></a><span class="lineno"> 556</span>   <span class="cm">/* From here on in, the shell must be a normal functioning shell.</span>
<a name="c1-557"></a><span class="lineno"> 557</span> <span class="cm">     Variables from the environment are expected to be set, etc. */</span>
<a name="c1-558"></a><span class="lineno"> 558</span>   <span class="n">shell_initialize</span> <span class="p">();</span>
<a name="c1-559"></a><span class="lineno"> 559</span> 
<a name="c1-560"></a><span class="lineno"> 560</span>   <span class="n">set_default_lang</span> <span class="p">();</span>
<a name="c1-561"></a><span class="lineno"> 561</span>   <span class="n">set_default_locale_vars</span> <span class="p">();</span>
<a name="c1-562"></a><span class="lineno"> 562</span> 
<a name="c1-563"></a><span class="lineno"> 563</span>   <span class="cm">/*</span>
<a name="c1-564"></a><span class="lineno"> 564</span> <span class="cm">   * M-x term -&gt; TERM=eterm EMACS=22.1 (term:0.96)  (eterm)</span>
<a name="c1-565"></a><span class="lineno"> 565</span> <span class="cm">   * M-x shell -&gt; TERM=dumb EMACS=t     (no line editing)</span>
<a name="c1-566"></a><span class="lineno"> 566</span> <span class="cm">   * M-x terminal -&gt; TERM=emacs-em7955 EMACS=   (line editing)</span>
<a name="c1-567"></a><span class="lineno"> 567</span> <span class="cm">   */</span>
<a name="c1-568"></a><span class="lineno"> 568</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span><span class="p">)</span>
<a name="c1-569"></a><span class="lineno"> 569</span>     <span class="p">{</span>
<a name="c1-570"></a><span class="lineno"> 570</span>       <span class="kt">char</span> <span class="o">*</span><span class="n">term</span><span class="p">,</span> <span class="o">*</span><span class="n">emacs</span><span class="p">;</span>
<a name="c1-571"></a><span class="lineno"> 571</span> 
<a name="c1-572"></a><span class="lineno"> 572</span>       <span class="n">term</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"TERM"</span><span class="p">);</span>
<a name="c1-573"></a><span class="lineno"> 573</span>       <span class="n">emacs</span> <span class="o">=</span> <span class="n">get_string_value</span> <span class="p">(</span><span class="s">"EMACS"</span><span class="p">);</span>
<a name="c1-574"></a><span class="lineno"> 574</span> 
<a name="c1-575"></a><span class="lineno"> 575</span>       <span class="cm">/* Not sure any emacs terminal emulator sets TERM=emacs any more */</span>
<a name="c1-576"></a><span class="lineno"> 576</span>       <span class="n">no_line_editing</span> <span class="o">|=</span> <span class="n">term</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="s">"emacs"</span><span class="p">));</span>
<a name="c1-577"></a><span class="lineno"> 577</span>       <span class="n">no_line_editing</span> <span class="o">|=</span> <span class="n">emacs</span> <span class="o">&amp;&amp;</span> <span class="n">emacs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'t'</span> <span class="o">&amp;&amp;</span> <span class="n">emacs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span> <span class="o">&amp;&amp;</span> <span class="n">STREQ</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="s">"dumb"</span><span class="p">);</span>
<a name="c1-578"></a><span class="lineno"> 578</span> 
<a name="c1-579"></a><span class="lineno"> 579</span>       <span class="cm">/* running_under_emacs == 2 for `eterm' */</span>
<a name="c1-580"></a><span class="lineno"> 580</span>       <span class="n">running_under_emacs</span> <span class="o">=</span> <span class="p">(</span><span class="n">emacs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">term</span> <span class="o">&amp;&amp;</span> <span class="n">STREQN</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="s">"emacs"</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
<a name="c1-581"></a><span class="lineno"> 581</span>       <span class="n">running_under_emacs</span> <span class="o">+=</span> <span class="n">term</span> <span class="o">&amp;&amp;</span> <span class="n">STREQN</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="s">"eterm"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">emacs</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span> <span class="p">(</span><span class="n">emacs</span><span class="p">,</span> <span class="s">"term"</span><span class="p">);</span>
<a name="c1-582"></a><span class="lineno"> 582</span> 
<a name="c1-583"></a><span class="lineno"> 583</span>       <span class="k">if</span> <span class="p">(</span><span class="n">running_under_emacs</span><span class="p">)</span>
<a name="c1-584"></a><span class="lineno"> 584</span>   <span class="n">gnu_error_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-585"></a><span class="lineno"> 585</span>     <span class="p">}</span>
<a name="c1-586"></a><span class="lineno"> 586</span> 
<a name="c1-587"></a><span class="lineno"> 587</span>   <span class="n">top_level_arg_index</span> <span class="o">=</span> <span class="n">arg_index</span><span class="p">;</span>
<a name="c1-588"></a><span class="lineno"> 588</span>   <span class="n">old_errexit_flag</span> <span class="o">=</span> <span class="n">exit_immediately_on_error</span><span class="p">;</span>
<a name="c1-589"></a><span class="lineno"> 589</span> 
<a name="c1-590"></a><span class="lineno"> 590</span>   <span class="cm">/* Give this shell a place to longjmp to before executing the</span>
<a name="c1-591"></a><span class="lineno"> 591</span> <span class="cm">     startup files.  This allows users to press C-c to abort the</span>
<a name="c1-592"></a><span class="lineno"> 592</span> <span class="cm">     lengthy startup. */</span>
<a name="c1-593"></a><span class="lineno"> 593</span>   <span class="n">code</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">);</span>
<a name="c1-594"></a><span class="lineno"> 594</span>   <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a name="c1-595"></a><span class="lineno"> 595</span>     <span class="p">{</span>
<a name="c1-596"></a><span class="lineno"> 596</span>       <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">EXITPROG</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">ERREXIT</span><span class="p">)</span>
<a name="c1-597"></a><span class="lineno"> 597</span>   <span class="n">exit_shell</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c1-598"></a><span class="lineno"> 598</span>       <span class="k">else</span>
<a name="c1-599"></a><span class="lineno"> 599</span>   <span class="p">{</span>
<a name="c1-600"></a><span class="lineno"> 600</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-601"></a><span class="lineno"> 601</span>     <span class="cm">/* Reset job control, since run_startup_files turned it off. */</span>
<a name="c1-602"></a><span class="lineno"> 602</span>     <span class="n">set_job_control</span> <span class="p">(</span><span class="n">interactive_shell</span><span class="p">);</span>
<a name="c1-603"></a><span class="lineno"> 603</span> <span class="cp">#endif</span>
<a name="c1-604"></a><span class="lineno"> 604</span>     <span class="cm">/* Reset value of `set -e', since it's turned off before running</span>
<a name="c1-605"></a><span class="lineno"> 605</span> <span class="cm">      the startup files. */</span>
<a name="c1-606"></a><span class="lineno"> 606</span>     <span class="n">exit_immediately_on_error</span> <span class="o">+=</span> <span class="n">old_errexit_flag</span><span class="p">;</span>
<a name="c1-607"></a><span class="lineno"> 607</span>     <span class="n">locally_skip_execution</span><span class="o">++</span><span class="p">;</span>
<a name="c1-608"></a><span class="lineno"> 608</span>   <span class="p">}</span>
<a name="c1-609"></a><span class="lineno"> 609</span>     <span class="p">}</span>
<a name="c1-610"></a><span class="lineno"> 610</span> 
<a name="c1-611"></a><span class="lineno"> 611</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="n">top_level_arg_index</span><span class="p">;</span>
<a name="c1-612"></a><span class="lineno"> 612</span> 
<a name="c1-613"></a><span class="lineno"> 613</span>   <span class="cm">/* Execute the start-up scripts. */</span>
<a name="c1-614"></a><span class="lineno"> 614</span> 
<a name="c1-615"></a><span class="lineno"> 615</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-616"></a><span class="lineno"> 616</span>     <span class="p">{</span>
<a name="c1-617"></a><span class="lineno"> 617</span>       <span class="n">unbind_variable</span> <span class="p">(</span><span class="s">"PS1"</span><span class="p">);</span>
<a name="c1-618"></a><span class="lineno"> 618</span>       <span class="n">unbind_variable</span> <span class="p">(</span><span class="s">"PS2"</span><span class="p">);</span>
<a name="c1-619"></a><span class="lineno"> 619</span>       <span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-620"></a><span class="lineno"> 620</span> <span class="cp">#if 0</span><span class="c"></span>
<a name="c1-621"></a><span class="lineno"> 621</span> <span class="c">      /* This has already been done by init_noninteractive */</span>
<a name="c1-622"></a><span class="lineno"> 622</span> <span class="c">      expand_aliases = posixly_correct;</span>
<a name="c1-623"></a><span class="lineno"> 623</span> <span class="cp">#endif</span>
<a name="c1-624"></a><span class="lineno"> 624</span>     <span class="p">}</span>
<a name="c1-625"></a><span class="lineno"> 625</span>   <span class="k">else</span>
<a name="c1-626"></a><span class="lineno"> 626</span>     <span class="p">{</span>
<a name="c1-627"></a><span class="lineno"> 627</span>       <span class="n">change_flag</span> <span class="p">(</span><span class="sc">'i'</span><span class="p">,</span> <span class="n">FLAG_ON</span><span class="p">);</span>
<a name="c1-628"></a><span class="lineno"> 628</span>       <span class="n">interactive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-629"></a><span class="lineno"> 629</span>     <span class="p">}</span>
<a name="c1-630"></a><span class="lineno"> 630</span> 
<a name="c1-631"></a><span class="lineno"> 631</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-632"></a><span class="lineno"> 632</span>   <span class="cm">/* Set restricted_shell based on whether the basename of $0 indicates that</span>
<a name="c1-633"></a><span class="lineno"> 633</span> <span class="cm">     the shell should be restricted or if the `-r' option was supplied at</span>
<a name="c1-634"></a><span class="lineno"> 634</span> <span class="cm">     startup. */</span>
<a name="c1-635"></a><span class="lineno"> 635</span>   <span class="n">restricted_shell</span> <span class="o">=</span> <span class="n">shell_is_restricted</span> <span class="p">(</span><span class="n">shell_name</span><span class="p">);</span>
<a name="c1-636"></a><span class="lineno"> 636</span> 
<a name="c1-637"></a><span class="lineno"> 637</span>   <span class="cm">/* If the `-r' option is supplied at invocation, make sure that the shell</span>
<a name="c1-638"></a><span class="lineno"> 638</span> <span class="cm">     is not in restricted mode when running the startup files. */</span>
<a name="c1-639"></a><span class="lineno"> 639</span>   <span class="n">saverst</span> <span class="o">=</span> <span class="k">restricted</span><span class="p">;</span>
<a name="c1-640"></a><span class="lineno"> 640</span>   <span class="k">restricted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-641"></a><span class="lineno"> 641</span> <span class="cp">#endif</span>
<a name="c1-642"></a><span class="lineno"> 642</span> 
<a name="c1-643"></a><span class="lineno"> 643</span>   <span class="cm">/* The startup files are run with `set -e' temporarily disabled. */</span>
<a name="c1-644"></a><span class="lineno"> 644</span>   <span class="k">if</span> <span class="p">(</span><span class="n">locally_skip_execution</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">running_setuid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-645"></a><span class="lineno"> 645</span>     <span class="p">{</span>
<a name="c1-646"></a><span class="lineno"> 646</span>       <span class="n">old_errexit_flag</span> <span class="o">=</span> <span class="n">exit_immediately_on_error</span><span class="p">;</span>
<a name="c1-647"></a><span class="lineno"> 647</span>       <span class="n">exit_immediately_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-648"></a><span class="lineno"> 648</span> 
<a name="c1-649"></a><span class="lineno"> 649</span>       <span class="n">run_startup_files</span> <span class="p">();</span>
<a name="c1-650"></a><span class="lineno"> 650</span>       <span class="n">exit_immediately_on_error</span> <span class="o">+=</span> <span class="n">old_errexit_flag</span><span class="p">;</span>
<a name="c1-651"></a><span class="lineno"> 651</span>     <span class="p">}</span>
<a name="c1-652"></a><span class="lineno"> 652</span> 
<a name="c1-653"></a><span class="lineno"> 653</span>   <span class="cm">/* If we are invoked as `sh', turn on Posix mode. */</span>
<a name="c1-654"></a><span class="lineno"> 654</span>   <span class="k">if</span> <span class="p">(</span><span class="n">act_like_sh</span><span class="p">)</span>
<a name="c1-655"></a><span class="lineno"> 655</span>     <span class="p">{</span>
<a name="c1-656"></a><span class="lineno"> 656</span>       <span class="n">bind_variable</span> <span class="p">(</span><span class="s">"POSIXLY_CORRECT"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-657"></a><span class="lineno"> 657</span>       <span class="n">sv_strict_posix</span> <span class="p">(</span><span class="s">"POSIXLY_CORRECT"</span><span class="p">);</span>
<a name="c1-658"></a><span class="lineno"> 658</span>     <span class="p">}</span>
<a name="c1-659"></a><span class="lineno"> 659</span> 
<a name="c1-660"></a><span class="lineno"> 660</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-661"></a><span class="lineno"> 661</span>   <span class="cm">/* Turn on the restrictions after executing the startup files.  This</span>
<a name="c1-662"></a><span class="lineno"> 662</span> <span class="cm">     means that `bash -r' or `set -r' invoked from a startup file will</span>
<a name="c1-663"></a><span class="lineno"> 663</span> <span class="cm">     turn on the restrictions after the startup files are executed. */</span>
<a name="c1-664"></a><span class="lineno"> 664</span>   <span class="k">restricted</span> <span class="o">=</span> <span class="n">saverst</span> <span class="o">||</span> <span class="k">restricted</span><span class="p">;</span>
<a name="c1-665"></a><span class="lineno"> 665</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shell_reinitialized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-666"></a><span class="lineno"> 666</span>     <span class="n">maybe_make_restricted</span> <span class="p">(</span><span class="n">shell_name</span><span class="p">);</span>
<a name="c1-667"></a><span class="lineno"> 667</span> <span class="cp">#endif </span><span class="cm">/* RESTRICTED_SHELL */</span><span class="cp"></span>
<a name="c1-668"></a><span class="lineno"> 668</span> 
<a name="c1-669"></a><span class="lineno"> 669</span> <span class="cp">#if defined (WORDEXP_OPTION)</span>
<a name="c1-670"></a><span class="lineno"> 670</span>   <span class="k">if</span> <span class="p">(</span><span class="n">wordexp_only</span><span class="p">)</span>
<a name="c1-671"></a><span class="lineno"> 671</span>     <span class="p">{</span>
<a name="c1-672"></a><span class="lineno"> 672</span>       <span class="n">startup_state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-673"></a><span class="lineno"> 673</span>       <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="n">run_wordexp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">]);</span>
<a name="c1-674"></a><span class="lineno"> 674</span>       <span class="n">exit_shell</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c1-675"></a><span class="lineno"> 675</span>     <span class="p">}</span>
<a name="c1-676"></a><span class="lineno"> 676</span> <span class="cp">#endif</span>
<a name="c1-677"></a><span class="lineno"> 677</span> 
<a name="c1-678"></a><span class="lineno"> 678</span>   <span class="k">if</span> <span class="p">(</span><span class="n">command_execution_string</span><span class="p">)</span>
<a name="c1-679"></a><span class="lineno"> 679</span>     <span class="p">{</span>
<a name="c1-680"></a><span class="lineno"> 680</span>       <span class="n">arg_index</span> <span class="o">=</span> <span class="n">bind_args</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-681"></a><span class="lineno"> 681</span>       <span class="n">startup_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c1-682"></a><span class="lineno"> 682</span> 
<a name="c1-683"></a><span class="lineno"> 683</span>       <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span><span class="p">)</span>
<a name="c1-684"></a><span class="lineno"> 684</span>   <span class="n">start_debugger</span> <span class="p">();</span>
<a name="c1-685"></a><span class="lineno"> 685</span> 
<a name="c1-686"></a><span class="lineno"> 686</span> <span class="cp">#if defined (ONESHOT)</span>
<a name="c1-687"></a><span class="lineno"> 687</span>       <span class="n">executing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-688"></a><span class="lineno"> 688</span>       <span class="n">run_one_command</span> <span class="p">(</span><span class="n">command_execution_string</span><span class="p">);</span>
<a name="c1-689"></a><span class="lineno"> 689</span>       <span class="n">exit_shell</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c1-690"></a><span class="lineno"> 690</span> <span class="cp">#else </span><span class="cm">/* ONESHOT */</span><span class="cp"></span>
<a name="c1-691"></a><span class="lineno"> 691</span>       <span class="n">with_input_from_string</span> <span class="p">(</span><span class="n">command_execution_string</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">);</span>
<a name="c1-692"></a><span class="lineno"> 692</span>       <span class="k">goto</span> <span class="n">read_and_execute</span><span class="p">;</span>
<a name="c1-693"></a><span class="lineno"> 693</span> <span class="cp">#endif </span><span class="cm">/* !ONESHOT */</span><span class="cp"></span>
<a name="c1-694"></a><span class="lineno"> 694</span>     <span class="p">}</span>
<a name="c1-695"></a><span class="lineno"> 695</span> 
<a name="c1-696"></a><span class="lineno"> 696</span>   <span class="cm">/* Get possible input filename and set up default_buffered_input or</span>
<a name="c1-697"></a><span class="lineno"> 697</span> <span class="cm">     default_input as appropriate. */</span>
<a name="c1-698"></a><span class="lineno"> 698</span>   <span class="k">if</span> <span class="p">(</span><span class="n">arg_index</span> <span class="o">!=</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">read_from_stdin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-699"></a><span class="lineno"> 699</span>     <span class="p">{</span>
<a name="c1-700"></a><span class="lineno"> 700</span>       <span class="n">open_shell_script</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">]);</span>
<a name="c1-701"></a><span class="lineno"> 701</span>       <span class="n">arg_index</span><span class="o">++</span><span class="p">;</span>
<a name="c1-702"></a><span class="lineno"> 702</span>     <span class="p">}</span>
<a name="c1-703"></a><span class="lineno"> 703</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">interactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-704"></a><span class="lineno"> 704</span>     <span class="cm">/* In this mode, bash is reading a script from stdin, which is a</span>
<a name="c1-705"></a><span class="lineno"> 705</span> <span class="cm">       pipe or redirected file. */</span>
<a name="c1-706"></a><span class="lineno"> 706</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-707"></a><span class="lineno"> 707</span>     <span class="n">default_buffered_input</span> <span class="o">=</span> <span class="n">fileno</span> <span class="p">(</span><span class="n">stdin</span><span class="p">);</span>  <span class="cm">/* == 0 */</span>
<a name="c1-708"></a><span class="lineno"> 708</span> <span class="cp">#else</span>
<a name="c1-709"></a><span class="lineno"> 709</span>     <span class="n">setbuf</span> <span class="p">(</span><span class="n">default_input</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c1-710"></a><span class="lineno"> 710</span> <span class="cp">#endif </span><span class="cm">/* !BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-711"></a><span class="lineno"> 711</span> 
<a name="c1-712"></a><span class="lineno"> 712</span>   <span class="n">set_bash_input</span> <span class="p">();</span>
<a name="c1-713"></a><span class="lineno"> 713</span> 
<a name="c1-714"></a><span class="lineno"> 714</span>   <span class="cm">/* Bind remaining args to $1 ... $n */</span>
<a name="c1-715"></a><span class="lineno"> 715</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="n">bind_args</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-716"></a><span class="lineno"> 716</span> 
<a name="c1-717"></a><span class="lineno"> 717</span>   <span class="k">if</span> <span class="p">(</span><span class="n">debugging_mode</span> <span class="o">&amp;&amp;</span> <span class="n">locally_skip_execution</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">running_setuid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-718"></a><span class="lineno"> 718</span>     <span class="n">start_debugger</span> <span class="p">();</span>
<a name="c1-719"></a><span class="lineno"> 719</span> 
<a name="c1-720"></a><span class="lineno"> 720</span>   <span class="cm">/* Do the things that should be done only for interactive shells. */</span>
<a name="c1-721"></a><span class="lineno"> 721</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span><span class="p">)</span>
<a name="c1-722"></a><span class="lineno"> 722</span>     <span class="p">{</span>
<a name="c1-723"></a><span class="lineno"> 723</span>       <span class="cm">/* Set up for checking for presence of mail. */</span>
<a name="c1-724"></a><span class="lineno"> 724</span>       <span class="n">reset_mail_timer</span> <span class="p">();</span>
<a name="c1-725"></a><span class="lineno"> 725</span>       <span class="n">init_mail_dates</span> <span class="p">();</span>
<a name="c1-726"></a><span class="lineno"> 726</span> 
<a name="c1-727"></a><span class="lineno"> 727</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c1-728"></a><span class="lineno"> 728</span>       <span class="cm">/* Initialize the interactive history stuff. */</span>
<a name="c1-729"></a><span class="lineno"> 729</span>       <span class="n">bash_initialize_history</span> <span class="p">();</span>
<a name="c1-730"></a><span class="lineno"> 730</span>       <span class="cm">/* Don't load the history from the history file if we've already</span>
<a name="c1-731"></a><span class="lineno"> 731</span> <span class="cm">  saved some lines in this session (e.g., by putting `history -s xx'</span>
<a name="c1-732"></a><span class="lineno"> 732</span> <span class="cm">  into one of the startup files). */</span>
<a name="c1-733"></a><span class="lineno"> 733</span>       <span class="k">if</span> <span class="p">(</span><span class="n">shell_initialized</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">history_lines_this_session</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-734"></a><span class="lineno"> 734</span>   <span class="n">load_history</span> <span class="p">();</span>
<a name="c1-735"></a><span class="lineno"> 735</span> <span class="cp">#endif </span><span class="cm">/* HISTORY */</span><span class="cp"></span>
<a name="c1-736"></a><span class="lineno"> 736</span> 
<a name="c1-737"></a><span class="lineno"> 737</span>       <span class="cm">/* Initialize terminal state for interactive shells after the</span>
<a name="c1-738"></a><span class="lineno"> 738</span> <span class="cm">  .bash_profile and .bashrc are interpreted. */</span>
<a name="c1-739"></a><span class="lineno"> 739</span>       <span class="n">get_tty_state</span> <span class="p">();</span>
<a name="c1-740"></a><span class="lineno"> 740</span>     <span class="p">}</span>
<a name="c1-741"></a><span class="lineno"> 741</span> 
<a name="c1-742"></a><span class="lineno"> 742</span> <span class="cp">#if !defined (ONESHOT)</span>
<a name="c1-743"></a><span class="lineno"> 743</span>  <span class="nl">read_and_execute:</span>
<a name="c1-744"></a><span class="lineno"> 744</span> <span class="cp">#endif </span><span class="cm">/* !ONESHOT */</span><span class="cp"></span>
<a name="c1-745"></a><span class="lineno"> 745</span> 
<a name="c1-746"></a><span class="lineno"> 746</span>   <span class="n">shell_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-747"></a><span class="lineno"> 747</span> 
<a name="c1-748"></a><span class="lineno"> 748</span>   <span class="cm">/* Read commands until exit condition. */</span>
<a name="c1-749"></a><span class="lineno"> 749</span>   <span class="n">reader_loop</span> <span class="p">();</span>
<a name="c1-750"></a><span class="lineno"> 750</span>   <span class="n">exit_shell</span> <span class="p">(</span><span class="n">last_command_exit_value</span><span class="p">);</span>
<a name="c1-751"></a><span class="lineno"> 751</span> <span class="p">}</span>
<a name="c1-752"></a><span class="lineno"> 752</span> 
<a name="c1-753"></a><span class="lineno"> 753</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-754"></a><span class="lineno"> 754</span> <span class="n">parse_long_options</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">arg_end</span><span class="p">)</span>
<a name="c1-755"></a><span class="lineno"> 755</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
<a name="c1-756"></a><span class="lineno"> 756</span>      <span class="kt">int</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">arg_end</span><span class="p">;</span>
<a name="c1-757"></a><span class="lineno"> 757</span> <span class="p">{</span>
<a name="c1-758"></a><span class="lineno"> 758</span>   <span class="kt">int</span> <span class="n">arg_index</span><span class="p">,</span> <span class="n">longarg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-759"></a><span class="lineno"> 759</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">arg_string</span><span class="p">;</span>
<a name="c1-760"></a><span class="lineno"> 760</span> 
<a name="c1-761"></a><span class="lineno"> 761</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="n">arg_start</span><span class="p">;</span>
<a name="c1-762"></a><span class="lineno"> 762</span>   <span class="k">while</span> <span class="p">((</span><span class="n">arg_index</span> <span class="o">!=</span> <span class="n">arg_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arg_string</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
<a name="c1-763"></a><span class="lineno"> 763</span>    <span class="p">(</span><span class="o">*</span><span class="n">arg_string</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">))</span>
<a name="c1-764"></a><span class="lineno"> 764</span>     <span class="p">{</span>
<a name="c1-765"></a><span class="lineno"> 765</span>       <span class="n">longarg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-766"></a><span class="lineno"> 766</span> 
<a name="c1-767"></a><span class="lineno"> 767</span>       <span class="cm">/* Make --login equivalent to -login. */</span>
<a name="c1-768"></a><span class="lineno"> 768</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">&amp;&amp;</span> <span class="n">arg_string</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a name="c1-769"></a><span class="lineno"> 769</span>   <span class="p">{</span>
<a name="c1-770"></a><span class="lineno"> 770</span>     <span class="n">longarg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-771"></a><span class="lineno"> 771</span>     <span class="n">arg_string</span><span class="o">++</span><span class="p">;</span>
<a name="c1-772"></a><span class="lineno"> 772</span>   <span class="p">}</span>
<a name="c1-773"></a><span class="lineno"> 773</span> 
<a name="c1-774"></a><span class="lineno"> 774</span>       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-775"></a><span class="lineno"> 775</span>   <span class="p">{</span>
<a name="c1-776"></a><span class="lineno"> 776</span>     <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">arg_string</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span>
<a name="c1-777"></a><span class="lineno"> 777</span>       <span class="p">{</span>
<a name="c1-778"></a><span class="lineno"> 778</span>         <span class="k">if</span> <span class="p">(</span><span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">Int</span><span class="p">)</span>
<a name="c1-779"></a><span class="lineno"> 779</span>     <span class="o">*</span><span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">int_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-780"></a><span class="lineno"> 780</span>         <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="o">++</span><span class="n">arg_index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-781"></a><span class="lineno"> 781</span>     <span class="p">{</span>
<a name="c1-782"></a><span class="lineno"> 782</span>       <span class="n">report_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: option requires an argument"</span><span class="p">),</span> <span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
<a name="c1-783"></a><span class="lineno"> 783</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BADUSAGE</span><span class="p">);</span>
<a name="c1-784"></a><span class="lineno"> 784</span>     <span class="p">}</span>
<a name="c1-785"></a><span class="lineno"> 785</span>         <span class="k">else</span>
<a name="c1-786"></a><span class="lineno"> 786</span>     <span class="o">*</span><span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">char_value</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">];</span>
<a name="c1-787"></a><span class="lineno"> 787</span> 
<a name="c1-788"></a><span class="lineno"> 788</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-789"></a><span class="lineno"> 789</span>       <span class="p">}</span>
<a name="c1-790"></a><span class="lineno"> 790</span>   <span class="p">}</span>
<a name="c1-791"></a><span class="lineno"> 791</span>       <span class="k">if</span> <span class="p">(</span><span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-792"></a><span class="lineno"> 792</span>   <span class="p">{</span>
<a name="c1-793"></a><span class="lineno"> 793</span>     <span class="k">if</span> <span class="p">(</span><span class="n">longarg</span><span class="p">)</span>
<a name="c1-794"></a><span class="lineno"> 794</span>       <span class="p">{</span>
<a name="c1-795"></a><span class="lineno"> 795</span>         <span class="n">report_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: invalid option"</span><span class="p">),</span> <span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">]);</span>
<a name="c1-796"></a><span class="lineno"> 796</span>         <span class="n">show_shell_usage</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-797"></a><span class="lineno"> 797</span>         <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BADUSAGE</span><span class="p">);</span>
<a name="c1-798"></a><span class="lineno"> 798</span>       <span class="p">}</span>
<a name="c1-799"></a><span class="lineno"> 799</span>     <span class="k">break</span><span class="p">;</span>    <span class="cm">/* No such argument.  Maybe flag arg. */</span>
<a name="c1-800"></a><span class="lineno"> 800</span>   <span class="p">}</span>
<a name="c1-801"></a><span class="lineno"> 801</span> 
<a name="c1-802"></a><span class="lineno"> 802</span>       <span class="n">arg_index</span><span class="o">++</span><span class="p">;</span>
<a name="c1-803"></a><span class="lineno"> 803</span>     <span class="p">}</span>
<a name="c1-804"></a><span class="lineno"> 804</span> 
<a name="c1-805"></a><span class="lineno"> 805</span>   <span class="k">return</span> <span class="p">(</span><span class="n">arg_index</span><span class="p">);</span>
<a name="c1-806"></a><span class="lineno"> 806</span> <span class="p">}</span>
<a name="c1-807"></a><span class="lineno"> 807</span> 
<a name="c1-808"></a><span class="lineno"> 808</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-809"></a><span class="lineno"> 809</span> <span class="n">parse_shell_options</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">arg_end</span><span class="p">)</span>
<a name="c1-810"></a><span class="lineno"> 810</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
<a name="c1-811"></a><span class="lineno"> 811</span>      <span class="kt">int</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">arg_end</span><span class="p">;</span>
<a name="c1-812"></a><span class="lineno"> 812</span> <span class="p">{</span>
<a name="c1-813"></a><span class="lineno"> 813</span>   <span class="kt">int</span> <span class="n">arg_index</span><span class="p">;</span>
<a name="c1-814"></a><span class="lineno"> 814</span>   <span class="kt">int</span> <span class="n">arg_character</span><span class="p">,</span> <span class="n">on_or_off</span><span class="p">,</span> <span class="n">next_arg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-815"></a><span class="lineno"> 815</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">o_option</span><span class="p">,</span> <span class="o">*</span><span class="n">arg_string</span><span class="p">;</span>
<a name="c1-816"></a><span class="lineno"> 816</span> 
<a name="c1-817"></a><span class="lineno"> 817</span>   <span class="n">arg_index</span> <span class="o">=</span> <span class="n">arg_start</span><span class="p">;</span>
<a name="c1-818"></a><span class="lineno"> 818</span>   <span class="k">while</span> <span class="p">(</span><span class="n">arg_index</span> <span class="o">!=</span> <span class="n">arg_end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arg_string</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">arg_index</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
<a name="c1-819"></a><span class="lineno"> 819</span>    <span class="p">(</span><span class="o">*</span><span class="n">arg_string</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="o">*</span><span class="n">arg_string</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">))</span>
<a name="c1-820"></a><span class="lineno"> 820</span>     <span class="p">{</span>
<a name="c1-821"></a><span class="lineno"> 821</span>       <span class="cm">/* There are flag arguments, so parse them. */</span>
<a name="c1-822"></a><span class="lineno"> 822</span>       <span class="n">next_arg</span> <span class="o">=</span> <span class="n">arg_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-823"></a><span class="lineno"> 823</span> 
<a name="c1-824"></a><span class="lineno"> 824</span>       <span class="cm">/* A single `-' signals the end of options.  From the 4.3 BSD sh.</span>
<a name="c1-825"></a><span class="lineno"> 825</span> <span class="cm">  An option `--' means the same thing; this is the standard</span>
<a name="c1-826"></a><span class="lineno"> 826</span> <span class="cm">  getopt(3) meaning. */</span>
<a name="c1-827"></a><span class="lineno"> 827</span>       <span class="k">if</span> <span class="p">(</span><span class="n">arg_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">&amp;&amp;</span>
<a name="c1-828"></a><span class="lineno"> 828</span>      <span class="p">(</span><span class="n">arg_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span> <span class="o">||</span>
<a name="c1-829"></a><span class="lineno"> 829</span>        <span class="p">(</span><span class="n">arg_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">&amp;&amp;</span> <span class="n">arg_string</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)))</span>
<a name="c1-830"></a><span class="lineno"> 830</span>   <span class="k">return</span> <span class="p">(</span><span class="n">next_arg</span><span class="p">);</span>
<a name="c1-831"></a><span class="lineno"> 831</span> 
<a name="c1-832"></a><span class="lineno"> 832</span>       <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-833"></a><span class="lineno"> 833</span>       <span class="n">on_or_off</span> <span class="o">=</span> <span class="n">arg_string</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="c1-834"></a><span class="lineno"> 834</span>       <span class="k">while</span> <span class="p">(</span><span class="n">arg_character</span> <span class="o">=</span> <span class="n">arg_string</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span>
<a name="c1-835"></a><span class="lineno"> 835</span>   <span class="p">{</span>
<a name="c1-836"></a><span class="lineno"> 836</span>     <span class="k">switch</span> <span class="p">(</span><span class="n">arg_character</span><span class="p">)</span>
<a name="c1-837"></a><span class="lineno"> 837</span>       <span class="p">{</span>
<a name="c1-838"></a><span class="lineno"> 838</span>       <span class="k">case</span> <span class="sc">'c'</span>:
<a name="c1-839"></a><span class="lineno"> 839</span>         <span class="n">want_pending_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-840"></a><span class="lineno"> 840</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-841"></a><span class="lineno"> 841</span> 
<a name="c1-842"></a><span class="lineno"> 842</span>       <span class="k">case</span> <span class="sc">'l'</span>:
<a name="c1-843"></a><span class="lineno"> 843</span>         <span class="n">make_login_shell</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-844"></a><span class="lineno"> 844</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-845"></a><span class="lineno"> 845</span> 
<a name="c1-846"></a><span class="lineno"> 846</span>       <span class="k">case</span> <span class="sc">'s'</span>:
<a name="c1-847"></a><span class="lineno"> 847</span>         <span class="n">read_from_stdin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-848"></a><span class="lineno"> 848</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-849"></a><span class="lineno"> 849</span> 
<a name="c1-850"></a><span class="lineno"> 850</span>       <span class="k">case</span> <span class="sc">'o'</span>:
<a name="c1-851"></a><span class="lineno"> 851</span>         <span class="n">o_option</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">next_arg</span><span class="p">];</span>
<a name="c1-852"></a><span class="lineno"> 852</span>         <span class="k">if</span> <span class="p">(</span><span class="n">o_option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-853"></a><span class="lineno"> 853</span>     <span class="p">{</span>
<a name="c1-854"></a><span class="lineno"> 854</span>       <span class="n">list_minus_o_opts</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">on_or_off</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-855"></a><span class="lineno"> 855</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-856"></a><span class="lineno"> 856</span>     <span class="p">}</span>
<a name="c1-857"></a><span class="lineno"> 857</span>         <span class="k">if</span> <span class="p">(</span><span class="n">set_minus_o_option</span> <span class="p">(</span><span class="n">on_or_off</span><span class="p">,</span> <span class="n">o_option</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c1-858"></a><span class="lineno"> 858</span>     <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BADUSAGE</span><span class="p">);</span>
<a name="c1-859"></a><span class="lineno"> 859</span>         <span class="n">next_arg</span><span class="o">++</span><span class="p">;</span>
<a name="c1-860"></a><span class="lineno"> 860</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-861"></a><span class="lineno"> 861</span> 
<a name="c1-862"></a><span class="lineno"> 862</span>       <span class="k">case</span> <span class="sc">'O'</span>:
<a name="c1-863"></a><span class="lineno"> 863</span>         <span class="cm">/* Since some of these can be overridden by the normal</span>
<a name="c1-864"></a><span class="lineno"> 864</span> <span class="cm">    interactive/non-interactive shell initialization or</span>
<a name="c1-865"></a><span class="lineno"> 865</span> <span class="cm">    initializing posix mode, we save the options and process</span>
<a name="c1-866"></a><span class="lineno"> 866</span> <span class="cm">    them after initialization. */</span>
<a name="c1-867"></a><span class="lineno"> 867</span>         <span class="n">o_option</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">next_arg</span><span class="p">];</span>
<a name="c1-868"></a><span class="lineno"> 868</span>         <span class="k">if</span> <span class="p">(</span><span class="n">o_option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-869"></a><span class="lineno"> 869</span>     <span class="p">{</span>
<a name="c1-870"></a><span class="lineno"> 870</span>       <span class="n">shopt_listopt</span> <span class="p">(</span><span class="n">o_option</span><span class="p">,</span> <span class="p">(</span><span class="n">on_or_off</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-871"></a><span class="lineno"> 871</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-872"></a><span class="lineno"> 872</span>     <span class="p">}</span>
<a name="c1-873"></a><span class="lineno"> 873</span>         <span class="n">add_shopt_to_alist</span> <span class="p">(</span><span class="n">o_option</span><span class="p">,</span> <span class="n">on_or_off</span><span class="p">);</span>
<a name="c1-874"></a><span class="lineno"> 874</span>         <span class="n">next_arg</span><span class="o">++</span><span class="p">;</span>
<a name="c1-875"></a><span class="lineno"> 875</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-876"></a><span class="lineno"> 876</span> 
<a name="c1-877"></a><span class="lineno"> 877</span>       <span class="k">case</span> <span class="sc">'D'</span>:
<a name="c1-878"></a><span class="lineno"> 878</span>         <span class="n">dump_translatable_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-879"></a><span class="lineno"> 879</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-880"></a><span class="lineno"> 880</span> 
<a name="c1-881"></a><span class="lineno"> 881</span>       <span class="nl">default:</span>
<a name="c1-882"></a><span class="lineno"> 882</span>         <span class="k">if</span> <span class="p">(</span><span class="n">change_flag</span> <span class="p">(</span><span class="n">arg_character</span><span class="p">,</span> <span class="n">on_or_off</span><span class="p">)</span> <span class="o">==</span> <span class="n">FLAG_ERROR</span><span class="p">)</span>
<a name="c1-883"></a><span class="lineno"> 883</span>     <span class="p">{</span>
<a name="c1-884"></a><span class="lineno"> 884</span>       <span class="n">report_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%c%c: invalid option"</span><span class="p">),</span> <span class="n">on_or_off</span><span class="p">,</span> <span class="n">arg_character</span><span class="p">);</span>
<a name="c1-885"></a><span class="lineno"> 885</span>       <span class="n">show_shell_usage</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-886"></a><span class="lineno"> 886</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BADUSAGE</span><span class="p">);</span>
<a name="c1-887"></a><span class="lineno"> 887</span>     <span class="p">}</span>
<a name="c1-888"></a><span class="lineno"> 888</span>       <span class="p">}</span>
<a name="c1-889"></a><span class="lineno"> 889</span>   <span class="p">}</span>
<a name="c1-890"></a><span class="lineno"> 890</span>       <span class="cm">/* Can't do just a simple increment anymore -- what about</span>
<a name="c1-891"></a><span class="lineno"> 891</span> <span class="cm">  "bash -abouo emacs ignoreeof -hP"? */</span>
<a name="c1-892"></a><span class="lineno"> 892</span>       <span class="n">arg_index</span> <span class="o">=</span> <span class="n">next_arg</span><span class="p">;</span>
<a name="c1-893"></a><span class="lineno"> 893</span>     <span class="p">}</span>
<a name="c1-894"></a><span class="lineno"> 894</span> 
<a name="c1-895"></a><span class="lineno"> 895</span>   <span class="k">return</span> <span class="p">(</span><span class="n">arg_index</span><span class="p">);</span>
<a name="c1-896"></a><span class="lineno"> 896</span> <span class="p">}</span>
<a name="c1-897"></a><span class="lineno"> 897</span> 
<a name="c1-898"></a><span class="lineno"> 898</span> <span class="cm">/* Exit the shell with status S. */</span>
<a name="c1-899"></a><span class="lineno"> 899</span> <span class="kt">void</span>
<a name="c1-900"></a><span class="lineno"> 900</span> <span class="n">exit_shell</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a name="c1-901"></a><span class="lineno"> 901</span>      <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
<a name="c1-902"></a><span class="lineno"> 902</span> <span class="p">{</span>
<a name="c1-903"></a><span class="lineno"> 903</span>   <span class="n">fflush</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>    <span class="cm">/* XXX */</span>
<a name="c1-904"></a><span class="lineno"> 904</span>   <span class="n">fflush</span> <span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
<a name="c1-905"></a><span class="lineno"> 905</span> 
<a name="c1-906"></a><span class="lineno"> 906</span>   <span class="cm">/* Do trap[0] if defined.  Allow it to override the exit status</span>
<a name="c1-907"></a><span class="lineno"> 907</span> <span class="cm">     passed to us. */</span>
<a name="c1-908"></a><span class="lineno"> 908</span>   <span class="k">if</span> <span class="p">(</span><span class="n">signal_is_trapped</span> <span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a name="c1-909"></a><span class="lineno"> 909</span>     <span class="n">s</span> <span class="o">=</span> <span class="n">run_exit_trap</span> <span class="p">();</span>
<a name="c1-910"></a><span class="lineno"> 910</span> 
<a name="c1-911"></a><span class="lineno"> 911</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c1-912"></a><span class="lineno"> 912</span>   <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c1-913"></a><span class="lineno"> 913</span> <span class="cp">#endif </span><span class="cm">/* PROCESS_SUBSTITUTION */</span><span class="cp"></span>
<a name="c1-914"></a><span class="lineno"> 914</span> 
<a name="c1-915"></a><span class="lineno"> 915</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c1-916"></a><span class="lineno"> 916</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span><span class="p">)</span>
<a name="c1-917"></a><span class="lineno"> 917</span>     <span class="n">maybe_save_shell_history</span> <span class="p">();</span>
<a name="c1-918"></a><span class="lineno"> 918</span> <span class="cp">#endif </span><span class="cm">/* HISTORY */</span><span class="cp"></span>
<a name="c1-919"></a><span class="lineno"> 919</span> 
<a name="c1-920"></a><span class="lineno"> 920</span> <span class="cp">#if defined (COPROCESS_SUPPORT)</span>
<a name="c1-921"></a><span class="lineno"> 921</span>   <span class="n">coproc_flush</span> <span class="p">();</span>
<a name="c1-922"></a><span class="lineno"> 922</span> <span class="cp">#endif</span>
<a name="c1-923"></a><span class="lineno"> 923</span> 
<a name="c1-924"></a><span class="lineno"> 924</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-925"></a><span class="lineno"> 925</span>   <span class="cm">/* If the user has run `shopt -s huponexit', hangup all jobs when we exit</span>
<a name="c1-926"></a><span class="lineno"> 926</span> <span class="cm">     an interactive login shell.  ksh does this unconditionally. */</span>
<a name="c1-927"></a><span class="lineno"> 927</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">&amp;&amp;</span> <span class="n">login_shell</span> <span class="o">&amp;&amp;</span> <span class="n">hup_on_exit</span><span class="p">)</span>
<a name="c1-928"></a><span class="lineno"> 928</span>     <span class="n">hangup_all_jobs</span> <span class="p">();</span>
<a name="c1-929"></a><span class="lineno"> 929</span> 
<a name="c1-930"></a><span class="lineno"> 930</span>   <span class="cm">/* If this shell is interactive, terminate all stopped jobs and</span>
<a name="c1-931"></a><span class="lineno"> 931</span> <span class="cm">     restore the original terminal process group.  Don't do this if we're</span>
<a name="c1-932"></a><span class="lineno"> 932</span> <span class="cm">     in a subshell and calling exit_shell after, for example, a failed</span>
<a name="c1-933"></a><span class="lineno"> 933</span> <span class="cm">     word expansion. */</span>
<a name="c1-934"></a><span class="lineno"> 934</span>   <span class="k">if</span> <span class="p">(</span><span class="n">subshell_environment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-935"></a><span class="lineno"> 935</span>     <span class="n">end_job_control</span> <span class="p">();</span>
<a name="c1-936"></a><span class="lineno"> 936</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c1-937"></a><span class="lineno"> 937</span> 
<a name="c1-938"></a><span class="lineno"> 938</span>   <span class="cm">/* Always return the exit status of the last command to our parent. */</span>
<a name="c1-939"></a><span class="lineno"> 939</span>   <span class="n">sh_exit</span> <span class="p">(</span><span class="n">s</span><span class="p">);</span>
<a name="c1-940"></a><span class="lineno"> 940</span> <span class="p">}</span>
<a name="c1-941"></a><span class="lineno"> 941</span> 
<a name="c1-942"></a><span class="lineno"> 942</span> <span class="cm">/* A wrapper for exit that (optionally) can do other things, like malloc</span>
<a name="c1-943"></a><span class="lineno"> 943</span> <span class="cm">   statistics tracing. */</span>
<a name="c1-944"></a><span class="lineno"> 944</span> <span class="kt">void</span>
<a name="c1-945"></a><span class="lineno"> 945</span> <span class="n">sh_exit</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a name="c1-946"></a><span class="lineno"> 946</span>      <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
<a name="c1-947"></a><span class="lineno"> 947</span> <span class="p">{</span>
<a name="c1-948"></a><span class="lineno"> 948</span> <span class="cp">#if defined (MALLOC_DEBUG) &amp;&amp; defined (USING_BASH_MALLOC)</span>
<a name="c1-949"></a><span class="lineno"> 949</span>   <span class="k">if</span> <span class="p">(</span><span class="n">malloc_trace_at_exit</span><span class="p">)</span>
<a name="c1-950"></a><span class="lineno"> 950</span>     <span class="n">trace_malloc_stats</span> <span class="p">(</span><span class="n">get_name_for_error</span> <span class="p">(),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c1-951"></a><span class="lineno"> 951</span> <span class="cp">#endif</span>
<a name="c1-952"></a><span class="lineno"> 952</span> 
<a name="c1-953"></a><span class="lineno"> 953</span>   <span class="n">exit</span> <span class="p">(</span><span class="n">s</span><span class="p">);</span>
<a name="c1-954"></a><span class="lineno"> 954</span> <span class="p">}</span>
<a name="c1-955"></a><span class="lineno"> 955</span> 
<a name="c1-956"></a><span class="lineno"> 956</span> <span class="cm">/* Source the bash startup files.  If POSIXLY_CORRECT is non-zero, we obey</span>
<a name="c1-957"></a><span class="lineno"> 957</span> <span class="cm">   the Posix.2 startup file rules:  $ENV is expanded, and if the file it</span>
<a name="c1-958"></a><span class="lineno"> 958</span> <span class="cm">   names exists, that file is sourced.  The Posix.2 rules are in effect</span>
<a name="c1-959"></a><span class="lineno"> 959</span> <span class="cm">   for interactive shells only. (section 4.56.5.3) */</span>
<a name="c1-960"></a><span class="lineno"> 960</span> 
<a name="c1-961"></a><span class="lineno"> 961</span> <span class="cm">/* Execute ~/.bashrc for most shells.  Never execute it if</span>
<a name="c1-962"></a><span class="lineno"> 962</span> <span class="cm">   ACT_LIKE_SH is set, or if NO_RC is set.</span>
<a name="c1-963"></a><span class="lineno"> 963</span> 
<a name="c1-964"></a><span class="lineno"> 964</span> <span class="cm">   If the executable file "/usr/gnu/src/bash/foo" contains:</span>
<a name="c1-965"></a><span class="lineno"> 965</span> 
<a name="c1-966"></a><span class="lineno"> 966</span> <span class="cm">   #!/usr/gnu/bin/bash</span>
<a name="c1-967"></a><span class="lineno"> 967</span> <span class="cm">   echo hello</span>
<a name="c1-968"></a><span class="lineno"> 968</span> 
<a name="c1-969"></a><span class="lineno"> 969</span> <span class="cm">   then:</span>
<a name="c1-970"></a><span class="lineno"> 970</span> 
<a name="c1-971"></a><span class="lineno"> 971</span> <span class="cm">  COMMAND      EXECUTE BASHRC</span>
<a name="c1-972"></a><span class="lineno"> 972</span> <span class="cm">  --------------------------------</span>
<a name="c1-973"></a><span class="lineno"> 973</span> <span class="cm">  bash -c foo    NO</span>
<a name="c1-974"></a><span class="lineno"> 974</span> <span class="cm">  bash foo   NO</span>
<a name="c1-975"></a><span class="lineno"> 975</span> <span class="cm">  foo      NO</span>
<a name="c1-976"></a><span class="lineno"> 976</span> <span class="cm">  rsh machine ls   YES (for rsh, which calls `bash -c')</span>
<a name="c1-977"></a><span class="lineno"> 977</span> <span class="cm">  rsh machine foo  YES (for shell started by rsh) NO (for foo!)</span>
<a name="c1-978"></a><span class="lineno"> 978</span> <span class="cm">  echo ls | bash   NO</span>
<a name="c1-979"></a><span class="lineno"> 979</span> <span class="cm">  login      NO</span>
<a name="c1-980"></a><span class="lineno"> 980</span> <span class="cm">  bash     YES</span>
<a name="c1-981"></a><span class="lineno"> 981</span> <span class="cm">*/</span>
<a name="c1-982"></a><span class="lineno"> 982</span> 
<a name="c1-983"></a><span class="lineno"> 983</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-984"></a><span class="lineno"> 984</span> <span class="n">execute_env_file</span> <span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
<a name="c1-985"></a><span class="lineno"> 985</span>       <span class="kt">char</span> <span class="o">*</span><span class="n">env_file</span><span class="p">;</span>
<a name="c1-986"></a><span class="lineno"> 986</span> <span class="p">{</span>
<a name="c1-987"></a><span class="lineno"> 987</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>
<a name="c1-988"></a><span class="lineno"> 988</span> 
<a name="c1-989"></a><span class="lineno"> 989</span>   <span class="k">if</span> <span class="p">(</span><span class="n">env_file</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">env_file</span><span class="p">)</span>
<a name="c1-990"></a><span class="lineno"> 990</span>     <span class="p">{</span>
<a name="c1-991"></a><span class="lineno"> 991</span>       <span class="n">fn</span> <span class="o">=</span> <span class="n">expand_string_unsplit_to_string</span> <span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="n">Q_DOUBLE_QUOTES</span><span class="p">);</span>
<a name="c1-992"></a><span class="lineno"> 992</span>       <span class="k">if</span> <span class="p">(</span><span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fn</span><span class="p">)</span>
<a name="c1-993"></a><span class="lineno"> 993</span>   <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-994"></a><span class="lineno"> 994</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<a name="c1-995"></a><span class="lineno"> 995</span>     <span class="p">}</span>
<a name="c1-996"></a><span class="lineno"> 996</span> <span class="p">}</span>
<a name="c1-997"></a><span class="lineno"> 997</span> 
<a name="c1-998"></a><span class="lineno"> 998</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-999"></a><span class="lineno"> 999</span> <span class="n">run_startup_files</span> <span class="p">()</span>
<a name="c1-1000"></a><span class="lineno">1000</span> <span class="p">{</span>
<a name="c1-1001"></a><span class="lineno">1001</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-1002"></a><span class="lineno">1002</span>   <span class="kt">int</span> <span class="n">old_job_control</span><span class="p">;</span>
<a name="c1-1003"></a><span class="lineno">1003</span> <span class="cp">#endif</span>
<a name="c1-1004"></a><span class="lineno">1004</span>   <span class="kt">int</span> <span class="n">sourced_login</span><span class="p">,</span> <span class="n">run_by_ssh</span><span class="p">;</span>
<a name="c1-1005"></a><span class="lineno">1005</span> 
<a name="c1-1006"></a><span class="lineno">1006</span>   <span class="cm">/* get the rshd/sshd case out of the way first. */</span>
<a name="c1-1007"></a><span class="lineno">1007</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">no_rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">login_shell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c1-1008"></a><span class="lineno">1008</span>       <span class="n">act_like_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">command_execution_string</span><span class="p">)</span>
<a name="c1-1009"></a><span class="lineno">1009</span>     <span class="p">{</span>
<a name="c1-1010"></a><span class="lineno">1010</span> <span class="cp">#ifdef SSH_SOURCE_BASHRC</span>
<a name="c1-1011"></a><span class="lineno">1011</span>       <span class="n">run_by_ssh</span> <span class="o">=</span> <span class="p">(</span><span class="n">find_variable</span> <span class="p">(</span><span class="s">"SSH_CLIENT"</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SHELL_VAR</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1012"></a><span class="lineno">1012</span>       <span class="p">(</span><span class="n">find_variable</span> <span class="p">(</span><span class="s">"SSH2_CLIENT"</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SHELL_VAR</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1013"></a><span class="lineno">1013</span> <span class="cp">#else</span>
<a name="c1-1014"></a><span class="lineno">1014</span>       <span class="n">run_by_ssh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1015"></a><span class="lineno">1015</span> <span class="cp">#endif</span>
<a name="c1-1016"></a><span class="lineno">1016</span> 
<a name="c1-1017"></a><span class="lineno">1017</span>       <span class="cm">/* If we were run by sshd or we think we were run by rshd, execute</span>
<a name="c1-1018"></a><span class="lineno">1018</span> <span class="cm">   ~/.bashrc if we are a top-level shell. */</span>
<a name="c1-1019"></a><span class="lineno">1019</span>       <span class="k">if</span> <span class="p">((</span><span class="n">run_by_ssh</span> <span class="o">||</span> <span class="n">isnetconn</span> <span class="p">(</span><span class="n">fileno</span> <span class="p">(</span><span class="n">stdin</span><span class="p">)))</span> <span class="o">&amp;&amp;</span> <span class="n">shell_level</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
<a name="c1-1020"></a><span class="lineno">1020</span>  <span class="p">{</span>
<a name="c1-1021"></a><span class="lineno">1021</span> <span class="cp">#ifdef SYS_BASHRC</span>
<a name="c1-1022"></a><span class="lineno">1022</span> <span class="cp">#  if defined (__OPENNT)</span>
<a name="c1-1023"></a><span class="lineno">1023</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">_prefixInstallPath</span><span class="p">(</span><span class="n">SYS_BASHRC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1024"></a><span class="lineno">1024</span> <span class="cp">#  else</span>
<a name="c1-1025"></a><span class="lineno">1025</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">SYS_BASHRC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1026"></a><span class="lineno">1026</span> <span class="cp">#  endif</span>
<a name="c1-1027"></a><span class="lineno">1027</span> <span class="cp">#endif</span>
<a name="c1-1028"></a><span class="lineno">1028</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">bashrc_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1029"></a><span class="lineno">1029</span>    <span class="k">return</span><span class="p">;</span>
<a name="c1-1030"></a><span class="lineno">1030</span>  <span class="p">}</span>
<a name="c1-1031"></a><span class="lineno">1031</span>     <span class="p">}</span>
<a name="c1-1032"></a><span class="lineno">1032</span> 
<a name="c1-1033"></a><span class="lineno">1033</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-1034"></a><span class="lineno">1034</span>   <span class="cm">/* Startup files should be run without job control enabled. */</span>
<a name="c1-1035"></a><span class="lineno">1035</span>   <span class="n">old_job_control</span> <span class="o">=</span> <span class="n">interactive_shell</span> <span class="o">?</span> <span class="n">set_job_control</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1036"></a><span class="lineno">1036</span> <span class="cp">#endif</span>
<a name="c1-1037"></a><span class="lineno">1037</span> 
<a name="c1-1038"></a><span class="lineno">1038</span>   <span class="n">sourced_login</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1039"></a><span class="lineno">1039</span> 
<a name="c1-1040"></a><span class="lineno">1040</span>   <span class="cm">/* A shell begun with the --login (or -l) flag that is not in posix mode</span>
<a name="c1-1041"></a><span class="lineno">1041</span> <span class="cm">     runs the login shell startup files, no matter whether or not it is</span>
<a name="c1-1042"></a><span class="lineno">1042</span> <span class="cm">     interactive.  If NON_INTERACTIVE_LOGIN_SHELLS is defined, run the</span>
<a name="c1-1043"></a><span class="lineno">1043</span> <span class="cm">     startup files if argv[0][0] == '-' as well. */</span>
<a name="c1-1044"></a><span class="lineno">1044</span> <span class="cp">#if defined (NON_INTERACTIVE_LOGIN_SHELLS)</span>
<a name="c1-1045"></a><span class="lineno">1045</span>   <span class="k">if</span> <span class="p">(</span><span class="n">login_shell</span> <span class="o">&amp;&amp;</span> <span class="n">posixly_correct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1046"></a><span class="lineno">1046</span> <span class="cp">#else</span>
<a name="c1-1047"></a><span class="lineno">1047</span>   <span class="k">if</span> <span class="p">(</span><span class="n">login_shell</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">posixly_correct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1048"></a><span class="lineno">1048</span> <span class="cp">#endif</span>
<a name="c1-1049"></a><span class="lineno">1049</span>     <span class="p">{</span>
<a name="c1-1050"></a><span class="lineno">1050</span>       <span class="cm">/* We don't execute .bashrc for login shells. */</span>
<a name="c1-1051"></a><span class="lineno">1051</span>       <span class="n">no_rc</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1052"></a><span class="lineno">1052</span> 
<a name="c1-1053"></a><span class="lineno">1053</span>       <span class="cm">/* Execute /etc/profile and one of the personal login shell</span>
<a name="c1-1054"></a><span class="lineno">1054</span> <span class="cm">   initialization files. */</span>
<a name="c1-1055"></a><span class="lineno">1055</span>       <span class="k">if</span> <span class="p">(</span><span class="n">no_profile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1056"></a><span class="lineno">1056</span>  <span class="p">{</span>
<a name="c1-1057"></a><span class="lineno">1057</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">SYS_PROFILE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1058"></a><span class="lineno">1058</span> 
<a name="c1-1059"></a><span class="lineno">1059</span>    <span class="k">if</span> <span class="p">(</span><span class="n">act_like_sh</span><span class="p">)</span>  <span class="cm">/* sh */</span>
<a name="c1-1060"></a><span class="lineno">1060</span>      <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.profile"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1061"></a><span class="lineno">1061</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.bash_profile"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-1062"></a><span class="lineno">1062</span>       <span class="p">(</span><span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.bash_login"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>  <span class="cm">/* bash */</span>
<a name="c1-1063"></a><span class="lineno">1063</span>      <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.profile"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1064"></a><span class="lineno">1064</span>  <span class="p">}</span>
<a name="c1-1065"></a><span class="lineno">1065</span> 
<a name="c1-1066"></a><span class="lineno">1066</span>       <span class="n">sourced_login</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1067"></a><span class="lineno">1067</span>     <span class="p">}</span>
<a name="c1-1068"></a><span class="lineno">1068</span> 
<a name="c1-1069"></a><span class="lineno">1069</span>   <span class="cm">/* A non-interactive shell not named `sh' and not in posix mode reads and</span>
<a name="c1-1070"></a><span class="lineno">1070</span> <span class="cm">     executes commands from $BASH_ENV.  If `su' starts a shell with `-c cmd'</span>
<a name="c1-1071"></a><span class="lineno">1071</span> <span class="cm">     and `-su' as the name of the shell, we want to read the startup files.</span>
<a name="c1-1072"></a><span class="lineno">1072</span> <span class="cm">     No other non-interactive shells read any startup files. */</span>
<a name="c1-1073"></a><span class="lineno">1073</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">su_shell</span> <span class="o">&amp;&amp;</span> <span class="n">login_shell</span><span class="p">))</span>
<a name="c1-1074"></a><span class="lineno">1074</span>     <span class="p">{</span>
<a name="c1-1075"></a><span class="lineno">1075</span>       <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">act_like_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">privileged_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c1-1076"></a><span class="lineno">1076</span>      <span class="n">sourced_env</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1077"></a><span class="lineno">1077</span>  <span class="n">execute_env_file</span> <span class="p">(</span><span class="n">get_string_value</span> <span class="p">(</span><span class="s">"BASH_ENV"</span><span class="p">));</span>
<a name="c1-1078"></a><span class="lineno">1078</span>       <span class="k">return</span><span class="p">;</span>
<a name="c1-1079"></a><span class="lineno">1079</span>     <span class="p">}</span>
<a name="c1-1080"></a><span class="lineno">1080</span> 
<a name="c1-1081"></a><span class="lineno">1081</span>   <span class="cm">/* Interactive shell or `-su' shell. */</span>
<a name="c1-1082"></a><span class="lineno">1082</span>   <span class="k">if</span> <span class="p">(</span><span class="n">posixly_correct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>     <span class="cm">/* bash, sh */</span>
<a name="c1-1083"></a><span class="lineno">1083</span>     <span class="p">{</span>
<a name="c1-1084"></a><span class="lineno">1084</span>       <span class="k">if</span> <span class="p">(</span><span class="n">login_shell</span> <span class="o">&amp;&amp;</span> <span class="n">sourced_login</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1085"></a><span class="lineno">1085</span>  <span class="p">{</span>
<a name="c1-1086"></a><span class="lineno">1086</span>    <span class="cm">/* We don't execute .bashrc for login shells. */</span>
<a name="c1-1087"></a><span class="lineno">1087</span>    <span class="n">no_rc</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1088"></a><span class="lineno">1088</span> 
<a name="c1-1089"></a><span class="lineno">1089</span>    <span class="cm">/* Execute /etc/profile and one of the personal login shell</span>
<a name="c1-1090"></a><span class="lineno">1090</span> <span class="cm">       initialization files. */</span>
<a name="c1-1091"></a><span class="lineno">1091</span>    <span class="k">if</span> <span class="p">(</span><span class="n">no_profile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1092"></a><span class="lineno">1092</span>      <span class="p">{</span>
<a name="c1-1093"></a><span class="lineno">1093</span>        <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">SYS_PROFILE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1094"></a><span class="lineno">1094</span> 
<a name="c1-1095"></a><span class="lineno">1095</span>        <span class="k">if</span> <span class="p">(</span><span class="n">act_like_sh</span><span class="p">)</span>  <span class="cm">/* sh */</span>
<a name="c1-1096"></a><span class="lineno">1096</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.profile"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1097"></a><span class="lineno">1097</span>        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.bash_profile"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-1098"></a><span class="lineno">1098</span>           <span class="p">(</span><span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.bash_login"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>  <span class="cm">/* bash */</span>
<a name="c1-1099"></a><span class="lineno">1099</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="s">"~/.profile"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1100"></a><span class="lineno">1100</span>      <span class="p">}</span>
<a name="c1-1101"></a><span class="lineno">1101</span>  <span class="p">}</span>
<a name="c1-1102"></a><span class="lineno">1102</span> 
<a name="c1-1103"></a><span class="lineno">1103</span>       <span class="cm">/* bash */</span>
<a name="c1-1104"></a><span class="lineno">1104</span>       <span class="k">if</span> <span class="p">(</span><span class="n">act_like_sh</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">no_rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1105"></a><span class="lineno">1105</span>  <span class="p">{</span>
<a name="c1-1106"></a><span class="lineno">1106</span> <span class="cp">#ifdef SYS_BASHRC</span>
<a name="c1-1107"></a><span class="lineno">1107</span> <span class="cp">#  if defined (__OPENNT)</span>
<a name="c1-1108"></a><span class="lineno">1108</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">_prefixInstallPath</span><span class="p">(</span><span class="n">SYS_BASHRC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1109"></a><span class="lineno">1109</span> <span class="cp">#  else</span>
<a name="c1-1110"></a><span class="lineno">1110</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">SYS_BASHRC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1111"></a><span class="lineno">1111</span> <span class="cp">#  endif</span>
<a name="c1-1112"></a><span class="lineno">1112</span> <span class="cp">#endif</span>
<a name="c1-1113"></a><span class="lineno">1113</span>    <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">bashrc_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1114"></a><span class="lineno">1114</span>  <span class="p">}</span>
<a name="c1-1115"></a><span class="lineno">1115</span>       <span class="cm">/* sh */</span>
<a name="c1-1116"></a><span class="lineno">1116</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">act_like_sh</span> <span class="o">&amp;&amp;</span> <span class="n">privileged_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sourced_env</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1117"></a><span class="lineno">1117</span>  <span class="n">execute_env_file</span> <span class="p">(</span><span class="n">get_string_value</span> <span class="p">(</span><span class="s">"ENV"</span><span class="p">));</span>
<a name="c1-1118"></a><span class="lineno">1118</span>     <span class="p">}</span>
<a name="c1-1119"></a><span class="lineno">1119</span>   <span class="k">else</span>    <span class="cm">/* bash --posix, sh --posix */</span>
<a name="c1-1120"></a><span class="lineno">1120</span>     <span class="p">{</span>
<a name="c1-1121"></a><span class="lineno">1121</span>       <span class="cm">/* bash and sh */</span>
<a name="c1-1122"></a><span class="lineno">1122</span>       <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">&amp;&amp;</span> <span class="n">privileged_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sourced_env</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1123"></a><span class="lineno">1123</span>  <span class="n">execute_env_file</span> <span class="p">(</span><span class="n">get_string_value</span> <span class="p">(</span><span class="s">"ENV"</span><span class="p">));</span>
<a name="c1-1124"></a><span class="lineno">1124</span>     <span class="p">}</span>
<a name="c1-1125"></a><span class="lineno">1125</span> 
<a name="c1-1126"></a><span class="lineno">1126</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-1127"></a><span class="lineno">1127</span>   <span class="n">set_job_control</span> <span class="p">(</span><span class="n">old_job_control</span><span class="p">);</span>
<a name="c1-1128"></a><span class="lineno">1128</span> <span class="cp">#endif</span>
<a name="c1-1129"></a><span class="lineno">1129</span> <span class="p">}</span>
<a name="c1-1130"></a><span class="lineno">1130</span> 
<a name="c1-1131"></a><span class="lineno">1131</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-1132"></a><span class="lineno">1132</span> <span class="cm">/* Return 1 if the shell should be a restricted one based on NAME or the</span>
<a name="c1-1133"></a><span class="lineno">1133</span> <span class="cm">   value of `restricted'.  Don't actually do anything, just return a</span>
<a name="c1-1134"></a><span class="lineno">1134</span> <span class="cm">   boolean value. */</span>
<a name="c1-1135"></a><span class="lineno">1135</span> <span class="kt">int</span>
<a name="c1-1136"></a><span class="lineno">1136</span> <span class="n">shell_is_restricted</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a name="c1-1137"></a><span class="lineno">1137</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-1138"></a><span class="lineno">1138</span> <span class="p">{</span>
<a name="c1-1139"></a><span class="lineno">1139</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<a name="c1-1140"></a><span class="lineno">1140</span> 
<a name="c1-1141"></a><span class="lineno">1141</span>   <span class="k">if</span> <span class="p">(</span><span class="k">restricted</span><span class="p">)</span>
<a name="c1-1142"></a><span class="lineno">1142</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1143"></a><span class="lineno">1143</span>   <span class="n">temp</span> <span class="o">=</span> <span class="n">base_pathname</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c1-1144"></a><span class="lineno">1144</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">temp</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c1-1145"></a><span class="lineno">1145</span>     <span class="n">temp</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1146"></a><span class="lineno">1146</span>   <span class="k">return</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">RESTRICTED_SHELL_NAME</span><span class="p">));</span>
<a name="c1-1147"></a><span class="lineno">1147</span> <span class="p">}</span>
<a name="c1-1148"></a><span class="lineno">1148</span> 
<a name="c1-1149"></a><span class="lineno">1149</span> <span class="cm">/* Perhaps make this shell a `restricted' one, based on NAME.  If the</span>
<a name="c1-1150"></a><span class="lineno">1150</span> <span class="cm">   basename of NAME is "rbash", then this shell is restricted.  The</span>
<a name="c1-1151"></a><span class="lineno">1151</span> <span class="cm">   name of the restricted shell is a configurable option, see config.h.</span>
<a name="c1-1152"></a><span class="lineno">1152</span> <span class="cm">   In a restricted shell, PATH, SHELL, ENV, and BASH_ENV are read-only</span>
<a name="c1-1153"></a><span class="lineno">1153</span> <span class="cm">   and non-unsettable.</span>
<a name="c1-1154"></a><span class="lineno">1154</span> <span class="cm">   Do this also if `restricted' is already set to 1; maybe the shell was</span>
<a name="c1-1155"></a><span class="lineno">1155</span> <span class="cm">   started with -r. */</span>
<a name="c1-1156"></a><span class="lineno">1156</span> <span class="kt">int</span>
<a name="c1-1157"></a><span class="lineno">1157</span> <span class="n">maybe_make_restricted</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a name="c1-1158"></a><span class="lineno">1158</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-1159"></a><span class="lineno">1159</span> <span class="p">{</span>
<a name="c1-1160"></a><span class="lineno">1160</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
<a name="c1-1161"></a><span class="lineno">1161</span> 
<a name="c1-1162"></a><span class="lineno">1162</span>   <span class="n">temp</span> <span class="o">=</span> <span class="n">base_pathname</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c1-1163"></a><span class="lineno">1163</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">temp</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c1-1164"></a><span class="lineno">1164</span>     <span class="n">temp</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1165"></a><span class="lineno">1165</span>   <span class="k">if</span> <span class="p">(</span><span class="k">restricted</span> <span class="o">||</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">RESTRICTED_SHELL_NAME</span><span class="p">)))</span>
<a name="c1-1166"></a><span class="lineno">1166</span>     <span class="p">{</span>
<a name="c1-1167"></a><span class="lineno">1167</span>       <span class="n">set_var_read_only</span> <span class="p">(</span><span class="s">"PATH"</span><span class="p">);</span>
<a name="c1-1168"></a><span class="lineno">1168</span>       <span class="n">set_var_read_only</span> <span class="p">(</span><span class="s">"SHELL"</span><span class="p">);</span>
<a name="c1-1169"></a><span class="lineno">1169</span>       <span class="n">set_var_read_only</span> <span class="p">(</span><span class="s">"ENV"</span><span class="p">);</span>
<a name="c1-1170"></a><span class="lineno">1170</span>       <span class="n">set_var_read_only</span> <span class="p">(</span><span class="s">"BASH_ENV"</span><span class="p">);</span>
<a name="c1-1171"></a><span class="lineno">1171</span>       <span class="k">restricted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1172"></a><span class="lineno">1172</span>     <span class="p">}</span>
<a name="c1-1173"></a><span class="lineno">1173</span>   <span class="k">return</span> <span class="p">(</span><span class="k">restricted</span><span class="p">);</span>
<a name="c1-1174"></a><span class="lineno">1174</span> <span class="p">}</span>
<a name="c1-1175"></a><span class="lineno">1175</span> <span class="cp">#endif </span><span class="cm">/* RESTRICTED_SHELL */</span><span class="cp"></span>
<a name="c1-1176"></a><span class="lineno">1176</span> 
<a name="c1-1177"></a><span class="lineno">1177</span> <span class="cm">/* Fetch the current set of uids and gids and return 1 if we're running</span>
<a name="c1-1178"></a><span class="lineno">1178</span> <span class="cm">   setuid or setgid. */</span>
<a name="c1-1179"></a><span class="lineno">1179</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-1180"></a><span class="lineno">1180</span> <span class="n">uidget</span> <span class="p">()</span>
<a name="c1-1181"></a><span class="lineno">1181</span> <span class="p">{</span>
<a name="c1-1182"></a><span class="lineno">1182</span>   <span class="n">uid_t</span> <span class="n">u</span><span class="p">;</span>
<a name="c1-1183"></a><span class="lineno">1183</span> 
<a name="c1-1184"></a><span class="lineno">1184</span>   <span class="n">u</span> <span class="o">=</span> <span class="n">getuid</span> <span class="p">();</span>
<a name="c1-1185"></a><span class="lineno">1185</span>   <span class="k">if</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">uid</span> <span class="o">!=</span> <span class="n">u</span><span class="p">)</span>
<a name="c1-1186"></a><span class="lineno">1186</span>     <span class="p">{</span>
<a name="c1-1187"></a><span class="lineno">1187</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span><span class="p">);</span>
<a name="c1-1188"></a><span class="lineno">1188</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">shell</span><span class="p">);</span>
<a name="c1-1189"></a><span class="lineno">1189</span>       <span class="n">FREE</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">home_dir</span><span class="p">);</span>
<a name="c1-1190"></a><span class="lineno">1190</span>       <span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1191"></a><span class="lineno">1191</span>     <span class="p">}</span>
<a name="c1-1192"></a><span class="lineno">1192</span>   <span class="n">current_user</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
<a name="c1-1193"></a><span class="lineno">1193</span>   <span class="n">current_user</span><span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">getgid</span> <span class="p">();</span>
<a name="c1-1194"></a><span class="lineno">1194</span>   <span class="n">current_user</span><span class="p">.</span><span class="n">euid</span> <span class="o">=</span> <span class="n">geteuid</span> <span class="p">();</span>
<a name="c1-1195"></a><span class="lineno">1195</span>   <span class="n">current_user</span><span class="p">.</span><span class="n">egid</span> <span class="o">=</span> <span class="n">getegid</span> <span class="p">();</span>
<a name="c1-1196"></a><span class="lineno">1196</span> 
<a name="c1-1197"></a><span class="lineno">1197</span>   <span class="cm">/* See whether or not we are running setuid or setgid. */</span>
<a name="c1-1198"></a><span class="lineno">1198</span>   <span class="k">return</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">uid</span> <span class="o">!=</span> <span class="n">current_user</span><span class="p">.</span><span class="n">euid</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1199"></a><span class="lineno">1199</span>     <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">gid</span> <span class="o">!=</span> <span class="n">current_user</span><span class="p">.</span><span class="n">egid</span><span class="p">);</span>
<a name="c1-1200"></a><span class="lineno">1200</span> <span class="p">}</span>
<a name="c1-1201"></a><span class="lineno">1201</span> 
<a name="c1-1202"></a><span class="lineno">1202</span> <span class="kt">void</span>
<a name="c1-1203"></a><span class="lineno">1203</span> <span class="n">disable_priv_mode</span> <span class="p">()</span>
<a name="c1-1204"></a><span class="lineno">1204</span> <span class="p">{</span>
<a name="c1-1205"></a><span class="lineno">1205</span>   <span class="n">setuid</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">uid</span><span class="p">);</span>
<a name="c1-1206"></a><span class="lineno">1206</span>   <span class="n">setgid</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">gid</span><span class="p">);</span>
<a name="c1-1207"></a><span class="lineno">1207</span>   <span class="n">current_user</span><span class="p">.</span><span class="n">euid</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
<a name="c1-1208"></a><span class="lineno">1208</span>   <span class="n">current_user</span><span class="p">.</span><span class="n">egid</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="n">gid</span><span class="p">;</span>
<a name="c1-1209"></a><span class="lineno">1209</span> <span class="p">}</span>
<a name="c1-1210"></a><span class="lineno">1210</span> 
<a name="c1-1211"></a><span class="lineno">1211</span> <span class="cp">#if defined (WORDEXP_OPTION)</span>
<a name="c1-1212"></a><span class="lineno">1212</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-1213"></a><span class="lineno">1213</span> <span class="n">run_wordexp</span> <span class="p">(</span><span class="n">words</span><span class="p">)</span>
<a name="c1-1214"></a><span class="lineno">1214</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">words</span><span class="p">;</span>
<a name="c1-1215"></a><span class="lineno">1215</span> <span class="p">{</span>
<a name="c1-1216"></a><span class="lineno">1216</span>   <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nb</span><span class="p">;</span>
<a name="c1-1217"></a><span class="lineno">1217</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="o">*</span><span class="n">tl</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="c1-1218"></a><span class="lineno">1218</span> 
<a name="c1-1219"></a><span class="lineno">1219</span>   <span class="n">code</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">);</span>
<a name="c1-1220"></a><span class="lineno">1220</span> 
<a name="c1-1221"></a><span class="lineno">1221</span>   <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">NOT_JUMPED</span><span class="p">)</span>
<a name="c1-1222"></a><span class="lineno">1222</span>     <span class="p">{</span>
<a name="c1-1223"></a><span class="lineno">1223</span>       <span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a name="c1-1224"></a><span class="lineno">1224</span>  <span class="p">{</span>
<a name="c1-1225"></a><span class="lineno">1225</span>    <span class="cm">/* Some kind of throw to top_level has occured. */</span>
<a name="c1-1226"></a><span class="lineno">1226</span>  <span class="k">case</span> <span class="n">FORCE_EOF</span>:
<a name="c1-1227"></a><span class="lineno">1227</span>    <span class="k">return</span> <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<a name="c1-1228"></a><span class="lineno">1228</span>  <span class="k">case</span> <span class="n">ERREXIT</span>:
<a name="c1-1229"></a><span class="lineno">1229</span>  <span class="k">case</span> <span class="n">EXITPROG</span>:
<a name="c1-1230"></a><span class="lineno">1230</span>    <span class="k">return</span> <span class="n">last_command_exit_value</span><span class="p">;</span>
<a name="c1-1231"></a><span class="lineno">1231</span>  <span class="k">case</span> <span class="n">DISCARD</span>:
<a name="c1-1232"></a><span class="lineno">1232</span>    <span class="k">return</span> <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1233"></a><span class="lineno">1233</span>  <span class="nl">default:</span>
<a name="c1-1234"></a><span class="lineno">1234</span>    <span class="n">command_error</span> <span class="p">(</span><span class="s">"run_wordexp"</span><span class="p">,</span> <span class="n">CMDERR_BADJUMP</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1235"></a><span class="lineno">1235</span>  <span class="p">}</span>
<a name="c1-1236"></a><span class="lineno">1236</span>     <span class="p">}</span>
<a name="c1-1237"></a><span class="lineno">1237</span> 
<a name="c1-1238"></a><span class="lineno">1238</span>   <span class="cm">/* Run it through the parser to get a list of words and expand them */</span>
<a name="c1-1239"></a><span class="lineno">1239</span>   <span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">words</span><span class="p">)</span>
<a name="c1-1240"></a><span class="lineno">1240</span>     <span class="p">{</span>
<a name="c1-1241"></a><span class="lineno">1241</span>       <span class="n">with_input_from_string</span> <span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="s">"--wordexp"</span><span class="p">);</span>
<a name="c1-1242"></a><span class="lineno">1242</span>       <span class="k">if</span> <span class="p">(</span><span class="n">parse_command</span> <span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1243"></a><span class="lineno">1243</span>  <span class="k">return</span> <span class="p">(</span><span class="mi">126</span><span class="p">);</span>
<a name="c1-1244"></a><span class="lineno">1244</span>       <span class="k">if</span> <span class="p">(</span><span class="n">global_command</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1245"></a><span class="lineno">1245</span>  <span class="p">{</span>
<a name="c1-1246"></a><span class="lineno">1246</span>    <span class="n">printf</span> <span class="p">(</span><span class="s">"0</span><span class="se">\n</span><span class="s">0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-1247"></a><span class="lineno">1247</span>    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1248"></a><span class="lineno">1248</span>  <span class="p">}</span>
<a name="c1-1249"></a><span class="lineno">1249</span>       <span class="k">if</span> <span class="p">(</span><span class="n">global_command</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">cm_simple</span><span class="p">)</span>
<a name="c1-1250"></a><span class="lineno">1250</span>  <span class="k">return</span> <span class="p">(</span><span class="mi">126</span><span class="p">);</span>
<a name="c1-1251"></a><span class="lineno">1251</span>       <span class="n">wl</span> <span class="o">=</span> <span class="n">global_command</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">;</span>
<a name="c1-1252"></a><span class="lineno">1252</span>       <span class="k">if</span> <span class="p">(</span><span class="n">protected_mode</span><span class="p">)</span>
<a name="c1-1253"></a><span class="lineno">1253</span>  <span class="k">for</span> <span class="p">(</span><span class="n">tl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span> <span class="n">tl</span><span class="p">;</span> <span class="n">tl</span> <span class="o">=</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-1254"></a><span class="lineno">1254</span>    <span class="n">tl</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">W_NOCOMSUB</span><span class="o">|</span><span class="n">W_NOPROCSUB</span><span class="p">;</span>
<a name="c1-1255"></a><span class="lineno">1255</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">wl</span> <span class="o">?</span> <span class="n">expand_words_no_vars</span> <span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<a name="c1-1256"></a><span class="lineno">1256</span>     <span class="p">}</span>
<a name="c1-1257"></a><span class="lineno">1257</span>   <span class="k">else</span>
<a name="c1-1258"></a><span class="lineno">1258</span>     <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<a name="c1-1259"></a><span class="lineno">1259</span> 
<a name="c1-1260"></a><span class="lineno">1260</span>   <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1261"></a><span class="lineno">1261</span> 
<a name="c1-1262"></a><span class="lineno">1262</span>   <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1263"></a><span class="lineno">1263</span>     <span class="p">{</span>
<a name="c1-1264"></a><span class="lineno">1264</span>       <span class="n">printf</span> <span class="p">(</span><span class="s">"0</span><span class="se">\n</span><span class="s">0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-1265"></a><span class="lineno">1265</span>       <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1266"></a><span class="lineno">1266</span>     <span class="p">}</span>
<a name="c1-1267"></a><span class="lineno">1267</span> 
<a name="c1-1268"></a><span class="lineno">1268</span>   <span class="cm">/* Count up the number of words and bytes, and print them.  Don't count</span>
<a name="c1-1269"></a><span class="lineno">1269</span> <span class="cm">     the trailing NUL byte. */</span>
<a name="c1-1270"></a><span class="lineno">1270</span>   <span class="k">for</span> <span class="p">(</span><span class="n">nw</span> <span class="o">=</span> <span class="n">nb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">wl</span><span class="p">;</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-1271"></a><span class="lineno">1271</span>     <span class="p">{</span>
<a name="c1-1272"></a><span class="lineno">1272</span>       <span class="n">nw</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1273"></a><span class="lineno">1273</span>       <span class="n">nb</span> <span class="o">+=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c1-1274"></a><span class="lineno">1274</span>     <span class="p">}</span>
<a name="c1-1275"></a><span class="lineno">1275</span>   <span class="n">printf</span> <span class="p">(</span><span class="s">"%u</span><span class="se">\n</span><span class="s">%u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<a name="c1-1276"></a><span class="lineno">1276</span>   <span class="cm">/* Print each word on a separate line.  This will have to be changed when</span>
<a name="c1-1277"></a><span class="lineno">1277</span> <span class="cm">     the interface to glibc is completed. */</span>
<a name="c1-1278"></a><span class="lineno">1278</span>   <span class="k">for</span> <span class="p">(</span><span class="n">wl</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> <span class="n">wl</span><span class="p">;</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-1279"></a><span class="lineno">1279</span>     <span class="n">printf</span> <span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c1-1280"></a><span class="lineno">1280</span> 
<a name="c1-1281"></a><span class="lineno">1281</span>   <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1282"></a><span class="lineno">1282</span> <span class="p">}</span>
<a name="c1-1283"></a><span class="lineno">1283</span> <span class="cp">#endif</span>
<a name="c1-1284"></a><span class="lineno">1284</span> 
<a name="c1-1285"></a><span class="lineno">1285</span> <span class="cp">#if defined (ONESHOT)</span>
<a name="c1-1286"></a><span class="lineno">1286</span> <span class="cm">/* Run one command, given as the argument to the -c option.  Tell</span>
<a name="c1-1287"></a><span class="lineno">1287</span> <span class="cm">   parse_and_execute not to fork for a simple command. */</span>
<a name="c1-1288"></a><span class="lineno">1288</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-1289"></a><span class="lineno">1289</span> <span class="n">run_one_command</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a name="c1-1290"></a><span class="lineno">1290</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
<a name="c1-1291"></a><span class="lineno">1291</span> <span class="p">{</span>
<a name="c1-1292"></a><span class="lineno">1292</span>   <span class="kt">int</span> <span class="n">code</span><span class="p">;</span>
<a name="c1-1293"></a><span class="lineno">1293</span> 
<a name="c1-1294"></a><span class="lineno">1294</span>   <span class="n">code</span> <span class="o">=</span> <span class="n">setjmp</span> <span class="p">(</span><span class="n">top_level</span><span class="p">);</span>
<a name="c1-1295"></a><span class="lineno">1295</span> 
<a name="c1-1296"></a><span class="lineno">1296</span>   <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">NOT_JUMPED</span><span class="p">)</span>
<a name="c1-1297"></a><span class="lineno">1297</span>     <span class="p">{</span>
<a name="c1-1298"></a><span class="lineno">1298</span> <span class="cp">#if defined (PROCESS_SUBSTITUTION)</span>
<a name="c1-1299"></a><span class="lineno">1299</span>       <span class="n">unlink_fifo_list</span> <span class="p">();</span>
<a name="c1-1300"></a><span class="lineno">1300</span> <span class="cp">#endif </span><span class="cm">/* PROCESS_SUBSTITUTION */</span><span class="cp"></span>
<a name="c1-1301"></a><span class="lineno">1301</span>       <span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a name="c1-1302"></a><span class="lineno">1302</span>  <span class="p">{</span>
<a name="c1-1303"></a><span class="lineno">1303</span>    <span class="cm">/* Some kind of throw to top_level has occured. */</span>
<a name="c1-1304"></a><span class="lineno">1304</span>  <span class="k">case</span> <span class="n">FORCE_EOF</span>:
<a name="c1-1305"></a><span class="lineno">1305</span>    <span class="k">return</span> <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<a name="c1-1306"></a><span class="lineno">1306</span>  <span class="k">case</span> <span class="n">ERREXIT</span>:
<a name="c1-1307"></a><span class="lineno">1307</span>  <span class="k">case</span> <span class="n">EXITPROG</span>:
<a name="c1-1308"></a><span class="lineno">1308</span>    <span class="k">return</span> <span class="n">last_command_exit_value</span><span class="p">;</span>
<a name="c1-1309"></a><span class="lineno">1309</span>  <span class="k">case</span> <span class="n">DISCARD</span>:
<a name="c1-1310"></a><span class="lineno">1310</span>    <span class="k">return</span> <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1311"></a><span class="lineno">1311</span>  <span class="nl">default:</span>
<a name="c1-1312"></a><span class="lineno">1312</span>    <span class="n">command_error</span> <span class="p">(</span><span class="s">"run_one_command"</span><span class="p">,</span> <span class="n">CMDERR_BADJUMP</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1313"></a><span class="lineno">1313</span>  <span class="p">}</span>
<a name="c1-1314"></a><span class="lineno">1314</span>     <span class="p">}</span>
<a name="c1-1315"></a><span class="lineno">1315</span>    <span class="k">return</span> <span class="p">(</span><span class="n">parse_and_execute</span> <span class="p">(</span><span class="n">savestring</span> <span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="s">"-c"</span><span class="p">,</span> <span class="n">SEVAL_NOHIST</span><span class="p">));</span>
<a name="c1-1316"></a><span class="lineno">1316</span> <span class="p">}</span>
<a name="c1-1317"></a><span class="lineno">1317</span> <span class="cp">#endif </span><span class="cm">/* ONESHOT */</span><span class="cp"></span>
<a name="c1-1318"></a><span class="lineno">1318</span> 
<a name="c1-1319"></a><span class="lineno">1319</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-1320"></a><span class="lineno">1320</span> <span class="n">bind_args</span> <span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">arg_end</span><span class="p">,</span> <span class="n">start_index</span><span class="p">)</span>
<a name="c1-1321"></a><span class="lineno">1321</span>      <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
<a name="c1-1322"></a><span class="lineno">1322</span>      <span class="kt">int</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">arg_end</span><span class="p">,</span> <span class="n">start_index</span><span class="p">;</span>
<a name="c1-1323"></a><span class="lineno">1323</span> <span class="p">{</span>
<a name="c1-1324"></a><span class="lineno">1324</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1325"></a><span class="lineno">1325</span>   <span class="n">WORD_LIST</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
<a name="c1-1326"></a><span class="lineno">1326</span> 
<a name="c1-1327"></a><span class="lineno">1327</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">arg_start</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arg_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1328"></a><span class="lineno">1328</span>     <span class="n">args</span> <span class="o">=</span> <span class="n">make_word_list</span> <span class="p">(</span><span class="n">make_word</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">args</span><span class="p">);</span>
<a name="c1-1329"></a><span class="lineno">1329</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a name="c1-1330"></a><span class="lineno">1330</span>     <span class="p">{</span>
<a name="c1-1331"></a><span class="lineno">1331</span>       <span class="n">args</span> <span class="o">=</span> <span class="n">REVERSE_LIST</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">);</span>
<a name="c1-1332"></a><span class="lineno">1332</span>       <span class="k">if</span> <span class="p">(</span><span class="n">start_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* bind to $0...$n for sh -c command */</span>
<a name="c1-1333"></a><span class="lineno">1333</span>  <span class="p">{</span>
<a name="c1-1334"></a><span class="lineno">1334</span>    <span class="cm">/* Posix.2 4.56.3 says that the first argument after sh -c command</span>
<a name="c1-1335"></a><span class="lineno">1335</span> <span class="cm">       becomes $0, and the rest of the arguments become $1...$n */</span>
<a name="c1-1336"></a><span class="lineno">1336</span>    <span class="n">shell_name</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c1-1337"></a><span class="lineno">1337</span>    <span class="n">FREE</span> <span class="p">(</span><span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-1338"></a><span class="lineno">1338</span>    <span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">word</span><span class="o">-&gt;</span><span class="n">word</span><span class="p">);</span>
<a name="c1-1339"></a><span class="lineno">1339</span>    <span class="n">remember_args</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1340"></a><span class="lineno">1340</span>    <span class="n">push_args</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>  <span class="cm">/* BASH_ARGV and BASH_ARGC */</span>
<a name="c1-1341"></a><span class="lineno">1341</span>  <span class="p">}</span>
<a name="c1-1342"></a><span class="lineno">1342</span>       <span class="k">else</span>      <span class="cm">/* bind to $1...$n for shell script */</span>
<a name="c1-1343"></a><span class="lineno">1343</span>         <span class="p">{</span>
<a name="c1-1344"></a><span class="lineno">1344</span>    <span class="n">remember_args</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1345"></a><span class="lineno">1345</span>    <span class="n">push_args</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>   <span class="cm">/* BASH_ARGV and BASH_ARGC */</span>
<a name="c1-1346"></a><span class="lineno">1346</span>         <span class="p">}</span>
<a name="c1-1347"></a><span class="lineno">1347</span> 
<a name="c1-1348"></a><span class="lineno">1348</span>       <span class="n">dispose_words</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
<a name="c1-1349"></a><span class="lineno">1349</span>     <span class="p">}</span>
<a name="c1-1350"></a><span class="lineno">1350</span> 
<a name="c1-1351"></a><span class="lineno">1351</span>   <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a name="c1-1352"></a><span class="lineno">1352</span> <span class="p">}</span>
<a name="c1-1353"></a><span class="lineno">1353</span> 
<a name="c1-1354"></a><span class="lineno">1354</span> <span class="kt">void</span>
<a name="c1-1355"></a><span class="lineno">1355</span> <span class="n">unbind_args</span> <span class="p">()</span>
<a name="c1-1356"></a><span class="lineno">1356</span> <span class="p">{</span>
<a name="c1-1357"></a><span class="lineno">1357</span>   <span class="n">remember_args</span> <span class="p">((</span><span class="n">WORD_LIST</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1358"></a><span class="lineno">1358</span>   <span class="n">pop_args</span> <span class="p">();</span>       <span class="cm">/* Reset BASH_ARGV and BASH_ARGC */</span>
<a name="c1-1359"></a><span class="lineno">1359</span> <span class="p">}</span>
<a name="c1-1360"></a><span class="lineno">1360</span> 
<a name="c1-1361"></a><span class="lineno">1361</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1362"></a><span class="lineno">1362</span> <span class="n">start_debugger</span> <span class="p">()</span>
<a name="c1-1363"></a><span class="lineno">1363</span> <span class="p">{</span>
<a name="c1-1364"></a><span class="lineno">1364</span> <span class="cp">#if defined (DEBUGGER) &amp;&amp; defined (DEBUGGER_START_FILE)</span>
<a name="c1-1365"></a><span class="lineno">1365</span>   <span class="kt">int</span> <span class="n">old_errexit</span><span class="p">;</span>
<a name="c1-1366"></a><span class="lineno">1366</span> 
<a name="c1-1367"></a><span class="lineno">1367</span>   <span class="n">old_errexit</span> <span class="o">=</span> <span class="n">exit_immediately_on_error</span><span class="p">;</span>
<a name="c1-1368"></a><span class="lineno">1368</span>   <span class="n">exit_immediately_on_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1369"></a><span class="lineno">1369</span> 
<a name="c1-1370"></a><span class="lineno">1370</span>   <span class="n">maybe_execute_file</span> <span class="p">(</span><span class="n">DEBUGGER_START_FILE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1371"></a><span class="lineno">1371</span>   <span class="n">function_trace_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1372"></a><span class="lineno">1372</span> 
<a name="c1-1373"></a><span class="lineno">1373</span>   <span class="n">exit_immediately_on_error</span> <span class="o">+=</span> <span class="n">old_errexit</span><span class="p">;</span>
<a name="c1-1374"></a><span class="lineno">1374</span> <span class="cp">#endif</span>
<a name="c1-1375"></a><span class="lineno">1375</span> <span class="p">}</span>
<a name="c1-1376"></a><span class="lineno">1376</span> 
<a name="c1-1377"></a><span class="lineno">1377</span> <span class="k">static</span> <span class="kt">int</span>
<a name="c1-1378"></a><span class="lineno">1378</span> <span class="n">open_shell_script</span> <span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
<a name="c1-1379"></a><span class="lineno">1379</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">script_name</span><span class="p">;</span>
<a name="c1-1380"></a><span class="lineno">1380</span> <span class="p">{</span>
<a name="c1-1381"></a><span class="lineno">1381</span>   <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">fd_is_tty</span><span class="p">;</span>
<a name="c1-1382"></a><span class="lineno">1382</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">path_filename</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
<a name="c1-1383"></a><span class="lineno">1383</span>   <span class="kt">char</span> <span class="n">sample</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
<a name="c1-1384"></a><span class="lineno">1384</span>   <span class="kt">int</span> <span class="n">sample_len</span><span class="p">;</span>
<a name="c1-1385"></a><span class="lineno">1385</span>   <span class="k">struct</span> <span class="n">stat</span> <span class="n">sb</span><span class="p">;</span>
<a name="c1-1386"></a><span class="lineno">1386</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c1-1387"></a><span class="lineno">1387</span>   <span class="n">SHELL_VAR</span> <span class="o">*</span><span class="n">funcname_v</span><span class="p">,</span> <span class="o">*</span><span class="n">bash_source_v</span><span class="p">,</span> <span class="o">*</span><span class="n">bash_lineno_v</span><span class="p">;</span>
<a name="c1-1388"></a><span class="lineno">1388</span>   <span class="n">ARRAY</span> <span class="o">*</span><span class="n">funcname_a</span><span class="p">,</span> <span class="o">*</span><span class="n">bash_source_a</span><span class="p">,</span> <span class="o">*</span><span class="n">bash_lineno_a</span><span class="p">;</span>
<a name="c1-1389"></a><span class="lineno">1389</span> <span class="cp">#endif</span>
<a name="c1-1390"></a><span class="lineno">1390</span> 
<a name="c1-1391"></a><span class="lineno">1391</span>   <span class="n">filename</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">script_name</span><span class="p">);</span>
<a name="c1-1392"></a><span class="lineno">1392</span> 
<a name="c1-1393"></a><span class="lineno">1393</span>   <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<a name="c1-1394"></a><span class="lineno">1394</span>   <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">absolute_program</span> <span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a name="c1-1395"></a><span class="lineno">1395</span>     <span class="p">{</span>
<a name="c1-1396"></a><span class="lineno">1396</span>       <span class="n">e</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-1397"></a><span class="lineno">1397</span>       <span class="cm">/* If it's not in the current directory, try looking through PATH</span>
<a name="c1-1398"></a><span class="lineno">1398</span> <span class="cm">   for it. */</span>
<a name="c1-1399"></a><span class="lineno">1399</span>       <span class="n">path_filename</span> <span class="o">=</span> <span class="n">find_path_file</span> <span class="p">(</span><span class="n">script_name</span><span class="p">);</span>
<a name="c1-1400"></a><span class="lineno">1400</span>       <span class="k">if</span> <span class="p">(</span><span class="n">path_filename</span><span class="p">)</span>
<a name="c1-1401"></a><span class="lineno">1401</span>  <span class="p">{</span>
<a name="c1-1402"></a><span class="lineno">1402</span>    <span class="n">free</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1403"></a><span class="lineno">1403</span>    <span class="n">filename</span> <span class="o">=</span> <span class="n">path_filename</span><span class="p">;</span>
<a name="c1-1404"></a><span class="lineno">1404</span>    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<a name="c1-1405"></a><span class="lineno">1405</span>  <span class="p">}</span>
<a name="c1-1406"></a><span class="lineno">1406</span>       <span class="k">else</span>
<a name="c1-1407"></a><span class="lineno">1407</span>  <span class="n">errno</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
<a name="c1-1408"></a><span class="lineno">1408</span>     <span class="p">}</span>
<a name="c1-1409"></a><span class="lineno">1409</span> 
<a name="c1-1410"></a><span class="lineno">1410</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1411"></a><span class="lineno">1411</span>     <span class="p">{</span>
<a name="c1-1412"></a><span class="lineno">1412</span>       <span class="n">e</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-1413"></a><span class="lineno">1413</span>       <span class="n">file_error</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1414"></a><span class="lineno">1414</span>       <span class="n">exit</span> <span class="p">((</span><span class="n">e</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="o">?</span> <span class="n">EX_NOTFOUND</span> <span class="o">:</span> <span class="n">EX_NOINPUT</span><span class="p">);</span>
<a name="c1-1415"></a><span class="lineno">1415</span>     <span class="p">}</span>
<a name="c1-1416"></a><span class="lineno">1416</span> 
<a name="c1-1417"></a><span class="lineno">1417</span>   <span class="n">free</span> <span class="p">(</span><span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-1418"></a><span class="lineno">1418</span>   <span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_argv0</span> <span class="o">?</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">exec_argv0</span><span class="p">)</span> <span class="o">:</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">script_name</span><span class="p">);</span>
<a name="c1-1419"></a><span class="lineno">1419</span>   <span class="k">if</span> <span class="p">(</span><span class="n">exec_argv0</span><span class="p">)</span>
<a name="c1-1420"></a><span class="lineno">1420</span>     <span class="p">{</span>
<a name="c1-1421"></a><span class="lineno">1421</span>       <span class="n">free</span> <span class="p">(</span><span class="n">exec_argv0</span><span class="p">);</span>
<a name="c1-1422"></a><span class="lineno">1422</span>       <span class="n">exec_argv0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1423"></a><span class="lineno">1423</span>     <span class="p">}</span>
<a name="c1-1424"></a><span class="lineno">1424</span> 
<a name="c1-1425"></a><span class="lineno">1425</span> <span class="cp">#if defined (ARRAY_VARS)</span>
<a name="c1-1426"></a><span class="lineno">1426</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"FUNCNAME"</span><span class="p">,</span> <span class="n">funcname_v</span><span class="p">,</span> <span class="n">funcname_a</span><span class="p">);</span>
<a name="c1-1427"></a><span class="lineno">1427</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"BASH_SOURCE"</span><span class="p">,</span> <span class="n">bash_source_v</span><span class="p">,</span> <span class="n">bash_source_a</span><span class="p">);</span>
<a name="c1-1428"></a><span class="lineno">1428</span>   <span class="n">GET_ARRAY_FROM_VAR</span> <span class="p">(</span><span class="s">"BASH_LINENO"</span><span class="p">,</span> <span class="n">bash_lineno_v</span><span class="p">,</span> <span class="n">bash_lineno_a</span><span class="p">);</span>
<a name="c1-1429"></a><span class="lineno">1429</span> 
<a name="c1-1430"></a><span class="lineno">1430</span>   <span class="n">array_push</span> <span class="p">(</span><span class="n">bash_source_a</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
<a name="c1-1431"></a><span class="lineno">1431</span>   <span class="k">if</span> <span class="p">(</span><span class="n">bash_lineno_a</span><span class="p">)</span>
<a name="c1-1432"></a><span class="lineno">1432</span>     <span class="p">{</span>
<a name="c1-1433"></a><span class="lineno">1433</span>       <span class="n">t</span> <span class="o">=</span> <span class="n">itos</span> <span class="p">(</span><span class="n">executing_line_number</span> <span class="p">());</span>
<a name="c1-1434"></a><span class="lineno">1434</span>       <span class="n">array_push</span> <span class="p">(</span><span class="n">bash_lineno_a</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<a name="c1-1435"></a><span class="lineno">1435</span>       <span class="n">free</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
<a name="c1-1436"></a><span class="lineno">1436</span>     <span class="p">}</span>
<a name="c1-1437"></a><span class="lineno">1437</span>   <span class="n">array_push</span> <span class="p">(</span><span class="n">funcname_a</span><span class="p">,</span> <span class="s">"main"</span><span class="p">);</span>
<a name="c1-1438"></a><span class="lineno">1438</span> <span class="cp">#endif</span>
<a name="c1-1439"></a><span class="lineno">1439</span> 
<a name="c1-1440"></a><span class="lineno">1440</span> <span class="cp">#ifdef HAVE_DEV_FD</span>
<a name="c1-1441"></a><span class="lineno">1441</span>   <span class="n">fd_is_tty</span> <span class="o">=</span> <span class="n">isatty</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c1-1442"></a><span class="lineno">1442</span> <span class="cp">#else</span>
<a name="c1-1443"></a><span class="lineno">1443</span>   <span class="n">fd_is_tty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1444"></a><span class="lineno">1444</span> <span class="cp">#endif</span>
<a name="c1-1445"></a><span class="lineno">1445</span> 
<a name="c1-1446"></a><span class="lineno">1446</span>   <span class="cm">/* Only do this with non-tty file descriptors we can seek on. */</span>
<a name="c1-1447"></a><span class="lineno">1447</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fd_is_tty</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lseek</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a name="c1-1448"></a><span class="lineno">1448</span>     <span class="p">{</span>
<a name="c1-1449"></a><span class="lineno">1449</span>       <span class="cm">/* Check to see if the `file' in `bash file' is a binary file</span>
<a name="c1-1450"></a><span class="lineno">1450</span> <span class="cm">   according to the same tests done by execute_simple_command (),</span>
<a name="c1-1451"></a><span class="lineno">1451</span> <span class="cm">   and report an error and exit if it is. */</span>
<a name="c1-1452"></a><span class="lineno">1452</span>       <span class="n">sample_len</span> <span class="o">=</span> <span class="n">read</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sample</span><span class="p">));</span>
<a name="c1-1453"></a><span class="lineno">1453</span>       <span class="k">if</span> <span class="p">(</span><span class="n">sample_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1454"></a><span class="lineno">1454</span>  <span class="p">{</span>
<a name="c1-1455"></a><span class="lineno">1455</span>    <span class="n">e</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<a name="c1-1456"></a><span class="lineno">1456</span>    <span class="k">if</span> <span class="p">((</span><span class="n">fstat</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">S_ISDIR</span> <span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
<a name="c1-1457"></a><span class="lineno">1457</span>      <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: is a directory"</span><span class="p">),</span> <span class="n">filename</span><span class="p">);</span>
<a name="c1-1458"></a><span class="lineno">1458</span>    <span class="k">else</span>
<a name="c1-1459"></a><span class="lineno">1459</span>      <span class="p">{</span>
<a name="c1-1460"></a><span class="lineno">1460</span>        <span class="n">errno</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
<a name="c1-1461"></a><span class="lineno">1461</span>        <span class="n">file_error</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1462"></a><span class="lineno">1462</span>      <span class="p">}</span>
<a name="c1-1463"></a><span class="lineno">1463</span>    <span class="n">exit</span> <span class="p">(</span><span class="n">EX_NOEXEC</span><span class="p">);</span>
<a name="c1-1464"></a><span class="lineno">1464</span>  <span class="p">}</span>
<a name="c1-1465"></a><span class="lineno">1465</span>       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sample_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">check_binary_file</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample_len</span><span class="p">)))</span>
<a name="c1-1466"></a><span class="lineno">1466</span>  <span class="p">{</span>
<a name="c1-1467"></a><span class="lineno">1467</span>    <span class="n">internal_error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s: cannot execute binary file"</span><span class="p">),</span> <span class="n">filename</span><span class="p">);</span>
<a name="c1-1468"></a><span class="lineno">1468</span>    <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BINARY_FILE</span><span class="p">);</span>
<a name="c1-1469"></a><span class="lineno">1469</span>  <span class="p">}</span>
<a name="c1-1470"></a><span class="lineno">1470</span>       <span class="cm">/* Now rewind the file back to the beginning. */</span>
<a name="c1-1471"></a><span class="lineno">1471</span>       <span class="n">lseek</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1472"></a><span class="lineno">1472</span>     <span class="p">}</span>
<a name="c1-1473"></a><span class="lineno">1473</span> 
<a name="c1-1474"></a><span class="lineno">1474</span>   <span class="cm">/* Open the script.  But try to move the file descriptor to a randomly</span>
<a name="c1-1475"></a><span class="lineno">1475</span> <span class="cm">     large one, in the hopes that any descriptors used by the script will</span>
<a name="c1-1476"></a><span class="lineno">1476</span> <span class="cm">     not match with ours. */</span>
<a name="c1-1477"></a><span class="lineno">1477</span>   <span class="n">fd</span> <span class="o">=</span> <span class="n">move_to_high_fd</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="c1-1478"></a><span class="lineno">1478</span> 
<a name="c1-1479"></a><span class="lineno">1479</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-1480"></a><span class="lineno">1480</span>   <span class="n">default_buffered_input</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
<a name="c1-1481"></a><span class="lineno">1481</span>   <span class="n">SET_CLOSE_ON_EXEC</span> <span class="p">(</span><span class="n">default_buffered_input</span><span class="p">);</span>
<a name="c1-1482"></a><span class="lineno">1482</span> <span class="cp">#else </span><span class="cm">/* !BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-1483"></a><span class="lineno">1483</span>   <span class="n">default_input</span> <span class="o">=</span> <span class="n">fdopen</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
<a name="c1-1484"></a><span class="lineno">1484</span> 
<a name="c1-1485"></a><span class="lineno">1485</span>   <span class="k">if</span> <span class="p">(</span><span class="n">default_input</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1486"></a><span class="lineno">1486</span>     <span class="p">{</span>
<a name="c1-1487"></a><span class="lineno">1487</span>       <span class="n">file_error</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1488"></a><span class="lineno">1488</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">EX_NOTFOUND</span><span class="p">);</span>
<a name="c1-1489"></a><span class="lineno">1489</span>     <span class="p">}</span>
<a name="c1-1490"></a><span class="lineno">1490</span> 
<a name="c1-1491"></a><span class="lineno">1491</span>   <span class="n">SET_CLOSE_ON_EXEC</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c1-1492"></a><span class="lineno">1492</span>   <span class="k">if</span> <span class="p">(</span><span class="n">fileno</span> <span class="p">(</span><span class="n">default_input</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fd</span><span class="p">)</span>
<a name="c1-1493"></a><span class="lineno">1493</span>     <span class="n">SET_CLOSE_ON_EXEC</span> <span class="p">(</span><span class="n">fileno</span> <span class="p">(</span><span class="n">default_input</span><span class="p">));</span>
<a name="c1-1494"></a><span class="lineno">1494</span> <span class="cp">#endif </span><span class="cm">/* !BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-1495"></a><span class="lineno">1495</span> 
<a name="c1-1496"></a><span class="lineno">1496</span>   <span class="cm">/* Just about the only way for this code to be executed is if something</span>
<a name="c1-1497"></a><span class="lineno">1497</span> <span class="cm">     like `bash -i /dev/stdin' is executed. */</span>
<a name="c1-1498"></a><span class="lineno">1498</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span> <span class="o">&amp;&amp;</span> <span class="n">fd_is_tty</span><span class="p">)</span>
<a name="c1-1499"></a><span class="lineno">1499</span>     <span class="p">{</span>
<a name="c1-1500"></a><span class="lineno">1500</span>       <span class="n">dup2</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1501"></a><span class="lineno">1501</span>       <span class="n">close</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c1-1502"></a><span class="lineno">1502</span>       <span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1503"></a><span class="lineno">1503</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-1504"></a><span class="lineno">1504</span>       <span class="n">default_buffered_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1505"></a><span class="lineno">1505</span> <span class="cp">#else</span>
<a name="c1-1506"></a><span class="lineno">1506</span>       <span class="n">fclose</span> <span class="p">(</span><span class="n">default_input</span><span class="p">);</span>
<a name="c1-1507"></a><span class="lineno">1507</span>       <span class="n">default_input</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">;</span>
<a name="c1-1508"></a><span class="lineno">1508</span> <span class="cp">#endif</span>
<a name="c1-1509"></a><span class="lineno">1509</span>     <span class="p">}</span>
<a name="c1-1510"></a><span class="lineno">1510</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">forced_interactive</span> <span class="o">&amp;&amp;</span> <span class="n">fd_is_tty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1511"></a><span class="lineno">1511</span>     <span class="cm">/* But if a script is called with something like `bash -i scriptname',</span>
<a name="c1-1512"></a><span class="lineno">1512</span> <span class="cm">       we need to do a non-interactive setup here, since we didn't do it</span>
<a name="c1-1513"></a><span class="lineno">1513</span> <span class="cm">       before. */</span>
<a name="c1-1514"></a><span class="lineno">1514</span>     <span class="n">init_interactive_script</span> <span class="p">();</span>
<a name="c1-1515"></a><span class="lineno">1515</span> 
<a name="c1-1516"></a><span class="lineno">1516</span>   <span class="n">free</span> <span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<a name="c1-1517"></a><span class="lineno">1517</span>   <span class="k">return</span> <span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c1-1518"></a><span class="lineno">1518</span> <span class="p">}</span>
<a name="c1-1519"></a><span class="lineno">1519</span> 
<a name="c1-1520"></a><span class="lineno">1520</span> <span class="cm">/* Initialize the input routines for the parser. */</span>
<a name="c1-1521"></a><span class="lineno">1521</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1522"></a><span class="lineno">1522</span> <span class="n">set_bash_input</span> <span class="p">()</span>
<a name="c1-1523"></a><span class="lineno">1523</span> <span class="p">{</span>
<a name="c1-1524"></a><span class="lineno">1524</span>   <span class="cm">/* Make sure the fd from which we are reading input is not in</span>
<a name="c1-1525"></a><span class="lineno">1525</span> <span class="cm">     no-delay mode. */</span>
<a name="c1-1526"></a><span class="lineno">1526</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-1527"></a><span class="lineno">1527</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1528"></a><span class="lineno">1528</span>     <span class="n">sh_unset_nodelay_mode</span> <span class="p">(</span><span class="n">default_buffered_input</span><span class="p">);</span>
<a name="c1-1529"></a><span class="lineno">1529</span>   <span class="k">else</span>
<a name="c1-1530"></a><span class="lineno">1530</span> <span class="cp">#endif </span><span class="cm">/* !BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-1531"></a><span class="lineno">1531</span>     <span class="n">sh_unset_nodelay_mode</span> <span class="p">(</span><span class="n">fileno</span> <span class="p">(</span><span class="n">stdin</span><span class="p">));</span>
<a name="c1-1532"></a><span class="lineno">1532</span> 
<a name="c1-1533"></a><span class="lineno">1533</span>   <span class="cm">/* with_input_from_stdin really means `with_input_from_readline' */</span>
<a name="c1-1534"></a><span class="lineno">1534</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive</span> <span class="o">&amp;&amp;</span> <span class="n">no_line_editing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1535"></a><span class="lineno">1535</span>     <span class="n">with_input_from_stdin</span> <span class="p">();</span>
<a name="c1-1536"></a><span class="lineno">1536</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-1537"></a><span class="lineno">1537</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">interactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1538"></a><span class="lineno">1538</span>     <span class="n">with_input_from_buffered_stream</span> <span class="p">(</span><span class="n">default_buffered_input</span><span class="p">,</span> <span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-1539"></a><span class="lineno">1539</span> <span class="cp">#endif </span><span class="cm">/* BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-1540"></a><span class="lineno">1540</span>   <span class="k">else</span>
<a name="c1-1541"></a><span class="lineno">1541</span>     <span class="n">with_input_from_stream</span> <span class="p">(</span><span class="n">default_input</span><span class="p">,</span> <span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-1542"></a><span class="lineno">1542</span> <span class="p">}</span>
<a name="c1-1543"></a><span class="lineno">1543</span> 
<a name="c1-1544"></a><span class="lineno">1544</span> <span class="cm">/* Close the current shell script input source and forget about it.  This is</span>
<a name="c1-1545"></a><span class="lineno">1545</span> <span class="cm">   extern so execute_cmd.c:initialize_subshell() can call it.  If CHECK_ZERO</span>
<a name="c1-1546"></a><span class="lineno">1546</span> <span class="cm">   is non-zero, we close default_buffered_input even if it's the standard</span>
<a name="c1-1547"></a><span class="lineno">1547</span> <span class="cm">   input (fd 0). */</span>
<a name="c1-1548"></a><span class="lineno">1548</span> <span class="kt">void</span>
<a name="c1-1549"></a><span class="lineno">1549</span> <span class="n">unset_bash_input</span> <span class="p">(</span><span class="n">check_zero</span><span class="p">)</span>
<a name="c1-1550"></a><span class="lineno">1550</span>      <span class="kt">int</span> <span class="n">check_zero</span><span class="p">;</span>
<a name="c1-1551"></a><span class="lineno">1551</span> <span class="p">{</span>
<a name="c1-1552"></a><span class="lineno">1552</span> <span class="cp">#if defined (BUFFERED_INPUT)</span>
<a name="c1-1553"></a><span class="lineno">1553</span>   <span class="k">if</span> <span class="p">((</span><span class="n">check_zero</span> <span class="o">&amp;&amp;</span> <span class="n">default_buffered_input</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1554"></a><span class="lineno">1554</span>       <span class="p">(</span><span class="n">check_zero</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">default_buffered_input</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
<a name="c1-1555"></a><span class="lineno">1555</span>     <span class="p">{</span>
<a name="c1-1556"></a><span class="lineno">1556</span>       <span class="n">close_buffered_fd</span> <span class="p">(</span><span class="n">default_buffered_input</span><span class="p">);</span>
<a name="c1-1557"></a><span class="lineno">1557</span>       <span class="n">default_buffered_input</span> <span class="o">=</span> <span class="n">bash_input</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">buffered_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-1558"></a><span class="lineno">1558</span>       <span class="n">bash_input</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">st_none</span><span class="p">;</span>   <span class="cm">/* XXX */</span>
<a name="c1-1559"></a><span class="lineno">1559</span>     <span class="p">}</span>
<a name="c1-1560"></a><span class="lineno">1560</span> <span class="cp">#else </span><span class="cm">/* !BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-1561"></a><span class="lineno">1561</span>   <span class="k">if</span> <span class="p">(</span><span class="n">default_input</span><span class="p">)</span>
<a name="c1-1562"></a><span class="lineno">1562</span>     <span class="p">{</span>
<a name="c1-1563"></a><span class="lineno">1563</span>       <span class="n">fclose</span> <span class="p">(</span><span class="n">default_input</span><span class="p">);</span>
<a name="c1-1564"></a><span class="lineno">1564</span>       <span class="n">default_input</span> <span class="o">=</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1565"></a><span class="lineno">1565</span>     <span class="p">}</span>
<a name="c1-1566"></a><span class="lineno">1566</span> <span class="cp">#endif </span><span class="cm">/* !BUFFERED_INPUT */</span><span class="cp"></span>
<a name="c1-1567"></a><span class="lineno">1567</span> <span class="p">}</span>
<a name="c1-1568"></a><span class="lineno">1568</span>       
<a name="c1-1569"></a><span class="lineno">1569</span> 
<a name="c1-1570"></a><span class="lineno">1570</span> <span class="cp">#if !defined (PROGRAM)</span>
<a name="c1-1571"></a><span class="lineno">1571</span> <span class="cp">#  define PROGRAM "bash"</span>
<a name="c1-1572"></a><span class="lineno">1572</span> <span class="cp">#endif</span>
<a name="c1-1573"></a><span class="lineno">1573</span> 
<a name="c1-1574"></a><span class="lineno">1574</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1575"></a><span class="lineno">1575</span> <span class="n">set_shell_name</span> <span class="p">(</span><span class="n">argv0</span><span class="p">)</span>
<a name="c1-1576"></a><span class="lineno">1576</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">argv0</span><span class="p">;</span>
<a name="c1-1577"></a><span class="lineno">1577</span> <span class="p">{</span>
<a name="c1-1578"></a><span class="lineno">1578</span>   <span class="cm">/* Here's a hack.  If the name of this shell is "sh", then don't do</span>
<a name="c1-1579"></a><span class="lineno">1579</span> <span class="cm">     any startup files; just try to be more like /bin/sh. */</span>
<a name="c1-1580"></a><span class="lineno">1580</span>   <span class="n">shell_name</span> <span class="o">=</span> <span class="n">argv0</span> <span class="o">?</span> <span class="n">base_pathname</span> <span class="p">(</span><span class="n">argv0</span><span class="p">)</span> <span class="o">:</span> <span class="n">PROGRAM</span><span class="p">;</span>
<a name="c1-1581"></a><span class="lineno">1581</span> 
<a name="c1-1582"></a><span class="lineno">1582</span>   <span class="k">if</span> <span class="p">(</span><span class="n">argv0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">argv0</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c1-1583"></a><span class="lineno">1583</span>     <span class="p">{</span>
<a name="c1-1584"></a><span class="lineno">1584</span>       <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">shell_name</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c1-1585"></a><span class="lineno">1585</span>  <span class="n">shell_name</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1586"></a><span class="lineno">1586</span>       <span class="n">login_shell</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1587"></a><span class="lineno">1587</span>     <span class="p">}</span>
<a name="c1-1588"></a><span class="lineno">1588</span> 
<a name="c1-1589"></a><span class="lineno">1589</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shell_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'s'</span> <span class="o">&amp;&amp;</span> <span class="n">shell_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'h'</span> <span class="o">&amp;&amp;</span> <span class="n">shell_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
<a name="c1-1590"></a><span class="lineno">1590</span>     <span class="n">act_like_sh</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1591"></a><span class="lineno">1591</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shell_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'s'</span> <span class="o">&amp;&amp;</span> <span class="n">shell_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'u'</span> <span class="o">&amp;&amp;</span> <span class="n">shell_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
<a name="c1-1592"></a><span class="lineno">1592</span>     <span class="n">su_shell</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1593"></a><span class="lineno">1593</span> 
<a name="c1-1594"></a><span class="lineno">1594</span>   <span class="n">shell_name</span> <span class="o">=</span> <span class="n">argv0</span> <span class="o">?</span> <span class="n">argv0</span> <span class="o">:</span> <span class="n">PROGRAM</span><span class="p">;</span>
<a name="c1-1595"></a><span class="lineno">1595</span>   <span class="n">FREE</span> <span class="p">(</span><span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-1596"></a><span class="lineno">1596</span>   <span class="n">dollar_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">shell_name</span><span class="p">);</span>
<a name="c1-1597"></a><span class="lineno">1597</span> 
<a name="c1-1598"></a><span class="lineno">1598</span>   <span class="cm">/* A program may start an interactive shell with</span>
<a name="c1-1599"></a><span class="lineno">1599</span> <span class="cm">    "execl ("/bin/bash", "-", NULL)".</span>
<a name="c1-1600"></a><span class="lineno">1600</span> <span class="cm">     If so, default the name of this shell to our name. */</span>
<a name="c1-1601"></a><span class="lineno">1601</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shell_name</span> <span class="o">||</span> <span class="o">!*</span><span class="n">shell_name</span> <span class="o">||</span> <span class="p">(</span><span class="n">shell_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shell_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a name="c1-1602"></a><span class="lineno">1602</span>     <span class="n">shell_name</span> <span class="o">=</span> <span class="n">PROGRAM</span><span class="p">;</span>
<a name="c1-1603"></a><span class="lineno">1603</span> <span class="p">}</span>
<a name="c1-1604"></a><span class="lineno">1604</span> 
<a name="c1-1605"></a><span class="lineno">1605</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1606"></a><span class="lineno">1606</span> <span class="n">init_interactive</span> <span class="p">()</span>
<a name="c1-1607"></a><span class="lineno">1607</span> <span class="p">{</span>
<a name="c1-1608"></a><span class="lineno">1608</span>   <span class="n">expand_aliases</span> <span class="o">=</span> <span class="n">interactive_shell</span> <span class="o">=</span> <span class="n">startup_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1609"></a><span class="lineno">1609</span>   <span class="n">interactive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1610"></a><span class="lineno">1610</span> <span class="p">}</span>
<a name="c1-1611"></a><span class="lineno">1611</span> 
<a name="c1-1612"></a><span class="lineno">1612</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1613"></a><span class="lineno">1613</span> <span class="n">init_noninteractive</span> <span class="p">()</span>
<a name="c1-1614"></a><span class="lineno">1614</span> <span class="p">{</span>
<a name="c1-1615"></a><span class="lineno">1615</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c1-1616"></a><span class="lineno">1616</span>   <span class="n">bash_history_reinit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1617"></a><span class="lineno">1617</span> <span class="cp">#endif </span><span class="cm">/* HISTORY */</span><span class="cp"></span>
<a name="c1-1618"></a><span class="lineno">1618</span>   <span class="n">interactive_shell</span> <span class="o">=</span> <span class="n">startup_state</span> <span class="o">=</span> <span class="n">interactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1619"></a><span class="lineno">1619</span>   <span class="n">expand_aliases</span> <span class="o">=</span> <span class="n">posixly_correct</span><span class="p">;</span>  <span class="cm">/* XXX - was 0 not posixly_correct */</span>
<a name="c1-1620"></a><span class="lineno">1620</span>   <span class="n">no_line_editing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1621"></a><span class="lineno">1621</span> <span class="cp">#if defined (JOB_CONTROL)</span>
<a name="c1-1622"></a><span class="lineno">1622</span>   <span class="n">set_job_control</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1623"></a><span class="lineno">1623</span> <span class="cp">#endif </span><span class="cm">/* JOB_CONTROL */</span><span class="cp"></span>
<a name="c1-1624"></a><span class="lineno">1624</span> <span class="p">}</span>
<a name="c1-1625"></a><span class="lineno">1625</span> 
<a name="c1-1626"></a><span class="lineno">1626</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1627"></a><span class="lineno">1627</span> <span class="n">init_interactive_script</span> <span class="p">()</span>
<a name="c1-1628"></a><span class="lineno">1628</span> <span class="p">{</span>
<a name="c1-1629"></a><span class="lineno">1629</span>   <span class="n">init_noninteractive</span> <span class="p">();</span>
<a name="c1-1630"></a><span class="lineno">1630</span>   <span class="n">expand_aliases</span> <span class="o">=</span> <span class="n">interactive_shell</span> <span class="o">=</span> <span class="n">startup_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1631"></a><span class="lineno">1631</span> <span class="p">}</span>
<a name="c1-1632"></a><span class="lineno">1632</span> 
<a name="c1-1633"></a><span class="lineno">1633</span> <span class="kt">void</span>
<a name="c1-1634"></a><span class="lineno">1634</span> <span class="n">get_current_user_info</span> <span class="p">()</span>
<a name="c1-1635"></a><span class="lineno">1635</span> <span class="p">{</span>
<a name="c1-1636"></a><span class="lineno">1636</span>   <span class="k">struct</span> <span class="n">passwd</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<a name="c1-1637"></a><span class="lineno">1637</span> 
<a name="c1-1638"></a><span class="lineno">1638</span>   <span class="cm">/* Don't fetch this more than once. */</span>
<a name="c1-1639"></a><span class="lineno">1639</span>   <span class="k">if</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1640"></a><span class="lineno">1640</span>     <span class="p">{</span>
<a name="c1-1641"></a><span class="lineno">1641</span>       <span class="n">entry</span> <span class="o">=</span> <span class="n">getpwuid</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">uid</span><span class="p">);</span>
<a name="c1-1642"></a><span class="lineno">1642</span>       <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<a name="c1-1643"></a><span class="lineno">1643</span>  <span class="p">{</span>
<a name="c1-1644"></a><span class="lineno">1644</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pw_name</span><span class="p">);</span>
<a name="c1-1645"></a><span class="lineno">1645</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">shell</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pw_shell</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">pw_shell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a name="c1-1646"></a><span class="lineno">1646</span>        <span class="o">?</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pw_shell</span><span class="p">)</span>
<a name="c1-1647"></a><span class="lineno">1647</span>        <span class="o">:</span> <span class="n">savestring</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
<a name="c1-1648"></a><span class="lineno">1648</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pw_dir</span><span class="p">);</span>
<a name="c1-1649"></a><span class="lineno">1649</span>  <span class="p">}</span>
<a name="c1-1650"></a><span class="lineno">1650</span>       <span class="k">else</span>
<a name="c1-1651"></a><span class="lineno">1651</span>  <span class="p">{</span>
<a name="c1-1652"></a><span class="lineno">1652</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">"I have no name!"</span><span class="p">);</span>
<a name="c1-1653"></a><span class="lineno">1653</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="n">user_name</span><span class="p">);</span>
<a name="c1-1654"></a><span class="lineno">1654</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
<a name="c1-1655"></a><span class="lineno">1655</span>    <span class="n">current_user</span><span class="p">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="s">"/"</span><span class="p">);</span>
<a name="c1-1656"></a><span class="lineno">1656</span>  <span class="p">}</span>
<a name="c1-1657"></a><span class="lineno">1657</span>       <span class="n">endpwent</span> <span class="p">();</span>
<a name="c1-1658"></a><span class="lineno">1658</span>     <span class="p">}</span>
<a name="c1-1659"></a><span class="lineno">1659</span> <span class="p">}</span>
<a name="c1-1660"></a><span class="lineno">1660</span> 
<a name="c1-1661"></a><span class="lineno">1661</span> <span class="cm">/* Do whatever is necessary to initialize the shell.</span>
<a name="c1-1662"></a><span class="lineno">1662</span> <span class="cm">   Put new initializations in here. */</span>
<a name="c1-1663"></a><span class="lineno">1663</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1664"></a><span class="lineno">1664</span> <span class="n">shell_initialize</span> <span class="p">()</span>
<a name="c1-1665"></a><span class="lineno">1665</span> <span class="p">{</span>
<a name="c1-1666"></a><span class="lineno">1666</span>   <span class="kt">char</span> <span class="n">hostname</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<a name="c1-1667"></a><span class="lineno">1667</span> 
<a name="c1-1668"></a><span class="lineno">1668</span>   <span class="cm">/* Line buffer output for stderr and stdout. */</span>
<a name="c1-1669"></a><span class="lineno">1669</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shell_initialized</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1670"></a><span class="lineno">1670</span>     <span class="p">{</span>
<a name="c1-1671"></a><span class="lineno">1671</span>       <span class="n">sh_setlinebuf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
<a name="c1-1672"></a><span class="lineno">1672</span>       <span class="n">sh_setlinebuf</span> <span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<a name="c1-1673"></a><span class="lineno">1673</span>     <span class="p">}</span>
<a name="c1-1674"></a><span class="lineno">1674</span> 
<a name="c1-1675"></a><span class="lineno">1675</span>   <span class="cm">/* Sort the array of shell builtins so that the binary search in</span>
<a name="c1-1676"></a><span class="lineno">1676</span> <span class="cm">     find_shell_builtin () works correctly. */</span>
<a name="c1-1677"></a><span class="lineno">1677</span>   <span class="n">initialize_shell_builtins</span> <span class="p">();</span>
<a name="c1-1678"></a><span class="lineno">1678</span> 
<a name="c1-1679"></a><span class="lineno">1679</span>   <span class="cm">/* Initialize the trap signal handlers before installing our own</span>
<a name="c1-1680"></a><span class="lineno">1680</span> <span class="cm">     signal handlers.  traps.c:restore_original_signals () is responsible</span>
<a name="c1-1681"></a><span class="lineno">1681</span> <span class="cm">     for restoring the original default signal handlers.  That function</span>
<a name="c1-1682"></a><span class="lineno">1682</span> <span class="cm">     is called when we make a new child. */</span>
<a name="c1-1683"></a><span class="lineno">1683</span>   <span class="n">initialize_traps</span> <span class="p">();</span>
<a name="c1-1684"></a><span class="lineno">1684</span>   <span class="n">initialize_signals</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1685"></a><span class="lineno">1685</span> 
<a name="c1-1686"></a><span class="lineno">1686</span>   <span class="cm">/* It's highly unlikely that this will change. */</span>
<a name="c1-1687"></a><span class="lineno">1687</span>   <span class="k">if</span> <span class="p">(</span><span class="n">current_host_name</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1688"></a><span class="lineno">1688</span>     <span class="p">{</span>
<a name="c1-1689"></a><span class="lineno">1689</span>       <span class="cm">/* Initialize current_host_name. */</span>
<a name="c1-1690"></a><span class="lineno">1690</span>       <span class="k">if</span> <span class="p">(</span><span class="n">gethostname</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1691"></a><span class="lineno">1691</span>  <span class="n">current_host_name</span> <span class="o">=</span> <span class="s">"??host??"</span><span class="p">;</span>
<a name="c1-1692"></a><span class="lineno">1692</span>       <span class="k">else</span>
<a name="c1-1693"></a><span class="lineno">1693</span>  <span class="n">current_host_name</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">hostname</span><span class="p">);</span>
<a name="c1-1694"></a><span class="lineno">1694</span>     <span class="p">}</span>
<a name="c1-1695"></a><span class="lineno">1695</span> 
<a name="c1-1696"></a><span class="lineno">1696</span>   <span class="cm">/* Initialize the stuff in current_user that comes from the password</span>
<a name="c1-1697"></a><span class="lineno">1697</span> <span class="cm">     file.  We don't need to do this right away if the shell is not</span>
<a name="c1-1698"></a><span class="lineno">1698</span> <span class="cm">     interactive. */</span>
<a name="c1-1699"></a><span class="lineno">1699</span>   <span class="k">if</span> <span class="p">(</span><span class="n">interactive_shell</span><span class="p">)</span>
<a name="c1-1700"></a><span class="lineno">1700</span>     <span class="n">get_current_user_info</span> <span class="p">();</span>
<a name="c1-1701"></a><span class="lineno">1701</span> 
<a name="c1-1702"></a><span class="lineno">1702</span>   <span class="cm">/* Initialize our interface to the tilde expander. */</span>
<a name="c1-1703"></a><span class="lineno">1703</span>   <span class="n">tilde_initialize</span> <span class="p">();</span>
<a name="c1-1704"></a><span class="lineno">1704</span> 
<a name="c1-1705"></a><span class="lineno">1705</span>   <span class="cm">/* Initialize internal and environment variables.  Don't import shell</span>
<a name="c1-1706"></a><span class="lineno">1706</span> <span class="cm">     functions from the environment if we are running in privileged or</span>
<a name="c1-1707"></a><span class="lineno">1707</span> <span class="cm">     restricted mode or if the shell is running setuid. */</span>
<a name="c1-1708"></a><span class="lineno">1708</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-1709"></a><span class="lineno">1709</span>   <span class="n">initialize_shell_variables</span> <span class="p">(</span><span class="n">shell_environment</span><span class="p">,</span> <span class="n">privileged_mode</span><span class="o">||</span><span class="k">restricted</span><span class="o">||</span><span class="n">running_setuid</span><span class="p">);</span>
<a name="c1-1710"></a><span class="lineno">1710</span> <span class="cp">#else</span>
<a name="c1-1711"></a><span class="lineno">1711</span>   <span class="n">initialize_shell_variables</span> <span class="p">(</span><span class="n">shell_environment</span><span class="p">,</span> <span class="n">privileged_mode</span><span class="o">||</span><span class="n">running_setuid</span><span class="p">);</span>
<a name="c1-1712"></a><span class="lineno">1712</span> <span class="cp">#endif</span>
<a name="c1-1713"></a><span class="lineno">1713</span> 
<a name="c1-1714"></a><span class="lineno">1714</span>   <span class="cm">/* Initialize the data structures for storing and running jobs. */</span>
<a name="c1-1715"></a><span class="lineno">1715</span>   <span class="n">initialize_job_control</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1716"></a><span class="lineno">1716</span> 
<a name="c1-1717"></a><span class="lineno">1717</span>   <span class="cm">/* Initialize input streams to null. */</span>
<a name="c1-1718"></a><span class="lineno">1718</span>   <span class="n">initialize_bash_input</span> <span class="p">();</span>
<a name="c1-1719"></a><span class="lineno">1719</span> 
<a name="c1-1720"></a><span class="lineno">1720</span>   <span class="n">initialize_flags</span> <span class="p">();</span>
<a name="c1-1721"></a><span class="lineno">1721</span> 
<a name="c1-1722"></a><span class="lineno">1722</span>   <span class="cm">/* Initialize the shell options.  Don't import the shell options</span>
<a name="c1-1723"></a><span class="lineno">1723</span> <span class="cm">     from the environment variables $SHELLOPTS or $BASHOPTS if we are</span>
<a name="c1-1724"></a><span class="lineno">1724</span> <span class="cm">     running in privileged or restricted mode or if the shell is running</span>
<a name="c1-1725"></a><span class="lineno">1725</span> <span class="cm">     setuid. */</span>
<a name="c1-1726"></a><span class="lineno">1726</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-1727"></a><span class="lineno">1727</span>   <span class="n">initialize_shell_options</span> <span class="p">(</span><span class="n">privileged_mode</span><span class="o">||</span><span class="k">restricted</span><span class="o">||</span><span class="n">running_setuid</span><span class="p">);</span>
<a name="c1-1728"></a><span class="lineno">1728</span>   <span class="n">initialize_bashopts</span> <span class="p">(</span><span class="n">privileged_mode</span><span class="o">||</span><span class="k">restricted</span><span class="o">||</span><span class="n">running_setuid</span><span class="p">);</span>
<a name="c1-1729"></a><span class="lineno">1729</span> <span class="cp">#else</span>
<a name="c1-1730"></a><span class="lineno">1730</span>   <span class="n">initialize_shell_options</span> <span class="p">(</span><span class="n">privileged_mode</span><span class="o">||</span><span class="n">running_setuid</span><span class="p">);</span>
<a name="c1-1731"></a><span class="lineno">1731</span>   <span class="n">initialize_bashopts</span> <span class="p">(</span><span class="n">privileged_mode</span><span class="o">||</span><span class="n">running_setuid</span><span class="p">);</span>
<a name="c1-1732"></a><span class="lineno">1732</span> <span class="cp">#endif</span>
<a name="c1-1733"></a><span class="lineno">1733</span> <span class="p">}</span>
<a name="c1-1734"></a><span class="lineno">1734</span> 
<a name="c1-1735"></a><span class="lineno">1735</span> <span class="cm">/* Function called by main () when it appears that the shell has already</span>
<a name="c1-1736"></a><span class="lineno">1736</span> <span class="cm">   had some initialization performed.  This is supposed to reset the world</span>
<a name="c1-1737"></a><span class="lineno">1737</span> <span class="cm">   back to a pristine state, as if we had been exec'ed. */</span>
<a name="c1-1738"></a><span class="lineno">1738</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1739"></a><span class="lineno">1739</span> <span class="n">shell_reinitialize</span> <span class="p">()</span>
<a name="c1-1740"></a><span class="lineno">1740</span> <span class="p">{</span>
<a name="c1-1741"></a><span class="lineno">1741</span>   <span class="cm">/* The default shell prompts. */</span>
<a name="c1-1742"></a><span class="lineno">1742</span>   <span class="n">primary_prompt</span> <span class="o">=</span> <span class="n">PPROMPT</span><span class="p">;</span>
<a name="c1-1743"></a><span class="lineno">1743</span>   <span class="n">secondary_prompt</span> <span class="o">=</span> <span class="n">SPROMPT</span><span class="p">;</span>
<a name="c1-1744"></a><span class="lineno">1744</span> 
<a name="c1-1745"></a><span class="lineno">1745</span>   <span class="cm">/* Things that get 1. */</span>
<a name="c1-1746"></a><span class="lineno">1746</span>   <span class="n">current_command_number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1747"></a><span class="lineno">1747</span> 
<a name="c1-1748"></a><span class="lineno">1748</span>   <span class="cm">/* We have decided that the ~/.bashrc file should not be executed</span>
<a name="c1-1749"></a><span class="lineno">1749</span> <span class="cm">     for the invocation of each shell script.  If the variable $ENV</span>
<a name="c1-1750"></a><span class="lineno">1750</span> <span class="cm">     (or $BASH_ENV) is set, its value is used as the name of a file</span>
<a name="c1-1751"></a><span class="lineno">1751</span> <span class="cm">     to source. */</span>
<a name="c1-1752"></a><span class="lineno">1752</span>   <span class="n">no_rc</span> <span class="o">=</span> <span class="n">no_profile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1753"></a><span class="lineno">1753</span> 
<a name="c1-1754"></a><span class="lineno">1754</span>   <span class="cm">/* Things that get 0. */</span>
<a name="c1-1755"></a><span class="lineno">1755</span>   <span class="n">login_shell</span> <span class="o">=</span> <span class="n">make_login_shell</span> <span class="o">=</span> <span class="n">interactive</span> <span class="o">=</span> <span class="n">executing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1756"></a><span class="lineno">1756</span>   <span class="n">debugging</span> <span class="o">=</span> <span class="n">do_version</span> <span class="o">=</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">last_command_exit_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1757"></a><span class="lineno">1757</span>   <span class="n">forced_interactive</span> <span class="o">=</span> <span class="n">interactive_shell</span> <span class="o">=</span> <span class="n">subshell_environment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1758"></a><span class="lineno">1758</span>   <span class="n">expand_aliases</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1759"></a><span class="lineno">1759</span> 
<a name="c1-1760"></a><span class="lineno">1760</span> <span class="cp">#if defined (HISTORY)</span>
<a name="c1-1761"></a><span class="lineno">1761</span>   <span class="n">bash_history_reinit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="c1-1762"></a><span class="lineno">1762</span> <span class="cp">#endif </span><span class="cm">/* HISTORY */</span><span class="cp"></span>
<a name="c1-1763"></a><span class="lineno">1763</span> 
<a name="c1-1764"></a><span class="lineno">1764</span> <span class="cp">#if defined (RESTRICTED_SHELL)</span>
<a name="c1-1765"></a><span class="lineno">1765</span>   <span class="k">restricted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1766"></a><span class="lineno">1766</span> <span class="cp">#endif </span><span class="cm">/* RESTRICTED_SHELL */</span><span class="cp"></span>
<a name="c1-1767"></a><span class="lineno">1767</span> 
<a name="c1-1768"></a><span class="lineno">1768</span>   <span class="cm">/* Ensure that the default startup file is used.  (Except that we don't</span>
<a name="c1-1769"></a><span class="lineno">1769</span> <span class="cm">     execute this file for reinitialized shells). */</span>
<a name="c1-1770"></a><span class="lineno">1770</span>   <span class="n">bashrc_file</span> <span class="o">=</span> <span class="s">"~/.bashrc"</span><span class="p">;</span>
<a name="c1-1771"></a><span class="lineno">1771</span> 
<a name="c1-1772"></a><span class="lineno">1772</span>   <span class="cm">/* Delete all variables and functions.  They will be reinitialized when</span>
<a name="c1-1773"></a><span class="lineno">1773</span> <span class="cm">     the environment is parsed. */</span>
<a name="c1-1774"></a><span class="lineno">1774</span>   <span class="n">delete_all_contexts</span> <span class="p">(</span><span class="n">shell_variables</span><span class="p">);</span>
<a name="c1-1775"></a><span class="lineno">1775</span>   <span class="n">delete_all_variables</span> <span class="p">(</span><span class="n">shell_functions</span><span class="p">);</span>
<a name="c1-1776"></a><span class="lineno">1776</span> 
<a name="c1-1777"></a><span class="lineno">1777</span>   <span class="n">reinit_special_variables</span> <span class="p">();</span>
<a name="c1-1778"></a><span class="lineno">1778</span> 
<a name="c1-1779"></a><span class="lineno">1779</span> <span class="cp">#if defined (READLINE)</span>
<a name="c1-1780"></a><span class="lineno">1780</span>   <span class="n">bashline_reinitialize</span> <span class="p">();</span>
<a name="c1-1781"></a><span class="lineno">1781</span> <span class="cp">#endif</span>
<a name="c1-1782"></a><span class="lineno">1782</span> 
<a name="c1-1783"></a><span class="lineno">1783</span>   <span class="n">shell_reinitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1784"></a><span class="lineno">1784</span> <span class="p">}</span>
<a name="c1-1785"></a><span class="lineno">1785</span> 
<a name="c1-1786"></a><span class="lineno">1786</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1787"></a><span class="lineno">1787</span> <span class="n">show_shell_usage</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
<a name="c1-1788"></a><span class="lineno">1788</span>      <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
<a name="c1-1789"></a><span class="lineno">1789</span>      <span class="kt">int</span> <span class="n">extra</span><span class="p">;</span>
<a name="c1-1790"></a><span class="lineno">1790</span> <span class="p">{</span>
<a name="c1-1791"></a><span class="lineno">1791</span>   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1792"></a><span class="lineno">1792</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">set_opts</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
<a name="c1-1793"></a><span class="lineno">1793</span> 
<a name="c1-1794"></a><span class="lineno">1794</span>   <span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">)</span>
<a name="c1-1795"></a><span class="lineno">1795</span>     <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"GNU bash, version %s-(%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">shell_version_string</span> <span class="p">(),</span> <span class="n">MACHTYPE</span><span class="p">);</span>
<a name="c1-1796"></a><span class="lineno">1796</span>   <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"Usage:</span><span class="se">\t</span><span class="s">%s [GNU long option] [option] ...</span><span class="se">\n\t</span><span class="s">%s [GNU long option] [option] script-file ...</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span>
<a name="c1-1797"></a><span class="lineno">1797</span>       <span class="n">shell_name</span><span class="p">,</span> <span class="n">shell_name</span><span class="p">);</span>
<a name="c1-1798"></a><span class="lineno">1798</span>   <span class="n">fputs</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"GNU long options:</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
<a name="c1-1799"></a><span class="lineno">1799</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1800"></a><span class="lineno">1800</span>     <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">"</span><span class="se">\t</span><span class="s">--%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">long_args</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
<a name="c1-1801"></a><span class="lineno">1801</span> 
<a name="c1-1802"></a><span class="lineno">1802</span>   <span class="n">fputs</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Shell options:</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
<a name="c1-1803"></a><span class="lineno">1803</span>   <span class="n">fputs</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">-irsD or -c command or -O shopt_option</span><span class="se">\t\t</span><span class="s">(invocation only)</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
<a name="c1-1804"></a><span class="lineno">1804</span> 
<a name="c1-1805"></a><span class="lineno">1805</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">set_opts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">shell_builtins</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1806"></a><span class="lineno">1806</span>     <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span> <span class="p">(</span><span class="n">shell_builtins</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">"set"</span><span class="p">))</span>
<a name="c1-1807"></a><span class="lineno">1807</span>       <span class="n">set_opts</span> <span class="o">=</span> <span class="n">savestring</span> <span class="p">(</span><span class="n">shell_builtins</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">short_doc</span><span class="p">);</span>
<a name="c1-1808"></a><span class="lineno">1808</span>   <span class="k">if</span> <span class="p">(</span><span class="n">set_opts</span><span class="p">)</span>
<a name="c1-1809"></a><span class="lineno">1809</span>     <span class="p">{</span>
<a name="c1-1810"></a><span class="lineno">1810</span>       <span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span> <span class="p">(</span><span class="n">set_opts</span><span class="p">,</span> <span class="sc">'['</span><span class="p">);</span>
<a name="c1-1811"></a><span class="lineno">1811</span>       <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-1812"></a><span class="lineno">1812</span>  <span class="n">s</span> <span class="o">=</span> <span class="n">set_opts</span><span class="p">;</span>
<a name="c1-1813"></a><span class="lineno">1813</span>       <span class="k">while</span> <span class="p">(</span><span class="o">*++</span><span class="n">s</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c1-1814"></a><span class="lineno">1814</span>  <span class="p">;</span>
<a name="c1-1815"></a><span class="lineno">1815</span>       <span class="n">t</span> <span class="o">=</span> <span class="n">strchr</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">']'</span><span class="p">);</span>
<a name="c1-1816"></a><span class="lineno">1816</span>       <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span>
<a name="c1-1817"></a><span class="lineno">1817</span>  <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c1-1818"></a><span class="lineno">1818</span>       <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">-%s or -o option</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>
<a name="c1-1819"></a><span class="lineno">1819</span>       <span class="n">free</span> <span class="p">(</span><span class="n">set_opts</span><span class="p">);</span>
<a name="c1-1820"></a><span class="lineno">1820</span>     <span class="p">}</span>
<a name="c1-1821"></a><span class="lineno">1821</span> 
<a name="c1-1822"></a><span class="lineno">1822</span>   <span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">)</span>
<a name="c1-1823"></a><span class="lineno">1823</span>     <span class="p">{</span>
<a name="c1-1824"></a><span class="lineno">1824</span>       <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"Type `%s -c </span><span class="se">\"</span><span class="s">help set</span><span class="se">\"</span><span class="s">' for more information about shell options.</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">shell_name</span><span class="p">);</span>
<a name="c1-1825"></a><span class="lineno">1825</span>       <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"Type `%s -c help' for more information about shell builtin commands.</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">shell_name</span><span class="p">);</span>
<a name="c1-1826"></a><span class="lineno">1826</span>       <span class="n">fprintf</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"Use the `bashbug' command to report bugs.</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
<a name="c1-1827"></a><span class="lineno">1827</span>     <span class="p">}</span>
<a name="c1-1828"></a><span class="lineno">1828</span> <span class="p">}</span>
<a name="c1-1829"></a><span class="lineno">1829</span> 
<a name="c1-1830"></a><span class="lineno">1830</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1831"></a><span class="lineno">1831</span> <span class="n">add_shopt_to_alist</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">on_or_off</span><span class="p">)</span>
<a name="c1-1832"></a><span class="lineno">1832</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
<a name="c1-1833"></a><span class="lineno">1833</span>      <span class="kt">int</span> <span class="n">on_or_off</span><span class="p">;</span>
<a name="c1-1834"></a><span class="lineno">1834</span> <span class="p">{</span>
<a name="c1-1835"></a><span class="lineno">1835</span>   <span class="k">if</span> <span class="p">(</span><span class="n">shopt_ind</span> <span class="o">&gt;=</span> <span class="n">shopt_len</span><span class="p">)</span>
<a name="c1-1836"></a><span class="lineno">1836</span>     <span class="p">{</span>
<a name="c1-1837"></a><span class="lineno">1837</span>       <span class="n">shopt_len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
<a name="c1-1838"></a><span class="lineno">1838</span>       <span class="n">shopt_alist</span> <span class="o">=</span> <span class="p">(</span><span class="n">STRING_INT_ALIST</span> <span class="o">*</span><span class="p">)</span><span class="n">xrealloc</span> <span class="p">(</span><span class="n">shopt_alist</span><span class="p">,</span> <span class="n">shopt_len</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">shopt_alist</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<a name="c1-1839"></a><span class="lineno">1839</span>     <span class="p">}</span>
<a name="c1-1840"></a><span class="lineno">1840</span>   <span class="n">shopt_alist</span><span class="p">[</span><span class="n">shopt_ind</span><span class="p">].</span><span class="n">word</span> <span class="o">=</span> <span class="n">opt</span><span class="p">;</span>
<a name="c1-1841"></a><span class="lineno">1841</span>   <span class="n">shopt_alist</span><span class="p">[</span><span class="n">shopt_ind</span><span class="p">].</span><span class="n">token</span> <span class="o">=</span> <span class="n">on_or_off</span><span class="p">;</span>
<a name="c1-1842"></a><span class="lineno">1842</span>   <span class="n">shopt_ind</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1843"></a><span class="lineno">1843</span> <span class="p">}</span>
<a name="c1-1844"></a><span class="lineno">1844</span> 
<a name="c1-1845"></a><span class="lineno">1845</span> <span class="k">static</span> <span class="kt">void</span>
<a name="c1-1846"></a><span class="lineno">1846</span> <span class="n">run_shopt_alist</span> <span class="p">()</span>
<a name="c1-1847"></a><span class="lineno">1847</span> <span class="p">{</span>
<a name="c1-1848"></a><span class="lineno">1848</span>   <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1849"></a><span class="lineno">1849</span> 
<a name="c1-1850"></a><span class="lineno">1850</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">shopt_ind</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-1851"></a><span class="lineno">1851</span>     <span class="k">if</span> <span class="p">(</span><span class="n">shopt_setopt</span> <span class="p">(</span><span class="n">shopt_alist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">word</span><span class="p">,</span> <span class="p">(</span><span class="n">shopt_alist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">))</span> <span class="o">!=</span> <span class="n">EXECUTION_SUCCESS</span><span class="p">)</span>
<a name="c1-1852"></a><span class="lineno">1852</span>       <span class="n">exit</span> <span class="p">(</span><span class="n">EX_BADUSAGE</span><span class="p">);</span>
<a name="c1-1853"></a><span class="lineno">1853</span>   <span class="n">free</span> <span class="p">(</span><span class="n">shopt_alist</span><span class="p">);</span>
<a name="c1-1854"></a><span class="lineno">1854</span>   <span class="n">shopt_alist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1855"></a><span class="lineno">1855</span>   <span class="n">shopt_ind</span> <span class="o">=</span> <span class="n">shopt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1856"></a><span class="lineno">1856</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>
</body></html>