<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac00069f -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="shortcut icon" href="http://tyr.ics.es.osaka-u.ac.jp/static/favicon.ico">
        <script type="text/javascript" src="./git-cluster2_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./git-cluster2_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./git-cluster2_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./git-cluster2_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./git-cluster2_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./git-cluster2_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./git-cluster2_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./git-cluster2_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./git-cluster2_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./git-cluster2_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./git-cluster2_files/chosen.jquery.js"></script>


        <script src="./git-cluster2_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./git-cluster2_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./git-cluster2_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac00069f");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./git-cluster2_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./git-cluster2_files/bootstrap.css" rel="stylesheet">

        <link href="./git-cluster2_files/force.css" rel="stylesheet" type="text/css">
        <link href="./git-cluster2_files/chosen.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="http://tyr.ics.es.osaka-u.ac.jp/pygments.css">
<title>Fica -- survey git-v1.7.9-rc1 12-01-25 02:26:57</title>

<script language="javascript">

    var reheight = function(){
        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-332']")[0].scrollIntoView();
        $("a[name='c1-442']")[0].scrollIntoView();
        reheight();
        
        $("#clonesets").accordion({event:"click", autoHeight: false});
        $("#clonesets").accordion("activate","#cs-4f1f687db61c5411ac00069f");
        
        $("#cs-4f1f687db61c5411ac00069f").scrollintoview();
        

        
        $(".scrollbox").each(function(){
            var scrollbox = $(this);
            scrollbox.scroll(function(){
                var percent = $(this).scrollTop() /
                    (this.scrollHeight-$(this).height()) ;
                $(this).prev().css("opacity", percent * 5 );
                $(this).next().css("opacity", (1 - percent ) * 5 );
            });
        });
        
    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

<body>
<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> builtin/rev-list.c 
                <small> (335,3)-(347,3)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">  1</span> <span class="cp">#include "cache.h"</span>
<a name="c0-2"></a><span class="lineno">  2</span> <span class="cp">#include "commit.h"</span>
<a name="c0-3"></a><span class="lineno">  3</span> <span class="cp">#include "diff.h"</span>
<a name="c0-4"></a><span class="lineno">  4</span> <span class="cp">#include "revision.h"</span>
<a name="c0-5"></a><span class="lineno">  5</span> <span class="cp">#include "list-objects.h"</span>
<a name="c0-6"></a><span class="lineno">  6</span> <span class="cp">#include "builtin.h"</span>
<a name="c0-7"></a><span class="lineno">  7</span> <span class="cp">#include "log-tree.h"</span>
<a name="c0-8"></a><span class="lineno">  8</span> <span class="cp">#include "graph.h"</span>
<a name="c0-9"></a><span class="lineno">  9</span> <span class="cp">#include "bisect.h"</span>
<a name="c0-10"></a><span class="lineno"> 10</span> 
<a name="c0-11"></a><span class="lineno"> 11</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">rev_list_usage</span><span class="p">[]</span> <span class="o">=</span>
<a name="c0-12"></a><span class="lineno"> 12</span> <span class="s">"git rev-list [OPTION] &lt;commit-id&gt;... [ -- paths... ]</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-13"></a><span class="lineno"> 13</span> <span class="s">"  limiting output:</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-14"></a><span class="lineno"> 14</span> <span class="s">"    --max-count=&lt;n&gt;</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-15"></a><span class="lineno"> 15</span> <span class="s">"    --max-age=&lt;epoch&gt;</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-16"></a><span class="lineno"> 16</span> <span class="s">"    --min-age=&lt;epoch&gt;</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-17"></a><span class="lineno"> 17</span> <span class="s">"    --sparse</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-18"></a><span class="lineno"> 18</span> <span class="s">"    --no-merges</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-19"></a><span class="lineno"> 19</span> <span class="s">"    --min-parents=&lt;n&gt;</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-20"></a><span class="lineno"> 20</span> <span class="s">"    --no-min-parents</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-21"></a><span class="lineno"> 21</span> <span class="s">"    --max-parents=&lt;n&gt;</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-22"></a><span class="lineno"> 22</span> <span class="s">"    --no-max-parents</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-23"></a><span class="lineno"> 23</span> <span class="s">"    --remove-empty</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-24"></a><span class="lineno"> 24</span> <span class="s">"    --all</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-25"></a><span class="lineno"> 25</span> <span class="s">"    --branches</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-26"></a><span class="lineno"> 26</span> <span class="s">"    --tags</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-27"></a><span class="lineno"> 27</span> <span class="s">"    --remotes</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-28"></a><span class="lineno"> 28</span> <span class="s">"    --stdin</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-29"></a><span class="lineno"> 29</span> <span class="s">"    --quiet</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-30"></a><span class="lineno"> 30</span> <span class="s">"  ordering output:</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-31"></a><span class="lineno"> 31</span> <span class="s">"    --topo-order</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-32"></a><span class="lineno"> 32</span> <span class="s">"    --date-order</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-33"></a><span class="lineno"> 33</span> <span class="s">"    --reverse</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-34"></a><span class="lineno"> 34</span> <span class="s">"  formatting output:</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-35"></a><span class="lineno"> 35</span> <span class="s">"    --parents</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-36"></a><span class="lineno"> 36</span> <span class="s">"    --children</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-37"></a><span class="lineno"> 37</span> <span class="s">"    --objects | --objects-edge</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-38"></a><span class="lineno"> 38</span> <span class="s">"    --unpacked</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-39"></a><span class="lineno"> 39</span> <span class="s">"    --header | --pretty</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-40"></a><span class="lineno"> 40</span> <span class="s">"    --abbrev=&lt;n&gt; | --no-abbrev</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-41"></a><span class="lineno"> 41</span> <span class="s">"    --abbrev-commit</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-42"></a><span class="lineno"> 42</span> <span class="s">"    --left-right</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-43"></a><span class="lineno"> 43</span> <span class="s">"  special purpose:</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-44"></a><span class="lineno"> 44</span> <span class="s">"    --bisect</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-45"></a><span class="lineno"> 45</span> <span class="s">"    --bisect-vars</span><span class="se">\n</span><span class="s">"</span>
<a name="c0-46"></a><span class="lineno"> 46</span> <span class="s">"    --bisect-all"</span>
<a name="c0-47"></a><span class="lineno"> 47</span> <span class="p">;</span>
<a name="c0-48"></a><span class="lineno"> 48</span> 
<a name="c0-49"></a><span class="lineno"> 49</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">finish_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<a name="c0-50"></a><span class="lineno"> 50</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c0-51"></a><span class="lineno"> 51</span> <span class="p">{</span>
<a name="c0-52"></a><span class="lineno"> 52</span>   <span class="k">struct</span> <span class="n">rev_list_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<a name="c0-53"></a><span class="lineno"> 53</span>   <span class="k">struct</span> <span class="n">rev_info</span> <span class="o">*</span><span class="n">revs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">revs</span><span class="p">;</span>
<a name="c0-54"></a><span class="lineno"> 54</span> 
<a name="c0-55"></a><span class="lineno"> 55</span>   <span class="n">graph_show_commit</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">);</span>
<a name="c0-56"></a><span class="lineno"> 56</span> 
<a name="c0-57"></a><span class="lineno"> 57</span>   <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-58"></a><span class="lineno"> 58</span>     <span class="k">if</span> <span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PATCHSAME</span><span class="p">)</span>
<a name="c0-59"></a><span class="lineno"> 59</span>       <span class="n">revs</span><span class="o">-&gt;</span><span class="n">count_same</span><span class="o">++</span><span class="p">;</span>
<a name="c0-60"></a><span class="lineno"> 60</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SYMMETRIC_LEFT</span><span class="p">)</span>
<a name="c0-61"></a><span class="lineno"> 61</span>       <span class="n">revs</span><span class="o">-&gt;</span><span class="n">count_left</span><span class="o">++</span><span class="p">;</span>
<a name="c0-62"></a><span class="lineno"> 62</span>     <span class="k">else</span>
<a name="c0-63"></a><span class="lineno"> 63</span>       <span class="n">revs</span><span class="o">-&gt;</span><span class="n">count_right</span><span class="o">++</span><span class="p">;</span>
<a name="c0-64"></a><span class="lineno"> 64</span>     <span class="n">finish_commit</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c0-65"></a><span class="lineno"> 65</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-66"></a><span class="lineno"> 66</span>   <span class="p">}</span>
<a name="c0-67"></a><span class="lineno"> 67</span> 
<a name="c0-68"></a><span class="lineno"> 68</span>   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">show_timestamp</span><span class="p">)</span>
<a name="c0-69"></a><span class="lineno"> 69</span>     <span class="n">printf</span><span class="p">(</span><span class="s">"%lu "</span><span class="p">,</span> <span class="n">commit</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">);</span>
<a name="c0-70"></a><span class="lineno"> 70</span>   <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">header_prefix</span><span class="p">)</span>
<a name="c0-71"></a><span class="lineno"> 71</span>     <span class="n">fputs</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">header_prefix</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
<a name="c0-72"></a><span class="lineno"> 72</span> 
<a name="c0-73"></a><span class="lineno"> 73</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">)</span>
<a name="c0-74"></a><span class="lineno"> 74</span>     <span class="n">fputs</span><span class="p">(</span><span class="n">get_revision_mark</span><span class="p">(</span><span class="n">revs</span><span class="p">,</span> <span class="n">commit</span><span class="p">),</span> <span class="n">stdout</span><span class="p">);</span>
<a name="c0-75"></a><span class="lineno"> 75</span>   <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">abbrev_commit</span> <span class="o">&amp;&amp;</span> <span class="n">revs</span><span class="o">-&gt;</span><span class="n">abbrev</span><span class="p">)</span>
<a name="c0-76"></a><span class="lineno"> 76</span>     <span class="n">fputs</span><span class="p">(</span><span class="n">find_unique_abbrev</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">,</span> <span class="n">revs</span><span class="o">-&gt;</span><span class="n">abbrev</span><span class="p">),</span>
<a name="c0-77"></a><span class="lineno"> 77</span>           <span class="n">stdout</span><span class="p">);</span>
<a name="c0-78"></a><span class="lineno"> 78</span>   <span class="k">else</span>
<a name="c0-79"></a><span class="lineno"> 79</span>     <span class="n">fputs</span><span class="p">(</span><span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">),</span> <span class="n">stdout</span><span class="p">);</span>
<a name="c0-80"></a><span class="lineno"> 80</span>   <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">print_parents</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-81"></a><span class="lineno"> 81</span>     <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">parents</span> <span class="o">=</span> <span class="n">commit</span><span class="o">-&gt;</span><span class="n">parents</span><span class="p">;</span>
<a name="c0-82"></a><span class="lineno"> 82</span>     <span class="k">while</span> <span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-83"></a><span class="lineno"> 83</span>       <span class="n">printf</span><span class="p">(</span><span class="s">" %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">parents</span><span class="o">-&gt;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-84"></a><span class="lineno"> 84</span>       <span class="n">parents</span> <span class="o">=</span> <span class="n">parents</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-85"></a><span class="lineno"> 85</span>     <span class="p">}</span>
<a name="c0-86"></a><span class="lineno"> 86</span>   <span class="p">}</span>
<a name="c0-87"></a><span class="lineno"> 87</span>   <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-88"></a><span class="lineno"> 88</span>     <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">children</span><span class="p">;</span>
<a name="c0-89"></a><span class="lineno"> 89</span> 
<a name="c0-90"></a><span class="lineno"> 90</span>     <span class="n">children</span> <span class="o">=</span> <span class="n">lookup_decoration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
<a name="c0-91"></a><span class="lineno"> 91</span>     <span class="k">while</span> <span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-92"></a><span class="lineno"> 92</span>       <span class="n">printf</span><span class="p">(</span><span class="s">" %s"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">children</span><span class="o">-&gt;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-93"></a><span class="lineno"> 93</span>       <span class="n">children</span> <span class="o">=</span> <span class="n">children</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-94"></a><span class="lineno"> 94</span>     <span class="p">}</span>
<a name="c0-95"></a><span class="lineno"> 95</span>   <span class="p">}</span>
<a name="c0-96"></a><span class="lineno"> 96</span>   <span class="n">show_decorations</span><span class="p">(</span><span class="n">revs</span><span class="p">,</span> <span class="n">commit</span><span class="p">);</span>
<a name="c0-97"></a><span class="lineno"> 97</span>   <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commit_format</span> <span class="o">==</span> <span class="n">CMIT_FMT_ONELINE</span><span class="p">)</span>
<a name="c0-98"></a><span class="lineno"> 98</span>     <span class="n">putchar</span><span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
<a name="c0-99"></a><span class="lineno"> 99</span>   <span class="k">else</span>
<a name="c0-100"></a><span class="lineno">100</span>    <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-101"></a><span class="lineno">101</span> 
<a name="c0-102"></a><span class="lineno">102</span>  <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">verbose_header</span> <span class="o">&amp;&amp;</span> <span class="n">commit</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-103"></a><span class="lineno">103</span>    <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-104"></a><span class="lineno">104</span>    <span class="k">struct</span> <span class="n">pretty_print_context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<a name="c0-105"></a><span class="lineno">105</span>    <span class="n">ctx</span><span class="p">.</span><span class="n">abbrev</span> <span class="o">=</span> <span class="n">revs</span><span class="o">-&gt;</span><span class="n">abbrev</span><span class="p">;</span>
<a name="c0-106"></a><span class="lineno">106</span>    <span class="n">ctx</span><span class="p">.</span><span class="n">date_mode</span> <span class="o">=</span> <span class="n">revs</span><span class="o">-&gt;</span><span class="n">date_mode</span><span class="p">;</span>
<a name="c0-107"></a><span class="lineno">107</span>    <span class="n">ctx</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">revs</span><span class="o">-&gt;</span><span class="n">commit_format</span><span class="p">;</span>
<a name="c0-108"></a><span class="lineno">108</span>    <span class="n">pretty_print_commit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-109"></a><span class="lineno">109</span>    <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-110"></a><span class="lineno">110</span>      <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-111"></a><span class="lineno">111</span>        <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commit_format</span> <span class="o">!=</span> <span class="n">CMIT_FMT_ONELINE</span><span class="p">)</span>
<a name="c0-112"></a><span class="lineno">112</span>          <span class="n">graph_show_oneline</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">);</span>
<a name="c0-113"></a><span class="lineno">113</span> 
<a name="c0-114"></a><span class="lineno">114</span>        <span class="n">graph_show_commit_msg</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-115"></a><span class="lineno">115</span> 
<a name="c0-116"></a><span class="lineno">116</span>        <span class="cm">/*</span>
<a name="c0-117"></a><span class="lineno">117</span> <span class="cm">         * Add a newline after the commit message.</span>
<a name="c0-118"></a><span class="lineno">118</span> <span class="cm">         *</span>
<a name="c0-119"></a><span class="lineno">119</span> <span class="cm">         * Usually, this newline produces a blank</span>
<a name="c0-120"></a><span class="lineno">120</span> <span class="cm">         * padding line between entries, in which case</span>
<a name="c0-121"></a><span class="lineno">121</span> <span class="cm">         * we need to add graph padding on this line.</span>
<a name="c0-122"></a><span class="lineno">122</span> <span class="cm">         *</span>
<a name="c0-123"></a><span class="lineno">123</span> <span class="cm">         * However, the commit message may not end in a</span>
<a name="c0-124"></a><span class="lineno">124</span> <span class="cm">         * newline.  In this case the newline simply</span>
<a name="c0-125"></a><span class="lineno">125</span> <span class="cm">         * ends the last line of the commit message,</span>
<a name="c0-126"></a><span class="lineno">126</span> <span class="cm">         * and we don't need any graph output.  (This</span>
<a name="c0-127"></a><span class="lineno">127</span> <span class="cm">         * always happens with CMIT_FMT_ONELINE, and it</span>
<a name="c0-128"></a><span class="lineno">128</span> <span class="cm">         * happens with CMIT_FMT_USERFORMAT when the</span>
<a name="c0-129"></a><span class="lineno">129</span> <span class="cm">         * format doesn't explicitly end in a newline.)</span>
<a name="c0-130"></a><span class="lineno">130</span> <span class="cm">         */</span>
<a name="c0-131"></a><span class="lineno">131</span>        <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-132"></a><span class="lineno">132</span>          <span class="n">graph_show_padding</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">);</span>
<a name="c0-133"></a><span class="lineno">133</span>        <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-134"></a><span class="lineno">134</span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-135"></a><span class="lineno">135</span>        <span class="cm">/*</span>
<a name="c0-136"></a><span class="lineno">136</span> <span class="cm">         * If the message buffer is empty, just show</span>
<a name="c0-137"></a><span class="lineno">137</span> <span class="cm">         * the rest of the graph output for this</span>
<a name="c0-138"></a><span class="lineno">138</span> <span class="cm">         * commit.</span>
<a name="c0-139"></a><span class="lineno">139</span> <span class="cm">         */</span>
<a name="c0-140"></a><span class="lineno">140</span>        <span class="k">if</span> <span class="p">(</span><span class="n">graph_show_remainder</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">))</span>
<a name="c0-141"></a><span class="lineno">141</span>          <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-142"></a><span class="lineno">142</span>        <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commit_format</span> <span class="o">==</span> <span class="n">CMIT_FMT_ONELINE</span><span class="p">)</span>
<a name="c0-143"></a><span class="lineno">143</span>          <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-144"></a><span class="lineno">144</span>      <span class="p">}</span>
<a name="c0-145"></a><span class="lineno">145</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-146"></a><span class="lineno">146</span>      <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commit_format</span> <span class="o">!=</span> <span class="n">CMIT_FMT_USERFORMAT</span> <span class="o">||</span>
<a name="c0-147"></a><span class="lineno">147</span>          <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-148"></a><span class="lineno">148</span>        <span class="n">fwrite</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
<a name="c0-149"></a><span class="lineno">149</span>        <span class="n">putchar</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr_termination</span><span class="p">);</span>
<a name="c0-150"></a><span class="lineno">150</span>      <span class="p">}</span>
<a name="c0-151"></a><span class="lineno">151</span>    <span class="p">}</span>
<a name="c0-152"></a><span class="lineno">152</span>    <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-153"></a><span class="lineno">153</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-154"></a><span class="lineno">154</span>    <span class="k">if</span> <span class="p">(</span><span class="n">graph_show_remainder</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">graph</span><span class="p">))</span>
<a name="c0-155"></a><span class="lineno">155</span>      <span class="n">putchar</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-156"></a><span class="lineno">156</span>  <span class="p">}</span>
<a name="c0-157"></a><span class="lineno">157</span>  <span class="n">maybe_flush_or_die</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"stdout"</span><span class="p">);</span>
<a name="c0-158"></a><span class="lineno">158</span>  <span class="n">finish_commit</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<a name="c0-159"></a><span class="lineno">159</span> <span class="p">}</span>
<a name="c0-160"></a><span class="lineno">160</span> 
<a name="c0-161"></a><span class="lineno">161</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c0-162"></a><span class="lineno">162</span> <span class="p">{</span>
<a name="c0-163"></a><span class="lineno">163</span>  <span class="k">if</span> <span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">parents</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-164"></a><span class="lineno">164</span>    <span class="n">free_commit_list</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">parents</span><span class="p">);</span>
<a name="c0-165"></a><span class="lineno">165</span>    <span class="n">commit</span><span class="o">-&gt;</span><span class="n">parents</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-166"></a><span class="lineno">166</span>  <span class="p">}</span>
<a name="c0-167"></a><span class="lineno">167</span>  <span class="n">free</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<a name="c0-168"></a><span class="lineno">168</span>  <span class="n">commit</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-169"></a><span class="lineno">169</span> <span class="p">}</span>
<a name="c0-170"></a><span class="lineno">170</span> 
<a name="c0-171"></a><span class="lineno">171</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
<a name="c0-172"></a><span class="lineno">172</span>        <span class="k">const</span> <span class="k">struct</span> <span class="n">name_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
<a name="c0-173"></a><span class="lineno">173</span>        <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<a name="c0-174"></a><span class="lineno">174</span> <span class="p">{</span>
<a name="c0-175"></a><span class="lineno">175</span>  <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_BLOB</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_sha1_file</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">))</span>
<a name="c0-176"></a><span class="lineno">176</span>    <span class="n">die</span><span class="p">(</span><span class="s">"missing blob object '%s'"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-177"></a><span class="lineno">177</span> <span class="p">}</span>
<a name="c0-178"></a><span class="lineno">178</span> 
<a name="c0-179"></a><span class="lineno">179</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
<a name="c0-180"></a><span class="lineno">180</span>      <span class="k">const</span> <span class="k">struct</span> <span class="n">name_path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">component</span><span class="p">,</span>
<a name="c0-181"></a><span class="lineno">181</span>      <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<a name="c0-182"></a><span class="lineno">182</span> <span class="p">{</span>
<a name="c0-183"></a><span class="lineno">183</span>  <span class="k">struct</span> <span class="n">rev_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">cb_data</span><span class="p">;</span>
<a name="c0-184"></a><span class="lineno">184</span> 
<a name="c0-185"></a><span class="lineno">185</span>  <span class="n">finish_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">cb_data</span><span class="p">);</span>
<a name="c0-186"></a><span class="lineno">186</span>  <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">verify_objects</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_COMMIT</span><span class="p">)</span>
<a name="c0-187"></a><span class="lineno">187</span>    <span class="n">parse_object</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-188"></a><span class="lineno">188</span>  <span class="n">show_object_with_name</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">component</span><span class="p">);</span>
<a name="c0-189"></a><span class="lineno">189</span> <span class="p">}</span>
<a name="c0-190"></a><span class="lineno">190</span> 
<a name="c0-191"></a><span class="lineno">191</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">)</span>
<a name="c0-192"></a><span class="lineno">192</span> <span class="p">{</span>
<a name="c0-193"></a><span class="lineno">193</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"-%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">commit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-194"></a><span class="lineno">194</span> <span class="p">}</span>
<a name="c0-195"></a><span class="lineno">195</span> 
<a name="c0-196"></a><span class="lineno">196</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">log2i</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<a name="c0-197"></a><span class="lineno">197</span> <span class="p">{</span>
<a name="c0-198"></a><span class="lineno">198</span>  <span class="kt">int</span> <span class="n">log2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-199"></a><span class="lineno">199</span> 
<a name="c0-200"></a><span class="lineno">200</span>  <span class="k">for</span> <span class="p">(;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-201"></a><span class="lineno">201</span>    <span class="n">log2</span><span class="o">++</span><span class="p">;</span>
<a name="c0-202"></a><span class="lineno">202</span> 
<a name="c0-203"></a><span class="lineno">203</span>  <span class="k">return</span> <span class="n">log2</span><span class="p">;</span>
<a name="c0-204"></a><span class="lineno">204</span> <span class="p">}</span>
<a name="c0-205"></a><span class="lineno">205</span> 
<a name="c0-206"></a><span class="lineno">206</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">exp2i</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<a name="c0-207"></a><span class="lineno">207</span> <span class="p">{</span>
<a name="c0-208"></a><span class="lineno">208</span>  <span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-209"></a><span class="lineno">209</span> <span class="p">}</span>
<a name="c0-210"></a><span class="lineno">210</span> 
<a name="c0-211"></a><span class="lineno">211</span> <span class="cm">/*</span>
<a name="c0-212"></a><span class="lineno">212</span> <span class="cm"> * Estimate the number of bisect steps left (after the current step)</span>
<a name="c0-213"></a><span class="lineno">213</span> <span class="cm"> *</span>
<a name="c0-214"></a><span class="lineno">214</span> <span class="cm"> * For any x between 0 included and 2^n excluded, the probability for</span>
<a name="c0-215"></a><span class="lineno">215</span> <span class="cm"> * n - 1 steps left looks like:</span>
<a name="c0-216"></a><span class="lineno">216</span> <span class="cm"> *</span>
<a name="c0-217"></a><span class="lineno">217</span> <span class="cm"> * P(2^n + x) == (2^n - x) / (2^n + x)</span>
<a name="c0-218"></a><span class="lineno">218</span> <span class="cm"> *</span>
<a name="c0-219"></a><span class="lineno">219</span> <span class="cm"> * and P(2^n + x) &lt; 0.5 means 2^n &lt; 3x</span>
<a name="c0-220"></a><span class="lineno">220</span> <span class="cm"> */</span>
<a name="c0-221"></a><span class="lineno">221</span> <span class="kt">int</span> <span class="nf">estimate_bisect_steps</span><span class="p">(</span><span class="kt">int</span> <span class="n">all</span><span class="p">)</span>
<a name="c0-222"></a><span class="lineno">222</span> <span class="p">{</span>
<a name="c0-223"></a><span class="lineno">223</span>  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">e</span><span class="p">;</span>
<a name="c0-224"></a><span class="lineno">224</span> 
<a name="c0-225"></a><span class="lineno">225</span>  <span class="k">if</span> <span class="p">(</span><span class="n">all</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
<a name="c0-226"></a><span class="lineno">226</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-227"></a><span class="lineno">227</span> 
<a name="c0-228"></a><span class="lineno">228</span>  <span class="n">n</span> <span class="o">=</span> <span class="n">log2i</span><span class="p">(</span><span class="n">all</span><span class="p">);</span>
<a name="c0-229"></a><span class="lineno">229</span>  <span class="n">e</span> <span class="o">=</span> <span class="n">exp2i</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<a name="c0-230"></a><span class="lineno">230</span>  <span class="n">x</span> <span class="o">=</span> <span class="n">all</span> <span class="o">-</span> <span class="n">e</span><span class="p">;</span>
<a name="c0-231"></a><span class="lineno">231</span> 
<a name="c0-232"></a><span class="lineno">232</span>  <span class="k">return</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-233"></a><span class="lineno">233</span> <span class="p">}</span>
<a name="c0-234"></a><span class="lineno">234</span> 
<a name="c0-235"></a><span class="lineno">235</span> <span class="kt">void</span> <span class="nf">print_commit_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
<a name="c0-236"></a><span class="lineno">236</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format_cur</span><span class="p">,</span>
<a name="c0-237"></a><span class="lineno">237</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format_last</span><span class="p">)</span>
<a name="c0-238"></a><span class="lineno">238</span> <span class="p">{</span>
<a name="c0-239"></a><span class="lineno">239</span>  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">list</span><span class="p">;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-240"></a><span class="lineno">240</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">?</span> <span class="n">format_cur</span> <span class="o">:</span> <span class="n">format_last</span><span class="p">;</span>
<a name="c0-241"></a><span class="lineno">241</span>    <span class="n">printf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-242"></a><span class="lineno">242</span>  <span class="p">}</span>
<a name="c0-243"></a><span class="lineno">243</span> <span class="p">}</span>
<a name="c0-244"></a><span class="lineno">244</span> 
<a name="c0-245"></a><span class="lineno">245</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_tried_revs</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">tried</span><span class="p">)</span>
<a name="c0-246"></a><span class="lineno">246</span> <span class="p">{</span>
<a name="c0-247"></a><span class="lineno">247</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"bisect_tried='"</span><span class="p">);</span>
<a name="c0-248"></a><span class="lineno">248</span>  <span class="n">print_commit_list</span><span class="p">(</span><span class="n">tried</span><span class="p">,</span> <span class="s">"%s|"</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">);</span>
<a name="c0-249"></a><span class="lineno">249</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"'</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c0-250"></a><span class="lineno">250</span> <span class="p">}</span>
<a name="c0-251"></a><span class="lineno">251</span> 
<a name="c0-252"></a><span class="lineno">252</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">print_var_str</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<a name="c0-253"></a><span class="lineno">253</span> <span class="p">{</span>
<a name="c0-254"></a><span class="lineno">254</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"%s='%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<a name="c0-255"></a><span class="lineno">255</span> <span class="p">}</span>
<a name="c0-256"></a><span class="lineno">256</span> 
<a name="c0-257"></a><span class="lineno">257</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">print_var_int</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<a name="c0-258"></a><span class="lineno">258</span> <span class="p">{</span>
<a name="c0-259"></a><span class="lineno">259</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"%s=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<a name="c0-260"></a><span class="lineno">260</span> <span class="p">}</span>
<a name="c0-261"></a><span class="lineno">261</span> 
<a name="c0-262"></a><span class="lineno">262</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">show_bisect_vars</span><span class="p">(</span><span class="k">struct</span> <span class="n">rev_list_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reaches</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all</span><span class="p">)</span>
<a name="c0-263"></a><span class="lineno">263</span> <span class="p">{</span>
<a name="c0-264"></a><span class="lineno">264</span>  <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bisect_show_flags</span><span class="p">;</span>
<a name="c0-265"></a><span class="lineno">265</span>  <span class="kt">char</span> <span class="n">hex</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-266"></a><span class="lineno">266</span>  <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">tried</span><span class="p">;</span>
<a name="c0-267"></a><span class="lineno">267</span>  <span class="k">struct</span> <span class="n">rev_info</span> <span class="o">*</span><span class="n">revs</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">revs</span><span class="p">;</span>
<a name="c0-268"></a><span class="lineno">268</span> 
<a name="c0-269"></a><span class="lineno">269</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commits</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BISECT_SHOW_TRIED</span><span class="p">))</span>
<a name="c0-270"></a><span class="lineno">270</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-271"></a><span class="lineno">271</span> 
<a name="c0-272"></a><span class="lineno">272</span>  <span class="n">revs</span><span class="o">-&gt;</span><span class="n">commits</span> <span class="o">=</span> <span class="n">filter_skipped</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tried</span><span class="p">,</span>
<a name="c0-273"></a><span class="lineno">273</span>               <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BISECT_SHOW_ALL</span><span class="p">,</span>
<a name="c0-274"></a><span class="lineno">274</span>               <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-275"></a><span class="lineno">275</span> 
<a name="c0-276"></a><span class="lineno">276</span>  <span class="cm">/*</span>
<a name="c0-277"></a><span class="lineno">277</span> <span class="cm">   * revs-&gt;commits can reach "reaches" commits among</span>
<a name="c0-278"></a><span class="lineno">278</span> <span class="cm">   * "all" commits.  If it is good, then there are</span>
<a name="c0-279"></a><span class="lineno">279</span> <span class="cm">   * (all-reaches) commits left to be bisected.</span>
<a name="c0-280"></a><span class="lineno">280</span> <span class="cm">   * On the other hand, if it is bad, then the set</span>
<a name="c0-281"></a><span class="lineno">281</span> <span class="cm">   * to bisect is "reaches".</span>
<a name="c0-282"></a><span class="lineno">282</span> <span class="cm">   * A bisect set of size N has (N-1) commits further</span>
<a name="c0-283"></a><span class="lineno">283</span> <span class="cm">   * to test, as we already know one bad one.</span>
<a name="c0-284"></a><span class="lineno">284</span> <span class="cm">   */</span>
<a name="c0-285"></a><span class="lineno">285</span>  <span class="n">cnt</span> <span class="o">=</span> <span class="n">all</span> <span class="o">-</span> <span class="n">reaches</span><span class="p">;</span>
<a name="c0-286"></a><span class="lineno">286</span>  <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">reaches</span><span class="p">)</span>
<a name="c0-287"></a><span class="lineno">287</span>    <span class="n">cnt</span> <span class="o">=</span> <span class="n">reaches</span><span class="p">;</span>
<a name="c0-288"></a><span class="lineno">288</span> 
<a name="c0-289"></a><span class="lineno">289</span>  <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commits</span><span class="p">)</span>
<a name="c0-290"></a><span class="lineno">290</span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">hex</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">revs</span><span class="o">-&gt;</span><span class="n">commits</span><span class="o">-&gt;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-291"></a><span class="lineno">291</span> 
<a name="c0-292"></a><span class="lineno">292</span>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BISECT_SHOW_ALL</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-293"></a><span class="lineno">293</span>    <span class="n">traverse_commit_list</span><span class="p">(</span><span class="n">revs</span><span class="p">,</span> <span class="n">show_commit</span><span class="p">,</span> <span class="n">show_object</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<a name="c0-294"></a><span class="lineno">294</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"------</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c0-295"></a><span class="lineno">295</span>  <span class="p">}</span>
<a name="c0-296"></a><span class="lineno">296</span> 
<a name="c0-297"></a><span class="lineno">297</span>  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BISECT_SHOW_TRIED</span><span class="p">)</span>
<a name="c0-298"></a><span class="lineno">298</span>    <span class="n">show_tried_revs</span><span class="p">(</span><span class="n">tried</span><span class="p">);</span>
<a name="c0-299"></a><span class="lineno">299</span> 
<a name="c0-300"></a><span class="lineno">300</span>  <span class="n">print_var_str</span><span class="p">(</span><span class="s">"bisect_rev"</span><span class="p">,</span> <span class="n">hex</span><span class="p">);</span>
<a name="c0-301"></a><span class="lineno">301</span>  <span class="n">print_var_int</span><span class="p">(</span><span class="s">"bisect_nr"</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-302"></a><span class="lineno">302</span>  <span class="n">print_var_int</span><span class="p">(</span><span class="s">"bisect_good"</span><span class="p">,</span> <span class="n">all</span> <span class="o">-</span> <span class="n">reaches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-303"></a><span class="lineno">303</span>  <span class="n">print_var_int</span><span class="p">(</span><span class="s">"bisect_bad"</span><span class="p">,</span> <span class="n">reaches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-304"></a><span class="lineno">304</span>  <span class="n">print_var_int</span><span class="p">(</span><span class="s">"bisect_all"</span><span class="p">,</span> <span class="n">all</span><span class="p">);</span>
<a name="c0-305"></a><span class="lineno">305</span>  <span class="n">print_var_int</span><span class="p">(</span><span class="s">"bisect_steps"</span><span class="p">,</span> <span class="n">estimate_bisect_steps</span><span class="p">(</span><span class="n">all</span><span class="p">));</span>
<a name="c0-306"></a><span class="lineno">306</span> 
<a name="c0-307"></a><span class="lineno">307</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-308"></a><span class="lineno">308</span> <span class="p">}</span>
<a name="c0-309"></a><span class="lineno">309</span> 
<a name="c0-310"></a><span class="lineno">310</span> <span class="kt">int</span> <span class="nf">cmd_rev_list</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<a name="c0-311"></a><span class="lineno">311</span> <span class="p">{</span>
<a name="c0-312"></a><span class="lineno">312</span>  <span class="k">struct</span> <span class="n">rev_info</span> <span class="n">revs</span><span class="p">;</span>
<a name="c0-313"></a><span class="lineno">313</span>  <span class="k">struct</span> <span class="n">rev_list_info</span> <span class="n">info</span><span class="p">;</span>
<a name="c0-314"></a><span class="lineno">314</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-315"></a><span class="lineno">315</span>  <span class="kt">int</span> <span class="n">bisect_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-316"></a><span class="lineno">316</span>  <span class="kt">int</span> <span class="n">bisect_show_vars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-317"></a><span class="lineno">317</span>  <span class="kt">int</span> <span class="n">bisect_find_all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-318"></a><span class="lineno">318</span>  <span class="kt">int</span> <span class="n">quiet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-319"></a><span class="lineno">319</span> 
<a name="c0-320"></a><span class="lineno">320</span>  <span class="n">git_config</span><span class="p">(</span><span class="n">git_default_config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-321"></a><span class="lineno">321</span>  <span class="n">init_revisions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
<a name="c0-322"></a><span class="lineno">322</span>  <span class="n">revs</span><span class="p">.</span><span class="n">abbrev</span> <span class="o">=</span> <span class="n">DEFAULT_ABBREV</span><span class="p">;</span>
<a name="c0-323"></a><span class="lineno">323</span>  <span class="n">revs</span><span class="p">.</span><span class="n">commit_format</span> <span class="o">=</span> <span class="n">CMIT_FMT_UNSPECIFIED</span><span class="p">;</span>
<a name="c0-324"></a><span class="lineno">324</span>  <span class="n">argc</span> <span class="o">=</span> <span class="n">setup_revisions</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-325"></a><span class="lineno">325</span> 
<a name="c0-326"></a><span class="lineno">326</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
<a name="c0-327"></a><span class="lineno">327</span>  <span class="n">info</span><span class="p">.</span><span class="n">revs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">revs</span><span class="p">;</span>
<a name="c0-328"></a><span class="lineno">328</span>  <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">bisect</span><span class="p">)</span>
<a name="c0-329"></a><span class="lineno">329</span>    <span class="n">bisect_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-330"></a><span class="lineno">330</span> 
<a name="c0-331"></a><span class="lineno">331</span>  <span class="n">quiet</span> <span class="o">=</span> <span class="n">DIFF_OPT_TST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">.</span><span class="n">diffopt</span><span class="p">,</span> <span class="n">QUICK</span><span class="p">);</span>
<a name="c0-332"></a><span class="lineno">332</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-333"></a><span class="lineno">333</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-334"></a><span class="lineno">334</span> 
<a name="c0-335"></a><span class="lineno">335</span> <span class="hll">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--header"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-336"></a><span class="lineno">336</span> <span class="hll">      <span class="n">revs</span><span class="p">.</span><span class="n">verbose_header</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c0-337"></a><span class="lineno">337</span> <span class="hll">      <span class="k">continue</span><span class="p">;</span>
</span><a name="c0-338"></a><span class="lineno">338</span> <span class="hll">    <span class="p">}</span>
</span><a name="c0-339"></a><span class="lineno">339</span> <span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--timestamp"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-340"></a><span class="lineno">340</span> <span class="hll">      <span class="n">info</span><span class="p">.</span><span class="n">show_timestamp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c0-341"></a><span class="lineno">341</span> <span class="hll">      <span class="k">continue</span><span class="p">;</span>
</span><a name="c0-342"></a><span class="lineno">342</span> <span class="hll">    <span class="p">}</span>
</span><a name="c0-343"></a><span class="lineno">343</span> <span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--bisect"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-344"></a><span class="lineno">344</span> <span class="hll">      <span class="n">bisect_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c0-345"></a><span class="lineno">345</span> <span class="hll">      <span class="k">continue</span><span class="p">;</span>
</span><a name="c0-346"></a><span class="lineno">346</span> <span class="hll">    <span class="p">}</span>
</span><a name="c0-347"></a><span class="lineno">347</span> <span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--bisect-all"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c0-348"></a><span class="lineno">348</span>       <span class="n">bisect_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-349"></a><span class="lineno">349</span>      <span class="n">bisect_find_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-350"></a><span class="lineno">350</span>      <span class="n">info</span><span class="p">.</span><span class="n">bisect_show_flags</span> <span class="o">=</span> <span class="n">BISECT_SHOW_ALL</span><span class="p">;</span>
<a name="c0-351"></a><span class="lineno">351</span>      <span class="n">revs</span><span class="p">.</span><span class="n">show_decorations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-352"></a><span class="lineno">352</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-353"></a><span class="lineno">353</span>    <span class="p">}</span>
<a name="c0-354"></a><span class="lineno">354</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--bisect-vars"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-355"></a><span class="lineno">355</span>      <span class="n">bisect_list</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-356"></a><span class="lineno">356</span>      <span class="n">bisect_show_vars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-357"></a><span class="lineno">357</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-358"></a><span class="lineno">358</span>    <span class="p">}</span>
<a name="c0-359"></a><span class="lineno">359</span>    <span class="n">usage</span><span class="p">(</span><span class="n">rev_list_usage</span><span class="p">);</span>
<a name="c0-360"></a><span class="lineno">360</span> 
<a name="c0-361"></a><span class="lineno">361</span>  <span class="p">}</span>
<a name="c0-362"></a><span class="lineno">362</span>  <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">commit_format</span> <span class="o">!=</span> <span class="n">CMIT_FMT_UNSPECIFIED</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-363"></a><span class="lineno">363</span>    <span class="cm">/* The command line has a --pretty  */</span>
<a name="c0-364"></a><span class="lineno">364</span>    <span class="n">info</span><span class="p">.</span><span class="n">hdr_termination</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c0-365"></a><span class="lineno">365</span>    <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">commit_format</span> <span class="o">==</span> <span class="n">CMIT_FMT_ONELINE</span><span class="p">)</span>
<a name="c0-366"></a><span class="lineno">366</span>      <span class="n">info</span><span class="p">.</span><span class="n">header_prefix</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-367"></a><span class="lineno">367</span>    <span class="k">else</span>
<a name="c0-368"></a><span class="lineno">368</span>      <span class="n">info</span><span class="p">.</span><span class="n">header_prefix</span> <span class="o">=</span> <span class="s">"commit "</span><span class="p">;</span>
<a name="c0-369"></a><span class="lineno">369</span>  <span class="p">}</span>
<a name="c0-370"></a><span class="lineno">370</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">verbose_header</span><span class="p">)</span>
<a name="c0-371"></a><span class="lineno">371</span>    <span class="cm">/* Only --header was specified */</span>
<a name="c0-372"></a><span class="lineno">372</span>    <span class="n">revs</span><span class="p">.</span><span class="n">commit_format</span> <span class="o">=</span> <span class="n">CMIT_FMT_RAW</span><span class="p">;</span>
<a name="c0-373"></a><span class="lineno">373</span> 
<a name="c0-374"></a><span class="lineno">374</span>  <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">revs</span><span class="p">.</span><span class="n">commits</span> <span class="o">&amp;&amp;</span>
<a name="c0-375"></a><span class="lineno">375</span>       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">tag_objects</span><span class="o">||</span><span class="n">revs</span><span class="p">.</span><span class="n">tree_objects</span><span class="o">||</span><span class="n">revs</span><span class="p">.</span><span class="n">blob_objects</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-376"></a><span class="lineno">376</span>        <span class="o">!</span><span class="n">revs</span><span class="p">.</span><span class="n">pending</span><span class="p">.</span><span class="n">nr</span><span class="p">))</span> <span class="o">||</span>
<a name="c0-377"></a><span class="lineno">377</span>      <span class="n">revs</span><span class="p">.</span><span class="n">diff</span><span class="p">)</span>
<a name="c0-378"></a><span class="lineno">378</span>    <span class="n">usage</span><span class="p">(</span><span class="n">rev_list_usage</span><span class="p">);</span>
<a name="c0-379"></a><span class="lineno">379</span> 
<a name="c0-380"></a><span class="lineno">380</span>  <span class="n">save_commit_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">verbose_header</span> <span class="o">||</span>
<a name="c0-381"></a><span class="lineno">381</span>            <span class="n">revs</span><span class="p">.</span><span class="n">grep_filter</span><span class="p">.</span><span class="n">pattern_list</span> <span class="o">||</span>
<a name="c0-382"></a><span class="lineno">382</span>            <span class="n">revs</span><span class="p">.</span><span class="n">grep_filter</span><span class="p">.</span><span class="n">header_list</span><span class="p">);</span>
<a name="c0-383"></a><span class="lineno">383</span>  <span class="k">if</span> <span class="p">(</span><span class="n">bisect_list</span><span class="p">)</span>
<a name="c0-384"></a><span class="lineno">384</span>    <span class="n">revs</span><span class="p">.</span><span class="n">limited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-385"></a><span class="lineno">385</span> 
<a name="c0-386"></a><span class="lineno">386</span>  <span class="k">if</span> <span class="p">(</span><span class="n">prepare_revision_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">))</span>
<a name="c0-387"></a><span class="lineno">387</span>    <span class="n">die</span><span class="p">(</span><span class="s">"revision walk setup failed"</span><span class="p">);</span>
<a name="c0-388"></a><span class="lineno">388</span>  <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">tree_objects</span><span class="p">)</span>
<a name="c0-389"></a><span class="lineno">389</span>    <span class="n">mark_edges_uninteresting</span><span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">commits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span> <span class="n">show_edge</span><span class="p">);</span>
<a name="c0-390"></a><span class="lineno">390</span> 
<a name="c0-391"></a><span class="lineno">391</span>  <span class="k">if</span> <span class="p">(</span><span class="n">bisect_list</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-392"></a><span class="lineno">392</span>    <span class="kt">int</span> <span class="n">reaches</span> <span class="o">=</span> <span class="n">reaches</span><span class="p">,</span> <span class="n">all</span> <span class="o">=</span> <span class="n">all</span><span class="p">;</span>
<a name="c0-393"></a><span class="lineno">393</span> 
<a name="c0-394"></a><span class="lineno">394</span>    <span class="n">revs</span><span class="p">.</span><span class="n">commits</span> <span class="o">=</span> <span class="n">find_bisection</span><span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">commits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reaches</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all</span><span class="p">,</span>
<a name="c0-395"></a><span class="lineno">395</span>                <span class="n">bisect_find_all</span><span class="p">);</span>
<a name="c0-396"></a><span class="lineno">396</span> 
<a name="c0-397"></a><span class="lineno">397</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bisect_show_vars</span><span class="p">)</span>
<a name="c0-398"></a><span class="lineno">398</span>      <span class="k">return</span> <span class="n">show_bisect_vars</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">reaches</span><span class="p">,</span> <span class="n">all</span><span class="p">);</span>
<a name="c0-399"></a><span class="lineno">399</span>  <span class="p">}</span>
<a name="c0-400"></a><span class="lineno">400</span> 
<a name="c0-401"></a><span class="lineno">401</span>  <span class="n">traverse_commit_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">revs</span><span class="p">,</span>
<a name="c0-402"></a><span class="lineno">402</span>           <span class="n">quiet</span> <span class="o">?</span> <span class="n">finish_commit</span> <span class="o">:</span> <span class="n">show_commit</span><span class="p">,</span>
<a name="c0-403"></a><span class="lineno">403</span>           <span class="n">quiet</span> <span class="o">?</span> <span class="n">finish_object</span> <span class="o">:</span> <span class="n">show_object</span><span class="p">,</span>
<a name="c0-404"></a><span class="lineno">404</span>           <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<a name="c0-405"></a><span class="lineno">405</span> 
<a name="c0-406"></a><span class="lineno">406</span>  <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-407"></a><span class="lineno">407</span>    <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">left_right</span> <span class="o">&amp;&amp;</span> <span class="n">revs</span><span class="p">.</span><span class="n">cherry_mark</span><span class="p">)</span>
<a name="c0-408"></a><span class="lineno">408</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_left</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_right</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_same</span><span class="p">);</span>
<a name="c0-409"></a><span class="lineno">409</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">left_right</span><span class="p">)</span>
<a name="c0-410"></a><span class="lineno">410</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_left</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_right</span><span class="p">);</span>
<a name="c0-411"></a><span class="lineno">411</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">revs</span><span class="p">.</span><span class="n">cherry_mark</span><span class="p">)</span>
<a name="c0-412"></a><span class="lineno">412</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_left</span> <span class="o">+</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_right</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_same</span><span class="p">);</span>
<a name="c0-413"></a><span class="lineno">413</span>    <span class="k">else</span>
<a name="c0-414"></a><span class="lineno">414</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_left</span> <span class="o">+</span> <span class="n">revs</span><span class="p">.</span><span class="n">count_right</span><span class="p">);</span>
<a name="c0-415"></a><span class="lineno">415</span>  <span class="p">}</span>
<a name="c0-416"></a><span class="lineno">416</span> 
<a name="c0-417"></a><span class="lineno">417</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-418"></a><span class="lineno">418</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> builtin/send-pack.c 
                <small> (446,4)-(458,4)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">  1</span> <span class="cp">#include "builtin.h"</span>
<a name="c1-2"></a><span class="lineno">  2</span> <span class="cp">#include "commit.h"</span>
<a name="c1-3"></a><span class="lineno">  3</span> <span class="cp">#include "refs.h"</span>
<a name="c1-4"></a><span class="lineno">  4</span> <span class="cp">#include "pkt-line.h"</span>
<a name="c1-5"></a><span class="lineno">  5</span> <span class="cp">#include "sideband.h"</span>
<a name="c1-6"></a><span class="lineno">  6</span> <span class="cp">#include "run-command.h"</span>
<a name="c1-7"></a><span class="lineno">  7</span> <span class="cp">#include "remote.h"</span>
<a name="c1-8"></a><span class="lineno">  8</span> <span class="cp">#include "send-pack.h"</span>
<a name="c1-9"></a><span class="lineno">  9</span> <span class="cp">#include "quote.h"</span>
<a name="c1-10"></a><span class="lineno"> 10</span> <span class="cp">#include "transport.h"</span>
<a name="c1-11"></a><span class="lineno"> 11</span> 
<a name="c1-12"></a><span class="lineno"> 12</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">send_pack_usage</span><span class="p">[]</span> <span class="o">=</span>
<a name="c1-13"></a><span class="lineno"> 13</span> <span class="s">"git send-pack [--all | --mirror] [--dry-run] [--force] [--receive-pack=&lt;git-receive-pack&gt;] [--verbose] [--thin] [&lt;host&gt;:]&lt;directory&gt; [&lt;ref&gt;...]</span><span class="se">\n</span><span class="s">"</span>
<a name="c1-14"></a><span class="lineno"> 14</span> <span class="s">"  --all and explicit &lt;ref&gt; specification are mutually exclusive."</span><span class="p">;</span>
<a name="c1-15"></a><span class="lineno"> 15</span> 
<a name="c1-16"></a><span class="lineno"> 16</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">send_pack_args</span> <span class="n">args</span><span class="p">;</span>
<a name="c1-17"></a><span class="lineno"> 17</span> 
<a name="c1-18"></a><span class="lineno"> 18</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">feed_object</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">negative</span><span class="p">)</span>
<a name="c1-19"></a><span class="lineno"> 19</span> <span class="p">{</span>
<a name="c1-20"></a><span class="lineno"> 20</span>   <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">42</span><span class="p">];</span>
<a name="c1-21"></a><span class="lineno"> 21</span> 
<a name="c1-22"></a><span class="lineno"> 22</span>   <span class="k">if</span> <span class="p">(</span><span class="n">negative</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_sha1_file</span><span class="p">(</span><span class="n">sha1</span><span class="p">))</span>
<a name="c1-23"></a><span class="lineno"> 23</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-24"></a><span class="lineno"> 24</span> 
<a name="c1-25"></a><span class="lineno"> 25</span>   <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">negative</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">),</span> <span class="mi">40</span><span class="p">);</span>
<a name="c1-26"></a><span class="lineno"> 26</span>   <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
<a name="c1-27"></a><span class="lineno"> 27</span>     <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'^'</span><span class="p">;</span>
<a name="c1-28"></a><span class="lineno"> 28</span>   <span class="n">buf</span><span class="p">[</span><span class="mi">40</span> <span class="o">+</span> <span class="n">negative</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c1-29"></a><span class="lineno"> 29</span>   <span class="k">return</span> <span class="n">write_or_whine</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">41</span> <span class="o">+</span> <span class="n">negative</span><span class="p">,</span> <span class="s">"send-pack: send refs"</span><span class="p">);</span>
<a name="c1-30"></a><span class="lineno"> 30</span> <span class="p">}</span>
<a name="c1-31"></a><span class="lineno"> 31</span> 
<a name="c1-32"></a><span class="lineno"> 32</span> <span class="cm">/*</span>
<a name="c1-33"></a><span class="lineno"> 33</span> <span class="cm"> * Make a pack stream and spit it out into file descriptor fd</span>
<a name="c1-34"></a><span class="lineno"> 34</span> <span class="cm"> */</span>
<a name="c1-35"></a><span class="lineno"> 35</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">pack_objects</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">refs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">extra_have_objects</span> <span class="o">*</span><span class="n">extra</span><span class="p">,</span> <span class="k">struct</span> <span class="n">send_pack_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a name="c1-36"></a><span class="lineno"> 36</span> <span class="p">{</span>
<a name="c1-37"></a><span class="lineno"> 37</span>   <span class="cm">/*</span>
<a name="c1-38"></a><span class="lineno"> 38</span> <span class="cm">  * The child becomes pack-objects --revs; we feed</span>
<a name="c1-39"></a><span class="lineno"> 39</span> <span class="cm">  * the revision parameters to it via its stdin and</span>
<a name="c1-40"></a><span class="lineno"> 40</span> <span class="cm">  * let its stdout go back to the other end.</span>
<a name="c1-41"></a><span class="lineno"> 41</span> <span class="cm">  */</span>
<a name="c1-42"></a><span class="lineno"> 42</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-43"></a><span class="lineno"> 43</span>     <span class="s">"pack-objects"</span><span class="p">,</span>
<a name="c1-44"></a><span class="lineno"> 44</span>     <span class="s">"--all-progress-implied"</span><span class="p">,</span>
<a name="c1-45"></a><span class="lineno"> 45</span>     <span class="s">"--revs"</span><span class="p">,</span>
<a name="c1-46"></a><span class="lineno"> 46</span>     <span class="s">"--stdout"</span><span class="p">,</span>
<a name="c1-47"></a><span class="lineno"> 47</span>     <span class="nb">NULL</span><span class="p">,</span>
<a name="c1-48"></a><span class="lineno"> 48</span>     <span class="nb">NULL</span><span class="p">,</span>
<a name="c1-49"></a><span class="lineno"> 49</span>     <span class="nb">NULL</span><span class="p">,</span>
<a name="c1-50"></a><span class="lineno"> 50</span>     <span class="nb">NULL</span><span class="p">,</span>
<a name="c1-51"></a><span class="lineno"> 51</span>     <span class="nb">NULL</span><span class="p">,</span>
<a name="c1-52"></a><span class="lineno"> 52</span>   <span class="p">};</span>
<a name="c1-53"></a><span class="lineno"> 53</span>   <span class="k">struct</span> <span class="n">child_process</span> <span class="n">po</span><span class="p">;</span>
<a name="c1-54"></a><span class="lineno"> 54</span>   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-55"></a><span class="lineno"> 55</span> 
<a name="c1-56"></a><span class="lineno"> 56</span>   <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<a name="c1-57"></a><span class="lineno"> 57</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">use_thin_pack</span><span class="p">)</span>
<a name="c1-58"></a><span class="lineno"> 58</span>     <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--thin"</span><span class="p">;</span>
<a name="c1-59"></a><span class="lineno"> 59</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">use_ofs_delta</span><span class="p">)</span>
<a name="c1-60"></a><span class="lineno"> 60</span>     <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--delta-base-offset"</span><span class="p">;</span>
<a name="c1-61"></a><span class="lineno"> 61</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">quiet</span><span class="p">)</span>
<a name="c1-62"></a><span class="lineno"> 62</span>     <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"-q"</span><span class="p">;</span>
<a name="c1-63"></a><span class="lineno"> 63</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">)</span>
<a name="c1-64"></a><span class="lineno"> 64</span>     <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--progress"</span><span class="p">;</span>
<a name="c1-65"></a><span class="lineno"> 65</span>   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">po</span><span class="p">));</span>
<a name="c1-66"></a><span class="lineno"> 66</span>   <span class="n">po</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span><span class="p">;</span>
<a name="c1-67"></a><span class="lineno"> 67</span>   <span class="n">po</span><span class="p">.</span><span class="n">in</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-68"></a><span class="lineno"> 68</span>   <span class="n">po</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">stateless_rpc</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">fd</span><span class="p">;</span>
<a name="c1-69"></a><span class="lineno"> 69</span>   <span class="n">po</span><span class="p">.</span><span class="n">git_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-70"></a><span class="lineno"> 70</span>   <span class="k">if</span> <span class="p">(</span><span class="n">start_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="p">))</span>
<a name="c1-71"></a><span class="lineno"> 71</span>     <span class="n">die_errno</span><span class="p">(</span><span class="s">"git pack-objects failed"</span><span class="p">);</span>
<a name="c1-72"></a><span class="lineno"> 72</span> 
<a name="c1-73"></a><span class="lineno"> 73</span>   <span class="cm">/*</span>
<a name="c1-74"></a><span class="lineno"> 74</span> <span class="cm">  * We feed the pack-objects we just spawned with revision</span>
<a name="c1-75"></a><span class="lineno"> 75</span> <span class="cm">  * parameters by writing to the pipe.</span>
<a name="c1-76"></a><span class="lineno"> 76</span> <span class="cm">  */</span>
<a name="c1-77"></a><span class="lineno"> 77</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">extra</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-78"></a><span class="lineno"> 78</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feed_object</span><span class="p">(</span><span class="n">extra</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">po</span><span class="p">.</span><span class="n">in</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="c1-79"></a><span class="lineno"> 79</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-80"></a><span class="lineno"> 80</span> 
<a name="c1-81"></a><span class="lineno"> 81</span>   <span class="k">while</span> <span class="p">(</span><span class="n">refs</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-82"></a><span class="lineno"> 82</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_null_sha1</span><span class="p">(</span><span class="n">refs</span><span class="o">-&gt;</span><span class="n">old_sha1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-83"></a><span class="lineno"> 83</span>         <span class="o">!</span><span class="n">feed_object</span><span class="p">(</span><span class="n">refs</span><span class="o">-&gt;</span><span class="n">old_sha1</span><span class="p">,</span> <span class="n">po</span><span class="p">.</span><span class="n">in</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="c1-84"></a><span class="lineno"> 84</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-85"></a><span class="lineno"> 85</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_null_sha1</span><span class="p">(</span><span class="n">refs</span><span class="o">-&gt;</span><span class="n">new_sha1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-86"></a><span class="lineno"> 86</span>         <span class="o">!</span><span class="n">feed_object</span><span class="p">(</span><span class="n">refs</span><span class="o">-&gt;</span><span class="n">new_sha1</span><span class="p">,</span> <span class="n">po</span><span class="p">.</span><span class="n">in</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a name="c1-87"></a><span class="lineno"> 87</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-88"></a><span class="lineno"> 88</span>     <span class="n">refs</span> <span class="o">=</span> <span class="n">refs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-89"></a><span class="lineno"> 89</span>   <span class="p">}</span>
<a name="c1-90"></a><span class="lineno"> 90</span> 
<a name="c1-91"></a><span class="lineno"> 91</span>   <span class="n">close</span><span class="p">(</span><span class="n">po</span><span class="p">.</span><span class="n">in</span><span class="p">);</span>
<a name="c1-92"></a><span class="lineno"> 92</span> 
<a name="c1-93"></a><span class="lineno"> 93</span>   <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">stateless_rpc</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-94"></a><span class="lineno"> 94</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">LARGE_PACKET_MAX</span><span class="p">);</span>
<a name="c1-95"></a><span class="lineno"> 95</span>     <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-96"></a><span class="lineno"> 96</span>       <span class="kt">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">xread</span><span class="p">(</span><span class="n">po</span><span class="p">.</span><span class="n">out</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LARGE_PACKET_MAX</span><span class="p">);</span>
<a name="c1-97"></a><span class="lineno"> 97</span>       <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-98"></a><span class="lineno"> 98</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-99"></a><span class="lineno"> 99</span>       <span class="n">send_sideband</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">LARGE_PACKET_MAX</span><span class="p">);</span>
<a name="c1-100"></a><span class="lineno">100</span>    <span class="p">}</span>
<a name="c1-101"></a><span class="lineno">101</span>    <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-102"></a><span class="lineno">102</span>    <span class="n">close</span><span class="p">(</span><span class="n">po</span><span class="p">.</span><span class="n">out</span><span class="p">);</span>
<a name="c1-103"></a><span class="lineno">103</span>    <span class="n">po</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-104"></a><span class="lineno">104</span>  <span class="p">}</span>
<a name="c1-105"></a><span class="lineno">105</span> 
<a name="c1-106"></a><span class="lineno">106</span>  <span class="k">if</span> <span class="p">(</span><span class="n">finish_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="p">))</span>
<a name="c1-107"></a><span class="lineno">107</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-108"></a><span class="lineno">108</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-109"></a><span class="lineno">109</span> <span class="p">}</span>
<a name="c1-110"></a><span class="lineno">110</span> 
<a name="c1-111"></a><span class="lineno">111</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">refs</span><span class="p">)</span>
<a name="c1-112"></a><span class="lineno">112</span> <span class="p">{</span>
<a name="c1-113"></a><span class="lineno">113</span>  <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">hint</span><span class="p">;</span>
<a name="c1-114"></a><span class="lineno">114</span>  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<a name="c1-115"></a><span class="lineno">115</span>  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-116"></a><span class="lineno">116</span>  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">packet_read_line</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">));</span>
<a name="c1-117"></a><span class="lineno">117</span>  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"unpack "</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<a name="c1-118"></a><span class="lineno">118</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"did not receive remote status"</span><span class="p">);</span>
<a name="c1-119"></a><span class="lineno">119</span>  <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"unpack ok</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-120"></a><span class="lineno">120</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-121"></a><span class="lineno">121</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-122"></a><span class="lineno">122</span>      <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c1-123"></a><span class="lineno">123</span>    <span class="n">error</span><span class="p">(</span><span class="s">"unpack failed: %s"</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
<a name="c1-124"></a><span class="lineno">124</span>    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-125"></a><span class="lineno">125</span>  <span class="p">}</span>
<a name="c1-126"></a><span class="lineno">126</span>  <span class="n">hint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-127"></a><span class="lineno">127</span>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-128"></a><span class="lineno">128</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">refname</span><span class="p">;</span>
<a name="c1-129"></a><span class="lineno">129</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<a name="c1-130"></a><span class="lineno">130</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">packet_read_line</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">));</span>
<a name="c1-131"></a><span class="lineno">131</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c1-132"></a><span class="lineno">132</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-133"></a><span class="lineno">133</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span>
<a name="c1-134"></a><span class="lineno">134</span>        <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"ok "</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"ng "</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
<a name="c1-135"></a><span class="lineno">135</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"protocol error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<a name="c1-136"></a><span class="lineno">136</span>      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-137"></a><span class="lineno">137</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-138"></a><span class="lineno">138</span>    <span class="p">}</span>
<a name="c1-139"></a><span class="lineno">139</span> 
<a name="c1-140"></a><span class="lineno">140</span>    <span class="n">line</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c1-141"></a><span class="lineno">141</span>    <span class="n">refname</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-142"></a><span class="lineno">142</span>    <span class="n">msg</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">refname</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
<a name="c1-143"></a><span class="lineno">143</span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a name="c1-144"></a><span class="lineno">144</span>      <span class="o">*</span><span class="n">msg</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c1-145"></a><span class="lineno">145</span> 
<a name="c1-146"></a><span class="lineno">146</span>    <span class="cm">/* first try searching at our hint, falling back to all refs */</span>
<a name="c1-147"></a><span class="lineno">147</span>    <span class="k">if</span> <span class="p">(</span><span class="n">hint</span><span class="p">)</span>
<a name="c1-148"></a><span class="lineno">148</span>      <span class="n">hint</span> <span class="o">=</span> <span class="n">find_ref_by_name</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="n">refname</span><span class="p">);</span>
<a name="c1-149"></a><span class="lineno">149</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hint</span><span class="p">)</span>
<a name="c1-150"></a><span class="lineno">150</span>      <span class="n">hint</span> <span class="o">=</span> <span class="n">find_ref_by_name</span><span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">refname</span><span class="p">);</span>
<a name="c1-151"></a><span class="lineno">151</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hint</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-152"></a><span class="lineno">152</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"remote reported status on unknown ref: %s"</span><span class="p">,</span>
<a name="c1-153"></a><span class="lineno">153</span>          <span class="n">refname</span><span class="p">);</span>
<a name="c1-154"></a><span class="lineno">154</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-155"></a><span class="lineno">155</span>    <span class="p">}</span>
<a name="c1-156"></a><span class="lineno">156</span>    <span class="k">if</span> <span class="p">(</span><span class="n">hint</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">REF_STATUS_EXPECTING_REPORT</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-157"></a><span class="lineno">157</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"remote reported status on unexpected ref: %s"</span><span class="p">,</span>
<a name="c1-158"></a><span class="lineno">158</span>          <span class="n">refname</span><span class="p">);</span>
<a name="c1-159"></a><span class="lineno">159</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-160"></a><span class="lineno">160</span>    <span class="p">}</span>
<a name="c1-161"></a><span class="lineno">161</span> 
<a name="c1-162"></a><span class="lineno">162</span>    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'o'</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'k'</span><span class="p">)</span>
<a name="c1-163"></a><span class="lineno">163</span>      <span class="n">hint</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REF_STATUS_OK</span><span class="p">;</span>
<a name="c1-164"></a><span class="lineno">164</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c1-165"></a><span class="lineno">165</span>      <span class="n">hint</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REF_STATUS_REMOTE_REJECT</span><span class="p">;</span>
<a name="c1-166"></a><span class="lineno">166</span>      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-167"></a><span class="lineno">167</span>    <span class="p">}</span>
<a name="c1-168"></a><span class="lineno">168</span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a name="c1-169"></a><span class="lineno">169</span>      <span class="n">hint</span><span class="o">-&gt;</span><span class="n">remote_status</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<a name="c1-170"></a><span class="lineno">170</span>    <span class="cm">/* start our next search from the next ref */</span>
<a name="c1-171"></a><span class="lineno">171</span>    <span class="n">hint</span> <span class="o">=</span> <span class="n">hint</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-172"></a><span class="lineno">172</span>  <span class="p">}</span>
<a name="c1-173"></a><span class="lineno">173</span>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-174"></a><span class="lineno">174</span> <span class="p">}</span>
<a name="c1-175"></a><span class="lineno">175</span> 
<a name="c1-176"></a><span class="lineno">176</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">print_helper_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<a name="c1-177"></a><span class="lineno">177</span> <span class="p">{</span>
<a name="c1-178"></a><span class="lineno">178</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-179"></a><span class="lineno">179</span> 
<a name="c1-180"></a><span class="lineno">180</span>  <span class="k">for</span> <span class="p">(;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-181"></a><span class="lineno">181</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-182"></a><span class="lineno">182</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
<a name="c1-183"></a><span class="lineno">183</span> 
<a name="c1-184"></a><span class="lineno">184</span>    <span class="k">switch</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-185"></a><span class="lineno">185</span>    <span class="k">case</span> <span class="n">REF_STATUS_NONE</span>:
<a name="c1-186"></a><span class="lineno">186</span>      <span class="n">res</span> <span class="o">=</span> <span class="s">"error"</span><span class="p">;</span>
<a name="c1-187"></a><span class="lineno">187</span>      <span class="n">msg</span> <span class="o">=</span> <span class="s">"no match"</span><span class="p">;</span>
<a name="c1-188"></a><span class="lineno">188</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-189"></a><span class="lineno">189</span> 
<a name="c1-190"></a><span class="lineno">190</span>    <span class="k">case</span> <span class="n">REF_STATUS_OK</span>:
<a name="c1-191"></a><span class="lineno">191</span>      <span class="n">res</span> <span class="o">=</span> <span class="s">"ok"</span><span class="p">;</span>
<a name="c1-192"></a><span class="lineno">192</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-193"></a><span class="lineno">193</span> 
<a name="c1-194"></a><span class="lineno">194</span>    <span class="k">case</span> <span class="n">REF_STATUS_UPTODATE</span>:
<a name="c1-195"></a><span class="lineno">195</span>      <span class="n">res</span> <span class="o">=</span> <span class="s">"ok"</span><span class="p">;</span>
<a name="c1-196"></a><span class="lineno">196</span>      <span class="n">msg</span> <span class="o">=</span> <span class="s">"up to date"</span><span class="p">;</span>
<a name="c1-197"></a><span class="lineno">197</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-198"></a><span class="lineno">198</span> 
<a name="c1-199"></a><span class="lineno">199</span>    <span class="k">case</span> <span class="n">REF_STATUS_REJECT_NONFASTFORWARD</span>:
<a name="c1-200"></a><span class="lineno">200</span>      <span class="n">res</span> <span class="o">=</span> <span class="s">"error"</span><span class="p">;</span>
<a name="c1-201"></a><span class="lineno">201</span>      <span class="n">msg</span> <span class="o">=</span> <span class="s">"non-fast forward"</span><span class="p">;</span>
<a name="c1-202"></a><span class="lineno">202</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-203"></a><span class="lineno">203</span> 
<a name="c1-204"></a><span class="lineno">204</span>    <span class="k">case</span> <span class="n">REF_STATUS_REJECT_NODELETE</span>:
<a name="c1-205"></a><span class="lineno">205</span>    <span class="k">case</span> <span class="n">REF_STATUS_REMOTE_REJECT</span>:
<a name="c1-206"></a><span class="lineno">206</span>      <span class="n">res</span> <span class="o">=</span> <span class="s">"error"</span><span class="p">;</span>
<a name="c1-207"></a><span class="lineno">207</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-208"></a><span class="lineno">208</span> 
<a name="c1-209"></a><span class="lineno">209</span>    <span class="k">case</span> <span class="n">REF_STATUS_EXPECTING_REPORT</span>:
<a name="c1-210"></a><span class="lineno">210</span>    <span class="nl">default:</span>
<a name="c1-211"></a><span class="lineno">211</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-212"></a><span class="lineno">212</span>    <span class="p">}</span>
<a name="c1-213"></a><span class="lineno">213</span> 
<a name="c1-214"></a><span class="lineno">214</span>    <span class="n">strbuf_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-215"></a><span class="lineno">215</span>    <span class="n">strbuf_addf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="s">"%s %s"</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c1-216"></a><span class="lineno">216</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">remote_status</span><span class="p">)</span>
<a name="c1-217"></a><span class="lineno">217</span>      <span class="n">msg</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">remote_status</span><span class="p">;</span>
<a name="c1-218"></a><span class="lineno">218</span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-219"></a><span class="lineno">219</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
<a name="c1-220"></a><span class="lineno">220</span>      <span class="n">quote_two_c_style</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-221"></a><span class="lineno">221</span>    <span class="p">}</span>
<a name="c1-222"></a><span class="lineno">222</span>    <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">);</span>
<a name="c1-223"></a><span class="lineno">223</span> 
<a name="c1-224"></a><span class="lineno">224</span>    <span class="n">safe_write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<a name="c1-225"></a><span class="lineno">225</span>  <span class="p">}</span>
<a name="c1-226"></a><span class="lineno">226</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-227"></a><span class="lineno">227</span> <span class="p">}</span>
<a name="c1-228"></a><span class="lineno">228</span> 
<a name="c1-229"></a><span class="lineno">229</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">sideband_demux</span><span class="p">(</span><span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-230"></a><span class="lineno">230</span> <span class="p">{</span>
<a name="c1-231"></a><span class="lineno">231</span>  <span class="kt">int</span> <span class="o">*</span><span class="n">fd</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-232"></a><span class="lineno">232</span> <span class="cp">#ifdef NO_PTHREADS</span>
<a name="c1-233"></a><span class="lineno">233</span>  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="c1-234"></a><span class="lineno">234</span> <span class="cp">#endif</span>
<a name="c1-235"></a><span class="lineno">235</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">recv_sideband</span><span class="p">(</span><span class="s">"send-pack"</span><span class="p">,</span> <span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
<a name="c1-236"></a><span class="lineno">236</span>  <span class="n">close</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c1-237"></a><span class="lineno">237</span>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-238"></a><span class="lineno">238</span> <span class="p">}</span>
<a name="c1-239"></a><span class="lineno">239</span> 
<a name="c1-240"></a><span class="lineno">240</span> <span class="kt">int</span> <span class="nf">send_pack</span><span class="p">(</span><span class="k">struct</span> <span class="n">send_pack_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<a name="c1-241"></a><span class="lineno">241</span>        <span class="kt">int</span> <span class="n">fd</span><span class="p">[],</span> <span class="k">struct</span> <span class="n">child_process</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
<a name="c1-242"></a><span class="lineno">242</span>        <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">remote_refs</span><span class="p">,</span>
<a name="c1-243"></a><span class="lineno">243</span>        <span class="k">struct</span> <span class="n">extra_have_objects</span> <span class="o">*</span><span class="n">extra_have</span><span class="p">)</span>
<a name="c1-244"></a><span class="lineno">244</span> <span class="p">{</span>
<a name="c1-245"></a><span class="lineno">245</span>  <span class="kt">int</span> <span class="n">in</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="c1-246"></a><span class="lineno">246</span>  <span class="kt">int</span> <span class="n">out</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="c1-247"></a><span class="lineno">247</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">req_buf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-248"></a><span class="lineno">248</span>  <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
<a name="c1-249"></a><span class="lineno">249</span>  <span class="kt">int</span> <span class="n">new_refs</span><span class="p">;</span>
<a name="c1-250"></a><span class="lineno">250</span>  <span class="kt">int</span> <span class="n">allow_deleting_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-251"></a><span class="lineno">251</span>  <span class="kt">int</span> <span class="n">status_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-252"></a><span class="lineno">252</span>  <span class="kt">int</span> <span class="n">use_sideband</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-253"></a><span class="lineno">253</span>  <span class="kt">unsigned</span> <span class="n">cmds_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-254"></a><span class="lineno">254</span>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-255"></a><span class="lineno">255</span>  <span class="k">struct</span> <span class="n">async</span> <span class="n">demux</span><span class="p">;</span>
<a name="c1-256"></a><span class="lineno">256</span> 
<a name="c1-257"></a><span class="lineno">257</span>  <span class="cm">/* Does the other end support the reporting? */</span>
<a name="c1-258"></a><span class="lineno">258</span>  <span class="k">if</span> <span class="p">(</span><span class="n">server_supports</span><span class="p">(</span><span class="s">"report-status"</span><span class="p">))</span>
<a name="c1-259"></a><span class="lineno">259</span>    <span class="n">status_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-260"></a><span class="lineno">260</span>  <span class="k">if</span> <span class="p">(</span><span class="n">server_supports</span><span class="p">(</span><span class="s">"delete-refs"</span><span class="p">))</span>
<a name="c1-261"></a><span class="lineno">261</span>    <span class="n">allow_deleting_refs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-262"></a><span class="lineno">262</span>  <span class="k">if</span> <span class="p">(</span><span class="n">server_supports</span><span class="p">(</span><span class="s">"ofs-delta"</span><span class="p">))</span>
<a name="c1-263"></a><span class="lineno">263</span>    <span class="n">args</span><span class="o">-&gt;</span><span class="n">use_ofs_delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-264"></a><span class="lineno">264</span>  <span class="k">if</span> <span class="p">(</span><span class="n">server_supports</span><span class="p">(</span><span class="s">"side-band-64k"</span><span class="p">))</span>
<a name="c1-265"></a><span class="lineno">265</span>    <span class="n">use_sideband</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-266"></a><span class="lineno">266</span> 
<a name="c1-267"></a><span class="lineno">267</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remote_refs</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-268"></a><span class="lineno">268</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"No refs in common and none specified; doing nothing.</span><span class="se">\n</span><span class="s">"</span>
<a name="c1-269"></a><span class="lineno">269</span>      <span class="s">"Perhaps you should specify a branch such as 'master'.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-270"></a><span class="lineno">270</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-271"></a><span class="lineno">271</span>  <span class="p">}</span>
<a name="c1-272"></a><span class="lineno">272</span> 
<a name="c1-273"></a><span class="lineno">273</span>  <span class="cm">/*</span>
<a name="c1-274"></a><span class="lineno">274</span> <span class="cm">   * Finally, tell the other end!</span>
<a name="c1-275"></a><span class="lineno">275</span> <span class="cm">   */</span>
<a name="c1-276"></a><span class="lineno">276</span>  <span class="n">new_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-277"></a><span class="lineno">277</span>  <span class="k">for</span> <span class="p">(</span><span class="n">ref</span> <span class="o">=</span> <span class="n">remote_refs</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-278"></a><span class="lineno">278</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">peer_ref</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">send_mirror</span><span class="p">)</span>
<a name="c1-279"></a><span class="lineno">279</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-280"></a><span class="lineno">280</span> 
<a name="c1-281"></a><span class="lineno">281</span>    <span class="cm">/* Check for statuses set by set_ref_status_for_push() */</span>
<a name="c1-282"></a><span class="lineno">282</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-283"></a><span class="lineno">283</span>    <span class="k">case</span> <span class="n">REF_STATUS_REJECT_NONFASTFORWARD</span>:
<a name="c1-284"></a><span class="lineno">284</span>    <span class="k">case</span> <span class="n">REF_STATUS_UPTODATE</span>:
<a name="c1-285"></a><span class="lineno">285</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-286"></a><span class="lineno">286</span>    <span class="nl">default:</span>
<a name="c1-287"></a><span class="lineno">287</span>      <span class="p">;</span> <span class="cm">/* do nothing */</span>
<a name="c1-288"></a><span class="lineno">288</span>    <span class="p">}</span>
<a name="c1-289"></a><span class="lineno">289</span> 
<a name="c1-290"></a><span class="lineno">290</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">deletion</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allow_deleting_refs</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-291"></a><span class="lineno">291</span>      <span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REF_STATUS_REJECT_NODELETE</span><span class="p">;</span>
<a name="c1-292"></a><span class="lineno">292</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-293"></a><span class="lineno">293</span>    <span class="p">}</span>
<a name="c1-294"></a><span class="lineno">294</span> 
<a name="c1-295"></a><span class="lineno">295</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">deletion</span><span class="p">)</span>
<a name="c1-296"></a><span class="lineno">296</span>      <span class="n">new_refs</span><span class="o">++</span><span class="p">;</span>
<a name="c1-297"></a><span class="lineno">297</span> 
<a name="c1-298"></a><span class="lineno">298</span>    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">dry_run</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-299"></a><span class="lineno">299</span>      <span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REF_STATUS_OK</span><span class="p">;</span>
<a name="c1-300"></a><span class="lineno">300</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-301"></a><span class="lineno">301</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">old_hex</span> <span class="o">=</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">old_sha1</span><span class="p">);</span>
<a name="c1-302"></a><span class="lineno">302</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">new_hex</span> <span class="o">=</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">new_sha1</span><span class="p">);</span>
<a name="c1-303"></a><span class="lineno">303</span> 
<a name="c1-304"></a><span class="lineno">304</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmds_sent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status_report</span> <span class="o">||</span> <span class="n">use_sideband</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-305"></a><span class="lineno">305</span>        <span class="n">packet_buf_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_buf</span><span class="p">,</span> <span class="s">"%s %s %s%c%s%s"</span><span class="p">,</span>
<a name="c1-306"></a><span class="lineno">306</span>          <span class="n">old_hex</span><span class="p">,</span> <span class="n">new_hex</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<a name="c1-307"></a><span class="lineno">307</span>          <span class="n">status_report</span> <span class="o">?</span> <span class="s">" report-status"</span> <span class="o">:</span> <span class="s">""</span><span class="p">,</span>
<a name="c1-308"></a><span class="lineno">308</span>          <span class="n">use_sideband</span> <span class="o">?</span> <span class="s">" side-band-64k"</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
<a name="c1-309"></a><span class="lineno">309</span>      <span class="p">}</span>
<a name="c1-310"></a><span class="lineno">310</span>      <span class="k">else</span>
<a name="c1-311"></a><span class="lineno">311</span>        <span class="n">packet_buf_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_buf</span><span class="p">,</span> <span class="s">"%s %s %s"</span><span class="p">,</span>
<a name="c1-312"></a><span class="lineno">312</span>          <span class="n">old_hex</span><span class="p">,</span> <span class="n">new_hex</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<a name="c1-313"></a><span class="lineno">313</span>      <span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status_report</span> <span class="o">?</span>
<a name="c1-314"></a><span class="lineno">314</span>        <span class="n">REF_STATUS_EXPECTING_REPORT</span> <span class="o">:</span>
<a name="c1-315"></a><span class="lineno">315</span>        <span class="n">REF_STATUS_OK</span><span class="p">;</span>
<a name="c1-316"></a><span class="lineno">316</span>      <span class="n">cmds_sent</span><span class="o">++</span><span class="p">;</span>
<a name="c1-317"></a><span class="lineno">317</span>    <span class="p">}</span>
<a name="c1-318"></a><span class="lineno">318</span>  <span class="p">}</span>
<a name="c1-319"></a><span class="lineno">319</span> 
<a name="c1-320"></a><span class="lineno">320</span>  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">stateless_rpc</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-321"></a><span class="lineno">321</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">dry_run</span> <span class="o">&amp;&amp;</span> <span class="n">cmds_sent</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-322"></a><span class="lineno">322</span>      <span class="n">packet_buf_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_buf</span><span class="p">);</span>
<a name="c1-323"></a><span class="lineno">323</span>      <span class="n">send_sideband</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">LARGE_PACKET_MAX</span><span class="p">);</span>
<a name="c1-324"></a><span class="lineno">324</span>    <span class="p">}</span>
<a name="c1-325"></a><span class="lineno">325</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-326"></a><span class="lineno">326</span>    <span class="n">safe_write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">req_buf</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<a name="c1-327"></a><span class="lineno">327</span>    <span class="n">packet_flush</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c1-328"></a><span class="lineno">328</span>  <span class="p">}</span>
<a name="c1-329"></a><span class="lineno">329</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req_buf</span><span class="p">);</span>
<a name="c1-330"></a><span class="lineno">330</span> 
<a name="c1-331"></a><span class="lineno">331</span>  <span class="k">if</span> <span class="p">(</span><span class="n">use_sideband</span> <span class="o">&amp;&amp;</span> <span class="n">cmds_sent</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-332"></a><span class="lineno">332</span>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">demux</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">demux</span><span class="p">));</span>
<a name="c1-333"></a><span class="lineno">333</span>    <span class="n">demux</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">sideband_demux</span><span class="p">;</span>
<a name="c1-334"></a><span class="lineno">334</span>    <span class="n">demux</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
<a name="c1-335"></a><span class="lineno">335</span>    <span class="n">demux</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-336"></a><span class="lineno">336</span>    <span class="k">if</span> <span class="p">(</span><span class="n">start_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">demux</span><span class="p">))</span>
<a name="c1-337"></a><span class="lineno">337</span>      <span class="n">die</span><span class="p">(</span><span class="s">"send-pack: unable to fork off sideband demultiplexer"</span><span class="p">);</span>
<a name="c1-338"></a><span class="lineno">338</span>    <span class="n">in</span> <span class="o">=</span> <span class="n">demux</span><span class="p">.</span><span class="n">out</span><span class="p">;</span>
<a name="c1-339"></a><span class="lineno">339</span>  <span class="p">}</span>
<a name="c1-340"></a><span class="lineno">340</span> 
<a name="c1-341"></a><span class="lineno">341</span>  <span class="k">if</span> <span class="p">(</span><span class="n">new_refs</span> <span class="o">&amp;&amp;</span> <span class="n">cmds_sent</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-342"></a><span class="lineno">342</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pack_objects</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">remote_refs</span><span class="p">,</span> <span class="n">extra_have</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-343"></a><span class="lineno">343</span>      <span class="k">for</span> <span class="p">(</span><span class="n">ref</span> <span class="o">=</span> <span class="n">remote_refs</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-344"></a><span class="lineno">344</span>        <span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">REF_STATUS_NONE</span><span class="p">;</span>
<a name="c1-345"></a><span class="lineno">345</span>      <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">stateless_rpc</span><span class="p">)</span>
<a name="c1-346"></a><span class="lineno">346</span>        <span class="n">close</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c1-347"></a><span class="lineno">347</span>      <span class="k">if</span> <span class="p">(</span><span class="n">git_connection_is_socket</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span>
<a name="c1-348"></a><span class="lineno">348</span>        <span class="n">shutdown</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SHUT_WR</span><span class="p">);</span>
<a name="c1-349"></a><span class="lineno">349</span>      <span class="k">if</span> <span class="p">(</span><span class="n">use_sideband</span><span class="p">)</span>
<a name="c1-350"></a><span class="lineno">350</span>        <span class="n">finish_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">demux</span><span class="p">);</span>
<a name="c1-351"></a><span class="lineno">351</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-352"></a><span class="lineno">352</span>    <span class="p">}</span>
<a name="c1-353"></a><span class="lineno">353</span>  <span class="p">}</span>
<a name="c1-354"></a><span class="lineno">354</span>  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">stateless_rpc</span> <span class="o">&amp;&amp;</span> <span class="n">cmds_sent</span><span class="p">)</span>
<a name="c1-355"></a><span class="lineno">355</span>    <span class="n">packet_flush</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c1-356"></a><span class="lineno">356</span> 
<a name="c1-357"></a><span class="lineno">357</span>  <span class="k">if</span> <span class="p">(</span><span class="n">status_report</span> <span class="o">&amp;&amp;</span> <span class="n">cmds_sent</span><span class="p">)</span>
<a name="c1-358"></a><span class="lineno">358</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">receive_status</span><span class="p">(</span><span class="n">in</span><span class="p">,</span> <span class="n">remote_refs</span><span class="p">);</span>
<a name="c1-359"></a><span class="lineno">359</span>  <span class="k">else</span>
<a name="c1-360"></a><span class="lineno">360</span>    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-361"></a><span class="lineno">361</span>  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">stateless_rpc</span><span class="p">)</span>
<a name="c1-362"></a><span class="lineno">362</span>    <span class="n">packet_flush</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c1-363"></a><span class="lineno">363</span> 
<a name="c1-364"></a><span class="lineno">364</span>  <span class="k">if</span> <span class="p">(</span><span class="n">use_sideband</span> <span class="o">&amp;&amp;</span> <span class="n">cmds_sent</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-365"></a><span class="lineno">365</span>    <span class="k">if</span> <span class="p">(</span><span class="n">finish_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">demux</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-366"></a><span class="lineno">366</span>      <span class="n">error</span><span class="p">(</span><span class="s">"error in sideband demultiplexer"</span><span class="p">);</span>
<a name="c1-367"></a><span class="lineno">367</span>      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-368"></a><span class="lineno">368</span>    <span class="p">}</span>
<a name="c1-369"></a><span class="lineno">369</span>    <span class="n">close</span><span class="p">(</span><span class="n">demux</span><span class="p">.</span><span class="n">out</span><span class="p">);</span>
<a name="c1-370"></a><span class="lineno">370</span>  <span class="p">}</span>
<a name="c1-371"></a><span class="lineno">371</span> 
<a name="c1-372"></a><span class="lineno">372</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-373"></a><span class="lineno">373</span>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-374"></a><span class="lineno">374</span> 
<a name="c1-375"></a><span class="lineno">375</span>  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">porcelain</span><span class="p">)</span>
<a name="c1-376"></a><span class="lineno">376</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-377"></a><span class="lineno">377</span> 
<a name="c1-378"></a><span class="lineno">378</span>  <span class="k">for</span> <span class="p">(</span><span class="n">ref</span> <span class="o">=</span> <span class="n">remote_refs</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-379"></a><span class="lineno">379</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-380"></a><span class="lineno">380</span>    <span class="k">case</span> <span class="n">REF_STATUS_NONE</span>:
<a name="c1-381"></a><span class="lineno">381</span>    <span class="k">case</span> <span class="n">REF_STATUS_UPTODATE</span>:
<a name="c1-382"></a><span class="lineno">382</span>    <span class="k">case</span> <span class="n">REF_STATUS_OK</span>:
<a name="c1-383"></a><span class="lineno">383</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-384"></a><span class="lineno">384</span>    <span class="nl">default:</span>
<a name="c1-385"></a><span class="lineno">385</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-386"></a><span class="lineno">386</span>    <span class="p">}</span>
<a name="c1-387"></a><span class="lineno">387</span>  <span class="p">}</span>
<a name="c1-388"></a><span class="lineno">388</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-389"></a><span class="lineno">389</span> <span class="p">}</span>
<a name="c1-390"></a><span class="lineno">390</span> 
<a name="c1-391"></a><span class="lineno">391</span> <span class="kt">int</span> <span class="nf">cmd_send_pack</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<a name="c1-392"></a><span class="lineno">392</span> <span class="p">{</span>
<a name="c1-393"></a><span class="lineno">393</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_refspecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-394"></a><span class="lineno">394</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">refspecs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-395"></a><span class="lineno">395</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">remote_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-396"></a><span class="lineno">396</span>  <span class="k">struct</span> <span class="n">remote</span> <span class="o">*</span><span class="n">remote</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-397"></a><span class="lineno">397</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-398"></a><span class="lineno">398</span>  <span class="kt">int</span> <span class="n">fd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="c1-399"></a><span class="lineno">399</span>  <span class="k">struct</span> <span class="n">child_process</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
<a name="c1-400"></a><span class="lineno">400</span>  <span class="k">struct</span> <span class="n">extra_have_objects</span> <span class="n">extra_have</span><span class="p">;</span>
<a name="c1-401"></a><span class="lineno">401</span>  <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">remote_refs</span><span class="p">,</span> <span class="o">*</span><span class="n">local_refs</span><span class="p">;</span>
<a name="c1-402"></a><span class="lineno">402</span>  <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-403"></a><span class="lineno">403</span>  <span class="kt">int</span> <span class="n">helper_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-404"></a><span class="lineno">404</span>  <span class="kt">int</span> <span class="n">send_all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-405"></a><span class="lineno">405</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">receivepack</span> <span class="o">=</span> <span class="s">"git-receive-pack"</span><span class="p">;</span>
<a name="c1-406"></a><span class="lineno">406</span>  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="c1-407"></a><span class="lineno">407</span>  <span class="kt">int</span> <span class="n">nonfastforward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-408"></a><span class="lineno">408</span> 
<a name="c1-409"></a><span class="lineno">409</span>  <span class="n">argv</span><span class="o">++</span><span class="p">;</span>
<a name="c1-410"></a><span class="lineno">410</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">argv</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-411"></a><span class="lineno">411</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
<a name="c1-412"></a><span class="lineno">412</span> 
<a name="c1-413"></a><span class="lineno">413</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">arg</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-414"></a><span class="lineno">414</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--receive-pack="</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-415"></a><span class="lineno">415</span>        <span class="n">receivepack</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">15</span><span class="p">;</span>
<a name="c1-416"></a><span class="lineno">416</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-417"></a><span class="lineno">417</span>      <span class="p">}</span>
<a name="c1-418"></a><span class="lineno">418</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--exec="</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-419"></a><span class="lineno">419</span>        <span class="n">receivepack</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
<a name="c1-420"></a><span class="lineno">420</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-421"></a><span class="lineno">421</span>      <span class="p">}</span>
<a name="c1-422"></a><span class="lineno">422</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--remote="</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-423"></a><span class="lineno">423</span>        <span class="n">remote_name</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>
<a name="c1-424"></a><span class="lineno">424</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-425"></a><span class="lineno">425</span>      <span class="p">}</span>
<a name="c1-426"></a><span class="lineno">426</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--all"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-427"></a><span class="lineno">427</span>        <span class="n">send_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-428"></a><span class="lineno">428</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-429"></a><span class="lineno">429</span>      <span class="p">}</span>
<a name="c1-430"></a><span class="lineno">430</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--dry-run"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-431"></a><span class="lineno">431</span>        <span class="n">args</span><span class="p">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-432"></a><span class="lineno">432</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-433"></a><span class="lineno">433</span>      <span class="p">}</span>
<a name="c1-434"></a><span class="lineno">434</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--mirror"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-435"></a><span class="lineno">435</span>        <span class="n">args</span><span class="p">.</span><span class="n">send_mirror</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-436"></a><span class="lineno">436</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-437"></a><span class="lineno">437</span>      <span class="p">}</span>
<a name="c1-438"></a><span class="lineno">438</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--force"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-439"></a><span class="lineno">439</span>        <span class="n">args</span><span class="p">.</span><span class="n">force_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-440"></a><span class="lineno">440</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-441"></a><span class="lineno">441</span>      <span class="p">}</span>
<a name="c1-442"></a><span class="lineno">442</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--verbose"</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-443"></a><span class="lineno">443</span>        <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-444"></a><span class="lineno">444</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-445"></a><span class="lineno">445</span>      <span class="p">}</span>
<a name="c1-446"></a><span class="lineno">446</span> <span class="hll">     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--thin"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-447"></a><span class="lineno">447</span> <span class="hll">        <span class="n">args</span><span class="p">.</span><span class="n">use_thin_pack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c1-448"></a><span class="lineno">448</span> <span class="hll">        <span class="k">continue</span><span class="p">;</span>
</span><a name="c1-449"></a><span class="lineno">449</span> <span class="hll">      <span class="p">}</span>
</span><a name="c1-450"></a><span class="lineno">450</span> <span class="hll">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--stateless-rpc"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-451"></a><span class="lineno">451</span> <span class="hll">        <span class="n">args</span><span class="p">.</span><span class="n">stateless_rpc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c1-452"></a><span class="lineno">452</span> <span class="hll">        <span class="k">continue</span><span class="p">;</span>
</span><a name="c1-453"></a><span class="lineno">453</span> <span class="hll">      <span class="p">}</span>
</span><a name="c1-454"></a><span class="lineno">454</span> <span class="hll">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"--helper-status"</span><span class="p">))</span> <span class="p">{</span>
</span><a name="c1-455"></a><span class="lineno">455</span> <span class="hll">        <span class="n">helper_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c1-456"></a><span class="lineno">456</span> <span class="hll">        <span class="k">continue</span><span class="p">;</span>
</span><a name="c1-457"></a><span class="lineno">457</span> <span class="hll">      <span class="p">}</span>
</span><a name="c1-458"></a><span class="lineno">458</span> <span class="hll">      <span class="n">usage</span><span class="p">(</span><span class="n">send_pack_usage</span><span class="p">);</span>
</span><a name="c1-459"></a><span class="lineno">459</span>     <span class="p">}</span>
<a name="c1-460"></a><span class="lineno">460</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-461"></a><span class="lineno">461</span>      <span class="n">dest</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
<a name="c1-462"></a><span class="lineno">462</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-463"></a><span class="lineno">463</span>    <span class="p">}</span>
<a name="c1-464"></a><span class="lineno">464</span>    <span class="n">refspecs</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span> <span class="n">argv</span><span class="p">;</span>
<a name="c1-465"></a><span class="lineno">465</span>    <span class="n">nr_refspecs</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-466"></a><span class="lineno">466</span>    <span class="k">break</span><span class="p">;</span>
<a name="c1-467"></a><span class="lineno">467</span>  <span class="p">}</span>
<a name="c1-468"></a><span class="lineno">468</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dest</span><span class="p">)</span>
<a name="c1-469"></a><span class="lineno">469</span>    <span class="n">usage</span><span class="p">(</span><span class="n">send_pack_usage</span><span class="p">);</span>
<a name="c1-470"></a><span class="lineno">470</span>  <span class="cm">/*</span>
<a name="c1-471"></a><span class="lineno">471</span> <span class="cm">   * --all and --mirror are incompatible; neither makes sense</span>
<a name="c1-472"></a><span class="lineno">472</span> <span class="cm">   * with any refspecs.</span>
<a name="c1-473"></a><span class="lineno">473</span> <span class="cm">   */</span>
<a name="c1-474"></a><span class="lineno">474</span>  <span class="k">if</span> <span class="p">((</span><span class="n">refspecs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">send_all</span> <span class="o">||</span> <span class="n">args</span><span class="p">.</span><span class="n">send_mirror</span><span class="p">))</span> <span class="o">||</span>
<a name="c1-475"></a><span class="lineno">475</span>      <span class="p">(</span><span class="n">send_all</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="p">.</span><span class="n">send_mirror</span><span class="p">))</span>
<a name="c1-476"></a><span class="lineno">476</span>    <span class="n">usage</span><span class="p">(</span><span class="n">send_pack_usage</span><span class="p">);</span>
<a name="c1-477"></a><span class="lineno">477</span> 
<a name="c1-478"></a><span class="lineno">478</span>  <span class="k">if</span> <span class="p">(</span><span class="n">remote_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-479"></a><span class="lineno">479</span>    <span class="n">remote</span> <span class="o">=</span> <span class="n">remote_get</span><span class="p">(</span><span class="n">remote_name</span><span class="p">);</span>
<a name="c1-480"></a><span class="lineno">480</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remote_has_url</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-481"></a><span class="lineno">481</span>      <span class="n">die</span><span class="p">(</span><span class="s">"Destination %s is not a uri for %s"</span><span class="p">,</span>
<a name="c1-482"></a><span class="lineno">482</span>          <span class="n">dest</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">);</span>
<a name="c1-483"></a><span class="lineno">483</span>    <span class="p">}</span>
<a name="c1-484"></a><span class="lineno">484</span>  <span class="p">}</span>
<a name="c1-485"></a><span class="lineno">485</span> 
<a name="c1-486"></a><span class="lineno">486</span>  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">stateless_rpc</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-487"></a><span class="lineno">487</span>    <span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-488"></a><span class="lineno">488</span>    <span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-489"></a><span class="lineno">489</span>    <span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-490"></a><span class="lineno">490</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-491"></a><span class="lineno">491</span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">git_connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">receivepack</span><span class="p">,</span>
<a name="c1-492"></a><span class="lineno">492</span>      <span class="n">args</span><span class="p">.</span><span class="n">verbose</span> <span class="o">?</span> <span class="n">CONNECT_VERBOSE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-493"></a><span class="lineno">493</span>  <span class="p">}</span>
<a name="c1-494"></a><span class="lineno">494</span> 
<a name="c1-495"></a><span class="lineno">495</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">extra_have</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">extra_have</span><span class="p">));</span>
<a name="c1-496"></a><span class="lineno">496</span> 
<a name="c1-497"></a><span class="lineno">497</span>  <span class="n">get_remote_heads</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">remote_refs</span><span class="p">,</span> <span class="n">REF_NORMAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extra_have</span><span class="p">);</span>
<a name="c1-498"></a><span class="lineno">498</span> 
<a name="c1-499"></a><span class="lineno">499</span>  <span class="n">transport_verify_remote_names</span><span class="p">(</span><span class="n">nr_refspecs</span><span class="p">,</span> <span class="n">refspecs</span><span class="p">);</span>
<a name="c1-500"></a><span class="lineno">500</span> 
<a name="c1-501"></a><span class="lineno">501</span>  <span class="n">local_refs</span> <span class="o">=</span> <span class="n">get_local_heads</span><span class="p">();</span>
<a name="c1-502"></a><span class="lineno">502</span> 
<a name="c1-503"></a><span class="lineno">503</span>  <span class="n">flags</span> <span class="o">=</span> <span class="n">MATCH_REFS_NONE</span><span class="p">;</span>
<a name="c1-504"></a><span class="lineno">504</span> 
<a name="c1-505"></a><span class="lineno">505</span>  <span class="k">if</span> <span class="p">(</span><span class="n">send_all</span><span class="p">)</span>
<a name="c1-506"></a><span class="lineno">506</span>    <span class="n">flags</span> <span class="o">|=</span> <span class="n">MATCH_REFS_ALL</span><span class="p">;</span>
<a name="c1-507"></a><span class="lineno">507</span>  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">send_mirror</span><span class="p">)</span>
<a name="c1-508"></a><span class="lineno">508</span>    <span class="n">flags</span> <span class="o">|=</span> <span class="n">MATCH_REFS_MIRROR</span><span class="p">;</span>
<a name="c1-509"></a><span class="lineno">509</span> 
<a name="c1-510"></a><span class="lineno">510</span>  <span class="cm">/* match them up */</span>
<a name="c1-511"></a><span class="lineno">511</span>  <span class="k">if</span> <span class="p">(</span><span class="n">match_push_refs</span><span class="p">(</span><span class="n">local_refs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remote_refs</span><span class="p">,</span> <span class="n">nr_refspecs</span><span class="p">,</span> <span class="n">refspecs</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
<a name="c1-512"></a><span class="lineno">512</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-513"></a><span class="lineno">513</span> 
<a name="c1-514"></a><span class="lineno">514</span>  <span class="n">set_ref_status_for_push</span><span class="p">(</span><span class="n">remote_refs</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">send_mirror</span><span class="p">,</span>
<a name="c1-515"></a><span class="lineno">515</span>    <span class="n">args</span><span class="p">.</span><span class="n">force_update</span><span class="p">);</span>
<a name="c1-516"></a><span class="lineno">516</span> 
<a name="c1-517"></a><span class="lineno">517</span>  <span class="n">ret</span> <span class="o">=</span> <span class="n">send_pack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">remote_refs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extra_have</span><span class="p">);</span>
<a name="c1-518"></a><span class="lineno">518</span> 
<a name="c1-519"></a><span class="lineno">519</span>  <span class="k">if</span> <span class="p">(</span><span class="n">helper_status</span><span class="p">)</span>
<a name="c1-520"></a><span class="lineno">520</span>    <span class="n">print_helper_status</span><span class="p">(</span><span class="n">remote_refs</span><span class="p">);</span>
<a name="c1-521"></a><span class="lineno">521</span> 
<a name="c1-522"></a><span class="lineno">522</span>  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a name="c1-523"></a><span class="lineno">523</span>  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-524"></a><span class="lineno">524</span> 
<a name="c1-525"></a><span class="lineno">525</span>  <span class="n">ret</span> <span class="o">|=</span> <span class="n">finish_connect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
<a name="c1-526"></a><span class="lineno">526</span> 
<a name="c1-527"></a><span class="lineno">527</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">helper_status</span><span class="p">)</span>
<a name="c1-528"></a><span class="lineno">528</span>    <span class="n">transport_print_push_status</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">remote_refs</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nonfastforward</span><span class="p">);</span>
<a name="c1-529"></a><span class="lineno">529</span> 
<a name="c1-530"></a><span class="lineno">530</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="p">.</span><span class="n">dry_run</span> <span class="o">&amp;&amp;</span> <span class="n">remote</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-531"></a><span class="lineno">531</span>    <span class="k">struct</span> <span class="n">ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
<a name="c1-532"></a><span class="lineno">532</span>    <span class="k">for</span> <span class="p">(</span><span class="n">ref</span> <span class="o">=</span> <span class="n">remote_refs</span><span class="p">;</span> <span class="n">ref</span><span class="p">;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-533"></a><span class="lineno">533</span>      <span class="n">transport_update_tracking_ref</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span><span class="p">);</span>
<a name="c1-534"></a><span class="lineno">534</span>  <span class="p">}</span>
<a name="c1-535"></a><span class="lineno">535</span> 
<a name="c1-536"></a><span class="lineno">536</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">transport_refs_pushed</span><span class="p">(</span><span class="n">remote_refs</span><span class="p">))</span>
<a name="c1-537"></a><span class="lineno">537</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Everything up-to-date</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-538"></a><span class="lineno">538</span> 
<a name="c1-539"></a><span class="lineno">539</span>  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-540"></a><span class="lineno">540</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>
</body></html>