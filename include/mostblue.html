<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000678 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="shortcut icon" href="http://tyr.ics.es.osaka-u.ac.jp/static/favicon.ico">
        <script type="text/javascript" src="./mostblue_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./mostblue_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./mostblue_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./mostblue_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./mostblue_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./mostblue_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./mostblue_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./mostblue_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./mostblue_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./mostblue_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./mostblue_files/chosen.jquery.js"></script>


        <script src="./mostblue_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./mostblue_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./mostblue_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000678");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./mostblue_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./mostblue_files/bootstrap.css" rel="stylesheet">

        <link href="./mostblue_files/force.css" rel="stylesheet" type="text/css">
        <link href="./mostblue_files/chosen.css" rel="stylesheet" type="text/css">
        
        <link href="./motivating_files/font-awesome.css" rel="stylesheet" type="text/css">

        
<link rel="stylesheet" href="http://tyr.ics.es.osaka-u.ac.jp/pygments.css">
<title>Fica -- survey git-v1.7.9-rc1 12-01-25 02:26:57</title>

<script language="javascript">

    var reheight = function(){
        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-364']")[0].scrollIntoView();
        $("a[name='c1-153']")[0].scrollIntoView();
        reheight();
      
       
    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

    <body>
      <table>
<tr>
        <th><a href="http://localhost/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000678">96</a></th>
        

        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        

        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
    </tr></table>

<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> attr.c 
                <small> (370,55)-(388,10)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">  1</span> <span class="cm">/*</span>
<a name="c0-2"></a><span class="lineno">  2</span> <span class="cm"> * Handle git attributes.  See gitattributes(5) for a description of</span>
<a name="c0-3"></a><span class="lineno">  3</span> <span class="cm"> * the file syntax, and Documentation/technical/api-gitattributes.txt</span>
<a name="c0-4"></a><span class="lineno">  4</span> <span class="cm"> * for a description of the API.</span>
<a name="c0-5"></a><span class="lineno">  5</span> <span class="cm"> *</span>
<a name="c0-6"></a><span class="lineno">  6</span> <span class="cm"> * One basic design decision here is that we are not going to support</span>
<a name="c0-7"></a><span class="lineno">  7</span> <span class="cm"> * an insanely large number of attributes.</span>
<a name="c0-8"></a><span class="lineno">  8</span> <span class="cm"> */</span>
<a name="c0-9"></a><span class="lineno">  9</span> 
<a name="c0-10"></a><span class="lineno"> 10</span> <span class="cp">#define NO_THE_INDEX_COMPATIBILITY_MACROS</span>
<a name="c0-11"></a><span class="lineno"> 11</span> <span class="cp">#include "cache.h"</span>
<a name="c0-12"></a><span class="lineno"> 12</span> <span class="cp">#include "exec_cmd.h"</span>
<a name="c0-13"></a><span class="lineno"> 13</span> <span class="cp">#include "attr.h"</span>
<a name="c0-14"></a><span class="lineno"> 14</span> <span class="cp">#include "dir.h"</span>
<a name="c0-15"></a><span class="lineno"> 15</span> 
<a name="c0-16"></a><span class="lineno"> 16</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">git_attr__true</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"(builtin)true"</span><span class="p">;</span>
<a name="c0-17"></a><span class="lineno"> 17</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">git_attr__false</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\0</span><span class="s">(builtin)false"</span><span class="p">;</span>
<a name="c0-18"></a><span class="lineno"> 18</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">git_attr__unknown</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"(builtin)unknown"</span><span class="p">;</span>
<a name="c0-19"></a><span class="lineno"> 19</span> <span class="cp">#define ATTR__TRUE git_attr__true</span>
<a name="c0-20"></a><span class="lineno"> 20</span> <span class="cp">#define ATTR__FALSE git_attr__false</span>
<a name="c0-21"></a><span class="lineno"> 21</span> <span class="cp">#define ATTR__UNSET NULL</span>
<a name="c0-22"></a><span class="lineno"> 22</span> <span class="cp">#define ATTR__UNKNOWN git_attr__unknown</span>
<a name="c0-23"></a><span class="lineno"> 23</span> 
<a name="c0-24"></a><span class="lineno"> 24</span> <span class="cm">/* This is a randomly chosen prime. */</span>
<a name="c0-25"></a><span class="lineno"> 25</span> <span class="cp">#define HASHSIZE 257</span>
<a name="c0-26"></a><span class="lineno"> 26</span> 
<a name="c0-27"></a><span class="lineno"> 27</span> <span class="cp">#ifndef DEBUG_ATTR</span>
<a name="c0-28"></a><span class="lineno"> 28</span> <span class="cp">#define DEBUG_ATTR 0</span>
<a name="c0-29"></a><span class="lineno"> 29</span> <span class="cp">#endif</span>
<a name="c0-30"></a><span class="lineno"> 30</span> 
<a name="c0-31"></a><span class="lineno"> 31</span> <span class="k">struct</span> <span class="n">git_attr</span> <span class="p">{</span>
<a name="c0-32"></a><span class="lineno"> 32</span>   <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-33"></a><span class="lineno"> 33</span>   <span class="kt">unsigned</span> <span class="n">h</span><span class="p">;</span>
<a name="c0-34"></a><span class="lineno"> 34</span>   <span class="kt">int</span> <span class="n">attr_nr</span><span class="p">;</span>
<a name="c0-35"></a><span class="lineno"> 35</span>   <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">FLEX_ARRAY</span><span class="p">];</span>
<a name="c0-36"></a><span class="lineno"> 36</span> <span class="p">};</span>
<a name="c0-37"></a><span class="lineno"> 37</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">attr_nr</span><span class="p">;</span>
<a name="c0-38"></a><span class="lineno"> 38</span> 
<a name="c0-39"></a><span class="lineno"> 39</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check_all_attr</span><span class="p">;</span>
<a name="c0-40"></a><span class="lineno"> 40</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="p">(</span><span class="n">git_attr_hash</span><span class="p">[</span><span class="n">HASHSIZE</span><span class="p">]);</span>
<a name="c0-41"></a><span class="lineno"> 41</span> 
<a name="c0-42"></a><span class="lineno"> 42</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">git_attr_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<a name="c0-43"></a><span class="lineno"> 43</span> <span class="p">{</span>
<a name="c0-44"></a><span class="lineno"> 44</span>   <span class="k">return</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<a name="c0-45"></a><span class="lineno"> 45</span> <span class="p">}</span>
<a name="c0-46"></a><span class="lineno"> 46</span> 
<a name="c0-47"></a><span class="lineno"> 47</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">hash_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">)</span>
<a name="c0-48"></a><span class="lineno"> 48</span> <span class="p">{</span>
<a name="c0-49"></a><span class="lineno"> 49</span>   <span class="kt">unsigned</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
<a name="c0-50"></a><span class="lineno"> 50</span> 
<a name="c0-51"></a><span class="lineno"> 51</span>   <span class="k">while</span> <span class="p">(</span><span class="n">namelen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-52"></a><span class="lineno"> 52</span>     <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
<a name="c0-53"></a><span class="lineno"> 53</span>     <span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">))</span> <span class="o">^</span> <span class="n">c</span><span class="p">;</span>
<a name="c0-54"></a><span class="lineno"> 54</span>   <span class="p">}</span>
<a name="c0-55"></a><span class="lineno"> 55</span>   <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<a name="c0-56"></a><span class="lineno"> 56</span> <span class="p">}</span>
<a name="c0-57"></a><span class="lineno"> 57</span> 
<a name="c0-58"></a><span class="lineno"> 58</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">invalid_attr_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">)</span>
<a name="c0-59"></a><span class="lineno"> 59</span> <span class="p">{</span>
<a name="c0-60"></a><span class="lineno"> 60</span>   <span class="cm">/*</span>
<a name="c0-61"></a><span class="lineno"> 61</span> <span class="cm">  * Attribute name cannot begin with '-' and must consist of</span>
<a name="c0-62"></a><span class="lineno"> 62</span> <span class="cm">  * characters from [-A-Za-z0-9_.].</span>
<a name="c0-63"></a><span class="lineno"> 63</span> <span class="cm">  */</span>
<a name="c0-64"></a><span class="lineno"> 64</span>   <span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">name</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-65"></a><span class="lineno"> 65</span>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-66"></a><span class="lineno"> 66</span>   <span class="k">while</span> <span class="p">(</span><span class="n">namelen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-67"></a><span class="lineno"> 67</span>     <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
<a name="c0-68"></a><span class="lineno"> 68</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">'_'</span> <span class="o">||</span>
<a name="c0-69"></a><span class="lineno"> 69</span>            <span class="p">(</span><span class="sc">'0'</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-70"></a><span class="lineno"> 70</span>            <span class="p">(</span><span class="sc">'a'</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-71"></a><span class="lineno"> 71</span>            <span class="p">(</span><span class="sc">'A'</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">))</span> <span class="p">)</span>
<a name="c0-72"></a><span class="lineno"> 72</span>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-73"></a><span class="lineno"> 73</span>   <span class="p">}</span>
<a name="c0-74"></a><span class="lineno"> 74</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-75"></a><span class="lineno"> 75</span> <span class="p">}</span>
<a name="c0-76"></a><span class="lineno"> 76</span> 
<a name="c0-77"></a><span class="lineno"> 77</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="nf">git_attr_internal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-78"></a><span class="lineno"> 78</span> <span class="p">{</span>
<a name="c0-79"></a><span class="lineno"> 79</span>   <span class="kt">unsigned</span> <span class="n">hval</span> <span class="o">=</span> <span class="n">hash_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-80"></a><span class="lineno"> 80</span>   <span class="kt">unsigned</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">hval</span> <span class="o">%</span> <span class="n">HASHSIZE</span><span class="p">;</span>
<a name="c0-81"></a><span class="lineno"> 81</span>   <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
<a name="c0-82"></a><span class="lineno"> 82</span> 
<a name="c0-83"></a><span class="lineno"> 83</span>   <span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">git_attr_hash</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span> <span class="n">a</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-84"></a><span class="lineno"> 84</span>     <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">h</span> <span class="o">==</span> <span class="n">hval</span> <span class="o">&amp;&amp;</span>
<a name="c0-85"></a><span class="lineno"> 85</span>         <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">])</span>
<a name="c0-86"></a><span class="lineno"> 86</span>       <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<a name="c0-87"></a><span class="lineno"> 87</span>   <span class="p">}</span>
<a name="c0-88"></a><span class="lineno"> 88</span> 
<a name="c0-89"></a><span class="lineno"> 89</span>   <span class="k">if</span> <span class="p">(</span><span class="n">invalid_attr_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
<a name="c0-90"></a><span class="lineno"> 90</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-91"></a><span class="lineno"> 91</span> 
<a name="c0-92"></a><span class="lineno"> 92</span>   <span class="n">a</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-93"></a><span class="lineno"> 93</span>   <span class="n">memcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-94"></a><span class="lineno"> 94</span>   <span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-95"></a><span class="lineno"> 95</span>   <span class="n">a</span><span class="o">-&gt;</span><span class="n">h</span> <span class="o">=</span> <span class="n">hval</span><span class="p">;</span>
<a name="c0-96"></a><span class="lineno"> 96</span>   <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">git_attr_hash</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
<a name="c0-97"></a><span class="lineno"> 97</span>   <span class="n">a</span><span class="o">-&gt;</span><span class="n">attr_nr</span> <span class="o">=</span> <span class="n">attr_nr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-98"></a><span class="lineno"> 98</span>   <span class="n">git_attr_hash</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<a name="c0-99"></a><span class="lineno"> 99</span> 
<a name="c0-100"></a><span class="lineno">100</span>  <span class="n">check_all_attr</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">check_all_attr</span><span class="p">,</span>
<a name="c0-101"></a><span class="lineno">101</span>          <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">check_all_attr</span><span class="p">)</span> <span class="o">*</span> <span class="n">attr_nr</span><span class="p">);</span>
<a name="c0-102"></a><span class="lineno">102</span>  <span class="n">check_all_attr</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">attr_nr</span><span class="p">].</span><span class="n">attr</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<a name="c0-103"></a><span class="lineno">103</span>  <span class="n">check_all_attr</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">attr_nr</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">ATTR__UNKNOWN</span><span class="p">;</span>
<a name="c0-104"></a><span class="lineno">104</span>  <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<a name="c0-105"></a><span class="lineno">105</span> <span class="p">}</span>
<a name="c0-106"></a><span class="lineno">106</span> 
<a name="c0-107"></a><span class="lineno">107</span> <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="nf">git_attr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-108"></a><span class="lineno">108</span> <span class="p">{</span>
<a name="c0-109"></a><span class="lineno">109</span>  <span class="k">return</span> <span class="n">git_attr_internal</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
<a name="c0-110"></a><span class="lineno">110</span> <span class="p">}</span>
<a name="c0-111"></a><span class="lineno">111</span> 
<a name="c0-112"></a><span class="lineno">112</span> <span class="cm">/* What does a matched pattern decide? */</span>
<a name="c0-113"></a><span class="lineno">113</span> <span class="k">struct</span> <span class="n">attr_state</span> <span class="p">{</span>
<a name="c0-114"></a><span class="lineno">114</span>  <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
<a name="c0-115"></a><span class="lineno">115</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setto</span><span class="p">;</span>
<a name="c0-116"></a><span class="lineno">116</span> <span class="p">};</span>
<a name="c0-117"></a><span class="lineno">117</span> 
<a name="c0-118"></a><span class="lineno">118</span> <span class="cm">/*</span>
<a name="c0-119"></a><span class="lineno">119</span> <span class="cm"> * One rule, as from a .gitattributes file.</span>
<a name="c0-120"></a><span class="lineno">120</span> <span class="cm"> *</span>
<a name="c0-121"></a><span class="lineno">121</span> <span class="cm"> * If is_macro is true, then u.attr is a pointer to the git_attr being</span>
<a name="c0-122"></a><span class="lineno">122</span> <span class="cm"> * defined.</span>
<a name="c0-123"></a><span class="lineno">123</span> <span class="cm"> *</span>
<a name="c0-124"></a><span class="lineno">124</span> <span class="cm"> * If is_macro is false, then u.pattern points at the filename pattern</span>
<a name="c0-125"></a><span class="lineno">125</span> <span class="cm"> * to which the rule applies.  (The memory pointed to is part of the</span>
<a name="c0-126"></a><span class="lineno">126</span> <span class="cm"> * memory block allocated for the match_attr instance.)</span>
<a name="c0-127"></a><span class="lineno">127</span> <span class="cm"> *</span>
<a name="c0-128"></a><span class="lineno">128</span> <span class="cm"> * In either case, num_attr is the number of attributes affected by</span>
<a name="c0-129"></a><span class="lineno">129</span> <span class="cm"> * this rule, and state is an array listing them.  The attributes are</span>
<a name="c0-130"></a><span class="lineno">130</span> <span class="cm"> * listed as they appear in the file (macros unexpanded).</span>
<a name="c0-131"></a><span class="lineno">131</span> <span class="cm"> */</span>
<a name="c0-132"></a><span class="lineno">132</span> <span class="k">struct</span> <span class="n">match_attr</span> <span class="p">{</span>
<a name="c0-133"></a><span class="lineno">133</span>  <span class="k">union</span> <span class="p">{</span>
<a name="c0-134"></a><span class="lineno">134</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">;</span>
<a name="c0-135"></a><span class="lineno">135</span>    <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
<a name="c0-136"></a><span class="lineno">136</span>  <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<a name="c0-137"></a><span class="lineno">137</span>  <span class="kt">char</span> <span class="n">is_macro</span><span class="p">;</span>
<a name="c0-138"></a><span class="lineno">138</span>  <span class="kt">unsigned</span> <span class="n">num_attr</span><span class="p">;</span>
<a name="c0-139"></a><span class="lineno">139</span>  <span class="k">struct</span> <span class="n">attr_state</span> <span class="n">state</span><span class="p">[</span><span class="n">FLEX_ARRAY</span><span class="p">];</span>
<a name="c0-140"></a><span class="lineno">140</span> <span class="p">};</span>
<a name="c0-141"></a><span class="lineno">141</span> 
<a name="c0-142"></a><span class="lineno">142</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">blank</span><span class="p">[]</span> <span class="o">=</span> <span class="s">" </span><span class="se">\t\r\n</span><span class="s">"</span><span class="p">;</span>
<a name="c0-143"></a><span class="lineno">143</span> 
<a name="c0-144"></a><span class="lineno">144</span> <span class="cm">/*</span>
<a name="c0-145"></a><span class="lineno">145</span> <span class="cm"> * Parse a whitespace-delimited attribute state (i.e., "attr",</span>
<a name="c0-146"></a><span class="lineno">146</span> <span class="cm"> * "-attr", "!attr", or "attr=value") from the string starting at src.</span>
<a name="c0-147"></a><span class="lineno">147</span> <span class="cm"> * If e is not NULL, write the results to *e.  Return a pointer to the</span>
<a name="c0-148"></a><span class="lineno">148</span> <span class="cm"> * remainder of the string (with leading whitespace removed), or NULL</span>
<a name="c0-149"></a><span class="lineno">149</span> <span class="cm"> * if there was an error.</span>
<a name="c0-150"></a><span class="lineno">150</span> <span class="cm"> */</span>
<a name="c0-151"></a><span class="lineno">151</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">parse_attr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
<a name="c0-152"></a><span class="lineno">152</span>            <span class="k">struct</span> <span class="n">attr_state</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<a name="c0-153"></a><span class="lineno">153</span> <span class="p">{</span>
<a name="c0-154"></a><span class="lineno">154</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">equals</span><span class="p">;</span>
<a name="c0-155"></a><span class="lineno">155</span>  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-156"></a><span class="lineno">156</span> 
<a name="c0-157"></a><span class="lineno">157</span>  <span class="n">ep</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-158"></a><span class="lineno">158</span>  <span class="n">equals</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="sc">'='</span><span class="p">);</span>
<a name="c0-159"></a><span class="lineno">159</span>  <span class="k">if</span> <span class="p">(</span><span class="n">equals</span> <span class="o">&amp;&amp;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="n">equals</span><span class="p">)</span>
<a name="c0-160"></a><span class="lineno">160</span>    <span class="n">equals</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-161"></a><span class="lineno">161</span>  <span class="k">if</span> <span class="p">(</span><span class="n">equals</span><span class="p">)</span>
<a name="c0-162"></a><span class="lineno">162</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">equals</span> <span class="o">-</span> <span class="n">cp</span><span class="p">;</span>
<a name="c0-163"></a><span class="lineno">163</span>  <span class="k">else</span>
<a name="c0-164"></a><span class="lineno">164</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">cp</span><span class="p">;</span>
<a name="c0-165"></a><span class="lineno">165</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-166"></a><span class="lineno">166</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'!'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-167"></a><span class="lineno">167</span>      <span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c0-168"></a><span class="lineno">168</span>      <span class="n">len</span><span class="o">--</span><span class="p">;</span>
<a name="c0-169"></a><span class="lineno">169</span>    <span class="p">}</span>
<a name="c0-170"></a><span class="lineno">170</span>    <span class="k">if</span> <span class="p">(</span><span class="n">invalid_attr_name</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-171"></a><span class="lineno">171</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="c0-172"></a><span class="lineno">172</span>        <span class="s">"%.*s is not a valid attribute name: %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-173"></a><span class="lineno">173</span>        <span class="n">len</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">lineno</span><span class="p">);</span>
<a name="c0-174"></a><span class="lineno">174</span>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-175"></a><span class="lineno">175</span>    <span class="p">}</span>
<a name="c0-176"></a><span class="lineno">176</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-177"></a><span class="lineno">177</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'!'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-178"></a><span class="lineno">178</span>      <span class="n">e</span><span class="o">-&gt;</span><span class="n">setto</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="o">?</span> <span class="n">ATTR__FALSE</span> <span class="o">:</span> <span class="n">ATTR__UNSET</span><span class="p">;</span>
<a name="c0-179"></a><span class="lineno">179</span>      <span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c0-180"></a><span class="lineno">180</span>      <span class="n">len</span><span class="o">--</span><span class="p">;</span>
<a name="c0-181"></a><span class="lineno">181</span>    <span class="p">}</span>
<a name="c0-182"></a><span class="lineno">182</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">equals</span><span class="p">)</span>
<a name="c0-183"></a><span class="lineno">183</span>      <span class="n">e</span><span class="o">-&gt;</span><span class="n">setto</span> <span class="o">=</span> <span class="n">ATTR__TRUE</span><span class="p">;</span>
<a name="c0-184"></a><span class="lineno">184</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c0-185"></a><span class="lineno">185</span>      <span class="n">e</span><span class="o">-&gt;</span><span class="n">setto</span> <span class="o">=</span> <span class="n">xmemdupz</span><span class="p">(</span><span class="n">equals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">equals</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-186"></a><span class="lineno">186</span>    <span class="p">}</span>
<a name="c0-187"></a><span class="lineno">187</span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="n">git_attr_internal</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-188"></a><span class="lineno">188</span>  <span class="p">}</span>
<a name="c0-189"></a><span class="lineno">189</span>  <span class="k">return</span> <span class="n">ep</span> <span class="o">+</span> <span class="n">strspn</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-190"></a><span class="lineno">190</span> <span class="p">}</span>
<a name="c0-191"></a><span class="lineno">191</span> 
<a name="c0-192"></a><span class="lineno">192</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="nf">parse_attr_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
<a name="c0-193"></a><span class="lineno">193</span>            <span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">macro_ok</span><span class="p">)</span>
<a name="c0-194"></a><span class="lineno">194</span> <span class="p">{</span>
<a name="c0-195"></a><span class="lineno">195</span>  <span class="kt">int</span> <span class="n">namelen</span><span class="p">;</span>
<a name="c0-196"></a><span class="lineno">196</span>  <span class="kt">int</span> <span class="n">num_attr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-197"></a><span class="lineno">197</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">states</span><span class="p">;</span>
<a name="c0-198"></a><span class="lineno">198</span>  <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-199"></a><span class="lineno">199</span>  <span class="kt">int</span> <span class="n">is_macro</span><span class="p">;</span>
<a name="c0-200"></a><span class="lineno">200</span> 
<a name="c0-201"></a><span class="lineno">201</span>  <span class="n">cp</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">strspn</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-202"></a><span class="lineno">202</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">cp</span> <span class="o">||</span> <span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'#'</span><span class="p">)</span>
<a name="c0-203"></a><span class="lineno">203</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-204"></a><span class="lineno">204</span>  <span class="n">name</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>
<a name="c0-205"></a><span class="lineno">205</span>  <span class="n">namelen</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-206"></a><span class="lineno">206</span>  <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ATTRIBUTE_MACRO_PREFIX</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">namelen</span> <span class="o">&amp;&amp;</span>
<a name="c0-207"></a><span class="lineno">207</span>      <span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ATTRIBUTE_MACRO_PREFIX</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-208"></a><span class="lineno">208</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macro_ok</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-209"></a><span class="lineno">209</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s not allowed: %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-210"></a><span class="lineno">210</span>        <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">lineno</span><span class="p">);</span>
<a name="c0-211"></a><span class="lineno">211</span>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-212"></a><span class="lineno">212</span>    <span class="p">}</span>
<a name="c0-213"></a><span class="lineno">213</span>    <span class="n">is_macro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-214"></a><span class="lineno">214</span>    <span class="n">name</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ATTRIBUTE_MACRO_PREFIX</span><span class="p">);</span>
<a name="c0-215"></a><span class="lineno">215</span>    <span class="n">name</span> <span class="o">+=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-216"></a><span class="lineno">216</span>    <span class="n">namelen</span> <span class="o">=</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-217"></a><span class="lineno">217</span>    <span class="k">if</span> <span class="p">(</span><span class="n">invalid_attr_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-218"></a><span class="lineno">218</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="c0-219"></a><span class="lineno">219</span>        <span class="s">"%.*s is not a valid attribute name: %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-220"></a><span class="lineno">220</span>        <span class="n">namelen</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">lineno</span><span class="p">);</span>
<a name="c0-221"></a><span class="lineno">221</span>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-222"></a><span class="lineno">222</span>    <span class="p">}</span>
<a name="c0-223"></a><span class="lineno">223</span>  <span class="p">}</span>
<a name="c0-224"></a><span class="lineno">224</span>  <span class="k">else</span>
<a name="c0-225"></a><span class="lineno">225</span>    <span class="n">is_macro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-226"></a><span class="lineno">226</span> 
<a name="c0-227"></a><span class="lineno">227</span>  <span class="n">states</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="n">namelen</span><span class="p">;</span>
<a name="c0-228"></a><span class="lineno">228</span>  <span class="n">states</span> <span class="o">+=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">blank</span><span class="p">);</span>
<a name="c0-229"></a><span class="lineno">229</span> 
<a name="c0-230"></a><span class="lineno">230</span>  <span class="cm">/* First pass to count the attr_states */</span>
<a name="c0-231"></a><span class="lineno">231</span>  <span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">states</span><span class="p">,</span> <span class="n">num_attr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span> <span class="n">num_attr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-232"></a><span class="lineno">232</span>    <span class="n">cp</span> <span class="o">=</span> <span class="n">parse_attr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-233"></a><span class="lineno">233</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-234"></a><span class="lineno">234</span>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-235"></a><span class="lineno">235</span>  <span class="p">}</span>
<a name="c0-236"></a><span class="lineno">236</span> 
<a name="c0-237"></a><span class="lineno">237</span>  <span class="n">res</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
<a name="c0-238"></a><span class="lineno">238</span>          <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span> <span class="o">+</span>
<a name="c0-239"></a><span class="lineno">239</span>          <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attr_state</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_attr</span> <span class="o">+</span>
<a name="c0-240"></a><span class="lineno">240</span>          <span class="p">(</span><span class="n">is_macro</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<a name="c0-241"></a><span class="lineno">241</span>  <span class="k">if</span> <span class="p">(</span><span class="n">is_macro</span><span class="p">)</span>
<a name="c0-242"></a><span class="lineno">242</span>    <span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">git_attr_internal</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
<a name="c0-243"></a><span class="lineno">243</span>  <span class="k">else</span> <span class="p">{</span>
<a name="c0-244"></a><span class="lineno">244</span>    <span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">num_attr</span><span class="p">]);</span>
<a name="c0-245"></a><span class="lineno">245</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
<a name="c0-246"></a><span class="lineno">246</span>    <span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pattern</span><span class="p">[</span><span class="n">namelen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-247"></a><span class="lineno">247</span>  <span class="p">}</span>
<a name="c0-248"></a><span class="lineno">248</span>  <span class="n">res</span><span class="o">-&gt;</span><span class="n">is_macro</span> <span class="o">=</span> <span class="n">is_macro</span><span class="p">;</span>
<a name="c0-249"></a><span class="lineno">249</span>  <span class="n">res</span><span class="o">-&gt;</span><span class="n">num_attr</span> <span class="o">=</span> <span class="n">num_attr</span><span class="p">;</span>
<a name="c0-250"></a><span class="lineno">250</span> 
<a name="c0-251"></a><span class="lineno">251</span>  <span class="cm">/* Second pass to fill the attr_states */</span>
<a name="c0-252"></a><span class="lineno">252</span>  <span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">states</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-253"></a><span class="lineno">253</span>    <span class="n">cp</span> <span class="o">=</span> <span class="n">parse_attr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<a name="c0-254"></a><span class="lineno">254</span>  <span class="p">}</span>
<a name="c0-255"></a><span class="lineno">255</span> 
<a name="c0-256"></a><span class="lineno">256</span>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<a name="c0-257"></a><span class="lineno">257</span> <span class="p">}</span>
<a name="c0-258"></a><span class="lineno">258</span> 
<a name="c0-259"></a><span class="lineno">259</span> <span class="cm">/*</span>
<a name="c0-260"></a><span class="lineno">260</span> <span class="cm"> * Like info/exclude and .gitignore, the attribute information can</span>
<a name="c0-261"></a><span class="lineno">261</span> <span class="cm"> * come from many places.</span>
<a name="c0-262"></a><span class="lineno">262</span> <span class="cm"> *</span>
<a name="c0-263"></a><span class="lineno">263</span> <span class="cm"> * (1) .gitattribute file of the same directory;</span>
<a name="c0-264"></a><span class="lineno">264</span> <span class="cm"> * (2) .gitattribute file of the parent directory if (1) does not have</span>
<a name="c0-265"></a><span class="lineno">265</span> <span class="cm"> *      any match; this goes recursively upwards, just like .gitignore.</span>
<a name="c0-266"></a><span class="lineno">266</span> <span class="cm"> * (3) $GIT_DIR/info/attributes, which overrides both of the above.</span>
<a name="c0-267"></a><span class="lineno">267</span> <span class="cm"> *</span>
<a name="c0-268"></a><span class="lineno">268</span> <span class="cm"> * In the same file, later entries override the earlier match, so in the</span>
<a name="c0-269"></a><span class="lineno">269</span> <span class="cm"> * global list, we would have entries from info/attributes the earliest</span>
<a name="c0-270"></a><span class="lineno">270</span> <span class="cm"> * (reading the file from top to bottom), .gitattribute of the root</span>
<a name="c0-271"></a><span class="lineno">271</span> <span class="cm"> * directory (again, reading the file from top to bottom) down to the</span>
<a name="c0-272"></a><span class="lineno">272</span> <span class="cm"> * current directory, and then scan the list backwards to find the first match.</span>
<a name="c0-273"></a><span class="lineno">273</span> <span class="cm"> * This is exactly the same as what excluded() does in dir.c to deal with</span>
<a name="c0-274"></a><span class="lineno">274</span> <span class="cm"> * .gitignore</span>
<a name="c0-275"></a><span class="lineno">275</span> <span class="cm"> */</span>
<a name="c0-276"></a><span class="lineno">276</span> 
<a name="c0-277"></a><span class="lineno">277</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="p">{</span>
<a name="c0-278"></a><span class="lineno">278</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<a name="c0-279"></a><span class="lineno">279</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">origin</span><span class="p">;</span>
<a name="c0-280"></a><span class="lineno">280</span>  <span class="kt">unsigned</span> <span class="n">num_matches</span><span class="p">;</span>
<a name="c0-281"></a><span class="lineno">281</span>  <span class="kt">unsigned</span> <span class="n">alloc</span><span class="p">;</span>
<a name="c0-282"></a><span class="lineno">282</span>  <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">**</span><span class="n">attrs</span><span class="p">;</span>
<a name="c0-283"></a><span class="lineno">283</span> <span class="p">}</span> <span class="o">*</span><span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-284"></a><span class="lineno">284</span> 
<a name="c0-285"></a><span class="lineno">285</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">free_attr_elem</span><span class="p">(</span><span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<a name="c0-286"></a><span class="lineno">286</span> <span class="p">{</span>
<a name="c0-287"></a><span class="lineno">287</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-288"></a><span class="lineno">288</span>  <span class="n">free</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">);</span>
<a name="c0-289"></a><span class="lineno">289</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">num_matches</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-290"></a><span class="lineno">290</span>    <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-291"></a><span class="lineno">291</span>    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<a name="c0-292"></a><span class="lineno">292</span>    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">num_attr</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-293"></a><span class="lineno">293</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">setto</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">setto</span><span class="p">;</span>
<a name="c0-294"></a><span class="lineno">294</span>      <span class="k">if</span> <span class="p">(</span><span class="n">setto</span> <span class="o">==</span> <span class="n">ATTR__TRUE</span> <span class="o">||</span>
<a name="c0-295"></a><span class="lineno">295</span>          <span class="n">setto</span> <span class="o">==</span> <span class="n">ATTR__FALSE</span> <span class="o">||</span>
<a name="c0-296"></a><span class="lineno">296</span>          <span class="n">setto</span> <span class="o">==</span> <span class="n">ATTR__UNSET</span> <span class="o">||</span>
<a name="c0-297"></a><span class="lineno">297</span>          <span class="n">setto</span> <span class="o">==</span> <span class="n">ATTR__UNKNOWN</span><span class="p">)</span>
<a name="c0-298"></a><span class="lineno">298</span>        <span class="p">;</span>
<a name="c0-299"></a><span class="lineno">299</span>      <span class="k">else</span>
<a name="c0-300"></a><span class="lineno">300</span>        <span class="n">free</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">setto</span><span class="p">);</span>
<a name="c0-301"></a><span class="lineno">301</span>    <span class="p">}</span>
<a name="c0-302"></a><span class="lineno">302</span>    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<a name="c0-303"></a><span class="lineno">303</span>  <span class="p">}</span>
<a name="c0-304"></a><span class="lineno">304</span>  <span class="n">free</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>
<a name="c0-305"></a><span class="lineno">305</span>  <span class="n">free</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a name="c0-306"></a><span class="lineno">306</span> <span class="p">}</span>
<a name="c0-307"></a><span class="lineno">307</span> 
<a name="c0-308"></a><span class="lineno">308</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">builtin_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c0-309"></a><span class="lineno">309</span>  <span class="s">"[attr]binary -diff -text"</span><span class="p">,</span>
<a name="c0-310"></a><span class="lineno">310</span>  <span class="nb">NULL</span><span class="p">,</span>
<a name="c0-311"></a><span class="lineno">311</span> <span class="p">};</span>
<a name="c0-312"></a><span class="lineno">312</span> 
<a name="c0-313"></a><span class="lineno">313</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_attr_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
<a name="c0-314"></a><span class="lineno">314</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span>
<a name="c0-315"></a><span class="lineno">315</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
<a name="c0-316"></a><span class="lineno">316</span>           <span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span>
<a name="c0-317"></a><span class="lineno">317</span>           <span class="kt">int</span> <span class="n">macro_ok</span><span class="p">)</span>
<a name="c0-318"></a><span class="lineno">318</span> <span class="p">{</span>
<a name="c0-319"></a><span class="lineno">319</span>  <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
<a name="c0-320"></a><span class="lineno">320</span> 
<a name="c0-321"></a><span class="lineno">321</span>  <span class="n">a</span> <span class="o">=</span> <span class="n">parse_attr_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-322"></a><span class="lineno">322</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span>
<a name="c0-323"></a><span class="lineno">323</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-324"></a><span class="lineno">324</span>  <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">&lt;=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">num_matches</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-325"></a><span class="lineno">325</span>    <span class="n">res</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">alloc_nr</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">num_matches</span><span class="p">);</span>
<a name="c0-326"></a><span class="lineno">326</span>    <span class="n">res</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">,</span>
<a name="c0-327"></a><span class="lineno">327</span>              <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
<a name="c0-328"></a><span class="lineno">328</span>              <span class="n">res</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
<a name="c0-329"></a><span class="lineno">329</span>  <span class="p">}</span>
<a name="c0-330"></a><span class="lineno">330</span>  <span class="n">res</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">num_matches</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<a name="c0-331"></a><span class="lineno">331</span> <span class="p">}</span>
<a name="c0-332"></a><span class="lineno">332</span> 
<a name="c0-333"></a><span class="lineno">333</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="nf">read_attr_from_array</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<a name="c0-334"></a><span class="lineno">334</span> <span class="p">{</span>
<a name="c0-335"></a><span class="lineno">335</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
<a name="c0-336"></a><span class="lineno">336</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
<a name="c0-337"></a><span class="lineno">337</span>  <span class="kt">int</span> <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-338"></a><span class="lineno">338</span> 
<a name="c0-339"></a><span class="lineno">339</span>  <span class="n">res</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
<a name="c0-340"></a><span class="lineno">340</span>  <span class="k">while</span> <span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">list</span><span class="o">++</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="c0-341"></a><span class="lineno">341</span>    <span class="n">handle_attr_line</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s">"[builtin]"</span><span class="p">,</span> <span class="o">++</span><span class="n">lineno</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-342"></a><span class="lineno">342</span>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<a name="c0-343"></a><span class="lineno">343</span> <span class="p">}</span>
<a name="c0-344"></a><span class="lineno">344</span> 
<a name="c0-345"></a><span class="lineno">345</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">git_attr_direction</span> <span class="n">direction</span><span class="p">;</span>
<a name="c0-346"></a><span class="lineno">346</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">index_state</span> <span class="o">*</span><span class="n">use_index</span><span class="p">;</span>
<a name="c0-347"></a><span class="lineno">347</span> 
<a name="c0-348"></a><span class="lineno">348</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="nf">read_attr_from_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">macro_ok</span><span class="p">)</span>
<a name="c0-349"></a><span class="lineno">349</span> <span class="p">{</span>
<a name="c0-350"></a><span class="lineno">350</span>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
<a name="c0-351"></a><span class="lineno">351</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
<a name="c0-352"></a><span class="lineno">352</span>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
<a name="c0-353"></a><span class="lineno">353</span>  <span class="kt">int</span> <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-354"></a><span class="lineno">354</span> 
<a name="c0-355"></a><span class="lineno">355</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
<a name="c0-356"></a><span class="lineno">356</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-357"></a><span class="lineno">357</span>  <span class="n">res</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
<a name="c0-358"></a><span class="lineno">358</span>  <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fp</span><span class="p">))</span>
<a name="c0-359"></a><span class="lineno">359</span>    <span class="n">handle_attr_line</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">++</span><span class="n">lineno</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-360"></a><span class="lineno">360</span>  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<a name="c0-361"></a><span class="lineno">361</span>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<a name="c0-362"></a><span class="lineno">362</span> <span class="p">}</span>
<a name="c0-363"></a><span class="lineno">363</span> 
<a name="c0-364"></a><span class="lineno">364</span> <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">read_index_data</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<a name="c0-365"></a><span class="lineno">365</span> <span class="p">{</span>
<a name="c0-366"></a><span class="lineno">366</span>  <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-367"></a><span class="lineno">367</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-368"></a><span class="lineno">368</span>  <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-369"></a><span class="lineno">369</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c0-370"></a><span class="lineno">370</span> <span class="hll"> <span class="k">struct</span> <span class="n">index_state</span> <span class="o">*</span><span class="n">istate</span> <span class="o">=</span> <span class="n">use_index</span> <span class="o">?</span> <span class="n">use_index</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">the_index</span><span class="p">;</span>
</span><a name="c0-371"></a><span class="lineno">371</span> <span class="hll">
</span><a name="c0-372"></a><span class="lineno">372</span> <span class="hll">  <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span><a name="c0-373"></a><span class="lineno">373</span> <span class="hll">  <span class="n">pos</span> <span class="o">=</span> <span class="n">index_name_pos</span><span class="p">(</span><span class="n">istate</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><a name="c0-374"></a><span class="lineno">374</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><a name="c0-375"></a><span class="lineno">375</span> <span class="hll">    <span class="cm">/*</span>
</span><a name="c0-376"></a><span class="lineno">376</span> <span class="hll"><span class="cm">    * We might be in the middle of a merge, in which</span>
</span><a name="c0-377"></a><span class="lineno">377</span> <span class="hll"><span class="cm">    * case we would read stage #2 (ours).</span>
</span><a name="c0-378"></a><span class="lineno">378</span> <span class="hll"><span class="cm">    */</span>
</span><a name="c0-379"></a><span class="lineno">379</span> <span class="hll">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><a name="c0-380"></a><span class="lineno">380</span> <span class="hll">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c0-381"></a><span class="lineno">381</span> <span class="hll">         <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache_nr</span> <span class="o">&amp;&amp;</span>
</span><a name="c0-382"></a><span class="lineno">382</span> <span class="hll">          <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">));</span>
</span><a name="c0-383"></a><span class="lineno">383</span> <span class="hll">         <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><a name="c0-384"></a><span class="lineno">384</span> <span class="hll">      <span class="k">if</span> <span class="p">(</span><span class="n">ce_stage</span><span class="p">(</span><span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span><a name="c0-385"></a><span class="lineno">385</span> <span class="hll">        <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><a name="c0-386"></a><span class="lineno">386</span> <span class="hll">  <span class="p">}</span>
</span><a name="c0-387"></a><span class="lineno">387</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><a name="c0-388"></a><span class="lineno">388</span> <span class="hll">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><a name="c0-389"></a><span class="lineno">389</span>   <span class="n">data</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<a name="c0-390"></a><span class="lineno">390</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_BLOB</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-391"></a><span class="lineno">391</span>    <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c0-392"></a><span class="lineno">392</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-393"></a><span class="lineno">393</span>  <span class="p">}</span>
<a name="c0-394"></a><span class="lineno">394</span>  <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<a name="c0-395"></a><span class="lineno">395</span> <span class="p">}</span>
<a name="c0-396"></a><span class="lineno">396</span> 
<a name="c0-397"></a><span class="lineno">397</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="nf">read_attr_from_index</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">macro_ok</span><span class="p">)</span>
<a name="c0-398"></a><span class="lineno">398</span> <span class="p">{</span>
<a name="c0-399"></a><span class="lineno">399</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
<a name="c0-400"></a><span class="lineno">400</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
<a name="c0-401"></a><span class="lineno">401</span>  <span class="kt">int</span> <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-402"></a><span class="lineno">402</span> 
<a name="c0-403"></a><span class="lineno">403</span>  <span class="n">buf</span> <span class="o">=</span> <span class="n">read_index_data</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<a name="c0-404"></a><span class="lineno">404</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-405"></a><span class="lineno">405</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-406"></a><span class="lineno">406</span> 
<a name="c0-407"></a><span class="lineno">407</span>  <span class="n">res</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
<a name="c0-408"></a><span class="lineno">408</span>  <span class="k">for</span> <span class="p">(</span><span class="n">sp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
<a name="c0-409"></a><span class="lineno">409</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
<a name="c0-410"></a><span class="lineno">410</span>    <span class="kt">int</span> <span class="n">more</span><span class="p">;</span>
<a name="c0-411"></a><span class="lineno">411</span>    <span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span> <span class="o">*</span><span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ep</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span>
<a name="c0-412"></a><span class="lineno">412</span>      <span class="p">;</span>
<a name="c0-413"></a><span class="lineno">413</span>    <span class="n">more</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ep</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-414"></a><span class="lineno">414</span>    <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-415"></a><span class="lineno">415</span>    <span class="n">handle_attr_line</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">++</span><span class="n">lineno</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-416"></a><span class="lineno">416</span>    <span class="n">sp</span> <span class="o">=</span> <span class="n">ep</span> <span class="o">+</span> <span class="n">more</span><span class="p">;</span>
<a name="c0-417"></a><span class="lineno">417</span>  <span class="p">}</span>
<a name="c0-418"></a><span class="lineno">418</span>  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-419"></a><span class="lineno">419</span>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<a name="c0-420"></a><span class="lineno">420</span> <span class="p">}</span>
<a name="c0-421"></a><span class="lineno">421</span> 
<a name="c0-422"></a><span class="lineno">422</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="nf">read_attr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">macro_ok</span><span class="p">)</span>
<a name="c0-423"></a><span class="lineno">423</span> <span class="p">{</span>
<a name="c0-424"></a><span class="lineno">424</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
<a name="c0-425"></a><span class="lineno">425</span> 
<a name="c0-426"></a><span class="lineno">426</span>  <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">GIT_ATTR_CHECKOUT</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-427"></a><span class="lineno">427</span>    <span class="n">res</span> <span class="o">=</span> <span class="n">read_attr_from_index</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-428"></a><span class="lineno">428</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
<a name="c0-429"></a><span class="lineno">429</span>      <span class="n">res</span> <span class="o">=</span> <span class="n">read_attr_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-430"></a><span class="lineno">430</span>  <span class="p">}</span>
<a name="c0-431"></a><span class="lineno">431</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">GIT_ATTR_CHECKIN</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-432"></a><span class="lineno">432</span>    <span class="n">res</span> <span class="o">=</span> <span class="n">read_attr_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-433"></a><span class="lineno">433</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
<a name="c0-434"></a><span class="lineno">434</span>      <span class="cm">/*</span>
<a name="c0-435"></a><span class="lineno">435</span> <span class="cm">       * There is no checked out .gitattributes file there, but</span>
<a name="c0-436"></a><span class="lineno">436</span> <span class="cm">       * we might have it in the index.  We allow operation in a</span>
<a name="c0-437"></a><span class="lineno">437</span> <span class="cm">       * sparsely checked out work tree, so read from it.</span>
<a name="c0-438"></a><span class="lineno">438</span> <span class="cm">       */</span>
<a name="c0-439"></a><span class="lineno">439</span>      <span class="n">res</span> <span class="o">=</span> <span class="n">read_attr_from_index</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-440"></a><span class="lineno">440</span>  <span class="p">}</span>
<a name="c0-441"></a><span class="lineno">441</span>  <span class="k">else</span>
<a name="c0-442"></a><span class="lineno">442</span>    <span class="n">res</span> <span class="o">=</span> <span class="n">read_attr_from_index</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">macro_ok</span><span class="p">);</span>
<a name="c0-443"></a><span class="lineno">443</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
<a name="c0-444"></a><span class="lineno">444</span>    <span class="n">res</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">));</span>
<a name="c0-445"></a><span class="lineno">445</span>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<a name="c0-446"></a><span class="lineno">446</span> <span class="p">}</span>
<a name="c0-447"></a><span class="lineno">447</span> 
<a name="c0-448"></a><span class="lineno">448</span> <span class="cp">#if DEBUG_ATTR</span>
<a name="c0-449"></a><span class="lineno">449</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_info</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">elem</span><span class="p">)</span>
<a name="c0-450"></a><span class="lineno">450</span> <span class="p">{</span>
<a name="c0-451"></a><span class="lineno">451</span>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">?</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">:</span> <span class="s">"()"</span><span class="p">);</span>
<a name="c0-452"></a><span class="lineno">452</span> <span class="p">}</span>
<a name="c0-453"></a><span class="lineno">453</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span> <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<a name="c0-454"></a><span class="lineno">454</span> <span class="p">{</span>
<a name="c0-455"></a><span class="lineno">455</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
<a name="c0-456"></a><span class="lineno">456</span> 
<a name="c0-457"></a><span class="lineno">457</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_TRUE</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c0-458"></a><span class="lineno">458</span>    <span class="n">value</span> <span class="o">=</span> <span class="s">"set"</span><span class="p">;</span>
<a name="c0-459"></a><span class="lineno">459</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_FALSE</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c0-460"></a><span class="lineno">460</span>    <span class="n">value</span> <span class="o">=</span> <span class="s">"unset"</span><span class="p">;</span>
<a name="c0-461"></a><span class="lineno">461</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_UNSET</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c0-462"></a><span class="lineno">462</span>    <span class="n">value</span> <span class="o">=</span> <span class="s">"unspecified"</span><span class="p">;</span>
<a name="c0-463"></a><span class="lineno">463</span> 
<a name="c0-464"></a><span class="lineno">464</span>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: %s =&gt; %s (%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-465"></a><span class="lineno">465</span>    <span class="n">what</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="n">match</span><span class="p">);</span>
<a name="c0-466"></a><span class="lineno">466</span> <span class="p">}</span>
<a name="c0-467"></a><span class="lineno">467</span> <span class="cp">#define debug_push(a) debug_info("push", (a))</span>
<a name="c0-468"></a><span class="lineno">468</span> <span class="cp">#define debug_pop(a) debug_info("pop", (a))</span>
<a name="c0-469"></a><span class="lineno">469</span> <span class="cp">#else</span>
<a name="c0-470"></a><span class="lineno">470</span> <span class="cp">#define debug_push(a) do { ; } while (0)</span>
<a name="c0-471"></a><span class="lineno">471</span> <span class="cp">#define debug_pop(a) do { ; } while (0)</span>
<a name="c0-472"></a><span class="lineno">472</span> <span class="cp">#define debug_set(a,b,c,d) do { ; } while (0)</span>
<a name="c0-473"></a><span class="lineno">473</span> <span class="cp">#endif</span>
<a name="c0-474"></a><span class="lineno">474</span> 
<a name="c0-475"></a><span class="lineno">475</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">drop_attr_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-476"></a><span class="lineno">476</span> <span class="p">{</span>
<a name="c0-477"></a><span class="lineno">477</span>  <span class="k">while</span> <span class="p">(</span><span class="n">attr_stack</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-478"></a><span class="lineno">478</span>    <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">elem</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-479"></a><span class="lineno">479</span>    <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
<a name="c0-480"></a><span class="lineno">480</span>    <span class="n">free_attr_elem</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<a name="c0-481"></a><span class="lineno">481</span>  <span class="p">}</span>
<a name="c0-482"></a><span class="lineno">482</span> <span class="p">}</span>
<a name="c0-483"></a><span class="lineno">483</span> 
<a name="c0-484"></a><span class="lineno">484</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">git_etc_gitattributes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-485"></a><span class="lineno">485</span> <span class="p">{</span>
<a name="c0-486"></a><span class="lineno">486</span>  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">system_wide</span><span class="p">;</span>
<a name="c0-487"></a><span class="lineno">487</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">system_wide</span><span class="p">)</span>
<a name="c0-488"></a><span class="lineno">488</span>    <span class="n">system_wide</span> <span class="o">=</span> <span class="n">system_path</span><span class="p">(</span><span class="n">ETC_GITATTRIBUTES</span><span class="p">);</span>
<a name="c0-489"></a><span class="lineno">489</span>  <span class="k">return</span> <span class="n">system_wide</span><span class="p">;</span>
<a name="c0-490"></a><span class="lineno">490</span> <span class="p">}</span>
<a name="c0-491"></a><span class="lineno">491</span> 
<a name="c0-492"></a><span class="lineno">492</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_attr_system</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-493"></a><span class="lineno">493</span> <span class="p">{</span>
<a name="c0-494"></a><span class="lineno">494</span>  <span class="k">return</span> <span class="o">!</span><span class="n">git_env_bool</span><span class="p">(</span><span class="s">"GIT_ATTR_NOSYSTEM"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-495"></a><span class="lineno">495</span> <span class="p">}</span>
<a name="c0-496"></a><span class="lineno">496</span> 
<a name="c0-497"></a><span class="lineno">497</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">bootstrap_attr_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c0-498"></a><span class="lineno">498</span> <span class="p">{</span>
<a name="c0-499"></a><span class="lineno">499</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">elem</span><span class="p">;</span>
<a name="c0-500"></a><span class="lineno">500</span> 
<a name="c0-501"></a><span class="lineno">501</span>  <span class="k">if</span> <span class="p">(</span><span class="n">attr_stack</span><span class="p">)</span>
<a name="c0-502"></a><span class="lineno">502</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-503"></a><span class="lineno">503</span> 
<a name="c0-504"></a><span class="lineno">504</span>  <span class="n">elem</span> <span class="o">=</span> <span class="n">read_attr_from_array</span><span class="p">(</span><span class="n">builtin_attr</span><span class="p">);</span>
<a name="c0-505"></a><span class="lineno">505</span>  <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-506"></a><span class="lineno">506</span>  <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-507"></a><span class="lineno">507</span>  <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
<a name="c0-508"></a><span class="lineno">508</span> 
<a name="c0-509"></a><span class="lineno">509</span>  <span class="k">if</span> <span class="p">(</span><span class="n">git_attr_system</span><span class="p">())</span> <span class="p">{</span>
<a name="c0-510"></a><span class="lineno">510</span>    <span class="n">elem</span> <span class="o">=</span> <span class="n">read_attr_from_file</span><span class="p">(</span><span class="n">git_etc_gitattributes</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-511"></a><span class="lineno">511</span>    <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-512"></a><span class="lineno">512</span>      <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-513"></a><span class="lineno">513</span>      <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-514"></a><span class="lineno">514</span>      <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
<a name="c0-515"></a><span class="lineno">515</span>    <span class="p">}</span>
<a name="c0-516"></a><span class="lineno">516</span>  <span class="p">}</span>
<a name="c0-517"></a><span class="lineno">517</span> 
<a name="c0-518"></a><span class="lineno">518</span>  <span class="k">if</span> <span class="p">(</span><span class="n">git_attributes_file</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-519"></a><span class="lineno">519</span>    <span class="n">elem</span> <span class="o">=</span> <span class="n">read_attr_from_file</span><span class="p">(</span><span class="n">git_attributes_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-520"></a><span class="lineno">520</span>    <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-521"></a><span class="lineno">521</span>      <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-522"></a><span class="lineno">522</span>      <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-523"></a><span class="lineno">523</span>      <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
<a name="c0-524"></a><span class="lineno">524</span>    <span class="p">}</span>
<a name="c0-525"></a><span class="lineno">525</span>  <span class="p">}</span>
<a name="c0-526"></a><span class="lineno">526</span> 
<a name="c0-527"></a><span class="lineno">527</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_bare_repository</span><span class="p">()</span> <span class="o">||</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">GIT_ATTR_INDEX</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-528"></a><span class="lineno">528</span>    <span class="n">elem</span> <span class="o">=</span> <span class="n">read_attr</span><span class="p">(</span><span class="n">GITATTRIBUTES_FILE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-529"></a><span class="lineno">529</span>    <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
<a name="c0-530"></a><span class="lineno">530</span>    <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-531"></a><span class="lineno">531</span>    <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
<a name="c0-532"></a><span class="lineno">532</span>    <span class="n">debug_push</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<a name="c0-533"></a><span class="lineno">533</span>  <span class="p">}</span>
<a name="c0-534"></a><span class="lineno">534</span> 
<a name="c0-535"></a><span class="lineno">535</span>  <span class="n">elem</span> <span class="o">=</span> <span class="n">read_attr_from_file</span><span class="p">(</span><span class="n">git_path</span><span class="p">(</span><span class="n">INFOATTRIBUTES_FILE</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-536"></a><span class="lineno">536</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">elem</span><span class="p">)</span>
<a name="c0-537"></a><span class="lineno">537</span>    <span class="n">elem</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">elem</span><span class="p">));</span>
<a name="c0-538"></a><span class="lineno">538</span>  <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-539"></a><span class="lineno">539</span>  <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-540"></a><span class="lineno">540</span>  <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
<a name="c0-541"></a><span class="lineno">541</span> <span class="p">}</span>
<a name="c0-542"></a><span class="lineno">542</span> 
<a name="c0-543"></a><span class="lineno">543</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_attr_stack</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<a name="c0-544"></a><span class="lineno">544</span> <span class="p">{</span>
<a name="c0-545"></a><span class="lineno">545</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">elem</span><span class="p">,</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
<a name="c0-546"></a><span class="lineno">546</span>  <span class="kt">int</span> <span class="n">dirlen</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-547"></a><span class="lineno">547</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-548"></a><span class="lineno">548</span> 
<a name="c0-549"></a><span class="lineno">549</span>  <span class="n">cp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-550"></a><span class="lineno">550</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-551"></a><span class="lineno">551</span>    <span class="n">dirlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-552"></a><span class="lineno">552</span>  <span class="k">else</span>
<a name="c0-553"></a><span class="lineno">553</span>    <span class="n">dirlen</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">path</span><span class="p">;</span>
<a name="c0-554"></a><span class="lineno">554</span> 
<a name="c0-555"></a><span class="lineno">555</span>  <span class="cm">/*</span>
<a name="c0-556"></a><span class="lineno">556</span> <span class="cm">   * At the bottom of the attribute stack is the built-in</span>
<a name="c0-557"></a><span class="lineno">557</span> <span class="cm">   * set of attribute definitions, followed by the contents</span>
<a name="c0-558"></a><span class="lineno">558</span> <span class="cm">   * of $(prefix)/etc/gitattributes and a file specified by</span>
<a name="c0-559"></a><span class="lineno">559</span> <span class="cm">   * core.attributesfile.  Then, contents from</span>
<a name="c0-560"></a><span class="lineno">560</span> <span class="cm">   * .gitattribute files from directories closer to the</span>
<a name="c0-561"></a><span class="lineno">561</span> <span class="cm">   * root to the ones in deeper directories are pushed</span>
<a name="c0-562"></a><span class="lineno">562</span> <span class="cm">   * to the stack.  Finally, at the very top of the stack</span>
<a name="c0-563"></a><span class="lineno">563</span> <span class="cm">   * we always keep the contents of $GIT_DIR/info/attributes.</span>
<a name="c0-564"></a><span class="lineno">564</span> <span class="cm">   *</span>
<a name="c0-565"></a><span class="lineno">565</span> <span class="cm">   * When checking, we use entries from near the top of the</span>
<a name="c0-566"></a><span class="lineno">566</span> <span class="cm">   * stack, preferring $GIT_DIR/info/attributes, then</span>
<a name="c0-567"></a><span class="lineno">567</span> <span class="cm">   * .gitattributes in deeper directories to shallower ones,</span>
<a name="c0-568"></a><span class="lineno">568</span> <span class="cm">   * and finally use the built-in set as the default.</span>
<a name="c0-569"></a><span class="lineno">569</span> <span class="cm">   */</span>
<a name="c0-570"></a><span class="lineno">570</span>  <span class="n">bootstrap_attr_stack</span><span class="p">();</span>
<a name="c0-571"></a><span class="lineno">571</span> 
<a name="c0-572"></a><span class="lineno">572</span>  <span class="cm">/*</span>
<a name="c0-573"></a><span class="lineno">573</span> <span class="cm">   * Pop the "info" one that is always at the top of the stack.</span>
<a name="c0-574"></a><span class="lineno">574</span> <span class="cm">   */</span>
<a name="c0-575"></a><span class="lineno">575</span>  <span class="n">info</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-576"></a><span class="lineno">576</span>  <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
<a name="c0-577"></a><span class="lineno">577</span> 
<a name="c0-578"></a><span class="lineno">578</span>  <span class="cm">/*</span>
<a name="c0-579"></a><span class="lineno">579</span> <span class="cm">   * Pop the ones from directories that are not the prefix of</span>
<a name="c0-580"></a><span class="lineno">580</span> <span class="cm">   * the path we are checking. Break out of the loop when we see</span>
<a name="c0-581"></a><span class="lineno">581</span> <span class="cm">   * the root one (whose origin is an empty string "") or the builtin</span>
<a name="c0-582"></a><span class="lineno">582</span> <span class="cm">   * one (whose origin is NULL) without popping it.</span>
<a name="c0-583"></a><span class="lineno">583</span> <span class="cm">   */</span>
<a name="c0-584"></a><span class="lineno">584</span>  <span class="k">while</span> <span class="p">(</span><span class="n">attr_stack</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-585"></a><span class="lineno">585</span>    <span class="kt">int</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">attr_stack</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">);</span>
<a name="c0-586"></a><span class="lineno">586</span> 
<a name="c0-587"></a><span class="lineno">587</span>    <span class="n">elem</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-588"></a><span class="lineno">588</span>    <span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&lt;=</span> <span class="n">dirlen</span> <span class="o">&amp;&amp;</span>
<a name="c0-589"></a><span class="lineno">589</span>        <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">namelen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-590"></a><span class="lineno">590</span>        <span class="p">(</span><span class="o">!</span><span class="n">namelen</span> <span class="o">||</span> <span class="n">path</span><span class="p">[</span><span class="n">namelen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">))</span>
<a name="c0-591"></a><span class="lineno">591</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-592"></a><span class="lineno">592</span> 
<a name="c0-593"></a><span class="lineno">593</span>    <span class="n">debug_pop</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<a name="c0-594"></a><span class="lineno">594</span>    <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
<a name="c0-595"></a><span class="lineno">595</span>    <span class="n">free_attr_elem</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<a name="c0-596"></a><span class="lineno">596</span>  <span class="p">}</span>
<a name="c0-597"></a><span class="lineno">597</span> 
<a name="c0-598"></a><span class="lineno">598</span>  <span class="cm">/*</span>
<a name="c0-599"></a><span class="lineno">599</span> <span class="cm">   * Read from parent directories and push them down</span>
<a name="c0-600"></a><span class="lineno">600</span> <span class="cm">   */</span>
<a name="c0-601"></a><span class="lineno">601</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_bare_repository</span><span class="p">()</span> <span class="o">||</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">GIT_ATTR_INDEX</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-602"></a><span class="lineno">602</span>    <span class="cm">/*</span>
<a name="c0-603"></a><span class="lineno">603</span> <span class="cm">     * bootstrap_attr_stack() should have added, and the</span>
<a name="c0-604"></a><span class="lineno">604</span> <span class="cm">     * above loop should have stopped before popping, the</span>
<a name="c0-605"></a><span class="lineno">605</span> <span class="cm">     * root element whose attr_stack-&gt;origin is set to an</span>
<a name="c0-606"></a><span class="lineno">606</span> <span class="cm">     * empty string.</span>
<a name="c0-607"></a><span class="lineno">607</span> <span class="cm">     */</span>
<a name="c0-608"></a><span class="lineno">608</span>    <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">pathbuf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-609"></a><span class="lineno">609</span> 
<a name="c0-610"></a><span class="lineno">610</span>    <span class="n">assert</span><span class="p">(</span><span class="n">attr_stack</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">);</span>
<a name="c0-611"></a><span class="lineno">611</span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-612"></a><span class="lineno">612</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">attr_stack</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">);</span>
<a name="c0-613"></a><span class="lineno">613</span>      <span class="k">if</span> <span class="p">(</span><span class="n">dirlen</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-614"></a><span class="lineno">614</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-615"></a><span class="lineno">615</span>      <span class="n">cp</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">,</span> <span class="n">dirlen</span> <span class="o">-</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-616"></a><span class="lineno">616</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-617"></a><span class="lineno">617</span>        <span class="n">cp</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">dirlen</span><span class="p">;</span>
<a name="c0-618"></a><span class="lineno">618</span>      <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pathbuf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-619"></a><span class="lineno">619</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pathbuf</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-620"></a><span class="lineno">620</span>      <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pathbuf</span><span class="p">,</span> <span class="n">GITATTRIBUTES_FILE</span><span class="p">);</span>
<a name="c0-621"></a><span class="lineno">621</span>      <span class="n">elem</span> <span class="o">=</span> <span class="n">read_attr</span><span class="p">(</span><span class="n">pathbuf</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-622"></a><span class="lineno">622</span>      <span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pathbuf</span><span class="p">,</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-623"></a><span class="lineno">623</span>      <span class="n">elem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pathbuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-624"></a><span class="lineno">624</span>      <span class="n">elem</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-625"></a><span class="lineno">625</span>      <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
<a name="c0-626"></a><span class="lineno">626</span>      <span class="n">debug_push</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
<a name="c0-627"></a><span class="lineno">627</span>    <span class="p">}</span>
<a name="c0-628"></a><span class="lineno">628</span> 
<a name="c0-629"></a><span class="lineno">629</span>    <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pathbuf</span><span class="p">);</span>
<a name="c0-630"></a><span class="lineno">630</span>  <span class="p">}</span>
<a name="c0-631"></a><span class="lineno">631</span> 
<a name="c0-632"></a><span class="lineno">632</span>  <span class="cm">/*</span>
<a name="c0-633"></a><span class="lineno">633</span> <span class="cm">   * Finally push the "info" one at the top of the stack.</span>
<a name="c0-634"></a><span class="lineno">634</span> <span class="cm">   */</span>
<a name="c0-635"></a><span class="lineno">635</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span>
<a name="c0-636"></a><span class="lineno">636</span>  <span class="n">attr_stack</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
<a name="c0-637"></a><span class="lineno">637</span> <span class="p">}</span>
<a name="c0-638"></a><span class="lineno">638</span> 
<a name="c0-639"></a><span class="lineno">639</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">path_matches</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pathlen</span><span class="p">,</span>
<a name="c0-640"></a><span class="lineno">640</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">,</span>
<a name="c0-641"></a><span class="lineno">641</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baselen</span><span class="p">)</span>
<a name="c0-642"></a><span class="lineno">642</span> <span class="p">{</span>
<a name="c0-643"></a><span class="lineno">643</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strchr</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-644"></a><span class="lineno">644</span>    <span class="cm">/* match basename */</span>
<a name="c0-645"></a><span class="lineno">645</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">basename</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-646"></a><span class="lineno">646</span>    <span class="n">basename</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">?</span> <span class="n">basename</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">pathname</span><span class="p">;</span>
<a name="c0-647"></a><span class="lineno">647</span>    <span class="k">return</span> <span class="p">(</span><span class="n">fnmatch_icase</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-648"></a><span class="lineno">648</span>  <span class="p">}</span>
<a name="c0-649"></a><span class="lineno">649</span>  <span class="cm">/*</span>
<a name="c0-650"></a><span class="lineno">650</span> <span class="cm">   * match with FNM_PATHNAME; the pattern has base implicitly</span>
<a name="c0-651"></a><span class="lineno">651</span> <span class="cm">   * in front of it.</span>
<a name="c0-652"></a><span class="lineno">652</span> <span class="cm">   */</span>
<a name="c0-653"></a><span class="lineno">653</span>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pattern</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
<a name="c0-654"></a><span class="lineno">654</span>    <span class="n">pattern</span><span class="o">++</span><span class="p">;</span>
<a name="c0-655"></a><span class="lineno">655</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pathlen</span> <span class="o">&lt;</span> <span class="n">baselen</span> <span class="o">||</span>
<a name="c0-656"></a><span class="lineno">656</span>      <span class="p">(</span><span class="n">baselen</span> <span class="o">&amp;&amp;</span> <span class="n">pathname</span><span class="p">[</span><span class="n">baselen</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-657"></a><span class="lineno">657</span>      <span class="n">strncmp</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">baselen</span><span class="p">))</span>
<a name="c0-658"></a><span class="lineno">658</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-659"></a><span class="lineno">659</span>  <span class="k">if</span> <span class="p">(</span><span class="n">baselen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-660"></a><span class="lineno">660</span>    <span class="n">baselen</span><span class="o">++</span><span class="p">;</span>
<a name="c0-661"></a><span class="lineno">661</span>  <span class="k">return</span> <span class="n">fnmatch_icase</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">pathname</span> <span class="o">+</span> <span class="n">baselen</span><span class="p">,</span> <span class="n">FNM_PATHNAME</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-662"></a><span class="lineno">662</span> <span class="p">}</span>
<a name="c0-663"></a><span class="lineno">663</span> 
<a name="c0-664"></a><span class="lineno">664</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">macroexpand_one</span><span class="p">(</span><span class="kt">int</span> <span class="n">attr_nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rem</span><span class="p">);</span>
<a name="c0-665"></a><span class="lineno">665</span> 
<a name="c0-666"></a><span class="lineno">666</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_one</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">,</span> <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rem</span><span class="p">)</span>
<a name="c0-667"></a><span class="lineno">667</span> <span class="p">{</span>
<a name="c0-668"></a><span class="lineno">668</span>  <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span> <span class="o">=</span> <span class="n">check_all_attr</span><span class="p">;</span>
<a name="c0-669"></a><span class="lineno">669</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-670"></a><span class="lineno">670</span> 
<a name="c0-671"></a><span class="lineno">671</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">num_attr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rem</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-672"></a><span class="lineno">672</span>    <span class="k">struct</span> <span class="n">git_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">;</span>
<a name="c0-673"></a><span class="lineno">673</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">n</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_nr</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
<a name="c0-674"></a><span class="lineno">674</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setto</span><span class="p">;</span>
<a name="c0-675"></a><span class="lineno">675</span> 
<a name="c0-676"></a><span class="lineno">676</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">n</span> <span class="o">==</span> <span class="n">ATTR__UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-677"></a><span class="lineno">677</span>      <span class="n">debug_set</span><span class="p">(</span><span class="n">what</span><span class="p">,</span>
<a name="c0-678"></a><span class="lineno">678</span>          <span class="n">a</span><span class="o">-&gt;</span><span class="n">is_macro</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pattern</span><span class="p">,</span>
<a name="c0-679"></a><span class="lineno">679</span>          <span class="n">attr</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<a name="c0-680"></a><span class="lineno">680</span>      <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
<a name="c0-681"></a><span class="lineno">681</span>      <span class="n">rem</span><span class="o">--</span><span class="p">;</span>
<a name="c0-682"></a><span class="lineno">682</span>      <span class="n">rem</span> <span class="o">=</span> <span class="n">macroexpand_one</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_nr</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>
<a name="c0-683"></a><span class="lineno">683</span>    <span class="p">}</span>
<a name="c0-684"></a><span class="lineno">684</span>  <span class="p">}</span>
<a name="c0-685"></a><span class="lineno">685</span>  <span class="k">return</span> <span class="n">rem</span><span class="p">;</span>
<a name="c0-686"></a><span class="lineno">686</span> <span class="p">}</span>
<a name="c0-687"></a><span class="lineno">687</span> 
<a name="c0-688"></a><span class="lineno">688</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fill</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pathlen</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">stk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rem</span><span class="p">)</span>
<a name="c0-689"></a><span class="lineno">689</span> <span class="p">{</span>
<a name="c0-690"></a><span class="lineno">690</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-691"></a><span class="lineno">691</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">?</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">:</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-692"></a><span class="lineno">692</span> 
<a name="c0-693"></a><span class="lineno">693</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">num_matches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rem</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-694"></a><span class="lineno">694</span>    <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-695"></a><span class="lineno">695</span>    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">is_macro</span><span class="p">)</span>
<a name="c0-696"></a><span class="lineno">696</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-697"></a><span class="lineno">697</span>    <span class="k">if</span> <span class="p">(</span><span class="n">path_matches</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pathlen</span><span class="p">,</span>
<a name="c0-698"></a><span class="lineno">698</span>         <span class="n">a</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pattern</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">base</span><span class="p">)))</span>
<a name="c0-699"></a><span class="lineno">699</span>      <span class="n">rem</span> <span class="o">=</span> <span class="n">fill_one</span><span class="p">(</span><span class="s">"fill"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>
<a name="c0-700"></a><span class="lineno">700</span>  <span class="p">}</span>
<a name="c0-701"></a><span class="lineno">701</span>  <span class="k">return</span> <span class="n">rem</span><span class="p">;</span>
<a name="c0-702"></a><span class="lineno">702</span> <span class="p">}</span>
<a name="c0-703"></a><span class="lineno">703</span> 
<a name="c0-704"></a><span class="lineno">704</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">macroexpand_one</span><span class="p">(</span><span class="kt">int</span> <span class="n">attr_nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rem</span><span class="p">)</span>
<a name="c0-705"></a><span class="lineno">705</span> <span class="p">{</span>
<a name="c0-706"></a><span class="lineno">706</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
<a name="c0-707"></a><span class="lineno">707</span>  <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-708"></a><span class="lineno">708</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-709"></a><span class="lineno">709</span> 
<a name="c0-710"></a><span class="lineno">710</span>  <span class="k">if</span> <span class="p">(</span><span class="n">check_all_attr</span><span class="p">[</span><span class="n">attr_nr</span><span class="p">].</span><span class="n">value</span> <span class="o">!=</span> <span class="n">ATTR__TRUE</span><span class="p">)</span>
<a name="c0-711"></a><span class="lineno">711</span>    <span class="k">return</span> <span class="n">rem</span><span class="p">;</span>
<a name="c0-712"></a><span class="lineno">712</span> 
<a name="c0-713"></a><span class="lineno">713</span>  <span class="k">for</span> <span class="p">(</span><span class="n">stk</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span> <span class="o">!</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">stk</span><span class="p">;</span> <span class="n">stk</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span>
<a name="c0-714"></a><span class="lineno">714</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">num_matches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">!</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-715"></a><span class="lineno">715</span>      <span class="k">struct</span> <span class="n">match_attr</span> <span class="o">*</span><span class="n">ma</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-716"></a><span class="lineno">716</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">is_macro</span><span class="p">)</span>
<a name="c0-717"></a><span class="lineno">717</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c0-718"></a><span class="lineno">718</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ma</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_nr</span> <span class="o">==</span> <span class="n">attr_nr</span><span class="p">)</span>
<a name="c0-719"></a><span class="lineno">719</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">ma</span><span class="p">;</span>
<a name="c0-720"></a><span class="lineno">720</span>    <span class="p">}</span>
<a name="c0-721"></a><span class="lineno">721</span> 
<a name="c0-722"></a><span class="lineno">722</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
<a name="c0-723"></a><span class="lineno">723</span>    <span class="n">rem</span> <span class="o">=</span> <span class="n">fill_one</span><span class="p">(</span><span class="s">"expand"</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>
<a name="c0-724"></a><span class="lineno">724</span> 
<a name="c0-725"></a><span class="lineno">725</span>  <span class="k">return</span> <span class="n">rem</span><span class="p">;</span>
<a name="c0-726"></a><span class="lineno">726</span> <span class="p">}</span>
<a name="c0-727"></a><span class="lineno">727</span> 
<a name="c0-728"></a><span class="lineno">728</span> <span class="cm">/*</span>
<a name="c0-729"></a><span class="lineno">729</span> <span class="cm"> * Collect all attributes for path into the array pointed to by</span>
<a name="c0-730"></a><span class="lineno">730</span> <span class="cm"> * check_all_attr.</span>
<a name="c0-731"></a><span class="lineno">731</span> <span class="cm"> */</span>
<a name="c0-732"></a><span class="lineno">732</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">collect_all_attrs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<a name="c0-733"></a><span class="lineno">733</span> <span class="p">{</span>
<a name="c0-734"></a><span class="lineno">734</span>  <span class="k">struct</span> <span class="n">attr_stack</span> <span class="o">*</span><span class="n">stk</span><span class="p">;</span>
<a name="c0-735"></a><span class="lineno">735</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pathlen</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>
<a name="c0-736"></a><span class="lineno">736</span> 
<a name="c0-737"></a><span class="lineno">737</span>  <span class="n">prepare_attr_stack</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<a name="c0-738"></a><span class="lineno">738</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attr_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-739"></a><span class="lineno">739</span>    <span class="n">check_all_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">ATTR__UNKNOWN</span><span class="p">;</span>
<a name="c0-740"></a><span class="lineno">740</span> 
<a name="c0-741"></a><span class="lineno">741</span>  <span class="n">pathlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<a name="c0-742"></a><span class="lineno">742</span>  <span class="n">rem</span> <span class="o">=</span> <span class="n">attr_nr</span><span class="p">;</span>
<a name="c0-743"></a><span class="lineno">743</span>  <span class="k">for</span> <span class="p">(</span><span class="n">stk</span> <span class="o">=</span> <span class="n">attr_stack</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rem</span> <span class="o">&amp;&amp;</span> <span class="n">stk</span><span class="p">;</span> <span class="n">stk</span> <span class="o">=</span> <span class="n">stk</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span>
<a name="c0-744"></a><span class="lineno">744</span>    <span class="n">rem</span> <span class="o">=</span> <span class="n">fill</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pathlen</span><span class="p">,</span> <span class="n">stk</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>
<a name="c0-745"></a><span class="lineno">745</span> <span class="p">}</span>
<a name="c0-746"></a><span class="lineno">746</span> 
<a name="c0-747"></a><span class="lineno">747</span> <span class="kt">int</span> <span class="nf">git_check_attr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<a name="c0-748"></a><span class="lineno">748</span> <span class="p">{</span>
<a name="c0-749"></a><span class="lineno">749</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-750"></a><span class="lineno">750</span> 
<a name="c0-751"></a><span class="lineno">751</span>  <span class="n">collect_all_attrs</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<a name="c0-752"></a><span class="lineno">752</span> 
<a name="c0-753"></a><span class="lineno">753</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-754"></a><span class="lineno">754</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check_all_attr</span><span class="p">[</span><span class="n">check</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr_nr</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
<a name="c0-755"></a><span class="lineno">755</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">ATTR__UNKNOWN</span><span class="p">)</span>
<a name="c0-756"></a><span class="lineno">756</span>      <span class="n">value</span> <span class="o">=</span> <span class="n">ATTR__UNSET</span><span class="p">;</span>
<a name="c0-757"></a><span class="lineno">757</span>    <span class="n">check</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<a name="c0-758"></a><span class="lineno">758</span>  <span class="p">}</span>
<a name="c0-759"></a><span class="lineno">759</span> 
<a name="c0-760"></a><span class="lineno">760</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-761"></a><span class="lineno">761</span> <span class="p">}</span>
<a name="c0-762"></a><span class="lineno">762</span> 
<a name="c0-763"></a><span class="lineno">763</span> <span class="kt">int</span> <span class="nf">git_all_attrs</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">**</span><span class="n">check</span><span class="p">)</span>
<a name="c0-764"></a><span class="lineno">764</span> <span class="p">{</span>
<a name="c0-765"></a><span class="lineno">765</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<a name="c0-766"></a><span class="lineno">766</span> 
<a name="c0-767"></a><span class="lineno">767</span>  <span class="n">collect_all_attrs</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<a name="c0-768"></a><span class="lineno">768</span> 
<a name="c0-769"></a><span class="lineno">769</span>  <span class="cm">/* Count the number of attributes that are set. */</span>
<a name="c0-770"></a><span class="lineno">770</span>  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-771"></a><span class="lineno">771</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attr_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-772"></a><span class="lineno">772</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check_all_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
<a name="c0-773"></a><span class="lineno">773</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">ATTR__UNSET</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">ATTR__UNKNOWN</span><span class="p">)</span>
<a name="c0-774"></a><span class="lineno">774</span>      <span class="o">++</span><span class="n">count</span><span class="p">;</span>
<a name="c0-775"></a><span class="lineno">775</span>  <span class="p">}</span>
<a name="c0-776"></a><span class="lineno">776</span>  <span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<a name="c0-777"></a><span class="lineno">777</span>  <span class="o">*</span><span class="n">check</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">**</span><span class="n">check</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">);</span>
<a name="c0-778"></a><span class="lineno">778</span>  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-779"></a><span class="lineno">779</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attr_nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-780"></a><span class="lineno">780</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check_all_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
<a name="c0-781"></a><span class="lineno">781</span>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">ATTR__UNSET</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">ATTR__UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-782"></a><span class="lineno">782</span>      <span class="p">(</span><span class="o">*</span><span class="n">check</span><span class="p">)[</span><span class="n">j</span><span class="p">].</span><span class="n">attr</span> <span class="o">=</span> <span class="n">check_all_attr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">;</span>
<a name="c0-783"></a><span class="lineno">783</span>      <span class="p">(</span><span class="o">*</span><span class="n">check</span><span class="p">)[</span><span class="n">j</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<a name="c0-784"></a><span class="lineno">784</span>      <span class="o">++</span><span class="n">j</span><span class="p">;</span>
<a name="c0-785"></a><span class="lineno">785</span>    <span class="p">}</span>
<a name="c0-786"></a><span class="lineno">786</span>  <span class="p">}</span>
<a name="c0-787"></a><span class="lineno">787</span> 
<a name="c0-788"></a><span class="lineno">788</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-789"></a><span class="lineno">789</span> <span class="p">}</span>
<a name="c0-790"></a><span class="lineno">790</span> 
<a name="c0-791"></a><span class="lineno">791</span> <span class="kt">void</span> <span class="nf">git_attr_set_direction</span><span class="p">(</span><span class="k">enum</span> <span class="n">git_attr_direction</span> <span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">index_state</span> <span class="o">*</span><span class="n">istate</span><span class="p">)</span>
<a name="c0-792"></a><span class="lineno">792</span> <span class="p">{</span>
<a name="c0-793"></a><span class="lineno">793</span>  <span class="k">enum</span> <span class="n">git_attr_direction</span> <span class="n">old</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
<a name="c0-794"></a><span class="lineno">794</span> 
<a name="c0-795"></a><span class="lineno">795</span>  <span class="k">if</span> <span class="p">(</span><span class="n">is_bare_repository</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">GIT_ATTR_INDEX</span><span class="p">)</span>
<a name="c0-796"></a><span class="lineno">796</span>    <span class="n">die</span><span class="p">(</span><span class="s">"BUG: non-INDEX attr direction in a bare repo"</span><span class="p">);</span>
<a name="c0-797"></a><span class="lineno">797</span> 
<a name="c0-798"></a><span class="lineno">798</span>  <span class="n">direction</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
<a name="c0-799"></a><span class="lineno">799</span>  <span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
<a name="c0-800"></a><span class="lineno">800</span>    <span class="n">drop_attr_stack</span><span class="p">();</span>
<a name="c0-801"></a><span class="lineno">801</span>  <span class="n">use_index</span> <span class="o">=</span> <span class="n">istate</span><span class="p">;</span>
<a name="c0-802"></a><span class="lineno">802</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> convert.c 
                <small> (160,31)-(178,10)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">   1</span> <span class="cp">#include "cache.h"</span>
<a name="c1-2"></a><span class="lineno">   2</span> <span class="cp">#include "attr.h"</span>
<a name="c1-3"></a><span class="lineno">   3</span> <span class="cp">#include "run-command.h"</span>
<a name="c1-4"></a><span class="lineno">   4</span> <span class="cp">#include "quote.h"</span>
<a name="c1-5"></a><span class="lineno">   5</span> 
<a name="c1-6"></a><span class="lineno">   6</span> <span class="cm">/*</span>
<a name="c1-7"></a><span class="lineno">   7</span> <span class="cm"> * convert.c - convert a file when checking it out and checking it in.</span>
<a name="c1-8"></a><span class="lineno">   8</span> <span class="cm"> *</span>
<a name="c1-9"></a><span class="lineno">   9</span> <span class="cm"> * This should use the pathname to decide on whether it wants to do some</span>
<a name="c1-10"></a><span class="lineno">  10</span> <span class="cm"> * more interesting conversions (automatic gzip/unzip, general format</span>
<a name="c1-11"></a><span class="lineno">  11</span> <span class="cm"> * conversions etc etc), but by default it just does automatic CRLF&lt;-&gt;LF</span>
<a name="c1-12"></a><span class="lineno">  12</span> <span class="cm"> * translation when the "text" attribute or "auto_crlf" option is set.</span>
<a name="c1-13"></a><span class="lineno">  13</span> <span class="cm"> */</span>
<a name="c1-14"></a><span class="lineno">  14</span> 
<a name="c1-15"></a><span class="lineno">  15</span> <span class="k">enum</span> <span class="n">crlf_action</span> <span class="p">{</span>
<a name="c1-16"></a><span class="lineno">  16</span>  <span class="n">CRLF_GUESS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<a name="c1-17"></a><span class="lineno">  17</span>  <span class="n">CRLF_BINARY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a name="c1-18"></a><span class="lineno">  18</span>  <span class="n">CRLF_TEXT</span><span class="p">,</span>
<a name="c1-19"></a><span class="lineno">  19</span>  <span class="n">CRLF_INPUT</span><span class="p">,</span>
<a name="c1-20"></a><span class="lineno">  20</span>  <span class="n">CRLF_CRLF</span><span class="p">,</span>
<a name="c1-21"></a><span class="lineno">  21</span>  <span class="n">CRLF_AUTO</span>
<a name="c1-22"></a><span class="lineno">  22</span> <span class="p">};</span>
<a name="c1-23"></a><span class="lineno">  23</span> 
<a name="c1-24"></a><span class="lineno">  24</span> <span class="k">struct</span> <span class="n">text_stat</span> <span class="p">{</span>
<a name="c1-25"></a><span class="lineno">  25</span>  <span class="cm">/* NUL, CR, LF and CRLF counts */</span>
<a name="c1-26"></a><span class="lineno">  26</span>  <span class="kt">unsigned</span> <span class="n">nul</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">crlf</span><span class="p">;</span>
<a name="c1-27"></a><span class="lineno">  27</span> 
<a name="c1-28"></a><span class="lineno">  28</span>  <span class="cm">/* These are just approximations! */</span>
<a name="c1-29"></a><span class="lineno">  29</span>  <span class="kt">unsigned</span> <span class="n">printable</span><span class="p">,</span> <span class="n">nonprintable</span><span class="p">;</span>
<a name="c1-30"></a><span class="lineno">  30</span> <span class="p">};</span>
<a name="c1-31"></a><span class="lineno">  31</span> 
<a name="c1-32"></a><span class="lineno">  32</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">gather_stats</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">text_stat</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<a name="c1-33"></a><span class="lineno">  33</span> <span class="p">{</span>
<a name="c1-34"></a><span class="lineno">  34</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-35"></a><span class="lineno">  35</span> 
<a name="c1-36"></a><span class="lineno">  36</span>  <span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>
<a name="c1-37"></a><span class="lineno">  37</span> 
<a name="c1-38"></a><span class="lineno">  38</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-39"></a><span class="lineno">  39</span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c1-40"></a><span class="lineno">  40</span>    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-41"></a><span class="lineno">  41</span>      <span class="n">stats</span><span class="o">-&gt;</span><span class="n">cr</span><span class="o">++</span><span class="p">;</span>
<a name="c1-42"></a><span class="lineno">  42</span>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-43"></a><span class="lineno">  43</span>        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">crlf</span><span class="o">++</span><span class="p">;</span>
<a name="c1-44"></a><span class="lineno">  44</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-45"></a><span class="lineno">  45</span>    <span class="p">}</span>
<a name="c1-46"></a><span class="lineno">  46</span>    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-47"></a><span class="lineno">  47</span>      <span class="n">stats</span><span class="o">-&gt;</span><span class="n">lf</span><span class="o">++</span><span class="p">;</span>
<a name="c1-48"></a><span class="lineno">  48</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-49"></a><span class="lineno">  49</span>    <span class="p">}</span>
<a name="c1-50"></a><span class="lineno">  50</span>    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span>
<a name="c1-51"></a><span class="lineno">  51</span>      <span class="cm">/* DEL */</span>
<a name="c1-52"></a><span class="lineno">  52</span>      <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nonprintable</span><span class="o">++</span><span class="p">;</span>
<a name="c1-53"></a><span class="lineno">  53</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-54"></a><span class="lineno">  54</span>      <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-55"></a><span class="lineno">  55</span>        <span class="cm">/* BS, HT, ESC and FF */</span>
<a name="c1-56"></a><span class="lineno">  56</span>      <span class="k">case</span> <span class="sc">'\b'</span>: <span class="k">case</span> <span class="sc">'\t'</span>: <span class="k">case</span> <span class="sc">'\033'</span>: <span class="k">case</span> <span class="sc">'\014'</span>:
<a name="c1-57"></a><span class="lineno">  57</span>        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">printable</span><span class="o">++</span><span class="p">;</span>
<a name="c1-58"></a><span class="lineno">  58</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-59"></a><span class="lineno">  59</span>      <span class="k">case</span> <span class="mi">0</span>:
<a name="c1-60"></a><span class="lineno">  60</span>        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nul</span><span class="o">++</span><span class="p">;</span>
<a name="c1-61"></a><span class="lineno">  61</span>        <span class="cm">/* fall through */</span>
<a name="c1-62"></a><span class="lineno">  62</span>      <span class="nl">default:</span>
<a name="c1-63"></a><span class="lineno">  63</span>        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nonprintable</span><span class="o">++</span><span class="p">;</span>
<a name="c1-64"></a><span class="lineno">  64</span>      <span class="p">}</span>
<a name="c1-65"></a><span class="lineno">  65</span>    <span class="p">}</span>
<a name="c1-66"></a><span class="lineno">  66</span>    <span class="k">else</span>
<a name="c1-67"></a><span class="lineno">  67</span>      <span class="n">stats</span><span class="o">-&gt;</span><span class="n">printable</span><span class="o">++</span><span class="p">;</span>
<a name="c1-68"></a><span class="lineno">  68</span>  <span class="p">}</span>
<a name="c1-69"></a><span class="lineno">  69</span> 
<a name="c1-70"></a><span class="lineno">  70</span>  <span class="cm">/* If file ends with EOF then don't count this EOF as non-printable. */</span>
<a name="c1-71"></a><span class="lineno">  71</span>  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\032'</span><span class="p">)</span>
<a name="c1-72"></a><span class="lineno">  72</span>    <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nonprintable</span><span class="o">--</span><span class="p">;</span>
<a name="c1-73"></a><span class="lineno">  73</span> <span class="p">}</span>
<a name="c1-74"></a><span class="lineno">  74</span> 
<a name="c1-75"></a><span class="lineno">  75</span> <span class="cm">/*</span>
<a name="c1-76"></a><span class="lineno">  76</span> <span class="cm"> * The same heuristics as diff.c::mmfile_is_binary()</span>
<a name="c1-77"></a><span class="lineno">  77</span> <span class="cm"> */</span>
<a name="c1-78"></a><span class="lineno">  78</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">is_binary</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">text_stat</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<a name="c1-79"></a><span class="lineno">  79</span> <span class="p">{</span>
<a name="c1-80"></a><span class="lineno">  80</span> 
<a name="c1-81"></a><span class="lineno">  81</span>  <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">nul</span><span class="p">)</span>
<a name="c1-82"></a><span class="lineno">  82</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-83"></a><span class="lineno">  83</span>  <span class="k">if</span> <span class="p">((</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">printable</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">nonprintable</span><span class="p">)</span>
<a name="c1-84"></a><span class="lineno">  84</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-85"></a><span class="lineno">  85</span>  <span class="cm">/*</span>
<a name="c1-86"></a><span class="lineno">  86</span> <span class="cm">   * Other heuristics? Average line length might be relevant,</span>
<a name="c1-87"></a><span class="lineno">  87</span> <span class="cm">   * as might LF vs CR vs CRLF counts..</span>
<a name="c1-88"></a><span class="lineno">  88</span> <span class="cm">   *</span>
<a name="c1-89"></a><span class="lineno">  89</span> <span class="cm">   * NOTE! It might be normal to have a low ratio of CRLF to LF</span>
<a name="c1-90"></a><span class="lineno">  90</span> <span class="cm">   * (somebody starts with a LF-only file and edits it with an editor</span>
<a name="c1-91"></a><span class="lineno">  91</span> <span class="cm">   * that adds CRLF only to lines that are added..). But do  we</span>
<a name="c1-92"></a><span class="lineno">  92</span> <span class="cm">   * want to support CR-only? Probably not.</span>
<a name="c1-93"></a><span class="lineno">  93</span> <span class="cm">   */</span>
<a name="c1-94"></a><span class="lineno">  94</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-95"></a><span class="lineno">  95</span> <span class="p">}</span>
<a name="c1-96"></a><span class="lineno">  96</span> 
<a name="c1-97"></a><span class="lineno">  97</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">eol</span> <span class="nf">output_eol</span><span class="p">(</span><span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">crlf_action</span><span class="p">)</span>
<a name="c1-98"></a><span class="lineno">  98</span> <span class="p">{</span>
<a name="c1-99"></a><span class="lineno">  99</span>  <span class="k">switch</span> <span class="p">(</span><span class="n">crlf_action</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-100"></a><span class="lineno"> 100</span>   <span class="k">case</span> <span class="n">CRLF_BINARY</span>:
<a name="c1-101"></a><span class="lineno"> 101</span>     <span class="k">return</span> <span class="n">EOL_UNSET</span><span class="p">;</span>
<a name="c1-102"></a><span class="lineno"> 102</span>   <span class="k">case</span> <span class="n">CRLF_CRLF</span>:
<a name="c1-103"></a><span class="lineno"> 103</span>     <span class="k">return</span> <span class="n">EOL_CRLF</span><span class="p">;</span>
<a name="c1-104"></a><span class="lineno"> 104</span>   <span class="k">case</span> <span class="n">CRLF_INPUT</span>:
<a name="c1-105"></a><span class="lineno"> 105</span>     <span class="k">return</span> <span class="n">EOL_LF</span><span class="p">;</span>
<a name="c1-106"></a><span class="lineno"> 106</span>   <span class="k">case</span> <span class="n">CRLF_GUESS</span>:
<a name="c1-107"></a><span class="lineno"> 107</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auto_crlf</span><span class="p">)</span>
<a name="c1-108"></a><span class="lineno"> 108</span>       <span class="k">return</span> <span class="n">EOL_UNSET</span><span class="p">;</span>
<a name="c1-109"></a><span class="lineno"> 109</span>     <span class="cm">/* fall through */</span>
<a name="c1-110"></a><span class="lineno"> 110</span>   <span class="k">case</span> <span class="n">CRLF_TEXT</span>:
<a name="c1-111"></a><span class="lineno"> 111</span>   <span class="k">case</span> <span class="n">CRLF_AUTO</span>:
<a name="c1-112"></a><span class="lineno"> 112</span>     <span class="k">if</span> <span class="p">(</span><span class="n">auto_crlf</span> <span class="o">==</span> <span class="n">AUTO_CRLF_TRUE</span><span class="p">)</span>
<a name="c1-113"></a><span class="lineno"> 113</span>       <span class="k">return</span> <span class="n">EOL_CRLF</span><span class="p">;</span>
<a name="c1-114"></a><span class="lineno"> 114</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">auto_crlf</span> <span class="o">==</span> <span class="n">AUTO_CRLF_INPUT</span><span class="p">)</span>
<a name="c1-115"></a><span class="lineno"> 115</span>       <span class="k">return</span> <span class="n">EOL_LF</span><span class="p">;</span>
<a name="c1-116"></a><span class="lineno"> 116</span>     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">core_eol</span> <span class="o">==</span> <span class="n">EOL_UNSET</span><span class="p">)</span>
<a name="c1-117"></a><span class="lineno"> 117</span>       <span class="k">return</span> <span class="n">EOL_NATIVE</span><span class="p">;</span>
<a name="c1-118"></a><span class="lineno"> 118</span>   <span class="p">}</span>
<a name="c1-119"></a><span class="lineno"> 119</span>   <span class="k">return</span> <span class="n">core_eol</span><span class="p">;</span>
<a name="c1-120"></a><span class="lineno"> 120</span> <span class="p">}</span>
<a name="c1-121"></a><span class="lineno"> 121</span> 
<a name="c1-122"></a><span class="lineno"> 122</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">check_safe_crlf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">crlf_action</span><span class="p">,</span>
<a name="c1-123"></a><span class="lineno"> 123</span>                             <span class="k">struct</span> <span class="n">text_stat</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="k">enum</span> <span class="n">safe_crlf</span> <span class="n">checksafe</span><span class="p">)</span>
<a name="c1-124"></a><span class="lineno"> 124</span> <span class="p">{</span>
<a name="c1-125"></a><span class="lineno"> 125</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checksafe</span><span class="p">)</span>
<a name="c1-126"></a><span class="lineno"> 126</span>     <span class="k">return</span><span class="p">;</span>
<a name="c1-127"></a><span class="lineno"> 127</span> 
<a name="c1-128"></a><span class="lineno"> 128</span>   <span class="k">if</span> <span class="p">(</span><span class="n">output_eol</span><span class="p">(</span><span class="n">crlf_action</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOL_LF</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-129"></a><span class="lineno"> 129</span>     <span class="cm">/*</span>
<a name="c1-130"></a><span class="lineno"> 130</span> <span class="cm">    * CRLFs would not be restored by checkout:</span>
<a name="c1-131"></a><span class="lineno"> 131</span> <span class="cm">    * check if we'd remove CRLFs</span>
<a name="c1-132"></a><span class="lineno"> 132</span> <span class="cm">    */</span>
<a name="c1-133"></a><span class="lineno"> 133</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">crlf</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-134"></a><span class="lineno"> 134</span>       <span class="k">if</span> <span class="p">(</span><span class="n">checksafe</span> <span class="o">==</span> <span class="n">SAFE_CRLF_WARN</span><span class="p">)</span>
<a name="c1-135"></a><span class="lineno"> 135</span>         <span class="n">warning</span><span class="p">(</span><span class="s">"CRLF will be replaced by LF in %s.</span><span class="se">\n</span><span class="s">The file will have its original line endings in your working directory."</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-136"></a><span class="lineno"> 136</span>       <span class="k">else</span> <span class="cm">/* i.e. SAFE_CRLF_FAIL */</span>
<a name="c1-137"></a><span class="lineno"> 137</span>         <span class="n">die</span><span class="p">(</span><span class="s">"CRLF would be replaced by LF in %s."</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-138"></a><span class="lineno"> 138</span>     <span class="p">}</span>
<a name="c1-139"></a><span class="lineno"> 139</span>   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">output_eol</span><span class="p">(</span><span class="n">crlf_action</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOL_CRLF</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-140"></a><span class="lineno"> 140</span>     <span class="cm">/*</span>
<a name="c1-141"></a><span class="lineno"> 141</span> <span class="cm">    * CRLFs would be added by checkout:</span>
<a name="c1-142"></a><span class="lineno"> 142</span> <span class="cm">    * check if we have "naked" LFs</span>
<a name="c1-143"></a><span class="lineno"> 143</span> <span class="cm">    */</span>
<a name="c1-144"></a><span class="lineno"> 144</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">lf</span> <span class="o">!=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">crlf</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-145"></a><span class="lineno"> 145</span>       <span class="k">if</span> <span class="p">(</span><span class="n">checksafe</span> <span class="o">==</span> <span class="n">SAFE_CRLF_WARN</span><span class="p">)</span>
<a name="c1-146"></a><span class="lineno"> 146</span>         <span class="n">warning</span><span class="p">(</span><span class="s">"LF will be replaced by CRLF in %s.</span><span class="se">\n</span><span class="s">The file will have its original line endings in your working directory."</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-147"></a><span class="lineno"> 147</span>       <span class="k">else</span> <span class="cm">/* i.e. SAFE_CRLF_FAIL */</span>
<a name="c1-148"></a><span class="lineno"> 148</span>         <span class="n">die</span><span class="p">(</span><span class="s">"LF would be replaced by CRLF in %s"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-149"></a><span class="lineno"> 149</span>     <span class="p">}</span>
<a name="c1-150"></a><span class="lineno"> 150</span>   <span class="p">}</span>
<a name="c1-151"></a><span class="lineno"> 151</span> <span class="p">}</span>
<a name="c1-152"></a><span class="lineno"> 152</span> 
<a name="c1-153"></a><span class="lineno"> 153</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">has_cr_in_index</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<a name="c1-154"></a><span class="lineno"> 154</span> <span class="p">{</span>
<a name="c1-155"></a><span class="lineno"> 155</span>   <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
<a name="c1-156"></a><span class="lineno"> 156</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
<a name="c1-157"></a><span class="lineno"> 157</span>   <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c1-158"></a><span class="lineno"> 158</span>   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<a name="c1-159"></a><span class="lineno"> 159</span>   <span class="kt">int</span> <span class="n">has_cr</span><span class="p">;</span>
<a name="c1-160"></a><span class="lineno"> 160</span> <span class="hll">  <span class="k">struct</span> <span class="n">index_state</span> <span class="o">*</span><span class="n">istate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">the_index</span><span class="p">;</span>
</span><a name="c1-161"></a><span class="lineno"> 161</span> <span class="hll">
</span><a name="c1-162"></a><span class="lineno"> 162</span> <span class="hll"> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span><a name="c1-163"></a><span class="lineno"> 163</span> <span class="hll"> <span class="n">pos</span> <span class="o">=</span> <span class="n">index_name_pos</span><span class="p">(</span><span class="n">istate</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><a name="c1-164"></a><span class="lineno"> 164</span> <span class="hll"> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><a name="c1-165"></a><span class="lineno"> 165</span> <span class="hll">   <span class="cm">/*</span>
</span><a name="c1-166"></a><span class="lineno"> 166</span> <span class="hll"><span class="cm">     * We might be in the middle of a merge, in which</span>
</span><a name="c1-167"></a><span class="lineno"> 167</span> <span class="hll"><span class="cm">     * case we would read stage #2 (ours).</span>
</span><a name="c1-168"></a><span class="lineno"> 168</span> <span class="hll"><span class="cm">     */</span>
</span><a name="c1-169"></a><span class="lineno"> 169</span> <span class="hll">   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><a name="c1-170"></a><span class="lineno"> 170</span> <span class="hll">   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c1-171"></a><span class="lineno"> 171</span> <span class="hll">        <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache_nr</span> <span class="o">&amp;&amp;</span>
</span><a name="c1-172"></a><span class="lineno"> 172</span> <span class="hll">         <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">));</span>
</span><a name="c1-173"></a><span class="lineno"> 173</span> <span class="hll">        <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><a name="c1-174"></a><span class="lineno"> 174</span> <span class="hll">     <span class="k">if</span> <span class="p">(</span><span class="n">ce_stage</span><span class="p">(</span><span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span><a name="c1-175"></a><span class="lineno"> 175</span> <span class="hll">       <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><a name="c1-176"></a><span class="lineno"> 176</span> <span class="hll"> <span class="p">}</span>
</span><a name="c1-177"></a><span class="lineno"> 177</span> <span class="hll"> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><a name="c1-178"></a><span class="lineno"> 178</span> <span class="hll">   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-179"></a><span class="lineno"> 179</span>  <span class="n">data</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">istate</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<a name="c1-180"></a><span class="lineno"> 180</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">OBJ_BLOB</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-181"></a><span class="lineno"> 181</span>     <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c1-182"></a><span class="lineno"> 182</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-183"></a><span class="lineno"> 183</span>   <span class="p">}</span>
<a name="c1-184"></a><span class="lineno"> 184</span> 
<a name="c1-185"></a><span class="lineno"> 185</span>   <span class="n">has_cr</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="sc">'\r'</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-186"></a><span class="lineno"> 186</span>   <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c1-187"></a><span class="lineno"> 187</span>   <span class="k">return</span> <span class="n">has_cr</span><span class="p">;</span>
<a name="c1-188"></a><span class="lineno"> 188</span> <span class="p">}</span>
<a name="c1-189"></a><span class="lineno"> 189</span> 
<a name="c1-190"></a><span class="lineno"> 190</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">crlf_to_git</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c1-191"></a><span class="lineno"> 191</span>            <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<a name="c1-192"></a><span class="lineno"> 192</span>            <span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">crlf_action</span><span class="p">,</span> <span class="k">enum</span> <span class="n">safe_crlf</span> <span class="n">checksafe</span><span class="p">)</span>
<a name="c1-193"></a><span class="lineno"> 193</span> <span class="p">{</span>
<a name="c1-194"></a><span class="lineno"> 194</span>   <span class="k">struct</span> <span class="n">text_stat</span> <span class="n">stats</span><span class="p">;</span>
<a name="c1-195"></a><span class="lineno"> 195</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="c1-196"></a><span class="lineno"> 196</span> 
<a name="c1-197"></a><span class="lineno"> 197</span>   <span class="k">if</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_BINARY</span> <span class="o">||</span>
<a name="c1-198"></a><span class="lineno"> 198</span>       <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span> <span class="o">&amp;&amp;</span> <span class="n">auto_crlf</span> <span class="o">==</span> <span class="n">AUTO_CRLF_FALSE</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c1-199"></a><span class="lineno"> 199</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-200"></a><span class="lineno"> 200</span> 
<a name="c1-201"></a><span class="lineno"> 201</span>   <span class="n">gather_stats</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
<a name="c1-202"></a><span class="lineno"> 202</span> 
<a name="c1-203"></a><span class="lineno"> 203</span>   <span class="k">if</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_AUTO</span> <span class="o">||</span> <span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-204"></a><span class="lineno"> 204</span>     <span class="cm">/*</span>
<a name="c1-205"></a><span class="lineno"> 205</span> <span class="cm">    * We're currently not going to even try to convert stuff</span>
<a name="c1-206"></a><span class="lineno"> 206</span> <span class="cm">    * that has bare CR characters. Does anybody do that crazy</span>
<a name="c1-207"></a><span class="lineno"> 207</span> <span class="cm">    * stuff?</span>
<a name="c1-208"></a><span class="lineno"> 208</span> <span class="cm">    */</span>
<a name="c1-209"></a><span class="lineno"> 209</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">cr</span> <span class="o">!=</span> <span class="n">stats</span><span class="p">.</span><span class="n">crlf</span><span class="p">)</span>
<a name="c1-210"></a><span class="lineno"> 210</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-211"></a><span class="lineno"> 211</span> 
<a name="c1-212"></a><span class="lineno"> 212</span>     <span class="cm">/*</span>
<a name="c1-213"></a><span class="lineno"> 213</span> <span class="cm">    * And add some heuristics for binary vs text, of course...</span>
<a name="c1-214"></a><span class="lineno"> 214</span> <span class="cm">    */</span>
<a name="c1-215"></a><span class="lineno"> 215</span>     <span class="k">if</span> <span class="p">(</span><span class="n">is_binary</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span>
<a name="c1-216"></a><span class="lineno"> 216</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-217"></a><span class="lineno"> 217</span> 
<a name="c1-218"></a><span class="lineno"> 218</span>     <span class="k">if</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-219"></a><span class="lineno"> 219</span>       <span class="cm">/*</span>
<a name="c1-220"></a><span class="lineno"> 220</span> <span class="cm">      * If the file in the index has any CR in it, do not convert.</span>
<a name="c1-221"></a><span class="lineno"> 221</span> <span class="cm">      * This is the new safer autocrlf handling.</span>
<a name="c1-222"></a><span class="lineno"> 222</span> <span class="cm">      */</span>
<a name="c1-223"></a><span class="lineno"> 223</span>       <span class="k">if</span> <span class="p">(</span><span class="n">has_cr_in_index</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
<a name="c1-224"></a><span class="lineno"> 224</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-225"></a><span class="lineno"> 225</span>     <span class="p">}</span>
<a name="c1-226"></a><span class="lineno"> 226</span>   <span class="p">}</span>
<a name="c1-227"></a><span class="lineno"> 227</span> 
<a name="c1-228"></a><span class="lineno"> 228</span>   <span class="n">check_safe_crlf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">crlf_action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="n">checksafe</span><span class="p">);</span>
<a name="c1-229"></a><span class="lineno"> 229</span> 
<a name="c1-230"></a><span class="lineno"> 230</span>   <span class="cm">/* Optimization: No CR? Nothing to convert, regardless. */</span>
<a name="c1-231"></a><span class="lineno"> 231</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stats</span><span class="p">.</span><span class="n">cr</span><span class="p">)</span>
<a name="c1-232"></a><span class="lineno"> 232</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-233"></a><span class="lineno"> 233</span> 
<a name="c1-234"></a><span class="lineno"> 234</span>   <span class="cm">/* only grow if not in place */</span>
<a name="c1-235"></a><span class="lineno"> 235</span>   <span class="k">if</span> <span class="p">(</span><span class="n">strbuf_avail</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
<a name="c1-236"></a><span class="lineno"> 236</span>     <span class="n">strbuf_grow</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a name="c1-237"></a><span class="lineno"> 237</span>   <span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-238"></a><span class="lineno"> 238</span>   <span class="k">if</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_AUTO</span> <span class="o">||</span> <span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-239"></a><span class="lineno"> 239</span>     <span class="cm">/*</span>
<a name="c1-240"></a><span class="lineno"> 240</span> <span class="cm">    * If we guessed, we already know we rejected a file with</span>
<a name="c1-241"></a><span class="lineno"> 241</span> <span class="cm">    * lone CR, and we can strip a CR without looking at what</span>
<a name="c1-242"></a><span class="lineno"> 242</span> <span class="cm">    * follow it.</span>
<a name="c1-243"></a><span class="lineno"> 243</span> <span class="cm">    */</span>
<a name="c1-244"></a><span class="lineno"> 244</span>     <span class="k">do</span> <span class="p">{</span>
<a name="c1-245"></a><span class="lineno"> 245</span>       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
<a name="c1-246"></a><span class="lineno"> 246</span>       <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">'\r'</span><span class="p">)</span>
<a name="c1-247"></a><span class="lineno"> 247</span>         <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-248"></a><span class="lineno"> 248</span>     <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">);</span>
<a name="c1-249"></a><span class="lineno"> 249</span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-250"></a><span class="lineno"> 250</span>     <span class="k">do</span> <span class="p">{</span>
<a name="c1-251"></a><span class="lineno"> 251</span>       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
<a name="c1-252"></a><span class="lineno"> 252</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">src</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)))</span>
<a name="c1-253"></a><span class="lineno"> 253</span>         <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-254"></a><span class="lineno"> 254</span>     <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">);</span>
<a name="c1-255"></a><span class="lineno"> 255</span>   <span class="p">}</span>
<a name="c1-256"></a><span class="lineno"> 256</span>   <span class="n">strbuf_setlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dst</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-257"></a><span class="lineno"> 257</span>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-258"></a><span class="lineno"> 258</span> <span class="p">}</span>
<a name="c1-259"></a><span class="lineno"> 259</span> 
<a name="c1-260"></a><span class="lineno"> 260</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">crlf_to_worktree</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c1-261"></a><span class="lineno"> 261</span>           <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">crlf_action</span><span class="p">)</span>
<a name="c1-262"></a><span class="lineno"> 262</span> <span class="p">{</span>
<a name="c1-263"></a><span class="lineno"> 263</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">to_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-264"></a><span class="lineno"> 264</span>   <span class="k">struct</span> <span class="n">text_stat</span> <span class="n">stats</span><span class="p">;</span>
<a name="c1-265"></a><span class="lineno"> 265</span> 
<a name="c1-266"></a><span class="lineno"> 266</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">output_eol</span><span class="p">(</span><span class="n">crlf_action</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EOL_CRLF</span><span class="p">)</span>
<a name="c1-267"></a><span class="lineno"> 267</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-268"></a><span class="lineno"> 268</span> 
<a name="c1-269"></a><span class="lineno"> 269</span>   <span class="n">gather_stats</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
<a name="c1-270"></a><span class="lineno"> 270</span> 
<a name="c1-271"></a><span class="lineno"> 271</span>   <span class="cm">/* No LF? Nothing to convert, regardless. */</span>
<a name="c1-272"></a><span class="lineno"> 272</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stats</span><span class="p">.</span><span class="n">lf</span><span class="p">)</span>
<a name="c1-273"></a><span class="lineno"> 273</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-274"></a><span class="lineno"> 274</span> 
<a name="c1-275"></a><span class="lineno"> 275</span>   <span class="cm">/* Was it already in CRLF format? */</span>
<a name="c1-276"></a><span class="lineno"> 276</span>   <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">lf</span> <span class="o">==</span> <span class="n">stats</span><span class="p">.</span><span class="n">crlf</span><span class="p">)</span>
<a name="c1-277"></a><span class="lineno"> 277</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-278"></a><span class="lineno"> 278</span> 
<a name="c1-279"></a><span class="lineno"> 279</span>   <span class="k">if</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_AUTO</span> <span class="o">||</span> <span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-280"></a><span class="lineno"> 280</span>     <span class="k">if</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-281"></a><span class="lineno"> 281</span>       <span class="cm">/* If we have any CR or CRLF line endings, we do not touch it */</span>
<a name="c1-282"></a><span class="lineno"> 282</span>       <span class="cm">/* This is the new safer autocrlf-handling */</span>
<a name="c1-283"></a><span class="lineno"> 283</span>       <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">cr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">stats</span><span class="p">.</span><span class="n">crlf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-284"></a><span class="lineno"> 284</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-285"></a><span class="lineno"> 285</span>     <span class="p">}</span>
<a name="c1-286"></a><span class="lineno"> 286</span> 
<a name="c1-287"></a><span class="lineno"> 287</span>     <span class="cm">/* If we have any bare CR characters, we're not going to touch it */</span>
<a name="c1-288"></a><span class="lineno"> 288</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">cr</span> <span class="o">!=</span> <span class="n">stats</span><span class="p">.</span><span class="n">crlf</span><span class="p">)</span>
<a name="c1-289"></a><span class="lineno"> 289</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-290"></a><span class="lineno"> 290</span> 
<a name="c1-291"></a><span class="lineno"> 291</span>     <span class="k">if</span> <span class="p">(</span><span class="n">is_binary</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">))</span>
<a name="c1-292"></a><span class="lineno"> 292</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-293"></a><span class="lineno"> 293</span>   <span class="p">}</span>
<a name="c1-294"></a><span class="lineno"> 294</span> 
<a name="c1-295"></a><span class="lineno"> 295</span>   <span class="cm">/* are we "faking" in place editing ? */</span>
<a name="c1-296"></a><span class="lineno"> 296</span>   <span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-297"></a><span class="lineno"> 297</span>     <span class="n">to_free</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-298"></a><span class="lineno"> 298</span> 
<a name="c1-299"></a><span class="lineno"> 299</span>   <span class="n">strbuf_grow</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">stats</span><span class="p">.</span><span class="n">lf</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">crlf</span><span class="p">);</span>
<a name="c1-300"></a><span class="lineno"> 300</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-301"></a><span class="lineno"> 301</span>     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-302"></a><span class="lineno"> 302</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nl</span><span class="p">)</span>
<a name="c1-303"></a><span class="lineno"> 303</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-304"></a><span class="lineno"> 304</span>     <span class="k">if</span> <span class="p">(</span><span class="n">nl</span> <span class="o">&gt;</span> <span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">nl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-305"></a><span class="lineno"> 305</span>       <span class="n">strbuf_add</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">);</span>
<a name="c1-306"></a><span class="lineno"> 306</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-307"></a><span class="lineno"> 307</span>       <span class="n">strbuf_add</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">nl</span> <span class="o">-</span> <span class="n">src</span><span class="p">);</span>
<a name="c1-308"></a><span class="lineno"> 308</span>       <span class="n">strbuf_addstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-309"></a><span class="lineno"> 309</span>     <span class="p">}</span>
<a name="c1-310"></a><span class="lineno"> 310</span>     <span class="n">len</span> <span class="o">-=</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-311"></a><span class="lineno"> 311</span>     <span class="n">src</span>  <span class="o">=</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-312"></a><span class="lineno"> 312</span>   <span class="p">}</span>
<a name="c1-313"></a><span class="lineno"> 313</span>   <span class="n">strbuf_add</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-314"></a><span class="lineno"> 314</span> 
<a name="c1-315"></a><span class="lineno"> 315</span>   <span class="n">free</span><span class="p">(</span><span class="n">to_free</span><span class="p">);</span>
<a name="c1-316"></a><span class="lineno"> 316</span>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-317"></a><span class="lineno"> 317</span> <span class="p">}</span>
<a name="c1-318"></a><span class="lineno"> 318</span> 
<a name="c1-319"></a><span class="lineno"> 319</span> <span class="k">struct</span> <span class="n">filter_params</span> <span class="p">{</span>
<a name="c1-320"></a><span class="lineno"> 320</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
<a name="c1-321"></a><span class="lineno"> 321</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
<a name="c1-322"></a><span class="lineno"> 322</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
<a name="c1-323"></a><span class="lineno"> 323</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
<a name="c1-324"></a><span class="lineno"> 324</span> <span class="p">};</span>
<a name="c1-325"></a><span class="lineno"> 325</span> 
<a name="c1-326"></a><span class="lineno"> 326</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">filter_buffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-327"></a><span class="lineno"> 327</span> <span class="p">{</span>
<a name="c1-328"></a><span class="lineno"> 328</span>   <span class="cm">/*</span>
<a name="c1-329"></a><span class="lineno"> 329</span> <span class="cm">  * Spawn cmd and feed the buffer contents through its stdin.</span>
<a name="c1-330"></a><span class="lineno"> 330</span> <span class="cm">  */</span>
<a name="c1-331"></a><span class="lineno"> 331</span>   <span class="k">struct</span> <span class="n">child_process</span> <span class="n">child_process</span><span class="p">;</span>
<a name="c1-332"></a><span class="lineno"> 332</span>   <span class="k">struct</span> <span class="n">filter_params</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">filter_params</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<a name="c1-333"></a><span class="lineno"> 333</span>   <span class="kt">int</span> <span class="n">write_err</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
<a name="c1-334"></a><span class="lineno"> 334</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<a name="c1-335"></a><span class="lineno"> 335</span> 
<a name="c1-336"></a><span class="lineno"> 336</span>   <span class="cm">/* apply % substitution to cmd */</span>
<a name="c1-337"></a><span class="lineno"> 337</span>   <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-338"></a><span class="lineno"> 338</span>   <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">path</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-339"></a><span class="lineno"> 339</span>   <span class="k">struct</span> <span class="n">strbuf_expand_dict_entry</span> <span class="n">dict</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-340"></a><span class="lineno"> 340</span>     <span class="p">{</span> <span class="s">"f"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">},</span>
<a name="c1-341"></a><span class="lineno"> 341</span>     <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">},</span>
<a name="c1-342"></a><span class="lineno"> 342</span>   <span class="p">};</span>
<a name="c1-343"></a><span class="lineno"> 343</span> 
<a name="c1-344"></a><span class="lineno"> 344</span>   <span class="cm">/* quote the path to preserve spaces, etc. */</span>
<a name="c1-345"></a><span class="lineno"> 345</span>   <span class="n">sq_quote_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-346"></a><span class="lineno"> 346</span>   <span class="n">dict</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-347"></a><span class="lineno"> 347</span> 
<a name="c1-348"></a><span class="lineno"> 348</span>   <span class="cm">/* expand all %f with the quoted path */</span>
<a name="c1-349"></a><span class="lineno"> 349</span>   <span class="n">strbuf_expand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">strbuf_expand_dict_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dict</span><span class="p">);</span>
<a name="c1-350"></a><span class="lineno"> 350</span>   <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-351"></a><span class="lineno"> 351</span> 
<a name="c1-352"></a><span class="lineno"> 352</span>   <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-353"></a><span class="lineno"> 353</span> 
<a name="c1-354"></a><span class="lineno"> 354</span>   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_process</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">child_process</span><span class="p">));</span>
<a name="c1-355"></a><span class="lineno"> 355</span>   <span class="n">child_process</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span><span class="p">;</span>
<a name="c1-356"></a><span class="lineno"> 356</span>   <span class="n">child_process</span><span class="p">.</span><span class="n">use_shell</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-357"></a><span class="lineno"> 357</span>   <span class="n">child_process</span><span class="p">.</span><span class="n">in</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-358"></a><span class="lineno"> 358</span>   <span class="n">child_process</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
<a name="c1-359"></a><span class="lineno"> 359</span> 
<a name="c1-360"></a><span class="lineno"> 360</span>   <span class="k">if</span> <span class="p">(</span><span class="n">start_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_process</span><span class="p">))</span>
<a name="c1-361"></a><span class="lineno"> 361</span>     <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"cannot fork to run external filter %s"</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
<a name="c1-362"></a><span class="lineno"> 362</span> 
<a name="c1-363"></a><span class="lineno"> 363</span>   <span class="n">write_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_in_full</span><span class="p">(</span><span class="n">child_process</span><span class="p">.</span><span class="n">in</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-364"></a><span class="lineno"> 364</span>   <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">child_process</span><span class="p">.</span><span class="n">in</span><span class="p">))</span>
<a name="c1-365"></a><span class="lineno"> 365</span>     <span class="n">write_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-366"></a><span class="lineno"> 366</span>   <span class="k">if</span> <span class="p">(</span><span class="n">write_err</span><span class="p">)</span>
<a name="c1-367"></a><span class="lineno"> 367</span>     <span class="n">error</span><span class="p">(</span><span class="s">"cannot feed the input to external filter %s"</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
<a name="c1-368"></a><span class="lineno"> 368</span> 
<a name="c1-369"></a><span class="lineno"> 369</span>   <span class="n">status</span> <span class="o">=</span> <span class="n">finish_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_process</span><span class="p">);</span>
<a name="c1-370"></a><span class="lineno"> 370</span>   <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
<a name="c1-371"></a><span class="lineno"> 371</span>     <span class="n">error</span><span class="p">(</span><span class="s">"external filter %s failed %d"</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<a name="c1-372"></a><span class="lineno"> 372</span> 
<a name="c1-373"></a><span class="lineno"> 373</span>   <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<a name="c1-374"></a><span class="lineno"> 374</span>   <span class="k">return</span> <span class="p">(</span><span class="n">write_err</span> <span class="o">||</span> <span class="n">status</span><span class="p">);</span>
<a name="c1-375"></a><span class="lineno"> 375</span> <span class="p">}</span>
<a name="c1-376"></a><span class="lineno"> 376</span> 
<a name="c1-377"></a><span class="lineno"> 377</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c1-378"></a><span class="lineno"> 378</span>                         <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<a name="c1-379"></a><span class="lineno"> 379</span> <span class="p">{</span>
<a name="c1-380"></a><span class="lineno"> 380</span>   <span class="cm">/*</span>
<a name="c1-381"></a><span class="lineno"> 381</span> <span class="cm">  * Create a pipeline to have the command filter the buffer's</span>
<a name="c1-382"></a><span class="lineno"> 382</span> <span class="cm">  * contents.</span>
<a name="c1-383"></a><span class="lineno"> 383</span> <span class="cm">  *</span>
<a name="c1-384"></a><span class="lineno"> 384</span> <span class="cm">  * (child --&gt; cmd) --&gt; us</span>
<a name="c1-385"></a><span class="lineno"> 385</span> <span class="cm">  */</span>
<a name="c1-386"></a><span class="lineno"> 386</span>   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-387"></a><span class="lineno"> 387</span>   <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">nbuf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c1-388"></a><span class="lineno"> 388</span>   <span class="k">struct</span> <span class="n">async</span> <span class="n">async</span><span class="p">;</span>
<a name="c1-389"></a><span class="lineno"> 389</span>   <span class="k">struct</span> <span class="n">filter_params</span> <span class="n">params</span><span class="p">;</span>
<a name="c1-390"></a><span class="lineno"> 390</span> 
<a name="c1-391"></a><span class="lineno"> 391</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
<a name="c1-392"></a><span class="lineno"> 392</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-393"></a><span class="lineno"> 393</span> 
<a name="c1-394"></a><span class="lineno"> 394</span>   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">async</span><span class="p">));</span>
<a name="c1-395"></a><span class="lineno"> 395</span>   <span class="n">async</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">filter_buffer</span><span class="p">;</span>
<a name="c1-396"></a><span class="lineno"> 396</span>   <span class="n">async</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">;</span>
<a name="c1-397"></a><span class="lineno"> 397</span>   <span class="n">async</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-398"></a><span class="lineno"> 398</span>   <span class="n">params</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-399"></a><span class="lineno"> 399</span>   <span class="n">params</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c1-400"></a><span class="lineno"> 400</span>   <span class="n">params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
<a name="c1-401"></a><span class="lineno"> 401</span>   <span class="n">params</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
<a name="c1-402"></a><span class="lineno"> 402</span> 
<a name="c1-403"></a><span class="lineno"> 403</span>   <span class="n">fflush</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c1-404"></a><span class="lineno"> 404</span>   <span class="k">if</span> <span class="p">(</span><span class="n">start_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="p">))</span>
<a name="c1-405"></a><span class="lineno"> 405</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* error was already reported */</span>
<a name="c1-406"></a><span class="lineno"> 406</span> 
<a name="c1-407"></a><span class="lineno"> 407</span>   <span class="k">if</span> <span class="p">(</span><span class="n">strbuf_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nbuf</span><span class="p">,</span> <span class="n">async</span><span class="p">.</span><span class="n">out</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-408"></a><span class="lineno"> 408</span>     <span class="n">error</span><span class="p">(</span><span class="s">"read from external filter %s failed"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<a name="c1-409"></a><span class="lineno"> 409</span>     <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-410"></a><span class="lineno"> 410</span>   <span class="p">}</span>
<a name="c1-411"></a><span class="lineno"> 411</span>   <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">async</span><span class="p">.</span><span class="n">out</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-412"></a><span class="lineno"> 412</span>     <span class="n">error</span><span class="p">(</span><span class="s">"read from external filter %s failed"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<a name="c1-413"></a><span class="lineno"> 413</span>     <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-414"></a><span class="lineno"> 414</span>   <span class="p">}</span>
<a name="c1-415"></a><span class="lineno"> 415</span>   <span class="k">if</span> <span class="p">(</span><span class="n">finish_async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-416"></a><span class="lineno"> 416</span>     <span class="n">error</span><span class="p">(</span><span class="s">"external filter %s failed"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<a name="c1-417"></a><span class="lineno"> 417</span>     <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-418"></a><span class="lineno"> 418</span>   <span class="p">}</span>
<a name="c1-419"></a><span class="lineno"> 419</span> 
<a name="c1-420"></a><span class="lineno"> 420</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-421"></a><span class="lineno"> 421</span>     <span class="n">strbuf_swap</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbuf</span><span class="p">);</span>
<a name="c1-422"></a><span class="lineno"> 422</span>   <span class="p">}</span>
<a name="c1-423"></a><span class="lineno"> 423</span>   <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nbuf</span><span class="p">);</span>
<a name="c1-424"></a><span class="lineno"> 424</span>   <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<a name="c1-425"></a><span class="lineno"> 425</span> <span class="p">}</span>
<a name="c1-426"></a><span class="lineno"> 426</span> 
<a name="c1-427"></a><span class="lineno"> 427</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">convert_driver</span> <span class="p">{</span>
<a name="c1-428"></a><span class="lineno"> 428</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-429"></a><span class="lineno"> 429</span>   <span class="k">struct</span> <span class="n">convert_driver</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c1-430"></a><span class="lineno"> 430</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">smudge</span><span class="p">;</span>
<a name="c1-431"></a><span class="lineno"> 431</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clean</span><span class="p">;</span>
<a name="c1-432"></a><span class="lineno"> 432</span> <span class="p">}</span> <span class="o">*</span><span class="n">user_convert</span><span class="p">,</span> <span class="o">**</span><span class="n">user_convert_tail</span><span class="p">;</span>
<a name="c1-433"></a><span class="lineno"> 433</span> 
<a name="c1-434"></a><span class="lineno"> 434</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">read_convert_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<a name="c1-435"></a><span class="lineno"> 435</span> <span class="p">{</span>
<a name="c1-436"></a><span class="lineno"> 436</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-437"></a><span class="lineno"> 437</span>   <span class="kt">int</span> <span class="n">namelen</span><span class="p">;</span>
<a name="c1-438"></a><span class="lineno"> 438</span>   <span class="k">struct</span> <span class="n">convert_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
<a name="c1-439"></a><span class="lineno"> 439</span> 
<a name="c1-440"></a><span class="lineno"> 440</span>   <span class="cm">/*</span>
<a name="c1-441"></a><span class="lineno"> 441</span> <span class="cm">  * External conversion drivers are configured using</span>
<a name="c1-442"></a><span class="lineno"> 442</span> <span class="cm">  * "filter.&lt;name&gt;.variable".</span>
<a name="c1-443"></a><span class="lineno"> 443</span> <span class="cm">  */</span>
<a name="c1-444"></a><span class="lineno"> 444</span>   <span class="k">if</span> <span class="p">(</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"filter."</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">))</span> <span class="o">==</span> <span class="n">var</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
<a name="c1-445"></a><span class="lineno"> 445</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-446"></a><span class="lineno"> 446</span>   <span class="n">name</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
<a name="c1-447"></a><span class="lineno"> 447</span>   <span class="n">namelen</span> <span class="o">=</span> <span class="n">ep</span> <span class="o">-</span> <span class="n">name</span><span class="p">;</span>
<a name="c1-448"></a><span class="lineno"> 448</span>   <span class="k">for</span> <span class="p">(</span><span class="n">drv</span> <span class="o">=</span> <span class="n">user_convert</span><span class="p">;</span> <span class="n">drv</span><span class="p">;</span> <span class="n">drv</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-449"></a><span class="lineno"> 449</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">namelen</span><span class="p">])</span>
<a name="c1-450"></a><span class="lineno"> 450</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-451"></a><span class="lineno"> 451</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-452"></a><span class="lineno"> 452</span>     <span class="n">drv</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">convert_driver</span><span class="p">));</span>
<a name="c1-453"></a><span class="lineno"> 453</span>     <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">xmemdupz</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
<a name="c1-454"></a><span class="lineno"> 454</span>     <span class="o">*</span><span class="n">user_convert_tail</span> <span class="o">=</span> <span class="n">drv</span><span class="p">;</span>
<a name="c1-455"></a><span class="lineno"> 455</span>     <span class="n">user_convert_tail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
<a name="c1-456"></a><span class="lineno"> 456</span>   <span class="p">}</span>
<a name="c1-457"></a><span class="lineno"> 457</span> 
<a name="c1-458"></a><span class="lineno"> 458</span>   <span class="n">ep</span><span class="o">++</span><span class="p">;</span>
<a name="c1-459"></a><span class="lineno"> 459</span> 
<a name="c1-460"></a><span class="lineno"> 460</span>   <span class="cm">/*</span>
<a name="c1-461"></a><span class="lineno"> 461</span> <span class="cm">  * filter.&lt;name&gt;.smudge and filter.&lt;name&gt;.clean specifies</span>
<a name="c1-462"></a><span class="lineno"> 462</span> <span class="cm">  * the command line:</span>
<a name="c1-463"></a><span class="lineno"> 463</span> <span class="cm">  *</span>
<a name="c1-464"></a><span class="lineno"> 464</span> <span class="cm">  *  command-line</span>
<a name="c1-465"></a><span class="lineno"> 465</span> <span class="cm">  *</span>
<a name="c1-466"></a><span class="lineno"> 466</span> <span class="cm">  * The command-line will not be interpolated in any way.</span>
<a name="c1-467"></a><span class="lineno"> 467</span> <span class="cm">  */</span>
<a name="c1-468"></a><span class="lineno"> 468</span> 
<a name="c1-469"></a><span class="lineno"> 469</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"smudge"</span><span class="p">,</span> <span class="n">ep</span><span class="p">))</span>
<a name="c1-470"></a><span class="lineno"> 470</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">smudge</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-471"></a><span class="lineno"> 471</span> 
<a name="c1-472"></a><span class="lineno"> 472</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">"clean"</span><span class="p">,</span> <span class="n">ep</span><span class="p">))</span>
<a name="c1-473"></a><span class="lineno"> 473</span>     <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">clean</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c1-474"></a><span class="lineno"> 474</span> 
<a name="c1-475"></a><span class="lineno"> 475</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-476"></a><span class="lineno"> 476</span> <span class="p">}</span>
<a name="c1-477"></a><span class="lineno"> 477</span> 
<a name="c1-478"></a><span class="lineno"> 478</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">count_ident</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<a name="c1-479"></a><span class="lineno"> 479</span> <span class="p">{</span>
<a name="c1-480"></a><span class="lineno"> 480</span>   <span class="cm">/*</span>
<a name="c1-481"></a><span class="lineno"> 481</span> <span class="cm">  * "$Id: 0000000000000000000000000000000000000000 $" &lt;=&gt; "$Id$"</span>
<a name="c1-482"></a><span class="lineno"> 482</span> <span class="cm">  */</span>
<a name="c1-483"></a><span class="lineno"> 483</span>   <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-484"></a><span class="lineno"> 484</span>   <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
<a name="c1-485"></a><span class="lineno"> 485</span> 
<a name="c1-486"></a><span class="lineno"> 486</span>   <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-487"></a><span class="lineno"> 487</span>     <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c1-488"></a><span class="lineno"> 488</span>     <span class="n">size</span><span class="o">--</span><span class="p">;</span>
<a name="c1-489"></a><span class="lineno"> 489</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">'$'</span><span class="p">)</span>
<a name="c1-490"></a><span class="lineno"> 490</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-491"></a><span class="lineno"> 491</span>     <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
<a name="c1-492"></a><span class="lineno"> 492</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-493"></a><span class="lineno"> 493</span>     <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="s">"Id"</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="c1-494"></a><span class="lineno"> 494</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-495"></a><span class="lineno"> 495</span>     <span class="n">ch</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a name="c1-496"></a><span class="lineno"> 496</span>     <span class="n">cp</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-497"></a><span class="lineno"> 497</span>     <span class="n">size</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-498"></a><span class="lineno"> 498</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'$'</span><span class="p">)</span>
<a name="c1-499"></a><span class="lineno"> 499</span>       <span class="n">cnt</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* $Id$ */</span>
<a name="c1-500"></a><span class="lineno"> 500</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">':'</span><span class="p">)</span>
<a name="c1-501"></a><span class="lineno"> 501</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-502"></a><span class="lineno"> 502</span> 
<a name="c1-503"></a><span class="lineno"> 503</span>     <span class="cm">/*</span>
<a name="c1-504"></a><span class="lineno"> 504</span> <span class="cm">    * "$Id: ... "; scan up to the closing dollar sign and discard.</span>
<a name="c1-505"></a><span class="lineno"> 505</span> <span class="cm">    */</span>
<a name="c1-506"></a><span class="lineno"> 506</span>     <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-507"></a><span class="lineno"> 507</span>       <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c1-508"></a><span class="lineno"> 508</span>       <span class="n">size</span><span class="o">--</span><span class="p">;</span>
<a name="c1-509"></a><span class="lineno"> 509</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'$'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-510"></a><span class="lineno"> 510</span>         <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
<a name="c1-511"></a><span class="lineno"> 511</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-512"></a><span class="lineno"> 512</span>       <span class="p">}</span>
<a name="c1-513"></a><span class="lineno"> 513</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c1-514"></a><span class="lineno"> 514</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-515"></a><span class="lineno"> 515</span>     <span class="p">}</span>
<a name="c1-516"></a><span class="lineno"> 516</span>   <span class="p">}</span>
<a name="c1-517"></a><span class="lineno"> 517</span>   <span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<a name="c1-518"></a><span class="lineno"> 518</span> <span class="p">}</span>
<a name="c1-519"></a><span class="lineno"> 519</span> 
<a name="c1-520"></a><span class="lineno"> 520</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ident_to_git</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c1-521"></a><span class="lineno"> 521</span>                         <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ident</span><span class="p">)</span>
<a name="c1-522"></a><span class="lineno"> 522</span> <span class="p">{</span>
<a name="c1-523"></a><span class="lineno"> 523</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">dollar</span><span class="p">;</span>
<a name="c1-524"></a><span class="lineno"> 524</span> 
<a name="c1-525"></a><span class="lineno"> 525</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ident</span> <span class="o">||</span> <span class="o">!</span><span class="n">count_ident</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
<a name="c1-526"></a><span class="lineno"> 526</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-527"></a><span class="lineno"> 527</span> 
<a name="c1-528"></a><span class="lineno"> 528</span>   <span class="cm">/* only grow if not in place */</span>
<a name="c1-529"></a><span class="lineno"> 529</span>   <span class="k">if</span> <span class="p">(</span><span class="n">strbuf_avail</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
<a name="c1-530"></a><span class="lineno"> 530</span>     <span class="n">strbuf_grow</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a name="c1-531"></a><span class="lineno"> 531</span>   <span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-532"></a><span class="lineno"> 532</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-533"></a><span class="lineno"> 533</span>     <span class="n">dollar</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sc">'$'</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-534"></a><span class="lineno"> 534</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dollar</span><span class="p">)</span>
<a name="c1-535"></a><span class="lineno"> 535</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-536"></a><span class="lineno"> 536</span>     <span class="n">memmove</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">);</span>
<a name="c1-537"></a><span class="lineno"> 537</span>     <span class="n">dst</span> <span class="o">+=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-538"></a><span class="lineno"> 538</span>     <span class="n">len</span> <span class="o">-=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-539"></a><span class="lineno"> 539</span>     <span class="n">src</span>  <span class="o">=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-540"></a><span class="lineno"> 540</span> 
<a name="c1-541"></a><span class="lineno"> 541</span>     <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">"Id:"</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-542"></a><span class="lineno"> 542</span>       <span class="n">dollar</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">'$'</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
<a name="c1-543"></a><span class="lineno"> 543</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dollar</span><span class="p">)</span>
<a name="c1-544"></a><span class="lineno"> 544</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-545"></a><span class="lineno"> 545</span>       <span class="k">if</span> <span class="p">(</span><span class="n">memchr</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">,</span> <span class="n">dollar</span> <span class="o">-</span> <span class="n">src</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-546"></a><span class="lineno"> 546</span>         <span class="cm">/* Line break before the next dollar. */</span>
<a name="c1-547"></a><span class="lineno"> 547</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-548"></a><span class="lineno"> 548</span>       <span class="p">}</span>
<a name="c1-549"></a><span class="lineno"> 549</span> 
<a name="c1-550"></a><span class="lineno"> 550</span>       <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">"Id$"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<a name="c1-551"></a><span class="lineno"> 551</span>       <span class="n">dst</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-552"></a><span class="lineno"> 552</span>       <span class="n">len</span> <span class="o">-=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-553"></a><span class="lineno"> 553</span>       <span class="n">src</span>  <span class="o">=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-554"></a><span class="lineno"> 554</span>     <span class="p">}</span>
<a name="c1-555"></a><span class="lineno"> 555</span>   <span class="p">}</span>
<a name="c1-556"></a><span class="lineno"> 556</span>   <span class="n">memmove</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-557"></a><span class="lineno"> 557</span>   <span class="n">strbuf_setlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-558"></a><span class="lineno"> 558</span>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-559"></a><span class="lineno"> 559</span> <span class="p">}</span>
<a name="c1-560"></a><span class="lineno"> 560</span> 
<a name="c1-561"></a><span class="lineno"> 561</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ident_to_worktree</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c1-562"></a><span class="lineno"> 562</span>                              <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ident</span><span class="p">)</span>
<a name="c1-563"></a><span class="lineno"> 563</span> <span class="p">{</span>
<a name="c1-564"></a><span class="lineno"> 564</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c1-565"></a><span class="lineno"> 565</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">to_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">dollar</span><span class="p">,</span> <span class="o">*</span><span class="n">spc</span><span class="p">;</span>
<a name="c1-566"></a><span class="lineno"> 566</span>   <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
<a name="c1-567"></a><span class="lineno"> 567</span> 
<a name="c1-568"></a><span class="lineno"> 568</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ident</span><span class="p">)</span>
<a name="c1-569"></a><span class="lineno"> 569</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-570"></a><span class="lineno"> 570</span> 
<a name="c1-571"></a><span class="lineno"> 571</span>   <span class="n">cnt</span> <span class="o">=</span> <span class="n">count_ident</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-572"></a><span class="lineno"> 572</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
<a name="c1-573"></a><span class="lineno"> 573</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-574"></a><span class="lineno"> 574</span> 
<a name="c1-575"></a><span class="lineno"> 575</span>   <span class="cm">/* are we "faking" in place editing ? */</span>
<a name="c1-576"></a><span class="lineno"> 576</span>   <span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span>
<a name="c1-577"></a><span class="lineno"> 577</span>     <span class="n">to_free</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-578"></a><span class="lineno"> 578</span>   <span class="n">hash_sha1_file</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">"blob"</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c1-579"></a><span class="lineno"> 579</span> 
<a name="c1-580"></a><span class="lineno"> 580</span>   <span class="n">strbuf_grow</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">*</span> <span class="mi">43</span><span class="p">);</span>
<a name="c1-581"></a><span class="lineno"> 581</span>   <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-582"></a><span class="lineno"> 582</span>     <span class="cm">/* step 1: run to the next '$' */</span>
<a name="c1-583"></a><span class="lineno"> 583</span>     <span class="n">dollar</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="sc">'$'</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-584"></a><span class="lineno"> 584</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dollar</span><span class="p">)</span>
<a name="c1-585"></a><span class="lineno"> 585</span>       <span class="k">break</span><span class="p">;</span>
<a name="c1-586"></a><span class="lineno"> 586</span>     <span class="n">strbuf_add</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">);</span>
<a name="c1-587"></a><span class="lineno"> 587</span>     <span class="n">len</span> <span class="o">-=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-588"></a><span class="lineno"> 588</span>     <span class="n">src</span>  <span class="o">=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-589"></a><span class="lineno"> 589</span> 
<a name="c1-590"></a><span class="lineno"> 590</span>     <span class="cm">/* step 2: does it looks like a bit like Id:xxx$ or Id$ ? */</span>
<a name="c1-591"></a><span class="lineno"> 591</span>     <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="s">"Id"</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="c1-592"></a><span class="lineno"> 592</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-593"></a><span class="lineno"> 593</span> 
<a name="c1-594"></a><span class="lineno"> 594</span>     <span class="cm">/* step 3: skip over Id$ or Id:xxxxx$ */</span>
<a name="c1-595"></a><span class="lineno"> 595</span>     <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'$'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-596"></a><span class="lineno"> 596</span>       <span class="n">src</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-597"></a><span class="lineno"> 597</span>       <span class="n">len</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
<a name="c1-598"></a><span class="lineno"> 598</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">':'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-599"></a><span class="lineno"> 599</span>       <span class="cm">/*</span>
<a name="c1-600"></a><span class="lineno"> 600</span> <span class="cm">      * It's possible that an expanded Id has crept its way into the</span>
<a name="c1-601"></a><span class="lineno"> 601</span> <span class="cm">      * repository, we cope with that by stripping the expansion out.</span>
<a name="c1-602"></a><span class="lineno"> 602</span> <span class="cm">      * This is probably not a good idea, since it will cause changes</span>
<a name="c1-603"></a><span class="lineno"> 603</span> <span class="cm">      * on checkout, which won't go away by stash, but let's keep it</span>
<a name="c1-604"></a><span class="lineno"> 604</span> <span class="cm">      * for git-style ids.</span>
<a name="c1-605"></a><span class="lineno"> 605</span> <span class="cm">      */</span>
<a name="c1-606"></a><span class="lineno"> 606</span>       <span class="n">dollar</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">'$'</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
<a name="c1-607"></a><span class="lineno"> 607</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dollar</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-608"></a><span class="lineno"> 608</span>         <span class="cm">/* incomplete keyword, no more '$', so just quit the loop */</span>
<a name="c1-609"></a><span class="lineno"> 609</span>         <span class="k">break</span><span class="p">;</span>
<a name="c1-610"></a><span class="lineno"> 610</span>       <span class="p">}</span>
<a name="c1-611"></a><span class="lineno"> 611</span> 
<a name="c1-612"></a><span class="lineno"> 612</span>       <span class="k">if</span> <span class="p">(</span><span class="n">memchr</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">,</span> <span class="n">dollar</span> <span class="o">-</span> <span class="n">src</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-613"></a><span class="lineno"> 613</span>         <span class="cm">/* Line break before the next dollar. */</span>
<a name="c1-614"></a><span class="lineno"> 614</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-615"></a><span class="lineno"> 615</span>       <span class="p">}</span>
<a name="c1-616"></a><span class="lineno"> 616</span> 
<a name="c1-617"></a><span class="lineno"> 617</span>       <span class="n">spc</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">src</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="sc">' '</span><span class="p">,</span> <span class="n">dollar</span> <span class="o">-</span> <span class="n">src</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
<a name="c1-618"></a><span class="lineno"> 618</span>       <span class="k">if</span> <span class="p">(</span><span class="n">spc</span> <span class="o">&amp;&amp;</span> <span class="n">spc</span> <span class="o">&lt;</span> <span class="n">dollar</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-619"></a><span class="lineno"> 619</span>         <span class="cm">/* There are spaces in unexpected places.</span>
<a name="c1-620"></a><span class="lineno"> 620</span> <span class="cm">        * This is probably an id from some other</span>
<a name="c1-621"></a><span class="lineno"> 621</span> <span class="cm">        * versioning system. Keep it for now.</span>
<a name="c1-622"></a><span class="lineno"> 622</span> <span class="cm">        */</span>
<a name="c1-623"></a><span class="lineno"> 623</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-624"></a><span class="lineno"> 624</span>       <span class="p">}</span>
<a name="c1-625"></a><span class="lineno"> 625</span> 
<a name="c1-626"></a><span class="lineno"> 626</span>       <span class="n">len</span> <span class="o">-=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src</span><span class="p">;</span>
<a name="c1-627"></a><span class="lineno"> 627</span>       <span class="n">src</span>  <span class="o">=</span> <span class="n">dollar</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-628"></a><span class="lineno"> 628</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-629"></a><span class="lineno"> 629</span>       <span class="cm">/* it wasn't a "Id$" or "Id:xxxx$" */</span>
<a name="c1-630"></a><span class="lineno"> 630</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-631"></a><span class="lineno"> 631</span>     <span class="p">}</span>
<a name="c1-632"></a><span class="lineno"> 632</span> 
<a name="c1-633"></a><span class="lineno"> 633</span>     <span class="cm">/* step 4: substitute */</span>
<a name="c1-634"></a><span class="lineno"> 634</span>     <span class="n">strbuf_addstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"Id: "</span><span class="p">);</span>
<a name="c1-635"></a><span class="lineno"> 635</span>     <span class="n">strbuf_add</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">),</span> <span class="mi">40</span><span class="p">);</span>
<a name="c1-636"></a><span class="lineno"> 636</span>     <span class="n">strbuf_addstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">" $"</span><span class="p">);</span>
<a name="c1-637"></a><span class="lineno"> 637</span>   <span class="p">}</span>
<a name="c1-638"></a><span class="lineno"> 638</span>   <span class="n">strbuf_add</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c1-639"></a><span class="lineno"> 639</span> 
<a name="c1-640"></a><span class="lineno"> 640</span>   <span class="n">free</span><span class="p">(</span><span class="n">to_free</span><span class="p">);</span>
<a name="c1-641"></a><span class="lineno"> 641</span>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-642"></a><span class="lineno"> 642</span> <span class="p">}</span>
<a name="c1-643"></a><span class="lineno"> 643</span> 
<a name="c1-644"></a><span class="lineno"> 644</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">crlf_action</span> <span class="nf">git_path_check_crlf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<a name="c1-645"></a><span class="lineno"> 645</span> <span class="p">{</span>
<a name="c1-646"></a><span class="lineno"> 646</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<a name="c1-647"></a><span class="lineno"> 647</span> 
<a name="c1-648"></a><span class="lineno"> 648</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_TRUE</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c1-649"></a><span class="lineno"> 649</span>     <span class="k">return</span> <span class="n">CRLF_TEXT</span><span class="p">;</span>
<a name="c1-650"></a><span class="lineno"> 650</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_FALSE</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c1-651"></a><span class="lineno"> 651</span>     <span class="k">return</span> <span class="n">CRLF_BINARY</span><span class="p">;</span>
<a name="c1-652"></a><span class="lineno"> 652</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_UNSET</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c1-653"></a><span class="lineno"> 653</span>     <span class="p">;</span>
<a name="c1-654"></a><span class="lineno"> 654</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"input"</span><span class="p">))</span>
<a name="c1-655"></a><span class="lineno"> 655</span>     <span class="k">return</span> <span class="n">CRLF_INPUT</span><span class="p">;</span>
<a name="c1-656"></a><span class="lineno"> 656</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"auto"</span><span class="p">))</span>
<a name="c1-657"></a><span class="lineno"> 657</span>     <span class="k">return</span> <span class="n">CRLF_AUTO</span><span class="p">;</span>
<a name="c1-658"></a><span class="lineno"> 658</span>   <span class="k">return</span> <span class="n">CRLF_GUESS</span><span class="p">;</span>
<a name="c1-659"></a><span class="lineno"> 659</span> <span class="p">}</span>
<a name="c1-660"></a><span class="lineno"> 660</span> 
<a name="c1-661"></a><span class="lineno"> 661</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">eol</span> <span class="nf">git_path_check_eol</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<a name="c1-662"></a><span class="lineno"> 662</span> <span class="p">{</span>
<a name="c1-663"></a><span class="lineno"> 663</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<a name="c1-664"></a><span class="lineno"> 664</span> 
<a name="c1-665"></a><span class="lineno"> 665</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_UNSET</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c1-666"></a><span class="lineno"> 666</span>     <span class="p">;</span>
<a name="c1-667"></a><span class="lineno"> 667</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"lf"</span><span class="p">))</span>
<a name="c1-668"></a><span class="lineno"> 668</span>     <span class="k">return</span> <span class="n">EOL_LF</span><span class="p">;</span>
<a name="c1-669"></a><span class="lineno"> 669</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">"crlf"</span><span class="p">))</span>
<a name="c1-670"></a><span class="lineno"> 670</span>     <span class="k">return</span> <span class="n">EOL_CRLF</span><span class="p">;</span>
<a name="c1-671"></a><span class="lineno"> 671</span>   <span class="k">return</span> <span class="n">EOL_UNSET</span><span class="p">;</span>
<a name="c1-672"></a><span class="lineno"> 672</span> <span class="p">}</span>
<a name="c1-673"></a><span class="lineno"> 673</span> 
<a name="c1-674"></a><span class="lineno"> 674</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">convert_driver</span> <span class="o">*</span><span class="nf">git_path_check_convert</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
<a name="c1-675"></a><span class="lineno"> 675</span>                <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<a name="c1-676"></a><span class="lineno"> 676</span> <span class="p">{</span>
<a name="c1-677"></a><span class="lineno"> 677</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<a name="c1-678"></a><span class="lineno"> 678</span>   <span class="k">struct</span> <span class="n">convert_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
<a name="c1-679"></a><span class="lineno"> 679</span> 
<a name="c1-680"></a><span class="lineno"> 680</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ATTR_TRUE</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">||</span> <span class="n">ATTR_FALSE</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">||</span> <span class="n">ATTR_UNSET</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a name="c1-681"></a><span class="lineno"> 681</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-682"></a><span class="lineno"> 682</span>   <span class="k">for</span> <span class="p">(</span><span class="n">drv</span> <span class="o">=</span> <span class="n">user_convert</span><span class="p">;</span> <span class="n">drv</span><span class="p">;</span> <span class="n">drv</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c1-683"></a><span class="lineno"> 683</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
<a name="c1-684"></a><span class="lineno"> 684</span>       <span class="k">return</span> <span class="n">drv</span><span class="p">;</span>
<a name="c1-685"></a><span class="lineno"> 685</span>   <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-686"></a><span class="lineno"> 686</span> <span class="p">}</span>
<a name="c1-687"></a><span class="lineno"> 687</span> 
<a name="c1-688"></a><span class="lineno"> 688</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_path_check_ident</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="o">*</span><span class="n">check</span><span class="p">)</span>
<a name="c1-689"></a><span class="lineno"> 689</span> <span class="p">{</span>
<a name="c1-690"></a><span class="lineno"> 690</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">check</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<a name="c1-691"></a><span class="lineno"> 691</span> 
<a name="c1-692"></a><span class="lineno"> 692</span>   <span class="k">return</span> <span class="o">!!</span><span class="n">ATTR_TRUE</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<a name="c1-693"></a><span class="lineno"> 693</span> <span class="p">}</span>
<a name="c1-694"></a><span class="lineno"> 694</span> 
<a name="c1-695"></a><span class="lineno"> 695</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">crlf_action</span> <span class="nf">input_crlf_action</span><span class="p">(</span><span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">text_attr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">eol</span> <span class="n">eol_attr</span><span class="p">)</span>
<a name="c1-696"></a><span class="lineno"> 696</span> <span class="p">{</span>
<a name="c1-697"></a><span class="lineno"> 697</span>   <span class="k">if</span> <span class="p">(</span><span class="n">text_attr</span> <span class="o">==</span> <span class="n">CRLF_BINARY</span><span class="p">)</span>
<a name="c1-698"></a><span class="lineno"> 698</span>     <span class="k">return</span> <span class="n">CRLF_BINARY</span><span class="p">;</span>
<a name="c1-699"></a><span class="lineno"> 699</span>   <span class="k">if</span> <span class="p">(</span><span class="n">eol_attr</span> <span class="o">==</span> <span class="n">EOL_LF</span><span class="p">)</span>
<a name="c1-700"></a><span class="lineno"> 700</span>     <span class="k">return</span> <span class="n">CRLF_INPUT</span><span class="p">;</span>
<a name="c1-701"></a><span class="lineno"> 701</span>   <span class="k">if</span> <span class="p">(</span><span class="n">eol_attr</span> <span class="o">==</span> <span class="n">EOL_CRLF</span><span class="p">)</span>
<a name="c1-702"></a><span class="lineno"> 702</span>     <span class="k">return</span> <span class="n">CRLF_CRLF</span><span class="p">;</span>
<a name="c1-703"></a><span class="lineno"> 703</span>   <span class="k">return</span> <span class="n">text_attr</span><span class="p">;</span>
<a name="c1-704"></a><span class="lineno"> 704</span> <span class="p">}</span>
<a name="c1-705"></a><span class="lineno"> 705</span> 
<a name="c1-706"></a><span class="lineno"> 706</span> <span class="k">struct</span> <span class="n">conv_attrs</span> <span class="p">{</span>
<a name="c1-707"></a><span class="lineno"> 707</span>   <span class="k">struct</span> <span class="n">convert_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
<a name="c1-708"></a><span class="lineno"> 708</span>   <span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">crlf_action</span><span class="p">;</span>
<a name="c1-709"></a><span class="lineno"> 709</span>   <span class="k">enum</span> <span class="n">eol</span> <span class="n">eol_attr</span><span class="p">;</span>
<a name="c1-710"></a><span class="lineno"> 710</span>   <span class="kt">int</span> <span class="n">ident</span><span class="p">;</span>
<a name="c1-711"></a><span class="lineno"> 711</span> <span class="p">};</span>
<a name="c1-712"></a><span class="lineno"> 712</span> 
<a name="c1-713"></a><span class="lineno"> 713</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">conv_attr_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-714"></a><span class="lineno"> 714</span>   <span class="s">"crlf"</span><span class="p">,</span> <span class="s">"ident"</span><span class="p">,</span> <span class="s">"filter"</span><span class="p">,</span> <span class="s">"eol"</span><span class="p">,</span> <span class="s">"text"</span><span class="p">,</span>
<a name="c1-715"></a><span class="lineno"> 715</span> <span class="p">};</span>
<a name="c1-716"></a><span class="lineno"> 716</span> <span class="cp">#define NUM_CONV_ATTRS ARRAY_SIZE(conv_attr_name)</span>
<a name="c1-717"></a><span class="lineno"> 717</span> 
<a name="c1-718"></a><span class="lineno"> 718</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">convert_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">conv_attrs</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<a name="c1-719"></a><span class="lineno"> 719</span> <span class="p">{</span>
<a name="c1-720"></a><span class="lineno"> 720</span>   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-721"></a><span class="lineno"> 721</span>   <span class="k">static</span> <span class="k">struct</span> <span class="n">git_attr_check</span> <span class="n">ccheck</span><span class="p">[</span><span class="n">NUM_CONV_ATTRS</span><span class="p">];</span>
<a name="c1-722"></a><span class="lineno"> 722</span> 
<a name="c1-723"></a><span class="lineno"> 723</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccheck</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-724"></a><span class="lineno"> 724</span>     <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CONV_ATTRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c1-725"></a><span class="lineno"> 725</span>       <span class="n">ccheck</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span> <span class="o">=</span> <span class="n">git_attr</span><span class="p">(</span><span class="n">conv_attr_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c1-726"></a><span class="lineno"> 726</span>     <span class="n">user_convert_tail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">user_convert</span><span class="p">;</span>
<a name="c1-727"></a><span class="lineno"> 727</span>     <span class="n">git_config</span><span class="p">(</span><span class="n">read_convert_config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-728"></a><span class="lineno"> 728</span>   <span class="p">}</span>
<a name="c1-729"></a><span class="lineno"> 729</span> 
<a name="c1-730"></a><span class="lineno"> 730</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">git_check_attr</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">NUM_CONV_ATTRS</span><span class="p">,</span> <span class="n">ccheck</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-731"></a><span class="lineno"> 731</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">crlf_action</span> <span class="o">=</span> <span class="n">git_path_check_crlf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ccheck</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
<a name="c1-732"></a><span class="lineno"> 732</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">)</span>
<a name="c1-733"></a><span class="lineno"> 733</span>       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">crlf_action</span> <span class="o">=</span> <span class="n">git_path_check_crlf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ccheck</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-734"></a><span class="lineno"> 734</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">git_path_check_ident</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ccheck</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-735"></a><span class="lineno"> 735</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="n">git_path_check_convert</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ccheck</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<a name="c1-736"></a><span class="lineno"> 736</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">eol_attr</span> <span class="o">=</span> <span class="n">git_path_check_eol</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ccheck</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
<a name="c1-737"></a><span class="lineno"> 737</span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-738"></a><span class="lineno"> 738</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-739"></a><span class="lineno"> 739</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">crlf_action</span> <span class="o">=</span> <span class="n">CRLF_GUESS</span><span class="p">;</span>
<a name="c1-740"></a><span class="lineno"> 740</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">eol_attr</span> <span class="o">=</span> <span class="n">EOL_UNSET</span><span class="p">;</span>
<a name="c1-741"></a><span class="lineno"> 741</span>     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-742"></a><span class="lineno"> 742</span>   <span class="p">}</span>
<a name="c1-743"></a><span class="lineno"> 743</span> <span class="p">}</span>
<a name="c1-744"></a><span class="lineno"> 744</span> 
<a name="c1-745"></a><span class="lineno"> 745</span> <span class="kt">int</span> <span class="nf">convert_to_git</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c1-746"></a><span class="lineno"> 746</span>                    <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">enum</span> <span class="n">safe_crlf</span> <span class="n">checksafe</span><span class="p">)</span>
<a name="c1-747"></a><span class="lineno"> 747</span> <span class="p">{</span>
<a name="c1-748"></a><span class="lineno"> 748</span>   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-749"></a><span class="lineno"> 749</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-750"></a><span class="lineno"> 750</span>   <span class="k">struct</span> <span class="n">conv_attrs</span> <span class="n">ca</span><span class="p">;</span>
<a name="c1-751"></a><span class="lineno"> 751</span> 
<a name="c1-752"></a><span class="lineno"> 752</span>   <span class="n">convert_attrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-753"></a><span class="lineno"> 753</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">drv</span><span class="p">)</span>
<a name="c1-754"></a><span class="lineno"> 754</span>     <span class="n">filter</span> <span class="o">=</span> <span class="n">ca</span><span class="p">.</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">clean</span><span class="p">;</span>
<a name="c1-755"></a><span class="lineno"> 755</span> 
<a name="c1-756"></a><span class="lineno"> 756</span>   <span class="n">ret</span> <span class="o">|=</span> <span class="n">apply_filter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
<a name="c1-757"></a><span class="lineno"> 757</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-758"></a><span class="lineno"> 758</span>     <span class="n">src</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-759"></a><span class="lineno"> 759</span>     <span class="n">len</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c1-760"></a><span class="lineno"> 760</span>   <span class="p">}</span>
<a name="c1-761"></a><span class="lineno"> 761</span>   <span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span> <span class="o">=</span> <span class="n">input_crlf_action</span><span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">eol_attr</span><span class="p">);</span>
<a name="c1-762"></a><span class="lineno"> 762</span>   <span class="n">ret</span> <span class="o">|=</span> <span class="n">crlf_to_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span><span class="p">,</span> <span class="n">checksafe</span><span class="p">);</span>
<a name="c1-763"></a><span class="lineno"> 763</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-764"></a><span class="lineno"> 764</span>     <span class="n">src</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-765"></a><span class="lineno"> 765</span>     <span class="n">len</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c1-766"></a><span class="lineno"> 766</span>   <span class="p">}</span>
<a name="c1-767"></a><span class="lineno"> 767</span>   <span class="k">return</span> <span class="n">ret</span> <span class="o">|</span> <span class="n">ident_to_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span>
<a name="c1-768"></a><span class="lineno"> 768</span> <span class="p">}</span>
<a name="c1-769"></a><span class="lineno"> 769</span> 
<a name="c1-770"></a><span class="lineno"> 770</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">convert_to_working_tree_internal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
<a name="c1-771"></a><span class="lineno"> 771</span>               <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
<a name="c1-772"></a><span class="lineno"> 772</span>               <span class="kt">int</span> <span class="n">normalizing</span><span class="p">)</span>
<a name="c1-773"></a><span class="lineno"> 773</span> <span class="p">{</span>
<a name="c1-774"></a><span class="lineno"> 774</span>   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-775"></a><span class="lineno"> 775</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-776"></a><span class="lineno"> 776</span>   <span class="k">struct</span> <span class="n">conv_attrs</span> <span class="n">ca</span><span class="p">;</span>
<a name="c1-777"></a><span class="lineno"> 777</span> 
<a name="c1-778"></a><span class="lineno"> 778</span>   <span class="n">convert_attrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-779"></a><span class="lineno"> 779</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">drv</span><span class="p">)</span>
<a name="c1-780"></a><span class="lineno"> 780</span>     <span class="n">filter</span> <span class="o">=</span> <span class="n">ca</span><span class="p">.</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">smudge</span><span class="p">;</span>
<a name="c1-781"></a><span class="lineno"> 781</span> 
<a name="c1-782"></a><span class="lineno"> 782</span>   <span class="n">ret</span> <span class="o">|=</span> <span class="n">ident_to_worktree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span>
<a name="c1-783"></a><span class="lineno"> 783</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-784"></a><span class="lineno"> 784</span>     <span class="n">src</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-785"></a><span class="lineno"> 785</span>     <span class="n">len</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c1-786"></a><span class="lineno"> 786</span>   <span class="p">}</span>
<a name="c1-787"></a><span class="lineno"> 787</span>   <span class="cm">/*</span>
<a name="c1-788"></a><span class="lineno"> 788</span> <span class="cm">  * CRLF conversion can be skipped if normalizing, unless there</span>
<a name="c1-789"></a><span class="lineno"> 789</span> <span class="cm">  * is a smudge filter.  The filter might expect CRLFs.</span>
<a name="c1-790"></a><span class="lineno"> 790</span> <span class="cm">  */</span>
<a name="c1-791"></a><span class="lineno"> 791</span>   <span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">||</span> <span class="o">!</span><span class="n">normalizing</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-792"></a><span class="lineno"> 792</span>     <span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span> <span class="o">=</span> <span class="n">input_crlf_action</span><span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">eol_attr</span><span class="p">);</span>
<a name="c1-793"></a><span class="lineno"> 793</span>     <span class="n">ret</span> <span class="o">|=</span> <span class="n">crlf_to_worktree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span><span class="p">);</span>
<a name="c1-794"></a><span class="lineno"> 794</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-795"></a><span class="lineno"> 795</span>       <span class="n">src</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-796"></a><span class="lineno"> 796</span>       <span class="n">len</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c1-797"></a><span class="lineno"> 797</span>     <span class="p">}</span>
<a name="c1-798"></a><span class="lineno"> 798</span>   <span class="p">}</span>
<a name="c1-799"></a><span class="lineno"> 799</span>   <span class="k">return</span> <span class="n">ret</span> <span class="o">|</span> <span class="n">apply_filter</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
<a name="c1-800"></a><span class="lineno"> 800</span> <span class="p">}</span>
<a name="c1-801"></a><span class="lineno"> 801</span> 
<a name="c1-802"></a><span class="lineno"> 802</span> <span class="kt">int</span> <span class="nf">convert_to_working_tree</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<a name="c1-803"></a><span class="lineno"> 803</span> <span class="p">{</span>
<a name="c1-804"></a><span class="lineno"> 804</span>   <span class="k">return</span> <span class="n">convert_to_working_tree_internal</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-805"></a><span class="lineno"> 805</span> <span class="p">}</span>
<a name="c1-806"></a><span class="lineno"> 806</span> 
<a name="c1-807"></a><span class="lineno"> 807</span> <span class="kt">int</span> <span class="nf">renormalize_buffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<a name="c1-808"></a><span class="lineno"> 808</span> <span class="p">{</span>
<a name="c1-809"></a><span class="lineno"> 809</span>   <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">convert_to_working_tree_internal</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-810"></a><span class="lineno"> 810</span>   <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-811"></a><span class="lineno"> 811</span>     <span class="n">src</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c1-812"></a><span class="lineno"> 812</span>     <span class="n">len</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c1-813"></a><span class="lineno"> 813</span>   <span class="p">}</span>
<a name="c1-814"></a><span class="lineno"> 814</span>   <span class="k">return</span> <span class="n">ret</span> <span class="o">|</span> <span class="n">convert_to_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">SAFE_CRLF_FALSE</span><span class="p">);</span>
<a name="c1-815"></a><span class="lineno"> 815</span> <span class="p">}</span>
<a name="c1-816"></a><span class="lineno"> 816</span> 
<a name="c1-817"></a><span class="lineno"> 817</span> <span class="cm">/*****************************************************************</span>
<a name="c1-818"></a><span class="lineno"> 818</span> <span class="cm"> *</span>
<a name="c1-819"></a><span class="lineno"> 819</span> <span class="cm"> * Streaming converison support</span>
<a name="c1-820"></a><span class="lineno"> 820</span> <span class="cm"> *</span>
<a name="c1-821"></a><span class="lineno"> 821</span> <span class="cm"> *****************************************************************/</span>
<a name="c1-822"></a><span class="lineno"> 822</span> 
<a name="c1-823"></a><span class="lineno"> 823</span> <span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">filter_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="p">,</span>
<a name="c1-824"></a><span class="lineno"> 824</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">,</span>
<a name="c1-825"></a><span class="lineno"> 825</span>        <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">);</span>
<a name="c1-826"></a><span class="lineno"> 826</span> <span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="p">);</span>
<a name="c1-827"></a><span class="lineno"> 827</span> 
<a name="c1-828"></a><span class="lineno"> 828</span> <span class="k">struct</span> <span class="n">stream_filter_vtbl</span> <span class="p">{</span>
<a name="c1-829"></a><span class="lineno"> 829</span>   <span class="n">filter_fn</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-830"></a><span class="lineno"> 830</span>   <span class="n">free_fn</span> <span class="n">free</span><span class="p">;</span>
<a name="c1-831"></a><span class="lineno"> 831</span> <span class="p">};</span>
<a name="c1-832"></a><span class="lineno"> 832</span> 
<a name="c1-833"></a><span class="lineno"> 833</span> <span class="k">struct</span> <span class="n">stream_filter</span> <span class="p">{</span>
<a name="c1-834"></a><span class="lineno"> 834</span>   <span class="k">struct</span> <span class="n">stream_filter_vtbl</span> <span class="o">*</span><span class="n">vtbl</span><span class="p">;</span>
<a name="c1-835"></a><span class="lineno"> 835</span> <span class="p">};</span>
<a name="c1-836"></a><span class="lineno"> 836</span> 
<a name="c1-837"></a><span class="lineno"> 837</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">null_filter_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
<a name="c1-838"></a><span class="lineno"> 838</span>         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">,</span>
<a name="c1-839"></a><span class="lineno"> 839</span>         <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-840"></a><span class="lineno"> 840</span> <span class="p">{</span>
<a name="c1-841"></a><span class="lineno"> 841</span>   <span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
<a name="c1-842"></a><span class="lineno"> 842</span> 
<a name="c1-843"></a><span class="lineno"> 843</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span>
<a name="c1-844"></a><span class="lineno"> 844</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* we do not keep any states */</span>
<a name="c1-845"></a><span class="lineno"> 845</span>   <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">;</span>
<a name="c1-846"></a><span class="lineno"> 846</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">osize_p</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
<a name="c1-847"></a><span class="lineno"> 847</span>     <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">;</span>
<a name="c1-848"></a><span class="lineno"> 848</span>   <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-849"></a><span class="lineno"> 849</span>     <span class="n">memmove</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<a name="c1-850"></a><span class="lineno"> 850</span>     <span class="o">*</span><span class="n">isize_p</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
<a name="c1-851"></a><span class="lineno"> 851</span>     <span class="o">*</span><span class="n">osize_p</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
<a name="c1-852"></a><span class="lineno"> 852</span>   <span class="p">}</span>
<a name="c1-853"></a><span class="lineno"> 853</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-854"></a><span class="lineno"> 854</span> <span class="p">}</span>
<a name="c1-855"></a><span class="lineno"> 855</span> 
<a name="c1-856"></a><span class="lineno"> 856</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">null_free_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<a name="c1-857"></a><span class="lineno"> 857</span> <span class="p">{</span>
<a name="c1-858"></a><span class="lineno"> 858</span>   <span class="p">;</span> <span class="cm">/* nothing -- null instances are shared */</span>
<a name="c1-859"></a><span class="lineno"> 859</span> <span class="p">}</span>
<a name="c1-860"></a><span class="lineno"> 860</span> 
<a name="c1-861"></a><span class="lineno"> 861</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter_vtbl</span> <span class="n">null_vtbl</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-862"></a><span class="lineno"> 862</span>   <span class="n">null_filter_fn</span><span class="p">,</span>
<a name="c1-863"></a><span class="lineno"> 863</span>   <span class="n">null_free_fn</span><span class="p">,</span>
<a name="c1-864"></a><span class="lineno"> 864</span> <span class="p">};</span>
<a name="c1-865"></a><span class="lineno"> 865</span> 
<a name="c1-866"></a><span class="lineno"> 866</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter</span> <span class="n">null_filter_singleton</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-867"></a><span class="lineno"> 867</span>   <span class="o">&amp;</span><span class="n">null_vtbl</span><span class="p">,</span>
<a name="c1-868"></a><span class="lineno"> 868</span> <span class="p">};</span>
<a name="c1-869"></a><span class="lineno"> 869</span> 
<a name="c1-870"></a><span class="lineno"> 870</span> <span class="kt">int</span> <span class="nf">is_null_stream_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<a name="c1-871"></a><span class="lineno"> 871</span> <span class="p">{</span>
<a name="c1-872"></a><span class="lineno"> 872</span>   <span class="k">return</span> <span class="n">filter</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">null_filter_singleton</span><span class="p">;</span>
<a name="c1-873"></a><span class="lineno"> 873</span> <span class="p">}</span>
<a name="c1-874"></a><span class="lineno"> 874</span> 
<a name="c1-875"></a><span class="lineno"> 875</span> 
<a name="c1-876"></a><span class="lineno"> 876</span> <span class="cm">/*</span>
<a name="c1-877"></a><span class="lineno"> 877</span> <span class="cm"> * LF-to-CRLF filter</span>
<a name="c1-878"></a><span class="lineno"> 878</span> <span class="cm"> */</span>
<a name="c1-879"></a><span class="lineno"> 879</span> 
<a name="c1-880"></a><span class="lineno"> 880</span> <span class="k">struct</span> <span class="n">lf_to_crlf_filter</span> <span class="p">{</span>
<a name="c1-881"></a><span class="lineno"> 881</span>   <span class="k">struct</span> <span class="n">stream_filter</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-882"></a><span class="lineno"> 882</span>   <span class="kt">unsigned</span> <span class="n">has_held</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-883"></a><span class="lineno"> 883</span>   <span class="kt">char</span> <span class="n">held</span><span class="p">;</span>
<a name="c1-884"></a><span class="lineno"> 884</span> <span class="p">};</span>
<a name="c1-885"></a><span class="lineno"> 885</span> 
<a name="c1-886"></a><span class="lineno"> 886</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">lf_to_crlf_filter_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
<a name="c1-887"></a><span class="lineno"> 887</span>         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">,</span>
<a name="c1-888"></a><span class="lineno"> 888</span>         <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-889"></a><span class="lineno"> 889</span> <span class="p">{</span>
<a name="c1-890"></a><span class="lineno"> 890</span>   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-891"></a><span class="lineno"> 891</span>   <span class="k">struct</span> <span class="n">lf_to_crlf_filter</span> <span class="o">*</span><span class="n">lf_to_crlf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lf_to_crlf_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">filter</span><span class="p">;</span>
<a name="c1-892"></a><span class="lineno"> 892</span> 
<a name="c1-893"></a><span class="lineno"> 893</span>   <span class="cm">/*</span>
<a name="c1-894"></a><span class="lineno"> 894</span> <span class="cm">  * We may be holding onto the CR to see if it is followed by a</span>
<a name="c1-895"></a><span class="lineno"> 895</span> <span class="cm">  * LF, in which case we would need to go to the main loop.</span>
<a name="c1-896"></a><span class="lineno"> 896</span> <span class="cm">  * Otherwise, just emit it to the output stream.</span>
<a name="c1-897"></a><span class="lineno"> 897</span> <span class="cm">  */</span>
<a name="c1-898"></a><span class="lineno"> 898</span>   <span class="k">if</span> <span class="p">(</span><span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">held</span> <span class="o">!=</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="o">!</span><span class="n">input</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-899"></a><span class="lineno"> 899</span>     <span class="n">output</span><span class="p">[</span><span class="n">o</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">held</span><span class="p">;</span>
<a name="c1-900"></a><span class="lineno"> 900</span>     <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-901"></a><span class="lineno"> 901</span>   <span class="p">}</span>
<a name="c1-902"></a><span class="lineno"> 902</span> 
<a name="c1-903"></a><span class="lineno"> 903</span>   <span class="cm">/* We are told to drain */</span>
<a name="c1-904"></a><span class="lineno"> 904</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-905"></a><span class="lineno"> 905</span>     <span class="o">*</span><span class="n">osize_p</span> <span class="o">-=</span> <span class="n">o</span><span class="p">;</span>
<a name="c1-906"></a><span class="lineno"> 906</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-907"></a><span class="lineno"> 907</span>   <span class="p">}</span>
<a name="c1-908"></a><span class="lineno"> 908</span> 
<a name="c1-909"></a><span class="lineno"> 909</span>   <span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">;</span>
<a name="c1-910"></a><span class="lineno"> 910</span>   <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">||</span> <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-911"></a><span class="lineno"> 911</span>     <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-912"></a><span class="lineno"> 912</span>     <span class="kt">int</span> <span class="n">was_cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-913"></a><span class="lineno"> 913</span> 
<a name="c1-914"></a><span class="lineno"> 914</span>     <span class="k">if</span> <span class="p">(</span><span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-915"></a><span class="lineno"> 915</span>       <span class="n">was_cr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-916"></a><span class="lineno"> 916</span>       <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-917"></a><span class="lineno"> 917</span>     <span class="p">}</span>
<a name="c1-918"></a><span class="lineno"> 918</span> 
<a name="c1-919"></a><span class="lineno"> 919</span>     <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">osize_p</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-920"></a><span class="lineno"> 920</span>       <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c1-921"></a><span class="lineno"> 921</span> 
<a name="c1-922"></a><span class="lineno"> 922</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-923"></a><span class="lineno"> 923</span>         <span class="n">output</span><span class="p">[</span><span class="n">o</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
<a name="c1-924"></a><span class="lineno"> 924</span>       <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">was_cr</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-925"></a><span class="lineno"> 925</span>         <span class="cm">/*</span>
<a name="c1-926"></a><span class="lineno"> 926</span> <span class="cm">        * Previous round saw CR and it is not followed</span>
<a name="c1-927"></a><span class="lineno"> 927</span> <span class="cm">        * by a LF; emit the CR before processing the</span>
<a name="c1-928"></a><span class="lineno"> 928</span> <span class="cm">        * current character.</span>
<a name="c1-929"></a><span class="lineno"> 929</span> <span class="cm">        */</span>
<a name="c1-930"></a><span class="lineno"> 930</span>         <span class="n">output</span><span class="p">[</span><span class="n">o</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
<a name="c1-931"></a><span class="lineno"> 931</span>       <span class="p">}</span>
<a name="c1-932"></a><span class="lineno"> 932</span> 
<a name="c1-933"></a><span class="lineno"> 933</span>       <span class="cm">/*</span>
<a name="c1-934"></a><span class="lineno"> 934</span> <span class="cm">      * We may have consumed the last output slot,</span>
<a name="c1-935"></a><span class="lineno"> 935</span> <span class="cm">      * in which case we need to break out of this</span>
<a name="c1-936"></a><span class="lineno"> 936</span> <span class="cm">      * loop; hold the current character before</span>
<a name="c1-937"></a><span class="lineno"> 937</span> <span class="cm">      * returning.</span>
<a name="c1-938"></a><span class="lineno"> 938</span> <span class="cm">      */</span>
<a name="c1-939"></a><span class="lineno"> 939</span>       <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">osize_p</span> <span class="o">&lt;=</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-940"></a><span class="lineno"> 940</span>         <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-941"></a><span class="lineno"> 941</span>         <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">held</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
<a name="c1-942"></a><span class="lineno"> 942</span>         <span class="k">continue</span><span class="p">;</span> <span class="cm">/* break but increment i */</span>
<a name="c1-943"></a><span class="lineno"> 943</span>       <span class="p">}</span>
<a name="c1-944"></a><span class="lineno"> 944</span> 
<a name="c1-945"></a><span class="lineno"> 945</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-946"></a><span class="lineno"> 946</span>         <span class="n">was_cr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-947"></a><span class="lineno"> 947</span>         <span class="k">continue</span><span class="p">;</span>
<a name="c1-948"></a><span class="lineno"> 948</span>       <span class="p">}</span>
<a name="c1-949"></a><span class="lineno"> 949</span> 
<a name="c1-950"></a><span class="lineno"> 950</span>       <span class="n">was_cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-951"></a><span class="lineno"> 951</span>       <span class="n">output</span><span class="p">[</span><span class="n">o</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
<a name="c1-952"></a><span class="lineno"> 952</span>     <span class="p">}</span>
<a name="c1-953"></a><span class="lineno"> 953</span> 
<a name="c1-954"></a><span class="lineno"> 954</span>     <span class="o">*</span><span class="n">osize_p</span> <span class="o">-=</span> <span class="n">o</span><span class="p">;</span>
<a name="c1-955"></a><span class="lineno"> 955</span>     <span class="o">*</span><span class="n">isize_p</span> <span class="o">-=</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-956"></a><span class="lineno"> 956</span> 
<a name="c1-957"></a><span class="lineno"> 957</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span> <span class="o">&amp;&amp;</span> <span class="n">was_cr</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-958"></a><span class="lineno"> 958</span>       <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">has_held</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-959"></a><span class="lineno"> 959</span>       <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">held</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
<a name="c1-960"></a><span class="lineno"> 960</span>     <span class="p">}</span>
<a name="c1-961"></a><span class="lineno"> 961</span>   <span class="p">}</span>
<a name="c1-962"></a><span class="lineno"> 962</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-963"></a><span class="lineno"> 963</span> <span class="p">}</span>
<a name="c1-964"></a><span class="lineno"> 964</span> 
<a name="c1-965"></a><span class="lineno"> 965</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">lf_to_crlf_free_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<a name="c1-966"></a><span class="lineno"> 966</span> <span class="p">{</span>
<a name="c1-967"></a><span class="lineno"> 967</span>   <span class="n">free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
<a name="c1-968"></a><span class="lineno"> 968</span> <span class="p">}</span>
<a name="c1-969"></a><span class="lineno"> 969</span> 
<a name="c1-970"></a><span class="lineno"> 970</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter_vtbl</span> <span class="n">lf_to_crlf_vtbl</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-971"></a><span class="lineno"> 971</span>   <span class="n">lf_to_crlf_filter_fn</span><span class="p">,</span>
<a name="c1-972"></a><span class="lineno"> 972</span>   <span class="n">lf_to_crlf_free_fn</span><span class="p">,</span>
<a name="c1-973"></a><span class="lineno"> 973</span> <span class="p">};</span>
<a name="c1-974"></a><span class="lineno"> 974</span> 
<a name="c1-975"></a><span class="lineno"> 975</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="nf">lf_to_crlf_filter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="c1-976"></a><span class="lineno"> 976</span> <span class="p">{</span>
<a name="c1-977"></a><span class="lineno"> 977</span>   <span class="k">struct</span> <span class="n">lf_to_crlf_filter</span> <span class="o">*</span><span class="n">lf_to_crlf</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lf_to_crlf</span><span class="p">));</span>
<a name="c1-978"></a><span class="lineno"> 978</span> 
<a name="c1-979"></a><span class="lineno"> 979</span>   <span class="n">lf_to_crlf</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">.</span><span class="n">vtbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lf_to_crlf_vtbl</span><span class="p">;</span>
<a name="c1-980"></a><span class="lineno"> 980</span>   <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">lf_to_crlf</span><span class="p">;</span>
<a name="c1-981"></a><span class="lineno"> 981</span> <span class="p">}</span>
<a name="c1-982"></a><span class="lineno"> 982</span> 
<a name="c1-983"></a><span class="lineno"> 983</span> <span class="cm">/*</span>
<a name="c1-984"></a><span class="lineno"> 984</span> <span class="cm"> * Cascade filter</span>
<a name="c1-985"></a><span class="lineno"> 985</span> <span class="cm"> */</span>
<a name="c1-986"></a><span class="lineno"> 986</span> <span class="cp">#define FILTER_BUFFER 1024</span>
<a name="c1-987"></a><span class="lineno"> 987</span> <span class="k">struct</span> <span class="n">cascade_filter</span> <span class="p">{</span>
<a name="c1-988"></a><span class="lineno"> 988</span>   <span class="k">struct</span> <span class="n">stream_filter</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-989"></a><span class="lineno"> 989</span>   <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">one</span><span class="p">;</span>
<a name="c1-990"></a><span class="lineno"> 990</span>   <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">two</span><span class="p">;</span>
<a name="c1-991"></a><span class="lineno"> 991</span>   <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">FILTER_BUFFER</span><span class="p">];</span>
<a name="c1-992"></a><span class="lineno"> 992</span>   <span class="kt">int</span> <span class="n">end</span><span class="p">,</span> <span class="n">ptr</span><span class="p">;</span>
<a name="c1-993"></a><span class="lineno"> 993</span> <span class="p">};</span>
<a name="c1-994"></a><span class="lineno"> 994</span> 
<a name="c1-995"></a><span class="lineno"> 995</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">cascade_filter_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
<a name="c1-996"></a><span class="lineno"> 996</span>            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">,</span>
<a name="c1-997"></a><span class="lineno"> 997</span>            <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-998"></a><span class="lineno"> 998</span> <span class="p">{</span>
<a name="c1-999"></a><span class="lineno"> 999</span>   <span class="k">struct</span> <span class="n">cascade_filter</span> <span class="o">*</span><span class="n">cas</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cascade_filter</span> <span class="o">*</span><span class="p">)</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-1000"></a><span class="lineno">1000</span>  <span class="kt">size_t</span> <span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1001"></a><span class="lineno">1001</span>  <span class="kt">size_t</span> <span class="n">sz</span> <span class="o">=</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">;</span>
<a name="c1-1002"></a><span class="lineno">1002</span>  <span class="kt">size_t</span> <span class="n">to_feed</span><span class="p">,</span> <span class="n">remaining</span><span class="p">;</span>
<a name="c1-1003"></a><span class="lineno">1003</span> 
<a name="c1-1004"></a><span class="lineno">1004</span>  <span class="cm">/*</span>
<a name="c1-1005"></a><span class="lineno">1005</span> <span class="cm">   * input -- (one) --&gt; buf -- (two) --&gt; output</span>
<a name="c1-1006"></a><span class="lineno">1006</span> <span class="cm">   */</span>
<a name="c1-1007"></a><span class="lineno">1007</span>  <span class="k">while</span> <span class="p">(</span><span class="n">filled</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1008"></a><span class="lineno">1008</span>    <span class="n">remaining</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">filled</span><span class="p">;</span>
<a name="c1-1009"></a><span class="lineno">1009</span> 
<a name="c1-1010"></a><span class="lineno">1010</span>    <span class="cm">/* do we already have something to feed two with? */</span>
<a name="c1-1011"></a><span class="lineno">1011</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">cas</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1012"></a><span class="lineno">1012</span>      <span class="n">to_feed</span> <span class="o">=</span> <span class="n">cas</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">cas</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
<a name="c1-1013"></a><span class="lineno">1013</span>      <span class="k">if</span> <span class="p">(</span><span class="n">stream_filter</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">two</span><span class="p">,</span>
<a name="c1-1014"></a><span class="lineno">1014</span>            <span class="n">cas</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">cas</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_feed</span><span class="p">,</span>
<a name="c1-1015"></a><span class="lineno">1015</span>            <span class="n">output</span> <span class="o">+</span> <span class="n">filled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remaining</span><span class="p">))</span>
<a name="c1-1016"></a><span class="lineno">1016</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-1017"></a><span class="lineno">1017</span>      <span class="n">cas</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">cas</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span> <span class="n">to_feed</span><span class="p">;</span>
<a name="c1-1018"></a><span class="lineno">1018</span>      <span class="n">filled</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">;</span>
<a name="c1-1019"></a><span class="lineno">1019</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1020"></a><span class="lineno">1020</span>    <span class="p">}</span>
<a name="c1-1021"></a><span class="lineno">1021</span> 
<a name="c1-1022"></a><span class="lineno">1022</span>    <span class="cm">/* feed one from upstream and have it emit into our buffer */</span>
<a name="c1-1023"></a><span class="lineno">1023</span>    <span class="n">to_feed</span> <span class="o">=</span> <span class="n">input</span> <span class="o">?</span> <span class="o">*</span><span class="n">isize_p</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1024"></a><span class="lineno">1024</span>    <span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">to_feed</span><span class="p">)</span>
<a name="c1-1025"></a><span class="lineno">1025</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-1026"></a><span class="lineno">1026</span>    <span class="n">remaining</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c1-1027"></a><span class="lineno">1027</span>    <span class="k">if</span> <span class="p">(</span><span class="n">stream_filter</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">one</span><span class="p">,</span>
<a name="c1-1028"></a><span class="lineno">1028</span>          <span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_feed</span><span class="p">,</span>
<a name="c1-1029"></a><span class="lineno">1029</span>          <span class="n">cas</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remaining</span><span class="p">))</span>
<a name="c1-1030"></a><span class="lineno">1030</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-1031"></a><span class="lineno">1031</span>    <span class="n">cas</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">;</span>
<a name="c1-1032"></a><span class="lineno">1032</span>    <span class="n">cas</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1033"></a><span class="lineno">1033</span>    <span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1034"></a><span class="lineno">1034</span>      <span class="kt">size_t</span> <span class="n">fed</span> <span class="o">=</span> <span class="o">*</span><span class="n">isize_p</span> <span class="o">-</span> <span class="n">to_feed</span><span class="p">;</span>
<a name="c1-1035"></a><span class="lineno">1035</span>      <span class="o">*</span><span class="n">isize_p</span> <span class="o">-=</span> <span class="n">fed</span><span class="p">;</span>
<a name="c1-1036"></a><span class="lineno">1036</span>      <span class="n">input</span> <span class="o">+=</span> <span class="n">fed</span><span class="p">;</span>
<a name="c1-1037"></a><span class="lineno">1037</span>    <span class="p">}</span>
<a name="c1-1038"></a><span class="lineno">1038</span> 
<a name="c1-1039"></a><span class="lineno">1039</span>    <span class="cm">/* do we know that we drained one completely? */</span>
<a name="c1-1040"></a><span class="lineno">1040</span>    <span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">||</span> <span class="n">cas</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
<a name="c1-1041"></a><span class="lineno">1041</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1042"></a><span class="lineno">1042</span> 
<a name="c1-1043"></a><span class="lineno">1043</span>    <span class="cm">/* tell two to drain; we have nothing more to give it */</span>
<a name="c1-1044"></a><span class="lineno">1044</span>    <span class="n">to_feed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1045"></a><span class="lineno">1045</span>    <span class="n">remaining</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">filled</span><span class="p">;</span>
<a name="c1-1046"></a><span class="lineno">1046</span>    <span class="k">if</span> <span class="p">(</span><span class="n">stream_filter</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">two</span><span class="p">,</span>
<a name="c1-1047"></a><span class="lineno">1047</span>          <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_feed</span><span class="p">,</span>
<a name="c1-1048"></a><span class="lineno">1048</span>          <span class="n">output</span> <span class="o">+</span> <span class="n">filled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remaining</span><span class="p">))</span>
<a name="c1-1049"></a><span class="lineno">1049</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-1050"></a><span class="lineno">1050</span>    <span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">==</span> <span class="p">(</span><span class="n">sz</span> <span class="o">-</span> <span class="n">filled</span><span class="p">))</span>
<a name="c1-1051"></a><span class="lineno">1051</span>      <span class="k">break</span><span class="p">;</span> <span class="cm">/* completely drained two */</span>
<a name="c1-1052"></a><span class="lineno">1052</span>    <span class="n">filled</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">;</span>
<a name="c1-1053"></a><span class="lineno">1053</span>  <span class="p">}</span>
<a name="c1-1054"></a><span class="lineno">1054</span>  <span class="o">*</span><span class="n">osize_p</span> <span class="o">-=</span> <span class="n">filled</span><span class="p">;</span>
<a name="c1-1055"></a><span class="lineno">1055</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1056"></a><span class="lineno">1056</span> <span class="p">}</span>
<a name="c1-1057"></a><span class="lineno">1057</span> 
<a name="c1-1058"></a><span class="lineno">1058</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">cascade_free_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<a name="c1-1059"></a><span class="lineno">1059</span> <span class="p">{</span>
<a name="c1-1060"></a><span class="lineno">1060</span>  <span class="k">struct</span> <span class="n">cascade_filter</span> <span class="o">*</span><span class="n">cas</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cascade_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">filter</span><span class="p">;</span>
<a name="c1-1061"></a><span class="lineno">1061</span>  <span class="n">free_stream_filter</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">one</span><span class="p">);</span>
<a name="c1-1062"></a><span class="lineno">1062</span>  <span class="n">free_stream_filter</span><span class="p">(</span><span class="n">cas</span><span class="o">-&gt;</span><span class="n">two</span><span class="p">);</span>
<a name="c1-1063"></a><span class="lineno">1063</span>  <span class="n">free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
<a name="c1-1064"></a><span class="lineno">1064</span> <span class="p">}</span>
<a name="c1-1065"></a><span class="lineno">1065</span> 
<a name="c1-1066"></a><span class="lineno">1066</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter_vtbl</span> <span class="n">cascade_vtbl</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-1067"></a><span class="lineno">1067</span>  <span class="n">cascade_filter_fn</span><span class="p">,</span>
<a name="c1-1068"></a><span class="lineno">1068</span>  <span class="n">cascade_free_fn</span><span class="p">,</span>
<a name="c1-1069"></a><span class="lineno">1069</span> <span class="p">};</span>
<a name="c1-1070"></a><span class="lineno">1070</span> 
<a name="c1-1071"></a><span class="lineno">1071</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="nf">cascade_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">one</span><span class="p">,</span>
<a name="c1-1072"></a><span class="lineno">1072</span>              <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">two</span><span class="p">)</span>
<a name="c1-1073"></a><span class="lineno">1073</span> <span class="p">{</span>
<a name="c1-1074"></a><span class="lineno">1074</span>  <span class="k">struct</span> <span class="n">cascade_filter</span> <span class="o">*</span><span class="n">cascade</span><span class="p">;</span>
<a name="c1-1075"></a><span class="lineno">1075</span> 
<a name="c1-1076"></a><span class="lineno">1076</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">one</span> <span class="o">||</span> <span class="n">is_null_stream_filter</span><span class="p">(</span><span class="n">one</span><span class="p">))</span>
<a name="c1-1077"></a><span class="lineno">1077</span>    <span class="k">return</span> <span class="n">two</span><span class="p">;</span>
<a name="c1-1078"></a><span class="lineno">1078</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">two</span> <span class="o">||</span> <span class="n">is_null_stream_filter</span><span class="p">(</span><span class="n">two</span><span class="p">))</span>
<a name="c1-1079"></a><span class="lineno">1079</span>    <span class="k">return</span> <span class="n">one</span><span class="p">;</span>
<a name="c1-1080"></a><span class="lineno">1080</span> 
<a name="c1-1081"></a><span class="lineno">1081</span>  <span class="n">cascade</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cascade</span><span class="p">));</span>
<a name="c1-1082"></a><span class="lineno">1082</span>  <span class="n">cascade</span><span class="o">-&gt;</span><span class="n">one</span> <span class="o">=</span> <span class="n">one</span><span class="p">;</span>
<a name="c1-1083"></a><span class="lineno">1083</span>  <span class="n">cascade</span><span class="o">-&gt;</span><span class="n">two</span> <span class="o">=</span> <span class="n">two</span><span class="p">;</span>
<a name="c1-1084"></a><span class="lineno">1084</span>  <span class="n">cascade</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">cascade</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1085"></a><span class="lineno">1085</span>  <span class="n">cascade</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">.</span><span class="n">vtbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cascade_vtbl</span><span class="p">;</span>
<a name="c1-1086"></a><span class="lineno">1086</span>  <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">cascade</span><span class="p">;</span>
<a name="c1-1087"></a><span class="lineno">1087</span> <span class="p">}</span>
<a name="c1-1088"></a><span class="lineno">1088</span> 
<a name="c1-1089"></a><span class="lineno">1089</span> <span class="cm">/*</span>
<a name="c1-1090"></a><span class="lineno">1090</span> <span class="cm"> * ident filter</span>
<a name="c1-1091"></a><span class="lineno">1091</span> <span class="cm"> */</span>
<a name="c1-1092"></a><span class="lineno">1092</span> <span class="cp">#define IDENT_DRAINING (-1)</span>
<a name="c1-1093"></a><span class="lineno">1093</span> <span class="cp">#define IDENT_SKIPPING (-2)</span>
<a name="c1-1094"></a><span class="lineno">1094</span> <span class="k">struct</span> <span class="n">ident_filter</span> <span class="p">{</span>
<a name="c1-1095"></a><span class="lineno">1095</span>  <span class="k">struct</span> <span class="n">stream_filter</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-1096"></a><span class="lineno">1096</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">left</span><span class="p">;</span>
<a name="c1-1097"></a><span class="lineno">1097</span>  <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
<a name="c1-1098"></a><span class="lineno">1098</span>  <span class="kt">char</span> <span class="n">ident</span><span class="p">[</span><span class="mi">45</span><span class="p">];</span> <span class="cm">/* ": x40 $" */</span>
<a name="c1-1099"></a><span class="lineno">1099</span> <span class="p">};</span>
<a name="c1-1100"></a><span class="lineno">1100</span> 
<a name="c1-1101"></a><span class="lineno">1101</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">is_foreign_ident</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<a name="c1-1102"></a><span class="lineno">1102</span> <span class="p">{</span>
<a name="c1-1103"></a><span class="lineno">1103</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-1104"></a><span class="lineno">1104</span> 
<a name="c1-1105"></a><span class="lineno">1105</span>  <span class="k">if</span> <span class="p">(</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">"$Id: "</span><span class="p">))</span>
<a name="c1-1106"></a><span class="lineno">1106</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1107"></a><span class="lineno">1107</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1108"></a><span class="lineno">1108</span>    <span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'$'</span><span class="p">)</span>
<a name="c1-1109"></a><span class="lineno">1109</span>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-1110"></a><span class="lineno">1110</span>  <span class="p">}</span>
<a name="c1-1111"></a><span class="lineno">1111</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1112"></a><span class="lineno">1112</span> <span class="p">}</span>
<a name="c1-1113"></a><span class="lineno">1113</span> 
<a name="c1-1114"></a><span class="lineno">1114</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">ident_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ident_filter</span> <span class="o">*</span><span class="n">ident</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">output_p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-1115"></a><span class="lineno">1115</span> <span class="p">{</span>
<a name="c1-1116"></a><span class="lineno">1116</span>  <span class="kt">size_t</span> <span class="n">to_drain</span> <span class="o">=</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c1-1117"></a><span class="lineno">1117</span> 
<a name="c1-1118"></a><span class="lineno">1118</span>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">osize_p</span> <span class="o">&lt;</span> <span class="n">to_drain</span><span class="p">)</span>
<a name="c1-1119"></a><span class="lineno">1119</span>    <span class="n">to_drain</span> <span class="o">=</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">;</span>
<a name="c1-1120"></a><span class="lineno">1120</span>  <span class="k">if</span> <span class="p">(</span><span class="n">to_drain</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1121"></a><span class="lineno">1121</span>    <span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">output_p</span><span class="p">,</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">to_drain</span><span class="p">);</span>
<a name="c1-1122"></a><span class="lineno">1122</span>    <span class="n">strbuf_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to_drain</span><span class="p">);</span>
<a name="c1-1123"></a><span class="lineno">1123</span>    <span class="o">*</span><span class="n">output_p</span> <span class="o">+=</span> <span class="n">to_drain</span><span class="p">;</span>
<a name="c1-1124"></a><span class="lineno">1124</span>    <span class="o">*</span><span class="n">osize_p</span> <span class="o">-=</span> <span class="n">to_drain</span><span class="p">;</span>
<a name="c1-1125"></a><span class="lineno">1125</span>  <span class="p">}</span>
<a name="c1-1126"></a><span class="lineno">1126</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
<a name="c1-1127"></a><span class="lineno">1127</span>    <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1128"></a><span class="lineno">1128</span> <span class="p">}</span>
<a name="c1-1129"></a><span class="lineno">1129</span> 
<a name="c1-1130"></a><span class="lineno">1130</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ident_filter_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
<a name="c1-1131"></a><span class="lineno">1131</span>         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">,</span>
<a name="c1-1132"></a><span class="lineno">1132</span>         <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-1133"></a><span class="lineno">1133</span> <span class="p">{</span>
<a name="c1-1134"></a><span class="lineno">1134</span>  <span class="k">struct</span> <span class="n">ident_filter</span> <span class="o">*</span><span class="n">ident</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ident_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">filter</span><span class="p">;</span>
<a name="c1-1135"></a><span class="lineno">1135</span>  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">head</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"$Id"</span><span class="p">;</span>
<a name="c1-1136"></a><span class="lineno">1136</span> 
<a name="c1-1137"></a><span class="lineno">1137</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1138"></a><span class="lineno">1138</span>    <span class="cm">/* drain upon eof */</span>
<a name="c1-1139"></a><span class="lineno">1139</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1140"></a><span class="lineno">1140</span>    <span class="nl">default:</span>
<a name="c1-1141"></a><span class="lineno">1141</span>      <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<a name="c1-1142"></a><span class="lineno">1142</span>    <span class="k">case</span> <span class="n">IDENT_SKIPPING</span>:
<a name="c1-1143"></a><span class="lineno">1143</span>      <span class="cm">/* fallthru */</span>
<a name="c1-1144"></a><span class="lineno">1144</span>    <span class="k">case</span> <span class="n">IDENT_DRAINING</span>:
<a name="c1-1145"></a><span class="lineno">1145</span>      <span class="n">ident_drain</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">,</span> <span class="n">osize_p</span><span class="p">);</span>
<a name="c1-1146"></a><span class="lineno">1146</span>    <span class="p">}</span>
<a name="c1-1147"></a><span class="lineno">1147</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1148"></a><span class="lineno">1148</span>  <span class="p">}</span>
<a name="c1-1149"></a><span class="lineno">1149</span> 
<a name="c1-1150"></a><span class="lineno">1150</span>  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">isize_p</span> <span class="o">||</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IDENT_DRAINING</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1151"></a><span class="lineno">1151</span>    <span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
<a name="c1-1152"></a><span class="lineno">1152</span> 
<a name="c1-1153"></a><span class="lineno">1153</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IDENT_DRAINING</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1154"></a><span class="lineno">1154</span>      <span class="n">ident_drain</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">,</span> <span class="n">osize_p</span><span class="p">);</span>
<a name="c1-1155"></a><span class="lineno">1155</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-1156"></a><span class="lineno">1156</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-1157"></a><span class="lineno">1157</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1158"></a><span class="lineno">1158</span>    <span class="p">}</span>
<a name="c1-1159"></a><span class="lineno">1159</span> 
<a name="c1-1160"></a><span class="lineno">1160</span>    <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">input</span><span class="o">++</span><span class="p">);</span>
<a name="c1-1161"></a><span class="lineno">1161</span>    <span class="p">(</span><span class="o">*</span><span class="n">isize_p</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
<a name="c1-1162"></a><span class="lineno">1162</span> 
<a name="c1-1163"></a><span class="lineno">1163</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IDENT_SKIPPING</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1164"></a><span class="lineno">1164</span>      <span class="cm">/*</span>
<a name="c1-1165"></a><span class="lineno">1165</span> <span class="cm">       * Skipping until '$' or LF, but keeping them</span>
<a name="c1-1166"></a><span class="lineno">1166</span> <span class="cm">       * in case it is a foreign ident.</span>
<a name="c1-1167"></a><span class="lineno">1167</span> <span class="cm">       */</span>
<a name="c1-1168"></a><span class="lineno">1168</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<a name="c1-1169"></a><span class="lineno">1169</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">'\n'</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="sc">'$'</span><span class="p">)</span>
<a name="c1-1170"></a><span class="lineno">1170</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-1171"></a><span class="lineno">1171</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'$'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_foreign_ident</span><span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">.</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-1172"></a><span class="lineno">1172</span>        <span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-1173"></a><span class="lineno">1173</span>        <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
<a name="c1-1174"></a><span class="lineno">1174</span>      <span class="p">}</span>
<a name="c1-1175"></a><span class="lineno">1175</span>      <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDENT_DRAINING</span><span class="p">;</span>
<a name="c1-1176"></a><span class="lineno">1176</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1177"></a><span class="lineno">1177</span>    <span class="p">}</span>
<a name="c1-1178"></a><span class="lineno">1178</span> 
<a name="c1-1179"></a><span class="lineno">1179</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c1-1180"></a><span class="lineno">1180</span>        <span class="n">head</span><span class="p">[</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">]</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1181"></a><span class="lineno">1181</span>      <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">++</span><span class="p">;</span>
<a name="c1-1182"></a><span class="lineno">1182</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1183"></a><span class="lineno">1183</span>    <span class="p">}</span>
<a name="c1-1184"></a><span class="lineno">1184</span> 
<a name="c1-1185"></a><span class="lineno">1185</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
<a name="c1-1186"></a><span class="lineno">1186</span>      <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<a name="c1-1187"></a><span class="lineno">1187</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1188"></a><span class="lineno">1188</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">':'</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="sc">'$'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1189"></a><span class="lineno">1189</span>        <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<a name="c1-1190"></a><span class="lineno">1190</span>        <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1191"></a><span class="lineno">1191</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c1-1192"></a><span class="lineno">1192</span>      <span class="p">}</span>
<a name="c1-1193"></a><span class="lineno">1193</span> 
<a name="c1-1194"></a><span class="lineno">1194</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">':'</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-1195"></a><span class="lineno">1195</span>        <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<a name="c1-1196"></a><span class="lineno">1196</span>        <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDENT_SKIPPING</span><span class="p">;</span>
<a name="c1-1197"></a><span class="lineno">1197</span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-1198"></a><span class="lineno">1198</span>        <span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
<a name="c1-1199"></a><span class="lineno">1199</span>        <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDENT_DRAINING</span><span class="p">;</span>
<a name="c1-1200"></a><span class="lineno">1200</span>      <span class="p">}</span>
<a name="c1-1201"></a><span class="lineno">1201</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-1202"></a><span class="lineno">1202</span>    <span class="p">}</span>
<a name="c1-1203"></a><span class="lineno">1203</span> 
<a name="c1-1204"></a><span class="lineno">1204</span>    <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<a name="c1-1205"></a><span class="lineno">1205</span>    <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDENT_DRAINING</span><span class="p">;</span>
<a name="c1-1206"></a><span class="lineno">1206</span>  <span class="p">}</span>
<a name="c1-1207"></a><span class="lineno">1207</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1208"></a><span class="lineno">1208</span> <span class="p">}</span>
<a name="c1-1209"></a><span class="lineno">1209</span> 
<a name="c1-1210"></a><span class="lineno">1210</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">ident_free_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<a name="c1-1211"></a><span class="lineno">1211</span> <span class="p">{</span>
<a name="c1-1212"></a><span class="lineno">1212</span>  <span class="k">struct</span> <span class="n">ident_filter</span> <span class="o">*</span><span class="n">ident</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ident_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">filter</span><span class="p">;</span>
<a name="c1-1213"></a><span class="lineno">1213</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
<a name="c1-1214"></a><span class="lineno">1214</span>  <span class="n">free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
<a name="c1-1215"></a><span class="lineno">1215</span> <span class="p">}</span>
<a name="c1-1216"></a><span class="lineno">1216</span> 
<a name="c1-1217"></a><span class="lineno">1217</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter_vtbl</span> <span class="n">ident_vtbl</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-1218"></a><span class="lineno">1218</span>  <span class="n">ident_filter_fn</span><span class="p">,</span>
<a name="c1-1219"></a><span class="lineno">1219</span>  <span class="n">ident_free_fn</span><span class="p">,</span>
<a name="c1-1220"></a><span class="lineno">1220</span> <span class="p">};</span>
<a name="c1-1221"></a><span class="lineno">1221</span> 
<a name="c1-1222"></a><span class="lineno">1222</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="nf">ident_filter</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c1-1223"></a><span class="lineno">1223</span> <span class="p">{</span>
<a name="c1-1224"></a><span class="lineno">1224</span>  <span class="k">struct</span> <span class="n">ident_filter</span> <span class="o">*</span><span class="n">ident</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ident</span><span class="p">));</span>
<a name="c1-1225"></a><span class="lineno">1225</span> 
<a name="c1-1226"></a><span class="lineno">1226</span>  <span class="n">sprintf</span><span class="p">(</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="s">": %s $"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">));</span>
<a name="c1-1227"></a><span class="lineno">1227</span>  <span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ident</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-1228"></a><span class="lineno">1228</span>  <span class="n">ident</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">.</span><span class="n">vtbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ident_vtbl</span><span class="p">;</span>
<a name="c1-1229"></a><span class="lineno">1229</span>  <span class="n">ident</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-1230"></a><span class="lineno">1230</span>  <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="p">)</span><span class="n">ident</span><span class="p">;</span>
<a name="c1-1231"></a><span class="lineno">1231</span> <span class="p">}</span>
<a name="c1-1232"></a><span class="lineno">1232</span> 
<a name="c1-1233"></a><span class="lineno">1233</span> <span class="cm">/*</span>
<a name="c1-1234"></a><span class="lineno">1234</span> <span class="cm"> * Return an appropriately constructed filter for the path, or NULL if</span>
<a name="c1-1235"></a><span class="lineno">1235</span> <span class="cm"> * the contents cannot be filtered without reading the whole thing</span>
<a name="c1-1236"></a><span class="lineno">1236</span> <span class="cm"> * in-core.</span>
<a name="c1-1237"></a><span class="lineno">1237</span> <span class="cm"> *</span>
<a name="c1-1238"></a><span class="lineno">1238</span> <span class="cm"> * Note that you would be crazy to set CRLF, smuge/clean or ident to a</span>
<a name="c1-1239"></a><span class="lineno">1239</span> <span class="cm"> * large binary blob you would want us not to slurp into the memory!</span>
<a name="c1-1240"></a><span class="lineno">1240</span> <span class="cm"> */</span>
<a name="c1-1241"></a><span class="lineno">1241</span> <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="nf">get_stream_filter</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c1-1242"></a><span class="lineno">1242</span> <span class="p">{</span>
<a name="c1-1243"></a><span class="lineno">1243</span>  <span class="k">struct</span> <span class="n">conv_attrs</span> <span class="n">ca</span><span class="p">;</span>
<a name="c1-1244"></a><span class="lineno">1244</span>  <span class="k">enum</span> <span class="n">crlf_action</span> <span class="n">crlf_action</span><span class="p">;</span>
<a name="c1-1245"></a><span class="lineno">1245</span>  <span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-1246"></a><span class="lineno">1246</span> 
<a name="c1-1247"></a><span class="lineno">1247</span>  <span class="n">convert_attrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c1-1248"></a><span class="lineno">1248</span> 
<a name="c1-1249"></a><span class="lineno">1249</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">smudge</span> <span class="o">||</span> <span class="n">ca</span><span class="p">.</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">clean</span><span class="p">))</span>
<a name="c1-1250"></a><span class="lineno">1250</span>    <span class="k">return</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-1251"></a><span class="lineno">1251</span> 
<a name="c1-1252"></a><span class="lineno">1252</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">ident</span><span class="p">)</span>
<a name="c1-1253"></a><span class="lineno">1253</span>    <span class="n">filter</span> <span class="o">=</span> <span class="n">ident_filter</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-1254"></a><span class="lineno">1254</span> 
<a name="c1-1255"></a><span class="lineno">1255</span>  <span class="n">crlf_action</span> <span class="o">=</span> <span class="n">input_crlf_action</span><span class="p">(</span><span class="n">ca</span><span class="p">.</span><span class="n">crlf_action</span><span class="p">,</span> <span class="n">ca</span><span class="p">.</span><span class="n">eol_attr</span><span class="p">);</span>
<a name="c1-1256"></a><span class="lineno">1256</span> 
<a name="c1-1257"></a><span class="lineno">1257</span>  <span class="k">if</span> <span class="p">((</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_BINARY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_INPUT</span><span class="p">)</span> <span class="o">||</span>
<a name="c1-1258"></a><span class="lineno">1258</span>      <span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span> <span class="o">&amp;&amp;</span> <span class="n">auto_crlf</span> <span class="o">==</span> <span class="n">AUTO_CRLF_FALSE</span><span class="p">))</span>
<a name="c1-1259"></a><span class="lineno">1259</span>    <span class="n">filter</span> <span class="o">=</span> <span class="n">cascade_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">null_filter_singleton</span><span class="p">);</span>
<a name="c1-1260"></a><span class="lineno">1260</span> 
<a name="c1-1261"></a><span class="lineno">1261</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">output_eol</span><span class="p">(</span><span class="n">crlf_action</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOL_CRLF</span> <span class="o">&amp;&amp;</span>
<a name="c1-1262"></a><span class="lineno">1262</span>     <span class="o">!</span><span class="p">(</span><span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_AUTO</span> <span class="o">||</span> <span class="n">crlf_action</span> <span class="o">==</span> <span class="n">CRLF_GUESS</span><span class="p">))</span>
<a name="c1-1263"></a><span class="lineno">1263</span>    <span class="n">filter</span> <span class="o">=</span> <span class="n">cascade_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">lf_to_crlf_filter</span><span class="p">());</span>
<a name="c1-1264"></a><span class="lineno">1264</span> 
<a name="c1-1265"></a><span class="lineno">1265</span>  <span class="k">return</span> <span class="n">filter</span><span class="p">;</span>
<a name="c1-1266"></a><span class="lineno">1266</span> <span class="p">}</span>
<a name="c1-1267"></a><span class="lineno">1267</span> 
<a name="c1-1268"></a><span class="lineno">1268</span> <span class="kt">void</span> <span class="nf">free_stream_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<a name="c1-1269"></a><span class="lineno">1269</span> <span class="p">{</span>
<a name="c1-1270"></a><span class="lineno">1270</span>  <span class="n">filter</span><span class="o">-&gt;</span><span class="n">vtbl</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
<a name="c1-1271"></a><span class="lineno">1271</span> <span class="p">}</span>
<a name="c1-1272"></a><span class="lineno">1272</span> 
<a name="c1-1273"></a><span class="lineno">1273</span> <span class="kt">int</span> <span class="nf">stream_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">stream_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
<a name="c1-1274"></a><span class="lineno">1274</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">isize_p</span><span class="p">,</span>
<a name="c1-1275"></a><span class="lineno">1275</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">osize_p</span><span class="p">)</span>
<a name="c1-1276"></a><span class="lineno">1276</span> <span class="p">{</span>
<a name="c1-1277"></a><span class="lineno">1277</span>  <span class="k">return</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">vtbl</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">isize_p</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">osize_p</span><span class="p">);</span>
<a name="c1-1278"></a><span class="lineno">1278</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>    
</body></html>