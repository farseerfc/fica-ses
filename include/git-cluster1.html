<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac0006ac -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <script type="text/javascript" src="./git-cluster1_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./git-cluster1_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./git-cluster1_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./git-cluster1_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./git-cluster1_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./git-cluster1_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./git-cluster1_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./git-cluster1_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./git-cluster1_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./git-cluster1_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./git-cluster1_files/chosen.jquery.js"></script>


        <script src="./git-cluster1_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./git-cluster1_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./git-cluster1_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac0006ac");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./git-cluster1_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./git-cluster1_files/bootstrap.css" rel="stylesheet">

        <link href="./git-cluster1_files/force.css" rel="stylesheet" type="text/css">
        <link href="./git-cluster1_files/chosen.css" rel="stylesheet" type="text/css">
      
        
<link rel="stylesheet" href="../pygments.css">
<title>Fica -- survey git-v1.7.9-rc1 12-01-25 02:26:57</title>

<script language="javascript">

    var reheight = function(){

        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-3860']")[0].scrollIntoView();
        $("a[name='c1-399']")[0].scrollIntoView();
        reheight();
        
        $("#clonesets").accordion({event:"click", autoHeight: false});
        $("#clonesets").accordion("activate","#cs-4f1f687db61c5411ac0006ac");
        
        $("#cs-4f1f687db61c5411ac0006ac").scrollintoview();
        

        
        $(".scrollbox").each(function(){
            var scrollbox = $(this);
            scrollbox.scroll(function(){
                var percent = $(this).scrollTop() /
                    (this.scrollHeight-$(this).height()) ;
                $(this).prev().css("opacity", percent * 5 );
                $(this).next().css("opacity", (1 - percent ) * 5 );
            });
        });
        
    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

<body>
<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> builtin/apply.c 
                <small> (3860,21)-(3869,15)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">   1</span> <span class="cm">/*</span>
<a name="c0-2"></a><span class="lineno">   2</span> <span class="cm"> * apply.c</span>
<a name="c0-3"></a><span class="lineno">   3</span> <span class="cm"> *</span>
<a name="c0-4"></a><span class="lineno">   4</span> <span class="cm"> * Copyright (C) Linus Torvalds, 2005</span>
<a name="c0-5"></a><span class="lineno">   5</span> <span class="cm"> *</span>
<a name="c0-6"></a><span class="lineno">   6</span> <span class="cm"> * This applies patches on top of some (arbitrary) version of the SCM.</span>
<a name="c0-7"></a><span class="lineno">   7</span> <span class="cm"> *</span>
<a name="c0-8"></a><span class="lineno">   8</span> <span class="cm"> */</span>
<a name="c0-9"></a><span class="lineno">   9</span> <span class="cp">#include "cache.h"</span>
<a name="c0-10"></a><span class="lineno">  10</span> <span class="cp">#include "cache-tree.h"</span>
<a name="c0-11"></a><span class="lineno">  11</span> <span class="cp">#include "quote.h"</span>
<a name="c0-12"></a><span class="lineno">  12</span> <span class="cp">#include "blob.h"</span>
<a name="c0-13"></a><span class="lineno">  13</span> <span class="cp">#include "delta.h"</span>
<a name="c0-14"></a><span class="lineno">  14</span> <span class="cp">#include "builtin.h"</span>
<a name="c0-15"></a><span class="lineno">  15</span> <span class="cp">#include "string-list.h"</span>
<a name="c0-16"></a><span class="lineno">  16</span> <span class="cp">#include "dir.h"</span>
<a name="c0-17"></a><span class="lineno">  17</span> <span class="cp">#include "parse-options.h"</span>
<a name="c0-18"></a><span class="lineno">  18</span> 
<a name="c0-19"></a><span class="lineno">  19</span> <span class="cm">/*</span>
<a name="c0-20"></a><span class="lineno">  20</span> <span class="cm"> *  --check turns on checking that the working tree matches the</span>
<a name="c0-21"></a><span class="lineno">  21</span> <span class="cm"> *    files that are being modified, but doesn't apply the patch</span>
<a name="c0-22"></a><span class="lineno">  22</span> <span class="cm"> *  --stat does just a diffstat, and doesn't actually apply</span>
<a name="c0-23"></a><span class="lineno">  23</span> <span class="cm"> *  --numstat does numeric diffstat, and doesn't actually apply</span>
<a name="c0-24"></a><span class="lineno">  24</span> <span class="cm"> *  --index-info shows the old and new index info for paths if available.</span>
<a name="c0-25"></a><span class="lineno">  25</span> <span class="cm"> *  --index updates the cache as well.</span>
<a name="c0-26"></a><span class="lineno">  26</span> <span class="cm"> *  --cached updates only the cache without ever touching the working tree.</span>
<a name="c0-27"></a><span class="lineno">  27</span> <span class="cm"> */</span>
<a name="c0-28"></a><span class="lineno">  28</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>
<a name="c0-29"></a><span class="lineno">  29</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">prefix_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-30"></a><span class="lineno">  30</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">newfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-31"></a><span class="lineno">  31</span> 
<a name="c0-32"></a><span class="lineno">  32</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">unidiff_zero</span><span class="p">;</span>
<a name="c0-33"></a><span class="lineno">  33</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">p_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-34"></a><span class="lineno">  34</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">p_value_known</span><span class="p">;</span>
<a name="c0-35"></a><span class="lineno">  35</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">check_index</span><span class="p">;</span>
<a name="c0-36"></a><span class="lineno">  36</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">update_index</span><span class="p">;</span>
<a name="c0-37"></a><span class="lineno">  37</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">cached</span><span class="p">;</span>
<a name="c0-38"></a><span class="lineno">  38</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">diffstat</span><span class="p">;</span>
<a name="c0-39"></a><span class="lineno">  39</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">numstat</span><span class="p">;</span>
<a name="c0-40"></a><span class="lineno">  40</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">summary</span><span class="p">;</span>
<a name="c0-41"></a><span class="lineno">  41</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">check</span><span class="p">;</span>
<a name="c0-42"></a><span class="lineno">  42</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">apply</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-43"></a><span class="lineno">  43</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">apply_in_reverse</span><span class="p">;</span>
<a name="c0-44"></a><span class="lineno">  44</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">apply_with_reject</span><span class="p">;</span>
<a name="c0-45"></a><span class="lineno">  45</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">apply_verbosely</span><span class="p">;</span>
<a name="c0-46"></a><span class="lineno">  46</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">allow_overlap</span><span class="p">;</span>
<a name="c0-47"></a><span class="lineno">  47</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">no_add</span><span class="p">;</span>
<a name="c0-48"></a><span class="lineno">  48</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fake_ancestor</span><span class="p">;</span>
<a name="c0-49"></a><span class="lineno">  49</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">line_termination</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c0-50"></a><span class="lineno">  50</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p_context</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
<a name="c0-51"></a><span class="lineno">  51</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">apply_usage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c0-52"></a><span class="lineno">  52</span>  <span class="s">"git apply [options] [&lt;patch&gt;...]"</span><span class="p">,</span>
<a name="c0-53"></a><span class="lineno">  53</span>  <span class="nb">NULL</span>
<a name="c0-54"></a><span class="lineno">  54</span> <span class="p">};</span>
<a name="c0-55"></a><span class="lineno">  55</span> 
<a name="c0-56"></a><span class="lineno">  56</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">ws_error_action</span> <span class="p">{</span>
<a name="c0-57"></a><span class="lineno">  57</span>  <span class="n">nowarn_ws_error</span><span class="p">,</span>
<a name="c0-58"></a><span class="lineno">  58</span>  <span class="n">warn_on_ws_error</span><span class="p">,</span>
<a name="c0-59"></a><span class="lineno">  59</span>  <span class="n">die_on_ws_error</span><span class="p">,</span>
<a name="c0-60"></a><span class="lineno">  60</span>  <span class="n">correct_ws_error</span>
<a name="c0-61"></a><span class="lineno">  61</span> <span class="p">}</span> <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">warn_on_ws_error</span><span class="p">;</span>
<a name="c0-62"></a><span class="lineno">  62</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">whitespace_error</span><span class="p">;</span>
<a name="c0-63"></a><span class="lineno">  63</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">squelch_whitespace_errors</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<a name="c0-64"></a><span class="lineno">  64</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">applied_after_fixing_ws</span><span class="p">;</span>
<a name="c0-65"></a><span class="lineno">  65</span> 
<a name="c0-66"></a><span class="lineno">  66</span> <span class="k">static</span> <span class="k">enum</span> <span class="n">ws_ignore</span> <span class="p">{</span>
<a name="c0-67"></a><span class="lineno">  67</span>  <span class="n">ignore_ws_none</span><span class="p">,</span>
<a name="c0-68"></a><span class="lineno">  68</span>  <span class="n">ignore_ws_change</span>
<a name="c0-69"></a><span class="lineno">  69</span> <span class="p">}</span> <span class="n">ws_ignore_action</span> <span class="o">=</span> <span class="n">ignore_ws_none</span><span class="p">;</span>
<a name="c0-70"></a><span class="lineno">  70</span> 
<a name="c0-71"></a><span class="lineno">  71</span> 
<a name="c0-72"></a><span class="lineno">  72</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">patch_input_file</span><span class="p">;</span>
<a name="c0-73"></a><span class="lineno">  73</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
<a name="c0-74"></a><span class="lineno">  74</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">root_len</span><span class="p">;</span>
<a name="c0-75"></a><span class="lineno">  75</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">read_stdin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-76"></a><span class="lineno">  76</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">;</span>
<a name="c0-77"></a><span class="lineno">  77</span> 
<a name="c0-78"></a><span class="lineno">  78</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_whitespace_option</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">)</span>
<a name="c0-79"></a><span class="lineno">  79</span> <span class="p">{</span>
<a name="c0-80"></a><span class="lineno">  80</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-81"></a><span class="lineno">  81</span>    <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">warn_on_ws_error</span><span class="p">;</span>
<a name="c0-82"></a><span class="lineno">  82</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-83"></a><span class="lineno">  83</span>  <span class="p">}</span>
<a name="c0-84"></a><span class="lineno">  84</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"warn"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-85"></a><span class="lineno">  85</span>    <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">warn_on_ws_error</span><span class="p">;</span>
<a name="c0-86"></a><span class="lineno">  86</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-87"></a><span class="lineno">  87</span>  <span class="p">}</span>
<a name="c0-88"></a><span class="lineno">  88</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"nowarn"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-89"></a><span class="lineno">  89</span>    <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">nowarn_ws_error</span><span class="p">;</span>
<a name="c0-90"></a><span class="lineno">  90</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-91"></a><span class="lineno">  91</span>  <span class="p">}</span>
<a name="c0-92"></a><span class="lineno">  92</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"error"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-93"></a><span class="lineno">  93</span>    <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">die_on_ws_error</span><span class="p">;</span>
<a name="c0-94"></a><span class="lineno">  94</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-95"></a><span class="lineno">  95</span>  <span class="p">}</span>
<a name="c0-96"></a><span class="lineno">  96</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"error-all"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-97"></a><span class="lineno">  97</span>    <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">die_on_ws_error</span><span class="p">;</span>
<a name="c0-98"></a><span class="lineno">  98</span>    <span class="n">squelch_whitespace_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-99"></a><span class="lineno">  99</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-100"></a><span class="lineno"> 100</span>   <span class="p">}</span>
<a name="c0-101"></a><span class="lineno"> 101</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"strip"</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"fix"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-102"></a><span class="lineno"> 102</span>     <span class="n">ws_error_action</span> <span class="o">=</span> <span class="n">correct_ws_error</span><span class="p">;</span>
<a name="c0-103"></a><span class="lineno"> 103</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-104"></a><span class="lineno"> 104</span>   <span class="p">}</span>
<a name="c0-105"></a><span class="lineno"> 105</span>   <span class="n">die</span><span class="p">(</span><span class="s">"unrecognized whitespace option '%s'"</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
<a name="c0-106"></a><span class="lineno"> 106</span> <span class="p">}</span>
<a name="c0-107"></a><span class="lineno"> 107</span> 
<a name="c0-108"></a><span class="lineno"> 108</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_ignorewhitespace_option</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">option</span><span class="p">)</span>
<a name="c0-109"></a><span class="lineno"> 109</span> <span class="p">{</span>
<a name="c0-110"></a><span class="lineno"> 110</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">option</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"no"</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-111"></a><span class="lineno"> 111</span>       <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"false"</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"never"</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-112"></a><span class="lineno"> 112</span>       <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"none"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-113"></a><span class="lineno"> 113</span>     <span class="n">ws_ignore_action</span> <span class="o">=</span> <span class="n">ignore_ws_none</span><span class="p">;</span>
<a name="c0-114"></a><span class="lineno"> 114</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-115"></a><span class="lineno"> 115</span>   <span class="p">}</span>
<a name="c0-116"></a><span class="lineno"> 116</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">"change"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-117"></a><span class="lineno"> 117</span>     <span class="n">ws_ignore_action</span> <span class="o">=</span> <span class="n">ignore_ws_change</span><span class="p">;</span>
<a name="c0-118"></a><span class="lineno"> 118</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-119"></a><span class="lineno"> 119</span>   <span class="p">}</span>
<a name="c0-120"></a><span class="lineno"> 120</span>   <span class="n">die</span><span class="p">(</span><span class="s">"unrecognized whitespace ignore option '%s'"</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
<a name="c0-121"></a><span class="lineno"> 121</span> <span class="p">}</span>
<a name="c0-122"></a><span class="lineno"> 122</span> 
<a name="c0-123"></a><span class="lineno"> 123</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">set_default_whitespace_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">whitespace_option</span><span class="p">)</span>
<a name="c0-124"></a><span class="lineno"> 124</span> <span class="p">{</span>
<a name="c0-125"></a><span class="lineno"> 125</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">whitespace_option</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">apply_default_whitespace</span><span class="p">)</span>
<a name="c0-126"></a><span class="lineno"> 126</span>     <span class="n">ws_error_action</span> <span class="o">=</span> <span class="p">(</span><span class="n">apply</span> <span class="o">?</span> <span class="n">warn_on_ws_error</span> <span class="o">:</span> <span class="n">nowarn_ws_error</span><span class="p">);</span>
<a name="c0-127"></a><span class="lineno"> 127</span> <span class="p">}</span>
<a name="c0-128"></a><span class="lineno"> 128</span> 
<a name="c0-129"></a><span class="lineno"> 129</span> <span class="cm">/*</span>
<a name="c0-130"></a><span class="lineno"> 130</span> <span class="cm"> * For "diff-stat" like behaviour, we keep track of the biggest change</span>
<a name="c0-131"></a><span class="lineno"> 131</span> <span class="cm"> * we've seen, and the longest filename. That allows us to do simple</span>
<a name="c0-132"></a><span class="lineno"> 132</span> <span class="cm"> * scaling.</span>
<a name="c0-133"></a><span class="lineno"> 133</span> <span class="cm"> */</span>
<a name="c0-134"></a><span class="lineno"> 134</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">max_change</span><span class="p">,</span> <span class="n">max_len</span><span class="p">;</span>
<a name="c0-135"></a><span class="lineno"> 135</span> 
<a name="c0-136"></a><span class="lineno"> 136</span> <span class="cm">/*</span>
<a name="c0-137"></a><span class="lineno"> 137</span> <span class="cm"> * Various "current state", notably line numbers and what</span>
<a name="c0-138"></a><span class="lineno"> 138</span> <span class="cm"> * file (and how) we're patching right now.. The "is_xxxx"</span>
<a name="c0-139"></a><span class="lineno"> 139</span> <span class="cm"> * things are flags, where -1 means "don't know yet".</span>
<a name="c0-140"></a><span class="lineno"> 140</span> <span class="cm"> */</span>
<a name="c0-141"></a><span class="lineno"> 141</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">linenr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-142"></a><span class="lineno"> 142</span> 
<a name="c0-143"></a><span class="lineno"> 143</span> <span class="cm">/*</span>
<a name="c0-144"></a><span class="lineno"> 144</span> <span class="cm"> * This represents one "hunk" from a patch, starting with</span>
<a name="c0-145"></a><span class="lineno"> 145</span> <span class="cm"> * "@@ -oldpos,oldlines +newpos,newlines @@" marker.  The</span>
<a name="c0-146"></a><span class="lineno"> 146</span> <span class="cm"> * patch text is pointed at by patch, and its byte length</span>
<a name="c0-147"></a><span class="lineno"> 147</span> <span class="cm"> * is stored in size.  leading and trailing are the number</span>
<a name="c0-148"></a><span class="lineno"> 148</span> <span class="cm"> * of context lines.</span>
<a name="c0-149"></a><span class="lineno"> 149</span> <span class="cm"> */</span>
<a name="c0-150"></a><span class="lineno"> 150</span> <span class="k">struct</span> <span class="n">fragment</span> <span class="p">{</span>
<a name="c0-151"></a><span class="lineno"> 151</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">leading</span><span class="p">,</span> <span class="n">trailing</span><span class="p">;</span>
<a name="c0-152"></a><span class="lineno"> 152</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldpos</span><span class="p">,</span> <span class="n">oldlines</span><span class="p">;</span>
<a name="c0-153"></a><span class="lineno"> 153</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newpos</span><span class="p">,</span> <span class="n">newlines</span><span class="p">;</span>
<a name="c0-154"></a><span class="lineno"> 154</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">patch</span><span class="p">;</span>
<a name="c0-155"></a><span class="lineno"> 155</span>   <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-156"></a><span class="lineno"> 156</span>   <span class="kt">int</span> <span class="n">rejected</span><span class="p">;</span>
<a name="c0-157"></a><span class="lineno"> 157</span>   <span class="kt">int</span> <span class="n">linenr</span><span class="p">;</span>
<a name="c0-158"></a><span class="lineno"> 158</span>   <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-159"></a><span class="lineno"> 159</span> <span class="p">};</span>
<a name="c0-160"></a><span class="lineno"> 160</span> 
<a name="c0-161"></a><span class="lineno"> 161</span> <span class="cm">/*</span>
<a name="c0-162"></a><span class="lineno"> 162</span> <span class="cm"> * When dealing with a binary patch, we reuse "leading" field</span>
<a name="c0-163"></a><span class="lineno"> 163</span> <span class="cm"> * to store the type of the binary hunk, either deflated "delta"</span>
<a name="c0-164"></a><span class="lineno"> 164</span> <span class="cm"> * or deflated "literal".</span>
<a name="c0-165"></a><span class="lineno"> 165</span> <span class="cm"> */</span>
<a name="c0-166"></a><span class="lineno"> 166</span> <span class="cp">#define binary_patch_method leading</span>
<a name="c0-167"></a><span class="lineno"> 167</span> <span class="cp">#define BINARY_DELTA_DEFLATED  1</span>
<a name="c0-168"></a><span class="lineno"> 168</span> <span class="cp">#define BINARY_LITERAL_DEFLATED 2</span>
<a name="c0-169"></a><span class="lineno"> 169</span> 
<a name="c0-170"></a><span class="lineno"> 170</span> <span class="cm">/*</span>
<a name="c0-171"></a><span class="lineno"> 171</span> <span class="cm"> * This represents a "patch" to a file, both metainfo changes</span>
<a name="c0-172"></a><span class="lineno"> 172</span> <span class="cm"> * such as creation/deletion, filemode and content changes represented</span>
<a name="c0-173"></a><span class="lineno"> 173</span> <span class="cm"> * as a series of fragments.</span>
<a name="c0-174"></a><span class="lineno"> 174</span> <span class="cm"> */</span>
<a name="c0-175"></a><span class="lineno"> 175</span> <span class="k">struct</span> <span class="n">patch</span> <span class="p">{</span>
<a name="c0-176"></a><span class="lineno"> 176</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">,</span> <span class="o">*</span><span class="n">old_name</span><span class="p">,</span> <span class="o">*</span><span class="n">def_name</span><span class="p">;</span>
<a name="c0-177"></a><span class="lineno"> 177</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_mode</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">;</span>
<a name="c0-178"></a><span class="lineno"> 178</span>   <span class="kt">int</span> <span class="n">is_new</span><span class="p">,</span> <span class="n">is_delete</span><span class="p">;</span>  <span class="cm">/* -1 = unknown, 0 = false, 1 = true */</span>
<a name="c0-179"></a><span class="lineno"> 179</span>   <span class="kt">int</span> <span class="n">rejected</span><span class="p">;</span>
<a name="c0-180"></a><span class="lineno"> 180</span>   <span class="kt">unsigned</span> <span class="n">ws_rule</span><span class="p">;</span>
<a name="c0-181"></a><span class="lineno"> 181</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deflate_origlen</span><span class="p">;</span>
<a name="c0-182"></a><span class="lineno"> 182</span>   <span class="kt">int</span> <span class="n">lines_added</span><span class="p">,</span> <span class="n">lines_deleted</span><span class="p">;</span>
<a name="c0-183"></a><span class="lineno"> 183</span>   <span class="kt">int</span> <span class="n">score</span><span class="p">;</span>
<a name="c0-184"></a><span class="lineno"> 184</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_toplevel_relative</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-185"></a><span class="lineno"> 185</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inaccurate_eof</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-186"></a><span class="lineno"> 186</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_binary</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-187"></a><span class="lineno"> 187</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_copy</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-188"></a><span class="lineno"> 188</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_rename</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-189"></a><span class="lineno"> 189</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recount</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-190"></a><span class="lineno"> 190</span>   <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">fragments</span><span class="p">;</span>
<a name="c0-191"></a><span class="lineno"> 191</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="c0-192"></a><span class="lineno"> 192</span>   <span class="kt">size_t</span> <span class="n">resultsize</span><span class="p">;</span>
<a name="c0-193"></a><span class="lineno"> 193</span>   <span class="kt">char</span> <span class="n">old_sha1_prefix</span><span class="p">[</span><span class="mi">41</span><span class="p">];</span>
<a name="c0-194"></a><span class="lineno"> 194</span>   <span class="kt">char</span> <span class="n">new_sha1_prefix</span><span class="p">[</span><span class="mi">41</span><span class="p">];</span>
<a name="c0-195"></a><span class="lineno"> 195</span>   <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-196"></a><span class="lineno"> 196</span> <span class="p">};</span>
<a name="c0-197"></a><span class="lineno"> 197</span> 
<a name="c0-198"></a><span class="lineno"> 198</span> <span class="cm">/*</span>
<a name="c0-199"></a><span class="lineno"> 199</span> <span class="cm"> * A line in a file, len-bytes long (includes the terminating LF,</span>
<a name="c0-200"></a><span class="lineno"> 200</span> <span class="cm"> * except for an incomplete line at the end if the file ends with</span>
<a name="c0-201"></a><span class="lineno"> 201</span> <span class="cm"> * one), and its contents hashes to 'hash'.</span>
<a name="c0-202"></a><span class="lineno"> 202</span> <span class="cm"> */</span>
<a name="c0-203"></a><span class="lineno"> 203</span> <span class="k">struct</span> <span class="n">line</span> <span class="p">{</span>
<a name="c0-204"></a><span class="lineno"> 204</span>   <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-205"></a><span class="lineno"> 205</span>   <span class="kt">unsigned</span> <span class="n">hash</span> <span class="o">:</span> <span class="mi">24</span><span class="p">;</span>
<a name="c0-206"></a><span class="lineno"> 206</span>   <span class="kt">unsigned</span> <span class="n">flag</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
<a name="c0-207"></a><span class="lineno"> 207</span> <span class="cp">#define LINE_COMMON     1</span>
<a name="c0-208"></a><span class="lineno"> 208</span> <span class="cp">#define LINE_PATCHED 2</span>
<a name="c0-209"></a><span class="lineno"> 209</span> <span class="p">};</span>
<a name="c0-210"></a><span class="lineno"> 210</span> 
<a name="c0-211"></a><span class="lineno"> 211</span> <span class="cm">/*</span>
<a name="c0-212"></a><span class="lineno"> 212</span> <span class="cm"> * This represents a "file", which is an array of "lines".</span>
<a name="c0-213"></a><span class="lineno"> 213</span> <span class="cm"> */</span>
<a name="c0-214"></a><span class="lineno"> 214</span> <span class="k">struct</span> <span class="n">image</span> <span class="p">{</span>
<a name="c0-215"></a><span class="lineno"> 215</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-216"></a><span class="lineno"> 216</span>   <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-217"></a><span class="lineno"> 217</span>   <span class="kt">size_t</span> <span class="n">nr</span><span class="p">;</span>
<a name="c0-218"></a><span class="lineno"> 218</span>   <span class="kt">size_t</span> <span class="n">alloc</span><span class="p">;</span>
<a name="c0-219"></a><span class="lineno"> 219</span>   <span class="k">struct</span> <span class="n">line</span> <span class="o">*</span><span class="n">line_allocated</span><span class="p">;</span>
<a name="c0-220"></a><span class="lineno"> 220</span>   <span class="k">struct</span> <span class="n">line</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
<a name="c0-221"></a><span class="lineno"> 221</span> <span class="p">};</span>
<a name="c0-222"></a><span class="lineno"> 222</span> 
<a name="c0-223"></a><span class="lineno"> 223</span> <span class="cm">/*</span>
<a name="c0-224"></a><span class="lineno"> 224</span> <span class="cm"> * Records filenames that have been touched, in order to handle</span>
<a name="c0-225"></a><span class="lineno"> 225</span> <span class="cm"> * the case where more than one patches touch the same file.</span>
<a name="c0-226"></a><span class="lineno"> 226</span> <span class="cm"> */</span>
<a name="c0-227"></a><span class="lineno"> 227</span> 
<a name="c0-228"></a><span class="lineno"> 228</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">string_list</span> <span class="n">fn_table</span><span class="p">;</span>
<a name="c0-229"></a><span class="lineno"> 229</span> 
<a name="c0-230"></a><span class="lineno"> 230</span> <span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">hash_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-231"></a><span class="lineno"> 231</span> <span class="p">{</span>
<a name="c0-232"></a><span class="lineno"> 232</span>   <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-233"></a><span class="lineno"> 233</span>   <span class="kt">uint32_t</span> <span class="n">h</span><span class="p">;</span>
<a name="c0-234"></a><span class="lineno"> 234</span>   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-235"></a><span class="lineno"> 235</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
<a name="c0-236"></a><span class="lineno"> 236</span>       <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<a name="c0-237"></a><span class="lineno"> 237</span>     <span class="p">}</span>
<a name="c0-238"></a><span class="lineno"> 238</span>   <span class="p">}</span>
<a name="c0-239"></a><span class="lineno"> 239</span>   <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<a name="c0-240"></a><span class="lineno"> 240</span> <span class="p">}</span>
<a name="c0-241"></a><span class="lineno"> 241</span> 
<a name="c0-242"></a><span class="lineno"> 242</span> <span class="cm">/*</span>
<a name="c0-243"></a><span class="lineno"> 243</span> <span class="cm"> * Compare lines s1 of length n1 and s2 of length n2, ignoring</span>
<a name="c0-244"></a><span class="lineno"> 244</span> <span class="cm"> * whitespace difference. Returns 1 if they match, 0 otherwise</span>
<a name="c0-245"></a><span class="lineno"> 245</span> <span class="cm"> */</span>
<a name="c0-246"></a><span class="lineno"> 246</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fuzzy_matchlines</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n1</span><span class="p">,</span>
<a name="c0-247"></a><span class="lineno"> 247</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n2</span><span class="p">)</span>
<a name="c0-248"></a><span class="lineno"> 248</span> <span class="p">{</span>
<a name="c0-249"></a><span class="lineno"> 249</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last1</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">n1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-250"></a><span class="lineno"> 250</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last2</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-251"></a><span class="lineno"> 251</span>   <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-252"></a><span class="lineno"> 252</span> 
<a name="c0-253"></a><span class="lineno"> 253</span>   <span class="cm">/* ignore line endings */</span>
<a name="c0-254"></a><span class="lineno"> 254</span>   <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">last1</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">last1</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">))</span>
<a name="c0-255"></a><span class="lineno"> 255</span>     <span class="n">last1</span><span class="o">--</span><span class="p">;</span>
<a name="c0-256"></a><span class="lineno"> 256</span>   <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">last2</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">last2</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">))</span>
<a name="c0-257"></a><span class="lineno"> 257</span>     <span class="n">last2</span><span class="o">--</span><span class="p">;</span>
<a name="c0-258"></a><span class="lineno"> 258</span> 
<a name="c0-259"></a><span class="lineno"> 259</span>   <span class="cm">/* skip leading whitespace */</span>
<a name="c0-260"></a><span class="lineno"> 260</span>   <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&lt;=</span> <span class="n">last1</span><span class="p">))</span>
<a name="c0-261"></a><span class="lineno"> 261</span>     <span class="n">s1</span><span class="o">++</span><span class="p">;</span>
<a name="c0-262"></a><span class="lineno"> 262</span>   <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s2</span> <span class="o">&lt;=</span> <span class="n">last2</span><span class="p">))</span>
<a name="c0-263"></a><span class="lineno"> 263</span>     <span class="n">s2</span><span class="o">++</span><span class="p">;</span>
<a name="c0-264"></a><span class="lineno"> 264</span>   <span class="cm">/* early return if both lines are empty */</span>
<a name="c0-265"></a><span class="lineno"> 265</span>   <span class="k">if</span> <span class="p">((</span><span class="n">s1</span> <span class="o">&gt;</span> <span class="n">last1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s2</span> <span class="o">&gt;</span> <span class="n">last2</span><span class="p">))</span>
<a name="c0-266"></a><span class="lineno"> 266</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-267"></a><span class="lineno"> 267</span>   <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-268"></a><span class="lineno"> 268</span>     <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="n">s1</span><span class="o">++</span> <span class="o">-</span> <span class="o">*</span><span class="n">s2</span><span class="o">++</span><span class="p">;</span>
<a name="c0-269"></a><span class="lineno"> 269</span>     <span class="cm">/*</span>
<a name="c0-270"></a><span class="lineno"> 270</span> <span class="cm">    * Skip whitespace inside. We check for whitespace on</span>
<a name="c0-271"></a><span class="lineno"> 271</span> <span class="cm">    * both buffers because we don't want "a b" to match</span>
<a name="c0-272"></a><span class="lineno"> 272</span> <span class="cm">    * "ab"</span>
<a name="c0-273"></a><span class="lineno"> 273</span> <span class="cm">    */</span>
<a name="c0-274"></a><span class="lineno"> 274</span>     <span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s2</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-275"></a><span class="lineno"> 275</span>       <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">s1</span> <span class="o">&lt;=</span> <span class="n">last1</span><span class="p">)</span>
<a name="c0-276"></a><span class="lineno"> 276</span>         <span class="n">s1</span><span class="o">++</span><span class="p">;</span>
<a name="c0-277"></a><span class="lineno"> 277</span>       <span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">s2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">s2</span> <span class="o">&lt;=</span> <span class="n">last2</span><span class="p">)</span>
<a name="c0-278"></a><span class="lineno"> 278</span>         <span class="n">s2</span><span class="o">++</span><span class="p">;</span>
<a name="c0-279"></a><span class="lineno"> 279</span>     <span class="p">}</span>
<a name="c0-280"></a><span class="lineno"> 280</span>     <span class="cm">/*</span>
<a name="c0-281"></a><span class="lineno"> 281</span> <span class="cm">    * If we reached the end on one side only,</span>
<a name="c0-282"></a><span class="lineno"> 282</span> <span class="cm">    * lines don't match</span>
<a name="c0-283"></a><span class="lineno"> 283</span> <span class="cm">    */</span>
<a name="c0-284"></a><span class="lineno"> 284</span>     <span class="k">if</span> <span class="p">(</span>
<a name="c0-285"></a><span class="lineno"> 285</span>         <span class="p">((</span><span class="n">s2</span> <span class="o">&gt;</span> <span class="n">last2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&lt;=</span> <span class="n">last1</span><span class="p">))</span> <span class="o">||</span>
<a name="c0-286"></a><span class="lineno"> 286</span>         <span class="p">((</span><span class="n">s1</span> <span class="o">&gt;</span> <span class="n">last1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s2</span> <span class="o">&lt;=</span> <span class="n">last2</span><span class="p">)))</span>
<a name="c0-287"></a><span class="lineno"> 287</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-288"></a><span class="lineno"> 288</span>     <span class="k">if</span> <span class="p">((</span><span class="n">s1</span> <span class="o">&gt;</span> <span class="n">last1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s2</span> <span class="o">&gt;</span> <span class="n">last2</span><span class="p">))</span>
<a name="c0-289"></a><span class="lineno"> 289</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-290"></a><span class="lineno"> 290</span>   <span class="p">}</span>
<a name="c0-291"></a><span class="lineno"> 291</span> 
<a name="c0-292"></a><span class="lineno"> 292</span>   <span class="k">return</span> <span class="o">!</span><span class="n">result</span><span class="p">;</span>
<a name="c0-293"></a><span class="lineno"> 293</span> <span class="p">}</span>
<a name="c0-294"></a><span class="lineno"> 294</span> 
<a name="c0-295"></a><span class="lineno"> 295</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_line_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bol</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flag</span><span class="p">)</span>
<a name="c0-296"></a><span class="lineno"> 296</span> <span class="p">{</span>
<a name="c0-297"></a><span class="lineno"> 297</span>   <span class="n">ALLOC_GROW</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line_allocated</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
<a name="c0-298"></a><span class="lineno"> 298</span>   <span class="n">img</span><span class="o">-&gt;</span><span class="n">line_allocated</span><span class="p">[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-299"></a><span class="lineno"> 299</span>   <span class="n">img</span><span class="o">-&gt;</span><span class="n">line_allocated</span><span class="p">[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">].</span><span class="n">hash</span> <span class="o">=</span> <span class="n">hash_line</span><span class="p">(</span><span class="n">bol</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-300"></a><span class="lineno"> 300</span>   <span class="n">img</span><span class="o">-&gt;</span><span class="n">line_allocated</span><span class="p">[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
<a name="c0-301"></a><span class="lineno"> 301</span>   <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-302"></a><span class="lineno"> 302</span> <span class="p">}</span>
<a name="c0-303"></a><span class="lineno"> 303</span> 
<a name="c0-304"></a><span class="lineno"> 304</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
<a name="c0-305"></a><span class="lineno"> 305</span>         <span class="kt">int</span> <span class="n">prepare_linetable</span><span class="p">)</span>
<a name="c0-306"></a><span class="lineno"> 306</span> <span class="p">{</span>
<a name="c0-307"></a><span class="lineno"> 307</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
<a name="c0-308"></a><span class="lineno"> 308</span> 
<a name="c0-309"></a><span class="lineno"> 309</span>   <span class="n">memset</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">image</span><span class="p">));</span>
<a name="c0-310"></a><span class="lineno"> 310</span>   <span class="n">image</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<a name="c0-311"></a><span class="lineno"> 311</span>   <span class="n">image</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-312"></a><span class="lineno"> 312</span> 
<a name="c0-313"></a><span class="lineno"> 313</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prepare_linetable</span><span class="p">)</span>
<a name="c0-314"></a><span class="lineno"> 314</span>     <span class="k">return</span><span class="p">;</span>
<a name="c0-315"></a><span class="lineno"> 315</span> 
<a name="c0-316"></a><span class="lineno"> 316</span>   <span class="n">ep</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c0-317"></a><span class="lineno"> 317</span>   <span class="n">cp</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-318"></a><span class="lineno"> 318</span>   <span class="k">while</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-319"></a><span class="lineno"> 319</span>     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-320"></a><span class="lineno"> 320</span>     <span class="k">for</span> <span class="p">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span> <span class="n">next</span> <span class="o">&lt;</span> <span class="n">ep</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">next</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">;</span> <span class="n">next</span><span class="o">++</span><span class="p">)</span>
<a name="c0-321"></a><span class="lineno"> 321</span>       <span class="p">;</span>
<a name="c0-322"></a><span class="lineno"> 322</span>     <span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="p">)</span>
<a name="c0-323"></a><span class="lineno"> 323</span>       <span class="n">next</span><span class="o">++</span><span class="p">;</span>
<a name="c0-324"></a><span class="lineno"> 324</span>     <span class="n">add_line_info</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">next</span> <span class="o">-</span> <span class="n">cp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-325"></a><span class="lineno"> 325</span>     <span class="n">cp</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
<a name="c0-326"></a><span class="lineno"> 326</span>   <span class="p">}</span>
<a name="c0-327"></a><span class="lineno"> 327</span>   <span class="n">image</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">line_allocated</span><span class="p">;</span>
<a name="c0-328"></a><span class="lineno"> 328</span> <span class="p">}</span>
<a name="c0-329"></a><span class="lineno"> 329</span> 
<a name="c0-330"></a><span class="lineno"> 330</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<a name="c0-331"></a><span class="lineno"> 331</span> <span class="p">{</span>
<a name="c0-332"></a><span class="lineno"> 332</span>   <span class="n">free</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-333"></a><span class="lineno"> 333</span>   <span class="n">image</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-334"></a><span class="lineno"> 334</span>   <span class="n">image</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-335"></a><span class="lineno"> 335</span> <span class="p">}</span>
<a name="c0-336"></a><span class="lineno"> 336</span> 
<a name="c0-337"></a><span class="lineno"> 337</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">say_patch_name</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pre</span><span class="p">,</span>
<a name="c0-338"></a><span class="lineno"> 338</span>          <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">post</span><span class="p">)</span>
<a name="c0-339"></a><span class="lineno"> 339</span> <span class="p">{</span>
<a name="c0-340"></a><span class="lineno"> 340</span>   <span class="n">fputs</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
<a name="c0-341"></a><span class="lineno"> 341</span>   <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">&amp;&amp;</span>
<a name="c0-342"></a><span class="lineno"> 342</span>       <span class="n">strcmp</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-343"></a><span class="lineno"> 343</span>     <span class="n">quote_c_style</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-344"></a><span class="lineno"> 344</span>     <span class="n">fputs</span><span class="p">(</span><span class="s">" =&gt; "</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
<a name="c0-345"></a><span class="lineno"> 345</span>     <span class="n">quote_c_style</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-346"></a><span class="lineno"> 346</span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-347"></a><span class="lineno"> 347</span>     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-348"></a><span class="lineno"> 348</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
<a name="c0-349"></a><span class="lineno"> 349</span>       <span class="n">n</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-350"></a><span class="lineno"> 350</span>     <span class="n">quote_c_style</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-351"></a><span class="lineno"> 351</span>   <span class="p">}</span>
<a name="c0-352"></a><span class="lineno"> 352</span>   <span class="n">fputs</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
<a name="c0-353"></a><span class="lineno"> 353</span> <span class="p">}</span>
<a name="c0-354"></a><span class="lineno"> 354</span> 
<a name="c0-355"></a><span class="lineno"> 355</span> <span class="cp">#define CHUNKSIZE (8192)</span>
<a name="c0-356"></a><span class="lineno"> 356</span> <span class="cp">#define SLOP (16)</span>
<a name="c0-357"></a><span class="lineno"> 357</span> 
<a name="c0-358"></a><span class="lineno"> 358</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">read_patch_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<a name="c0-359"></a><span class="lineno"> 359</span> <span class="p">{</span>
<a name="c0-360"></a><span class="lineno"> 360</span>   <span class="k">if</span> <span class="p">(</span><span class="n">strbuf_read</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-361"></a><span class="lineno"> 361</span>     <span class="n">die_errno</span><span class="p">(</span><span class="s">"git apply: failed to read"</span><span class="p">);</span>
<a name="c0-362"></a><span class="lineno"> 362</span> 
<a name="c0-363"></a><span class="lineno"> 363</span>   <span class="cm">/*</span>
<a name="c0-364"></a><span class="lineno"> 364</span> <span class="cm">  * Make sure that we have some slop in the buffer</span>
<a name="c0-365"></a><span class="lineno"> 365</span> <span class="cm">  * so that we can do speculative "memcmp" etc, and</span>
<a name="c0-366"></a><span class="lineno"> 366</span> <span class="cm">  * see to it that it is NUL-filled.</span>
<a name="c0-367"></a><span class="lineno"> 367</span> <span class="cm">  */</span>
<a name="c0-368"></a><span class="lineno"> 368</span>   <span class="n">strbuf_grow</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">SLOP</span><span class="p">);</span>
<a name="c0-369"></a><span class="lineno"> 369</span>   <span class="n">memset</span><span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLOP</span><span class="p">);</span>
<a name="c0-370"></a><span class="lineno"> 370</span> <span class="p">}</span>
<a name="c0-371"></a><span class="lineno"> 371</span> 
<a name="c0-372"></a><span class="lineno"> 372</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">linelen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<a name="c0-373"></a><span class="lineno"> 373</span> <span class="p">{</span>
<a name="c0-374"></a><span class="lineno"> 374</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-375"></a><span class="lineno"> 375</span>   <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-376"></a><span class="lineno"> 376</span>     <span class="n">len</span><span class="o">++</span><span class="p">;</span>
<a name="c0-377"></a><span class="lineno"> 377</span>     <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="o">++</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-378"></a><span class="lineno"> 378</span>       <span class="k">break</span><span class="p">;</span>
<a name="c0-379"></a><span class="lineno"> 379</span>   <span class="p">}</span>
<a name="c0-380"></a><span class="lineno"> 380</span>   <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-381"></a><span class="lineno"> 381</span> <span class="p">}</span>
<a name="c0-382"></a><span class="lineno"> 382</span> 
<a name="c0-383"></a><span class="lineno"> 383</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">is_dev_null</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<a name="c0-384"></a><span class="lineno"> 384</span> <span class="p">{</span>
<a name="c0-385"></a><span class="lineno"> 385</span>   <span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
<a name="c0-386"></a><span class="lineno"> 386</span> <span class="p">}</span>
<a name="c0-387"></a><span class="lineno"> 387</span> 
<a name="c0-388"></a><span class="lineno"> 388</span> <span class="cp">#define TERM_SPACE 1</span>
<a name="c0-389"></a><span class="lineno"> 389</span> <span class="cp">#define TERM_TAB 2</span>
<a name="c0-390"></a><span class="lineno"> 390</span> 
<a name="c0-391"></a><span class="lineno"> 391</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">name_terminate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">terminate</span><span class="p">)</span>
<a name="c0-392"></a><span class="lineno"> 392</span> <span class="p">{</span>
<a name="c0-393"></a><span class="lineno"> 393</span>   <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">' '</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">terminate</span> <span class="o">&amp;</span> <span class="n">TERM_SPACE</span><span class="p">))</span>
<a name="c0-394"></a><span class="lineno"> 394</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-395"></a><span class="lineno"> 395</span>   <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\t'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">terminate</span> <span class="o">&amp;</span> <span class="n">TERM_TAB</span><span class="p">))</span>
<a name="c0-396"></a><span class="lineno"> 396</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-397"></a><span class="lineno"> 397</span> 
<a name="c0-398"></a><span class="lineno"> 398</span>   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-399"></a><span class="lineno"> 399</span> <span class="p">}</span>
<a name="c0-400"></a><span class="lineno"> 400</span> 
<a name="c0-401"></a><span class="lineno"> 401</span> <span class="cm">/* remove double slashes to make --index work with such filenames */</span>
<a name="c0-402"></a><span class="lineno"> 402</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">squash_slash</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-403"></a><span class="lineno"> 403</span> <span class="p">{</span>
<a name="c0-404"></a><span class="lineno"> 404</span>   <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-405"></a><span class="lineno"> 405</span> 
<a name="c0-406"></a><span class="lineno"> 406</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
<a name="c0-407"></a><span class="lineno"> 407</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-408"></a><span class="lineno"> 408</span> 
<a name="c0-409"></a><span class="lineno"> 409</span>   <span class="k">while</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
<a name="c0-410"></a><span class="lineno"> 410</span>     <span class="k">if</span> <span class="p">((</span><span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
<a name="c0-411"></a><span class="lineno"> 411</span>       <span class="k">while</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
<a name="c0-412"></a><span class="lineno"> 412</span>         <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="c0-413"></a><span class="lineno"> 413</span>   <span class="p">}</span>
<a name="c0-414"></a><span class="lineno"> 414</span>   <span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-415"></a><span class="lineno"> 415</span>   <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-416"></a><span class="lineno"> 416</span> <span class="p">}</span>
<a name="c0-417"></a><span class="lineno"> 417</span> 
<a name="c0-418"></a><span class="lineno"> 418</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">find_name_gnu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">def</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_value</span><span class="p">)</span>
<a name="c0-419"></a><span class="lineno"> 419</span> <span class="p">{</span>
<a name="c0-420"></a><span class="lineno"> 420</span>   <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">name</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-421"></a><span class="lineno"> 421</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-422"></a><span class="lineno"> 422</span> 
<a name="c0-423"></a><span class="lineno"> 423</span>   <span class="cm">/*</span>
<a name="c0-424"></a><span class="lineno"> 424</span> <span class="cm">  * Proposed "new-style" GNU patch/diff format; see</span>
<a name="c0-425"></a><span class="lineno"> 425</span> <span class="cm">  * http://marc.theaimsgroup.com/?l=git&amp;m=112927316408690&amp;w=2</span>
<a name="c0-426"></a><span class="lineno"> 426</span> <span class="cm">  */</span>
<a name="c0-427"></a><span class="lineno"> 427</span>   <span class="k">if</span> <span class="p">(</span><span class="n">unquote_c_style</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-428"></a><span class="lineno"> 428</span>     <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-429"></a><span class="lineno"> 429</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-430"></a><span class="lineno"> 430</span>   <span class="p">}</span>
<a name="c0-431"></a><span class="lineno"> 431</span> 
<a name="c0-432"></a><span class="lineno"> 432</span>   <span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span> <span class="n">p_value</span><span class="p">;</span> <span class="n">p_value</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-433"></a><span class="lineno"> 433</span>     <span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-434"></a><span class="lineno"> 434</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-435"></a><span class="lineno"> 435</span>       <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
<a name="c0-436"></a><span class="lineno"> 436</span>       <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-437"></a><span class="lineno"> 437</span>     <span class="p">}</span>
<a name="c0-438"></a><span class="lineno"> 438</span>     <span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c0-439"></a><span class="lineno"> 439</span>   <span class="p">}</span>
<a name="c0-440"></a><span class="lineno"> 440</span> 
<a name="c0-441"></a><span class="lineno"> 441</span>   <span class="cm">/* name can later be freed, so we need</span>
<a name="c0-442"></a><span class="lineno"> 442</span> <span class="cm">  * to memmove, not just return cp</span>
<a name="c0-443"></a><span class="lineno"> 443</span> <span class="cm">  */</span>
<a name="c0-444"></a><span class="lineno"> 444</span>   <span class="n">strbuf_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">name</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-445"></a><span class="lineno"> 445</span>   <span class="n">free</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<a name="c0-446"></a><span class="lineno"> 446</span>   <span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span>
<a name="c0-447"></a><span class="lineno"> 447</span>     <span class="n">strbuf_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">root_len</span><span class="p">);</span>
<a name="c0-448"></a><span class="lineno"> 448</span>   <span class="k">return</span> <span class="n">squash_slash</span><span class="p">(</span><span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span>
<a name="c0-449"></a><span class="lineno"> 449</span> <span class="p">}</span>
<a name="c0-450"></a><span class="lineno"> 450</span> 
<a name="c0-451"></a><span class="lineno"> 451</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">sane_tz_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-452"></a><span class="lineno"> 452</span> <span class="p">{</span>
<a name="c0-453"></a><span class="lineno"> 453</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tz</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-454"></a><span class="lineno"> 454</span> 
<a name="c0-455"></a><span class="lineno"> 455</span>   <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="s">" +0500"</span><span class="p">)</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="n">strlen</span><span class="p">(</span><span class="s">" +0500"</span><span class="p">)]</span> <span class="o">!=</span> <span class="sc">' '</span><span class="p">)</span>
<a name="c0-456"></a><span class="lineno"> 456</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-457"></a><span class="lineno"> 457</span>   <span class="n">tz</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="s">" +0500"</span><span class="p">);</span>
<a name="c0-458"></a><span class="lineno"> 458</span> 
<a name="c0-459"></a><span class="lineno"> 459</span>   <span class="k">if</span> <span class="p">(</span><span class="n">tz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'+'</span> <span class="o">&amp;&amp;</span> <span class="n">tz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-460"></a><span class="lineno"> 460</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-461"></a><span class="lineno"> 461</span> 
<a name="c0-462"></a><span class="lineno"> 462</span>   <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">tz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
<a name="c0-463"></a><span class="lineno"> 463</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
<a name="c0-464"></a><span class="lineno"> 464</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-465"></a><span class="lineno"> 465</span> 
<a name="c0-466"></a><span class="lineno"> 466</span>   <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">tz</span><span class="p">;</span>
<a name="c0-467"></a><span class="lineno"> 467</span> <span class="p">}</span>
<a name="c0-468"></a><span class="lineno"> 468</span> 
<a name="c0-469"></a><span class="lineno"> 469</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">tz_with_colon_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-470"></a><span class="lineno"> 470</span> <span class="p">{</span>
<a name="c0-471"></a><span class="lineno"> 471</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tz</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-472"></a><span class="lineno"> 472</span> 
<a name="c0-473"></a><span class="lineno"> 473</span>   <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="s">" +08:00"</span><span class="p">)</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="s">":00"</span><span class="p">)]</span> <span class="o">!=</span> <span class="sc">':'</span><span class="p">)</span>
<a name="c0-474"></a><span class="lineno"> 474</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-475"></a><span class="lineno"> 475</span>   <span class="n">tz</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="s">" +08:00"</span><span class="p">);</span>
<a name="c0-476"></a><span class="lineno"> 476</span> 
<a name="c0-477"></a><span class="lineno"> 477</span>   <span class="k">if</span> <span class="p">(</span><span class="n">tz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">' '</span> <span class="o">||</span> <span class="p">(</span><span class="n">tz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'+'</span> <span class="o">&amp;&amp;</span> <span class="n">tz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'-'</span><span class="p">))</span>
<a name="c0-478"></a><span class="lineno"> 478</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-479"></a><span class="lineno"> 479</span>   <span class="n">p</span> <span class="o">=</span> <span class="n">tz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-480"></a><span class="lineno"> 480</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">':'</span> <span class="o">||</span>
<a name="c0-481"></a><span class="lineno"> 481</span>       <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">))</span>
<a name="c0-482"></a><span class="lineno"> 482</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-483"></a><span class="lineno"> 483</span> 
<a name="c0-484"></a><span class="lineno"> 484</span>   <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">tz</span><span class="p">;</span>
<a name="c0-485"></a><span class="lineno"> 485</span> <span class="p">}</span>
<a name="c0-486"></a><span class="lineno"> 486</span> 
<a name="c0-487"></a><span class="lineno"> 487</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">date_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-488"></a><span class="lineno"> 488</span> <span class="p">{</span>
<a name="c0-489"></a><span class="lineno"> 489</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">date</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-490"></a><span class="lineno"> 490</span> 
<a name="c0-491"></a><span class="lineno"> 491</span>   <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"72-02-05"</span><span class="p">)</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="n">strlen</span><span class="p">(</span><span class="s">"-05"</span><span class="p">)]</span> <span class="o">!=</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-492"></a><span class="lineno"> 492</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-493"></a><span class="lineno"> 493</span>   <span class="n">p</span> <span class="o">=</span> <span class="n">date</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"72-02-05"</span><span class="p">);</span>
<a name="c0-494"></a><span class="lineno"> 494</span> 
<a name="c0-495"></a><span class="lineno"> 495</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">'-'</span> <span class="o">||</span>
<a name="c0-496"></a><span class="lineno"> 496</span>       <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">'-'</span> <span class="o">||</span>
<a name="c0-497"></a><span class="lineno"> 497</span>       <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">))</span>  <span class="cm">/* Not a date. */</span>
<a name="c0-498"></a><span class="lineno"> 498</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-499"></a><span class="lineno"> 499</span> 
<a name="c0-500"></a><span class="lineno"> 500</span>   <span class="k">if</span> <span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"19"</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-501"></a><span class="lineno"> 501</span>       <span class="n">isdigit</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>  <span class="cm">/* 4-digit year */</span>
<a name="c0-502"></a><span class="lineno"> 502</span>     <span class="n">date</span> <span class="o">-=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"19"</span><span class="p">);</span>
<a name="c0-503"></a><span class="lineno"> 503</span> 
<a name="c0-504"></a><span class="lineno"> 504</span>   <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">date</span><span class="p">;</span>
<a name="c0-505"></a><span class="lineno"> 505</span> <span class="p">}</span>
<a name="c0-506"></a><span class="lineno"> 506</span> 
<a name="c0-507"></a><span class="lineno"> 507</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">short_time_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-508"></a><span class="lineno"> 508</span> <span class="p">{</span>
<a name="c0-509"></a><span class="lineno"> 509</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">time</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-510"></a><span class="lineno"> 510</span> 
<a name="c0-511"></a><span class="lineno"> 511</span>   <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="s">" 07:01:32"</span><span class="p">)</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="n">strlen</span><span class="p">(</span><span class="s">":32"</span><span class="p">)]</span> <span class="o">!=</span> <span class="sc">':'</span><span class="p">)</span>
<a name="c0-512"></a><span class="lineno"> 512</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-513"></a><span class="lineno"> 513</span>   <span class="n">p</span> <span class="o">=</span> <span class="n">time</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="s">" 07:01:32"</span><span class="p">);</span>
<a name="c0-514"></a><span class="lineno"> 514</span> 
<a name="c0-515"></a><span class="lineno"> 515</span>   <span class="cm">/* Permit 1-digit hours? */</span>
<a name="c0-516"></a><span class="lineno"> 516</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">' '</span> <span class="o">||</span>
<a name="c0-517"></a><span class="lineno"> 517</span>       <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">':'</span> <span class="o">||</span>
<a name="c0-518"></a><span class="lineno"> 518</span>       <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">':'</span> <span class="o">||</span>
<a name="c0-519"></a><span class="lineno"> 519</span>       <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">))</span>  <span class="cm">/* Not a time. */</span>
<a name="c0-520"></a><span class="lineno"> 520</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-521"></a><span class="lineno"> 521</span> 
<a name="c0-522"></a><span class="lineno"> 522</span>   <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">time</span><span class="p">;</span>
<a name="c0-523"></a><span class="lineno"> 523</span> <span class="p">}</span>
<a name="c0-524"></a><span class="lineno"> 524</span> 
<a name="c0-525"></a><span class="lineno"> 525</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">fractional_time_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-526"></a><span class="lineno"> 526</span> <span class="p">{</span>
<a name="c0-527"></a><span class="lineno"> 527</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-528"></a><span class="lineno"> 528</span>   <span class="kt">size_t</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-529"></a><span class="lineno"> 529</span> 
<a name="c0-530"></a><span class="lineno"> 530</span>   <span class="cm">/* Expected format: 19:41:17.620000023 */</span>
<a name="c0-531"></a><span class="lineno"> 531</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
<a name="c0-532"></a><span class="lineno"> 532</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-533"></a><span class="lineno"> 533</span>   <span class="n">p</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-534"></a><span class="lineno"> 534</span> 
<a name="c0-535"></a><span class="lineno"> 535</span>   <span class="cm">/* Fractional seconds. */</span>
<a name="c0-536"></a><span class="lineno"> 536</span>   <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
<a name="c0-537"></a><span class="lineno"> 537</span>     <span class="n">p</span><span class="o">--</span><span class="p">;</span>
<a name="c0-538"></a><span class="lineno"> 538</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">'.'</span><span class="p">)</span>
<a name="c0-539"></a><span class="lineno"> 539</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-540"></a><span class="lineno"> 540</span> 
<a name="c0-541"></a><span class="lineno"> 541</span>   <span class="cm">/* Hours, minutes, and whole seconds. */</span>
<a name="c0-542"></a><span class="lineno"> 542</span>   <span class="n">n</span> <span class="o">=</span> <span class="n">short_time_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-543"></a><span class="lineno"> 543</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
<a name="c0-544"></a><span class="lineno"> 544</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-545"></a><span class="lineno"> 545</span> 
<a name="c0-546"></a><span class="lineno"> 546</span>   <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">p</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-547"></a><span class="lineno"> 547</span> <span class="p">}</span>
<a name="c0-548"></a><span class="lineno"> 548</span> 
<a name="c0-549"></a><span class="lineno"> 549</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">trailing_spaces_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-550"></a><span class="lineno"> 550</span> <span class="p">{</span>
<a name="c0-551"></a><span class="lineno"> 551</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-552"></a><span class="lineno"> 552</span> 
<a name="c0-553"></a><span class="lineno"> 553</span>   <span class="cm">/* Expected format: ' ' x (1 or more)  */</span>
<a name="c0-554"></a><span class="lineno"> 554</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">' '</span><span class="p">)</span>
<a name="c0-555"></a><span class="lineno"> 555</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-556"></a><span class="lineno"> 556</span> 
<a name="c0-557"></a><span class="lineno"> 557</span>   <span class="n">p</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-558"></a><span class="lineno"> 558</span>   <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">line</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-559"></a><span class="lineno"> 559</span>     <span class="n">p</span><span class="o">--</span><span class="p">;</span>
<a name="c0-560"></a><span class="lineno"> 560</span>     <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">' '</span><span class="p">)</span>
<a name="c0-561"></a><span class="lineno"> 561</span>       <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-562"></a><span class="lineno"> 562</span>   <span class="p">}</span>
<a name="c0-563"></a><span class="lineno"> 563</span> 
<a name="c0-564"></a><span class="lineno"> 564</span>   <span class="cm">/* All spaces! */</span>
<a name="c0-565"></a><span class="lineno"> 565</span>   <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-566"></a><span class="lineno"> 566</span> <span class="p">}</span>
<a name="c0-567"></a><span class="lineno"> 567</span> 
<a name="c0-568"></a><span class="lineno"> 568</span> <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">diff_timestamp_len</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-569"></a><span class="lineno"> 569</span> <span class="p">{</span>
<a name="c0-570"></a><span class="lineno"> 570</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-571"></a><span class="lineno"> 571</span>   <span class="kt">size_t</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-572"></a><span class="lineno"> 572</span> 
<a name="c0-573"></a><span class="lineno"> 573</span>   <span class="cm">/*</span>
<a name="c0-574"></a><span class="lineno"> 574</span> <span class="cm">  * Posix: 2010-07-05 19:41:17</span>
<a name="c0-575"></a><span class="lineno"> 575</span> <span class="cm">  * GNU: 2010-07-05 19:41:17.620000023 -0500</span>
<a name="c0-576"></a><span class="lineno"> 576</span> <span class="cm">  */</span>
<a name="c0-577"></a><span class="lineno"> 577</span> 
<a name="c0-578"></a><span class="lineno"> 578</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<a name="c0-579"></a><span class="lineno"> 579</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-580"></a><span class="lineno"> 580</span> 
<a name="c0-581"></a><span class="lineno"> 581</span>   <span class="n">n</span> <span class="o">=</span> <span class="n">sane_tz_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-582"></a><span class="lineno"> 582</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
<a name="c0-583"></a><span class="lineno"> 583</span>     <span class="n">n</span> <span class="o">=</span> <span class="n">tz_with_colon_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-584"></a><span class="lineno"> 584</span>   <span class="n">end</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-585"></a><span class="lineno"> 585</span> 
<a name="c0-586"></a><span class="lineno"> 586</span>   <span class="n">n</span> <span class="o">=</span> <span class="n">short_time_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-587"></a><span class="lineno"> 587</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
<a name="c0-588"></a><span class="lineno"> 588</span>     <span class="n">n</span> <span class="o">=</span> <span class="n">fractional_time_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-589"></a><span class="lineno"> 589</span>   <span class="n">end</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-590"></a><span class="lineno"> 590</span> 
<a name="c0-591"></a><span class="lineno"> 591</span>   <span class="n">n</span> <span class="o">=</span> <span class="n">date_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-592"></a><span class="lineno"> 592</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>  <span class="cm">/* No date.  Too bad. */</span>
<a name="c0-593"></a><span class="lineno"> 593</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-594"></a><span class="lineno"> 594</span>   <span class="n">end</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
<a name="c0-595"></a><span class="lineno"> 595</span> 
<a name="c0-596"></a><span class="lineno"> 596</span>   <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">line</span><span class="p">)</span>  <span class="cm">/* No space before date. */</span>
<a name="c0-597"></a><span class="lineno"> 597</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-598"></a><span class="lineno"> 598</span>   <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Success! */</span>
<a name="c0-599"></a><span class="lineno"> 599</span>     <span class="n">end</span><span class="o">--</span><span class="p">;</span>
<a name="c0-600"></a><span class="lineno"> 600</span>     <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">end</span><span class="p">;</span>
<a name="c0-601"></a><span class="lineno"> 601</span>   <span class="p">}</span>
<a name="c0-602"></a><span class="lineno"> 602</span>   <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">' '</span><span class="p">)</span> <span class="cm">/* No space before date. */</span>
<a name="c0-603"></a><span class="lineno"> 603</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-604"></a><span class="lineno"> 604</span> 
<a name="c0-605"></a><span class="lineno"> 605</span>   <span class="cm">/* Whitespace damage. */</span>
<a name="c0-606"></a><span class="lineno"> 606</span>   <span class="n">end</span> <span class="o">-=</span> <span class="n">trailing_spaces_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-607"></a><span class="lineno"> 607</span>   <span class="k">return</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">end</span><span class="p">;</span>
<a name="c0-608"></a><span class="lineno"> 608</span> <span class="p">}</span>
<a name="c0-609"></a><span class="lineno"> 609</span> 
<a name="c0-610"></a><span class="lineno"> 610</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">find_name_common</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">def</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_value</span><span class="p">,</span>
<a name="c0-611"></a><span class="lineno"> 611</span>         <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="kt">int</span> <span class="n">terminate</span><span class="p">)</span>
<a name="c0-612"></a><span class="lineno"> 612</span> <span class="p">{</span>
<a name="c0-613"></a><span class="lineno"> 613</span>   <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-614"></a><span class="lineno"> 614</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-615"></a><span class="lineno"> 615</span> 
<a name="c0-616"></a><span class="lineno"> 616</span>   <span class="k">if</span> <span class="p">(</span><span class="n">p_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-617"></a><span class="lineno"> 617</span>     <span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-618"></a><span class="lineno"> 618</span>   <span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-619"></a><span class="lineno"> 619</span>     <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>
<a name="c0-620"></a><span class="lineno"> 620</span> 
<a name="c0-621"></a><span class="lineno"> 621</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-622"></a><span class="lineno"> 622</span>       <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-623"></a><span class="lineno"> 623</span>         <span class="k">break</span><span class="p">;</span>
<a name="c0-624"></a><span class="lineno"> 624</span>       <span class="k">if</span> <span class="p">(</span><span class="n">name_terminate</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">line</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">terminate</span><span class="p">))</span>
<a name="c0-625"></a><span class="lineno"> 625</span>         <span class="k">break</span><span class="p">;</span>
<a name="c0-626"></a><span class="lineno"> 626</span>     <span class="p">}</span>
<a name="c0-627"></a><span class="lineno"> 627</span>     <span class="n">line</span><span class="o">++</span><span class="p">;</span>
<a name="c0-628"></a><span class="lineno"> 628</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">&amp;&amp;</span> <span class="o">!--</span><span class="n">p_value</span><span class="p">)</span>
<a name="c0-629"></a><span class="lineno"> 629</span>       <span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-630"></a><span class="lineno"> 630</span>   <span class="p">}</span>
<a name="c0-631"></a><span class="lineno"> 631</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start</span><span class="p">)</span>
<a name="c0-632"></a><span class="lineno"> 632</span>     <span class="k">return</span> <span class="n">squash_slash</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<a name="c0-633"></a><span class="lineno"> 633</span>   <span class="n">len</span> <span class="o">=</span> <span class="n">line</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<a name="c0-634"></a><span class="lineno"> 634</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c0-635"></a><span class="lineno"> 635</span>     <span class="k">return</span> <span class="n">squash_slash</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<a name="c0-636"></a><span class="lineno"> 636</span> 
<a name="c0-637"></a><span class="lineno"> 637</span>   <span class="cm">/*</span>
<a name="c0-638"></a><span class="lineno"> 638</span> <span class="cm">  * Generally we prefer the shorter name, especially</span>
<a name="c0-639"></a><span class="lineno"> 639</span> <span class="cm">  * if the other one is just a variation of that with</span>
<a name="c0-640"></a><span class="lineno"> 640</span> <span class="cm">  * something else tacked on to the end (ie "file.orig"</span>
<a name="c0-641"></a><span class="lineno"> 641</span> <span class="cm">  * or "file~").</span>
<a name="c0-642"></a><span class="lineno"> 642</span> <span class="cm">  */</span>
<a name="c0-643"></a><span class="lineno"> 643</span>   <span class="k">if</span> <span class="p">(</span><span class="n">def</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-644"></a><span class="lineno"> 644</span>     <span class="kt">int</span> <span class="n">deflen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<a name="c0-645"></a><span class="lineno"> 645</span>     <span class="k">if</span> <span class="p">(</span><span class="n">deflen</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">deflen</span><span class="p">))</span>
<a name="c0-646"></a><span class="lineno"> 646</span>       <span class="k">return</span> <span class="n">squash_slash</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<a name="c0-647"></a><span class="lineno"> 647</span>     <span class="n">free</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>
<a name="c0-648"></a><span class="lineno"> 648</span>   <span class="p">}</span>
<a name="c0-649"></a><span class="lineno"> 649</span> 
<a name="c0-650"></a><span class="lineno"> 650</span>   <span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-651"></a><span class="lineno"> 651</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">root_len</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-652"></a><span class="lineno"> 652</span>     <span class="n">strcpy</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<a name="c0-653"></a><span class="lineno"> 653</span>     <span class="n">memcpy</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="n">root_len</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-654"></a><span class="lineno"> 654</span>     <span class="n">ret</span><span class="p">[</span><span class="n">root_len</span> <span class="o">+</span> <span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-655"></a><span class="lineno"> 655</span>     <span class="k">return</span> <span class="n">squash_slash</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<a name="c0-656"></a><span class="lineno"> 656</span>   <span class="p">}</span>
<a name="c0-657"></a><span class="lineno"> 657</span> 
<a name="c0-658"></a><span class="lineno"> 658</span>   <span class="k">return</span> <span class="n">squash_slash</span><span class="p">(</span><span class="n">xmemdupz</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
<a name="c0-659"></a><span class="lineno"> 659</span> <span class="p">}</span>
<a name="c0-660"></a><span class="lineno"> 660</span> 
<a name="c0-661"></a><span class="lineno"> 661</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">find_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">def</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">terminate</span><span class="p">)</span>
<a name="c0-662"></a><span class="lineno"> 662</span> <span class="p">{</span>
<a name="c0-663"></a><span class="lineno"> 663</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-664"></a><span class="lineno"> 664</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">find_name_gnu</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">p_value</span><span class="p">);</span>
<a name="c0-665"></a><span class="lineno"> 665</span>     <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a name="c0-666"></a><span class="lineno"> 666</span>       <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-667"></a><span class="lineno"> 667</span>   <span class="p">}</span>
<a name="c0-668"></a><span class="lineno"> 668</span> 
<a name="c0-669"></a><span class="lineno"> 669</span>   <span class="k">return</span> <span class="n">find_name_common</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">terminate</span><span class="p">);</span>
<a name="c0-670"></a><span class="lineno"> 670</span> <span class="p">}</span>
<a name="c0-671"></a><span class="lineno"> 671</span> 
<a name="c0-672"></a><span class="lineno"> 672</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">find_name_traditional</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">def</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_value</span><span class="p">)</span>
<a name="c0-673"></a><span class="lineno"> 673</span> <span class="p">{</span>
<a name="c0-674"></a><span class="lineno"> 674</span>   <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
<a name="c0-675"></a><span class="lineno"> 675</span>   <span class="kt">size_t</span> <span class="n">date_len</span><span class="p">;</span>
<a name="c0-676"></a><span class="lineno"> 676</span> 
<a name="c0-677"></a><span class="lineno"> 677</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-678"></a><span class="lineno"> 678</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">find_name_gnu</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">p_value</span><span class="p">);</span>
<a name="c0-679"></a><span class="lineno"> 679</span>     <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a name="c0-680"></a><span class="lineno"> 680</span>       <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-681"></a><span class="lineno"> 681</span>   <span class="p">}</span>
<a name="c0-682"></a><span class="lineno"> 682</span> 
<a name="c0-683"></a><span class="lineno"> 683</span>   <span class="n">len</span> <span class="o">=</span> <span class="n">strchrnul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="o">-</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-684"></a><span class="lineno"> 684</span>   <span class="n">date_len</span> <span class="o">=</span> <span class="n">diff_timestamp_len</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-685"></a><span class="lineno"> 685</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">date_len</span><span class="p">)</span>
<a name="c0-686"></a><span class="lineno"> 686</span>     <span class="k">return</span> <span class="n">find_name_common</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">TERM_TAB</span><span class="p">);</span>
<a name="c0-687"></a><span class="lineno"> 687</span>   <span class="n">len</span> <span class="o">-=</span> <span class="n">date_len</span><span class="p">;</span>
<a name="c0-688"></a><span class="lineno"> 688</span> 
<a name="c0-689"></a><span class="lineno"> 689</span>   <span class="k">return</span> <span class="n">find_name_common</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-690"></a><span class="lineno"> 690</span> <span class="p">}</span>
<a name="c0-691"></a><span class="lineno"> 691</span> 
<a name="c0-692"></a><span class="lineno"> 692</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">count_slashes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-693"></a><span class="lineno"> 693</span> <span class="p">{</span>
<a name="c0-694"></a><span class="lineno"> 694</span>   <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-695"></a><span class="lineno"> 695</span>   <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
<a name="c0-696"></a><span class="lineno"> 696</span> 
<a name="c0-697"></a><span class="lineno"> 697</span>   <span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">))</span>
<a name="c0-698"></a><span class="lineno"> 698</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'/'</span><span class="p">)</span>
<a name="c0-699"></a><span class="lineno"> 699</span>       <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
<a name="c0-700"></a><span class="lineno"> 700</span>   <span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<a name="c0-701"></a><span class="lineno"> 701</span> <span class="p">}</span>
<a name="c0-702"></a><span class="lineno"> 702</span> 
<a name="c0-703"></a><span class="lineno"> 703</span> <span class="cm">/*</span>
<a name="c0-704"></a><span class="lineno"> 704</span> <span class="cm"> * Given the string after "--- " or "+++ ", guess the appropriate</span>
<a name="c0-705"></a><span class="lineno"> 705</span> <span class="cm"> * p_value for the given patch.</span>
<a name="c0-706"></a><span class="lineno"> 706</span> <span class="cm"> */</span>
<a name="c0-707"></a><span class="lineno"> 707</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">guess_p_value</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nameline</span><span class="p">)</span>
<a name="c0-708"></a><span class="lineno"> 708</span> <span class="p">{</span>
<a name="c0-709"></a><span class="lineno"> 709</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-710"></a><span class="lineno"> 710</span>   <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-711"></a><span class="lineno"> 711</span> 
<a name="c0-712"></a><span class="lineno"> 712</span>   <span class="k">if</span> <span class="p">(</span><span class="n">is_dev_null</span><span class="p">(</span><span class="n">nameline</span><span class="p">))</span>
<a name="c0-713"></a><span class="lineno"> 713</span>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-714"></a><span class="lineno"> 714</span>   <span class="n">name</span> <span class="o">=</span> <span class="n">find_name_traditional</span><span class="p">(</span><span class="n">nameline</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-715"></a><span class="lineno"> 715</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
<a name="c0-716"></a><span class="lineno"> 716</span>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-717"></a><span class="lineno"> 717</span>   <span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-718"></a><span class="lineno"> 718</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-719"></a><span class="lineno"> 719</span>     <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-720"></a><span class="lineno"> 720</span>   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-721"></a><span class="lineno"> 721</span>     <span class="cm">/*</span>
<a name="c0-722"></a><span class="lineno"> 722</span> <span class="cm">    * Does it begin with "a/$our-prefix" and such?  Then this is</span>
<a name="c0-723"></a><span class="lineno"> 723</span> <span class="cm">    * very likely to apply to our directory.</span>
<a name="c0-724"></a><span class="lineno"> 724</span> <span class="cm">    */</span>
<a name="c0-725"></a><span class="lineno"> 725</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">))</span>
<a name="c0-726"></a><span class="lineno"> 726</span>       <span class="n">val</span> <span class="o">=</span> <span class="n">count_slashes</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span>
<a name="c0-727"></a><span class="lineno"> 727</span>     <span class="k">else</span> <span class="p">{</span>
<a name="c0-728"></a><span class="lineno"> 728</span>       <span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c0-729"></a><span class="lineno"> 729</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">))</span>
<a name="c0-730"></a><span class="lineno"> 730</span>         <span class="n">val</span> <span class="o">=</span> <span class="n">count_slashes</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-731"></a><span class="lineno"> 731</span>     <span class="p">}</span>
<a name="c0-732"></a><span class="lineno"> 732</span>   <span class="p">}</span>
<a name="c0-733"></a><span class="lineno"> 733</span>   <span class="n">free</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-734"></a><span class="lineno"> 734</span>   <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<a name="c0-735"></a><span class="lineno"> 735</span> <span class="p">}</span>
<a name="c0-736"></a><span class="lineno"> 736</span> 
<a name="c0-737"></a><span class="lineno"> 737</span> <span class="cm">/*</span>
<a name="c0-738"></a><span class="lineno"> 738</span> <span class="cm"> * Does the ---/+++ line has the POSIX timestamp after the last HT?</span>
<a name="c0-739"></a><span class="lineno"> 739</span> <span class="cm"> * GNU diff puts epoch there to signal a creation/deletion event.  Is</span>
<a name="c0-740"></a><span class="lineno"> 740</span> <span class="cm"> * this such a timestamp?</span>
<a name="c0-741"></a><span class="lineno"> 741</span> <span class="cm"> */</span>
<a name="c0-742"></a><span class="lineno"> 742</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">has_epoch_timestamp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nameline</span><span class="p">)</span>
<a name="c0-743"></a><span class="lineno"> 743</span> <span class="p">{</span>
<a name="c0-744"></a><span class="lineno"> 744</span>   <span class="cm">/*</span>
<a name="c0-745"></a><span class="lineno"> 745</span> <span class="cm">  * We are only interested in epoch timestamp; any non-zero</span>
<a name="c0-746"></a><span class="lineno"> 746</span> <span class="cm">  * fraction cannot be one, hence "(\.0+)?" in the regexp below.</span>
<a name="c0-747"></a><span class="lineno"> 747</span> <span class="cm">  * For the same reason, the date must be either 1969-12-31 or</span>
<a name="c0-748"></a><span class="lineno"> 748</span> <span class="cm">  * 1970-01-01, and the seconds part must be "00".</span>
<a name="c0-749"></a><span class="lineno"> 749</span> <span class="cm">  */</span>
<a name="c0-750"></a><span class="lineno"> 750</span>   <span class="k">const</span> <span class="kt">char</span> <span class="n">stamp_regexp</span><span class="p">[]</span> <span class="o">=</span>
<a name="c0-751"></a><span class="lineno"> 751</span>     <span class="s">"^(1969-12-31|1970-01-01)"</span>
<a name="c0-752"></a><span class="lineno"> 752</span>     <span class="s">" "</span>
<a name="c0-753"></a><span class="lineno"> 753</span>     <span class="s">"[0-2][0-9]:[0-5][0-9]:00(</span><span class="se">\\</span><span class="s">.0+)?"</span>
<a name="c0-754"></a><span class="lineno"> 754</span>     <span class="s">" "</span>
<a name="c0-755"></a><span class="lineno"> 755</span>     <span class="s">"([-+][0-2][0-9]:?[0-5][0-9])</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<a name="c0-756"></a><span class="lineno"> 756</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">timestamp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">colon</span><span class="p">;</span>
<a name="c0-757"></a><span class="lineno"> 757</span>   <span class="k">static</span> <span class="n">regex_t</span> <span class="o">*</span><span class="n">stamp</span><span class="p">;</span>
<a name="c0-758"></a><span class="lineno"> 758</span>   <span class="n">regmatch_t</span> <span class="n">m</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<a name="c0-759"></a><span class="lineno"> 759</span>   <span class="kt">int</span> <span class="n">zoneoffset</span><span class="p">;</span>
<a name="c0-760"></a><span class="lineno"> 760</span>   <span class="kt">int</span> <span class="n">hourminute</span><span class="p">;</span>
<a name="c0-761"></a><span class="lineno"> 761</span>   <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-762"></a><span class="lineno"> 762</span> 
<a name="c0-763"></a><span class="lineno"> 763</span>   <span class="k">for</span> <span class="p">(</span><span class="n">cp</span> <span class="o">=</span> <span class="n">nameline</span><span class="p">;</span> <span class="o">*</span><span class="n">cp</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">;</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-764"></a><span class="lineno"> 764</span>     <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span>
<a name="c0-765"></a><span class="lineno"> 765</span>       <span class="n">timestamp</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-766"></a><span class="lineno"> 766</span>   <span class="p">}</span>
<a name="c0-767"></a><span class="lineno"> 767</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timestamp</span><span class="p">)</span>
<a name="c0-768"></a><span class="lineno"> 768</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-769"></a><span class="lineno"> 769</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stamp</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-770"></a><span class="lineno"> 770</span>     <span class="n">stamp</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stamp</span><span class="p">));</span>
<a name="c0-771"></a><span class="lineno"> 771</span>     <span class="k">if</span> <span class="p">(</span><span class="n">regcomp</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">stamp_regexp</span><span class="p">,</span> <span class="n">REG_EXTENDED</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-772"></a><span class="lineno"> 772</span>       <span class="n">warning</span><span class="p">(</span><span class="s">"Cannot prepare timestamp regexp %s"</span><span class="p">,</span>
<a name="c0-773"></a><span class="lineno"> 773</span>         <span class="n">stamp_regexp</span><span class="p">);</span>
<a name="c0-774"></a><span class="lineno"> 774</span>       <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-775"></a><span class="lineno"> 775</span>     <span class="p">}</span>
<a name="c0-776"></a><span class="lineno"> 776</span>   <span class="p">}</span>
<a name="c0-777"></a><span class="lineno"> 777</span> 
<a name="c0-778"></a><span class="lineno"> 778</span>   <span class="n">status</span> <span class="o">=</span> <span class="n">regexec</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-779"></a><span class="lineno"> 779</span>   <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-780"></a><span class="lineno"> 780</span>     <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">REG_NOMATCH</span><span class="p">)</span>
<a name="c0-781"></a><span class="lineno"> 781</span>       <span class="n">warning</span><span class="p">(</span><span class="s">"regexec returned %d for input: %s"</span><span class="p">,</span>
<a name="c0-782"></a><span class="lineno"> 782</span>         <span class="n">status</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
<a name="c0-783"></a><span class="lineno"> 783</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-784"></a><span class="lineno"> 784</span>   <span class="p">}</span>
<a name="c0-785"></a><span class="lineno"> 785</span> 
<a name="c0-786"></a><span class="lineno"> 786</span>   <span class="n">zoneoffset</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">rm_so</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">colon</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-787"></a><span class="lineno"> 787</span>   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">colon</span> <span class="o">==</span> <span class="sc">':'</span><span class="p">)</span>
<a name="c0-788"></a><span class="lineno"> 788</span>     <span class="n">zoneoffset</span> <span class="o">=</span> <span class="n">zoneoffset</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">strtol</span><span class="p">(</span><span class="n">colon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-789"></a><span class="lineno"> 789</span>   <span class="k">else</span>
<a name="c0-790"></a><span class="lineno"> 790</span>     <span class="n">zoneoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">zoneoffset</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="p">(</span><span class="n">zoneoffset</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
<a name="c0-791"></a><span class="lineno"> 791</span>   <span class="k">if</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">rm_so</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-792"></a><span class="lineno"> 792</span>     <span class="n">zoneoffset</span> <span class="o">=</span> <span class="o">-</span><span class="n">zoneoffset</span><span class="p">;</span>
<a name="c0-793"></a><span class="lineno"> 793</span> 
<a name="c0-794"></a><span class="lineno"> 794</span>   <span class="cm">/*</span>
<a name="c0-795"></a><span class="lineno"> 795</span> <span class="cm">  * YYYY-MM-DD hh:mm:ss must be from either 1969-12-31</span>
<a name="c0-796"></a><span class="lineno"> 796</span> <span class="cm">  * (west of GMT) or 1970-01-01 (east of GMT)</span>
<a name="c0-797"></a><span class="lineno"> 797</span> <span class="cm">  */</span>
<a name="c0-798"></a><span class="lineno"> 798</span>   <span class="k">if</span> <span class="p">((</span><span class="n">zoneoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s">"1969-12-31"</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">||</span>
<a name="c0-799"></a><span class="lineno"> 799</span>       <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">zoneoffset</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s">"1970-01-01"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
<a name="c0-800"></a><span class="lineno"> 800</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-801"></a><span class="lineno"> 801</span> 
<a name="c0-802"></a><span class="lineno"> 802</span>   <span class="n">hourminute</span> <span class="o">=</span> <span class="p">(</span><span class="n">strtol</span><span class="p">(</span><span class="n">timestamp</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span>
<a name="c0-803"></a><span class="lineno"> 803</span>           <span class="n">strtol</span><span class="p">(</span><span class="n">timestamp</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span>
<a name="c0-804"></a><span class="lineno"> 804</span>           <span class="n">zoneoffset</span><span class="p">);</span>
<a name="c0-805"></a><span class="lineno"> 805</span> 
<a name="c0-806"></a><span class="lineno"> 806</span>   <span class="k">return</span> <span class="p">((</span><span class="n">zoneoffset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hourminute</span> <span class="o">==</span> <span class="mi">1440</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-807"></a><span class="lineno"> 807</span>     <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">zoneoffset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hourminute</span><span class="p">));</span>
<a name="c0-808"></a><span class="lineno"> 808</span> <span class="p">}</span>
<a name="c0-809"></a><span class="lineno"> 809</span> 
<a name="c0-810"></a><span class="lineno"> 810</span> <span class="cm">/*</span>
<a name="c0-811"></a><span class="lineno"> 811</span> <span class="cm"> * Get the name etc info from the ---/+++ lines of a traditional patch header</span>
<a name="c0-812"></a><span class="lineno"> 812</span> <span class="cm"> *</span>
<a name="c0-813"></a><span class="lineno"> 813</span> <span class="cm"> * FIXME! The end-of-filename heuristics are kind of screwy. For existing</span>
<a name="c0-814"></a><span class="lineno"> 814</span> <span class="cm"> * files, we can happily check the index for a match, but for creating a</span>
<a name="c0-815"></a><span class="lineno"> 815</span> <span class="cm"> * new file we should try to match whatever "patch" does. I have no idea.</span>
<a name="c0-816"></a><span class="lineno"> 816</span> <span class="cm"> */</span>
<a name="c0-817"></a><span class="lineno"> 817</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_traditional_patch</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">second</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-818"></a><span class="lineno"> 818</span> <span class="p">{</span>
<a name="c0-819"></a><span class="lineno"> 819</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-820"></a><span class="lineno"> 820</span> 
<a name="c0-821"></a><span class="lineno"> 821</span>   <span class="n">first</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>  <span class="cm">/* skip "--- " */</span>
<a name="c0-822"></a><span class="lineno"> 822</span>   <span class="n">second</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* skip "+++ " */</span>
<a name="c0-823"></a><span class="lineno"> 823</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_value_known</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-824"></a><span class="lineno"> 824</span>     <span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
<a name="c0-825"></a><span class="lineno"> 825</span>     <span class="n">p</span> <span class="o">=</span> <span class="n">guess_p_value</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
<a name="c0-826"></a><span class="lineno"> 826</span>     <span class="n">q</span> <span class="o">=</span> <span class="n">guess_p_value</span><span class="p">(</span><span class="n">second</span><span class="p">);</span>
<a name="c0-827"></a><span class="lineno"> 827</span>     <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
<a name="c0-828"></a><span class="lineno"> 828</span>     <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">==</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-829"></a><span class="lineno"> 829</span>       <span class="n">p_value</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<a name="c0-830"></a><span class="lineno"> 830</span>       <span class="n">p_value_known</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-831"></a><span class="lineno"> 831</span>     <span class="p">}</span>
<a name="c0-832"></a><span class="lineno"> 832</span>   <span class="p">}</span>
<a name="c0-833"></a><span class="lineno"> 833</span>   <span class="k">if</span> <span class="p">(</span><span class="n">is_dev_null</span><span class="p">(</span><span class="n">first</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-834"></a><span class="lineno"> 834</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-835"></a><span class="lineno"> 835</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-836"></a><span class="lineno"> 836</span>     <span class="n">name</span> <span class="o">=</span> <span class="n">find_name_traditional</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">);</span>
<a name="c0-837"></a><span class="lineno"> 837</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-838"></a><span class="lineno"> 838</span>   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_dev_null</span><span class="p">(</span><span class="n">second</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-839"></a><span class="lineno"> 839</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-840"></a><span class="lineno"> 840</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-841"></a><span class="lineno"> 841</span>     <span class="n">name</span> <span class="o">=</span> <span class="n">find_name_traditional</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">);</span>
<a name="c0-842"></a><span class="lineno"> 842</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-843"></a><span class="lineno"> 843</span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-844"></a><span class="lineno"> 844</span>     <span class="n">name</span> <span class="o">=</span> <span class="n">find_name_traditional</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">);</span>
<a name="c0-845"></a><span class="lineno"> 845</span>     <span class="n">name</span> <span class="o">=</span> <span class="n">find_name_traditional</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">p_value</span><span class="p">);</span>
<a name="c0-846"></a><span class="lineno"> 846</span>     <span class="k">if</span> <span class="p">(</span><span class="n">has_epoch_timestamp</span><span class="p">(</span><span class="n">first</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-847"></a><span class="lineno"> 847</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-848"></a><span class="lineno"> 848</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-849"></a><span class="lineno"> 849</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-850"></a><span class="lineno"> 850</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">has_epoch_timestamp</span><span class="p">(</span><span class="n">second</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-851"></a><span class="lineno"> 851</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-852"></a><span class="lineno"> 852</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-853"></a><span class="lineno"> 853</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-854"></a><span class="lineno"> 854</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-855"></a><span class="lineno"> 855</span>       <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-856"></a><span class="lineno"> 856</span>     <span class="p">}</span>
<a name="c0-857"></a><span class="lineno"> 857</span>   <span class="p">}</span>
<a name="c0-858"></a><span class="lineno"> 858</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
<a name="c0-859"></a><span class="lineno"> 859</span>     <span class="n">die</span><span class="p">(</span><span class="s">"unable to find filename in patch at line %d"</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-860"></a><span class="lineno"> 860</span> <span class="p">}</span>
<a name="c0-861"></a><span class="lineno"> 861</span> 
<a name="c0-862"></a><span class="lineno"> 862</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_hdrend</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-863"></a><span class="lineno"> 863</span> <span class="p">{</span>
<a name="c0-864"></a><span class="lineno"> 864</span>   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-865"></a><span class="lineno"> 865</span> <span class="p">}</span>
<a name="c0-866"></a><span class="lineno"> 866</span> 
<a name="c0-867"></a><span class="lineno"> 867</span> <span class="cm">/*</span>
<a name="c0-868"></a><span class="lineno"> 868</span> <span class="cm"> * We're anal about diff header consistency, to make</span>
<a name="c0-869"></a><span class="lineno"> 869</span> <span class="cm"> * sure that we don't end up having strange ambiguous</span>
<a name="c0-870"></a><span class="lineno"> 870</span> <span class="cm"> * patches floating around.</span>
<a name="c0-871"></a><span class="lineno"> 871</span> <span class="cm"> *</span>
<a name="c0-872"></a><span class="lineno"> 872</span> <span class="cm"> * As a result, gitdiff_{old|new}name() will check</span>
<a name="c0-873"></a><span class="lineno"> 873</span> <span class="cm"> * their names against any previous information, just</span>
<a name="c0-874"></a><span class="lineno"> 874</span> <span class="cm"> * to make sure..</span>
<a name="c0-875"></a><span class="lineno"> 875</span> <span class="cm"> */</span>
<a name="c0-876"></a><span class="lineno"> 876</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gitdiff_verify_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isnull</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">orig_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oldnew</span><span class="p">)</span>
<a name="c0-877"></a><span class="lineno"> 877</span> <span class="p">{</span>
<a name="c0-878"></a><span class="lineno"> 878</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orig_name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isnull</span><span class="p">)</span>
<a name="c0-879"></a><span class="lineno"> 879</span>     <span class="k">return</span> <span class="n">find_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">TERM_TAB</span><span class="p">);</span>
<a name="c0-880"></a><span class="lineno"> 880</span> 
<a name="c0-881"></a><span class="lineno"> 881</span>   <span class="k">if</span> <span class="p">(</span><span class="n">orig_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-882"></a><span class="lineno"> 882</span>     <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-883"></a><span class="lineno"> 883</span>     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-884"></a><span class="lineno"> 884</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">another</span><span class="p">;</span>
<a name="c0-885"></a><span class="lineno"> 885</span>     <span class="n">name</span> <span class="o">=</span> <span class="n">orig_name</span><span class="p">;</span>
<a name="c0-886"></a><span class="lineno"> 886</span>     <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<a name="c0-887"></a><span class="lineno"> 887</span>     <span class="k">if</span> <span class="p">(</span><span class="n">isnull</span><span class="p">)</span>
<a name="c0-888"></a><span class="lineno"> 888</span>       <span class="n">die</span><span class="p">(</span><span class="s">"git apply: bad git-diff - expected /dev/null, got %s on line %d"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-889"></a><span class="lineno"> 889</span>     <span class="n">another</span> <span class="o">=</span> <span class="n">find_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">TERM_TAB</span><span class="p">);</span>
<a name="c0-890"></a><span class="lineno"> 890</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">another</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">another</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="c0-891"></a><span class="lineno"> 891</span>       <span class="n">die</span><span class="p">(</span><span class="s">"git apply: bad git-diff - inconsistent %s filename on line %d"</span><span class="p">,</span> <span class="n">oldnew</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-892"></a><span class="lineno"> 892</span>     <span class="n">free</span><span class="p">(</span><span class="n">another</span><span class="p">);</span>
<a name="c0-893"></a><span class="lineno"> 893</span>     <span class="k">return</span> <span class="n">orig_name</span><span class="p">;</span>
<a name="c0-894"></a><span class="lineno"> 894</span>   <span class="p">}</span>
<a name="c0-895"></a><span class="lineno"> 895</span>   <span class="k">else</span> <span class="p">{</span>
<a name="c0-896"></a><span class="lineno"> 896</span>     <span class="cm">/* expect "/dev/null" */</span>
<a name="c0-897"></a><span class="lineno"> 897</span>     <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="s">"/dev/null"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-898"></a><span class="lineno"> 898</span>       <span class="n">die</span><span class="p">(</span><span class="s">"git apply: bad git-diff - expected /dev/null on line %d"</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-899"></a><span class="lineno"> 899</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-900"></a><span class="lineno"> 900</span>   <span class="p">}</span>
<a name="c0-901"></a><span class="lineno"> 901</span> <span class="p">}</span>
<a name="c0-902"></a><span class="lineno"> 902</span> 
<a name="c0-903"></a><span class="lineno"> 903</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_oldname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-904"></a><span class="lineno"> 904</span> <span class="p">{</span>
<a name="c0-905"></a><span class="lineno"> 905</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">gitdiff_verify_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="s">"old"</span><span class="p">);</span>
<a name="c0-906"></a><span class="lineno"> 906</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-907"></a><span class="lineno"> 907</span> <span class="p">}</span>
<a name="c0-908"></a><span class="lineno"> 908</span> 
<a name="c0-909"></a><span class="lineno"> 909</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_newname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-910"></a><span class="lineno"> 910</span> <span class="p">{</span>
<a name="c0-911"></a><span class="lineno"> 911</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">gitdiff_verify_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="s">"new"</span><span class="p">);</span>
<a name="c0-912"></a><span class="lineno"> 912</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-913"></a><span class="lineno"> 913</span> <span class="p">}</span>
<a name="c0-914"></a><span class="lineno"> 914</span> 
<a name="c0-915"></a><span class="lineno"> 915</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_oldmode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-916"></a><span class="lineno"> 916</span> <span class="p">{</span>
<a name="c0-917"></a><span class="lineno"> 917</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<a name="c0-918"></a><span class="lineno"> 918</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-919"></a><span class="lineno"> 919</span> <span class="p">}</span>
<a name="c0-920"></a><span class="lineno"> 920</span> 
<a name="c0-921"></a><span class="lineno"> 921</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_newmode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-922"></a><span class="lineno"> 922</span> <span class="p">{</span>
<a name="c0-923"></a><span class="lineno"> 923</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<a name="c0-924"></a><span class="lineno"> 924</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-925"></a><span class="lineno"> 925</span> <span class="p">}</span>
<a name="c0-926"></a><span class="lineno"> 926</span> 
<a name="c0-927"></a><span class="lineno"> 927</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_delete</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-928"></a><span class="lineno"> 928</span> <span class="p">{</span>
<a name="c0-929"></a><span class="lineno"> 929</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-930"></a><span class="lineno"> 930</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">;</span>
<a name="c0-931"></a><span class="lineno"> 931</span>   <span class="k">return</span> <span class="n">gitdiff_oldmode</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-932"></a><span class="lineno"> 932</span> <span class="p">}</span>
<a name="c0-933"></a><span class="lineno"> 933</span> 
<a name="c0-934"></a><span class="lineno"> 934</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_newfile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-935"></a><span class="lineno"> 935</span> <span class="p">{</span>
<a name="c0-936"></a><span class="lineno"> 936</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-937"></a><span class="lineno"> 937</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">;</span>
<a name="c0-938"></a><span class="lineno"> 938</span>   <span class="k">return</span> <span class="n">gitdiff_newmode</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-939"></a><span class="lineno"> 939</span> <span class="p">}</span>
<a name="c0-940"></a><span class="lineno"> 940</span> 
<a name="c0-941"></a><span class="lineno"> 941</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_copysrc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-942"></a><span class="lineno"> 942</span> <span class="p">{</span>
<a name="c0-943"></a><span class="lineno"> 943</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-944"></a><span class="lineno"> 944</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">find_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">?</span> <span class="n">p_value</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-945"></a><span class="lineno"> 945</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-946"></a><span class="lineno"> 946</span> <span class="p">}</span>
<a name="c0-947"></a><span class="lineno"> 947</span> 
<a name="c0-948"></a><span class="lineno"> 948</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_copydst</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-949"></a><span class="lineno"> 949</span> <span class="p">{</span>
<a name="c0-950"></a><span class="lineno"> 950</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-951"></a><span class="lineno"> 951</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">find_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">?</span> <span class="n">p_value</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-952"></a><span class="lineno"> 952</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-953"></a><span class="lineno"> 953</span> <span class="p">}</span>
<a name="c0-954"></a><span class="lineno"> 954</span> 
<a name="c0-955"></a><span class="lineno"> 955</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_renamesrc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-956"></a><span class="lineno"> 956</span> <span class="p">{</span>
<a name="c0-957"></a><span class="lineno"> 957</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-958"></a><span class="lineno"> 958</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">find_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">?</span> <span class="n">p_value</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-959"></a><span class="lineno"> 959</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-960"></a><span class="lineno"> 960</span> <span class="p">}</span>
<a name="c0-961"></a><span class="lineno"> 961</span> 
<a name="c0-962"></a><span class="lineno"> 962</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_renamedst</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-963"></a><span class="lineno"> 963</span> <span class="p">{</span>
<a name="c0-964"></a><span class="lineno"> 964</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-965"></a><span class="lineno"> 965</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">find_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">?</span> <span class="n">p_value</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-966"></a><span class="lineno"> 966</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-967"></a><span class="lineno"> 967</span> <span class="p">}</span>
<a name="c0-968"></a><span class="lineno"> 968</span> 
<a name="c0-969"></a><span class="lineno"> 969</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_similarity</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-970"></a><span class="lineno"> 970</span> <span class="p">{</span>
<a name="c0-971"></a><span class="lineno"> 971</span>   <span class="k">if</span> <span class="p">((</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="n">ULONG_MAX</span><span class="p">)</span>
<a name="c0-972"></a><span class="lineno"> 972</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-973"></a><span class="lineno"> 973</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-974"></a><span class="lineno"> 974</span> <span class="p">}</span>
<a name="c0-975"></a><span class="lineno"> 975</span> 
<a name="c0-976"></a><span class="lineno"> 976</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_dissimilarity</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-977"></a><span class="lineno"> 977</span> <span class="p">{</span>
<a name="c0-978"></a><span class="lineno"> 978</span>   <span class="k">if</span> <span class="p">((</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">==</span> <span class="n">ULONG_MAX</span><span class="p">)</span>
<a name="c0-979"></a><span class="lineno"> 979</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-980"></a><span class="lineno"> 980</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-981"></a><span class="lineno"> 981</span> <span class="p">}</span>
<a name="c0-982"></a><span class="lineno"> 982</span> 
<a name="c0-983"></a><span class="lineno"> 983</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_index</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-984"></a><span class="lineno"> 984</span> <span class="p">{</span>
<a name="c0-985"></a><span class="lineno"> 985</span>   <span class="cm">/*</span>
<a name="c0-986"></a><span class="lineno"> 986</span> <span class="cm">  * index line is N hexadecimal, "..", N hexadecimal,</span>
<a name="c0-987"></a><span class="lineno"> 987</span> <span class="cm">  * and optional space with octal mode.</span>
<a name="c0-988"></a><span class="lineno"> 988</span> <span class="cm">  */</span>
<a name="c0-989"></a><span class="lineno"> 989</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">eol</span><span class="p">;</span>
<a name="c0-990"></a><span class="lineno"> 990</span>   <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-991"></a><span class="lineno"> 991</span> 
<a name="c0-992"></a><span class="lineno"> 992</span>   <span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">);</span>
<a name="c0-993"></a><span class="lineno"> 993</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span> <span class="o">||</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'.'</span> <span class="o">||</span> <span class="mi">40</span> <span class="o">&lt;</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">line</span><span class="p">)</span>
<a name="c0-994"></a><span class="lineno"> 994</span>     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-995"></a><span class="lineno"> 995</span>   <span class="n">len</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-996"></a><span class="lineno"> 996</span>   <span class="n">memcpy</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-997"></a><span class="lineno"> 997</span>   <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-998"></a><span class="lineno"> 998</span> 
<a name="c0-999"></a><span class="lineno"> 999</span>   <span class="n">line</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1000"></a><span class="lineno">1000</span>  <span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
<a name="c0-1001"></a><span class="lineno">1001</span>  <span class="n">eol</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-1002"></a><span class="lineno">1002</span> 
<a name="c0-1003"></a><span class="lineno">1003</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span> <span class="o">||</span> <span class="n">eol</span> <span class="o">&lt;</span> <span class="n">ptr</span><span class="p">)</span>
<a name="c0-1004"></a><span class="lineno">1004</span>    <span class="n">ptr</span> <span class="o">=</span> <span class="n">eol</span><span class="p">;</span>
<a name="c0-1005"></a><span class="lineno">1005</span>  <span class="n">len</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-1006"></a><span class="lineno">1006</span> 
<a name="c0-1007"></a><span class="lineno">1007</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">40</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-1008"></a><span class="lineno">1008</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1009"></a><span class="lineno">1009</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-1010"></a><span class="lineno">1010</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1011"></a><span class="lineno">1011</span>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span>
<a name="c0-1012"></a><span class="lineno">1012</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<a name="c0-1013"></a><span class="lineno">1013</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1014"></a><span class="lineno">1014</span> <span class="p">}</span>
<a name="c0-1015"></a><span class="lineno">1015</span> 
<a name="c0-1016"></a><span class="lineno">1016</span> <span class="cm">/*</span>
<a name="c0-1017"></a><span class="lineno">1017</span> <span class="cm"> * This is normal for a diff that doesn't change anything: we'll fall through</span>
<a name="c0-1018"></a><span class="lineno">1018</span> <span class="cm"> * into the next diff. Tell the parser to break out.</span>
<a name="c0-1019"></a><span class="lineno">1019</span> <span class="cm"> */</span>
<a name="c0-1020"></a><span class="lineno">1020</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">gitdiff_unrecognized</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1021"></a><span class="lineno">1021</span> <span class="p">{</span>
<a name="c0-1022"></a><span class="lineno">1022</span>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1023"></a><span class="lineno">1023</span> <span class="p">}</span>
<a name="c0-1024"></a><span class="lineno">1024</span> 
<a name="c0-1025"></a><span class="lineno">1025</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">stop_at_slash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">llen</span><span class="p">)</span>
<a name="c0-1026"></a><span class="lineno">1026</span> <span class="p">{</span>
<a name="c0-1027"></a><span class="lineno">1027</span>  <span class="kt">int</span> <span class="n">nslash</span> <span class="o">=</span> <span class="n">p_value</span><span class="p">;</span>
<a name="c0-1028"></a><span class="lineno">1028</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1029"></a><span class="lineno">1029</span> 
<a name="c0-1030"></a><span class="lineno">1030</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">llen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1031"></a><span class="lineno">1031</span>    <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-1032"></a><span class="lineno">1032</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">nslash</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1033"></a><span class="lineno">1033</span>      <span class="k">return</span> <span class="o">&amp;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-1034"></a><span class="lineno">1034</span>  <span class="p">}</span>
<a name="c0-1035"></a><span class="lineno">1035</span>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1036"></a><span class="lineno">1036</span> <span class="p">}</span>
<a name="c0-1037"></a><span class="lineno">1037</span> 
<a name="c0-1038"></a><span class="lineno">1038</span> <span class="cm">/*</span>
<a name="c0-1039"></a><span class="lineno">1039</span> <span class="cm"> * This is to extract the same name that appears on "diff --git"</span>
<a name="c0-1040"></a><span class="lineno">1040</span> <span class="cm"> * line.  We do not find and return anything if it is a rename</span>
<a name="c0-1041"></a><span class="lineno">1041</span> <span class="cm"> * patch, and it is OK because we will find the name elsewhere.</span>
<a name="c0-1042"></a><span class="lineno">1042</span> <span class="cm"> * We need to reliably find name only when it is mode-change only,</span>
<a name="c0-1043"></a><span class="lineno">1043</span> <span class="cm"> * creation or deletion of an empty file.  In any of these cases,</span>
<a name="c0-1044"></a><span class="lineno">1044</span> <span class="cm"> * both sides are the same name under a/ and b/ respectively.</span>
<a name="c0-1045"></a><span class="lineno">1045</span> <span class="cm"> */</span>
<a name="c0-1046"></a><span class="lineno">1046</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">git_header_name</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">llen</span><span class="p">)</span>
<a name="c0-1047"></a><span class="lineno">1047</span> <span class="p">{</span>
<a name="c0-1048"></a><span class="lineno">1048</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-1049"></a><span class="lineno">1049</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">second</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1050"></a><span class="lineno">1050</span>  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">line_len</span><span class="p">;</span>
<a name="c0-1051"></a><span class="lineno">1051</span> 
<a name="c0-1052"></a><span class="lineno">1052</span>  <span class="n">line</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"diff --git "</span><span class="p">);</span>
<a name="c0-1053"></a><span class="lineno">1053</span>  <span class="n">llen</span> <span class="o">-=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"diff --git "</span><span class="p">);</span>
<a name="c0-1054"></a><span class="lineno">1054</span> 
<a name="c0-1055"></a><span class="lineno">1055</span>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1056"></a><span class="lineno">1056</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
<a name="c0-1057"></a><span class="lineno">1057</span>    <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">first</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-1058"></a><span class="lineno">1058</span>    <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-1059"></a><span class="lineno">1059</span> 
<a name="c0-1060"></a><span class="lineno">1060</span>    <span class="k">if</span> <span class="p">(</span><span class="n">unquote_c_style</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">second</span><span class="p">))</span>
<a name="c0-1061"></a><span class="lineno">1061</span>      <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1062"></a><span class="lineno">1062</span> 
<a name="c0-1063"></a><span class="lineno">1063</span>    <span class="cm">/* advance to the first slash */</span>
<a name="c0-1064"></a><span class="lineno">1064</span>    <span class="n">cp</span> <span class="o">=</span> <span class="n">stop_at_slash</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">first</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<a name="c0-1065"></a><span class="lineno">1065</span>    <span class="cm">/* we do not accept absolute paths */</span>
<a name="c0-1066"></a><span class="lineno">1066</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span> <span class="o">||</span> <span class="n">cp</span> <span class="o">==</span> <span class="n">first</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-1067"></a><span class="lineno">1067</span>      <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1068"></a><span class="lineno">1068</span>    <span class="n">strbuf_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">first</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-1069"></a><span class="lineno">1069</span> 
<a name="c0-1070"></a><span class="lineno">1070</span>    <span class="cm">/*</span>
<a name="c0-1071"></a><span class="lineno">1071</span> <span class="cm">     * second points at one past closing dq of name.</span>
<a name="c0-1072"></a><span class="lineno">1072</span> <span class="cm">     * find the second name.</span>
<a name="c0-1073"></a><span class="lineno">1073</span> <span class="cm">     */</span>
<a name="c0-1074"></a><span class="lineno">1074</span>    <span class="k">while</span> <span class="p">((</span><span class="n">second</span> <span class="o">&lt;</span> <span class="n">line</span> <span class="o">+</span> <span class="n">llen</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">second</span><span class="p">))</span>
<a name="c0-1075"></a><span class="lineno">1075</span>      <span class="n">second</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1076"></a><span class="lineno">1076</span> 
<a name="c0-1077"></a><span class="lineno">1077</span>    <span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">llen</span> <span class="o">&lt;=</span> <span class="n">second</span><span class="p">)</span>
<a name="c0-1078"></a><span class="lineno">1078</span>      <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1079"></a><span class="lineno">1079</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">second</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1080"></a><span class="lineno">1080</span>      <span class="k">if</span> <span class="p">(</span><span class="n">unquote_c_style</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
<a name="c0-1081"></a><span class="lineno">1081</span>        <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1082"></a><span class="lineno">1082</span>      <span class="n">cp</span> <span class="o">=</span> <span class="n">stop_at_slash</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">sp</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<a name="c0-1083"></a><span class="lineno">1083</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span> <span class="o">||</span> <span class="n">cp</span> <span class="o">==</span> <span class="n">sp</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-1084"></a><span class="lineno">1084</span>        <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1085"></a><span class="lineno">1085</span>      <span class="cm">/* They must match, otherwise ignore */</span>
<a name="c0-1086"></a><span class="lineno">1086</span>      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first</span><span class="p">.</span><span class="n">buf</span><span class="p">))</span>
<a name="c0-1087"></a><span class="lineno">1087</span>        <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1088"></a><span class="lineno">1088</span>      <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>
<a name="c0-1089"></a><span class="lineno">1089</span>      <span class="k">return</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1090"></a><span class="lineno">1090</span>    <span class="p">}</span>
<a name="c0-1091"></a><span class="lineno">1091</span> 
<a name="c0-1092"></a><span class="lineno">1092</span>    <span class="cm">/* unquoted second */</span>
<a name="c0-1093"></a><span class="lineno">1093</span>    <span class="n">cp</span> <span class="o">=</span> <span class="n">stop_at_slash</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="n">llen</span> <span class="o">-</span> <span class="n">second</span><span class="p">);</span>
<a name="c0-1094"></a><span class="lineno">1094</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span> <span class="o">||</span> <span class="n">cp</span> <span class="o">==</span> <span class="n">second</span><span class="p">)</span>
<a name="c0-1095"></a><span class="lineno">1095</span>      <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1096"></a><span class="lineno">1096</span>    <span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1097"></a><span class="lineno">1097</span>    <span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">llen</span> <span class="o">-</span> <span class="n">cp</span> <span class="o">!=</span> <span class="n">first</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">||</span>
<a name="c0-1098"></a><span class="lineno">1098</span>        <span class="n">memcmp</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">first</span><span class="p">.</span><span class="n">len</span><span class="p">))</span>
<a name="c0-1099"></a><span class="lineno">1099</span>      <span class="k">goto</span> <span class="n">free_and_fail1</span><span class="p">;</span>
<a name="c0-1100"></a><span class="lineno">1100</span>    <span class="k">return</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1101"></a><span class="lineno">1101</span> 
<a name="c0-1102"></a><span class="lineno">1102</span>  <span class="nl">free_and_fail1:</span>
<a name="c0-1103"></a><span class="lineno">1103</span>    <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first</span><span class="p">);</span>
<a name="c0-1104"></a><span class="lineno">1104</span>    <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>
<a name="c0-1105"></a><span class="lineno">1105</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1106"></a><span class="lineno">1106</span>  <span class="p">}</span>
<a name="c0-1107"></a><span class="lineno">1107</span> 
<a name="c0-1108"></a><span class="lineno">1108</span>  <span class="cm">/* unquoted first name */</span>
<a name="c0-1109"></a><span class="lineno">1109</span>  <span class="n">name</span> <span class="o">=</span> <span class="n">stop_at_slash</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">llen</span><span class="p">);</span>
<a name="c0-1110"></a><span class="lineno">1110</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span> <span class="o">||</span> <span class="n">name</span> <span class="o">==</span> <span class="n">line</span><span class="p">)</span>
<a name="c0-1111"></a><span class="lineno">1111</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1112"></a><span class="lineno">1112</span>  <span class="n">name</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1113"></a><span class="lineno">1113</span> 
<a name="c0-1114"></a><span class="lineno">1114</span>  <span class="cm">/*</span>
<a name="c0-1115"></a><span class="lineno">1115</span> <span class="cm">   * since the first name is unquoted, a dq if exists must be</span>
<a name="c0-1116"></a><span class="lineno">1116</span> <span class="cm">   * the beginning of the second name.</span>
<a name="c0-1117"></a><span class="lineno">1117</span> <span class="cm">   */</span>
<a name="c0-1118"></a><span class="lineno">1118</span>  <span class="k">for</span> <span class="p">(</span><span class="n">second</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span> <span class="n">second</span> <span class="o">&lt;</span> <span class="n">line</span> <span class="o">+</span> <span class="n">llen</span><span class="p">;</span> <span class="n">second</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1119"></a><span class="lineno">1119</span>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">second</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1120"></a><span class="lineno">1120</span>      <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-1121"></a><span class="lineno">1121</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
<a name="c0-1122"></a><span class="lineno">1122</span> 
<a name="c0-1123"></a><span class="lineno">1123</span>      <span class="k">if</span> <span class="p">(</span><span class="n">unquote_c_style</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
<a name="c0-1124"></a><span class="lineno">1124</span>        <span class="k">goto</span> <span class="n">free_and_fail2</span><span class="p">;</span>
<a name="c0-1125"></a><span class="lineno">1125</span> 
<a name="c0-1126"></a><span class="lineno">1126</span>      <span class="n">np</span> <span class="o">=</span> <span class="n">stop_at_slash</span><span class="p">(</span><span class="n">sp</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">sp</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<a name="c0-1127"></a><span class="lineno">1127</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span> <span class="o">||</span> <span class="n">np</span> <span class="o">==</span> <span class="n">sp</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-1128"></a><span class="lineno">1128</span>        <span class="k">goto</span> <span class="n">free_and_fail2</span><span class="p">;</span>
<a name="c0-1129"></a><span class="lineno">1129</span>      <span class="n">np</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1130"></a><span class="lineno">1130</span> 
<a name="c0-1131"></a><span class="lineno">1131</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">sp</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">sp</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">np</span><span class="p">;</span>
<a name="c0-1132"></a><span class="lineno">1132</span>      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">second</span> <span class="o">-</span> <span class="n">name</span> <span class="o">&amp;&amp;</span>
<a name="c0-1133"></a><span class="lineno">1133</span>          <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-1134"></a><span class="lineno">1134</span>          <span class="n">isspace</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">]))</span> <span class="p">{</span>
<a name="c0-1135"></a><span class="lineno">1135</span>        <span class="cm">/* Good */</span>
<a name="c0-1136"></a><span class="lineno">1136</span>        <span class="n">strbuf_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span> <span class="o">-</span> <span class="n">sp</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-1137"></a><span class="lineno">1137</span>        <span class="k">return</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-1138"></a><span class="lineno">1138</span>      <span class="p">}</span>
<a name="c0-1139"></a><span class="lineno">1139</span> 
<a name="c0-1140"></a><span class="lineno">1140</span>    <span class="nl">free_and_fail2:</span>
<a name="c0-1141"></a><span class="lineno">1141</span>      <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>
<a name="c0-1142"></a><span class="lineno">1142</span>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1143"></a><span class="lineno">1143</span>    <span class="p">}</span>
<a name="c0-1144"></a><span class="lineno">1144</span>  <span class="p">}</span>
<a name="c0-1145"></a><span class="lineno">1145</span> 
<a name="c0-1146"></a><span class="lineno">1146</span>  <span class="cm">/*</span>
<a name="c0-1147"></a><span class="lineno">1147</span> <span class="cm">   * Accept a name only if it shows up twice, exactly the same</span>
<a name="c0-1148"></a><span class="lineno">1148</span> <span class="cm">   * form.</span>
<a name="c0-1149"></a><span class="lineno">1149</span> <span class="cm">   */</span>
<a name="c0-1150"></a><span class="lineno">1150</span>  <span class="n">second</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-1151"></a><span class="lineno">1151</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">second</span><span class="p">)</span>
<a name="c0-1152"></a><span class="lineno">1152</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1153"></a><span class="lineno">1153</span>  <span class="n">line_len</span> <span class="o">=</span> <span class="n">second</span> <span class="o">-</span> <span class="n">name</span><span class="p">;</span>
<a name="c0-1154"></a><span class="lineno">1154</span>  <span class="k">for</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="p">;</span> <span class="n">len</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1155"></a><span class="lineno">1155</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">])</span> <span class="p">{</span>
<a name="c0-1156"></a><span class="lineno">1156</span>    <span class="nl">default:</span>
<a name="c0-1157"></a><span class="lineno">1157</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1158"></a><span class="lineno">1158</span>    <span class="k">case</span> <span class="sc">'\n'</span>:
<a name="c0-1159"></a><span class="lineno">1159</span>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1160"></a><span class="lineno">1160</span>    <span class="k">case</span> <span class="sc">'\t'</span>: <span class="k">case</span> <span class="sc">' '</span>:
<a name="c0-1161"></a><span class="lineno">1161</span>      <span class="n">second</span> <span class="o">=</span> <span class="n">stop_at_slash</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">line_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-1162"></a><span class="lineno">1162</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">second</span><span class="p">)</span>
<a name="c0-1163"></a><span class="lineno">1163</span>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1164"></a><span class="lineno">1164</span>      <span class="n">second</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1165"></a><span class="lineno">1165</span>      <span class="k">if</span> <span class="p">(</span><span class="n">second</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1166"></a><span class="lineno">1166</span>        <span class="k">return</span> <span class="n">xmemdupz</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-1167"></a><span class="lineno">1167</span>      <span class="p">}</span>
<a name="c0-1168"></a><span class="lineno">1168</span>    <span class="p">}</span>
<a name="c0-1169"></a><span class="lineno">1169</span>  <span class="p">}</span>
<a name="c0-1170"></a><span class="lineno">1170</span> <span class="p">}</span>
<a name="c0-1171"></a><span class="lineno">1171</span> 
<a name="c0-1172"></a><span class="lineno">1172</span> <span class="cm">/* Verify that we recognize the lines following a git header */</span>
<a name="c0-1173"></a><span class="lineno">1173</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_git_header</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1174"></a><span class="lineno">1174</span> <span class="p">{</span>
<a name="c0-1175"></a><span class="lineno">1175</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1176"></a><span class="lineno">1176</span> 
<a name="c0-1177"></a><span class="lineno">1177</span>  <span class="cm">/* A git diff has explicit new/delete information, so we don't guess */</span>
<a name="c0-1178"></a><span class="lineno">1178</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1179"></a><span class="lineno">1179</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1180"></a><span class="lineno">1180</span> 
<a name="c0-1181"></a><span class="lineno">1181</span>  <span class="cm">/*</span>
<a name="c0-1182"></a><span class="lineno">1182</span> <span class="cm">   * Some things may not have the old name in the</span>
<a name="c0-1183"></a><span class="lineno">1183</span> <span class="cm">   * rest of the headers anywhere (pure mode changes,</span>
<a name="c0-1184"></a><span class="lineno">1184</span> <span class="cm">   * or removing or adding empty files), so we get</span>
<a name="c0-1185"></a><span class="lineno">1185</span> <span class="cm">   * the default name from the header.</span>
<a name="c0-1186"></a><span class="lineno">1186</span> <span class="cm">   */</span>
<a name="c0-1187"></a><span class="lineno">1187</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span> <span class="o">=</span> <span class="n">git_header_name</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-1188"></a><span class="lineno">1188</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span> <span class="o">&amp;&amp;</span> <span class="n">root</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1189"></a><span class="lineno">1189</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">root_len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-1190"></a><span class="lineno">1190</span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
<a name="c0-1191"></a><span class="lineno">1191</span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">root_len</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">);</span>
<a name="c0-1192"></a><span class="lineno">1192</span>    <span class="n">free</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">);</span>
<a name="c0-1193"></a><span class="lineno">1193</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<a name="c0-1194"></a><span class="lineno">1194</span>  <span class="p">}</span>
<a name="c0-1195"></a><span class="lineno">1195</span> 
<a name="c0-1196"></a><span class="lineno">1196</span>  <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1197"></a><span class="lineno">1197</span>  <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1198"></a><span class="lineno">1198</span>  <span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1199"></a><span class="lineno">1199</span>  <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">len</span> <span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">,</span> <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">,</span> <span class="n">linenr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1200"></a><span class="lineno">1200</span>    <span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">opentry</span> <span class="p">{</span>
<a name="c0-1201"></a><span class="lineno">1201</span>      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
<a name="c0-1202"></a><span class="lineno">1202</span>      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="p">);</span>
<a name="c0-1203"></a><span class="lineno">1203</span>    <span class="p">}</span> <span class="n">optable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c0-1204"></a><span class="lineno">1204</span>      <span class="p">{</span> <span class="s">"@@ -"</span><span class="p">,</span> <span class="n">gitdiff_hdrend</span> <span class="p">},</span>
<a name="c0-1205"></a><span class="lineno">1205</span>      <span class="p">{</span> <span class="s">"--- "</span><span class="p">,</span> <span class="n">gitdiff_oldname</span> <span class="p">},</span>
<a name="c0-1206"></a><span class="lineno">1206</span>      <span class="p">{</span> <span class="s">"+++ "</span><span class="p">,</span> <span class="n">gitdiff_newname</span> <span class="p">},</span>
<a name="c0-1207"></a><span class="lineno">1207</span>      <span class="p">{</span> <span class="s">"old mode "</span><span class="p">,</span> <span class="n">gitdiff_oldmode</span> <span class="p">},</span>
<a name="c0-1208"></a><span class="lineno">1208</span>      <span class="p">{</span> <span class="s">"new mode "</span><span class="p">,</span> <span class="n">gitdiff_newmode</span> <span class="p">},</span>
<a name="c0-1209"></a><span class="lineno">1209</span>      <span class="p">{</span> <span class="s">"deleted file mode "</span><span class="p">,</span> <span class="n">gitdiff_delete</span> <span class="p">},</span>
<a name="c0-1210"></a><span class="lineno">1210</span>      <span class="p">{</span> <span class="s">"new file mode "</span><span class="p">,</span> <span class="n">gitdiff_newfile</span> <span class="p">},</span>
<a name="c0-1211"></a><span class="lineno">1211</span>      <span class="p">{</span> <span class="s">"copy from "</span><span class="p">,</span> <span class="n">gitdiff_copysrc</span> <span class="p">},</span>
<a name="c0-1212"></a><span class="lineno">1212</span>      <span class="p">{</span> <span class="s">"copy to "</span><span class="p">,</span> <span class="n">gitdiff_copydst</span> <span class="p">},</span>
<a name="c0-1213"></a><span class="lineno">1213</span>      <span class="p">{</span> <span class="s">"rename old "</span><span class="p">,</span> <span class="n">gitdiff_renamesrc</span> <span class="p">},</span>
<a name="c0-1214"></a><span class="lineno">1214</span>      <span class="p">{</span> <span class="s">"rename new "</span><span class="p">,</span> <span class="n">gitdiff_renamedst</span> <span class="p">},</span>
<a name="c0-1215"></a><span class="lineno">1215</span>      <span class="p">{</span> <span class="s">"rename from "</span><span class="p">,</span> <span class="n">gitdiff_renamesrc</span> <span class="p">},</span>
<a name="c0-1216"></a><span class="lineno">1216</span>      <span class="p">{</span> <span class="s">"rename to "</span><span class="p">,</span> <span class="n">gitdiff_renamedst</span> <span class="p">},</span>
<a name="c0-1217"></a><span class="lineno">1217</span>      <span class="p">{</span> <span class="s">"similarity index "</span><span class="p">,</span> <span class="n">gitdiff_similarity</span> <span class="p">},</span>
<a name="c0-1218"></a><span class="lineno">1218</span>      <span class="p">{</span> <span class="s">"dissimilarity index "</span><span class="p">,</span> <span class="n">gitdiff_dissimilarity</span> <span class="p">},</span>
<a name="c0-1219"></a><span class="lineno">1219</span>      <span class="p">{</span> <span class="s">"index "</span><span class="p">,</span> <span class="n">gitdiff_index</span> <span class="p">},</span>
<a name="c0-1220"></a><span class="lineno">1220</span>      <span class="p">{</span> <span class="s">""</span><span class="p">,</span> <span class="n">gitdiff_unrecognized</span> <span class="p">},</span>
<a name="c0-1221"></a><span class="lineno">1221</span>    <span class="p">};</span>
<a name="c0-1222"></a><span class="lineno">1222</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1223"></a><span class="lineno">1223</span> 
<a name="c0-1224"></a><span class="lineno">1224</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1225"></a><span class="lineno">1225</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-1226"></a><span class="lineno">1226</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1227"></a><span class="lineno">1227</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">optable</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1228"></a><span class="lineno">1228</span>      <span class="k">const</span> <span class="k">struct</span> <span class="n">opentry</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">optable</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1229"></a><span class="lineno">1229</span>      <span class="kt">int</span> <span class="n">oplen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
<a name="c0-1230"></a><span class="lineno">1230</span>      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">oplen</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">oplen</span><span class="p">))</span>
<a name="c0-1231"></a><span class="lineno">1231</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c0-1232"></a><span class="lineno">1232</span>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">oplen</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1233"></a><span class="lineno">1233</span>        <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1234"></a><span class="lineno">1234</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1235"></a><span class="lineno">1235</span>    <span class="p">}</span>
<a name="c0-1236"></a><span class="lineno">1236</span>  <span class="p">}</span>
<a name="c0-1237"></a><span class="lineno">1237</span> 
<a name="c0-1238"></a><span class="lineno">1238</span>  <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1239"></a><span class="lineno">1239</span> <span class="p">}</span>
<a name="c0-1240"></a><span class="lineno">1240</span> 
<a name="c0-1241"></a><span class="lineno">1241</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_num</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="c0-1242"></a><span class="lineno">1242</span> <span class="p">{</span>
<a name="c0-1243"></a><span class="lineno">1243</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<a name="c0-1244"></a><span class="lineno">1244</span> 
<a name="c0-1245"></a><span class="lineno">1245</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">))</span>
<a name="c0-1246"></a><span class="lineno">1246</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1247"></a><span class="lineno">1247</span>  <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-1248"></a><span class="lineno">1248</span>  <span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-1249"></a><span class="lineno">1249</span> <span class="p">}</span>
<a name="c0-1250"></a><span class="lineno">1250</span> 
<a name="c0-1251"></a><span class="lineno">1251</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_range</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">expect</span><span class="p">,</span>
<a name="c0-1252"></a><span class="lineno">1252</span>           <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p2</span><span class="p">)</span>
<a name="c0-1253"></a><span class="lineno">1253</span> <span class="p">{</span>
<a name="c0-1254"></a><span class="lineno">1254</span>  <span class="kt">int</span> <span class="n">digits</span><span class="p">,</span> <span class="n">ex</span><span class="p">;</span>
<a name="c0-1255"></a><span class="lineno">1255</span> 
<a name="c0-1256"></a><span class="lineno">1256</span>  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-1257"></a><span class="lineno">1257</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1258"></a><span class="lineno">1258</span>  <span class="n">line</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1259"></a><span class="lineno">1259</span>  <span class="n">len</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1260"></a><span class="lineno">1260</span> 
<a name="c0-1261"></a><span class="lineno">1261</span>  <span class="n">digits</span> <span class="o">=</span> <span class="n">parse_num</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">p1</span><span class="p">);</span>
<a name="c0-1262"></a><span class="lineno">1262</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">digits</span><span class="p">)</span>
<a name="c0-1263"></a><span class="lineno">1263</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1264"></a><span class="lineno">1264</span> 
<a name="c0-1265"></a><span class="lineno">1265</span>  <span class="n">offset</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">;</span>
<a name="c0-1266"></a><span class="lineno">1266</span>  <span class="n">line</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">;</span>
<a name="c0-1267"></a><span class="lineno">1267</span>  <span class="n">len</span> <span class="o">-=</span> <span class="n">digits</span><span class="p">;</span>
<a name="c0-1268"></a><span class="lineno">1268</span> 
<a name="c0-1269"></a><span class="lineno">1269</span>  <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1270"></a><span class="lineno">1270</span>  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">','</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1271"></a><span class="lineno">1271</span>    <span class="n">digits</span> <span class="o">=</span> <span class="n">parse_num</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
<a name="c0-1272"></a><span class="lineno">1272</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">digits</span><span class="p">)</span>
<a name="c0-1273"></a><span class="lineno">1273</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1274"></a><span class="lineno">1274</span> 
<a name="c0-1275"></a><span class="lineno">1275</span>    <span class="n">offset</span> <span class="o">+=</span> <span class="n">digits</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1276"></a><span class="lineno">1276</span>    <span class="n">line</span> <span class="o">+=</span> <span class="n">digits</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1277"></a><span class="lineno">1277</span>    <span class="n">len</span> <span class="o">-=</span> <span class="n">digits</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1278"></a><span class="lineno">1278</span>  <span class="p">}</span>
<a name="c0-1279"></a><span class="lineno">1279</span> 
<a name="c0-1280"></a><span class="lineno">1280</span>  <span class="n">ex</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">expect</span><span class="p">);</span>
<a name="c0-1281"></a><span class="lineno">1281</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-1282"></a><span class="lineno">1282</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1283"></a><span class="lineno">1283</span>  <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">expect</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
<a name="c0-1284"></a><span class="lineno">1284</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1285"></a><span class="lineno">1285</span> 
<a name="c0-1286"></a><span class="lineno">1286</span>  <span class="k">return</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">ex</span><span class="p">;</span>
<a name="c0-1287"></a><span class="lineno">1287</span> <span class="p">}</span>
<a name="c0-1288"></a><span class="lineno">1288</span> 
<a name="c0-1289"></a><span class="lineno">1289</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">recount_diff</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">fragment</span><span class="p">)</span>
<a name="c0-1290"></a><span class="lineno">1290</span> <span class="p">{</span>
<a name="c0-1291"></a><span class="lineno">1291</span>  <span class="kt">int</span> <span class="n">oldlines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">newlines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1292"></a><span class="lineno">1292</span> 
<a name="c0-1293"></a><span class="lineno">1293</span>  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1294"></a><span class="lineno">1294</span>    <span class="n">warning</span><span class="p">(</span><span class="s">"recount: ignore empty hunk"</span><span class="p">);</span>
<a name="c0-1295"></a><span class="lineno">1295</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1296"></a><span class="lineno">1296</span>  <span class="p">}</span>
<a name="c0-1297"></a><span class="lineno">1297</span> 
<a name="c0-1298"></a><span class="lineno">1298</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-1299"></a><span class="lineno">1299</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1300"></a><span class="lineno">1300</span>    <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1301"></a><span class="lineno">1301</span>    <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1302"></a><span class="lineno">1302</span> 
<a name="c0-1303"></a><span class="lineno">1303</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-1304"></a><span class="lineno">1304</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1305"></a><span class="lineno">1305</span> 
<a name="c0-1306"></a><span class="lineno">1306</span>    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1307"></a><span class="lineno">1307</span>    <span class="k">case</span> <span class="sc">' '</span>: <span class="k">case</span> <span class="sc">'\n'</span>:
<a name="c0-1308"></a><span class="lineno">1308</span>      <span class="n">newlines</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1309"></a><span class="lineno">1309</span>      <span class="cm">/* fall through */</span>
<a name="c0-1310"></a><span class="lineno">1310</span>    <span class="k">case</span> <span class="sc">'-'</span>:
<a name="c0-1311"></a><span class="lineno">1311</span>      <span class="n">oldlines</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1312"></a><span class="lineno">1312</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1313"></a><span class="lineno">1313</span>    <span class="k">case</span> <span class="sc">'+'</span>:
<a name="c0-1314"></a><span class="lineno">1314</span>      <span class="n">newlines</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1315"></a><span class="lineno">1315</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1316"></a><span class="lineno">1316</span>    <span class="k">case</span> <span class="sc">'\\'</span>:
<a name="c0-1317"></a><span class="lineno">1317</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1318"></a><span class="lineno">1318</span>    <span class="k">case</span> <span class="sc">'@'</span>:
<a name="c0-1319"></a><span class="lineno">1319</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">prefixcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"@@ "</span><span class="p">);</span>
<a name="c0-1320"></a><span class="lineno">1320</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1321"></a><span class="lineno">1321</span>    <span class="k">case</span> <span class="sc">'d'</span>:
<a name="c0-1322"></a><span class="lineno">1322</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">prefixcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"diff "</span><span class="p">);</span>
<a name="c0-1323"></a><span class="lineno">1323</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1324"></a><span class="lineno">1324</span>    <span class="nl">default:</span>
<a name="c0-1325"></a><span class="lineno">1325</span>      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1326"></a><span class="lineno">1326</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1327"></a><span class="lineno">1327</span>    <span class="p">}</span>
<a name="c0-1328"></a><span class="lineno">1328</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1329"></a><span class="lineno">1329</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"recount: unexpected line: %.*s"</span><span class="p">,</span>
<a name="c0-1330"></a><span class="lineno">1330</span>        <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-1331"></a><span class="lineno">1331</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-1332"></a><span class="lineno">1332</span>    <span class="p">}</span>
<a name="c0-1333"></a><span class="lineno">1333</span>    <span class="k">break</span><span class="p">;</span>
<a name="c0-1334"></a><span class="lineno">1334</span>  <span class="p">}</span>
<a name="c0-1335"></a><span class="lineno">1335</span>  <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">oldlines</span> <span class="o">=</span> <span class="n">oldlines</span><span class="p">;</span>
<a name="c0-1336"></a><span class="lineno">1336</span>  <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">newlines</span> <span class="o">=</span> <span class="n">newlines</span><span class="p">;</span>
<a name="c0-1337"></a><span class="lineno">1337</span> <span class="p">}</span>
<a name="c0-1338"></a><span class="lineno">1338</span> 
<a name="c0-1339"></a><span class="lineno">1339</span> <span class="cm">/*</span>
<a name="c0-1340"></a><span class="lineno">1340</span> <span class="cm"> * Parse a unified diff fragment header of the</span>
<a name="c0-1341"></a><span class="lineno">1341</span> <span class="cm"> * form "@@ -a,b +c,d @@"</span>
<a name="c0-1342"></a><span class="lineno">1342</span> <span class="cm"> */</span>
<a name="c0-1343"></a><span class="lineno">1343</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_fragment_header</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">fragment</span><span class="p">)</span>
<a name="c0-1344"></a><span class="lineno">1344</span> <span class="p">{</span>
<a name="c0-1345"></a><span class="lineno">1345</span>  <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1346"></a><span class="lineno">1346</span> 
<a name="c0-1347"></a><span class="lineno">1347</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-1348"></a><span class="lineno">1348</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1349"></a><span class="lineno">1349</span> 
<a name="c0-1350"></a><span class="lineno">1350</span>  <span class="cm">/* Figure out the number of lines in a fragment */</span>
<a name="c0-1351"></a><span class="lineno">1351</span>  <span class="n">offset</span> <span class="o">=</span> <span class="n">parse_range</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">" +"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">oldpos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">oldlines</span><span class="p">);</span>
<a name="c0-1352"></a><span class="lineno">1352</span>  <span class="n">offset</span> <span class="o">=</span> <span class="n">parse_range</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="s">" @@"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">newpos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">newlines</span><span class="p">);</span>
<a name="c0-1353"></a><span class="lineno">1353</span> 
<a name="c0-1354"></a><span class="lineno">1354</span>  <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1355"></a><span class="lineno">1355</span> <span class="p">}</span>
<a name="c0-1356"></a><span class="lineno">1356</span> 
<a name="c0-1357"></a><span class="lineno">1357</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">find_header</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hdrsize</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1358"></a><span class="lineno">1358</span> <span class="p">{</span>
<a name="c0-1359"></a><span class="lineno">1359</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1360"></a><span class="lineno">1360</span> 
<a name="c0-1361"></a><span class="lineno">1361</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_toplevel_relative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1362"></a><span class="lineno">1362</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1363"></a><span class="lineno">1363</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1364"></a><span class="lineno">1364</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1365"></a><span class="lineno">1365</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1366"></a><span class="lineno">1366</span>  <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">,</span> <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">,</span> <span class="n">linenr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1367"></a><span class="lineno">1367</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nextlen</span><span class="p">;</span>
<a name="c0-1368"></a><span class="lineno">1368</span> 
<a name="c0-1369"></a><span class="lineno">1369</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1370"></a><span class="lineno">1370</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c0-1371"></a><span class="lineno">1371</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1372"></a><span class="lineno">1372</span> 
<a name="c0-1373"></a><span class="lineno">1373</span>    <span class="cm">/* Testing this early allows us to take a few shortcuts.. */</span>
<a name="c0-1374"></a><span class="lineno">1374</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
<a name="c0-1375"></a><span class="lineno">1375</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1376"></a><span class="lineno">1376</span> 
<a name="c0-1377"></a><span class="lineno">1377</span>    <span class="cm">/*</span>
<a name="c0-1378"></a><span class="lineno">1378</span> <span class="cm">     * Make sure we don't find any unconnected patch fragments.</span>
<a name="c0-1379"></a><span class="lineno">1379</span> <span class="cm">     * That's a sign that we didn't find a header, and that a</span>
<a name="c0-1380"></a><span class="lineno">1380</span> <span class="cm">     * patch has become corrupted/broken up.</span>
<a name="c0-1381"></a><span class="lineno">1381</span> <span class="cm">     */</span>
<a name="c0-1382"></a><span class="lineno">1382</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="s">"@@ -"</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1383"></a><span class="lineno">1383</span>      <span class="k">struct</span> <span class="n">fragment</span> <span class="n">dummy</span><span class="p">;</span>
<a name="c0-1384"></a><span class="lineno">1384</span>      <span class="k">if</span> <span class="p">(</span><span class="n">parse_fragment_header</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1385"></a><span class="lineno">1385</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c0-1386"></a><span class="lineno">1386</span>      <span class="n">die</span><span class="p">(</span><span class="s">"patch fragment without header at line %d: %.*s"</span><span class="p">,</span>
<a name="c0-1387"></a><span class="lineno">1387</span>          <span class="n">linenr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-1388"></a><span class="lineno">1388</span>    <span class="p">}</span>
<a name="c0-1389"></a><span class="lineno">1389</span> 
<a name="c0-1390"></a><span class="lineno">1390</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
<a name="c0-1391"></a><span class="lineno">1391</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1392"></a><span class="lineno">1392</span> 
<a name="c0-1393"></a><span class="lineno">1393</span>    <span class="cm">/*</span>
<a name="c0-1394"></a><span class="lineno">1394</span> <span class="cm">     * Git patch? It might not have a real patch, just a rename</span>
<a name="c0-1395"></a><span class="lineno">1395</span> <span class="cm">     * or mode change, so we handle that specially</span>
<a name="c0-1396"></a><span class="lineno">1396</span> <span class="cm">     */</span>
<a name="c0-1397"></a><span class="lineno">1397</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="s">"diff --git "</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1398"></a><span class="lineno">1398</span>      <span class="kt">int</span> <span class="n">git_hdr_len</span> <span class="o">=</span> <span class="n">parse_git_header</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-1399"></a><span class="lineno">1399</span>      <span class="k">if</span> <span class="p">(</span><span class="n">git_hdr_len</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span>
<a name="c0-1400"></a><span class="lineno">1400</span>        <span class="k">continue</span><span class="p">;</span>
<a name="c0-1401"></a><span class="lineno">1401</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1402"></a><span class="lineno">1402</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">)</span>
<a name="c0-1403"></a><span class="lineno">1403</span>          <span class="n">die</span><span class="p">(</span><span class="s">"git diff header lacks filename information when removing "</span>
<a name="c0-1404"></a><span class="lineno">1404</span>              <span class="s">"%d leading pathname components (line %d)"</span> <span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-1405"></a><span class="lineno">1405</span>        <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">def_name</span><span class="p">;</span>
<a name="c0-1406"></a><span class="lineno">1406</span>      <span class="p">}</span>
<a name="c0-1407"></a><span class="lineno">1407</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">)</span>
<a name="c0-1408"></a><span class="lineno">1408</span>        <span class="n">die</span><span class="p">(</span><span class="s">"git diff header lacks filename information "</span>
<a name="c0-1409"></a><span class="lineno">1409</span>            <span class="s">"(line %d)"</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-1410"></a><span class="lineno">1410</span>      <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_toplevel_relative</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1411"></a><span class="lineno">1411</span>      <span class="o">*</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="n">git_hdr_len</span><span class="p">;</span>
<a name="c0-1412"></a><span class="lineno">1412</span>      <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1413"></a><span class="lineno">1413</span>    <span class="p">}</span>
<a name="c0-1414"></a><span class="lineno">1414</span> 
<a name="c0-1415"></a><span class="lineno">1415</span>    <span class="cm">/* --- followed by +++ ? */</span>
<a name="c0-1416"></a><span class="lineno">1416</span>    <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="s">"--- "</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="s">"+++ "</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a name="c0-1417"></a><span class="lineno">1417</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1418"></a><span class="lineno">1418</span> 
<a name="c0-1419"></a><span class="lineno">1419</span>    <span class="cm">/*</span>
<a name="c0-1420"></a><span class="lineno">1420</span> <span class="cm">     * We only accept unified patches, so we want it to</span>
<a name="c0-1421"></a><span class="lineno">1421</span> <span class="cm">     * at least have "@@ -a,b +c,d @@\n", which is 14 chars</span>
<a name="c0-1422"></a><span class="lineno">1422</span> <span class="cm">     * minimum ("@@ -0,0 +1 @@\n" is the shortest).</span>
<a name="c0-1423"></a><span class="lineno">1423</span> <span class="cm">     */</span>
<a name="c0-1424"></a><span class="lineno">1424</span>    <span class="n">nextlen</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-1425"></a><span class="lineno">1425</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">nextlen</span> <span class="o">+</span> <span class="mi">14</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="s">"@@ -"</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="n">nextlen</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a name="c0-1426"></a><span class="lineno">1426</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-1427"></a><span class="lineno">1427</span> 
<a name="c0-1428"></a><span class="lineno">1428</span>    <span class="cm">/* Ok, we'll consider it a patch */</span>
<a name="c0-1429"></a><span class="lineno">1429</span>    <span class="n">parse_traditional_patch</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">line</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-1430"></a><span class="lineno">1430</span>    <span class="o">*</span><span class="n">hdrsize</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">nextlen</span><span class="p">;</span>
<a name="c0-1431"></a><span class="lineno">1431</span>    <span class="n">linenr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c0-1432"></a><span class="lineno">1432</span>    <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1433"></a><span class="lineno">1433</span>  <span class="p">}</span>
<a name="c0-1434"></a><span class="lineno">1434</span>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1435"></a><span class="lineno">1435</span> <span class="p">}</span>
<a name="c0-1436"></a><span class="lineno">1436</span> 
<a name="c0-1437"></a><span class="lineno">1437</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">record_ws_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">result</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">linenr</span><span class="p">)</span>
<a name="c0-1438"></a><span class="lineno">1438</span> <span class="p">{</span>
<a name="c0-1439"></a><span class="lineno">1439</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
<a name="c0-1440"></a><span class="lineno">1440</span> 
<a name="c0-1441"></a><span class="lineno">1441</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
<a name="c0-1442"></a><span class="lineno">1442</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1443"></a><span class="lineno">1443</span> 
<a name="c0-1444"></a><span class="lineno">1444</span>  <span class="n">whitespace_error</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1445"></a><span class="lineno">1445</span>  <span class="k">if</span> <span class="p">(</span><span class="n">squelch_whitespace_errors</span> <span class="o">&amp;&amp;</span>
<a name="c0-1446"></a><span class="lineno">1446</span>      <span class="n">squelch_whitespace_errors</span> <span class="o">&lt;</span> <span class="n">whitespace_error</span><span class="p">)</span>
<a name="c0-1447"></a><span class="lineno">1447</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1448"></a><span class="lineno">1448</span> 
<a name="c0-1449"></a><span class="lineno">1449</span>  <span class="n">err</span> <span class="o">=</span> <span class="n">whitespace_error_string</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<a name="c0-1450"></a><span class="lineno">1450</span>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s:%d: %s.</span><span class="se">\n</span><span class="s">%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-1451"></a><span class="lineno">1451</span>    <span class="n">patch_input_file</span><span class="p">,</span> <span class="n">linenr</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<a name="c0-1452"></a><span class="lineno">1452</span>  <span class="n">free</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<a name="c0-1453"></a><span class="lineno">1453</span> <span class="p">}</span>
<a name="c0-1454"></a><span class="lineno">1454</span> 
<a name="c0-1455"></a><span class="lineno">1455</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">check_whitespace</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ws_rule</span><span class="p">)</span>
<a name="c0-1456"></a><span class="lineno">1456</span> <span class="p">{</span>
<a name="c0-1457"></a><span class="lineno">1457</span>  <span class="kt">unsigned</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ws_check</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">);</span>
<a name="c0-1458"></a><span class="lineno">1458</span> 
<a name="c0-1459"></a><span class="lineno">1459</span>  <span class="n">record_ws_error</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-1460"></a><span class="lineno">1460</span> <span class="p">}</span>
<a name="c0-1461"></a><span class="lineno">1461</span> 
<a name="c0-1462"></a><span class="lineno">1462</span> <span class="cm">/*</span>
<a name="c0-1463"></a><span class="lineno">1463</span> <span class="cm"> * Parse a unified diff. Note that this really needs to parse each</span>
<a name="c0-1464"></a><span class="lineno">1464</span> <span class="cm"> * fragment separately, since the only way to know the difference</span>
<a name="c0-1465"></a><span class="lineno">1465</span> <span class="cm"> * between a "---" that is part of a patch, and a "---" that starts</span>
<a name="c0-1466"></a><span class="lineno">1466</span> <span class="cm"> * the next patch is to look at the line counts..</span>
<a name="c0-1467"></a><span class="lineno">1467</span> <span class="cm"> */</span>
<a name="c0-1468"></a><span class="lineno">1468</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_fragment</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
<a name="c0-1469"></a><span class="lineno">1469</span>        <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">fragment</span><span class="p">)</span>
<a name="c0-1470"></a><span class="lineno">1470</span> <span class="p">{</span>
<a name="c0-1471"></a><span class="lineno">1471</span>  <span class="kt">int</span> <span class="n">added</span><span class="p">,</span> <span class="n">deleted</span><span class="p">;</span>
<a name="c0-1472"></a><span class="lineno">1472</span>  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1473"></a><span class="lineno">1473</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldlines</span><span class="p">,</span> <span class="n">newlines</span><span class="p">;</span>
<a name="c0-1474"></a><span class="lineno">1474</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">leading</span><span class="p">,</span> <span class="n">trailing</span><span class="p">;</span>
<a name="c0-1475"></a><span class="lineno">1475</span> 
<a name="c0-1476"></a><span class="lineno">1476</span>  <span class="n">offset</span> <span class="o">=</span> <span class="n">parse_fragment_header</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fragment</span><span class="p">);</span>
<a name="c0-1477"></a><span class="lineno">1477</span>  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1478"></a><span class="lineno">1478</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1479"></a><span class="lineno">1479</span>  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">recount</span><span class="p">)</span>
<a name="c0-1480"></a><span class="lineno">1480</span>    <span class="n">recount_diff</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">fragment</span><span class="p">);</span>
<a name="c0-1481"></a><span class="lineno">1481</span>  <span class="n">oldlines</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">oldlines</span><span class="p">;</span>
<a name="c0-1482"></a><span class="lineno">1482</span>  <span class="n">newlines</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">newlines</span><span class="p">;</span>
<a name="c0-1483"></a><span class="lineno">1483</span>  <span class="n">leading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1484"></a><span class="lineno">1484</span>  <span class="n">trailing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1485"></a><span class="lineno">1485</span> 
<a name="c0-1486"></a><span class="lineno">1486</span>  <span class="cm">/* Parse the thing.. */</span>
<a name="c0-1487"></a><span class="lineno">1487</span>  <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1488"></a><span class="lineno">1488</span>  <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1489"></a><span class="lineno">1489</span>  <span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1490"></a><span class="lineno">1490</span>  <span class="n">added</span> <span class="o">=</span> <span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1491"></a><span class="lineno">1491</span>  <span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1492"></a><span class="lineno">1492</span>       <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-1493"></a><span class="lineno">1493</span>       <span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">,</span> <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">,</span> <span class="n">linenr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1494"></a><span class="lineno">1494</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldlines</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">newlines</span><span class="p">)</span>
<a name="c0-1495"></a><span class="lineno">1495</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1496"></a><span class="lineno">1496</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1497"></a><span class="lineno">1497</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-1498"></a><span class="lineno">1498</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1499"></a><span class="lineno">1499</span>    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1500"></a><span class="lineno">1500</span>    <span class="nl">default:</span>
<a name="c0-1501"></a><span class="lineno">1501</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1502"></a><span class="lineno">1502</span>    <span class="k">case</span> <span class="sc">'\n'</span>: <span class="cm">/* newer GNU diff, an empty context line */</span>
<a name="c0-1503"></a><span class="lineno">1503</span>    <span class="k">case</span> <span class="sc">' '</span>:
<a name="c0-1504"></a><span class="lineno">1504</span>      <span class="n">oldlines</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1505"></a><span class="lineno">1505</span>      <span class="n">newlines</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1506"></a><span class="lineno">1506</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deleted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">added</span><span class="p">)</span>
<a name="c0-1507"></a><span class="lineno">1507</span>        <span class="n">leading</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1508"></a><span class="lineno">1508</span>      <span class="n">trailing</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1509"></a><span class="lineno">1509</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1510"></a><span class="lineno">1510</span>    <span class="k">case</span> <span class="sc">'-'</span>:
<a name="c0-1511"></a><span class="lineno">1511</span>      <span class="k">if</span> <span class="p">(</span><span class="n">apply_in_reverse</span> <span class="o">&amp;&amp;</span>
<a name="c0-1512"></a><span class="lineno">1512</span>          <span class="n">ws_error_action</span> <span class="o">!=</span> <span class="n">nowarn_ws_error</span><span class="p">)</span>
<a name="c0-1513"></a><span class="lineno">1513</span>        <span class="n">check_whitespace</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">ws_rule</span><span class="p">);</span>
<a name="c0-1514"></a><span class="lineno">1514</span>      <span class="n">deleted</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1515"></a><span class="lineno">1515</span>      <span class="n">oldlines</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1516"></a><span class="lineno">1516</span>      <span class="n">trailing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1517"></a><span class="lineno">1517</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1518"></a><span class="lineno">1518</span>    <span class="k">case</span> <span class="sc">'+'</span>:
<a name="c0-1519"></a><span class="lineno">1519</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apply_in_reverse</span> <span class="o">&amp;&amp;</span>
<a name="c0-1520"></a><span class="lineno">1520</span>          <span class="n">ws_error_action</span> <span class="o">!=</span> <span class="n">nowarn_ws_error</span><span class="p">)</span>
<a name="c0-1521"></a><span class="lineno">1521</span>        <span class="n">check_whitespace</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">ws_rule</span><span class="p">);</span>
<a name="c0-1522"></a><span class="lineno">1522</span>      <span class="n">added</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1523"></a><span class="lineno">1523</span>      <span class="n">newlines</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1524"></a><span class="lineno">1524</span>      <span class="n">trailing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1525"></a><span class="lineno">1525</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1526"></a><span class="lineno">1526</span> 
<a name="c0-1527"></a><span class="lineno">1527</span>    <span class="cm">/*</span>
<a name="c0-1528"></a><span class="lineno">1528</span> <span class="cm">     * We allow "\ No newline at end of file". Depending</span>
<a name="c0-1529"></a><span class="lineno">1529</span> <span class="cm">                 * on locale settings when the patch was produced we</span>
<a name="c0-1530"></a><span class="lineno">1530</span> <span class="cm">                 * don't know what this line looks like. The only</span>
<a name="c0-1531"></a><span class="lineno">1531</span> <span class="cm">                 * thing we do know is that it begins with "\ ".</span>
<a name="c0-1532"></a><span class="lineno">1532</span> <span class="cm">     * Checking for 12 is just for sanity check -- any</span>
<a name="c0-1533"></a><span class="lineno">1533</span> <span class="cm">     * l10n of "\ No newline..." is at least that long.</span>
<a name="c0-1534"></a><span class="lineno">1534</span> <span class="cm">     */</span>
<a name="c0-1535"></a><span class="lineno">1535</span>    <span class="k">case</span> <span class="sc">'\\'</span>:
<a name="c0-1536"></a><span class="lineno">1536</span>      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s"> "</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="c0-1537"></a><span class="lineno">1537</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1538"></a><span class="lineno">1538</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1539"></a><span class="lineno">1539</span>    <span class="p">}</span>
<a name="c0-1540"></a><span class="lineno">1540</span>  <span class="p">}</span>
<a name="c0-1541"></a><span class="lineno">1541</span>  <span class="k">if</span> <span class="p">(</span><span class="n">oldlines</span> <span class="o">||</span> <span class="n">newlines</span><span class="p">)</span>
<a name="c0-1542"></a><span class="lineno">1542</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1543"></a><span class="lineno">1543</span>  <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">leading</span> <span class="o">=</span> <span class="n">leading</span><span class="p">;</span>
<a name="c0-1544"></a><span class="lineno">1544</span>  <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">trailing</span> <span class="o">=</span> <span class="n">trailing</span><span class="p">;</span>
<a name="c0-1545"></a><span class="lineno">1545</span> 
<a name="c0-1546"></a><span class="lineno">1546</span>  <span class="cm">/*</span>
<a name="c0-1547"></a><span class="lineno">1547</span> <span class="cm">   * If a fragment ends with an incomplete line, we failed to include</span>
<a name="c0-1548"></a><span class="lineno">1548</span> <span class="cm">   * it in the above loop because we hit oldlines == newlines == 0</span>
<a name="c0-1549"></a><span class="lineno">1549</span> <span class="cm">   * before seeing it.</span>
<a name="c0-1550"></a><span class="lineno">1550</span> <span class="cm">   */</span>
<a name="c0-1551"></a><span class="lineno">1551</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">12</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"</span><span class="se">\\</span><span class="s"> "</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="c0-1552"></a><span class="lineno">1552</span>    <span class="n">offset</span> <span class="o">+=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1553"></a><span class="lineno">1553</span> 
<a name="c0-1554"></a><span class="lineno">1554</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span> <span class="o">+=</span> <span class="n">added</span><span class="p">;</span>
<a name="c0-1555"></a><span class="lineno">1555</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span> <span class="o">+=</span> <span class="n">deleted</span><span class="p">;</span>
<a name="c0-1556"></a><span class="lineno">1556</span> 
<a name="c0-1557"></a><span class="lineno">1557</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&amp;&amp;</span> <span class="n">oldlines</span><span class="p">)</span>
<a name="c0-1558"></a><span class="lineno">1558</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"new file depends on old contents"</span><span class="p">);</span>
<a name="c0-1559"></a><span class="lineno">1559</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&amp;&amp;</span> <span class="n">newlines</span><span class="p">)</span>
<a name="c0-1560"></a><span class="lineno">1560</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"deleted file still has contents"</span><span class="p">);</span>
<a name="c0-1561"></a><span class="lineno">1561</span>  <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1562"></a><span class="lineno">1562</span> <span class="p">}</span>
<a name="c0-1563"></a><span class="lineno">1563</span> 
<a name="c0-1564"></a><span class="lineno">1564</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_single_patch</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1565"></a><span class="lineno">1565</span> <span class="p">{</span>
<a name="c0-1566"></a><span class="lineno">1566</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1567"></a><span class="lineno">1567</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oldlines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">newlines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1568"></a><span class="lineno">1568</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">**</span><span class="n">fragp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">;</span>
<a name="c0-1569"></a><span class="lineno">1569</span> 
<a name="c0-1570"></a><span class="lineno">1570</span>  <span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">"@@ -"</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1571"></a><span class="lineno">1571</span>    <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">fragment</span><span class="p">;</span>
<a name="c0-1572"></a><span class="lineno">1572</span>    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1573"></a><span class="lineno">1573</span> 
<a name="c0-1574"></a><span class="lineno">1574</span>    <span class="n">fragment</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fragment</span><span class="p">));</span>
<a name="c0-1575"></a><span class="lineno">1575</span>    <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">linenr</span> <span class="o">=</span> <span class="n">linenr</span><span class="p">;</span>
<a name="c0-1576"></a><span class="lineno">1576</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">parse_fragment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">fragment</span><span class="p">);</span>
<a name="c0-1577"></a><span class="lineno">1577</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1578"></a><span class="lineno">1578</span>      <span class="n">die</span><span class="p">(</span><span class="s">"corrupt patch at line %d"</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-1579"></a><span class="lineno">1579</span>    <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">patch</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-1580"></a><span class="lineno">1580</span>    <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1581"></a><span class="lineno">1581</span>    <span class="n">oldlines</span> <span class="o">+=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">oldlines</span><span class="p">;</span>
<a name="c0-1582"></a><span class="lineno">1582</span>    <span class="n">newlines</span> <span class="o">+=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">newlines</span><span class="p">;</span>
<a name="c0-1583"></a><span class="lineno">1583</span>    <span class="n">context</span> <span class="o">+=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">leading</span> <span class="o">+</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">trailing</span><span class="p">;</span>
<a name="c0-1584"></a><span class="lineno">1584</span> 
<a name="c0-1585"></a><span class="lineno">1585</span>    <span class="o">*</span><span class="n">fragp</span> <span class="o">=</span> <span class="n">fragment</span><span class="p">;</span>
<a name="c0-1586"></a><span class="lineno">1586</span>    <span class="n">fragp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-1587"></a><span class="lineno">1587</span> 
<a name="c0-1588"></a><span class="lineno">1588</span>    <span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1589"></a><span class="lineno">1589</span>    <span class="n">line</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1590"></a><span class="lineno">1590</span>    <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-1591"></a><span class="lineno">1591</span>  <span class="p">}</span>
<a name="c0-1592"></a><span class="lineno">1592</span> 
<a name="c0-1593"></a><span class="lineno">1593</span>  <span class="cm">/*</span>
<a name="c0-1594"></a><span class="lineno">1594</span> <span class="cm">   * If something was removed (i.e. we have old-lines) it cannot</span>
<a name="c0-1595"></a><span class="lineno">1595</span> <span class="cm">   * be creation, and if something was added it cannot be</span>
<a name="c0-1596"></a><span class="lineno">1596</span> <span class="cm">   * deletion.  However, the reverse is not true; --unified=0</span>
<a name="c0-1597"></a><span class="lineno">1597</span> <span class="cm">   * patches that only add are not necessarily creation even</span>
<a name="c0-1598"></a><span class="lineno">1598</span> <span class="cm">   * though they do not have any old lines, and ones that only</span>
<a name="c0-1599"></a><span class="lineno">1599</span> <span class="cm">   * delete are not necessarily deletion.</span>
<a name="c0-1600"></a><span class="lineno">1600</span> <span class="cm">   *</span>
<a name="c0-1601"></a><span class="lineno">1601</span> <span class="cm">   * Unfortunately, a real creation/deletion patch do _not_ have</span>
<a name="c0-1602"></a><span class="lineno">1602</span> <span class="cm">   * any context line by definition, so we cannot safely tell it</span>
<a name="c0-1603"></a><span class="lineno">1603</span> <span class="cm">   * apart with --unified=0 insanity.  At least if the patch has</span>
<a name="c0-1604"></a><span class="lineno">1604</span> <span class="cm">   * more than one hunk it is not creation or deletion.</span>
<a name="c0-1605"></a><span class="lineno">1605</span> <span class="cm">   */</span>
<a name="c0-1606"></a><span class="lineno">1606</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-1607"></a><span class="lineno">1607</span>      <span class="p">(</span><span class="n">oldlines</span> <span class="o">||</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)))</span>
<a name="c0-1608"></a><span class="lineno">1608</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1609"></a><span class="lineno">1609</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-1610"></a><span class="lineno">1610</span>      <span class="p">(</span><span class="n">newlines</span> <span class="o">||</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)))</span>
<a name="c0-1611"></a><span class="lineno">1611</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1612"></a><span class="lineno">1612</span> 
<a name="c0-1613"></a><span class="lineno">1613</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&amp;&amp;</span> <span class="n">oldlines</span><span class="p">)</span>
<a name="c0-1614"></a><span class="lineno">1614</span>    <span class="n">die</span><span class="p">(</span><span class="s">"new file %s depends on old contents"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-1615"></a><span class="lineno">1615</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&amp;&amp;</span> <span class="n">newlines</span><span class="p">)</span>
<a name="c0-1616"></a><span class="lineno">1616</span>    <span class="n">die</span><span class="p">(</span><span class="s">"deleted file %s still has contents"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-1617"></a><span class="lineno">1617</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">newlines</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="p">)</span>
<a name="c0-1618"></a><span class="lineno">1618</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"** warning: file %s becomes empty but "</span>
<a name="c0-1619"></a><span class="lineno">1619</span>      <span class="s">"is not deleted</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-1620"></a><span class="lineno">1620</span> 
<a name="c0-1621"></a><span class="lineno">1621</span>  <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1622"></a><span class="lineno">1622</span> <span class="p">}</span>
<a name="c0-1623"></a><span class="lineno">1623</span> 
<a name="c0-1624"></a><span class="lineno">1624</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">metadata_changes</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1625"></a><span class="lineno">1625</span> <span class="p">{</span>
<a name="c0-1626"></a><span class="lineno">1626</span>  <span class="k">return</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
<a name="c0-1627"></a><span class="lineno">1627</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
<a name="c0-1628"></a><span class="lineno">1628</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
<a name="c0-1629"></a><span class="lineno">1629</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">||</span>
<a name="c0-1630"></a><span class="lineno">1630</span>    <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">&amp;&amp;</span>
<a name="c0-1631"></a><span class="lineno">1631</span>     <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">!=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">);</span>
<a name="c0-1632"></a><span class="lineno">1632</span> <span class="p">}</span>
<a name="c0-1633"></a><span class="lineno">1633</span> 
<a name="c0-1634"></a><span class="lineno">1634</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">inflate_it</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
<a name="c0-1635"></a><span class="lineno">1635</span>      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">inflated_size</span><span class="p">)</span>
<a name="c0-1636"></a><span class="lineno">1636</span> <span class="p">{</span>
<a name="c0-1637"></a><span class="lineno">1637</span>  <span class="n">git_zstream</span> <span class="n">stream</span><span class="p">;</span>
<a name="c0-1638"></a><span class="lineno">1638</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">out</span><span class="p">;</span>
<a name="c0-1639"></a><span class="lineno">1639</span>  <span class="kt">int</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-1640"></a><span class="lineno">1640</span> 
<a name="c0-1641"></a><span class="lineno">1641</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span>
<a name="c0-1642"></a><span class="lineno">1642</span> 
<a name="c0-1643"></a><span class="lineno">1643</span>  <span class="n">stream</span><span class="p">.</span><span class="n">next_in</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<a name="c0-1644"></a><span class="lineno">1644</span>  <span class="n">stream</span><span class="p">.</span><span class="n">avail_in</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-1645"></a><span class="lineno">1645</span>  <span class="n">stream</span><span class="p">.</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">inflated_size</span><span class="p">);</span>
<a name="c0-1646"></a><span class="lineno">1646</span>  <span class="n">stream</span><span class="p">.</span><span class="n">avail_out</span> <span class="o">=</span> <span class="n">inflated_size</span><span class="p">;</span>
<a name="c0-1647"></a><span class="lineno">1647</span>  <span class="n">git_inflate_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
<a name="c0-1648"></a><span class="lineno">1648</span>  <span class="n">st</span> <span class="o">=</span> <span class="n">git_inflate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">,</span> <span class="n">Z_FINISH</span><span class="p">);</span>
<a name="c0-1649"></a><span class="lineno">1649</span>  <span class="n">git_inflate_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
<a name="c0-1650"></a><span class="lineno">1650</span>  <span class="k">if</span> <span class="p">((</span><span class="n">st</span> <span class="o">!=</span> <span class="n">Z_STREAM_END</span><span class="p">)</span> <span class="o">||</span> <span class="n">stream</span><span class="p">.</span><span class="n">total_out</span> <span class="o">!=</span> <span class="n">inflated_size</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1651"></a><span class="lineno">1651</span>    <span class="n">free</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<a name="c0-1652"></a><span class="lineno">1652</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1653"></a><span class="lineno">1653</span>  <span class="p">}</span>
<a name="c0-1654"></a><span class="lineno">1654</span>  <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<a name="c0-1655"></a><span class="lineno">1655</span> <span class="p">}</span>
<a name="c0-1656"></a><span class="lineno">1656</span> 
<a name="c0-1657"></a><span class="lineno">1657</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="nf">parse_binary_hunk</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">buf_p</span><span class="p">,</span>
<a name="c0-1658"></a><span class="lineno">1658</span>            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sz_p</span><span class="p">,</span>
<a name="c0-1659"></a><span class="lineno">1659</span>            <span class="kt">int</span> <span class="o">*</span><span class="n">status_p</span><span class="p">,</span>
<a name="c0-1660"></a><span class="lineno">1660</span>            <span class="kt">int</span> <span class="o">*</span><span class="n">used_p</span><span class="p">)</span>
<a name="c0-1661"></a><span class="lineno">1661</span> <span class="p">{</span>
<a name="c0-1662"></a><span class="lineno">1662</span>  <span class="cm">/*</span>
<a name="c0-1663"></a><span class="lineno">1663</span> <span class="cm">   * Expect a line that begins with binary patch method ("literal"</span>
<a name="c0-1664"></a><span class="lineno">1664</span> <span class="cm">   * or "delta"), followed by the length of data before deflating.</span>
<a name="c0-1665"></a><span class="lineno">1665</span> <span class="cm">   * a sequence of 'length-byte' followed by base-85 encoded data</span>
<a name="c0-1666"></a><span class="lineno">1666</span> <span class="cm">   * should follow, terminated by a newline.</span>
<a name="c0-1667"></a><span class="lineno">1667</span> <span class="cm">   *</span>
<a name="c0-1668"></a><span class="lineno">1668</span> <span class="cm">   * Each 5-byte sequence of base-85 encodes up to 4 bytes,</span>
<a name="c0-1669"></a><span class="lineno">1669</span> <span class="cm">   * and we would limit the patch line to 66 characters,</span>
<a name="c0-1670"></a><span class="lineno">1670</span> <span class="cm">   * so one line can fit up to 13 groups that would decode</span>
<a name="c0-1671"></a><span class="lineno">1671</span> <span class="cm">   * to 52 bytes max.  The length byte 'A'-'Z' corresponds</span>
<a name="c0-1672"></a><span class="lineno">1672</span> <span class="cm">   * to 1-26 bytes, and 'a'-'z' corresponds to 27-52 bytes.</span>
<a name="c0-1673"></a><span class="lineno">1673</span> <span class="cm">   */</span>
<a name="c0-1674"></a><span class="lineno">1674</span>  <span class="kt">int</span> <span class="n">llen</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>
<a name="c0-1675"></a><span class="lineno">1675</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">sz_p</span><span class="p">;</span>
<a name="c0-1676"></a><span class="lineno">1676</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf_p</span><span class="p">;</span>
<a name="c0-1677"></a><span class="lineno">1677</span>  <span class="kt">int</span> <span class="n">patch_method</span><span class="p">;</span>
<a name="c0-1678"></a><span class="lineno">1678</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">origlen</span><span class="p">;</span>
<a name="c0-1679"></a><span class="lineno">1679</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1680"></a><span class="lineno">1680</span>  <span class="kt">int</span> <span class="n">hunk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1681"></a><span class="lineno">1681</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
<a name="c0-1682"></a><span class="lineno">1682</span> 
<a name="c0-1683"></a><span class="lineno">1683</span>  <span class="n">llen</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1684"></a><span class="lineno">1684</span>  <span class="n">used</span> <span class="o">=</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1685"></a><span class="lineno">1685</span> 
<a name="c0-1686"></a><span class="lineno">1686</span>  <span class="o">*</span><span class="n">status_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1687"></a><span class="lineno">1687</span> 
<a name="c0-1688"></a><span class="lineno">1688</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"delta "</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1689"></a><span class="lineno">1689</span>    <span class="n">patch_method</span> <span class="o">=</span> <span class="n">BINARY_DELTA_DEFLATED</span><span class="p">;</span>
<a name="c0-1690"></a><span class="lineno">1690</span>    <span class="n">origlen</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-1691"></a><span class="lineno">1691</span>  <span class="p">}</span>
<a name="c0-1692"></a><span class="lineno">1692</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"literal "</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1693"></a><span class="lineno">1693</span>    <span class="n">patch_method</span> <span class="o">=</span> <span class="n">BINARY_LITERAL_DEFLATED</span><span class="p">;</span>
<a name="c0-1694"></a><span class="lineno">1694</span>    <span class="n">origlen</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="c0-1695"></a><span class="lineno">1695</span>  <span class="p">}</span>
<a name="c0-1696"></a><span class="lineno">1696</span>  <span class="k">else</span>
<a name="c0-1697"></a><span class="lineno">1697</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1698"></a><span class="lineno">1698</span> 
<a name="c0-1699"></a><span class="lineno">1699</span>  <span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1700"></a><span class="lineno">1700</span>  <span class="n">buffer</span> <span class="o">+=</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1701"></a><span class="lineno">1701</span>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1702"></a><span class="lineno">1702</span>    <span class="kt">int</span> <span class="n">byte_length</span><span class="p">,</span> <span class="n">max_byte_length</span><span class="p">,</span> <span class="n">newsize</span><span class="p">;</span>
<a name="c0-1703"></a><span class="lineno">1703</span>    <span class="n">llen</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-1704"></a><span class="lineno">1704</span>    <span class="n">used</span> <span class="o">+=</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1705"></a><span class="lineno">1705</span>    <span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1706"></a><span class="lineno">1706</span>    <span class="k">if</span> <span class="p">(</span><span class="n">llen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1707"></a><span class="lineno">1707</span>      <span class="cm">/* consume the blank line */</span>
<a name="c0-1708"></a><span class="lineno">1708</span>      <span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1709"></a><span class="lineno">1709</span>      <span class="n">size</span><span class="o">--</span><span class="p">;</span>
<a name="c0-1710"></a><span class="lineno">1710</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-1711"></a><span class="lineno">1711</span>    <span class="p">}</span>
<a name="c0-1712"></a><span class="lineno">1712</span>    <span class="cm">/*</span>
<a name="c0-1713"></a><span class="lineno">1713</span> <span class="cm">     * Minimum line is "A00000\n" which is 7-byte long,</span>
<a name="c0-1714"></a><span class="lineno">1714</span> <span class="cm">     * and the line length must be multiple of 5 plus 2.</span>
<a name="c0-1715"></a><span class="lineno">1715</span> <span class="cm">     */</span>
<a name="c0-1716"></a><span class="lineno">1716</span>    <span class="k">if</span> <span class="p">((</span><span class="n">llen</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">llen</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
<a name="c0-1717"></a><span class="lineno">1717</span>      <span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
<a name="c0-1718"></a><span class="lineno">1718</span>    <span class="n">max_byte_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">llen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<a name="c0-1719"></a><span class="lineno">1719</span>    <span class="n">byte_length</span> <span class="o">=</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<a name="c0-1720"></a><span class="lineno">1720</span>    <span class="k">if</span> <span class="p">(</span><span class="sc">'A'</span> <span class="o">&lt;=</span> <span class="n">byte_length</span> <span class="o">&amp;&amp;</span> <span class="n">byte_length</span> <span class="o">&lt;=</span> <span class="sc">'Z'</span><span class="p">)</span>
<a name="c0-1721"></a><span class="lineno">1721</span>      <span class="n">byte_length</span> <span class="o">=</span> <span class="n">byte_length</span> <span class="o">-</span> <span class="sc">'A'</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1722"></a><span class="lineno">1722</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="sc">'a'</span> <span class="o">&lt;=</span> <span class="n">byte_length</span> <span class="o">&amp;&amp;</span> <span class="n">byte_length</span> <span class="o">&lt;=</span> <span class="sc">'z'</span><span class="p">)</span>
<a name="c0-1723"></a><span class="lineno">1723</span>      <span class="n">byte_length</span> <span class="o">=</span> <span class="n">byte_length</span> <span class="o">-</span> <span class="sc">'a'</span> <span class="o">+</span> <span class="mi">27</span><span class="p">;</span>
<a name="c0-1724"></a><span class="lineno">1724</span>    <span class="k">else</span>
<a name="c0-1725"></a><span class="lineno">1725</span>      <span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
<a name="c0-1726"></a><span class="lineno">1726</span>    <span class="cm">/* if the input length was not multiple of 4, we would</span>
<a name="c0-1727"></a><span class="lineno">1727</span> <span class="cm">     * have filler at the end but the filler should never</span>
<a name="c0-1728"></a><span class="lineno">1728</span> <span class="cm">     * exceed 3 bytes</span>
<a name="c0-1729"></a><span class="lineno">1729</span> <span class="cm">     */</span>
<a name="c0-1730"></a><span class="lineno">1730</span>    <span class="k">if</span> <span class="p">(</span><span class="n">max_byte_length</span> <span class="o">&lt;</span> <span class="n">byte_length</span> <span class="o">||</span>
<a name="c0-1731"></a><span class="lineno">1731</span>        <span class="n">byte_length</span> <span class="o">&lt;=</span> <span class="n">max_byte_length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
<a name="c0-1732"></a><span class="lineno">1732</span>      <span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
<a name="c0-1733"></a><span class="lineno">1733</span>    <span class="n">newsize</span> <span class="o">=</span> <span class="n">hunk_size</span> <span class="o">+</span> <span class="n">byte_length</span><span class="p">;</span>
<a name="c0-1734"></a><span class="lineno">1734</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">newsize</span><span class="p">);</span>
<a name="c0-1735"></a><span class="lineno">1735</span>    <span class="k">if</span> <span class="p">(</span><span class="n">decode_85</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">hunk_size</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">byte_length</span><span class="p">))</span>
<a name="c0-1736"></a><span class="lineno">1736</span>      <span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
<a name="c0-1737"></a><span class="lineno">1737</span>    <span class="n">hunk_size</span> <span class="o">=</span> <span class="n">newsize</span><span class="p">;</span>
<a name="c0-1738"></a><span class="lineno">1738</span>    <span class="n">buffer</span> <span class="o">+=</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1739"></a><span class="lineno">1739</span>    <span class="n">size</span> <span class="o">-=</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1740"></a><span class="lineno">1740</span>  <span class="p">}</span>
<a name="c0-1741"></a><span class="lineno">1741</span> 
<a name="c0-1742"></a><span class="lineno">1742</span>  <span class="n">frag</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frag</span><span class="p">));</span>
<a name="c0-1743"></a><span class="lineno">1743</span>  <span class="n">frag</span><span class="o">-&gt;</span><span class="n">patch</span> <span class="o">=</span> <span class="n">inflate_it</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hunk_size</span><span class="p">,</span> <span class="n">origlen</span><span class="p">);</span>
<a name="c0-1744"></a><span class="lineno">1744</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1745"></a><span class="lineno">1745</span>    <span class="k">goto</span> <span class="n">corrupt</span><span class="p">;</span>
<a name="c0-1746"></a><span class="lineno">1746</span>  <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c0-1747"></a><span class="lineno">1747</span>  <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">origlen</span><span class="p">;</span>
<a name="c0-1748"></a><span class="lineno">1748</span>  <span class="o">*</span><span class="n">buf_p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
<a name="c0-1749"></a><span class="lineno">1749</span>  <span class="o">*</span><span class="n">sz_p</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-1750"></a><span class="lineno">1750</span>  <span class="o">*</span><span class="n">used_p</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span>
<a name="c0-1751"></a><span class="lineno">1751</span>  <span class="n">frag</span><span class="o">-&gt;</span><span class="n">binary_patch_method</span> <span class="o">=</span> <span class="n">patch_method</span><span class="p">;</span>
<a name="c0-1752"></a><span class="lineno">1752</span>  <span class="k">return</span> <span class="n">frag</span><span class="p">;</span>
<a name="c0-1753"></a><span class="lineno">1753</span> 
<a name="c0-1754"></a><span class="lineno">1754</span>  <span class="nl">corrupt:</span>
<a name="c0-1755"></a><span class="lineno">1755</span>  <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a name="c0-1756"></a><span class="lineno">1756</span>  <span class="o">*</span><span class="n">status_p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1757"></a><span class="lineno">1757</span>  <span class="n">error</span><span class="p">(</span><span class="s">"corrupt binary patch at line %d: %.*s"</span><span class="p">,</span>
<a name="c0-1758"></a><span class="lineno">1758</span>        <span class="n">linenr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">llen</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<a name="c0-1759"></a><span class="lineno">1759</span>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-1760"></a><span class="lineno">1760</span> <span class="p">}</span>
<a name="c0-1761"></a><span class="lineno">1761</span> 
<a name="c0-1762"></a><span class="lineno">1762</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_binary</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1763"></a><span class="lineno">1763</span> <span class="p">{</span>
<a name="c0-1764"></a><span class="lineno">1764</span>  <span class="cm">/*</span>
<a name="c0-1765"></a><span class="lineno">1765</span> <span class="cm">   * We have read "GIT binary patch\n"; what follows is a line</span>
<a name="c0-1766"></a><span class="lineno">1766</span> <span class="cm">   * that says the patch method (currently, either "literal" or</span>
<a name="c0-1767"></a><span class="lineno">1767</span> <span class="cm">   * "delta") and the length of data before deflating; a</span>
<a name="c0-1768"></a><span class="lineno">1768</span> <span class="cm">   * sequence of 'length-byte' followed by base-85 encoded data</span>
<a name="c0-1769"></a><span class="lineno">1769</span> <span class="cm">   * follows.</span>
<a name="c0-1770"></a><span class="lineno">1770</span> <span class="cm">   *</span>
<a name="c0-1771"></a><span class="lineno">1771</span> <span class="cm">   * When a binary patch is reversible, there is another binary</span>
<a name="c0-1772"></a><span class="lineno">1772</span> <span class="cm">   * hunk in the same format, starting with patch method (either</span>
<a name="c0-1773"></a><span class="lineno">1773</span> <span class="cm">   * "literal" or "delta") with the length of data, and a sequence</span>
<a name="c0-1774"></a><span class="lineno">1774</span> <span class="cm">   * of length-byte + base-85 encoded data, terminated with another</span>
<a name="c0-1775"></a><span class="lineno">1775</span> <span class="cm">   * empty line.  This data, when applied to the postimage, produces</span>
<a name="c0-1776"></a><span class="lineno">1776</span> <span class="cm">   * the preimage.</span>
<a name="c0-1777"></a><span class="lineno">1777</span> <span class="cm">   */</span>
<a name="c0-1778"></a><span class="lineno">1778</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">forward</span><span class="p">;</span>
<a name="c0-1779"></a><span class="lineno">1779</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">reverse</span><span class="p">;</span>
<a name="c0-1780"></a><span class="lineno">1780</span>  <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-1781"></a><span class="lineno">1781</span>  <span class="kt">int</span> <span class="n">used</span><span class="p">,</span> <span class="n">used_1</span><span class="p">;</span>
<a name="c0-1782"></a><span class="lineno">1782</span> 
<a name="c0-1783"></a><span class="lineno">1783</span>  <span class="n">forward</span> <span class="o">=</span> <span class="n">parse_binary_hunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">used</span><span class="p">);</span>
<a name="c0-1784"></a><span class="lineno">1784</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forward</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span>
<a name="c0-1785"></a><span class="lineno">1785</span>    <span class="cm">/* there has to be one hunk (forward hunk) */</span>
<a name="c0-1786"></a><span class="lineno">1786</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"unrecognized binary patch at line %d"</span><span class="p">,</span> <span class="n">linenr</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-1787"></a><span class="lineno">1787</span>  <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
<a name="c0-1788"></a><span class="lineno">1788</span>    <span class="cm">/* otherwise we already gave an error message */</span>
<a name="c0-1789"></a><span class="lineno">1789</span>    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-1790"></a><span class="lineno">1790</span> 
<a name="c0-1791"></a><span class="lineno">1791</span>  <span class="n">reverse</span> <span class="o">=</span> <span class="n">parse_binary_hunk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">used_1</span><span class="p">);</span>
<a name="c0-1792"></a><span class="lineno">1792</span>  <span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
<a name="c0-1793"></a><span class="lineno">1793</span>    <span class="n">used</span> <span class="o">+=</span> <span class="n">used_1</span><span class="p">;</span>
<a name="c0-1794"></a><span class="lineno">1794</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1795"></a><span class="lineno">1795</span>    <span class="cm">/*</span>
<a name="c0-1796"></a><span class="lineno">1796</span> <span class="cm">     * Not having reverse hunk is not an error, but having</span>
<a name="c0-1797"></a><span class="lineno">1797</span> <span class="cm">     * a corrupt reverse hunk is.</span>
<a name="c0-1798"></a><span class="lineno">1798</span> <span class="cm">     */</span>
<a name="c0-1799"></a><span class="lineno">1799</span>    <span class="n">free</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">forward</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-1800"></a><span class="lineno">1800</span>    <span class="n">free</span><span class="p">(</span><span class="n">forward</span><span class="p">);</span>
<a name="c0-1801"></a><span class="lineno">1801</span>    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-1802"></a><span class="lineno">1802</span>  <span class="p">}</span>
<a name="c0-1803"></a><span class="lineno">1803</span>  <span class="n">forward</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">;</span>
<a name="c0-1804"></a><span class="lineno">1804</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">forward</span><span class="p">;</span>
<a name="c0-1805"></a><span class="lineno">1805</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1806"></a><span class="lineno">1806</span>  <span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<a name="c0-1807"></a><span class="lineno">1807</span> <span class="p">}</span>
<a name="c0-1808"></a><span class="lineno">1808</span> 
<a name="c0-1809"></a><span class="lineno">1809</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_chunk</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1810"></a><span class="lineno">1810</span> <span class="p">{</span>
<a name="c0-1811"></a><span class="lineno">1811</span>  <span class="kt">int</span> <span class="n">hdrsize</span><span class="p">,</span> <span class="n">patchsize</span><span class="p">;</span>
<a name="c0-1812"></a><span class="lineno">1812</span>  <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">find_header</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdrsize</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-1813"></a><span class="lineno">1813</span> 
<a name="c0-1814"></a><span class="lineno">1814</span>  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1815"></a><span class="lineno">1815</span>    <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1816"></a><span class="lineno">1816</span> 
<a name="c0-1817"></a><span class="lineno">1817</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">ws_rule</span> <span class="o">=</span> <span class="n">whitespace_rule</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span>
<a name="c0-1818"></a><span class="lineno">1818</span>           <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span>
<a name="c0-1819"></a><span class="lineno">1819</span>           <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-1820"></a><span class="lineno">1820</span> 
<a name="c0-1821"></a><span class="lineno">1821</span>  <span class="n">patchsize</span> <span class="o">=</span> <span class="n">parse_single_patch</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">hdrsize</span><span class="p">,</span>
<a name="c0-1822"></a><span class="lineno">1822</span>               <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">hdrsize</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-1823"></a><span class="lineno">1823</span> 
<a name="c0-1824"></a><span class="lineno">1824</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patchsize</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1825"></a><span class="lineno">1825</span>    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">binhdr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c0-1826"></a><span class="lineno">1826</span>      <span class="s">"Binary files "</span><span class="p">,</span>
<a name="c0-1827"></a><span class="lineno">1827</span>      <span class="s">"Files "</span><span class="p">,</span>
<a name="c0-1828"></a><span class="lineno">1828</span>      <span class="nb">NULL</span><span class="p">,</span>
<a name="c0-1829"></a><span class="lineno">1829</span>    <span class="p">};</span>
<a name="c0-1830"></a><span class="lineno">1830</span>    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">git_binary</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"GIT binary patch</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<a name="c0-1831"></a><span class="lineno">1831</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-1832"></a><span class="lineno">1832</span>    <span class="kt">int</span> <span class="n">hd</span> <span class="o">=</span> <span class="n">hdrsize</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-1833"></a><span class="lineno">1833</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">llen</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">hd</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">hd</span><span class="p">);</span>
<a name="c0-1834"></a><span class="lineno">1834</span> 
<a name="c0-1835"></a><span class="lineno">1835</span>    <span class="k">if</span> <span class="p">(</span><span class="n">llen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">git_binary</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
<a name="c0-1836"></a><span class="lineno">1836</span>        <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">git_binary</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">hd</span><span class="p">,</span> <span class="n">llen</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1837"></a><span class="lineno">1837</span>      <span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
<a name="c0-1838"></a><span class="lineno">1838</span>      <span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1839"></a><span class="lineno">1839</span>      <span class="n">used</span> <span class="o">=</span> <span class="n">parse_binary</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">hd</span> <span class="o">+</span> <span class="n">llen</span><span class="p">,</span>
<a name="c0-1840"></a><span class="lineno">1840</span>              <span class="n">size</span> <span class="o">-</span> <span class="n">hd</span> <span class="o">-</span> <span class="n">llen</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-1841"></a><span class="lineno">1841</span>      <span class="k">if</span> <span class="p">(</span><span class="n">used</span><span class="p">)</span>
<a name="c0-1842"></a><span class="lineno">1842</span>        <span class="n">patchsize</span> <span class="o">=</span> <span class="n">used</span> <span class="o">+</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1843"></a><span class="lineno">1843</span>      <span class="k">else</span>
<a name="c0-1844"></a><span class="lineno">1844</span>        <span class="n">patchsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1845"></a><span class="lineno">1845</span>    <span class="p">}</span>
<a name="c0-1846"></a><span class="lineno">1846</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="s">" differ</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">hd</span> <span class="o">+</span> <span class="n">llen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1847"></a><span class="lineno">1847</span>      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">binhdr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1848"></a><span class="lineno">1848</span>        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">binhdr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a name="c0-1849"></a><span class="lineno">1849</span>        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="n">hd</span> <span class="o">&amp;&amp;</span>
<a name="c0-1850"></a><span class="lineno">1850</span>            <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">binhdr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">hd</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-1851"></a><span class="lineno">1851</span>          <span class="n">linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-1852"></a><span class="lineno">1852</span>          <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-1853"></a><span class="lineno">1853</span>          <span class="n">patchsize</span> <span class="o">=</span> <span class="n">llen</span><span class="p">;</span>
<a name="c0-1854"></a><span class="lineno">1854</span>          <span class="k">break</span><span class="p">;</span>
<a name="c0-1855"></a><span class="lineno">1855</span>        <span class="p">}</span>
<a name="c0-1856"></a><span class="lineno">1856</span>      <span class="p">}</span>
<a name="c0-1857"></a><span class="lineno">1857</span>    <span class="p">}</span>
<a name="c0-1858"></a><span class="lineno">1858</span> 
<a name="c0-1859"></a><span class="lineno">1859</span>    <span class="cm">/* Empty patch cannot be applied if it is a text patch</span>
<a name="c0-1860"></a><span class="lineno">1860</span> <span class="cm">     * without metadata change.  A binary patch appears</span>
<a name="c0-1861"></a><span class="lineno">1861</span> <span class="cm">     * empty to us here.</span>
<a name="c0-1862"></a><span class="lineno">1862</span> <span class="cm">     */</span>
<a name="c0-1863"></a><span class="lineno">1863</span>    <span class="k">if</span> <span class="p">((</span><span class="n">apply</span> <span class="o">||</span> <span class="n">check</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-1864"></a><span class="lineno">1864</span>        <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">metadata_changes</span><span class="p">(</span><span class="n">patch</span><span class="p">)))</span>
<a name="c0-1865"></a><span class="lineno">1865</span>      <span class="n">die</span><span class="p">(</span><span class="s">"patch with only garbage at line %d"</span><span class="p">,</span> <span class="n">linenr</span><span class="p">);</span>
<a name="c0-1866"></a><span class="lineno">1866</span>  <span class="p">}</span>
<a name="c0-1867"></a><span class="lineno">1867</span> 
<a name="c0-1868"></a><span class="lineno">1868</span>  <span class="k">return</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">hdrsize</span> <span class="o">+</span> <span class="n">patchsize</span><span class="p">;</span>
<a name="c0-1869"></a><span class="lineno">1869</span> <span class="p">}</span>
<a name="c0-1870"></a><span class="lineno">1870</span> 
<a name="c0-1871"></a><span class="lineno">1871</span> <span class="cp">#define swap(a,b) myswap((a),(b),sizeof(a))</span>
<a name="c0-1872"></a><span class="lineno">1872</span> 
<a name="c0-1873"></a><span class="lineno">1873</span> <span class="cp">#define myswap(a, b, size) do {   \</span>
<a name="c0-1874"></a><span class="lineno">1874</span> <span class="cp">  unsigned char mytmp[size];  \</span>
<a name="c0-1875"></a><span class="lineno">1875</span> <span class="cp">  memcpy(mytmp, &amp;a, size);    \</span>
<a name="c0-1876"></a><span class="lineno">1876</span> <span class="cp">  memcpy(&amp;a, &amp;b, size);   \</span>
<a name="c0-1877"></a><span class="lineno">1877</span> <span class="cp">  memcpy(&amp;b, mytmp, size);    \</span>
<a name="c0-1878"></a><span class="lineno">1878</span> <span class="cp">} while (0)</span>
<a name="c0-1879"></a><span class="lineno">1879</span> 
<a name="c0-1880"></a><span class="lineno">1880</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">reverse_patches</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="c0-1881"></a><span class="lineno">1881</span> <span class="p">{</span>
<a name="c0-1882"></a><span class="lineno">1882</span>  <span class="k">for</span> <span class="p">(;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1883"></a><span class="lineno">1883</span>    <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">;</span>
<a name="c0-1884"></a><span class="lineno">1884</span> 
<a name="c0-1885"></a><span class="lineno">1885</span>    <span class="n">swap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-1886"></a><span class="lineno">1886</span>    <span class="n">swap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">);</span>
<a name="c0-1887"></a><span class="lineno">1887</span>    <span class="n">swap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_delete</span><span class="p">);</span>
<a name="c0-1888"></a><span class="lineno">1888</span>    <span class="n">swap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lines_added</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">);</span>
<a name="c0-1889"></a><span class="lineno">1889</span>    <span class="n">swap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">);</span>
<a name="c0-1890"></a><span class="lineno">1890</span> 
<a name="c0-1891"></a><span class="lineno">1891</span>    <span class="k">for</span> <span class="p">(;</span> <span class="n">frag</span><span class="p">;</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1892"></a><span class="lineno">1892</span>      <span class="n">swap</span><span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">newpos</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">oldpos</span><span class="p">);</span>
<a name="c0-1893"></a><span class="lineno">1893</span>      <span class="n">swap</span><span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">newlines</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">oldlines</span><span class="p">);</span>
<a name="c0-1894"></a><span class="lineno">1894</span>    <span class="p">}</span>
<a name="c0-1895"></a><span class="lineno">1895</span>  <span class="p">}</span>
<a name="c0-1896"></a><span class="lineno">1896</span> <span class="p">}</span>
<a name="c0-1897"></a><span class="lineno">1897</span> 
<a name="c0-1898"></a><span class="lineno">1898</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">pluses</span><span class="p">[]</span> <span class="o">=</span>
<a name="c0-1899"></a><span class="lineno">1899</span> <span class="s">"++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"</span><span class="p">;</span>
<a name="c0-1900"></a><span class="lineno">1900</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">minuses</span><span class="p">[]</span><span class="o">=</span>
<a name="c0-1901"></a><span class="lineno">1901</span> <span class="s">"----------------------------------------------------------------------"</span><span class="p">;</span>
<a name="c0-1902"></a><span class="lineno">1902</span> 
<a name="c0-1903"></a><span class="lineno">1903</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-1904"></a><span class="lineno">1904</span> <span class="p">{</span>
<a name="c0-1905"></a><span class="lineno">1905</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">qname</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-1906"></a><span class="lineno">1906</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-1907"></a><span class="lineno">1907</span>  <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">del</span><span class="p">;</span>
<a name="c0-1908"></a><span class="lineno">1908</span> 
<a name="c0-1909"></a><span class="lineno">1909</span>  <span class="n">quote_c_style</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1910"></a><span class="lineno">1910</span> 
<a name="c0-1911"></a><span class="lineno">1911</span>  <span class="cm">/*</span>
<a name="c0-1912"></a><span class="lineno">1912</span> <span class="cm">   * "scale" the filename</span>
<a name="c0-1913"></a><span class="lineno">1913</span> <span class="cm">   */</span>
<a name="c0-1914"></a><span class="lineno">1914</span>  <span class="n">max</span> <span class="o">=</span> <span class="n">max_len</span><span class="p">;</span>
<a name="c0-1915"></a><span class="lineno">1915</span>  <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
<a name="c0-1916"></a><span class="lineno">1916</span>    <span class="n">max</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<a name="c0-1917"></a><span class="lineno">1917</span> 
<a name="c0-1918"></a><span class="lineno">1918</span>  <span class="k">if</span> <span class="p">(</span><span class="n">qname</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1919"></a><span class="lineno">1919</span>    <span class="n">cp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">qname</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">qname</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">max</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-1920"></a><span class="lineno">1920</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
<a name="c0-1921"></a><span class="lineno">1921</span>      <span class="n">cp</span> <span class="o">=</span> <span class="n">qname</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">qname</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">max</span><span class="p">;</span>
<a name="c0-1922"></a><span class="lineno">1922</span>    <span class="n">strbuf_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">qname</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="s">"..."</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<a name="c0-1923"></a><span class="lineno">1923</span>  <span class="p">}</span>
<a name="c0-1924"></a><span class="lineno">1924</span> 
<a name="c0-1925"></a><span class="lineno">1925</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1926"></a><span class="lineno">1926</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" %-*s |  Bin</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">qname</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-1927"></a><span class="lineno">1927</span>    <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qname</span><span class="p">);</span>
<a name="c0-1928"></a><span class="lineno">1928</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-1929"></a><span class="lineno">1929</span>  <span class="p">}</span>
<a name="c0-1930"></a><span class="lineno">1930</span> 
<a name="c0-1931"></a><span class="lineno">1931</span>  <span class="n">printf</span><span class="p">(</span><span class="s">" %-*s |"</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">qname</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-1932"></a><span class="lineno">1932</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qname</span><span class="p">);</span>
<a name="c0-1933"></a><span class="lineno">1933</span> 
<a name="c0-1934"></a><span class="lineno">1934</span>  <span class="cm">/*</span>
<a name="c0-1935"></a><span class="lineno">1935</span> <span class="cm">   * scale the add/delete</span>
<a name="c0-1936"></a><span class="lineno">1936</span> <span class="cm">   */</span>
<a name="c0-1937"></a><span class="lineno">1937</span>  <span class="n">max</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="n">max_change</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="o">?</span> <span class="mi">70</span> <span class="o">-</span> <span class="n">max</span> <span class="o">:</span> <span class="n">max_change</span><span class="p">;</span>
<a name="c0-1938"></a><span class="lineno">1938</span>  <span class="n">add</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span><span class="p">;</span>
<a name="c0-1939"></a><span class="lineno">1939</span>  <span class="n">del</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">;</span>
<a name="c0-1940"></a><span class="lineno">1940</span> 
<a name="c0-1941"></a><span class="lineno">1941</span>  <span class="k">if</span> <span class="p">(</span><span class="n">max_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1942"></a><span class="lineno">1942</span>    <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="p">((</span><span class="n">add</span> <span class="o">+</span> <span class="n">del</span><span class="p">)</span> <span class="o">*</span> <span class="n">max</span> <span class="o">+</span> <span class="n">max_change</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_change</span><span class="p">;</span>
<a name="c0-1943"></a><span class="lineno">1943</span>    <span class="n">add</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span> <span class="o">*</span> <span class="n">max</span> <span class="o">+</span> <span class="n">max_change</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_change</span><span class="p">;</span>
<a name="c0-1944"></a><span class="lineno">1944</span>    <span class="n">del</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">add</span><span class="p">;</span>
<a name="c0-1945"></a><span class="lineno">1945</span>  <span class="p">}</span>
<a name="c0-1946"></a><span class="lineno">1946</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"%5d %.*s%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span> <span class="o">+</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">,</span>
<a name="c0-1947"></a><span class="lineno">1947</span>    <span class="n">add</span><span class="p">,</span> <span class="n">pluses</span><span class="p">,</span> <span class="n">del</span><span class="p">,</span> <span class="n">minuses</span><span class="p">);</span>
<a name="c0-1948"></a><span class="lineno">1948</span> <span class="p">}</span>
<a name="c0-1949"></a><span class="lineno">1949</span> 
<a name="c0-1950"></a><span class="lineno">1950</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">read_old_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-1951"></a><span class="lineno">1951</span> <span class="p">{</span>
<a name="c0-1952"></a><span class="lineno">1952</span>  <span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-1953"></a><span class="lineno">1953</span>  <span class="k">case</span> <span class="n">S_IFLNK</span>:
<a name="c0-1954"></a><span class="lineno">1954</span>    <span class="k">if</span> <span class="p">(</span><span class="n">strbuf_readlink</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-1955"></a><span class="lineno">1955</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"unable to read symlink %s"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-1956"></a><span class="lineno">1956</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1957"></a><span class="lineno">1957</span>  <span class="k">case</span> <span class="n">S_IFREG</span>:
<a name="c0-1958"></a><span class="lineno">1958</span>    <span class="k">if</span> <span class="p">(</span><span class="n">strbuf_read_file</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">)</span>
<a name="c0-1959"></a><span class="lineno">1959</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"unable to open or read %s"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-1960"></a><span class="lineno">1960</span>    <span class="n">convert_to_git</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-1961"></a><span class="lineno">1961</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-1962"></a><span class="lineno">1962</span>  <span class="nl">default:</span>
<a name="c0-1963"></a><span class="lineno">1963</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-1964"></a><span class="lineno">1964</span>  <span class="p">}</span>
<a name="c0-1965"></a><span class="lineno">1965</span> <span class="p">}</span>
<a name="c0-1966"></a><span class="lineno">1966</span> 
<a name="c0-1967"></a><span class="lineno">1967</span> <span class="cm">/*</span>
<a name="c0-1968"></a><span class="lineno">1968</span> <span class="cm"> * Update the preimage, and the common lines in postimage,</span>
<a name="c0-1969"></a><span class="lineno">1969</span> <span class="cm"> * from buffer buf of length len. If postlen is 0 the postimage</span>
<a name="c0-1970"></a><span class="lineno">1970</span> <span class="cm"> * is updated in place, otherwise it's updated on a new buffer</span>
<a name="c0-1971"></a><span class="lineno">1971</span> <span class="cm"> * of length postlen</span>
<a name="c0-1972"></a><span class="lineno">1972</span> <span class="cm"> */</span>
<a name="c0-1973"></a><span class="lineno">1973</span> 
<a name="c0-1974"></a><span class="lineno">1974</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">update_pre_post_images</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">preimage</span><span class="p">,</span>
<a name="c0-1975"></a><span class="lineno">1975</span>           <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">postimage</span><span class="p">,</span>
<a name="c0-1976"></a><span class="lineno">1976</span>           <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<a name="c0-1977"></a><span class="lineno">1977</span>           <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">postlen</span><span class="p">)</span>
<a name="c0-1978"></a><span class="lineno">1978</span> <span class="p">{</span>
<a name="c0-1979"></a><span class="lineno">1979</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ctx</span><span class="p">;</span>
<a name="c0-1980"></a><span class="lineno">1980</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed</span><span class="p">;</span>
<a name="c0-1981"></a><span class="lineno">1981</span>  <span class="k">struct</span> <span class="n">image</span> <span class="n">fixed_preimage</span><span class="p">;</span>
<a name="c0-1982"></a><span class="lineno">1982</span> 
<a name="c0-1983"></a><span class="lineno">1983</span>  <span class="cm">/*</span>
<a name="c0-1984"></a><span class="lineno">1984</span> <span class="cm">   * Update the preimage with whitespace fixes.  Note that we</span>
<a name="c0-1985"></a><span class="lineno">1985</span> <span class="cm">   * are not losing preimage-&gt;buf -- apply_one_fragment() will</span>
<a name="c0-1986"></a><span class="lineno">1986</span> <span class="cm">   * free "oldlines".</span>
<a name="c0-1987"></a><span class="lineno">1987</span> <span class="cm">   */</span>
<a name="c0-1988"></a><span class="lineno">1988</span>  <span class="n">prepare_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed_preimage</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-1989"></a><span class="lineno">1989</span>  <span class="n">assert</span><span class="p">(</span><span class="n">fixed_preimage</span><span class="p">.</span><span class="n">nr</span> <span class="o">==</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
<a name="c0-1990"></a><span class="lineno">1990</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-1991"></a><span class="lineno">1991</span>    <span class="n">fixed_preimage</span><span class="p">.</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">;</span>
<a name="c0-1992"></a><span class="lineno">1992</span>  <span class="n">free</span><span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line_allocated</span><span class="p">);</span>
<a name="c0-1993"></a><span class="lineno">1993</span>  <span class="o">*</span><span class="n">preimage</span> <span class="o">=</span> <span class="n">fixed_preimage</span><span class="p">;</span>
<a name="c0-1994"></a><span class="lineno">1994</span> 
<a name="c0-1995"></a><span class="lineno">1995</span>  <span class="cm">/*</span>
<a name="c0-1996"></a><span class="lineno">1996</span> <span class="cm">   * Adjust the common context lines in postimage. This can be</span>
<a name="c0-1997"></a><span class="lineno">1997</span> <span class="cm">   * done in-place when we are just doing whitespace fixing,</span>
<a name="c0-1998"></a><span class="lineno">1998</span> <span class="cm">   * which does not make the string grow, but needs a new buffer</span>
<a name="c0-1999"></a><span class="lineno">1999</span> <span class="cm">   * when ignoring whitespace causes the update, since in this case</span>
<a name="c0-2000"></a><span class="lineno">2000</span> <span class="cm">   * we could have e.g. tabs converted to multiple spaces.</span>
<a name="c0-2001"></a><span class="lineno">2001</span> <span class="cm">   * We trust the caller to tell us if the update can be done</span>
<a name="c0-2002"></a><span class="lineno">2002</span> <span class="cm">   * in place (postlen==0) or not.</span>
<a name="c0-2003"></a><span class="lineno">2003</span> <span class="cm">   */</span>
<a name="c0-2004"></a><span class="lineno">2004</span>  <span class="n">old</span> <span class="o">=</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2005"></a><span class="lineno">2005</span>  <span class="k">if</span> <span class="p">(</span><span class="n">postlen</span><span class="p">)</span>
<a name="c0-2006"></a><span class="lineno">2006</span>    <span class="n">new</span> <span class="o">=</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">postlen</span><span class="p">);</span>
<a name="c0-2007"></a><span class="lineno">2007</span>  <span class="k">else</span>
<a name="c0-2008"></a><span class="lineno">2008</span>    <span class="n">new</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
<a name="c0-2009"></a><span class="lineno">2009</span>  <span class="n">fixed</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2010"></a><span class="lineno">2010</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2011"></a><span class="lineno">2011</span>    <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2012"></a><span class="lineno">2012</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">postimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LINE_COMMON</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2013"></a><span class="lineno">2013</span>      <span class="cm">/* an added line -- no counterparts in preimage */</span>
<a name="c0-2014"></a><span class="lineno">2014</span>      <span class="n">memmove</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-2015"></a><span class="lineno">2015</span>      <span class="n">old</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2016"></a><span class="lineno">2016</span>      <span class="n">new</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2017"></a><span class="lineno">2017</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2018"></a><span class="lineno">2018</span>    <span class="p">}</span>
<a name="c0-2019"></a><span class="lineno">2019</span> 
<a name="c0-2020"></a><span class="lineno">2020</span>    <span class="cm">/* a common context -- skip it in the original postimage */</span>
<a name="c0-2021"></a><span class="lineno">2021</span>    <span class="n">old</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2022"></a><span class="lineno">2022</span> 
<a name="c0-2023"></a><span class="lineno">2023</span>    <span class="cm">/* and find the corresponding one in the fixed preimage */</span>
<a name="c0-2024"></a><span class="lineno">2024</span>    <span class="k">while</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">&lt;</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;&amp;</span>
<a name="c0-2025"></a><span class="lineno">2025</span>           <span class="o">!</span><span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">ctx</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LINE_COMMON</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2026"></a><span class="lineno">2026</span>      <span class="n">fixed</span> <span class="o">+=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">ctx</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2027"></a><span class="lineno">2027</span>      <span class="n">ctx</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2028"></a><span class="lineno">2028</span>    <span class="p">}</span>
<a name="c0-2029"></a><span class="lineno">2029</span>    <span class="k">if</span> <span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="n">ctx</span><span class="p">)</span>
<a name="c0-2030"></a><span class="lineno">2030</span>      <span class="n">die</span><span class="p">(</span><span class="s">"oops"</span><span class="p">);</span>
<a name="c0-2031"></a><span class="lineno">2031</span> 
<a name="c0-2032"></a><span class="lineno">2032</span>    <span class="cm">/* and copy it in, while fixing the line length */</span>
<a name="c0-2033"></a><span class="lineno">2033</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">ctx</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2034"></a><span class="lineno">2034</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="c0-2035"></a><span class="lineno">2035</span>    <span class="n">new</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2036"></a><span class="lineno">2036</span>    <span class="n">fixed</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2037"></a><span class="lineno">2037</span>    <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2038"></a><span class="lineno">2038</span>    <span class="n">ctx</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2039"></a><span class="lineno">2039</span>  <span class="p">}</span>
<a name="c0-2040"></a><span class="lineno">2040</span> 
<a name="c0-2041"></a><span class="lineno">2041</span>  <span class="cm">/* Fix the length of the whole thing */</span>
<a name="c0-2042"></a><span class="lineno">2042</span>  <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">new</span> <span class="o">-</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2043"></a><span class="lineno">2043</span> <span class="p">}</span>
<a name="c0-2044"></a><span class="lineno">2044</span> 
<a name="c0-2045"></a><span class="lineno">2045</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">match_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span>
<a name="c0-2046"></a><span class="lineno">2046</span>        <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">preimage</span><span class="p">,</span>
<a name="c0-2047"></a><span class="lineno">2047</span>        <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">postimage</span><span class="p">,</span>
<a name="c0-2048"></a><span class="lineno">2048</span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">try</span><span class="p">,</span>
<a name="c0-2049"></a><span class="lineno">2049</span>        <span class="kt">int</span> <span class="n">try_lno</span><span class="p">,</span>
<a name="c0-2050"></a><span class="lineno">2050</span>        <span class="kt">unsigned</span> <span class="n">ws_rule</span><span class="p">,</span>
<a name="c0-2051"></a><span class="lineno">2051</span>        <span class="kt">int</span> <span class="n">match_beginning</span><span class="p">,</span> <span class="kt">int</span> <span class="n">match_end</span><span class="p">)</span>
<a name="c0-2052"></a><span class="lineno">2052</span> <span class="p">{</span>
<a name="c0-2053"></a><span class="lineno">2053</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-2054"></a><span class="lineno">2054</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">fixed_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
<a name="c0-2055"></a><span class="lineno">2055</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">fixed</span><span class="p">;</span>
<a name="c0-2056"></a><span class="lineno">2056</span>  <span class="kt">size_t</span> <span class="n">fixed_len</span><span class="p">;</span>
<a name="c0-2057"></a><span class="lineno">2057</span>  <span class="kt">int</span> <span class="n">preimage_limit</span><span class="p">;</span>
<a name="c0-2058"></a><span class="lineno">2058</span> 
<a name="c0-2059"></a><span class="lineno">2059</span>  <span class="k">if</span> <span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="n">try_lno</span> <span class="o">&lt;=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2060"></a><span class="lineno">2060</span>    <span class="cm">/*</span>
<a name="c0-2061"></a><span class="lineno">2061</span> <span class="cm">     * The hunk falls within the boundaries of img.</span>
<a name="c0-2062"></a><span class="lineno">2062</span> <span class="cm">     */</span>
<a name="c0-2063"></a><span class="lineno">2063</span>    <span class="n">preimage_limit</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
<a name="c0-2064"></a><span class="lineno">2064</span>    <span class="k">if</span> <span class="p">(</span><span class="n">match_end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="n">try_lno</span> <span class="o">!=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">))</span>
<a name="c0-2065"></a><span class="lineno">2065</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2066"></a><span class="lineno">2066</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ws_error_action</span> <span class="o">==</span> <span class="n">correct_ws_error</span> <span class="o">&amp;&amp;</span>
<a name="c0-2067"></a><span class="lineno">2067</span>       <span class="p">(</span><span class="n">ws_rule</span> <span class="o">&amp;</span> <span class="n">WS_BLANK_AT_EOF</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2068"></a><span class="lineno">2068</span>    <span class="cm">/*</span>
<a name="c0-2069"></a><span class="lineno">2069</span> <span class="cm">     * This hunk extends beyond the end of img, and we are</span>
<a name="c0-2070"></a><span class="lineno">2070</span> <span class="cm">     * removing blank lines at the end of the file.  This</span>
<a name="c0-2071"></a><span class="lineno">2071</span> <span class="cm">     * many lines from the beginning of the preimage must</span>
<a name="c0-2072"></a><span class="lineno">2072</span> <span class="cm">     * match with img, and the remainder of the preimage</span>
<a name="c0-2073"></a><span class="lineno">2073</span> <span class="cm">     * must be blank.</span>
<a name="c0-2074"></a><span class="lineno">2074</span> <span class="cm">     */</span>
<a name="c0-2075"></a><span class="lineno">2075</span>    <span class="n">preimage_limit</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="n">try_lno</span><span class="p">;</span>
<a name="c0-2076"></a><span class="lineno">2076</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2077"></a><span class="lineno">2077</span>    <span class="cm">/*</span>
<a name="c0-2078"></a><span class="lineno">2078</span> <span class="cm">     * The hunk extends beyond the end of the img and</span>
<a name="c0-2079"></a><span class="lineno">2079</span> <span class="cm">     * we are not removing blanks at the end, so we</span>
<a name="c0-2080"></a><span class="lineno">2080</span> <span class="cm">     * should reject the hunk at this position.</span>
<a name="c0-2081"></a><span class="lineno">2081</span> <span class="cm">     */</span>
<a name="c0-2082"></a><span class="lineno">2082</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2083"></a><span class="lineno">2083</span>  <span class="p">}</span>
<a name="c0-2084"></a><span class="lineno">2084</span> 
<a name="c0-2085"></a><span class="lineno">2085</span>  <span class="k">if</span> <span class="p">(</span><span class="n">match_beginning</span> <span class="o">&amp;&amp;</span> <span class="n">try_lno</span><span class="p">)</span>
<a name="c0-2086"></a><span class="lineno">2086</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2087"></a><span class="lineno">2087</span> 
<a name="c0-2088"></a><span class="lineno">2088</span>  <span class="cm">/* Quick hash check */</span>
<a name="c0-2089"></a><span class="lineno">2089</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage_limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2090"></a><span class="lineno">2090</span>    <span class="k">if</span> <span class="p">((</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">try_lno</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LINE_PATCHED</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-2091"></a><span class="lineno">2091</span>        <span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hash</span> <span class="o">!=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">try_lno</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">hash</span><span class="p">))</span>
<a name="c0-2092"></a><span class="lineno">2092</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2093"></a><span class="lineno">2093</span> 
<a name="c0-2094"></a><span class="lineno">2094</span>  <span class="k">if</span> <span class="p">(</span><span class="n">preimage_limit</span> <span class="o">==</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2095"></a><span class="lineno">2095</span>    <span class="cm">/*</span>
<a name="c0-2096"></a><span class="lineno">2096</span> <span class="cm">     * Do we have an exact match?  If we were told to match</span>
<a name="c0-2097"></a><span class="lineno">2097</span> <span class="cm">     * at the end, size must be exactly at try+fragsize,</span>
<a name="c0-2098"></a><span class="lineno">2098</span> <span class="cm">     * otherwise try+fragsize must be still within the preimage,</span>
<a name="c0-2099"></a><span class="lineno">2099</span> <span class="cm">     * and either case, the old piece should match the preimage</span>
<a name="c0-2100"></a><span class="lineno">2100</span> <span class="cm">     * exactly.</span>
<a name="c0-2101"></a><span class="lineno">2101</span> <span class="cm">     */</span>
<a name="c0-2102"></a><span class="lineno">2102</span>    <span class="k">if</span> <span class="p">((</span><span class="n">match_end</span>
<a name="c0-2103"></a><span class="lineno">2103</span>         <span class="o">?</span> <span class="p">(</span><span class="n">try</span> <span class="o">+</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
<a name="c0-2104"></a><span class="lineno">2104</span>         <span class="o">:</span> <span class="p">(</span><span class="n">try</span> <span class="o">+</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
<a name="c0-2105"></a><span class="lineno">2105</span>        <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">try</span><span class="p">,</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
<a name="c0-2106"></a><span class="lineno">2106</span>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2107"></a><span class="lineno">2107</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2108"></a><span class="lineno">2108</span>    <span class="cm">/*</span>
<a name="c0-2109"></a><span class="lineno">2109</span> <span class="cm">     * The preimage extends beyond the end of img, so</span>
<a name="c0-2110"></a><span class="lineno">2110</span> <span class="cm">     * there cannot be an exact match.</span>
<a name="c0-2111"></a><span class="lineno">2111</span> <span class="cm">     *</span>
<a name="c0-2112"></a><span class="lineno">2112</span> <span class="cm">     * There must be one non-blank context line that match</span>
<a name="c0-2113"></a><span class="lineno">2113</span> <span class="cm">     * a line before the end of img.</span>
<a name="c0-2114"></a><span class="lineno">2114</span> <span class="cm">     */</span>
<a name="c0-2115"></a><span class="lineno">2115</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">buf_end</span><span class="p">;</span>
<a name="c0-2116"></a><span class="lineno">2116</span> 
<a name="c0-2117"></a><span class="lineno">2117</span>    <span class="n">buf</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2118"></a><span class="lineno">2118</span>    <span class="n">buf_end</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<a name="c0-2119"></a><span class="lineno">2119</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage_limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2120"></a><span class="lineno">2120</span>      <span class="n">buf_end</span> <span class="o">+=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2121"></a><span class="lineno">2121</span> 
<a name="c0-2122"></a><span class="lineno">2122</span>    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">buf_end</span><span class="p">;</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2123"></a><span class="lineno">2123</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">))</span>
<a name="c0-2124"></a><span class="lineno">2124</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-2125"></a><span class="lineno">2125</span>    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="n">buf_end</span><span class="p">)</span>
<a name="c0-2126"></a><span class="lineno">2126</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2127"></a><span class="lineno">2127</span>  <span class="p">}</span>
<a name="c0-2128"></a><span class="lineno">2128</span> 
<a name="c0-2129"></a><span class="lineno">2129</span>  <span class="cm">/*</span>
<a name="c0-2130"></a><span class="lineno">2130</span> <span class="cm">   * No exact match. If we are ignoring whitespace, run a line-by-line</span>
<a name="c0-2131"></a><span class="lineno">2131</span> <span class="cm">   * fuzzy matching. We collect all the line length information because</span>
<a name="c0-2132"></a><span class="lineno">2132</span> <span class="cm">   * we need it to adjust whitespace if we match.</span>
<a name="c0-2133"></a><span class="lineno">2133</span> <span class="cm">   */</span>
<a name="c0-2134"></a><span class="lineno">2134</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ws_ignore_action</span> <span class="o">==</span> <span class="n">ignore_ws_change</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2135"></a><span class="lineno">2135</span>    <span class="kt">size_t</span> <span class="n">imgoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2136"></a><span class="lineno">2136</span>    <span class="kt">size_t</span> <span class="n">preoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2137"></a><span class="lineno">2137</span>    <span class="kt">size_t</span> <span class="n">postlen</span> <span class="o">=</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2138"></a><span class="lineno">2138</span>    <span class="kt">size_t</span> <span class="n">extra_chars</span><span class="p">;</span>
<a name="c0-2139"></a><span class="lineno">2139</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">preimage_eof</span><span class="p">;</span>
<a name="c0-2140"></a><span class="lineno">2140</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">preimage_end</span><span class="p">;</span>
<a name="c0-2141"></a><span class="lineno">2141</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage_limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2142"></a><span class="lineno">2142</span>      <span class="kt">size_t</span> <span class="n">prelen</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2143"></a><span class="lineno">2143</span>      <span class="kt">size_t</span> <span class="n">imglen</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">try_lno</span><span class="o">+</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2144"></a><span class="lineno">2144</span> 
<a name="c0-2145"></a><span class="lineno">2145</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fuzzy_matchlines</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">try</span> <span class="o">+</span> <span class="n">imgoff</span><span class="p">,</span> <span class="n">imglen</span><span class="p">,</span>
<a name="c0-2146"></a><span class="lineno">2146</span>                <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">preoff</span><span class="p">,</span> <span class="n">prelen</span><span class="p">))</span>
<a name="c0-2147"></a><span class="lineno">2147</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2148"></a><span class="lineno">2148</span>      <span class="k">if</span> <span class="p">(</span><span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">LINE_COMMON</span><span class="p">)</span>
<a name="c0-2149"></a><span class="lineno">2149</span>        <span class="n">postlen</span> <span class="o">+=</span> <span class="n">imglen</span> <span class="o">-</span> <span class="n">prelen</span><span class="p">;</span>
<a name="c0-2150"></a><span class="lineno">2150</span>      <span class="n">imgoff</span> <span class="o">+=</span> <span class="n">imglen</span><span class="p">;</span>
<a name="c0-2151"></a><span class="lineno">2151</span>      <span class="n">preoff</span> <span class="o">+=</span> <span class="n">prelen</span><span class="p">;</span>
<a name="c0-2152"></a><span class="lineno">2152</span>    <span class="p">}</span>
<a name="c0-2153"></a><span class="lineno">2153</span> 
<a name="c0-2154"></a><span class="lineno">2154</span>    <span class="cm">/*</span>
<a name="c0-2155"></a><span class="lineno">2155</span> <span class="cm">     * Ok, the preimage matches with whitespace fuzz.</span>
<a name="c0-2156"></a><span class="lineno">2156</span> <span class="cm">     *</span>
<a name="c0-2157"></a><span class="lineno">2157</span> <span class="cm">     * imgoff now holds the true length of the target that</span>
<a name="c0-2158"></a><span class="lineno">2158</span> <span class="cm">     * matches the preimage before the end of the file.</span>
<a name="c0-2159"></a><span class="lineno">2159</span> <span class="cm">     *</span>
<a name="c0-2160"></a><span class="lineno">2160</span> <span class="cm">     * Count the number of characters in the preimage that fall</span>
<a name="c0-2161"></a><span class="lineno">2161</span> <span class="cm">     * beyond the end of the file and make sure that all of them</span>
<a name="c0-2162"></a><span class="lineno">2162</span> <span class="cm">     * are whitespace characters. (This can only happen if</span>
<a name="c0-2163"></a><span class="lineno">2163</span> <span class="cm">     * we are removing blank lines at the end of the file.)</span>
<a name="c0-2164"></a><span class="lineno">2164</span> <span class="cm">     */</span>
<a name="c0-2165"></a><span class="lineno">2165</span>    <span class="n">buf</span> <span class="o">=</span> <span class="n">preimage_eof</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">preoff</span><span class="p">;</span>
<a name="c0-2166"></a><span class="lineno">2166</span>    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2167"></a><span class="lineno">2167</span>      <span class="n">preoff</span> <span class="o">+=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2168"></a><span class="lineno">2168</span>    <span class="n">preimage_end</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">preoff</span><span class="p">;</span>
<a name="c0-2169"></a><span class="lineno">2169</span>    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">buf</span> <span class="o">&lt;</span> <span class="n">preimage_end</span><span class="p">;</span> <span class="n">buf</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2170"></a><span class="lineno">2170</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">))</span>
<a name="c0-2171"></a><span class="lineno">2171</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2172"></a><span class="lineno">2172</span> 
<a name="c0-2173"></a><span class="lineno">2173</span>    <span class="cm">/*</span>
<a name="c0-2174"></a><span class="lineno">2174</span> <span class="cm">     * Update the preimage and the common postimage context</span>
<a name="c0-2175"></a><span class="lineno">2175</span> <span class="cm">     * lines to use the same whitespace as the target.</span>
<a name="c0-2176"></a><span class="lineno">2176</span> <span class="cm">     * If whitespace is missing in the target (i.e.</span>
<a name="c0-2177"></a><span class="lineno">2177</span> <span class="cm">     * if the preimage extends beyond the end of the file),</span>
<a name="c0-2178"></a><span class="lineno">2178</span> <span class="cm">     * use the whitespace from the preimage.</span>
<a name="c0-2179"></a><span class="lineno">2179</span> <span class="cm">     */</span>
<a name="c0-2180"></a><span class="lineno">2180</span>    <span class="n">extra_chars</span> <span class="o">=</span> <span class="n">preimage_end</span> <span class="o">-</span> <span class="n">preimage_eof</span><span class="p">;</span>
<a name="c0-2181"></a><span class="lineno">2181</span>    <span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="n">imgoff</span> <span class="o">+</span> <span class="n">extra_chars</span><span class="p">);</span>
<a name="c0-2182"></a><span class="lineno">2182</span>    <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">try</span><span class="p">,</span> <span class="n">imgoff</span><span class="p">);</span>
<a name="c0-2183"></a><span class="lineno">2183</span>    <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="n">preimage_eof</span><span class="p">,</span> <span class="n">extra_chars</span><span class="p">);</span>
<a name="c0-2184"></a><span class="lineno">2184</span>    <span class="n">fixed_buf</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fixed_len</span><span class="p">);</span>
<a name="c0-2185"></a><span class="lineno">2185</span>    <span class="n">update_pre_post_images</span><span class="p">(</span><span class="n">preimage</span><span class="p">,</span> <span class="n">postimage</span><span class="p">,</span>
<a name="c0-2186"></a><span class="lineno">2186</span>        <span class="n">fixed_buf</span><span class="p">,</span> <span class="n">fixed_len</span><span class="p">,</span> <span class="n">postlen</span><span class="p">);</span>
<a name="c0-2187"></a><span class="lineno">2187</span>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2188"></a><span class="lineno">2188</span>  <span class="p">}</span>
<a name="c0-2189"></a><span class="lineno">2189</span> 
<a name="c0-2190"></a><span class="lineno">2190</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ws_error_action</span> <span class="o">!=</span> <span class="n">correct_ws_error</span><span class="p">)</span>
<a name="c0-2191"></a><span class="lineno">2191</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2192"></a><span class="lineno">2192</span> 
<a name="c0-2193"></a><span class="lineno">2193</span>  <span class="cm">/*</span>
<a name="c0-2194"></a><span class="lineno">2194</span> <span class="cm">   * The hunk does not apply byte-by-byte, but the hash says</span>
<a name="c0-2195"></a><span class="lineno">2195</span> <span class="cm">   * it might with whitespace fuzz. We haven't been asked to</span>
<a name="c0-2196"></a><span class="lineno">2196</span> <span class="cm">   * ignore whitespace, we were asked to correct whitespace</span>
<a name="c0-2197"></a><span class="lineno">2197</span> <span class="cm">   * errors, so let's try matching after whitespace correction.</span>
<a name="c0-2198"></a><span class="lineno">2198</span> <span class="cm">   *</span>
<a name="c0-2199"></a><span class="lineno">2199</span> <span class="cm">   * The preimage may extend beyond the end of the file,</span>
<a name="c0-2200"></a><span class="lineno">2200</span> <span class="cm">   * but in this loop we will only handle the part of the</span>
<a name="c0-2201"></a><span class="lineno">2201</span> <span class="cm">   * preimage that falls within the file.</span>
<a name="c0-2202"></a><span class="lineno">2202</span> <span class="cm">   */</span>
<a name="c0-2203"></a><span class="lineno">2203</span>  <span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-2204"></a><span class="lineno">2204</span>  <span class="n">orig</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2205"></a><span class="lineno">2205</span>  <span class="n">target</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">try</span><span class="p">;</span>
<a name="c0-2206"></a><span class="lineno">2206</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage_limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2207"></a><span class="lineno">2207</span>    <span class="kt">size_t</span> <span class="n">oldlen</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2208"></a><span class="lineno">2208</span>    <span class="kt">size_t</span> <span class="n">tgtlen</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">try_lno</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2209"></a><span class="lineno">2209</span>    <span class="kt">size_t</span> <span class="n">fixstart</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2210"></a><span class="lineno">2210</span>    <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">tgtfix</span><span class="p">;</span>
<a name="c0-2211"></a><span class="lineno">2211</span>    <span class="kt">int</span> <span class="n">match</span><span class="p">;</span>
<a name="c0-2212"></a><span class="lineno">2212</span> 
<a name="c0-2213"></a><span class="lineno">2213</span>    <span class="cm">/* Try fixing the line in the preimage */</span>
<a name="c0-2214"></a><span class="lineno">2214</span>    <span class="n">ws_fix_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">oldlen</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2215"></a><span class="lineno">2215</span> 
<a name="c0-2216"></a><span class="lineno">2216</span>    <span class="cm">/* Try fixing the line in the target */</span>
<a name="c0-2217"></a><span class="lineno">2217</span>    <span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgtfix</span><span class="p">,</span> <span class="n">tgtlen</span><span class="p">);</span>
<a name="c0-2218"></a><span class="lineno">2218</span>    <span class="n">ws_fix_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgtfix</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tgtlen</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2219"></a><span class="lineno">2219</span> 
<a name="c0-2220"></a><span class="lineno">2220</span>    <span class="cm">/*</span>
<a name="c0-2221"></a><span class="lineno">2221</span> <span class="cm">     * If they match, either the preimage was based on</span>
<a name="c0-2222"></a><span class="lineno">2222</span> <span class="cm">     * a version before our tree fixed whitespace breakage,</span>
<a name="c0-2223"></a><span class="lineno">2223</span> <span class="cm">     * or we are lacking a whitespace-fix patch the tree</span>
<a name="c0-2224"></a><span class="lineno">2224</span> <span class="cm">     * the preimage was based on already had (i.e. target</span>
<a name="c0-2225"></a><span class="lineno">2225</span> <span class="cm">     * has whitespace breakage, the preimage doesn't).</span>
<a name="c0-2226"></a><span class="lineno">2226</span> <span class="cm">     * In either case, we are fixing the whitespace breakages</span>
<a name="c0-2227"></a><span class="lineno">2227</span> <span class="cm">     * so we might as well take the fix together with their</span>
<a name="c0-2228"></a><span class="lineno">2228</span> <span class="cm">     * real change.</span>
<a name="c0-2229"></a><span class="lineno">2229</span> <span class="cm">     */</span>
<a name="c0-2230"></a><span class="lineno">2230</span>    <span class="n">match</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgtfix</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="n">fixed</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">fixstart</span> <span class="o">&amp;&amp;</span>
<a name="c0-2231"></a><span class="lineno">2231</span>       <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tgtfix</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">fixed</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">fixstart</span><span class="p">,</span>
<a name="c0-2232"></a><span class="lineno">2232</span>               <span class="n">fixed</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">fixstart</span><span class="p">));</span>
<a name="c0-2233"></a><span class="lineno">2233</span> 
<a name="c0-2234"></a><span class="lineno">2234</span>    <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tgtfix</span><span class="p">);</span>
<a name="c0-2235"></a><span class="lineno">2235</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
<a name="c0-2236"></a><span class="lineno">2236</span>      <span class="k">goto</span> <span class="n">unmatch_exit</span><span class="p">;</span>
<a name="c0-2237"></a><span class="lineno">2237</span> 
<a name="c0-2238"></a><span class="lineno">2238</span>    <span class="n">orig</span> <span class="o">+=</span> <span class="n">oldlen</span><span class="p">;</span>
<a name="c0-2239"></a><span class="lineno">2239</span>    <span class="n">target</span> <span class="o">+=</span> <span class="n">tgtlen</span><span class="p">;</span>
<a name="c0-2240"></a><span class="lineno">2240</span>  <span class="p">}</span>
<a name="c0-2241"></a><span class="lineno">2241</span> 
<a name="c0-2242"></a><span class="lineno">2242</span> 
<a name="c0-2243"></a><span class="lineno">2243</span>  <span class="cm">/*</span>
<a name="c0-2244"></a><span class="lineno">2244</span> <span class="cm">   * Now handle the lines in the preimage that falls beyond the</span>
<a name="c0-2245"></a><span class="lineno">2245</span> <span class="cm">   * end of the file (if any). They will only match if they are</span>
<a name="c0-2246"></a><span class="lineno">2246</span> <span class="cm">   * empty or only contain whitespace (if WS_BLANK_AT_EOL is</span>
<a name="c0-2247"></a><span class="lineno">2247</span> <span class="cm">   * false).</span>
<a name="c0-2248"></a><span class="lineno">2248</span> <span class="cm">   */</span>
<a name="c0-2249"></a><span class="lineno">2249</span>  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2250"></a><span class="lineno">2250</span>    <span class="kt">size_t</span> <span class="n">fixstart</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="cm">/* start of the fixed preimage */</span>
<a name="c0-2251"></a><span class="lineno">2251</span>    <span class="kt">size_t</span> <span class="n">oldlen</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2252"></a><span class="lineno">2252</span>    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<a name="c0-2253"></a><span class="lineno">2253</span> 
<a name="c0-2254"></a><span class="lineno">2254</span>    <span class="cm">/* Try fixing the line in the preimage */</span>
<a name="c0-2255"></a><span class="lineno">2255</span>    <span class="n">ws_fix_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">oldlen</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-2256"></a><span class="lineno">2256</span> 
<a name="c0-2257"></a><span class="lineno">2257</span>    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">fixstart</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">fixed</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2258"></a><span class="lineno">2258</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="n">fixed</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
<a name="c0-2259"></a><span class="lineno">2259</span>        <span class="k">goto</span> <span class="n">unmatch_exit</span><span class="p">;</span>
<a name="c0-2260"></a><span class="lineno">2260</span> 
<a name="c0-2261"></a><span class="lineno">2261</span>    <span class="n">orig</span> <span class="o">+=</span> <span class="n">oldlen</span><span class="p">;</span>
<a name="c0-2262"></a><span class="lineno">2262</span>  <span class="p">}</span>
<a name="c0-2263"></a><span class="lineno">2263</span> 
<a name="c0-2264"></a><span class="lineno">2264</span>  <span class="cm">/*</span>
<a name="c0-2265"></a><span class="lineno">2265</span> <span class="cm">   * Yes, the preimage is based on an older version that still</span>
<a name="c0-2266"></a><span class="lineno">2266</span> <span class="cm">   * has whitespace breakages unfixed, and fixing them makes the</span>
<a name="c0-2267"></a><span class="lineno">2267</span> <span class="cm">   * hunk match.  Update the context lines in the postimage.</span>
<a name="c0-2268"></a><span class="lineno">2268</span> <span class="cm">   */</span>
<a name="c0-2269"></a><span class="lineno">2269</span>  <span class="n">fixed_buf</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fixed_len</span><span class="p">);</span>
<a name="c0-2270"></a><span class="lineno">2270</span>  <span class="n">update_pre_post_images</span><span class="p">(</span><span class="n">preimage</span><span class="p">,</span> <span class="n">postimage</span><span class="p">,</span>
<a name="c0-2271"></a><span class="lineno">2271</span>             <span class="n">fixed_buf</span><span class="p">,</span> <span class="n">fixed_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2272"></a><span class="lineno">2272</span>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2273"></a><span class="lineno">2273</span> 
<a name="c0-2274"></a><span class="lineno">2274</span>  <span class="nl">unmatch_exit:</span>
<a name="c0-2275"></a><span class="lineno">2275</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fixed</span><span class="p">);</span>
<a name="c0-2276"></a><span class="lineno">2276</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2277"></a><span class="lineno">2277</span> <span class="p">}</span>
<a name="c0-2278"></a><span class="lineno">2278</span> 
<a name="c0-2279"></a><span class="lineno">2279</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">find_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span>
<a name="c0-2280"></a><span class="lineno">2280</span>        <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">preimage</span><span class="p">,</span>
<a name="c0-2281"></a><span class="lineno">2281</span>        <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">postimage</span><span class="p">,</span>
<a name="c0-2282"></a><span class="lineno">2282</span>        <span class="kt">int</span> <span class="n">line</span><span class="p">,</span>
<a name="c0-2283"></a><span class="lineno">2283</span>        <span class="kt">unsigned</span> <span class="n">ws_rule</span><span class="p">,</span>
<a name="c0-2284"></a><span class="lineno">2284</span>        <span class="kt">int</span> <span class="n">match_beginning</span><span class="p">,</span> <span class="kt">int</span> <span class="n">match_end</span><span class="p">)</span>
<a name="c0-2285"></a><span class="lineno">2285</span> <span class="p">{</span>
<a name="c0-2286"></a><span class="lineno">2286</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-2287"></a><span class="lineno">2287</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">backwards</span><span class="p">,</span> <span class="n">forwards</span><span class="p">,</span> <span class="n">try</span><span class="p">;</span>
<a name="c0-2288"></a><span class="lineno">2288</span>  <span class="kt">int</span> <span class="n">backwards_lno</span><span class="p">,</span> <span class="n">forwards_lno</span><span class="p">,</span> <span class="n">try_lno</span><span class="p">;</span>
<a name="c0-2289"></a><span class="lineno">2289</span> 
<a name="c0-2290"></a><span class="lineno">2290</span>  <span class="cm">/*</span>
<a name="c0-2291"></a><span class="lineno">2291</span> <span class="cm">   * If match_beginning or match_end is specified, there is no</span>
<a name="c0-2292"></a><span class="lineno">2292</span> <span class="cm">   * point starting from a wrong line that will never match and</span>
<a name="c0-2293"></a><span class="lineno">2293</span> <span class="cm">   * wander around and wait for a match at the specified end.</span>
<a name="c0-2294"></a><span class="lineno">2294</span> <span class="cm">   */</span>
<a name="c0-2295"></a><span class="lineno">2295</span>  <span class="k">if</span> <span class="p">(</span><span class="n">match_beginning</span><span class="p">)</span>
<a name="c0-2296"></a><span class="lineno">2296</span>    <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2297"></a><span class="lineno">2297</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">match_end</span><span class="p">)</span>
<a name="c0-2298"></a><span class="lineno">2298</span>    <span class="n">line</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
<a name="c0-2299"></a><span class="lineno">2299</span> 
<a name="c0-2300"></a><span class="lineno">2300</span>  <span class="cm">/*</span>
<a name="c0-2301"></a><span class="lineno">2301</span> <span class="cm">   * Because the comparison is unsigned, the following test</span>
<a name="c0-2302"></a><span class="lineno">2302</span> <span class="cm">   * will also take care of a negative line number that can</span>
<a name="c0-2303"></a><span class="lineno">2303</span> <span class="cm">   * result when match_end and preimage is larger than the target.</span>
<a name="c0-2304"></a><span class="lineno">2304</span> <span class="cm">   */</span>
<a name="c0-2305"></a><span class="lineno">2305</span>  <span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span>
<a name="c0-2306"></a><span class="lineno">2306</span>    <span class="n">line</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
<a name="c0-2307"></a><span class="lineno">2307</span> 
<a name="c0-2308"></a><span class="lineno">2308</span>  <span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2309"></a><span class="lineno">2309</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">line</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2310"></a><span class="lineno">2310</span>    <span class="n">try</span> <span class="o">+=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2311"></a><span class="lineno">2311</span> 
<a name="c0-2312"></a><span class="lineno">2312</span>  <span class="cm">/*</span>
<a name="c0-2313"></a><span class="lineno">2313</span> <span class="cm">   * There's probably some smart way to do this, but I'll leave</span>
<a name="c0-2314"></a><span class="lineno">2314</span> <span class="cm">   * that to the smart and beautiful people. I'm simple and stupid.</span>
<a name="c0-2315"></a><span class="lineno">2315</span> <span class="cm">   */</span>
<a name="c0-2316"></a><span class="lineno">2316</span>  <span class="n">backwards</span> <span class="o">=</span> <span class="n">try</span><span class="p">;</span>
<a name="c0-2317"></a><span class="lineno">2317</span>  <span class="n">backwards_lno</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-2318"></a><span class="lineno">2318</span>  <span class="n">forwards</span> <span class="o">=</span> <span class="n">try</span><span class="p">;</span>
<a name="c0-2319"></a><span class="lineno">2319</span>  <span class="n">forwards_lno</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-2320"></a><span class="lineno">2320</span>  <span class="n">try_lno</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c0-2321"></a><span class="lineno">2321</span> 
<a name="c0-2322"></a><span class="lineno">2322</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2323"></a><span class="lineno">2323</span>    <span class="k">if</span> <span class="p">(</span><span class="n">match_fragment</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">preimage</span><span class="p">,</span> <span class="n">postimage</span><span class="p">,</span>
<a name="c0-2324"></a><span class="lineno">2324</span>           <span class="n">try</span><span class="p">,</span> <span class="n">try_lno</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">,</span>
<a name="c0-2325"></a><span class="lineno">2325</span>           <span class="n">match_beginning</span><span class="p">,</span> <span class="n">match_end</span><span class="p">))</span>
<a name="c0-2326"></a><span class="lineno">2326</span>      <span class="k">return</span> <span class="n">try_lno</span><span class="p">;</span>
<a name="c0-2327"></a><span class="lineno">2327</span> 
<a name="c0-2328"></a><span class="lineno">2328</span>  <span class="nl">again:</span>
<a name="c0-2329"></a><span class="lineno">2329</span>    <span class="k">if</span> <span class="p">(</span><span class="n">backwards_lno</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">forwards_lno</span> <span class="o">==</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span>
<a name="c0-2330"></a><span class="lineno">2330</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2331"></a><span class="lineno">2331</span> 
<a name="c0-2332"></a><span class="lineno">2332</span>    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2333"></a><span class="lineno">2333</span>      <span class="k">if</span> <span class="p">(</span><span class="n">backwards_lno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2334"></a><span class="lineno">2334</span>        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2335"></a><span class="lineno">2335</span>        <span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
<a name="c0-2336"></a><span class="lineno">2336</span>      <span class="p">}</span>
<a name="c0-2337"></a><span class="lineno">2337</span>      <span class="n">backwards_lno</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2338"></a><span class="lineno">2338</span>      <span class="n">backwards</span> <span class="o">-=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">backwards_lno</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2339"></a><span class="lineno">2339</span>      <span class="n">try</span> <span class="o">=</span> <span class="n">backwards</span><span class="p">;</span>
<a name="c0-2340"></a><span class="lineno">2340</span>      <span class="n">try_lno</span> <span class="o">=</span> <span class="n">backwards_lno</span><span class="p">;</span>
<a name="c0-2341"></a><span class="lineno">2341</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2342"></a><span class="lineno">2342</span>      <span class="k">if</span> <span class="p">(</span><span class="n">forwards_lno</span> <span class="o">==</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2343"></a><span class="lineno">2343</span>        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2344"></a><span class="lineno">2344</span>        <span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
<a name="c0-2345"></a><span class="lineno">2345</span>      <span class="p">}</span>
<a name="c0-2346"></a><span class="lineno">2346</span>      <span class="n">forwards</span> <span class="o">+=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">forwards_lno</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2347"></a><span class="lineno">2347</span>      <span class="n">forwards_lno</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2348"></a><span class="lineno">2348</span>      <span class="n">try</span> <span class="o">=</span> <span class="n">forwards</span><span class="p">;</span>
<a name="c0-2349"></a><span class="lineno">2349</span>      <span class="n">try_lno</span> <span class="o">=</span> <span class="n">forwards_lno</span><span class="p">;</span>
<a name="c0-2350"></a><span class="lineno">2350</span>    <span class="p">}</span>
<a name="c0-2351"></a><span class="lineno">2351</span> 
<a name="c0-2352"></a><span class="lineno">2352</span>  <span class="p">}</span>
<a name="c0-2353"></a><span class="lineno">2353</span>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2354"></a><span class="lineno">2354</span> <span class="p">}</span>
<a name="c0-2355"></a><span class="lineno">2355</span> 
<a name="c0-2356"></a><span class="lineno">2356</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_first_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">)</span>
<a name="c0-2357"></a><span class="lineno">2357</span> <span class="p">{</span>
<a name="c0-2358"></a><span class="lineno">2358</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2359"></a><span class="lineno">2359</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2360"></a><span class="lineno">2360</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2361"></a><span class="lineno">2361</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2362"></a><span class="lineno">2362</span> <span class="p">}</span>
<a name="c0-2363"></a><span class="lineno">2363</span> 
<a name="c0-2364"></a><span class="lineno">2364</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_last_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">)</span>
<a name="c0-2365"></a><span class="lineno">2365</span> <span class="p">{</span>
<a name="c0-2366"></a><span class="lineno">2366</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="o">--</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2367"></a><span class="lineno">2367</span> <span class="p">}</span>
<a name="c0-2368"></a><span class="lineno">2368</span> 
<a name="c0-2369"></a><span class="lineno">2369</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">update_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span>
<a name="c0-2370"></a><span class="lineno">2370</span>       <span class="kt">int</span> <span class="n">applied_pos</span><span class="p">,</span>
<a name="c0-2371"></a><span class="lineno">2371</span>       <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">preimage</span><span class="p">,</span>
<a name="c0-2372"></a><span class="lineno">2372</span>       <span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">postimage</span><span class="p">)</span>
<a name="c0-2373"></a><span class="lineno">2373</span> <span class="p">{</span>
<a name="c0-2374"></a><span class="lineno">2374</span>  <span class="cm">/*</span>
<a name="c0-2375"></a><span class="lineno">2375</span> <span class="cm">   * remove the copy of preimage at offset in img</span>
<a name="c0-2376"></a><span class="lineno">2376</span> <span class="cm">   * and replace it with postimage</span>
<a name="c0-2377"></a><span class="lineno">2377</span> <span class="cm">   */</span>
<a name="c0-2378"></a><span class="lineno">2378</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>
<a name="c0-2379"></a><span class="lineno">2379</span>  <span class="kt">size_t</span> <span class="n">remove_count</span><span class="p">,</span> <span class="n">insert_count</span><span class="p">,</span> <span class="n">applied_at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2380"></a><span class="lineno">2380</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="c0-2381"></a><span class="lineno">2381</span>  <span class="kt">int</span> <span class="n">preimage_limit</span><span class="p">;</span>
<a name="c0-2382"></a><span class="lineno">2382</span> 
<a name="c0-2383"></a><span class="lineno">2383</span>  <span class="cm">/*</span>
<a name="c0-2384"></a><span class="lineno">2384</span> <span class="cm">   * If we are removing blank lines at the end of img,</span>
<a name="c0-2385"></a><span class="lineno">2385</span> <span class="cm">   * the preimage may extend beyond the end.</span>
<a name="c0-2386"></a><span class="lineno">2386</span> <span class="cm">   * If that is the case, we must be careful only to</span>
<a name="c0-2387"></a><span class="lineno">2387</span> <span class="cm">   * remove the part of the preimage that falls within</span>
<a name="c0-2388"></a><span class="lineno">2388</span> <span class="cm">   * the boundaries of img. Initialize preimage_limit</span>
<a name="c0-2389"></a><span class="lineno">2389</span> <span class="cm">   * to the number of lines in the preimage that falls</span>
<a name="c0-2390"></a><span class="lineno">2390</span> <span class="cm">   * within the boundaries.</span>
<a name="c0-2391"></a><span class="lineno">2391</span> <span class="cm">   */</span>
<a name="c0-2392"></a><span class="lineno">2392</span>  <span class="n">preimage_limit</span> <span class="o">=</span> <span class="n">preimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
<a name="c0-2393"></a><span class="lineno">2393</span>  <span class="k">if</span> <span class="p">(</span><span class="n">preimage_limit</span> <span class="o">&gt;</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="n">applied_pos</span><span class="p">)</span>
<a name="c0-2394"></a><span class="lineno">2394</span>    <span class="n">preimage_limit</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="n">applied_pos</span><span class="p">;</span>
<a name="c0-2395"></a><span class="lineno">2395</span> 
<a name="c0-2396"></a><span class="lineno">2396</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">applied_pos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2397"></a><span class="lineno">2397</span>    <span class="n">applied_at</span> <span class="o">+=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2398"></a><span class="lineno">2398</span> 
<a name="c0-2399"></a><span class="lineno">2399</span>  <span class="n">remove_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2400"></a><span class="lineno">2400</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">preimage_limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2401"></a><span class="lineno">2401</span>    <span class="n">remove_count</span> <span class="o">+=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">applied_pos</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2402"></a><span class="lineno">2402</span>  <span class="n">insert_count</span> <span class="o">=</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2403"></a><span class="lineno">2403</span> 
<a name="c0-2404"></a><span class="lineno">2404</span>  <span class="cm">/* Adjust the contents */</span>
<a name="c0-2405"></a><span class="lineno">2405</span>  <span class="n">result</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">insert_count</span> <span class="o">-</span> <span class="n">remove_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-2406"></a><span class="lineno">2406</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">applied_at</span><span class="p">);</span>
<a name="c0-2407"></a><span class="lineno">2407</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="n">applied_at</span><span class="p">,</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a name="c0-2408"></a><span class="lineno">2408</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="n">applied_at</span> <span class="o">+</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
<a name="c0-2409"></a><span class="lineno">2409</span>         <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">applied_at</span> <span class="o">+</span> <span class="n">remove_count</span><span class="p">),</span>
<a name="c0-2410"></a><span class="lineno">2410</span>         <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">applied_at</span> <span class="o">+</span> <span class="n">remove_count</span><span class="p">));</span>
<a name="c0-2411"></a><span class="lineno">2411</span>  <span class="n">free</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-2412"></a><span class="lineno">2412</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-2413"></a><span class="lineno">2413</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">insert_count</span> <span class="o">-</span> <span class="n">remove_count</span><span class="p">;</span>
<a name="c0-2414"></a><span class="lineno">2414</span>  <span class="n">result</span><span class="p">[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-2415"></a><span class="lineno">2415</span> 
<a name="c0-2416"></a><span class="lineno">2416</span>  <span class="cm">/* Adjust the line table */</span>
<a name="c0-2417"></a><span class="lineno">2417</span>  <span class="n">nr</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">+</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="n">preimage_limit</span><span class="p">;</span>
<a name="c0-2418"></a><span class="lineno">2418</span>  <span class="k">if</span> <span class="p">(</span><span class="n">preimage_limit</span> <span class="o">&lt;</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2419"></a><span class="lineno">2419</span>    <span class="cm">/*</span>
<a name="c0-2420"></a><span class="lineno">2420</span> <span class="cm">     * NOTE: this knows that we never call remove_first_line()</span>
<a name="c0-2421"></a><span class="lineno">2421</span> <span class="cm">     * on anything other than pre/post image.</span>
<a name="c0-2422"></a><span class="lineno">2422</span> <span class="cm">     */</span>
<a name="c0-2423"></a><span class="lineno">2423</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<a name="c0-2424"></a><span class="lineno">2424</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">line_allocated</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
<a name="c0-2425"></a><span class="lineno">2425</span>  <span class="p">}</span>
<a name="c0-2426"></a><span class="lineno">2426</span>  <span class="k">if</span> <span class="p">(</span><span class="n">preimage_limit</span> <span class="o">!=</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span>
<a name="c0-2427"></a><span class="lineno">2427</span>    <span class="n">memmove</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">+</span> <span class="n">applied_pos</span> <span class="o">+</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span>
<a name="c0-2428"></a><span class="lineno">2428</span>      <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">+</span> <span class="n">applied_pos</span> <span class="o">+</span> <span class="n">preimage_limit</span><span class="p">,</span>
<a name="c0-2429"></a><span class="lineno">2429</span>      <span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="p">(</span><span class="n">applied_pos</span> <span class="o">+</span> <span class="n">preimage_limit</span><span class="p">))</span> <span class="o">*</span>
<a name="c0-2430"></a><span class="lineno">2430</span>      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<a name="c0-2431"></a><span class="lineno">2431</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">+</span> <span class="n">applied_pos</span><span class="p">,</span>
<a name="c0-2432"></a><span class="lineno">2432</span>         <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
<a name="c0-2433"></a><span class="lineno">2433</span>         <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">));</span>
<a name="c0-2434"></a><span class="lineno">2434</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">allow_overlap</span><span class="p">)</span>
<a name="c0-2435"></a><span class="lineno">2435</span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">postimage</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="c0-2436"></a><span class="lineno">2436</span>      <span class="n">img</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">[</span><span class="n">applied_pos</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">LINE_PATCHED</span><span class="p">;</span>
<a name="c0-2437"></a><span class="lineno">2437</span>  <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
<a name="c0-2438"></a><span class="lineno">2438</span> <span class="p">}</span>
<a name="c0-2439"></a><span class="lineno">2439</span> 
<a name="c0-2440"></a><span class="lineno">2440</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_one_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span>
<a name="c0-2441"></a><span class="lineno">2441</span>            <span class="kt">int</span> <span class="n">inaccurate_eof</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ws_rule</span><span class="p">,</span>
<a name="c0-2442"></a><span class="lineno">2442</span>            <span class="kt">int</span> <span class="n">nth_fragment</span><span class="p">)</span>
<a name="c0-2443"></a><span class="lineno">2443</span> <span class="p">{</span>
<a name="c0-2444"></a><span class="lineno">2444</span>  <span class="kt">int</span> <span class="n">match_beginning</span><span class="p">,</span> <span class="n">match_end</span><span class="p">;</span>
<a name="c0-2445"></a><span class="lineno">2445</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">patch</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">;</span>
<a name="c0-2446"></a><span class="lineno">2446</span>  <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<a name="c0-2447"></a><span class="lineno">2447</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="o">*</span><span class="n">oldlines</span><span class="p">;</span>
<a name="c0-2448"></a><span class="lineno">2448</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">newlines</span><span class="p">;</span>
<a name="c0-2449"></a><span class="lineno">2449</span>  <span class="kt">int</span> <span class="n">new_blank_lines_at_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2450"></a><span class="lineno">2450</span>  <span class="kt">int</span> <span class="n">found_new_blank_lines_at_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2451"></a><span class="lineno">2451</span>  <span class="kt">int</span> <span class="n">hunk_linenr</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">linenr</span><span class="p">;</span>
<a name="c0-2452"></a><span class="lineno">2452</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">leading</span><span class="p">,</span> <span class="n">trailing</span><span class="p">;</span>
<a name="c0-2453"></a><span class="lineno">2453</span>  <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">applied_pos</span><span class="p">;</span>
<a name="c0-2454"></a><span class="lineno">2454</span>  <span class="k">struct</span> <span class="n">image</span> <span class="n">preimage</span><span class="p">;</span>
<a name="c0-2455"></a><span class="lineno">2455</span>  <span class="k">struct</span> <span class="n">image</span> <span class="n">postimage</span><span class="p">;</span>
<a name="c0-2456"></a><span class="lineno">2456</span> 
<a name="c0-2457"></a><span class="lineno">2457</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preimage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">preimage</span><span class="p">));</span>
<a name="c0-2458"></a><span class="lineno">2458</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">postimage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">postimage</span><span class="p">));</span>
<a name="c0-2459"></a><span class="lineno">2459</span>  <span class="n">oldlines</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<a name="c0-2460"></a><span class="lineno">2460</span>  <span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlines</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-2461"></a><span class="lineno">2461</span> 
<a name="c0-2462"></a><span class="lineno">2462</span>  <span class="n">old</span> <span class="o">=</span> <span class="n">oldlines</span><span class="p">;</span>
<a name="c0-2463"></a><span class="lineno">2463</span>  <span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2464"></a><span class="lineno">2464</span>    <span class="kt">char</span> <span class="n">first</span><span class="p">;</span>
<a name="c0-2465"></a><span class="lineno">2465</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-2466"></a><span class="lineno">2466</span>    <span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>
<a name="c0-2467"></a><span class="lineno">2467</span>    <span class="kt">int</span> <span class="n">added_blank_line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2468"></a><span class="lineno">2468</span>    <span class="kt">int</span> <span class="n">is_blank_context</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2469"></a><span class="lineno">2469</span>    <span class="kt">size_t</span> <span class="n">start</span><span class="p">;</span>
<a name="c0-2470"></a><span class="lineno">2470</span> 
<a name="c0-2471"></a><span class="lineno">2471</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c0-2472"></a><span class="lineno">2472</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2473"></a><span class="lineno">2473</span> 
<a name="c0-2474"></a><span class="lineno">2474</span>    <span class="cm">/*</span>
<a name="c0-2475"></a><span class="lineno">2475</span> <span class="cm">     * "plen" is how much of the line we should use for</span>
<a name="c0-2476"></a><span class="lineno">2476</span> <span class="cm">     * the actual patch data. Normally we just remove the</span>
<a name="c0-2477"></a><span class="lineno">2477</span> <span class="cm">     * first character on the line, but if the line is</span>
<a name="c0-2478"></a><span class="lineno">2478</span> <span class="cm">     * followed by "\ No newline", then we also remove the</span>
<a name="c0-2479"></a><span class="lineno">2479</span> <span class="cm">     * last one (which is the newline, of course).</span>
<a name="c0-2480"></a><span class="lineno">2480</span> <span class="cm">     */</span>
<a name="c0-2481"></a><span class="lineno">2481</span>    <span class="n">plen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2482"></a><span class="lineno">2482</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="p">)</span>
<a name="c0-2483"></a><span class="lineno">2483</span>      <span class="n">plen</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2484"></a><span class="lineno">2484</span>    <span class="n">first</span> <span class="o">=</span> <span class="o">*</span><span class="n">patch</span><span class="p">;</span>
<a name="c0-2485"></a><span class="lineno">2485</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_in_reverse</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2486"></a><span class="lineno">2486</span>      <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-2487"></a><span class="lineno">2487</span>        <span class="n">first</span> <span class="o">=</span> <span class="sc">'+'</span><span class="p">;</span>
<a name="c0-2488"></a><span class="lineno">2488</span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span>
<a name="c0-2489"></a><span class="lineno">2489</span>        <span class="n">first</span> <span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>
<a name="c0-2490"></a><span class="lineno">2490</span>    <span class="p">}</span>
<a name="c0-2491"></a><span class="lineno">2491</span> 
<a name="c0-2492"></a><span class="lineno">2492</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2493"></a><span class="lineno">2493</span>    <span class="k">case</span> <span class="sc">'\n'</span>:
<a name="c0-2494"></a><span class="lineno">2494</span>      <span class="cm">/* Newer GNU diff, empty context line */</span>
<a name="c0-2495"></a><span class="lineno">2495</span>      <span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2496"></a><span class="lineno">2496</span>        <span class="cm">/* ... followed by '\No newline'; nothing */</span>
<a name="c0-2497"></a><span class="lineno">2497</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-2498"></a><span class="lineno">2498</span>      <span class="o">*</span><span class="n">old</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c0-2499"></a><span class="lineno">2499</span>      <span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlines</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">);</span>
<a name="c0-2500"></a><span class="lineno">2500</span>      <span class="n">add_line_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preimage</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LINE_COMMON</span><span class="p">);</span>
<a name="c0-2501"></a><span class="lineno">2501</span>      <span class="n">add_line_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">postimage</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LINE_COMMON</span><span class="p">);</span>
<a name="c0-2502"></a><span class="lineno">2502</span>      <span class="n">is_blank_context</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2503"></a><span class="lineno">2503</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2504"></a><span class="lineno">2504</span>    <span class="k">case</span> <span class="sc">' '</span>:
<a name="c0-2505"></a><span class="lineno">2505</span>      <span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ws_rule</span> <span class="o">&amp;</span> <span class="n">WS_BLANK_AT_EOF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2506"></a><span class="lineno">2506</span>          <span class="n">ws_blank_line</span><span class="p">(</span><span class="n">patch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">))</span>
<a name="c0-2507"></a><span class="lineno">2507</span>        <span class="n">is_blank_context</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2508"></a><span class="lineno">2508</span>    <span class="k">case</span> <span class="sc">'-'</span>:
<a name="c0-2509"></a><span class="lineno">2509</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">patch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
<a name="c0-2510"></a><span class="lineno">2510</span>      <span class="n">add_line_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preimage</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span>
<a name="c0-2511"></a><span class="lineno">2511</span>              <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">' '</span> <span class="o">?</span> <span class="n">LINE_COMMON</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<a name="c0-2512"></a><span class="lineno">2512</span>      <span class="n">old</span> <span class="o">+=</span> <span class="n">plen</span><span class="p">;</span>
<a name="c0-2513"></a><span class="lineno">2513</span>      <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span>
<a name="c0-2514"></a><span class="lineno">2514</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-2515"></a><span class="lineno">2515</span>    <span class="cm">/* Fall-through for ' ' */</span>
<a name="c0-2516"></a><span class="lineno">2516</span>    <span class="k">case</span> <span class="sc">'+'</span>:
<a name="c0-2517"></a><span class="lineno">2517</span>      <span class="cm">/* --no-add does not add new lines */</span>
<a name="c0-2518"></a><span class="lineno">2518</span>      <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">&amp;&amp;</span> <span class="n">no_add</span><span class="p">)</span>
<a name="c0-2519"></a><span class="lineno">2519</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-2520"></a><span class="lineno">2520</span> 
<a name="c0-2521"></a><span class="lineno">2521</span>      <span class="n">start</span> <span class="o">=</span> <span class="n">newlines</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2522"></a><span class="lineno">2522</span>      <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="sc">'+'</span> <span class="o">||</span>
<a name="c0-2523"></a><span class="lineno">2523</span>          <span class="o">!</span><span class="n">whitespace_error</span> <span class="o">||</span>
<a name="c0-2524"></a><span class="lineno">2524</span>          <span class="n">ws_error_action</span> <span class="o">!=</span> <span class="n">correct_ws_error</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2525"></a><span class="lineno">2525</span>        <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlines</span><span class="p">,</span> <span class="n">patch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
<a name="c0-2526"></a><span class="lineno">2526</span>      <span class="p">}</span>
<a name="c0-2527"></a><span class="lineno">2527</span>      <span class="k">else</span> <span class="p">{</span>
<a name="c0-2528"></a><span class="lineno">2528</span>        <span class="n">ws_fix_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlines</span><span class="p">,</span> <span class="n">patch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">applied_after_fixing_ws</span><span class="p">);</span>
<a name="c0-2529"></a><span class="lineno">2529</span>      <span class="p">}</span>
<a name="c0-2530"></a><span class="lineno">2530</span>      <span class="n">add_line_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">postimage</span><span class="p">,</span> <span class="n">newlines</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">newlines</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
<a name="c0-2531"></a><span class="lineno">2531</span>              <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">LINE_COMMON</span><span class="p">));</span>
<a name="c0-2532"></a><span class="lineno">2532</span>      <span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">&amp;&amp;</span>
<a name="c0-2533"></a><span class="lineno">2533</span>          <span class="p">(</span><span class="n">ws_rule</span> <span class="o">&amp;</span> <span class="n">WS_BLANK_AT_EOF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2534"></a><span class="lineno">2534</span>          <span class="n">ws_blank_line</span><span class="p">(</span><span class="n">patch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">))</span>
<a name="c0-2535"></a><span class="lineno">2535</span>        <span class="n">added_blank_line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2536"></a><span class="lineno">2536</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2537"></a><span class="lineno">2537</span>    <span class="k">case</span> <span class="sc">'@'</span>: <span class="k">case</span> <span class="sc">'\\'</span>:
<a name="c0-2538"></a><span class="lineno">2538</span>      <span class="cm">/* Ignore it, we already handled it */</span>
<a name="c0-2539"></a><span class="lineno">2539</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2540"></a><span class="lineno">2540</span>    <span class="nl">default:</span>
<a name="c0-2541"></a><span class="lineno">2541</span>      <span class="k">if</span> <span class="p">(</span><span class="n">apply_verbosely</span><span class="p">)</span>
<a name="c0-2542"></a><span class="lineno">2542</span>        <span class="n">error</span><span class="p">(</span><span class="s">"invalid start of line: '%c'"</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>
<a name="c0-2543"></a><span class="lineno">2543</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2544"></a><span class="lineno">2544</span>    <span class="p">}</span>
<a name="c0-2545"></a><span class="lineno">2545</span>    <span class="k">if</span> <span class="p">(</span><span class="n">added_blank_line</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2546"></a><span class="lineno">2546</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_blank_lines_at_end</span><span class="p">)</span>
<a name="c0-2547"></a><span class="lineno">2547</span>        <span class="n">found_new_blank_lines_at_end</span> <span class="o">=</span> <span class="n">hunk_linenr</span><span class="p">;</span>
<a name="c0-2548"></a><span class="lineno">2548</span>      <span class="n">new_blank_lines_at_end</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2549"></a><span class="lineno">2549</span>    <span class="p">}</span>
<a name="c0-2550"></a><span class="lineno">2550</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_blank_context</span><span class="p">)</span>
<a name="c0-2551"></a><span class="lineno">2551</span>      <span class="p">;</span>
<a name="c0-2552"></a><span class="lineno">2552</span>    <span class="k">else</span>
<a name="c0-2553"></a><span class="lineno">2553</span>      <span class="n">new_blank_lines_at_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2554"></a><span class="lineno">2554</span>    <span class="n">patch</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2555"></a><span class="lineno">2555</span>    <span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2556"></a><span class="lineno">2556</span>    <span class="n">hunk_linenr</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2557"></a><span class="lineno">2557</span>  <span class="p">}</span>
<a name="c0-2558"></a><span class="lineno">2558</span>  <span class="k">if</span> <span class="p">(</span><span class="n">inaccurate_eof</span> <span class="o">&amp;&amp;</span>
<a name="c0-2559"></a><span class="lineno">2559</span>      <span class="n">old</span> <span class="o">&gt;</span> <span class="n">oldlines</span> <span class="o">&amp;&amp;</span> <span class="n">old</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">&amp;&amp;</span>
<a name="c0-2560"></a><span class="lineno">2560</span>      <span class="n">newlines</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">newlines</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">newlines</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2561"></a><span class="lineno">2561</span>    <span class="n">old</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2562"></a><span class="lineno">2562</span>    <span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlines</span><span class="p">,</span> <span class="n">newlines</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-2563"></a><span class="lineno">2563</span>  <span class="p">}</span>
<a name="c0-2564"></a><span class="lineno">2564</span> 
<a name="c0-2565"></a><span class="lineno">2565</span>  <span class="n">leading</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">leading</span><span class="p">;</span>
<a name="c0-2566"></a><span class="lineno">2566</span>  <span class="n">trailing</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">trailing</span><span class="p">;</span>
<a name="c0-2567"></a><span class="lineno">2567</span> 
<a name="c0-2568"></a><span class="lineno">2568</span>  <span class="cm">/*</span>
<a name="c0-2569"></a><span class="lineno">2569</span> <span class="cm">   * A hunk to change lines at the beginning would begin with</span>
<a name="c0-2570"></a><span class="lineno">2570</span> <span class="cm">   * @@ -1,L +N,M @@</span>
<a name="c0-2571"></a><span class="lineno">2571</span> <span class="cm">   * but we need to be careful.  -U0 that inserts before the second</span>
<a name="c0-2572"></a><span class="lineno">2572</span> <span class="cm">   * line also has this pattern.</span>
<a name="c0-2573"></a><span class="lineno">2573</span> <span class="cm">   *</span>
<a name="c0-2574"></a><span class="lineno">2574</span> <span class="cm">   * And a hunk to add to an empty file would begin with</span>
<a name="c0-2575"></a><span class="lineno">2575</span> <span class="cm">   * @@ -0,0 +N,M @@</span>
<a name="c0-2576"></a><span class="lineno">2576</span> <span class="cm">   *</span>
<a name="c0-2577"></a><span class="lineno">2577</span> <span class="cm">   * In other words, a hunk that is (frag-&gt;oldpos &lt;= 1) with or</span>
<a name="c0-2578"></a><span class="lineno">2578</span> <span class="cm">   * without leading context must match at the beginning.</span>
<a name="c0-2579"></a><span class="lineno">2579</span> <span class="cm">   */</span>
<a name="c0-2580"></a><span class="lineno">2580</span>  <span class="n">match_beginning</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">oldpos</span> <span class="o">||</span>
<a name="c0-2581"></a><span class="lineno">2581</span>         <span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">oldpos</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unidiff_zero</span><span class="p">));</span>
<a name="c0-2582"></a><span class="lineno">2582</span> 
<a name="c0-2583"></a><span class="lineno">2583</span>  <span class="cm">/*</span>
<a name="c0-2584"></a><span class="lineno">2584</span> <span class="cm">   * A hunk without trailing lines must match at the end.</span>
<a name="c0-2585"></a><span class="lineno">2585</span> <span class="cm">   * However, we simply cannot tell if a hunk must match end</span>
<a name="c0-2586"></a><span class="lineno">2586</span> <span class="cm">   * from the lack of trailing lines if the patch was generated</span>
<a name="c0-2587"></a><span class="lineno">2587</span> <span class="cm">   * with unidiff without any context.</span>
<a name="c0-2588"></a><span class="lineno">2588</span> <span class="cm">   */</span>
<a name="c0-2589"></a><span class="lineno">2589</span>  <span class="n">match_end</span> <span class="o">=</span> <span class="o">!</span><span class="n">unidiff_zero</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">trailing</span><span class="p">;</span>
<a name="c0-2590"></a><span class="lineno">2590</span> 
<a name="c0-2591"></a><span class="lineno">2591</span>  <span class="n">pos</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">newpos</span> <span class="o">?</span> <span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">newpos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2592"></a><span class="lineno">2592</span>  <span class="n">preimage</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">oldlines</span><span class="p">;</span>
<a name="c0-2593"></a><span class="lineno">2593</span>  <span class="n">preimage</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">old</span> <span class="o">-</span> <span class="n">oldlines</span><span class="p">;</span>
<a name="c0-2594"></a><span class="lineno">2594</span>  <span class="n">postimage</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">newlines</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2595"></a><span class="lineno">2595</span>  <span class="n">postimage</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">newlines</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2596"></a><span class="lineno">2596</span>  <span class="n">preimage</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">preimage</span><span class="p">.</span><span class="n">line_allocated</span><span class="p">;</span>
<a name="c0-2597"></a><span class="lineno">2597</span>  <span class="n">postimage</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">postimage</span><span class="p">.</span><span class="n">line_allocated</span><span class="p">;</span>
<a name="c0-2598"></a><span class="lineno">2598</span> 
<a name="c0-2599"></a><span class="lineno">2599</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-2600"></a><span class="lineno">2600</span> 
<a name="c0-2601"></a><span class="lineno">2601</span>    <span class="n">applied_pos</span> <span class="o">=</span> <span class="n">find_pos</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">preimage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">postimage</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
<a name="c0-2602"></a><span class="lineno">2602</span>               <span class="n">ws_rule</span><span class="p">,</span> <span class="n">match_beginning</span><span class="p">,</span> <span class="n">match_end</span><span class="p">);</span>
<a name="c0-2603"></a><span class="lineno">2603</span> 
<a name="c0-2604"></a><span class="lineno">2604</span>    <span class="k">if</span> <span class="p">(</span><span class="n">applied_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2605"></a><span class="lineno">2605</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2606"></a><span class="lineno">2606</span> 
<a name="c0-2607"></a><span class="lineno">2607</span>    <span class="cm">/* Am I at my context limits? */</span>
<a name="c0-2608"></a><span class="lineno">2608</span>    <span class="k">if</span> <span class="p">((</span><span class="n">leading</span> <span class="o">&lt;=</span> <span class="n">p_context</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trailing</span> <span class="o">&lt;=</span> <span class="n">p_context</span><span class="p">))</span>
<a name="c0-2609"></a><span class="lineno">2609</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-2610"></a><span class="lineno">2610</span>    <span class="k">if</span> <span class="p">(</span><span class="n">match_beginning</span> <span class="o">||</span> <span class="n">match_end</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2611"></a><span class="lineno">2611</span>      <span class="n">match_beginning</span> <span class="o">=</span> <span class="n">match_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2612"></a><span class="lineno">2612</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-2613"></a><span class="lineno">2613</span>    <span class="p">}</span>
<a name="c0-2614"></a><span class="lineno">2614</span> 
<a name="c0-2615"></a><span class="lineno">2615</span>    <span class="cm">/*</span>
<a name="c0-2616"></a><span class="lineno">2616</span> <span class="cm">     * Reduce the number of context lines; reduce both</span>
<a name="c0-2617"></a><span class="lineno">2617</span> <span class="cm">     * leading and trailing if they are equal otherwise</span>
<a name="c0-2618"></a><span class="lineno">2618</span> <span class="cm">     * just reduce the larger context.</span>
<a name="c0-2619"></a><span class="lineno">2619</span> <span class="cm">     */</span>
<a name="c0-2620"></a><span class="lineno">2620</span>    <span class="k">if</span> <span class="p">(</span><span class="n">leading</span> <span class="o">&gt;=</span> <span class="n">trailing</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2621"></a><span class="lineno">2621</span>      <span class="n">remove_first_line</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preimage</span><span class="p">);</span>
<a name="c0-2622"></a><span class="lineno">2622</span>      <span class="n">remove_first_line</span><span class="p">(</span><span class="o">&amp;</span><span class="n">postimage</span><span class="p">);</span>
<a name="c0-2623"></a><span class="lineno">2623</span>      <span class="n">pos</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2624"></a><span class="lineno">2624</span>      <span class="n">leading</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2625"></a><span class="lineno">2625</span>    <span class="p">}</span>
<a name="c0-2626"></a><span class="lineno">2626</span>    <span class="k">if</span> <span class="p">(</span><span class="n">trailing</span> <span class="o">&gt;</span> <span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2627"></a><span class="lineno">2627</span>      <span class="n">remove_last_line</span><span class="p">(</span><span class="o">&amp;</span><span class="n">preimage</span><span class="p">);</span>
<a name="c0-2628"></a><span class="lineno">2628</span>      <span class="n">remove_last_line</span><span class="p">(</span><span class="o">&amp;</span><span class="n">postimage</span><span class="p">);</span>
<a name="c0-2629"></a><span class="lineno">2629</span>      <span class="n">trailing</span><span class="o">--</span><span class="p">;</span>
<a name="c0-2630"></a><span class="lineno">2630</span>    <span class="p">}</span>
<a name="c0-2631"></a><span class="lineno">2631</span>  <span class="p">}</span>
<a name="c0-2632"></a><span class="lineno">2632</span> 
<a name="c0-2633"></a><span class="lineno">2633</span>  <span class="k">if</span> <span class="p">(</span><span class="n">applied_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2634"></a><span class="lineno">2634</span>    <span class="k">if</span> <span class="p">(</span><span class="n">new_blank_lines_at_end</span> <span class="o">&amp;&amp;</span>
<a name="c0-2635"></a><span class="lineno">2635</span>        <span class="n">preimage</span><span class="p">.</span><span class="n">nr</span> <span class="o">+</span> <span class="n">applied_pos</span> <span class="o">&gt;=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;&amp;</span>
<a name="c0-2636"></a><span class="lineno">2636</span>        <span class="p">(</span><span class="n">ws_rule</span> <span class="o">&amp;</span> <span class="n">WS_BLANK_AT_EOF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2637"></a><span class="lineno">2637</span>        <span class="n">ws_error_action</span> <span class="o">!=</span> <span class="n">nowarn_ws_error</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2638"></a><span class="lineno">2638</span>      <span class="n">record_ws_error</span><span class="p">(</span><span class="n">WS_BLANK_AT_EOF</span><span class="p">,</span> <span class="s">"+"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
<a name="c0-2639"></a><span class="lineno">2639</span>          <span class="n">found_new_blank_lines_at_end</span><span class="p">);</span>
<a name="c0-2640"></a><span class="lineno">2640</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ws_error_action</span> <span class="o">==</span> <span class="n">correct_ws_error</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2641"></a><span class="lineno">2641</span>        <span class="k">while</span> <span class="p">(</span><span class="n">new_blank_lines_at_end</span><span class="o">--</span><span class="p">)</span>
<a name="c0-2642"></a><span class="lineno">2642</span>          <span class="n">remove_last_line</span><span class="p">(</span><span class="o">&amp;</span><span class="n">postimage</span><span class="p">);</span>
<a name="c0-2643"></a><span class="lineno">2643</span>      <span class="p">}</span>
<a name="c0-2644"></a><span class="lineno">2644</span>      <span class="cm">/*</span>
<a name="c0-2645"></a><span class="lineno">2645</span> <span class="cm">       * We would want to prevent write_out_results()</span>
<a name="c0-2646"></a><span class="lineno">2646</span> <span class="cm">       * from taking place in apply_patch() that follows</span>
<a name="c0-2647"></a><span class="lineno">2647</span> <span class="cm">       * the callchain led us here, which is:</span>
<a name="c0-2648"></a><span class="lineno">2648</span> <span class="cm">       * apply_patch-&gt;check_patch_list-&gt;check_patch-&gt;</span>
<a name="c0-2649"></a><span class="lineno">2649</span> <span class="cm">       * apply_data-&gt;apply_fragments-&gt;apply_one_fragment</span>
<a name="c0-2650"></a><span class="lineno">2650</span> <span class="cm">       */</span>
<a name="c0-2651"></a><span class="lineno">2651</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ws_error_action</span> <span class="o">==</span> <span class="n">die_on_ws_error</span><span class="p">)</span>
<a name="c0-2652"></a><span class="lineno">2652</span>        <span class="n">apply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2653"></a><span class="lineno">2653</span>    <span class="p">}</span>
<a name="c0-2654"></a><span class="lineno">2654</span> 
<a name="c0-2655"></a><span class="lineno">2655</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_verbosely</span> <span class="o">&amp;&amp;</span> <span class="n">applied_pos</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2656"></a><span class="lineno">2656</span>      <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">applied_pos</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
<a name="c0-2657"></a><span class="lineno">2657</span>      <span class="k">if</span> <span class="p">(</span><span class="n">apply_in_reverse</span><span class="p">)</span>
<a name="c0-2658"></a><span class="lineno">2658</span>        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-2659"></a><span class="lineno">2659</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="c0-2660"></a><span class="lineno">2660</span>        <span class="s">"Hunk #%d succeeded at %d (offset %d lines).</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-2661"></a><span class="lineno">2661</span>        <span class="n">nth_fragment</span><span class="p">,</span> <span class="n">applied_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<a name="c0-2662"></a><span class="lineno">2662</span>    <span class="p">}</span>
<a name="c0-2663"></a><span class="lineno">2663</span> 
<a name="c0-2664"></a><span class="lineno">2664</span>    <span class="cm">/*</span>
<a name="c0-2665"></a><span class="lineno">2665</span> <span class="cm">     * Warn if it was necessary to reduce the number</span>
<a name="c0-2666"></a><span class="lineno">2666</span> <span class="cm">     * of context lines.</span>
<a name="c0-2667"></a><span class="lineno">2667</span> <span class="cm">     */</span>
<a name="c0-2668"></a><span class="lineno">2668</span>    <span class="k">if</span> <span class="p">((</span><span class="n">leading</span> <span class="o">!=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">leading</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-2669"></a><span class="lineno">2669</span>        <span class="p">(</span><span class="n">trailing</span> <span class="o">!=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">trailing</span><span class="p">))</span>
<a name="c0-2670"></a><span class="lineno">2670</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Context reduced to (%ld/%ld)"</span>
<a name="c0-2671"></a><span class="lineno">2671</span>        <span class="s">" to apply fragment at %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-2672"></a><span class="lineno">2672</span>        <span class="n">leading</span><span class="p">,</span> <span class="n">trailing</span><span class="p">,</span> <span class="n">applied_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-2673"></a><span class="lineno">2673</span>    <span class="n">update_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">applied_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">preimage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">postimage</span><span class="p">);</span>
<a name="c0-2674"></a><span class="lineno">2674</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2675"></a><span class="lineno">2675</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_verbosely</span><span class="p">)</span>
<a name="c0-2676"></a><span class="lineno">2676</span>      <span class="n">error</span><span class="p">(</span><span class="s">"while searching for:</span><span class="se">\n</span><span class="s">%.*s"</span><span class="p">,</span>
<a name="c0-2677"></a><span class="lineno">2677</span>            <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">old</span> <span class="o">-</span> <span class="n">oldlines</span><span class="p">),</span> <span class="n">oldlines</span><span class="p">);</span>
<a name="c0-2678"></a><span class="lineno">2678</span>  <span class="p">}</span>
<a name="c0-2679"></a><span class="lineno">2679</span> 
<a name="c0-2680"></a><span class="lineno">2680</span>  <span class="n">free</span><span class="p">(</span><span class="n">oldlines</span><span class="p">);</span>
<a name="c0-2681"></a><span class="lineno">2681</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlines</span><span class="p">);</span>
<a name="c0-2682"></a><span class="lineno">2682</span>  <span class="n">free</span><span class="p">(</span><span class="n">preimage</span><span class="p">.</span><span class="n">line_allocated</span><span class="p">);</span>
<a name="c0-2683"></a><span class="lineno">2683</span>  <span class="n">free</span><span class="p">(</span><span class="n">postimage</span><span class="p">.</span><span class="n">line_allocated</span><span class="p">);</span>
<a name="c0-2684"></a><span class="lineno">2684</span> 
<a name="c0-2685"></a><span class="lineno">2685</span>  <span class="k">return</span> <span class="p">(</span><span class="n">applied_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-2686"></a><span class="lineno">2686</span> <span class="p">}</span>
<a name="c0-2687"></a><span class="lineno">2687</span> 
<a name="c0-2688"></a><span class="lineno">2688</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_binary_fragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2689"></a><span class="lineno">2689</span> <span class="p">{</span>
<a name="c0-2690"></a><span class="lineno">2690</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">fragment</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">;</span>
<a name="c0-2691"></a><span class="lineno">2691</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2692"></a><span class="lineno">2692</span>  <span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
<a name="c0-2693"></a><span class="lineno">2693</span> 
<a name="c0-2694"></a><span class="lineno">2694</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fragment</span><span class="p">)</span>
<a name="c0-2695"></a><span class="lineno">2695</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"missing binary patch data for '%s'"</span><span class="p">,</span>
<a name="c0-2696"></a><span class="lineno">2696</span>           <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">?</span>
<a name="c0-2697"></a><span class="lineno">2697</span>           <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">:</span>
<a name="c0-2698"></a><span class="lineno">2698</span>           <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2699"></a><span class="lineno">2699</span> 
<a name="c0-2700"></a><span class="lineno">2700</span>  <span class="cm">/* Binary patch is irreversible without the optional second hunk */</span>
<a name="c0-2701"></a><span class="lineno">2701</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply_in_reverse</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2702"></a><span class="lineno">2702</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<a name="c0-2703"></a><span class="lineno">2703</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"cannot reverse-apply a binary patch "</span>
<a name="c0-2704"></a><span class="lineno">2704</span>             <span class="s">"without the reverse hunk to '%s'"</span><span class="p">,</span>
<a name="c0-2705"></a><span class="lineno">2705</span>             <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span>
<a name="c0-2706"></a><span class="lineno">2706</span>             <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2707"></a><span class="lineno">2707</span>    <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-2708"></a><span class="lineno">2708</span>  <span class="p">}</span>
<a name="c0-2709"></a><span class="lineno">2709</span>  <span class="k">switch</span> <span class="p">(</span><span class="n">fragment</span><span class="o">-&gt;</span><span class="n">binary_patch_method</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2710"></a><span class="lineno">2710</span>  <span class="k">case</span> <span class="n">BINARY_DELTA_DEFLATED</span>:
<a name="c0-2711"></a><span class="lineno">2711</span>    <span class="n">dst</span> <span class="o">=</span> <span class="n">patch_delta</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">,</span>
<a name="c0-2712"></a><span class="lineno">2712</span>          <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<a name="c0-2713"></a><span class="lineno">2713</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst</span><span class="p">)</span>
<a name="c0-2714"></a><span class="lineno">2714</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2715"></a><span class="lineno">2715</span>    <span class="n">clear_image</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
<a name="c0-2716"></a><span class="lineno">2716</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
<a name="c0-2717"></a><span class="lineno">2717</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2718"></a><span class="lineno">2718</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2719"></a><span class="lineno">2719</span>  <span class="k">case</span> <span class="n">BINARY_LITERAL_DEFLATED</span>:
<a name="c0-2720"></a><span class="lineno">2720</span>    <span class="n">clear_image</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
<a name="c0-2721"></a><span class="lineno">2721</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<a name="c0-2722"></a><span class="lineno">2722</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-2723"></a><span class="lineno">2723</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">fragment</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<a name="c0-2724"></a><span class="lineno">2724</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<a name="c0-2725"></a><span class="lineno">2725</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2726"></a><span class="lineno">2726</span>  <span class="p">}</span>
<a name="c0-2727"></a><span class="lineno">2727</span>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2728"></a><span class="lineno">2728</span> <span class="p">}</span>
<a name="c0-2729"></a><span class="lineno">2729</span> 
<a name="c0-2730"></a><span class="lineno">2730</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2731"></a><span class="lineno">2731</span> <span class="p">{</span>
<a name="c0-2732"></a><span class="lineno">2732</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-2733"></a><span class="lineno">2733</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-2734"></a><span class="lineno">2734</span> 
<a name="c0-2735"></a><span class="lineno">2735</span>  <span class="cm">/*</span>
<a name="c0-2736"></a><span class="lineno">2736</span> <span class="cm">   * For safety, we require patch index line to contain</span>
<a name="c0-2737"></a><span class="lineno">2737</span> <span class="cm">   * full 40-byte textual SHA1 for old and new, at least for now.</span>
<a name="c0-2738"></a><span class="lineno">2738</span> <span class="cm">   */</span>
<a name="c0-2739"></a><span class="lineno">2739</span>  <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">40</span> <span class="o">||</span>
<a name="c0-2740"></a><span class="lineno">2740</span>      <span class="n">strlen</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">40</span> <span class="o">||</span>
<a name="c0-2741"></a><span class="lineno">2741</span>      <span class="n">get_sha1_hex</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">,</span> <span class="n">sha1</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-2742"></a><span class="lineno">2742</span>      <span class="n">get_sha1_hex</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span>
<a name="c0-2743"></a><span class="lineno">2743</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"cannot apply binary patch to '%s' "</span>
<a name="c0-2744"></a><span class="lineno">2744</span>           <span class="s">"without full index line"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-2745"></a><span class="lineno">2745</span> 
<a name="c0-2746"></a><span class="lineno">2746</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2747"></a><span class="lineno">2747</span>    <span class="cm">/*</span>
<a name="c0-2748"></a><span class="lineno">2748</span> <span class="cm">     * See if the old one matches what the patch</span>
<a name="c0-2749"></a><span class="lineno">2749</span> <span class="cm">     * applies to.</span>
<a name="c0-2750"></a><span class="lineno">2750</span> <span class="cm">     */</span>
<a name="c0-2751"></a><span class="lineno">2751</span>    <span class="n">hash_sha1_file</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">blob_type</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c0-2752"></a><span class="lineno">2752</span>    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">),</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">))</span>
<a name="c0-2753"></a><span class="lineno">2753</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"the patch applies to '%s' (%s), "</span>
<a name="c0-2754"></a><span class="lineno">2754</span>             <span class="s">"which does not match the "</span>
<a name="c0-2755"></a><span class="lineno">2755</span>             <span class="s">"current contents."</span><span class="p">,</span>
<a name="c0-2756"></a><span class="lineno">2756</span>             <span class="n">name</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-2757"></a><span class="lineno">2757</span>  <span class="p">}</span>
<a name="c0-2758"></a><span class="lineno">2758</span>  <span class="k">else</span> <span class="p">{</span>
<a name="c0-2759"></a><span class="lineno">2759</span>    <span class="cm">/* Otherwise, the old one must be empty. */</span>
<a name="c0-2760"></a><span class="lineno">2760</span>    <span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
<a name="c0-2761"></a><span class="lineno">2761</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"the patch applies to an empty "</span>
<a name="c0-2762"></a><span class="lineno">2762</span>             <span class="s">"'%s' but it is not empty"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-2763"></a><span class="lineno">2763</span>  <span class="p">}</span>
<a name="c0-2764"></a><span class="lineno">2764</span> 
<a name="c0-2765"></a><span class="lineno">2765</span>  <span class="n">get_sha1_hex</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c0-2766"></a><span class="lineno">2766</span>  <span class="k">if</span> <span class="p">(</span><span class="n">is_null_sha1</span><span class="p">(</span><span class="n">sha1</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2767"></a><span class="lineno">2767</span>    <span class="n">clear_image</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
<a name="c0-2768"></a><span class="lineno">2768</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* deletion patch */</span>
<a name="c0-2769"></a><span class="lineno">2769</span>  <span class="p">}</span>
<a name="c0-2770"></a><span class="lineno">2770</span> 
<a name="c0-2771"></a><span class="lineno">2771</span>  <span class="k">if</span> <span class="p">(</span><span class="n">has_sha1_file</span><span class="p">(</span><span class="n">sha1</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2772"></a><span class="lineno">2772</span>    <span class="cm">/* We already have the postimage */</span>
<a name="c0-2773"></a><span class="lineno">2773</span>    <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-2774"></a><span class="lineno">2774</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-2775"></a><span class="lineno">2775</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="c0-2776"></a><span class="lineno">2776</span> 
<a name="c0-2777"></a><span class="lineno">2777</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<a name="c0-2778"></a><span class="lineno">2778</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
<a name="c0-2779"></a><span class="lineno">2779</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"the necessary postimage %s for "</span>
<a name="c0-2780"></a><span class="lineno">2780</span>             <span class="s">"'%s' cannot be read"</span><span class="p">,</span>
<a name="c0-2781"></a><span class="lineno">2781</span>             <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-2782"></a><span class="lineno">2782</span>    <span class="n">clear_image</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
<a name="c0-2783"></a><span class="lineno">2783</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-2784"></a><span class="lineno">2784</span>    <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<a name="c0-2785"></a><span class="lineno">2785</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2786"></a><span class="lineno">2786</span>    <span class="cm">/*</span>
<a name="c0-2787"></a><span class="lineno">2787</span> <span class="cm">     * We have verified buf matches the preimage;</span>
<a name="c0-2788"></a><span class="lineno">2788</span> <span class="cm">     * apply the patch data to it, which is stored</span>
<a name="c0-2789"></a><span class="lineno">2789</span> <span class="cm">     * in the patch-&gt;fragments-&gt;{patch,size}.</span>
<a name="c0-2790"></a><span class="lineno">2790</span> <span class="cm">     */</span>
<a name="c0-2791"></a><span class="lineno">2791</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_binary_fragment</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">patch</span><span class="p">))</span>
<a name="c0-2792"></a><span class="lineno">2792</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"binary patch does not apply to '%s'"</span><span class="p">,</span>
<a name="c0-2793"></a><span class="lineno">2793</span>             <span class="n">name</span><span class="p">);</span>
<a name="c0-2794"></a><span class="lineno">2794</span> 
<a name="c0-2795"></a><span class="lineno">2795</span>    <span class="cm">/* verify that the result matches */</span>
<a name="c0-2796"></a><span class="lineno">2796</span>    <span class="n">hash_sha1_file</span><span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">blob_type</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c0-2797"></a><span class="lineno">2797</span>    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">),</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">))</span>
<a name="c0-2798"></a><span class="lineno">2798</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"binary patch to '%s' creates incorrect result (expecting %s, got %s)"</span><span class="p">,</span>
<a name="c0-2799"></a><span class="lineno">2799</span>        <span class="n">name</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_sha1_prefix</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-2800"></a><span class="lineno">2800</span>  <span class="p">}</span>
<a name="c0-2801"></a><span class="lineno">2801</span> 
<a name="c0-2802"></a><span class="lineno">2802</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2803"></a><span class="lineno">2803</span> <span class="p">}</span>
<a name="c0-2804"></a><span class="lineno">2804</span> 
<a name="c0-2805"></a><span class="lineno">2805</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_fragments</span><span class="p">(</span><span class="k">struct</span> <span class="n">image</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2806"></a><span class="lineno">2806</span> <span class="p">{</span>
<a name="c0-2807"></a><span class="lineno">2807</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">;</span>
<a name="c0-2808"></a><span class="lineno">2808</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-2809"></a><span class="lineno">2809</span>  <span class="kt">unsigned</span> <span class="n">ws_rule</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">ws_rule</span><span class="p">;</span>
<a name="c0-2810"></a><span class="lineno">2810</span>  <span class="kt">unsigned</span> <span class="n">inaccurate_eof</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">inaccurate_eof</span><span class="p">;</span>
<a name="c0-2811"></a><span class="lineno">2811</span>  <span class="kt">int</span> <span class="n">nth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2812"></a><span class="lineno">2812</span> 
<a name="c0-2813"></a><span class="lineno">2813</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span><span class="p">)</span>
<a name="c0-2814"></a><span class="lineno">2814</span>    <span class="k">return</span> <span class="n">apply_binary</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-2815"></a><span class="lineno">2815</span> 
<a name="c0-2816"></a><span class="lineno">2816</span>  <span class="k">while</span> <span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2817"></a><span class="lineno">2817</span>    <span class="n">nth</span><span class="o">++</span><span class="p">;</span>
<a name="c0-2818"></a><span class="lineno">2818</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_one_fragment</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">inaccurate_eof</span><span class="p">,</span> <span class="n">ws_rule</span><span class="p">,</span> <span class="n">nth</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2819"></a><span class="lineno">2819</span>      <span class="n">error</span><span class="p">(</span><span class="s">"patch failed: %s:%ld"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">oldpos</span><span class="p">);</span>
<a name="c0-2820"></a><span class="lineno">2820</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apply_with_reject</span><span class="p">)</span>
<a name="c0-2821"></a><span class="lineno">2821</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2822"></a><span class="lineno">2822</span>      <span class="n">frag</span><span class="o">-&gt;</span><span class="n">rejected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-2823"></a><span class="lineno">2823</span>    <span class="p">}</span>
<a name="c0-2824"></a><span class="lineno">2824</span>    <span class="n">frag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-2825"></a><span class="lineno">2825</span>  <span class="p">}</span>
<a name="c0-2826"></a><span class="lineno">2826</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2827"></a><span class="lineno">2827</span> <span class="p">}</span>
<a name="c0-2828"></a><span class="lineno">2828</span> 
<a name="c0-2829"></a><span class="lineno">2829</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">read_file_or_gitlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">ce</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<a name="c0-2830"></a><span class="lineno">2830</span> <span class="p">{</span>
<a name="c0-2831"></a><span class="lineno">2831</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ce</span><span class="p">)</span>
<a name="c0-2832"></a><span class="lineno">2832</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2833"></a><span class="lineno">2833</span> 
<a name="c0-2834"></a><span class="lineno">2834</span>  <span class="k">if</span> <span class="p">(</span><span class="n">S_ISGITLINK</span><span class="p">(</span><span class="n">ce</span><span class="o">-&gt;</span><span class="n">ce_mode</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2835"></a><span class="lineno">2835</span>    <span class="n">strbuf_grow</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<a name="c0-2836"></a><span class="lineno">2836</span>    <span class="n">strbuf_addf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"Subproject commit %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">ce</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">));</span>
<a name="c0-2837"></a><span class="lineno">2837</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2838"></a><span class="lineno">2838</span>    <span class="k">enum</span> <span class="n">object_type</span> <span class="n">type</span><span class="p">;</span>
<a name="c0-2839"></a><span class="lineno">2839</span>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-2840"></a><span class="lineno">2840</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="c0-2841"></a><span class="lineno">2841</span> 
<a name="c0-2842"></a><span class="lineno">2842</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">read_sha1_file</span><span class="p">(</span><span class="n">ce</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<a name="c0-2843"></a><span class="lineno">2843</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
<a name="c0-2844"></a><span class="lineno">2844</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-2845"></a><span class="lineno">2845</span>    <span class="cm">/* XXX read_sha1_file NUL-terminates */</span>
<a name="c0-2846"></a><span class="lineno">2846</span>    <span class="n">strbuf_attach</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-2847"></a><span class="lineno">2847</span>  <span class="p">}</span>
<a name="c0-2848"></a><span class="lineno">2848</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2849"></a><span class="lineno">2849</span> <span class="p">}</span>
<a name="c0-2850"></a><span class="lineno">2850</span> 
<a name="c0-2851"></a><span class="lineno">2851</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="nf">in_fn_table</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-2852"></a><span class="lineno">2852</span> <span class="p">{</span>
<a name="c0-2853"></a><span class="lineno">2853</span>  <span class="k">struct</span> <span class="n">string_list_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
<a name="c0-2854"></a><span class="lineno">2854</span> 
<a name="c0-2855"></a><span class="lineno">2855</span>  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="c0-2856"></a><span class="lineno">2856</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-2857"></a><span class="lineno">2857</span> 
<a name="c0-2858"></a><span class="lineno">2858</span>  <span class="n">item</span> <span class="o">=</span> <span class="n">string_list_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_table</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-2859"></a><span class="lineno">2859</span>  <span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<a name="c0-2860"></a><span class="lineno">2860</span>    <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="p">)</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span><span class="p">;</span>
<a name="c0-2861"></a><span class="lineno">2861</span> 
<a name="c0-2862"></a><span class="lineno">2862</span>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-2863"></a><span class="lineno">2863</span> <span class="p">}</span>
<a name="c0-2864"></a><span class="lineno">2864</span> 
<a name="c0-2865"></a><span class="lineno">2865</span> <span class="cm">/*</span>
<a name="c0-2866"></a><span class="lineno">2866</span> <span class="cm"> * item-&gt;util in the filename table records the status of the path.</span>
<a name="c0-2867"></a><span class="lineno">2867</span> <span class="cm"> * Usually it points at a patch (whose result records the contents</span>
<a name="c0-2868"></a><span class="lineno">2868</span> <span class="cm"> * of it after applying it), but it could be PATH_WAS_DELETED for a</span>
<a name="c0-2869"></a><span class="lineno">2869</span> <span class="cm"> * path that a previously applied patch has already removed.</span>
<a name="c0-2870"></a><span class="lineno">2870</span> <span class="cm"> */</span>
<a name="c0-2871"></a><span class="lineno">2871</span>  <span class="cp">#define PATH_TO_BE_DELETED ((struct patch *) -2)</span>
<a name="c0-2872"></a><span class="lineno">2872</span> <span class="cp">#define PATH_WAS_DELETED ((struct patch *) -1)</span>
<a name="c0-2873"></a><span class="lineno">2873</span> 
<a name="c0-2874"></a><span class="lineno">2874</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">to_be_deleted</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2875"></a><span class="lineno">2875</span> <span class="p">{</span>
<a name="c0-2876"></a><span class="lineno">2876</span>  <span class="k">return</span> <span class="n">patch</span> <span class="o">==</span> <span class="n">PATH_TO_BE_DELETED</span><span class="p">;</span>
<a name="c0-2877"></a><span class="lineno">2877</span> <span class="p">}</span>
<a name="c0-2878"></a><span class="lineno">2878</span> 
<a name="c0-2879"></a><span class="lineno">2879</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">was_deleted</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2880"></a><span class="lineno">2880</span> <span class="p">{</span>
<a name="c0-2881"></a><span class="lineno">2881</span>  <span class="k">return</span> <span class="n">patch</span> <span class="o">==</span> <span class="n">PATH_WAS_DELETED</span><span class="p">;</span>
<a name="c0-2882"></a><span class="lineno">2882</span> <span class="p">}</span>
<a name="c0-2883"></a><span class="lineno">2883</span> 
<a name="c0-2884"></a><span class="lineno">2884</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_to_fn_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2885"></a><span class="lineno">2885</span> <span class="p">{</span>
<a name="c0-2886"></a><span class="lineno">2886</span>  <span class="k">struct</span> <span class="n">string_list_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
<a name="c0-2887"></a><span class="lineno">2887</span> 
<a name="c0-2888"></a><span class="lineno">2888</span>  <span class="cm">/*</span>
<a name="c0-2889"></a><span class="lineno">2889</span> <span class="cm">   * Always add new_name unless patch is a deletion</span>
<a name="c0-2890"></a><span class="lineno">2890</span> <span class="cm">   * This should cover the cases for normal diffs,</span>
<a name="c0-2891"></a><span class="lineno">2891</span> <span class="cm">   * file creations and copies</span>
<a name="c0-2892"></a><span class="lineno">2892</span> <span class="cm">   */</span>
<a name="c0-2893"></a><span class="lineno">2893</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2894"></a><span class="lineno">2894</span>    <span class="n">item</span> <span class="o">=</span> <span class="n">string_list_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_table</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-2895"></a><span class="lineno">2895</span>    <span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">=</span> <span class="n">patch</span><span class="p">;</span>
<a name="c0-2896"></a><span class="lineno">2896</span>  <span class="p">}</span>
<a name="c0-2897"></a><span class="lineno">2897</span> 
<a name="c0-2898"></a><span class="lineno">2898</span>  <span class="cm">/*</span>
<a name="c0-2899"></a><span class="lineno">2899</span> <span class="cm">   * store a failure on rename/deletion cases because</span>
<a name="c0-2900"></a><span class="lineno">2900</span> <span class="cm">   * later chunks shouldn't patch old names</span>
<a name="c0-2901"></a><span class="lineno">2901</span> <span class="cm">   */</span>
<a name="c0-2902"></a><span class="lineno">2902</span>  <span class="k">if</span> <span class="p">((</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2903"></a><span class="lineno">2903</span>    <span class="n">item</span> <span class="o">=</span> <span class="n">string_list_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_table</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2904"></a><span class="lineno">2904</span>    <span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">=</span> <span class="n">PATH_WAS_DELETED</span><span class="p">;</span>
<a name="c0-2905"></a><span class="lineno">2905</span>  <span class="p">}</span>
<a name="c0-2906"></a><span class="lineno">2906</span> <span class="p">}</span>
<a name="c0-2907"></a><span class="lineno">2907</span> 
<a name="c0-2908"></a><span class="lineno">2908</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_fn_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-2909"></a><span class="lineno">2909</span> <span class="p">{</span>
<a name="c0-2910"></a><span class="lineno">2910</span>  <span class="cm">/*</span>
<a name="c0-2911"></a><span class="lineno">2911</span> <span class="cm">   * store information about incoming file deletion</span>
<a name="c0-2912"></a><span class="lineno">2912</span> <span class="cm">   */</span>
<a name="c0-2913"></a><span class="lineno">2913</span>  <span class="k">while</span> <span class="p">(</span><span class="n">patch</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2914"></a><span class="lineno">2914</span>    <span class="k">if</span> <span class="p">((</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2915"></a><span class="lineno">2915</span>      <span class="k">struct</span> <span class="n">string_list_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
<a name="c0-2916"></a><span class="lineno">2916</span>      <span class="n">item</span> <span class="o">=</span> <span class="n">string_list_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_table</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2917"></a><span class="lineno">2917</span>      <span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">=</span> <span class="n">PATH_TO_BE_DELETED</span><span class="p">;</span>
<a name="c0-2918"></a><span class="lineno">2918</span>    <span class="p">}</span>
<a name="c0-2919"></a><span class="lineno">2919</span>    <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-2920"></a><span class="lineno">2920</span>  <span class="p">}</span>
<a name="c0-2921"></a><span class="lineno">2921</span> <span class="p">}</span>
<a name="c0-2922"></a><span class="lineno">2922</span> 
<a name="c0-2923"></a><span class="lineno">2923</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">ce</span><span class="p">)</span>
<a name="c0-2924"></a><span class="lineno">2924</span> <span class="p">{</span>
<a name="c0-2925"></a><span class="lineno">2925</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-2926"></a><span class="lineno">2926</span>  <span class="k">struct</span> <span class="n">image</span> <span class="n">image</span><span class="p">;</span>
<a name="c0-2927"></a><span class="lineno">2927</span>  <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-2928"></a><span class="lineno">2928</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">img</span><span class="p">;</span>
<a name="c0-2929"></a><span class="lineno">2929</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">tpatch</span><span class="p">;</span>
<a name="c0-2930"></a><span class="lineno">2930</span> 
<a name="c0-2931"></a><span class="lineno">2931</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span> <span class="o">||</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-2932"></a><span class="lineno">2932</span>      <span class="p">(</span><span class="n">tpatch</span> <span class="o">=</span> <span class="n">in_fn_table</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">to_be_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2933"></a><span class="lineno">2933</span>    <span class="k">if</span> <span class="p">(</span><span class="n">was_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2934"></a><span class="lineno">2934</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"patch %s has been renamed/deleted"</span><span class="p">,</span>
<a name="c0-2935"></a><span class="lineno">2935</span>        <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2936"></a><span class="lineno">2936</span>    <span class="p">}</span>
<a name="c0-2937"></a><span class="lineno">2937</span>    <span class="cm">/* We have a patched copy in memory use that */</span>
<a name="c0-2938"></a><span class="lineno">2938</span>    <span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">tpatch</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">tpatch</span><span class="o">-&gt;</span><span class="n">resultsize</span><span class="p">);</span>
<a name="c0-2939"></a><span class="lineno">2939</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2940"></a><span class="lineno">2940</span>    <span class="k">if</span> <span class="p">(</span><span class="n">read_file_or_gitlink</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span>
<a name="c0-2941"></a><span class="lineno">2941</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"read of %s failed"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2942"></a><span class="lineno">2942</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2943"></a><span class="lineno">2943</span>    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISGITLINK</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2944"></a><span class="lineno">2944</span>      <span class="k">if</span> <span class="p">(</span><span class="n">ce</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-2945"></a><span class="lineno">2945</span>        <span class="n">read_file_or_gitlink</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-2946"></a><span class="lineno">2946</span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2947"></a><span class="lineno">2947</span>        <span class="cm">/*</span>
<a name="c0-2948"></a><span class="lineno">2948</span> <span class="cm">         * There is no way to apply subproject</span>
<a name="c0-2949"></a><span class="lineno">2949</span> <span class="cm">         * patch without looking at the index.</span>
<a name="c0-2950"></a><span class="lineno">2950</span> <span class="cm">         */</span>
<a name="c0-2951"></a><span class="lineno">2951</span>        <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-2952"></a><span class="lineno">2952</span>      <span class="p">}</span>
<a name="c0-2953"></a><span class="lineno">2953</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-2954"></a><span class="lineno">2954</span>      <span class="k">if</span> <span class="p">(</span><span class="n">read_old_data</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span>
<a name="c0-2955"></a><span class="lineno">2955</span>        <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"read of %s failed"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-2956"></a><span class="lineno">2956</span>    <span class="p">}</span>
<a name="c0-2957"></a><span class="lineno">2957</span>  <span class="p">}</span>
<a name="c0-2958"></a><span class="lineno">2958</span> 
<a name="c0-2959"></a><span class="lineno">2959</span>  <span class="n">img</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<a name="c0-2960"></a><span class="lineno">2960</span>  <span class="n">prepare_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span><span class="p">);</span>
<a name="c0-2961"></a><span class="lineno">2961</span> 
<a name="c0-2962"></a><span class="lineno">2962</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply_fragments</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-2963"></a><span class="lineno">2963</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* note with --reject this succeeds. */</span>
<a name="c0-2964"></a><span class="lineno">2964</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-2965"></a><span class="lineno">2965</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">resultsize</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c0-2966"></a><span class="lineno">2966</span>  <span class="n">add_to_fn_table</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-2967"></a><span class="lineno">2967</span>  <span class="n">free</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">line_allocated</span><span class="p">);</span>
<a name="c0-2968"></a><span class="lineno">2968</span> 
<a name="c0-2969"></a><span class="lineno">2969</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&amp;&amp;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">resultsize</span><span class="p">)</span>
<a name="c0-2970"></a><span class="lineno">2970</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"removal patch leaves file contents"</span><span class="p">);</span>
<a name="c0-2971"></a><span class="lineno">2971</span> 
<a name="c0-2972"></a><span class="lineno">2972</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2973"></a><span class="lineno">2973</span> <span class="p">}</span>
<a name="c0-2974"></a><span class="lineno">2974</span> 
<a name="c0-2975"></a><span class="lineno">2975</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">check_to_create_blob</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok_if_exists</span><span class="p">)</span>
<a name="c0-2976"></a><span class="lineno">2976</span> <span class="p">{</span>
<a name="c0-2977"></a><span class="lineno">2977</span>  <span class="k">struct</span> <span class="n">stat</span> <span class="n">nst</span><span class="p">;</span>
<a name="c0-2978"></a><span class="lineno">2978</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lstat</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nst</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-2979"></a><span class="lineno">2979</span>    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">nst</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">||</span> <span class="n">ok_if_exists</span><span class="p">)</span>
<a name="c0-2980"></a><span class="lineno">2980</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2981"></a><span class="lineno">2981</span>    <span class="cm">/*</span>
<a name="c0-2982"></a><span class="lineno">2982</span> <span class="cm">     * A leading component of new_name might be a symlink</span>
<a name="c0-2983"></a><span class="lineno">2983</span> <span class="cm">     * that is going to be removed with this patch, but</span>
<a name="c0-2984"></a><span class="lineno">2984</span> <span class="cm">     * still pointing at somewhere that has the path.</span>
<a name="c0-2985"></a><span class="lineno">2985</span> <span class="cm">     * In such a case, path "new_name" does not exist as</span>
<a name="c0-2986"></a><span class="lineno">2986</span> <span class="cm">     * far as git is concerned.</span>
<a name="c0-2987"></a><span class="lineno">2987</span> <span class="cm">     */</span>
<a name="c0-2988"></a><span class="lineno">2988</span>    <span class="k">if</span> <span class="p">(</span><span class="n">has_symlink_leading_path</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">new_name</span><span class="p">)))</span>
<a name="c0-2989"></a><span class="lineno">2989</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2990"></a><span class="lineno">2990</span> 
<a name="c0-2991"></a><span class="lineno">2991</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: already exists in working directory"</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>
<a name="c0-2992"></a><span class="lineno">2992</span>  <span class="p">}</span>
<a name="c0-2993"></a><span class="lineno">2993</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOTDIR</span><span class="p">))</span>
<a name="c0-2994"></a><span class="lineno">2994</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-2995"></a><span class="lineno">2995</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-2996"></a><span class="lineno">2996</span> <span class="p">}</span>
<a name="c0-2997"></a><span class="lineno">2997</span> 
<a name="c0-2998"></a><span class="lineno">2998</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_index_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">ce</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<a name="c0-2999"></a><span class="lineno">2999</span> <span class="p">{</span>
<a name="c0-3000"></a><span class="lineno">3000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">S_ISGITLINK</span><span class="p">(</span><span class="n">ce</span><span class="o">-&gt;</span><span class="n">ce_mode</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3001"></a><span class="lineno">3001</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">st_mode</span><span class="p">))</span>
<a name="c0-3002"></a><span class="lineno">3002</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-3003"></a><span class="lineno">3003</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3004"></a><span class="lineno">3004</span>  <span class="p">}</span>
<a name="c0-3005"></a><span class="lineno">3005</span>  <span class="k">return</span> <span class="n">ce_match_stat</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">CE_MATCH_IGNORE_VALID</span><span class="o">|</span><span class="n">CE_MATCH_IGNORE_SKIP_WORKTREE</span><span class="p">);</span>
<a name="c0-3006"></a><span class="lineno">3006</span> <span class="p">}</span>
<a name="c0-3007"></a><span class="lineno">3007</span> 
<a name="c0-3008"></a><span class="lineno">3008</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">check_preimage</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">**</span><span class="n">ce</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<a name="c0-3009"></a><span class="lineno">3009</span> <span class="p">{</span>
<a name="c0-3010"></a><span class="lineno">3010</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-3011"></a><span class="lineno">3011</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">tpatch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3012"></a><span class="lineno">3012</span>  <span class="kt">int</span> <span class="n">stat_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3013"></a><span class="lineno">3013</span>  <span class="kt">unsigned</span> <span class="n">st_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3014"></a><span class="lineno">3014</span> 
<a name="c0-3015"></a><span class="lineno">3015</span>  <span class="cm">/*</span>
<a name="c0-3016"></a><span class="lineno">3016</span> <span class="cm">   * Make sure that we do not have local modifications from the</span>
<a name="c0-3017"></a><span class="lineno">3017</span> <span class="cm">   * index when we are looking at the index.  Also make sure</span>
<a name="c0-3018"></a><span class="lineno">3018</span> <span class="cm">   * we have the preimage file to be patched in the work tree,</span>
<a name="c0-3019"></a><span class="lineno">3019</span> <span class="cm">   * unless --cached, which tells git to apply only in the index.</span>
<a name="c0-3020"></a><span class="lineno">3020</span> <span class="cm">   */</span>
<a name="c0-3021"></a><span class="lineno">3021</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_name</span><span class="p">)</span>
<a name="c0-3022"></a><span class="lineno">3022</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3023"></a><span class="lineno">3023</span> 
<a name="c0-3024"></a><span class="lineno">3024</span>  <span class="n">assert</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3025"></a><span class="lineno">3025</span> 
<a name="c0-3026"></a><span class="lineno">3026</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span> <span class="o">||</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-3027"></a><span class="lineno">3027</span>      <span class="p">(</span><span class="n">tpatch</span> <span class="o">=</span> <span class="n">in_fn_table</span><span class="p">(</span><span class="n">old_name</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">to_be_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3028"></a><span class="lineno">3028</span>    <span class="k">if</span> <span class="p">(</span><span class="n">was_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">))</span>
<a name="c0-3029"></a><span class="lineno">3029</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: has been deleted/renamed"</span><span class="p">,</span> <span class="n">old_name</span><span class="p">);</span>
<a name="c0-3030"></a><span class="lineno">3030</span>    <span class="n">st_mode</span> <span class="o">=</span> <span class="n">tpatch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">;</span>
<a name="c0-3031"></a><span class="lineno">3031</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3032"></a><span class="lineno">3032</span>    <span class="n">stat_ret</span> <span class="o">=</span> <span class="n">lstat</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
<a name="c0-3033"></a><span class="lineno">3033</span>    <span class="k">if</span> <span class="p">(</span><span class="n">stat_ret</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">)</span>
<a name="c0-3034"></a><span class="lineno">3034</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-3035"></a><span class="lineno">3035</span>  <span class="p">}</span>
<a name="c0-3036"></a><span class="lineno">3036</span> 
<a name="c0-3037"></a><span class="lineno">3037</span>  <span class="k">if</span> <span class="p">(</span><span class="n">to_be_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">))</span>
<a name="c0-3038"></a><span class="lineno">3038</span>    <span class="n">tpatch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3039"></a><span class="lineno">3039</span> 
<a name="c0-3040"></a><span class="lineno">3040</span>  <span class="k">if</span> <span class="p">(</span><span class="n">check_index</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tpatch</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3041"></a><span class="lineno">3041</span>    <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">cache_name_pos</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">old_name</span><span class="p">));</span>
<a name="c0-3042"></a><span class="lineno">3042</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3043"></a><span class="lineno">3043</span>      <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3044"></a><span class="lineno">3044</span>        <span class="k">goto</span> <span class="n">is_new</span><span class="p">;</span>
<a name="c0-3045"></a><span class="lineno">3045</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: does not exist in index"</span><span class="p">,</span> <span class="n">old_name</span><span class="p">);</span>
<a name="c0-3046"></a><span class="lineno">3046</span>    <span class="p">}</span>
<a name="c0-3047"></a><span class="lineno">3047</span>    <span class="o">*</span><span class="n">ce</span> <span class="o">=</span> <span class="n">active_cache</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
<a name="c0-3048"></a><span class="lineno">3048</span>    <span class="k">if</span> <span class="p">(</span><span class="n">stat_ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3049"></a><span class="lineno">3049</span>      <span class="k">struct</span> <span class="n">checkout</span> <span class="n">costate</span><span class="p">;</span>
<a name="c0-3050"></a><span class="lineno">3050</span>      <span class="cm">/* checkout */</span>
<a name="c0-3051"></a><span class="lineno">3051</span>      <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">costate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">costate</span><span class="p">));</span>
<a name="c0-3052"></a><span class="lineno">3052</span>      <span class="n">costate</span><span class="p">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<a name="c0-3053"></a><span class="lineno">3053</span>      <span class="n">costate</span><span class="p">.</span><span class="n">refresh_cache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3054"></a><span class="lineno">3054</span>      <span class="k">if</span> <span class="p">(</span><span class="n">checkout_entry</span><span class="p">(</span><span class="o">*</span><span class="n">ce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">costate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-3055"></a><span class="lineno">3055</span>          <span class="n">lstat</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>
<a name="c0-3056"></a><span class="lineno">3056</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-3057"></a><span class="lineno">3057</span>    <span class="p">}</span>
<a name="c0-3058"></a><span class="lineno">3058</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span> <span class="o">&amp;&amp;</span> <span class="n">verify_index_match</span><span class="p">(</span><span class="o">*</span><span class="n">ce</span><span class="p">,</span> <span class="n">st</span><span class="p">))</span>
<a name="c0-3059"></a><span class="lineno">3059</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: does not match index"</span><span class="p">,</span> <span class="n">old_name</span><span class="p">);</span>
<a name="c0-3060"></a><span class="lineno">3060</span>    <span class="k">if</span> <span class="p">(</span><span class="n">cached</span><span class="p">)</span>
<a name="c0-3061"></a><span class="lineno">3061</span>      <span class="n">st_mode</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ce</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ce_mode</span><span class="p">;</span>
<a name="c0-3062"></a><span class="lineno">3062</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat_ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3063"></a><span class="lineno">3063</span>    <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3064"></a><span class="lineno">3064</span>      <span class="k">goto</span> <span class="n">is_new</span><span class="p">;</span>
<a name="c0-3065"></a><span class="lineno">3065</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-3066"></a><span class="lineno">3066</span>  <span class="p">}</span>
<a name="c0-3067"></a><span class="lineno">3067</span> 
<a name="c0-3068"></a><span class="lineno">3068</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tpatch</span><span class="p">)</span>
<a name="c0-3069"></a><span class="lineno">3069</span>    <span class="n">st_mode</span> <span class="o">=</span> <span class="n">ce_mode_from_stat</span><span class="p">(</span><span class="o">*</span><span class="n">ce</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">st_mode</span><span class="p">);</span>
<a name="c0-3070"></a><span class="lineno">3070</span> 
<a name="c0-3071"></a><span class="lineno">3071</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3072"></a><span class="lineno">3072</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3073"></a><span class="lineno">3073</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">)</span>
<a name="c0-3074"></a><span class="lineno">3074</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">=</span> <span class="n">st_mode</span><span class="p">;</span>
<a name="c0-3075"></a><span class="lineno">3075</span>  <span class="k">if</span> <span class="p">((</span><span class="n">st_mode</span> <span class="o">^</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span>
<a name="c0-3076"></a><span class="lineno">3076</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: wrong type"</span><span class="p">,</span> <span class="n">old_name</span><span class="p">);</span>
<a name="c0-3077"></a><span class="lineno">3077</span>  <span class="k">if</span> <span class="p">(</span><span class="n">st_mode</span> <span class="o">!=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">)</span>
<a name="c0-3078"></a><span class="lineno">3078</span>    <span class="n">warning</span><span class="p">(</span><span class="s">"%s has type %o, expected %o"</span><span class="p">,</span>
<a name="c0-3079"></a><span class="lineno">3079</span>      <span class="n">old_name</span><span class="p">,</span> <span class="n">st_mode</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">);</span>
<a name="c0-3080"></a><span class="lineno">3080</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span><span class="p">)</span>
<a name="c0-3081"></a><span class="lineno">3081</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="n">st_mode</span><span class="p">;</span>
<a name="c0-3082"></a><span class="lineno">3082</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3083"></a><span class="lineno">3083</span> 
<a name="c0-3084"></a><span class="lineno">3084</span>  <span class="nl">is_new:</span>
<a name="c0-3085"></a><span class="lineno">3085</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3086"></a><span class="lineno">3086</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3087"></a><span class="lineno">3087</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3088"></a><span class="lineno">3088</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3089"></a><span class="lineno">3089</span> <span class="p">}</span>
<a name="c0-3090"></a><span class="lineno">3090</span> 
<a name="c0-3091"></a><span class="lineno">3091</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">check_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3092"></a><span class="lineno">3092</span> <span class="p">{</span>
<a name="c0-3093"></a><span class="lineno">3093</span>  <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-3094"></a><span class="lineno">3094</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-3095"></a><span class="lineno">3095</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-3096"></a><span class="lineno">3096</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">old_name</span> <span class="o">?</span> <span class="n">old_name</span> <span class="o">:</span> <span class="n">new_name</span><span class="p">;</span>
<a name="c0-3097"></a><span class="lineno">3097</span>  <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">ce</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3098"></a><span class="lineno">3098</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">tpatch</span><span class="p">;</span>
<a name="c0-3099"></a><span class="lineno">3099</span>  <span class="kt">int</span> <span class="n">ok_if_exists</span><span class="p">;</span>
<a name="c0-3100"></a><span class="lineno">3100</span>  <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-3101"></a><span class="lineno">3101</span> 
<a name="c0-3102"></a><span class="lineno">3102</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">rejected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* we will drop this after we succeed */</span>
<a name="c0-3103"></a><span class="lineno">3103</span> 
<a name="c0-3104"></a><span class="lineno">3104</span>  <span class="n">status</span> <span class="o">=</span> <span class="n">check_preimage</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<a name="c0-3105"></a><span class="lineno">3105</span>  <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
<a name="c0-3106"></a><span class="lineno">3106</span>    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<a name="c0-3107"></a><span class="lineno">3107</span>  <span class="n">old_name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-3108"></a><span class="lineno">3108</span> 
<a name="c0-3109"></a><span class="lineno">3109</span>  <span class="k">if</span> <span class="p">((</span><span class="n">tpatch</span> <span class="o">=</span> <span class="n">in_fn_table</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
<a name="c0-3110"></a><span class="lineno">3110</span>      <span class="p">(</span><span class="n">was_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">)</span> <span class="o">||</span> <span class="n">to_be_deleted</span><span class="p">(</span><span class="n">tpatch</span><span class="p">)))</span>
<a name="c0-3111"></a><span class="lineno">3111</span>    <span class="cm">/*</span>
<a name="c0-3112"></a><span class="lineno">3112</span> <span class="cm">     * A type-change diff is always split into a patch to</span>
<a name="c0-3113"></a><span class="lineno">3113</span> <span class="cm">     * delete old, immediately followed by a patch to</span>
<a name="c0-3114"></a><span class="lineno">3114</span> <span class="cm">     * create new (see diff.c::run_diff()); in such a case</span>
<a name="c0-3115"></a><span class="lineno">3115</span> <span class="cm">     * it is Ok that the entry to be deleted by the</span>
<a name="c0-3116"></a><span class="lineno">3116</span> <span class="cm">     * previous patch is still in the working tree and in</span>
<a name="c0-3117"></a><span class="lineno">3117</span> <span class="cm">     * the index.</span>
<a name="c0-3118"></a><span class="lineno">3118</span> <span class="cm">     */</span>
<a name="c0-3119"></a><span class="lineno">3119</span>    <span class="n">ok_if_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3120"></a><span class="lineno">3120</span>  <span class="k">else</span>
<a name="c0-3121"></a><span class="lineno">3121</span>    <span class="n">ok_if_exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3122"></a><span class="lineno">3122</span> 
<a name="c0-3123"></a><span class="lineno">3123</span>  <span class="k">if</span> <span class="p">(</span><span class="n">new_name</span> <span class="o">&amp;&amp;</span>
<a name="c0-3124"></a><span class="lineno">3124</span>      <span class="p">((</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span><span class="p">)</span> <span class="o">|</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3125"></a><span class="lineno">3125</span>    <span class="k">if</span> <span class="p">(</span><span class="n">check_index</span> <span class="o">&amp;&amp;</span>
<a name="c0-3126"></a><span class="lineno">3126</span>        <span class="n">cache_name_pos</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-3127"></a><span class="lineno">3127</span>        <span class="o">!</span><span class="n">ok_if_exists</span><span class="p">)</span>
<a name="c0-3128"></a><span class="lineno">3128</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: already exists in index"</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>
<a name="c0-3129"></a><span class="lineno">3129</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3130"></a><span class="lineno">3130</span>      <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">check_to_create_blob</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">ok_if_exists</span><span class="p">);</span>
<a name="c0-3131"></a><span class="lineno">3131</span>      <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
<a name="c0-3132"></a><span class="lineno">3132</span>        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<a name="c0-3133"></a><span class="lineno">3133</span>    <span class="p">}</span>
<a name="c0-3134"></a><span class="lineno">3134</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3135"></a><span class="lineno">3135</span>      <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">)</span>
<a name="c0-3136"></a><span class="lineno">3136</span>        <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="mo">0644</span><span class="p">;</span>
<a name="c0-3137"></a><span class="lineno">3137</span>      <span class="k">else</span>
<a name="c0-3138"></a><span class="lineno">3138</span>        <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">;</span>
<a name="c0-3139"></a><span class="lineno">3139</span>    <span class="p">}</span>
<a name="c0-3140"></a><span class="lineno">3140</span>  <span class="p">}</span>
<a name="c0-3141"></a><span class="lineno">3141</span> 
<a name="c0-3142"></a><span class="lineno">3142</span>  <span class="k">if</span> <span class="p">(</span><span class="n">new_name</span> <span class="o">&amp;&amp;</span> <span class="n">old_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3143"></a><span class="lineno">3143</span>    <span class="kt">int</span> <span class="n">same</span> <span class="o">=</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">);</span>
<a name="c0-3144"></a><span class="lineno">3144</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">)</span>
<a name="c0-3145"></a><span class="lineno">3145</span>      <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">;</span>
<a name="c0-3146"></a><span class="lineno">3146</span>    <span class="k">if</span> <span class="p">((</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">^</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_IFMT</span><span class="p">)</span>
<a name="c0-3147"></a><span class="lineno">3147</span>      <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"new mode (%o) of %s does not match old mode (%o)%s%s"</span><span class="p">,</span>
<a name="c0-3148"></a><span class="lineno">3148</span>        <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">,</span>
<a name="c0-3149"></a><span class="lineno">3149</span>        <span class="n">same</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">" of "</span><span class="p">,</span> <span class="n">same</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="n">old_name</span><span class="p">);</span>
<a name="c0-3150"></a><span class="lineno">3150</span>  <span class="p">}</span>
<a name="c0-3151"></a><span class="lineno">3151</span> 
<a name="c0-3152"></a><span class="lineno">3152</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply_data</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="n">ce</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3153"></a><span class="lineno">3153</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"%s: patch does not apply"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3154"></a><span class="lineno">3154</span>  <span class="n">patch</span><span class="o">-&gt;</span><span class="n">rejected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3155"></a><span class="lineno">3155</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3156"></a><span class="lineno">3156</span> <span class="p">}</span>
<a name="c0-3157"></a><span class="lineno">3157</span> 
<a name="c0-3158"></a><span class="lineno">3158</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">check_patch_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3159"></a><span class="lineno">3159</span> <span class="p">{</span>
<a name="c0-3160"></a><span class="lineno">3160</span>  <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3161"></a><span class="lineno">3161</span> 
<a name="c0-3162"></a><span class="lineno">3162</span>  <span class="n">prepare_fn_table</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3163"></a><span class="lineno">3163</span>  <span class="k">while</span> <span class="p">(</span><span class="n">patch</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3164"></a><span class="lineno">3164</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_verbosely</span><span class="p">)</span>
<a name="c0-3165"></a><span class="lineno">3165</span>      <span class="n">say_patch_name</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="c0-3166"></a><span class="lineno">3166</span>               <span class="s">"Checking patch "</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="s">"...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c0-3167"></a><span class="lineno">3167</span>    <span class="n">err</span> <span class="o">|=</span> <span class="n">check_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3168"></a><span class="lineno">3168</span>    <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-3169"></a><span class="lineno">3169</span>  <span class="p">}</span>
<a name="c0-3170"></a><span class="lineno">3170</span>  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<a name="c0-3171"></a><span class="lineno">3171</span> <span class="p">}</span>
<a name="c0-3172"></a><span class="lineno">3172</span> 
<a name="c0-3173"></a><span class="lineno">3173</span> <span class="cm">/* This function tries to read the sha1 from the current index */</span>
<a name="c0-3174"></a><span class="lineno">3174</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">get_current_sha1</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c0-3175"></a><span class="lineno">3175</span> <span class="p">{</span>
<a name="c0-3176"></a><span class="lineno">3176</span>  <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
<a name="c0-3177"></a><span class="lineno">3177</span> 
<a name="c0-3178"></a><span class="lineno">3178</span>  <span class="k">if</span> <span class="p">(</span><span class="n">read_cache</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3179"></a><span class="lineno">3179</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-3180"></a><span class="lineno">3180</span>  <span class="n">pos</span> <span class="o">=</span> <span class="n">cache_name_pos</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>
<a name="c0-3181"></a><span class="lineno">3181</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3182"></a><span class="lineno">3182</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-3183"></a><span class="lineno">3183</span>  <span class="n">hashcpy</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">active_cache</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">);</span>
<a name="c0-3184"></a><span class="lineno">3184</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3185"></a><span class="lineno">3185</span> <span class="p">}</span>
<a name="c0-3186"></a><span class="lineno">3186</span> 
<a name="c0-3187"></a><span class="lineno">3187</span> <span class="cm">/* Build an index that contains the just the files needed for a 3way merge */</span>
<a name="c0-3188"></a><span class="lineno">3188</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">build_fake_ancestor</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<a name="c0-3189"></a><span class="lineno">3189</span> <span class="p">{</span>
<a name="c0-3190"></a><span class="lineno">3190</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">;</span>
<a name="c0-3191"></a><span class="lineno">3191</span>  <span class="k">struct</span> <span class="n">index_state</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span> <span class="p">};</span>
<a name="c0-3192"></a><span class="lineno">3192</span>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-3193"></a><span class="lineno">3193</span> 
<a name="c0-3194"></a><span class="lineno">3194</span>  <span class="cm">/* Once we start supporting the reverse patch, it may be</span>
<a name="c0-3195"></a><span class="lineno">3195</span> <span class="cm">   * worth showing the new sha1 prefix, but until then...</span>
<a name="c0-3196"></a><span class="lineno">3196</span> <span class="cm">   */</span>
<a name="c0-3197"></a><span class="lineno">3197</span>  <span class="k">for</span> <span class="p">(</span><span class="n">patch</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span> <span class="n">patch</span><span class="p">;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3198"></a><span class="lineno">3198</span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1_ptr</span><span class="p">;</span>
<a name="c0-3199"></a><span class="lineno">3199</span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c0-3200"></a><span class="lineno">3200</span>    <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">ce</span><span class="p">;</span>
<a name="c0-3201"></a><span class="lineno">3201</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-3202"></a><span class="lineno">3202</span> 
<a name="c0-3203"></a><span class="lineno">3203</span>    <span class="n">name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-3204"></a><span class="lineno">3204</span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">)</span>
<a name="c0-3205"></a><span class="lineno">3205</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-3206"></a><span class="lineno">3206</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_sha1</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_sha1_prefix</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span>
<a name="c0-3207"></a><span class="lineno">3207</span>      <span class="cm">/* git diff has no index line for mode/type changes */</span>
<a name="c0-3208"></a><span class="lineno">3208</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3209"></a><span class="lineno">3209</span>        <span class="k">if</span> <span class="p">(</span><span class="n">get_current_sha1</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span>
<a name="c0-3210"></a><span class="lineno">3210</span>          <span class="n">die</span><span class="p">(</span><span class="s">"mode change for %s, which is not "</span>
<a name="c0-3211"></a><span class="lineno">3211</span>            <span class="s">"in current HEAD"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3212"></a><span class="lineno">3212</span>        <span class="n">sha1_ptr</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">;</span>
<a name="c0-3213"></a><span class="lineno">3213</span>      <span class="p">}</span> <span class="k">else</span>
<a name="c0-3214"></a><span class="lineno">3214</span>        <span class="n">die</span><span class="p">(</span><span class="s">"sha1 information is lacking or useless "</span>
<a name="c0-3215"></a><span class="lineno">3215</span>          <span class="s">"(%s)."</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3216"></a><span class="lineno">3216</span>    <span class="k">else</span>
<a name="c0-3217"></a><span class="lineno">3217</span>      <span class="n">sha1_ptr</span> <span class="o">=</span> <span class="n">sha1</span><span class="p">;</span>
<a name="c0-3218"></a><span class="lineno">3218</span> 
<a name="c0-3219"></a><span class="lineno">3219</span>    <span class="n">ce</span> <span class="o">=</span> <span class="n">make_cache_entry</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">sha1_ptr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3220"></a><span class="lineno">3220</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ce</span><span class="p">)</span>
<a name="c0-3221"></a><span class="lineno">3221</span>      <span class="n">die</span><span class="p">(</span><span class="s">"make_cache_entry failed for path '%s'"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3222"></a><span class="lineno">3222</span>    <span class="k">if</span> <span class="p">(</span><span class="n">add_index_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">ce</span><span class="p">,</span> <span class="n">ADD_CACHE_OK_TO_ADD</span><span class="p">))</span>
<a name="c0-3223"></a><span class="lineno">3223</span>      <span class="n">die</span> <span class="p">(</span><span class="s">"Could not add %s to temporary index"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3224"></a><span class="lineno">3224</span>  <span class="p">}</span>
<a name="c0-3225"></a><span class="lineno">3225</span> 
<a name="c0-3226"></a><span class="lineno">3226</span>  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
<a name="c0-3227"></a><span class="lineno">3227</span>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">write_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span> <span class="o">||</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
<a name="c0-3228"></a><span class="lineno">3228</span>    <span class="n">die</span> <span class="p">(</span><span class="s">"Could not write temporary index to %s"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
<a name="c0-3229"></a><span class="lineno">3229</span> 
<a name="c0-3230"></a><span class="lineno">3230</span>  <span class="n">discard_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
<a name="c0-3231"></a><span class="lineno">3231</span> <span class="p">}</span>
<a name="c0-3232"></a><span class="lineno">3232</span> 
<a name="c0-3233"></a><span class="lineno">3233</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">stat_patch_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3234"></a><span class="lineno">3234</span> <span class="p">{</span>
<a name="c0-3235"></a><span class="lineno">3235</span>  <span class="kt">int</span> <span class="n">files</span><span class="p">,</span> <span class="n">adds</span><span class="p">,</span> <span class="n">dels</span><span class="p">;</span>
<a name="c0-3236"></a><span class="lineno">3236</span> 
<a name="c0-3237"></a><span class="lineno">3237</span>  <span class="k">for</span> <span class="p">(</span><span class="n">files</span> <span class="o">=</span> <span class="n">adds</span> <span class="o">=</span> <span class="n">dels</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">patch</span> <span class="p">;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3238"></a><span class="lineno">3238</span>    <span class="n">files</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3239"></a><span class="lineno">3239</span>    <span class="n">adds</span> <span class="o">+=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span><span class="p">;</span>
<a name="c0-3240"></a><span class="lineno">3240</span>    <span class="n">dels</span> <span class="o">+=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">;</span>
<a name="c0-3241"></a><span class="lineno">3241</span>    <span class="n">show_stats</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3242"></a><span class="lineno">3242</span>  <span class="p">}</span>
<a name="c0-3243"></a><span class="lineno">3243</span> 
<a name="c0-3244"></a><span class="lineno">3244</span>  <span class="n">printf</span><span class="p">(</span><span class="s">" %d files changed, %d insertions(+), %d deletions(-)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">adds</span><span class="p">,</span> <span class="n">dels</span><span class="p">);</span>
<a name="c0-3245"></a><span class="lineno">3245</span> <span class="p">}</span>
<a name="c0-3246"></a><span class="lineno">3246</span> 
<a name="c0-3247"></a><span class="lineno">3247</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">numstat_patch_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3248"></a><span class="lineno">3248</span> <span class="p">{</span>
<a name="c0-3249"></a><span class="lineno">3249</span>  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">patch</span><span class="p">;</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3250"></a><span class="lineno">3250</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-3251"></a><span class="lineno">3251</span>    <span class="n">name</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">?</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">:</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-3252"></a><span class="lineno">3252</span>    <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_binary</span><span class="p">)</span>
<a name="c0-3253"></a><span class="lineno">3253</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"-</span><span class="se">\t</span><span class="s">-</span><span class="se">\t</span><span class="s">"</span><span class="p">);</span>
<a name="c0-3254"></a><span class="lineno">3254</span>    <span class="k">else</span>
<a name="c0-3255"></a><span class="lineno">3255</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\t</span><span class="s">%d</span><span class="se">\t</span><span class="s">"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">);</span>
<a name="c0-3256"></a><span class="lineno">3256</span>    <span class="n">write_name_quoted</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">line_termination</span><span class="p">);</span>
<a name="c0-3257"></a><span class="lineno">3257</span>  <span class="p">}</span>
<a name="c0-3258"></a><span class="lineno">3258</span> <span class="p">}</span>
<a name="c0-3259"></a><span class="lineno">3259</span> 
<a name="c0-3260"></a><span class="lineno">3260</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_file_mode_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">newdelete</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<a name="c0-3261"></a><span class="lineno">3261</span> <span class="p">{</span>
<a name="c0-3262"></a><span class="lineno">3262</span>  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
<a name="c0-3263"></a><span class="lineno">3263</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" %s mode %06o %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">newdelete</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3264"></a><span class="lineno">3264</span>  <span class="k">else</span>
<a name="c0-3265"></a><span class="lineno">3265</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" %s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">newdelete</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3266"></a><span class="lineno">3266</span> <span class="p">}</span>
<a name="c0-3267"></a><span class="lineno">3267</span> 
<a name="c0-3268"></a><span class="lineno">3268</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_mode_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">show_name</span><span class="p">)</span>
<a name="c0-3269"></a><span class="lineno">3269</span> <span class="p">{</span>
<a name="c0-3270"></a><span class="lineno">3270</span>  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_mode</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_mode</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3271"></a><span class="lineno">3271</span>    <span class="k">if</span> <span class="p">(</span><span class="n">show_name</span><span class="p">)</span>
<a name="c0-3272"></a><span class="lineno">3272</span>      <span class="n">printf</span><span class="p">(</span><span class="s">" mode change %06o =&gt; %06o %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-3273"></a><span class="lineno">3273</span>             <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3274"></a><span class="lineno">3274</span>    <span class="k">else</span>
<a name="c0-3275"></a><span class="lineno">3275</span>      <span class="n">printf</span><span class="p">(</span><span class="s">" mode change %06o =&gt; %06o</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-3276"></a><span class="lineno">3276</span>             <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">);</span>
<a name="c0-3277"></a><span class="lineno">3277</span>  <span class="p">}</span>
<a name="c0-3278"></a><span class="lineno">3278</span> <span class="p">}</span>
<a name="c0-3279"></a><span class="lineno">3279</span> 
<a name="c0-3280"></a><span class="lineno">3280</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_rename_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="c0-3281"></a><span class="lineno">3281</span> <span class="p">{</span>
<a name="c0-3282"></a><span class="lineno">3282</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">renamecopy</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_rename</span> <span class="o">?</span> <span class="s">"rename"</span> <span class="o">:</span> <span class="s">"copy"</span><span class="p">;</span>
<a name="c0-3283"></a><span class="lineno">3283</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
<a name="c0-3284"></a><span class="lineno">3284</span> 
<a name="c0-3285"></a><span class="lineno">3285</span>  <span class="cm">/* Find common prefix */</span>
<a name="c0-3286"></a><span class="lineno">3286</span>  <span class="n">old</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-3287"></a><span class="lineno">3287</span>  <span class="n">new</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-3288"></a><span class="lineno">3288</span>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3289"></a><span class="lineno">3289</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slash_old</span><span class="p">,</span> <span class="o">*</span><span class="n">slash_new</span><span class="p">;</span>
<a name="c0-3290"></a><span class="lineno">3290</span>    <span class="n">slash_old</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-3291"></a><span class="lineno">3291</span>    <span class="n">slash_new</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
<a name="c0-3292"></a><span class="lineno">3292</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slash_old</span> <span class="o">||</span>
<a name="c0-3293"></a><span class="lineno">3293</span>        <span class="o">!</span><span class="n">slash_new</span> <span class="o">||</span>
<a name="c0-3294"></a><span class="lineno">3294</span>        <span class="n">slash_old</span> <span class="o">-</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">slash_new</span> <span class="o">-</span> <span class="n">new</span> <span class="o">||</span>
<a name="c0-3295"></a><span class="lineno">3295</span>        <span class="n">memcmp</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">slash_new</span> <span class="o">-</span> <span class="n">new</span><span class="p">))</span>
<a name="c0-3296"></a><span class="lineno">3296</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-3297"></a><span class="lineno">3297</span>    <span class="n">old</span> <span class="o">=</span> <span class="n">slash_old</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3298"></a><span class="lineno">3298</span>    <span class="n">new</span> <span class="o">=</span> <span class="n">slash_new</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3299"></a><span class="lineno">3299</span>  <span class="p">}</span>
<a name="c0-3300"></a><span class="lineno">3300</span>  <span class="cm">/* p-&gt;old_name thru old is the common prefix, and old and new</span>
<a name="c0-3301"></a><span class="lineno">3301</span> <span class="cm">   * through the end of names are renames</span>
<a name="c0-3302"></a><span class="lineno">3302</span> <span class="cm">   */</span>
<a name="c0-3303"></a><span class="lineno">3303</span>  <span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span>
<a name="c0-3304"></a><span class="lineno">3304</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" %s %.*s{%s =&gt; %s} (%d%%)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">renamecopy</span><span class="p">,</span>
<a name="c0-3305"></a><span class="lineno">3305</span>           <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">old</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span>
<a name="c0-3306"></a><span class="lineno">3306</span>           <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">);</span>
<a name="c0-3307"></a><span class="lineno">3307</span>  <span class="k">else</span>
<a name="c0-3308"></a><span class="lineno">3308</span>    <span class="n">printf</span><span class="p">(</span><span class="s">" %s %s =&gt; %s (%d%%)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">renamecopy</span><span class="p">,</span>
<a name="c0-3309"></a><span class="lineno">3309</span>           <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">);</span>
<a name="c0-3310"></a><span class="lineno">3310</span>  <span class="n">show_mode_change</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3311"></a><span class="lineno">3311</span> <span class="p">}</span>
<a name="c0-3312"></a><span class="lineno">3312</span> 
<a name="c0-3313"></a><span class="lineno">3313</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">summary_patch_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3314"></a><span class="lineno">3314</span> <span class="p">{</span>
<a name="c0-3315"></a><span class="lineno">3315</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<a name="c0-3316"></a><span class="lineno">3316</span> 
<a name="c0-3317"></a><span class="lineno">3317</span>  <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">patch</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3318"></a><span class="lineno">3318</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">)</span>
<a name="c0-3319"></a><span class="lineno">3319</span>      <span class="n">show_file_mode_name</span><span class="p">(</span><span class="s">"create"</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3320"></a><span class="lineno">3320</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_delete</span><span class="p">)</span>
<a name="c0-3321"></a><span class="lineno">3321</span>      <span class="n">show_file_mode_name</span><span class="p">(</span><span class="s">"delete"</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-3322"></a><span class="lineno">3322</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c0-3323"></a><span class="lineno">3323</span>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_rename</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_copy</span><span class="p">)</span>
<a name="c0-3324"></a><span class="lineno">3324</span>        <span class="n">show_rename_copy</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c0-3325"></a><span class="lineno">3325</span>      <span class="k">else</span> <span class="p">{</span>
<a name="c0-3326"></a><span class="lineno">3326</span>        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3327"></a><span class="lineno">3327</span>          <span class="n">printf</span><span class="p">(</span><span class="s">" rewrite %s (%d%%)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-3328"></a><span class="lineno">3328</span>                 <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">);</span>
<a name="c0-3329"></a><span class="lineno">3329</span>          <span class="n">show_mode_change</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3330"></a><span class="lineno">3330</span>        <span class="p">}</span>
<a name="c0-3331"></a><span class="lineno">3331</span>        <span class="k">else</span>
<a name="c0-3332"></a><span class="lineno">3332</span>          <span class="n">show_mode_change</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-3333"></a><span class="lineno">3333</span>      <span class="p">}</span>
<a name="c0-3334"></a><span class="lineno">3334</span>    <span class="p">}</span>
<a name="c0-3335"></a><span class="lineno">3335</span>  <span class="p">}</span>
<a name="c0-3336"></a><span class="lineno">3336</span> <span class="p">}</span>
<a name="c0-3337"></a><span class="lineno">3337</span> 
<a name="c0-3338"></a><span class="lineno">3338</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">patch_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3339"></a><span class="lineno">3339</span> <span class="p">{</span>
<a name="c0-3340"></a><span class="lineno">3340</span>  <span class="kt">int</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_added</span> <span class="o">+</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">lines_deleted</span><span class="p">;</span>
<a name="c0-3341"></a><span class="lineno">3341</span> 
<a name="c0-3342"></a><span class="lineno">3342</span>  <span class="k">if</span> <span class="p">(</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="n">max_change</span><span class="p">)</span>
<a name="c0-3343"></a><span class="lineno">3343</span>    <span class="n">max_change</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
<a name="c0-3344"></a><span class="lineno">3344</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3345"></a><span class="lineno">3345</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">quote_c_style</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3346"></a><span class="lineno">3346</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c0-3347"></a><span class="lineno">3347</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-3348"></a><span class="lineno">3348</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">)</span>
<a name="c0-3349"></a><span class="lineno">3349</span>      <span class="n">max_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-3350"></a><span class="lineno">3350</span>  <span class="p">}</span>
<a name="c0-3351"></a><span class="lineno">3351</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3352"></a><span class="lineno">3352</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">quote_c_style</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3353"></a><span class="lineno">3353</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
<a name="c0-3354"></a><span class="lineno">3354</span>      <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3355"></a><span class="lineno">3355</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">)</span>
<a name="c0-3356"></a><span class="lineno">3356</span>      <span class="n">max_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<a name="c0-3357"></a><span class="lineno">3357</span>  <span class="p">}</span>
<a name="c0-3358"></a><span class="lineno">3358</span> <span class="p">}</span>
<a name="c0-3359"></a><span class="lineno">3359</span> 
<a name="c0-3360"></a><span class="lineno">3360</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rmdir_empty</span><span class="p">)</span>
<a name="c0-3361"></a><span class="lineno">3361</span> <span class="p">{</span>
<a name="c0-3362"></a><span class="lineno">3362</span>  <span class="k">if</span> <span class="p">(</span><span class="n">update_index</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3363"></a><span class="lineno">3363</span>    <span class="k">if</span> <span class="p">(</span><span class="n">remove_file_from_cache</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3364"></a><span class="lineno">3364</span>      <span class="n">die</span><span class="p">(</span><span class="s">"unable to remove %s from index"</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-3365"></a><span class="lineno">3365</span>  <span class="p">}</span>
<a name="c0-3366"></a><span class="lineno">3366</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3367"></a><span class="lineno">3367</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remove_or_warn</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rmdir_empty</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3368"></a><span class="lineno">3368</span>      <span class="n">remove_path</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-3369"></a><span class="lineno">3369</span>    <span class="p">}</span>
<a name="c0-3370"></a><span class="lineno">3370</span>  <span class="p">}</span>
<a name="c0-3371"></a><span class="lineno">3371</span> <span class="p">}</span>
<a name="c0-3372"></a><span class="lineno">3372</span> 
<a name="c0-3373"></a><span class="lineno">3373</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_index_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<a name="c0-3374"></a><span class="lineno">3374</span> <span class="p">{</span>
<a name="c0-3375"></a><span class="lineno">3375</span>  <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-3376"></a><span class="lineno">3376</span>  <span class="k">struct</span> <span class="n">cache_entry</span> <span class="o">*</span><span class="n">ce</span><span class="p">;</span>
<a name="c0-3377"></a><span class="lineno">3377</span>  <span class="kt">int</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<a name="c0-3378"></a><span class="lineno">3378</span>  <span class="kt">unsigned</span> <span class="n">ce_size</span> <span class="o">=</span> <span class="n">cache_entry_size</span><span class="p">(</span><span class="n">namelen</span><span class="p">);</span>
<a name="c0-3379"></a><span class="lineno">3379</span> 
<a name="c0-3380"></a><span class="lineno">3380</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update_index</span><span class="p">)</span>
<a name="c0-3381"></a><span class="lineno">3381</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3382"></a><span class="lineno">3382</span> 
<a name="c0-3383"></a><span class="lineno">3383</span>  <span class="n">ce</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ce_size</span><span class="p">);</span>
<a name="c0-3384"></a><span class="lineno">3384</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">ce</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
<a name="c0-3385"></a><span class="lineno">3385</span>  <span class="n">ce</span><span class="o">-&gt;</span><span class="n">ce_mode</span> <span class="o">=</span> <span class="n">create_ce_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
<a name="c0-3386"></a><span class="lineno">3386</span>  <span class="n">ce</span><span class="o">-&gt;</span><span class="n">ce_flags</span> <span class="o">=</span> <span class="n">namelen</span><span class="p">;</span>
<a name="c0-3387"></a><span class="lineno">3387</span>  <span class="k">if</span> <span class="p">(</span><span class="n">S_ISGITLINK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3388"></a><span class="lineno">3388</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<a name="c0-3389"></a><span class="lineno">3389</span> 
<a name="c0-3390"></a><span class="lineno">3390</span>    <span class="k">if</span> <span class="p">(</span><span class="n">get_sha1_hex</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"Subproject commit "</span><span class="p">),</span> <span class="n">ce</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">))</span>
<a name="c0-3391"></a><span class="lineno">3391</span>      <span class="n">die</span><span class="p">(</span><span class="s">"corrupt patch for subproject %s"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-3392"></a><span class="lineno">3392</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-3393"></a><span class="lineno">3393</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3394"></a><span class="lineno">3394</span>      <span class="k">if</span> <span class="p">(</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3395"></a><span class="lineno">3395</span>        <span class="n">die_errno</span><span class="p">(</span><span class="s">"unable to stat newly created file '%s'"</span><span class="p">,</span>
<a name="c0-3396"></a><span class="lineno">3396</span>            <span class="n">path</span><span class="p">);</span>
<a name="c0-3397"></a><span class="lineno">3397</span>      <span class="n">fill_stat_cache_info</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<a name="c0-3398"></a><span class="lineno">3398</span>    <span class="p">}</span>
<a name="c0-3399"></a><span class="lineno">3399</span>    <span class="k">if</span> <span class="p">(</span><span class="n">write_sha1_file</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">blob_type</span><span class="p">,</span> <span class="n">ce</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3400"></a><span class="lineno">3400</span>      <span class="n">die</span><span class="p">(</span><span class="s">"unable to create backing store for newly created file %s"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-3401"></a><span class="lineno">3401</span>  <span class="p">}</span>
<a name="c0-3402"></a><span class="lineno">3402</span>  <span class="k">if</span> <span class="p">(</span><span class="n">add_cache_entry</span><span class="p">(</span><span class="n">ce</span><span class="p">,</span> <span class="n">ADD_CACHE_OK_TO_ADD</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3403"></a><span class="lineno">3403</span>    <span class="n">die</span><span class="p">(</span><span class="s">"unable to add cache entry for %s"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-3404"></a><span class="lineno">3404</span> <span class="p">}</span>
<a name="c0-3405"></a><span class="lineno">3405</span> 
<a name="c0-3406"></a><span class="lineno">3406</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">try_create_file</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<a name="c0-3407"></a><span class="lineno">3407</span> <span class="p">{</span>
<a name="c0-3408"></a><span class="lineno">3408</span>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-3409"></a><span class="lineno">3409</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">nbuf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-3410"></a><span class="lineno">3410</span> 
<a name="c0-3411"></a><span class="lineno">3411</span>  <span class="k">if</span> <span class="p">(</span><span class="n">S_ISGITLINK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3412"></a><span class="lineno">3412</span>    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-3413"></a><span class="lineno">3413</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span>
<a name="c0-3414"></a><span class="lineno">3414</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3415"></a><span class="lineno">3415</span>    <span class="k">return</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span>
<a name="c0-3416"></a><span class="lineno">3416</span>  <span class="p">}</span>
<a name="c0-3417"></a><span class="lineno">3417</span> 
<a name="c0-3418"></a><span class="lineno">3418</span>  <span class="k">if</span> <span class="p">(</span><span class="n">has_symlinks</span> <span class="o">&amp;&amp;</span> <span class="n">S_ISLNK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
<a name="c0-3419"></a><span class="lineno">3419</span>    <span class="cm">/* Although buf:size is counted string, it also is NUL</span>
<a name="c0-3420"></a><span class="lineno">3420</span> <span class="cm">     * terminated.</span>
<a name="c0-3421"></a><span class="lineno">3421</span> <span class="cm">     */</span>
<a name="c0-3422"></a><span class="lineno">3422</span>    <span class="k">return</span> <span class="n">symlink</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-3423"></a><span class="lineno">3423</span> 
<a name="c0-3424"></a><span class="lineno">3424</span>  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_EXCL</span> <span class="o">|</span> <span class="n">O_WRONLY</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0100</span><span class="p">)</span> <span class="o">?</span> <span class="mo">0777</span> <span class="o">:</span> <span class="mo">0666</span><span class="p">);</span>
<a name="c0-3425"></a><span class="lineno">3425</span>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3426"></a><span class="lineno">3426</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-3427"></a><span class="lineno">3427</span> 
<a name="c0-3428"></a><span class="lineno">3428</span>  <span class="k">if</span> <span class="p">(</span><span class="n">convert_to_working_tree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbuf</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3429"></a><span class="lineno">3429</span>    <span class="n">size</span> <span class="o">=</span> <span class="n">nbuf</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="c0-3430"></a><span class="lineno">3430</span>    <span class="n">buf</span>  <span class="o">=</span> <span class="n">nbuf</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="c0-3431"></a><span class="lineno">3431</span>  <span class="p">}</span>
<a name="c0-3432"></a><span class="lineno">3432</span>  <span class="n">write_or_die</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-3433"></a><span class="lineno">3433</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nbuf</span><span class="p">);</span>
<a name="c0-3434"></a><span class="lineno">3434</span> 
<a name="c0-3435"></a><span class="lineno">3435</span>  <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3436"></a><span class="lineno">3436</span>    <span class="n">die_errno</span><span class="p">(</span><span class="s">"closing file '%s'"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<a name="c0-3437"></a><span class="lineno">3437</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3438"></a><span class="lineno">3438</span> <span class="p">}</span>
<a name="c0-3439"></a><span class="lineno">3439</span> 
<a name="c0-3440"></a><span class="lineno">3440</span> <span class="cm">/*</span>
<a name="c0-3441"></a><span class="lineno">3441</span> <span class="cm"> * We optimistically assume that the directories exist,</span>
<a name="c0-3442"></a><span class="lineno">3442</span> <span class="cm"> * which is true 99% of the time anyway. If they don't,</span>
<a name="c0-3443"></a><span class="lineno">3443</span> <span class="cm"> * we create them and try again.</span>
<a name="c0-3444"></a><span class="lineno">3444</span> <span class="cm"> */</span>
<a name="c0-3445"></a><span class="lineno">3445</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">create_one_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<a name="c0-3446"></a><span class="lineno">3446</span> <span class="p">{</span>
<a name="c0-3447"></a><span class="lineno">3447</span>  <span class="k">if</span> <span class="p">(</span><span class="n">cached</span><span class="p">)</span>
<a name="c0-3448"></a><span class="lineno">3448</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3449"></a><span class="lineno">3449</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_create_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
<a name="c0-3450"></a><span class="lineno">3450</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3451"></a><span class="lineno">3451</span> 
<a name="c0-3452"></a><span class="lineno">3452</span>  <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3453"></a><span class="lineno">3453</span>    <span class="k">if</span> <span class="p">(</span><span class="n">safe_create_leading_directories</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
<a name="c0-3454"></a><span class="lineno">3454</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-3455"></a><span class="lineno">3455</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_create_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
<a name="c0-3456"></a><span class="lineno">3456</span>      <span class="k">return</span><span class="p">;</span>
<a name="c0-3457"></a><span class="lineno">3457</span>  <span class="p">}</span>
<a name="c0-3458"></a><span class="lineno">3458</span> 
<a name="c0-3459"></a><span class="lineno">3459</span>  <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EEXIST</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EACCES</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3460"></a><span class="lineno">3460</span>    <span class="cm">/* We may be trying to create a file where a directory</span>
<a name="c0-3461"></a><span class="lineno">3461</span> <span class="cm">     * used to be.</span>
<a name="c0-3462"></a><span class="lineno">3462</span> <span class="cm">     */</span>
<a name="c0-3463"></a><span class="lineno">3463</span>    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="c0-3464"></a><span class="lineno">3464</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
<a name="c0-3465"></a><span class="lineno">3465</span>      <span class="n">errno</span> <span class="o">=</span> <span class="n">EEXIST</span><span class="p">;</span>
<a name="c0-3466"></a><span class="lineno">3466</span>  <span class="p">}</span>
<a name="c0-3467"></a><span class="lineno">3467</span> 
<a name="c0-3468"></a><span class="lineno">3468</span>  <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EEXIST</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3469"></a><span class="lineno">3469</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
<a name="c0-3470"></a><span class="lineno">3470</span> 
<a name="c0-3471"></a><span class="lineno">3471</span>    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-3472"></a><span class="lineno">3472</span>      <span class="kt">char</span> <span class="n">newpath</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
<a name="c0-3473"></a><span class="lineno">3473</span>      <span class="n">mksnpath</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">newpath</span><span class="p">),</span> <span class="s">"%s~%u"</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
<a name="c0-3474"></a><span class="lineno">3474</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_create_file</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3475"></a><span class="lineno">3475</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rename</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
<a name="c0-3476"></a><span class="lineno">3476</span>          <span class="k">return</span><span class="p">;</span>
<a name="c0-3477"></a><span class="lineno">3477</span>        <span class="n">unlink_or_warn</span><span class="p">(</span><span class="n">newpath</span><span class="p">);</span>
<a name="c0-3478"></a><span class="lineno">3478</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-3479"></a><span class="lineno">3479</span>      <span class="p">}</span>
<a name="c0-3480"></a><span class="lineno">3480</span>      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">)</span>
<a name="c0-3481"></a><span class="lineno">3481</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-3482"></a><span class="lineno">3482</span>      <span class="o">++</span><span class="n">nr</span><span class="p">;</span>
<a name="c0-3483"></a><span class="lineno">3483</span>    <span class="p">}</span>
<a name="c0-3484"></a><span class="lineno">3484</span>  <span class="p">}</span>
<a name="c0-3485"></a><span class="lineno">3485</span>  <span class="n">die_errno</span><span class="p">(</span><span class="s">"unable to write file '%s' mode %o"</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<a name="c0-3486"></a><span class="lineno">3486</span> <span class="p">}</span>
<a name="c0-3487"></a><span class="lineno">3487</span> 
<a name="c0-3488"></a><span class="lineno">3488</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">create_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3489"></a><span class="lineno">3489</span> <span class="p">{</span>
<a name="c0-3490"></a><span class="lineno">3490</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-3491"></a><span class="lineno">3491</span>  <span class="kt">unsigned</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_mode</span><span class="p">;</span>
<a name="c0-3492"></a><span class="lineno">3492</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">resultsize</span><span class="p">;</span>
<a name="c0-3493"></a><span class="lineno">3493</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
<a name="c0-3494"></a><span class="lineno">3494</span> 
<a name="c0-3495"></a><span class="lineno">3495</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
<a name="c0-3496"></a><span class="lineno">3496</span>    <span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="mo">0644</span><span class="p">;</span>
<a name="c0-3497"></a><span class="lineno">3497</span>  <span class="n">create_one_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-3498"></a><span class="lineno">3498</span>  <span class="n">add_index_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<a name="c0-3499"></a><span class="lineno">3499</span> <span class="p">}</span>
<a name="c0-3500"></a><span class="lineno">3500</span> 
<a name="c0-3501"></a><span class="lineno">3501</span> <span class="cm">/* phase zero is to remove, phase one is to create */</span>
<a name="c0-3502"></a><span class="lineno">3502</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">write_out_one_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phase</span><span class="p">)</span>
<a name="c0-3503"></a><span class="lineno">3503</span> <span class="p">{</span>
<a name="c0-3504"></a><span class="lineno">3504</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_delete</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3505"></a><span class="lineno">3505</span>    <span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3506"></a><span class="lineno">3506</span>      <span class="n">remove_file</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-3507"></a><span class="lineno">3507</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3508"></a><span class="lineno">3508</span>  <span class="p">}</span>
<a name="c0-3509"></a><span class="lineno">3509</span>  <span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_copy</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3510"></a><span class="lineno">3510</span>    <span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-3511"></a><span class="lineno">3511</span>      <span class="n">create_file</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3512"></a><span class="lineno">3512</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3513"></a><span class="lineno">3513</span>  <span class="p">}</span>
<a name="c0-3514"></a><span class="lineno">3514</span>  <span class="cm">/*</span>
<a name="c0-3515"></a><span class="lineno">3515</span> <span class="cm">   * Rename or modification boils down to the same</span>
<a name="c0-3516"></a><span class="lineno">3516</span> <span class="cm">   * thing: remove the old, write the new</span>
<a name="c0-3517"></a><span class="lineno">3517</span> <span class="cm">   */</span>
<a name="c0-3518"></a><span class="lineno">3518</span>  <span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3519"></a><span class="lineno">3519</span>    <span class="n">remove_file</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">is_rename</span><span class="p">);</span>
<a name="c0-3520"></a><span class="lineno">3520</span>  <span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a name="c0-3521"></a><span class="lineno">3521</span>    <span class="n">create_file</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3522"></a><span class="lineno">3522</span> <span class="p">}</span>
<a name="c0-3523"></a><span class="lineno">3523</span> 
<a name="c0-3524"></a><span class="lineno">3524</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">write_out_one_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">)</span>
<a name="c0-3525"></a><span class="lineno">3525</span> <span class="p">{</span>
<a name="c0-3526"></a><span class="lineno">3526</span>  <span class="kt">FILE</span> <span class="o">*</span><span class="n">rej</span><span class="p">;</span>
<a name="c0-3527"></a><span class="lineno">3527</span>  <span class="kt">char</span> <span class="n">namebuf</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
<a name="c0-3528"></a><span class="lineno">3528</span>  <span class="k">struct</span> <span class="n">fragment</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
<a name="c0-3529"></a><span class="lineno">3529</span>  <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3530"></a><span class="lineno">3530</span> 
<a name="c0-3531"></a><span class="lineno">3531</span>  <span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">;</span> <span class="n">frag</span><span class="p">;</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3532"></a><span class="lineno">3532</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">rejected</span><span class="p">)</span>
<a name="c0-3533"></a><span class="lineno">3533</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-3534"></a><span class="lineno">3534</span>    <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3535"></a><span class="lineno">3535</span>  <span class="p">}</span>
<a name="c0-3536"></a><span class="lineno">3536</span> 
<a name="c0-3537"></a><span class="lineno">3537</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3538"></a><span class="lineno">3538</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_verbosely</span><span class="p">)</span>
<a name="c0-3539"></a><span class="lineno">3539</span>      <span class="n">say_patch_name</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="c0-3540"></a><span class="lineno">3540</span>               <span class="s">"Applied patch "</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="s">" cleanly.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c0-3541"></a><span class="lineno">3541</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3542"></a><span class="lineno">3542</span>  <span class="p">}</span>
<a name="c0-3543"></a><span class="lineno">3543</span> 
<a name="c0-3544"></a><span class="lineno">3544</span>  <span class="cm">/* This should not happen, because a removal patch that leaves</span>
<a name="c0-3545"></a><span class="lineno">3545</span> <span class="cm">   * contents are marked "rejected" at the patch level.</span>
<a name="c0-3546"></a><span class="lineno">3546</span> <span class="cm">   */</span>
<a name="c0-3547"></a><span class="lineno">3547</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">)</span>
<a name="c0-3548"></a><span class="lineno">3548</span>    <span class="n">die</span><span class="p">(</span><span class="s">"internal error"</span><span class="p">);</span>
<a name="c0-3549"></a><span class="lineno">3549</span> 
<a name="c0-3550"></a><span class="lineno">3550</span>  <span class="cm">/* Say this even without --verbose */</span>
<a name="c0-3551"></a><span class="lineno">3551</span>  <span class="n">say_patch_name</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Applying patch "</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="s">" with"</span><span class="p">);</span>
<a name="c0-3552"></a><span class="lineno">3552</span>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">" %d rejects...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<a name="c0-3553"></a><span class="lineno">3553</span> 
<a name="c0-3554"></a><span class="lineno">3554</span>  <span class="n">cnt</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3555"></a><span class="lineno">3555</span>  <span class="k">if</span> <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">namebuf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3556"></a><span class="lineno">3556</span>    <span class="n">cnt</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">namebuf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
<a name="c0-3557"></a><span class="lineno">3557</span>    <span class="n">warning</span><span class="p">(</span><span class="s">"truncating .rej filename to %.*s.rej"</span><span class="p">,</span>
<a name="c0-3558"></a><span class="lineno">3558</span>      <span class="n">cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3559"></a><span class="lineno">3559</span>  <span class="p">}</span>
<a name="c0-3560"></a><span class="lineno">3560</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<a name="c0-3561"></a><span class="lineno">3561</span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">namebuf</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">,</span> <span class="s">".rej"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<a name="c0-3562"></a><span class="lineno">3562</span> 
<a name="c0-3563"></a><span class="lineno">3563</span>  <span class="n">rej</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">namebuf</span><span class="p">,</span> <span class="s">"w"</span><span class="p">);</span>
<a name="c0-3564"></a><span class="lineno">3564</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rej</span><span class="p">)</span>
<a name="c0-3565"></a><span class="lineno">3565</span>    <span class="k">return</span> <span class="n">error</span><span class="p">(</span><span class="s">"cannot open %s: %s"</span><span class="p">,</span> <span class="n">namebuf</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<a name="c0-3566"></a><span class="lineno">3566</span> 
<a name="c0-3567"></a><span class="lineno">3567</span>  <span class="cm">/* Normal git tools never deal with .rej, so do not pretend</span>
<a name="c0-3568"></a><span class="lineno">3568</span> <span class="cm">   * this is a git patch by saying --git nor give extended</span>
<a name="c0-3569"></a><span class="lineno">3569</span> <span class="cm">   * headers.  While at it, maybe please "kompare" that wants</span>
<a name="c0-3570"></a><span class="lineno">3570</span> <span class="cm">   * the trailing TAB and some garbage at the end of line ;-).</span>
<a name="c0-3571"></a><span class="lineno">3571</span> <span class="cm">   */</span>
<a name="c0-3572"></a><span class="lineno">3572</span>  <span class="n">fprintf</span><span class="p">(</span><span class="n">rej</span><span class="p">,</span> <span class="s">"diff a/%s b/%s</span><span class="se">\t</span><span class="s">(rejected hunks)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c0-3573"></a><span class="lineno">3573</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">,</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3574"></a><span class="lineno">3574</span>  <span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">patch</span><span class="o">-&gt;</span><span class="n">fragments</span><span class="p">;</span>
<a name="c0-3575"></a><span class="lineno">3575</span>       <span class="n">frag</span><span class="p">;</span>
<a name="c0-3576"></a><span class="lineno">3576</span>       <span class="n">cnt</span><span class="o">++</span><span class="p">,</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3577"></a><span class="lineno">3577</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">rejected</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3578"></a><span class="lineno">3578</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Hunk #%d applied cleanly.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<a name="c0-3579"></a><span class="lineno">3579</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-3580"></a><span class="lineno">3580</span>    <span class="p">}</span>
<a name="c0-3581"></a><span class="lineno">3581</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Rejected hunk #%d.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
<a name="c0-3582"></a><span class="lineno">3582</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">rej</span><span class="p">,</span> <span class="s">"%.*s"</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3583"></a><span class="lineno">3583</span>    <span class="k">if</span> <span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">[</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span>
<a name="c0-3584"></a><span class="lineno">3584</span>      <span class="n">fputc</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">rej</span><span class="p">);</span>
<a name="c0-3585"></a><span class="lineno">3585</span>  <span class="p">}</span>
<a name="c0-3586"></a><span class="lineno">3586</span>  <span class="n">fclose</span><span class="p">(</span><span class="n">rej</span><span class="p">);</span>
<a name="c0-3587"></a><span class="lineno">3587</span>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-3588"></a><span class="lineno">3588</span> <span class="p">}</span>
<a name="c0-3589"></a><span class="lineno">3589</span> 
<a name="c0-3590"></a><span class="lineno">3590</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">write_out_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<a name="c0-3591"></a><span class="lineno">3591</span> <span class="p">{</span>
<a name="c0-3592"></a><span class="lineno">3592</span>  <span class="kt">int</span> <span class="n">phase</span><span class="p">;</span>
<a name="c0-3593"></a><span class="lineno">3593</span>  <span class="kt">int</span> <span class="n">errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3594"></a><span class="lineno">3594</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
<a name="c0-3595"></a><span class="lineno">3595</span> 
<a name="c0-3596"></a><span class="lineno">3596</span>  <span class="k">for</span> <span class="p">(</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phase</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">phase</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3597"></a><span class="lineno">3597</span>    <span class="n">l</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
<a name="c0-3598"></a><span class="lineno">3598</span>    <span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3599"></a><span class="lineno">3599</span>      <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">rejected</span><span class="p">)</span>
<a name="c0-3600"></a><span class="lineno">3600</span>        <span class="n">errs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3601"></a><span class="lineno">3601</span>      <span class="k">else</span> <span class="p">{</span>
<a name="c0-3602"></a><span class="lineno">3602</span>        <span class="n">write_out_one_result</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>
<a name="c0-3603"></a><span class="lineno">3603</span>        <span class="k">if</span> <span class="p">(</span><span class="n">phase</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">write_out_one_reject</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
<a name="c0-3604"></a><span class="lineno">3604</span>          <span class="n">errs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3605"></a><span class="lineno">3605</span>      <span class="p">}</span>
<a name="c0-3606"></a><span class="lineno">3606</span>      <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-3607"></a><span class="lineno">3607</span>    <span class="p">}</span>
<a name="c0-3608"></a><span class="lineno">3608</span>  <span class="p">}</span>
<a name="c0-3609"></a><span class="lineno">3609</span>  <span class="k">return</span> <span class="n">errs</span><span class="p">;</span>
<a name="c0-3610"></a><span class="lineno">3610</span> <span class="p">}</span>
<a name="c0-3611"></a><span class="lineno">3611</span> 
<a name="c0-3612"></a><span class="lineno">3612</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">lock_file</span> <span class="n">lock_file</span><span class="p">;</span>
<a name="c0-3613"></a><span class="lineno">3613</span> 
<a name="c0-3614"></a><span class="lineno">3614</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">string_list</span> <span class="n">limit_by_name</span><span class="p">;</span>
<a name="c0-3615"></a><span class="lineno">3615</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">has_include</span><span class="p">;</span>
<a name="c0-3616"></a><span class="lineno">3616</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_name_limit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exclude</span><span class="p">)</span>
<a name="c0-3617"></a><span class="lineno">3617</span> <span class="p">{</span>
<a name="c0-3618"></a><span class="lineno">3618</span>  <span class="k">struct</span> <span class="n">string_list_item</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
<a name="c0-3619"></a><span class="lineno">3619</span> 
<a name="c0-3620"></a><span class="lineno">3620</span>  <span class="n">it</span> <span class="o">=</span> <span class="n">string_list_append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">limit_by_name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<a name="c0-3621"></a><span class="lineno">3621</span>  <span class="n">it</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">=</span> <span class="n">exclude</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3622"></a><span class="lineno">3622</span> <span class="p">}</span>
<a name="c0-3623"></a><span class="lineno">3623</span> 
<a name="c0-3624"></a><span class="lineno">3624</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">use_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="c0-3625"></a><span class="lineno">3625</span> <span class="p">{</span>
<a name="c0-3626"></a><span class="lineno">3626</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">?</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">;</span>
<a name="c0-3627"></a><span class="lineno">3627</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-3628"></a><span class="lineno">3628</span> 
<a name="c0-3629"></a><span class="lineno">3629</span>  <span class="cm">/* Paths outside are not touched regardless of "--include" */</span>
<a name="c0-3630"></a><span class="lineno">3630</span>  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">prefix_length</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3631"></a><span class="lineno">3631</span>    <span class="kt">int</span> <span class="n">pathlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pathname</span><span class="p">);</span>
<a name="c0-3632"></a><span class="lineno">3632</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pathlen</span> <span class="o">&lt;=</span> <span class="n">prefix_length</span> <span class="o">||</span>
<a name="c0-3633"></a><span class="lineno">3633</span>        <span class="n">memcmp</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">))</span>
<a name="c0-3634"></a><span class="lineno">3634</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3635"></a><span class="lineno">3635</span>  <span class="p">}</span>
<a name="c0-3636"></a><span class="lineno">3636</span> 
<a name="c0-3637"></a><span class="lineno">3637</span>  <span class="cm">/* See if it matches any of exclude/include rule */</span>
<a name="c0-3638"></a><span class="lineno">3638</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit_by_name</span><span class="p">.</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3639"></a><span class="lineno">3639</span>    <span class="k">struct</span> <span class="n">string_list_item</span> <span class="o">*</span><span class="n">it</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">limit_by_name</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-3640"></a><span class="lineno">3640</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a name="c0-3641"></a><span class="lineno">3641</span>      <span class="k">return</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-3642"></a><span class="lineno">3642</span>  <span class="p">}</span>
<a name="c0-3643"></a><span class="lineno">3643</span> 
<a name="c0-3644"></a><span class="lineno">3644</span>  <span class="cm">/*</span>
<a name="c0-3645"></a><span class="lineno">3645</span> <span class="cm">   * If we had any include, a path that does not match any rule is</span>
<a name="c0-3646"></a><span class="lineno">3646</span> <span class="cm">   * not used.  Otherwise, we saw bunch of exclude rules (or none)</span>
<a name="c0-3647"></a><span class="lineno">3647</span> <span class="cm">   * and such a path is used.</span>
<a name="c0-3648"></a><span class="lineno">3648</span> <span class="cm">   */</span>
<a name="c0-3649"></a><span class="lineno">3649</span>  <span class="k">return</span> <span class="o">!</span><span class="n">has_include</span><span class="p">;</span>
<a name="c0-3650"></a><span class="lineno">3650</span> <span class="p">}</span>
<a name="c0-3651"></a><span class="lineno">3651</span> 
<a name="c0-3652"></a><span class="lineno">3652</span> 
<a name="c0-3653"></a><span class="lineno">3653</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">prefix_one</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">name</span><span class="p">)</span>
<a name="c0-3654"></a><span class="lineno">3654</span> <span class="p">{</span>
<a name="c0-3655"></a><span class="lineno">3655</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">old_name</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c0-3656"></a><span class="lineno">3656</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_name</span><span class="p">)</span>
<a name="c0-3657"></a><span class="lineno">3657</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3658"></a><span class="lineno">3658</span>  <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">xstrdup</span><span class="p">(</span><span class="n">prefix_filename</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">));</span>
<a name="c0-3659"></a><span class="lineno">3659</span>  <span class="n">free</span><span class="p">(</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-3660"></a><span class="lineno">3660</span> <span class="p">}</span>
<a name="c0-3661"></a><span class="lineno">3661</span> 
<a name="c0-3662"></a><span class="lineno">3662</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">prefix_patches</span><span class="p">(</span><span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="c0-3663"></a><span class="lineno">3663</span> <span class="p">{</span>
<a name="c0-3664"></a><span class="lineno">3664</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefix</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_toplevel_relative</span><span class="p">)</span>
<a name="c0-3665"></a><span class="lineno">3665</span>    <span class="k">return</span><span class="p">;</span>
<a name="c0-3666"></a><span class="lineno">3666</span>  <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3667"></a><span class="lineno">3667</span>    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3668"></a><span class="lineno">3668</span>      <span class="kt">char</span> <span class="o">*</span><span class="n">prefixed</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">;</span>
<a name="c0-3669"></a><span class="lineno">3669</span>      <span class="n">prefix_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prefixed</span><span class="p">);</span>
<a name="c0-3670"></a><span class="lineno">3670</span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">;</span>
<a name="c0-3671"></a><span class="lineno">3671</span>    <span class="p">}</span>
<a name="c0-3672"></a><span class="lineno">3672</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c0-3673"></a><span class="lineno">3673</span>      <span class="n">prefix_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">new_name</span><span class="p">);</span>
<a name="c0-3674"></a><span class="lineno">3674</span>      <span class="n">prefix_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">old_name</span><span class="p">);</span>
<a name="c0-3675"></a><span class="lineno">3675</span>    <span class="p">}</span>
<a name="c0-3676"></a><span class="lineno">3676</span>  <span class="p">}</span>
<a name="c0-3677"></a><span class="lineno">3677</span> <span class="p">}</span>
<a name="c0-3678"></a><span class="lineno">3678</span> 
<a name="c0-3679"></a><span class="lineno">3679</span> <span class="cp">#define INACCURATE_EOF  (1&lt;&lt;0)</span>
<a name="c0-3680"></a><span class="lineno">3680</span> <span class="cp">#define RECOUNT   (1&lt;&lt;1)</span>
<a name="c0-3681"></a><span class="lineno">3681</span> 
<a name="c0-3682"></a><span class="lineno">3682</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">apply_patch</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">)</span>
<a name="c0-3683"></a><span class="lineno">3683</span> <span class="p">{</span>
<a name="c0-3684"></a><span class="lineno">3684</span>  <span class="kt">size_t</span> <span class="n">offset</span><span class="p">;</span>
<a name="c0-3685"></a><span class="lineno">3685</span>  <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="c0-3686"></a><span class="lineno">3686</span>  <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">**</span><span class="n">listp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">;</span>
<a name="c0-3687"></a><span class="lineno">3687</span>  <span class="kt">int</span> <span class="n">skipped_patch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3688"></a><span class="lineno">3688</span> 
<a name="c0-3689"></a><span class="lineno">3689</span>  <span class="cm">/* FIXME - memory leak when using multiple patch files as inputs */</span>
<a name="c0-3690"></a><span class="lineno">3690</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">string_list</span><span class="p">));</span>
<a name="c0-3691"></a><span class="lineno">3691</span>  <span class="n">patch_input_file</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
<a name="c0-3692"></a><span class="lineno">3692</span>  <span class="n">read_patch_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
<a name="c0-3693"></a><span class="lineno">3693</span>  <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3694"></a><span class="lineno">3694</span>  <span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3695"></a><span class="lineno">3695</span>    <span class="k">struct</span> <span class="n">patch</span> <span class="o">*</span><span class="n">patch</span><span class="p">;</span>
<a name="c0-3696"></a><span class="lineno">3696</span>    <span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>
<a name="c0-3697"></a><span class="lineno">3697</span> 
<a name="c0-3698"></a><span class="lineno">3698</span>    <span class="n">patch</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">patch</span><span class="p">));</span>
<a name="c0-3699"></a><span class="lineno">3699</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">inaccurate_eof</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">INACCURATE_EOF</span><span class="p">);</span>
<a name="c0-3700"></a><span class="lineno">3700</span>    <span class="n">patch</span><span class="o">-&gt;</span><span class="n">recount</span> <span class="o">=</span>  <span class="o">!!</span><span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">RECOUNT</span><span class="p">);</span>
<a name="c0-3701"></a><span class="lineno">3701</span>    <span class="n">nr</span> <span class="o">=</span> <span class="n">parse_chunk</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">patch</span><span class="p">);</span>
<a name="c0-3702"></a><span class="lineno">3702</span>    <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3703"></a><span class="lineno">3703</span>      <span class="k">break</span><span class="p">;</span>
<a name="c0-3704"></a><span class="lineno">3704</span>    <span class="k">if</span> <span class="p">(</span><span class="n">apply_in_reverse</span><span class="p">)</span>
<a name="c0-3705"></a><span class="lineno">3705</span>      <span class="n">reverse_patches</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3706"></a><span class="lineno">3706</span>    <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
<a name="c0-3707"></a><span class="lineno">3707</span>      <span class="n">prefix_patches</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3708"></a><span class="lineno">3708</span>    <span class="k">if</span> <span class="p">(</span><span class="n">use_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3709"></a><span class="lineno">3709</span>      <span class="n">patch_stats</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3710"></a><span class="lineno">3710</span>      <span class="o">*</span><span class="n">listp</span> <span class="o">=</span> <span class="n">patch</span><span class="p">;</span>
<a name="c0-3711"></a><span class="lineno">3711</span>      <span class="n">listp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">patch</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-3712"></a><span class="lineno">3712</span>    <span class="p">}</span>
<a name="c0-3713"></a><span class="lineno">3713</span>    <span class="k">else</span> <span class="p">{</span>
<a name="c0-3714"></a><span class="lineno">3714</span>      <span class="cm">/* perhaps free it a bit better? */</span>
<a name="c0-3715"></a><span class="lineno">3715</span>      <span class="n">free</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
<a name="c0-3716"></a><span class="lineno">3716</span>      <span class="n">skipped_patch</span><span class="o">++</span><span class="p">;</span>
<a name="c0-3717"></a><span class="lineno">3717</span>    <span class="p">}</span>
<a name="c0-3718"></a><span class="lineno">3718</span>    <span class="n">offset</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>
<a name="c0-3719"></a><span class="lineno">3719</span>  <span class="p">}</span>
<a name="c0-3720"></a><span class="lineno">3720</span> 
<a name="c0-3721"></a><span class="lineno">3721</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skipped_patch</span><span class="p">)</span>
<a name="c0-3722"></a><span class="lineno">3722</span>    <span class="n">die</span><span class="p">(</span><span class="s">"unrecognized input"</span><span class="p">);</span>
<a name="c0-3723"></a><span class="lineno">3723</span> 
<a name="c0-3724"></a><span class="lineno">3724</span>  <span class="k">if</span> <span class="p">(</span><span class="n">whitespace_error</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ws_error_action</span> <span class="o">==</span> <span class="n">die_on_ws_error</span><span class="p">))</span>
<a name="c0-3725"></a><span class="lineno">3725</span>    <span class="n">apply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3726"></a><span class="lineno">3726</span> 
<a name="c0-3727"></a><span class="lineno">3727</span>  <span class="n">update_index</span> <span class="o">=</span> <span class="n">check_index</span> <span class="o">&amp;&amp;</span> <span class="n">apply</span><span class="p">;</span>
<a name="c0-3728"></a><span class="lineno">3728</span>  <span class="k">if</span> <span class="p">(</span><span class="n">update_index</span> <span class="o">&amp;&amp;</span> <span class="n">newfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3729"></a><span class="lineno">3729</span>    <span class="n">newfd</span> <span class="o">=</span> <span class="n">hold_locked_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_file</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-3730"></a><span class="lineno">3730</span> 
<a name="c0-3731"></a><span class="lineno">3731</span>  <span class="k">if</span> <span class="p">(</span><span class="n">check_index</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3732"></a><span class="lineno">3732</span>    <span class="k">if</span> <span class="p">(</span><span class="n">read_cache</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3733"></a><span class="lineno">3733</span>      <span class="n">die</span><span class="p">(</span><span class="s">"unable to read index file"</span><span class="p">);</span>
<a name="c0-3734"></a><span class="lineno">3734</span>  <span class="p">}</span>
<a name="c0-3735"></a><span class="lineno">3735</span> 
<a name="c0-3736"></a><span class="lineno">3736</span>  <span class="k">if</span> <span class="p">((</span><span class="n">check</span> <span class="o">||</span> <span class="n">apply</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="c0-3737"></a><span class="lineno">3737</span>      <span class="n">check_patch_list</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<a name="c0-3738"></a><span class="lineno">3738</span>      <span class="o">!</span><span class="n">apply_with_reject</span><span class="p">)</span>
<a name="c0-3739"></a><span class="lineno">3739</span>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-3740"></a><span class="lineno">3740</span> 
<a name="c0-3741"></a><span class="lineno">3741</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply</span> <span class="o">&amp;&amp;</span> <span class="n">write_out_results</span><span class="p">(</span><span class="n">list</span><span class="p">))</span>
<a name="c0-3742"></a><span class="lineno">3742</span>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a name="c0-3743"></a><span class="lineno">3743</span> 
<a name="c0-3744"></a><span class="lineno">3744</span>  <span class="k">if</span> <span class="p">(</span><span class="n">fake_ancestor</span><span class="p">)</span>
<a name="c0-3745"></a><span class="lineno">3745</span>    <span class="n">build_fake_ancestor</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">fake_ancestor</span><span class="p">);</span>
<a name="c0-3746"></a><span class="lineno">3746</span> 
<a name="c0-3747"></a><span class="lineno">3747</span>  <span class="k">if</span> <span class="p">(</span><span class="n">diffstat</span><span class="p">)</span>
<a name="c0-3748"></a><span class="lineno">3748</span>    <span class="n">stat_patch_list</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c0-3749"></a><span class="lineno">3749</span> 
<a name="c0-3750"></a><span class="lineno">3750</span>  <span class="k">if</span> <span class="p">(</span><span class="n">numstat</span><span class="p">)</span>
<a name="c0-3751"></a><span class="lineno">3751</span>    <span class="n">numstat_patch_list</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c0-3752"></a><span class="lineno">3752</span> 
<a name="c0-3753"></a><span class="lineno">3753</span>  <span class="k">if</span> <span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<a name="c0-3754"></a><span class="lineno">3754</span>    <span class="n">summary_patch_list</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c0-3755"></a><span class="lineno">3755</span> 
<a name="c0-3756"></a><span class="lineno">3756</span>  <span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<a name="c0-3757"></a><span class="lineno">3757</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3758"></a><span class="lineno">3758</span> <span class="p">}</span>
<a name="c0-3759"></a><span class="lineno">3759</span> 
<a name="c0-3760"></a><span class="lineno">3760</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">git_apply_config</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<a name="c0-3761"></a><span class="lineno">3761</span> <span class="p">{</span>
<a name="c0-3762"></a><span class="lineno">3762</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"apply.whitespace"</span><span class="p">))</span>
<a name="c0-3763"></a><span class="lineno">3763</span>    <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apply_default_whitespace</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c0-3764"></a><span class="lineno">3764</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">"apply.ignorewhitespace"</span><span class="p">))</span>
<a name="c0-3765"></a><span class="lineno">3765</span>    <span class="k">return</span> <span class="n">git_config_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apply_default_ignorewhitespace</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<a name="c0-3766"></a><span class="lineno">3766</span>  <span class="k">return</span> <span class="n">git_default_config</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<a name="c0-3767"></a><span class="lineno">3767</span> <span class="p">}</span>
<a name="c0-3768"></a><span class="lineno">3768</span> 
<a name="c0-3769"></a><span class="lineno">3769</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_exclude</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3770"></a><span class="lineno">3770</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3771"></a><span class="lineno">3771</span> <span class="p">{</span>
<a name="c0-3772"></a><span class="lineno">3772</span>  <span class="n">add_name_limit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-3773"></a><span class="lineno">3773</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3774"></a><span class="lineno">3774</span> <span class="p">}</span>
<a name="c0-3775"></a><span class="lineno">3775</span> 
<a name="c0-3776"></a><span class="lineno">3776</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_include</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3777"></a><span class="lineno">3777</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3778"></a><span class="lineno">3778</span> <span class="p">{</span>
<a name="c0-3779"></a><span class="lineno">3779</span>  <span class="n">add_name_limit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3780"></a><span class="lineno">3780</span>  <span class="n">has_include</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3781"></a><span class="lineno">3781</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3782"></a><span class="lineno">3782</span> <span class="p">}</span>
<a name="c0-3783"></a><span class="lineno">3783</span> 
<a name="c0-3784"></a><span class="lineno">3784</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_p</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3785"></a><span class="lineno">3785</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3786"></a><span class="lineno">3786</span> <span class="p">{</span>
<a name="c0-3787"></a><span class="lineno">3787</span>  <span class="n">p_value</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<a name="c0-3788"></a><span class="lineno">3788</span>  <span class="n">p_value_known</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3789"></a><span class="lineno">3789</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3790"></a><span class="lineno">3790</span> <span class="p">}</span>
<a name="c0-3791"></a><span class="lineno">3791</span> 
<a name="c0-3792"></a><span class="lineno">3792</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_z</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3793"></a><span class="lineno">3793</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3794"></a><span class="lineno">3794</span> <span class="p">{</span>
<a name="c0-3795"></a><span class="lineno">3795</span>  <span class="k">if</span> <span class="p">(</span><span class="n">unset</span><span class="p">)</span>
<a name="c0-3796"></a><span class="lineno">3796</span>    <span class="n">line_termination</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="c0-3797"></a><span class="lineno">3797</span>  <span class="k">else</span>
<a name="c0-3798"></a><span class="lineno">3798</span>    <span class="n">line_termination</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3799"></a><span class="lineno">3799</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3800"></a><span class="lineno">3800</span> <span class="p">}</span>
<a name="c0-3801"></a><span class="lineno">3801</span> 
<a name="c0-3802"></a><span class="lineno">3802</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_space_change</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3803"></a><span class="lineno">3803</span>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3804"></a><span class="lineno">3804</span> <span class="p">{</span>
<a name="c0-3805"></a><span class="lineno">3805</span>  <span class="k">if</span> <span class="p">(</span><span class="n">unset</span><span class="p">)</span>
<a name="c0-3806"></a><span class="lineno">3806</span>    <span class="n">ws_ignore_action</span> <span class="o">=</span> <span class="n">ignore_ws_none</span><span class="p">;</span>
<a name="c0-3807"></a><span class="lineno">3807</span>  <span class="k">else</span>
<a name="c0-3808"></a><span class="lineno">3808</span>    <span class="n">ws_ignore_action</span> <span class="o">=</span> <span class="n">ignore_ws_change</span><span class="p">;</span>
<a name="c0-3809"></a><span class="lineno">3809</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3810"></a><span class="lineno">3810</span> <span class="p">}</span>
<a name="c0-3811"></a><span class="lineno">3811</span> 
<a name="c0-3812"></a><span class="lineno">3812</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_whitespace</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3813"></a><span class="lineno">3813</span>           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3814"></a><span class="lineno">3814</span> <span class="p">{</span>
<a name="c0-3815"></a><span class="lineno">3815</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">whitespace_option</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
<a name="c0-3816"></a><span class="lineno">3816</span> 
<a name="c0-3817"></a><span class="lineno">3817</span>  <span class="o">*</span><span class="n">whitespace_option</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
<a name="c0-3818"></a><span class="lineno">3818</span>  <span class="n">parse_whitespace_option</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<a name="c0-3819"></a><span class="lineno">3819</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3820"></a><span class="lineno">3820</span> <span class="p">}</span>
<a name="c0-3821"></a><span class="lineno">3821</span> 
<a name="c0-3822"></a><span class="lineno">3822</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">option_parse_directory</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span>
<a name="c0-3823"></a><span class="lineno">3823</span>          <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unset</span><span class="p">)</span>
<a name="c0-3824"></a><span class="lineno">3824</span> <span class="p">{</span>
<a name="c0-3825"></a><span class="lineno">3825</span>  <span class="n">root_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<a name="c0-3826"></a><span class="lineno">3826</span>  <span class="k">if</span> <span class="p">(</span><span class="n">root_len</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="p">[</span><span class="n">root_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3827"></a><span class="lineno">3827</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">new_root</span><span class="p">;</span>
<a name="c0-3828"></a><span class="lineno">3828</span>    <span class="n">root</span> <span class="o">=</span> <span class="n">new_root</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">root_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<a name="c0-3829"></a><span class="lineno">3829</span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">new_root</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-3830"></a><span class="lineno">3830</span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">new_root</span> <span class="o">+</span> <span class="n">root_len</span><span class="o">++</span><span class="p">,</span> <span class="s">"/"</span><span class="p">);</span>
<a name="c0-3831"></a><span class="lineno">3831</span>  <span class="p">}</span> <span class="k">else</span>
<a name="c0-3832"></a><span class="lineno">3832</span>    <span class="n">root</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
<a name="c0-3833"></a><span class="lineno">3833</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3834"></a><span class="lineno">3834</span> <span class="p">}</span>
<a name="c0-3835"></a><span class="lineno">3835</span> 
<a name="c0-3836"></a><span class="lineno">3836</span> <span class="kt">int</span> <span class="nf">cmd_apply</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix_</span><span class="p">)</span>
<a name="c0-3837"></a><span class="lineno">3837</span> <span class="p">{</span>
<a name="c0-3838"></a><span class="lineno">3838</span>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<a name="c0-3839"></a><span class="lineno">3839</span>  <span class="kt">int</span> <span class="n">errs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3840"></a><span class="lineno">3840</span>  <span class="kt">int</span> <span class="n">is_not_gitdir</span> <span class="o">=</span> <span class="o">!</span><span class="n">startup_info</span><span class="o">-&gt;</span><span class="n">have_repository</span><span class="p">;</span>
<a name="c0-3841"></a><span class="lineno">3841</span>  <span class="kt">int</span> <span class="n">force_apply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3842"></a><span class="lineno">3842</span> 
<a name="c0-3843"></a><span class="lineno">3843</span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">whitespace_option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-3844"></a><span class="lineno">3844</span> 
<a name="c0-3845"></a><span class="lineno">3845</span>  <span class="k">struct</span> <span class="n">option</span> <span class="n">builtin_apply_options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c0-3846"></a><span class="lineno">3846</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"exclude"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"path"</span><span class="p">,</span>
<a name="c0-3847"></a><span class="lineno">3847</span>      <span class="s">"don't apply changes matching the given path"</span><span class="p">,</span>
<a name="c0-3848"></a><span class="lineno">3848</span>      <span class="mi">0</span><span class="p">,</span> <span class="n">option_parse_exclude</span> <span class="p">},</span>
<a name="c0-3849"></a><span class="lineno">3849</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"include"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"path"</span><span class="p">,</span>
<a name="c0-3850"></a><span class="lineno">3850</span>      <span class="s">"apply changes matching the given path"</span><span class="p">,</span>
<a name="c0-3851"></a><span class="lineno">3851</span>      <span class="mi">0</span><span class="p">,</span> <span class="n">option_parse_include</span> <span class="p">},</span>
<a name="c0-3852"></a><span class="lineno">3852</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"num"</span><span class="p">,</span>
<a name="c0-3853"></a><span class="lineno">3853</span>      <span class="s">"remove &lt;num&gt; leading slashes from traditional diff paths"</span><span class="p">,</span>
<a name="c0-3854"></a><span class="lineno">3854</span>      <span class="mi">0</span><span class="p">,</span> <span class="n">option_parse_p</span> <span class="p">},</span>
<a name="c0-3855"></a><span class="lineno">3855</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"no-add"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_add</span><span class="p">,</span>
<a name="c0-3856"></a><span class="lineno">3856</span>      <span class="s">"ignore additions made by the patch"</span><span class="p">),</span>
<a name="c0-3857"></a><span class="lineno">3857</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"stat"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diffstat</span><span class="p">,</span>
<a name="c0-3858"></a><span class="lineno">3858</span>      <span class="s">"instead of applying the patch, output diffstat for the input"</span><span class="p">),</span>
<a name="c0-3859"></a><span class="lineno">3859</span>    <span class="n">OPT_NOOP_NOARG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"allow-binary-replacement"</span><span class="p">),</span>
<a name="c0-3860"></a><span class="lineno">3860</span> <span class="hll">   <span class="n">OPT_NOOP_NOARG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"binary"</span><span class="p">),</span>
</span><a name="c0-3861"></a><span class="lineno">3861</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"numstat"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numstat</span><span class="p">,</span>
</span><a name="c0-3862"></a><span class="lineno">3862</span> <span class="hll">      <span class="s">"shows number of added and deleted lines in decimal notation"</span><span class="p">),</span>
</span><a name="c0-3863"></a><span class="lineno">3863</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"summary"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">summary</span><span class="p">,</span>
</span><a name="c0-3864"></a><span class="lineno">3864</span> <span class="hll">      <span class="s">"instead of applying the patch, output a summary for the input"</span><span class="p">),</span>
</span><a name="c0-3865"></a><span class="lineno">3865</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"check"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">check</span><span class="p">,</span>
</span><a name="c0-3866"></a><span class="lineno">3866</span> <span class="hll">      <span class="s">"instead of applying the patch, see if the patch is applicable"</span><span class="p">),</span>
</span><a name="c0-3867"></a><span class="lineno">3867</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"index"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">check_index</span><span class="p">,</span>
</span><a name="c0-3868"></a><span class="lineno">3868</span> <span class="hll">      <span class="s">"make sure the patch is applicable to the current index"</span><span class="p">),</span>
</span><a name="c0-3869"></a><span class="lineno">3869</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"cached"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cached</span><span class="p">,</span>
</span><a name="c0-3870"></a><span class="lineno">3870</span>       <span class="s">"apply a patch without touching the working tree"</span><span class="p">),</span>
<a name="c0-3871"></a><span class="lineno">3871</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"apply"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">force_apply</span><span class="p">,</span>
<a name="c0-3872"></a><span class="lineno">3872</span>      <span class="s">"also apply the patch (use with --stat/--summary/--check)"</span><span class="p">),</span>
<a name="c0-3873"></a><span class="lineno">3873</span>    <span class="n">OPT_FILENAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"build-fake-ancestor"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_ancestor</span><span class="p">,</span>
<a name="c0-3874"></a><span class="lineno">3874</span>      <span class="s">"build a temporary index based on embedded index information"</span><span class="p">),</span>
<a name="c0-3875"></a><span class="lineno">3875</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="sc">'z'</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
<a name="c0-3876"></a><span class="lineno">3876</span>      <span class="s">"paths are separated with NUL character"</span><span class="p">,</span>
<a name="c0-3877"></a><span class="lineno">3877</span>      <span class="n">PARSE_OPT_NOARG</span><span class="p">,</span> <span class="n">option_parse_z</span> <span class="p">},</span>
<a name="c0-3878"></a><span class="lineno">3878</span>    <span class="n">OPT_INTEGER</span><span class="p">(</span><span class="sc">'C'</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_context</span><span class="p">,</span>
<a name="c0-3879"></a><span class="lineno">3879</span>        <span class="s">"ensure at least &lt;n&gt; lines of context match"</span><span class="p">),</span>
<a name="c0-3880"></a><span class="lineno">3880</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"whitespace"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">whitespace_option</span><span class="p">,</span> <span class="s">"action"</span><span class="p">,</span>
<a name="c0-3881"></a><span class="lineno">3881</span>      <span class="s">"detect new or modified lines that have whitespace errors"</span><span class="p">,</span>
<a name="c0-3882"></a><span class="lineno">3882</span>      <span class="mi">0</span><span class="p">,</span> <span class="n">option_parse_whitespace</span> <span class="p">},</span>
<a name="c0-3883"></a><span class="lineno">3883</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"ignore-space-change"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
<a name="c0-3884"></a><span class="lineno">3884</span>      <span class="s">"ignore changes in whitespace when finding context"</span><span class="p">,</span>
<a name="c0-3885"></a><span class="lineno">3885</span>      <span class="n">PARSE_OPT_NOARG</span><span class="p">,</span> <span class="n">option_parse_space_change</span> <span class="p">},</span>
<a name="c0-3886"></a><span class="lineno">3886</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"ignore-whitespace"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
<a name="c0-3887"></a><span class="lineno">3887</span>      <span class="s">"ignore changes in whitespace when finding context"</span><span class="p">,</span>
<a name="c0-3888"></a><span class="lineno">3888</span>      <span class="n">PARSE_OPT_NOARG</span><span class="p">,</span> <span class="n">option_parse_space_change</span> <span class="p">},</span>
<a name="c0-3889"></a><span class="lineno">3889</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="sc">'R'</span><span class="p">,</span> <span class="s">"reverse"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apply_in_reverse</span><span class="p">,</span>
<a name="c0-3890"></a><span class="lineno">3890</span>      <span class="s">"apply the patch in reverse"</span><span class="p">),</span>
<a name="c0-3891"></a><span class="lineno">3891</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"unidiff-zero"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unidiff_zero</span><span class="p">,</span>
<a name="c0-3892"></a><span class="lineno">3892</span>      <span class="s">"don't expect at least one line of context"</span><span class="p">),</span>
<a name="c0-3893"></a><span class="lineno">3893</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"reject"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apply_with_reject</span><span class="p">,</span>
<a name="c0-3894"></a><span class="lineno">3894</span>      <span class="s">"leave the rejected hunks in corresponding *.rej files"</span><span class="p">),</span>
<a name="c0-3895"></a><span class="lineno">3895</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"allow-overlap"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">allow_overlap</span><span class="p">,</span>
<a name="c0-3896"></a><span class="lineno">3896</span>      <span class="s">"allow overlapping hunks"</span><span class="p">),</span>
<a name="c0-3897"></a><span class="lineno">3897</span>    <span class="n">OPT__VERBOSE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apply_verbosely</span><span class="p">,</span> <span class="s">"be verbose"</span><span class="p">),</span>
<a name="c0-3898"></a><span class="lineno">3898</span>    <span class="n">OPT_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"inaccurate-eof"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">,</span>
<a name="c0-3899"></a><span class="lineno">3899</span>      <span class="s">"tolerate incorrectly detected missing new-line at the end of file"</span><span class="p">,</span>
<a name="c0-3900"></a><span class="lineno">3900</span>      <span class="n">INACCURATE_EOF</span><span class="p">),</span>
<a name="c0-3901"></a><span class="lineno">3901</span>    <span class="n">OPT_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"recount"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">,</span>
<a name="c0-3902"></a><span class="lineno">3902</span>      <span class="s">"do not trust the line counts in the hunk headers"</span><span class="p">,</span>
<a name="c0-3903"></a><span class="lineno">3903</span>      <span class="n">RECOUNT</span><span class="p">),</span>
<a name="c0-3904"></a><span class="lineno">3904</span>    <span class="p">{</span> <span class="n">OPTION_CALLBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"directory"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span>
<a name="c0-3905"></a><span class="lineno">3905</span>      <span class="s">"prepend &lt;root&gt; to all filenames"</span><span class="p">,</span>
<a name="c0-3906"></a><span class="lineno">3906</span>      <span class="mi">0</span><span class="p">,</span> <span class="n">option_parse_directory</span> <span class="p">},</span>
<a name="c0-3907"></a><span class="lineno">3907</span>    <span class="n">OPT_END</span><span class="p">()</span>
<a name="c0-3908"></a><span class="lineno">3908</span>  <span class="p">};</span>
<a name="c0-3909"></a><span class="lineno">3909</span> 
<a name="c0-3910"></a><span class="lineno">3910</span>  <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_</span><span class="p">;</span>
<a name="c0-3911"></a><span class="lineno">3911</span>  <span class="n">prefix_length</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3912"></a><span class="lineno">3912</span>  <span class="n">git_config</span><span class="p">(</span><span class="n">git_apply_config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c0-3913"></a><span class="lineno">3913</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply_default_whitespace</span><span class="p">)</span>
<a name="c0-3914"></a><span class="lineno">3914</span>    <span class="n">parse_whitespace_option</span><span class="p">(</span><span class="n">apply_default_whitespace</span><span class="p">);</span>
<a name="c0-3915"></a><span class="lineno">3915</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply_default_ignorewhitespace</span><span class="p">)</span>
<a name="c0-3916"></a><span class="lineno">3916</span>    <span class="n">parse_ignorewhitespace_option</span><span class="p">(</span><span class="n">apply_default_ignorewhitespace</span><span class="p">);</span>
<a name="c0-3917"></a><span class="lineno">3917</span> 
<a name="c0-3918"></a><span class="lineno">3918</span>  <span class="n">argc</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">builtin_apply_options</span><span class="p">,</span>
<a name="c0-3919"></a><span class="lineno">3919</span>      <span class="n">apply_usage</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c0-3920"></a><span class="lineno">3920</span> 
<a name="c0-3921"></a><span class="lineno">3921</span>  <span class="k">if</span> <span class="p">(</span><span class="n">apply_with_reject</span><span class="p">)</span>
<a name="c0-3922"></a><span class="lineno">3922</span>    <span class="n">apply</span> <span class="o">=</span> <span class="n">apply_verbosely</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3923"></a><span class="lineno">3923</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_apply</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diffstat</span> <span class="o">||</span> <span class="n">numstat</span> <span class="o">||</span> <span class="n">summary</span> <span class="o">||</span> <span class="n">check</span> <span class="o">||</span> <span class="n">fake_ancestor</span><span class="p">))</span>
<a name="c0-3924"></a><span class="lineno">3924</span>    <span class="n">apply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3925"></a><span class="lineno">3925</span>  <span class="k">if</span> <span class="p">(</span><span class="n">check_index</span> <span class="o">&amp;&amp;</span> <span class="n">is_not_gitdir</span><span class="p">)</span>
<a name="c0-3926"></a><span class="lineno">3926</span>    <span class="n">die</span><span class="p">(</span><span class="s">"--index outside a repository"</span><span class="p">);</span>
<a name="c0-3927"></a><span class="lineno">3927</span>  <span class="k">if</span> <span class="p">(</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3928"></a><span class="lineno">3928</span>    <span class="k">if</span> <span class="p">(</span><span class="n">is_not_gitdir</span><span class="p">)</span>
<a name="c0-3929"></a><span class="lineno">3929</span>      <span class="n">die</span><span class="p">(</span><span class="s">"--cached outside a repository"</span><span class="p">);</span>
<a name="c0-3930"></a><span class="lineno">3930</span>    <span class="n">check_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-3931"></a><span class="lineno">3931</span>  <span class="p">}</span>
<a name="c0-3932"></a><span class="lineno">3932</span>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3933"></a><span class="lineno">3933</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c0-3934"></a><span class="lineno">3934</span>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c0-3935"></a><span class="lineno">3935</span> 
<a name="c0-3936"></a><span class="lineno">3936</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">"-"</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-3937"></a><span class="lineno">3937</span>      <span class="n">errs</span> <span class="o">|=</span> <span class="n">apply_patch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
<a name="c0-3938"></a><span class="lineno">3938</span>      <span class="n">read_stdin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3939"></a><span class="lineno">3939</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-3940"></a><span class="lineno">3940</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">prefix_length</span><span class="p">)</span>
<a name="c0-3941"></a><span class="lineno">3941</span>      <span class="n">arg</span> <span class="o">=</span> <span class="n">prefix_filename</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">prefix_length</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-3942"></a><span class="lineno">3942</span> 
<a name="c0-3943"></a><span class="lineno">3943</span>    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<a name="c0-3944"></a><span class="lineno">3944</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-3945"></a><span class="lineno">3945</span>      <span class="n">die_errno</span><span class="p">(</span><span class="s">"can't open patch '%s'"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<a name="c0-3946"></a><span class="lineno">3946</span>    <span class="n">read_stdin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-3947"></a><span class="lineno">3947</span>    <span class="n">set_default_whitespace_mode</span><span class="p">(</span><span class="n">whitespace_option</span><span class="p">);</span>
<a name="c0-3948"></a><span class="lineno">3948</span>    <span class="n">errs</span> <span class="o">|=</span> <span class="n">apply_patch</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
<a name="c0-3949"></a><span class="lineno">3949</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a name="c0-3950"></a><span class="lineno">3950</span>  <span class="p">}</span>
<a name="c0-3951"></a><span class="lineno">3951</span>  <span class="n">set_default_whitespace_mode</span><span class="p">(</span><span class="n">whitespace_option</span><span class="p">);</span>
<a name="c0-3952"></a><span class="lineno">3952</span>  <span class="k">if</span> <span class="p">(</span><span class="n">read_stdin</span><span class="p">)</span>
<a name="c0-3953"></a><span class="lineno">3953</span>    <span class="n">errs</span> <span class="o">|=</span> <span class="n">apply_patch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
<a name="c0-3954"></a><span class="lineno">3954</span>  <span class="k">if</span> <span class="p">(</span><span class="n">whitespace_error</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3955"></a><span class="lineno">3955</span>    <span class="k">if</span> <span class="p">(</span><span class="n">squelch_whitespace_errors</span> <span class="o">&amp;&amp;</span>
<a name="c0-3956"></a><span class="lineno">3956</span>        <span class="n">squelch_whitespace_errors</span> <span class="o">&lt;</span> <span class="n">whitespace_error</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3957"></a><span class="lineno">3957</span>      <span class="kt">int</span> <span class="n">squelched</span> <span class="o">=</span>
<a name="c0-3958"></a><span class="lineno">3958</span>        <span class="n">whitespace_error</span> <span class="o">-</span> <span class="n">squelch_whitespace_errors</span><span class="p">;</span>
<a name="c0-3959"></a><span class="lineno">3959</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"squelched %d "</span>
<a name="c0-3960"></a><span class="lineno">3960</span>        <span class="s">"whitespace error%s"</span><span class="p">,</span>
<a name="c0-3961"></a><span class="lineno">3961</span>        <span class="n">squelched</span><span class="p">,</span>
<a name="c0-3962"></a><span class="lineno">3962</span>        <span class="n">squelched</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">"s"</span><span class="p">);</span>
<a name="c0-3963"></a><span class="lineno">3963</span>    <span class="p">}</span>
<a name="c0-3964"></a><span class="lineno">3964</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ws_error_action</span> <span class="o">==</span> <span class="n">die_on_ws_error</span><span class="p">)</span>
<a name="c0-3965"></a><span class="lineno">3965</span>      <span class="n">die</span><span class="p">(</span><span class="s">"%d line%s add%s whitespace errors."</span><span class="p">,</span>
<a name="c0-3966"></a><span class="lineno">3966</span>          <span class="n">whitespace_error</span><span class="p">,</span>
<a name="c0-3967"></a><span class="lineno">3967</span>          <span class="n">whitespace_error</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">"s"</span><span class="p">,</span>
<a name="c0-3968"></a><span class="lineno">3968</span>          <span class="n">whitespace_error</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">"s"</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
<a name="c0-3969"></a><span class="lineno">3969</span>    <span class="k">if</span> <span class="p">(</span><span class="n">applied_after_fixing_ws</span> <span class="o">&amp;&amp;</span> <span class="n">apply</span><span class="p">)</span>
<a name="c0-3970"></a><span class="lineno">3970</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"%d line%s applied after"</span>
<a name="c0-3971"></a><span class="lineno">3971</span>        <span class="s">" fixing whitespace errors."</span><span class="p">,</span>
<a name="c0-3972"></a><span class="lineno">3972</span>        <span class="n">applied_after_fixing_ws</span><span class="p">,</span>
<a name="c0-3973"></a><span class="lineno">3973</span>        <span class="n">applied_after_fixing_ws</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">"s"</span><span class="p">);</span>
<a name="c0-3974"></a><span class="lineno">3974</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">whitespace_error</span><span class="p">)</span>
<a name="c0-3975"></a><span class="lineno">3975</span>      <span class="n">warning</span><span class="p">(</span><span class="s">"%d line%s add%s whitespace errors."</span><span class="p">,</span>
<a name="c0-3976"></a><span class="lineno">3976</span>        <span class="n">whitespace_error</span><span class="p">,</span>
<a name="c0-3977"></a><span class="lineno">3977</span>        <span class="n">whitespace_error</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">"s"</span><span class="p">,</span>
<a name="c0-3978"></a><span class="lineno">3978</span>        <span class="n">whitespace_error</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">"s"</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
<a name="c0-3979"></a><span class="lineno">3979</span>  <span class="p">}</span>
<a name="c0-3980"></a><span class="lineno">3980</span> 
<a name="c0-3981"></a><span class="lineno">3981</span>  <span class="k">if</span> <span class="p">(</span><span class="n">update_index</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-3982"></a><span class="lineno">3982</span>    <span class="k">if</span> <span class="p">(</span><span class="n">write_cache</span><span class="p">(</span><span class="n">newfd</span><span class="p">,</span> <span class="n">active_cache</span><span class="p">,</span> <span class="n">active_nr</span><span class="p">)</span> <span class="o">||</span>
<a name="c0-3983"></a><span class="lineno">3983</span>        <span class="n">commit_locked_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock_file</span><span class="p">))</span>
<a name="c0-3984"></a><span class="lineno">3984</span>      <span class="n">die</span><span class="p">(</span><span class="s">"Unable to write new index file"</span><span class="p">);</span>
<a name="c0-3985"></a><span class="lineno">3985</span>  <span class="p">}</span>
<a name="c0-3986"></a><span class="lineno">3986</span> 
<a name="c0-3987"></a><span class="lineno">3987</span>  <span class="k">return</span> <span class="o">!!</span><span class="n">errs</span><span class="p">;</span>
<a name="c0-3988"></a><span class="lineno">3988</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> builtin/describe.c 
                <small> (403,43)-(408,15)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">  1</span> <span class="cp">#include "cache.h"</span>
<a name="c1-2"></a><span class="lineno">  2</span> <span class="cp">#include "commit.h"</span>
<a name="c1-3"></a><span class="lineno">  3</span> <span class="cp">#include "tag.h"</span>
<a name="c1-4"></a><span class="lineno">  4</span> <span class="cp">#include "refs.h"</span>
<a name="c1-5"></a><span class="lineno">  5</span> <span class="cp">#include "builtin.h"</span>
<a name="c1-6"></a><span class="lineno">  6</span> <span class="cp">#include "exec_cmd.h"</span>
<a name="c1-7"></a><span class="lineno">  7</span> <span class="cp">#include "parse-options.h"</span>
<a name="c1-8"></a><span class="lineno">  8</span> <span class="cp">#include "diff.h"</span>
<a name="c1-9"></a><span class="lineno">  9</span> <span class="cp">#include "hash.h"</span>
<a name="c1-10"></a><span class="lineno"> 10</span> 
<a name="c1-11"></a><span class="lineno"> 11</span> <span class="cp">#define SEEN   (1u&lt;&lt;0)</span>
<a name="c1-12"></a><span class="lineno"> 12</span> <span class="cp">#define MAX_TAGS (FLAG_BITS - 1)</span>
<a name="c1-13"></a><span class="lineno"> 13</span> 
<a name="c1-14"></a><span class="lineno"> 14</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">describe_usage</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-15"></a><span class="lineno"> 15</span>   <span class="s">"git describe [options] &lt;committish&gt;*"</span><span class="p">,</span>
<a name="c1-16"></a><span class="lineno"> 16</span>   <span class="s">"git describe [options] --dirty"</span><span class="p">,</span>
<a name="c1-17"></a><span class="lineno"> 17</span>   <span class="nb">NULL</span>
<a name="c1-18"></a><span class="lineno"> 18</span> <span class="p">};</span>
<a name="c1-19"></a><span class="lineno"> 19</span> 
<a name="c1-20"></a><span class="lineno"> 20</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>  <span class="cm">/* Display lots of verbose info */</span>
<a name="c1-21"></a><span class="lineno"> 21</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">all</span><span class="p">;</span>  <span class="cm">/* Any valid ref can be used */</span>
<a name="c1-22"></a><span class="lineno"> 22</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">tags</span><span class="p">;</span> <span class="cm">/* Allow lightweight tags */</span>
<a name="c1-23"></a><span class="lineno"> 23</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">longformat</span><span class="p">;</span>
<a name="c1-24"></a><span class="lineno"> 24</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">abbrev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* unspecified */</span>
<a name="c1-25"></a><span class="lineno"> 25</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">max_candidates</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<a name="c1-26"></a><span class="lineno"> 26</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">hash_table</span> <span class="n">names</span><span class="p">;</span>
<a name="c1-27"></a><span class="lineno"> 27</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">have_util</span><span class="p">;</span>
<a name="c1-28"></a><span class="lineno"> 28</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pattern</span><span class="p">;</span>
<a name="c1-29"></a><span class="lineno"> 29</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">always</span><span class="p">;</span>
<a name="c1-30"></a><span class="lineno"> 30</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dirty</span><span class="p">;</span>
<a name="c1-31"></a><span class="lineno"> 31</span> 
<a name="c1-32"></a><span class="lineno"> 32</span> <span class="cm">/* diff-index command arguments to check if working tree is dirty. */</span>
<a name="c1-33"></a><span class="lineno"> 33</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">diff_index_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-34"></a><span class="lineno"> 34</span>   <span class="s">"diff-index"</span><span class="p">,</span> <span class="s">"--quiet"</span><span class="p">,</span> <span class="s">"HEAD"</span><span class="p">,</span> <span class="s">"--"</span><span class="p">,</span> <span class="nb">NULL</span>
<a name="c1-35"></a><span class="lineno"> 35</span> <span class="p">};</span>
<a name="c1-36"></a><span class="lineno"> 36</span> 
<a name="c1-37"></a><span class="lineno"> 37</span> 
<a name="c1-38"></a><span class="lineno"> 38</span> <span class="k">struct</span> <span class="n">commit_name</span> <span class="p">{</span>
<a name="c1-39"></a><span class="lineno"> 39</span>   <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c1-40"></a><span class="lineno"> 40</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">peeled</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c1-41"></a><span class="lineno"> 41</span>   <span class="k">struct</span> <span class="n">tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
<a name="c1-42"></a><span class="lineno"> 42</span>   <span class="kt">unsigned</span> <span class="n">prio</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* annotated tag = 2, tag = 1, head = 0 */</span>
<a name="c1-43"></a><span class="lineno"> 43</span>   <span class="kt">unsigned</span> <span class="n">name_checked</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-44"></a><span class="lineno"> 44</span>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c1-45"></a><span class="lineno"> 45</span>   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
<a name="c1-46"></a><span class="lineno"> 46</span> <span class="p">};</span>
<a name="c1-47"></a><span class="lineno"> 47</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prio_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-48"></a><span class="lineno"> 48</span>   <span class="s">"head"</span><span class="p">,</span> <span class="s">"lightweight"</span><span class="p">,</span> <span class="s">"annotated"</span><span class="p">,</span>
<a name="c1-49"></a><span class="lineno"> 49</span> <span class="p">};</span>
<a name="c1-50"></a><span class="lineno"> 50</span> 
<a name="c1-51"></a><span class="lineno"> 51</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hash_sha1</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c1-52"></a><span class="lineno"> 52</span> <span class="p">{</span>
<a name="c1-53"></a><span class="lineno"> 53</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>
<a name="c1-54"></a><span class="lineno"> 54</span>   <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>
<a name="c1-55"></a><span class="lineno"> 55</span>   <span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<a name="c1-56"></a><span class="lineno"> 56</span> <span class="p">}</span>
<a name="c1-57"></a><span class="lineno"> 57</span> 
<a name="c1-58"></a><span class="lineno"> 58</span> <span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="nf">find_commit_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">peeled</span><span class="p">)</span>
<a name="c1-59"></a><span class="lineno"> 59</span> <span class="p">{</span>
<a name="c1-60"></a><span class="lineno"> 60</span>   <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">lookup_hash</span><span class="p">(</span><span class="n">hash_sha1</span><span class="p">(</span><span class="n">peeled</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">names</span><span class="p">);</span>
<a name="c1-61"></a><span class="lineno"> 61</span>   <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="n">hashcmp</span><span class="p">(</span><span class="n">peeled</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">peeled</span><span class="p">))</span>
<a name="c1-62"></a><span class="lineno"> 62</span>     <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-63"></a><span class="lineno"> 63</span>   <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<a name="c1-64"></a><span class="lineno"> 64</span> <span class="p">}</span>
<a name="c1-65"></a><span class="lineno"> 65</span> 
<a name="c1-66"></a><span class="lineno"> 66</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">set_util</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a name="c1-67"></a><span class="lineno"> 67</span> <span class="p">{</span>
<a name="c1-68"></a><span class="lineno"> 68</span>   <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
<a name="c1-69"></a><span class="lineno"> 69</span>   <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">chain</span><span class="p">;</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-70"></a><span class="lineno"> 70</span>     <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">lookup_commit_reference_gently</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">peeled</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-71"></a><span class="lineno"> 71</span>     <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a name="c1-72"></a><span class="lineno"> 72</span>       <span class="n">c</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<a name="c1-73"></a><span class="lineno"> 73</span>   <span class="p">}</span>
<a name="c1-74"></a><span class="lineno"> 74</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-75"></a><span class="lineno"> 75</span> <span class="p">}</span>
<a name="c1-76"></a><span class="lineno"> 76</span> 
<a name="c1-77"></a><span class="lineno"> 77</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">replace_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
<a name="c1-78"></a><span class="lineno"> 78</span>              <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
<a name="c1-79"></a><span class="lineno"> 79</span>              <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">,</span>
<a name="c1-80"></a><span class="lineno"> 80</span>              <span class="k">struct</span> <span class="n">tag</span> <span class="o">**</span><span class="n">tag</span><span class="p">)</span>
<a name="c1-81"></a><span class="lineno"> 81</span> <span class="p">{</span>
<a name="c1-82"></a><span class="lineno"> 82</span>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">&lt;</span> <span class="n">prio</span><span class="p">)</span>
<a name="c1-83"></a><span class="lineno"> 83</span>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-84"></a><span class="lineno"> 84</span> 
<a name="c1-85"></a><span class="lineno"> 85</span>   <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">prio</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-86"></a><span class="lineno"> 86</span>     <span class="cm">/* Multiple annotated tags point to the same commit.</span>
<a name="c1-87"></a><span class="lineno"> 87</span> <span class="cm">    * Select one to keep based upon their tagger date.</span>
<a name="c1-88"></a><span class="lineno"> 88</span> <span class="cm">    */</span>
<a name="c1-89"></a><span class="lineno"> 89</span>     <span class="k">struct</span> <span class="n">tag</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
<a name="c1-90"></a><span class="lineno"> 90</span> 
<a name="c1-91"></a><span class="lineno"> 91</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-92"></a><span class="lineno"> 92</span>       <span class="n">t</span> <span class="o">=</span> <span class="n">lookup_tag</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-93"></a><span class="lineno"> 93</span>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="n">parse_tag</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<a name="c1-94"></a><span class="lineno"> 94</span>         <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-95"></a><span class="lineno"> 95</span>       <span class="n">e</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<a name="c1-96"></a><span class="lineno"> 96</span>     <span class="p">}</span>
<a name="c1-97"></a><span class="lineno"> 97</span> 
<a name="c1-98"></a><span class="lineno"> 98</span>     <span class="n">t</span> <span class="o">=</span> <span class="n">lookup_tag</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-99"></a><span class="lineno"> 99</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span> <span class="o">||</span> <span class="n">parse_tag</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<a name="c1-100"></a><span class="lineno">100</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-101"></a><span class="lineno">101</span>    <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<a name="c1-102"></a><span class="lineno">102</span> 
<a name="c1-103"></a><span class="lineno">103</span>    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">tag</span><span class="o">-&gt;</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">)</span>
<a name="c1-104"></a><span class="lineno">104</span>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-105"></a><span class="lineno">105</span>  <span class="p">}</span>
<a name="c1-106"></a><span class="lineno">106</span> 
<a name="c1-107"></a><span class="lineno">107</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-108"></a><span class="lineno">108</span> <span class="p">}</span>
<a name="c1-109"></a><span class="lineno">109</span> 
<a name="c1-110"></a><span class="lineno">110</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">add_to_known_names</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
<a name="c1-111"></a><span class="lineno">111</span>             <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">peeled</span><span class="p">,</span>
<a name="c1-112"></a><span class="lineno">112</span>             <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
<a name="c1-113"></a><span class="lineno">113</span>             <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c1-114"></a><span class="lineno">114</span> <span class="p">{</span>
<a name="c1-115"></a><span class="lineno">115</span>  <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">find_commit_name</span><span class="p">(</span><span class="n">peeled</span><span class="p">);</span>
<a name="c1-116"></a><span class="lineno">116</span>  <span class="k">struct</span> <span class="n">tag</span> <span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-117"></a><span class="lineno">117</span>  <span class="k">if</span> <span class="p">(</span><span class="n">replace_name</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-118"></a><span class="lineno">118</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-119"></a><span class="lineno">119</span>      <span class="kt">void</span> <span class="o">**</span><span class="n">pos</span><span class="p">;</span>
<a name="c1-120"></a><span class="lineno">120</span>      <span class="n">e</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit_name</span><span class="p">));</span>
<a name="c1-121"></a><span class="lineno">121</span>      <span class="n">hashcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">peeled</span><span class="p">,</span> <span class="n">peeled</span><span class="p">);</span>
<a name="c1-122"></a><span class="lineno">122</span>      <span class="n">pos</span> <span class="o">=</span> <span class="n">insert_hash</span><span class="p">(</span><span class="n">hash_sha1</span><span class="p">(</span><span class="n">peeled</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">names</span><span class="p">);</span>
<a name="c1-123"></a><span class="lineno">123</span>      <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-124"></a><span class="lineno">124</span>        <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
<a name="c1-125"></a><span class="lineno">125</span>        <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
<a name="c1-126"></a><span class="lineno">126</span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-127"></a><span class="lineno">127</span>        <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-128"></a><span class="lineno">128</span>      <span class="p">}</span>
<a name="c1-129"></a><span class="lineno">129</span>    <span class="p">}</span>
<a name="c1-130"></a><span class="lineno">130</span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<a name="c1-131"></a><span class="lineno">131</span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">=</span> <span class="n">prio</span><span class="p">;</span>
<a name="c1-132"></a><span class="lineno">132</span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">name_checked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-133"></a><span class="lineno">133</span>    <span class="n">hashcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c1-134"></a><span class="lineno">134</span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
<a name="c1-135"></a><span class="lineno">135</span>  <span class="p">}</span>
<a name="c1-136"></a><span class="lineno">136</span> <span class="p">}</span>
<a name="c1-137"></a><span class="lineno">137</span> 
<a name="c1-138"></a><span class="lineno">138</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">get_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<a name="c1-139"></a><span class="lineno">139</span> <span class="p">{</span>
<a name="c1-140"></a><span class="lineno">140</span>  <span class="kt">int</span> <span class="n">might_be_tag</span> <span class="o">=</span> <span class="o">!</span><span class="n">prefixcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"refs/tags/"</span><span class="p">);</span>
<a name="c1-141"></a><span class="lineno">141</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">peeled</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c1-142"></a><span class="lineno">142</span>  <span class="kt">int</span> <span class="n">is_tag</span><span class="p">,</span> <span class="n">prio</span><span class="p">;</span>
<a name="c1-143"></a><span class="lineno">143</span> 
<a name="c1-144"></a><span class="lineno">144</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">might_be_tag</span><span class="p">)</span>
<a name="c1-145"></a><span class="lineno">145</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-146"></a><span class="lineno">146</span> 
<a name="c1-147"></a><span class="lineno">147</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peel_ref</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">peeled</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_null_sha1</span><span class="p">(</span><span class="n">peeled</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-148"></a><span class="lineno">148</span>    <span class="n">is_tag</span> <span class="o">=</span> <span class="o">!!</span><span class="n">hashcmp</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">peeled</span><span class="p">);</span>
<a name="c1-149"></a><span class="lineno">149</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-150"></a><span class="lineno">150</span>    <span class="n">hashcpy</span><span class="p">(</span><span class="n">peeled</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c1-151"></a><span class="lineno">151</span>    <span class="n">is_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-152"></a><span class="lineno">152</span>  <span class="p">}</span>
<a name="c1-153"></a><span class="lineno">153</span> 
<a name="c1-154"></a><span class="lineno">154</span>  <span class="cm">/* If --all, then any refs are used.</span>
<a name="c1-155"></a><span class="lineno">155</span> <span class="cm">   * If --tags, then any tags are used.</span>
<a name="c1-156"></a><span class="lineno">156</span> <span class="cm">   * Otherwise only annotated tags are used.</span>
<a name="c1-157"></a><span class="lineno">157</span> <span class="cm">   */</span>
<a name="c1-158"></a><span class="lineno">158</span>  <span class="k">if</span> <span class="p">(</span><span class="n">might_be_tag</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-159"></a><span class="lineno">159</span>    <span class="k">if</span> <span class="p">(</span><span class="n">is_tag</span><span class="p">)</span>
<a name="c1-160"></a><span class="lineno">160</span>      <span class="n">prio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="c1-161"></a><span class="lineno">161</span>    <span class="k">else</span>
<a name="c1-162"></a><span class="lineno">162</span>      <span class="n">prio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-163"></a><span class="lineno">163</span> 
<a name="c1-164"></a><span class="lineno">164</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pattern</span> <span class="o">&amp;&amp;</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a name="c1-165"></a><span class="lineno">165</span>      <span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-166"></a><span class="lineno">166</span>  <span class="p">}</span>
<a name="c1-167"></a><span class="lineno">167</span>  <span class="k">else</span>
<a name="c1-168"></a><span class="lineno">168</span>    <span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-169"></a><span class="lineno">169</span> 
<a name="c1-170"></a><span class="lineno">170</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-171"></a><span class="lineno">171</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prio</span><span class="p">)</span>
<a name="c1-172"></a><span class="lineno">172</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-173"></a><span class="lineno">173</span>  <span class="p">}</span>
<a name="c1-174"></a><span class="lineno">174</span>  <span class="n">add_to_known_names</span><span class="p">(</span><span class="n">all</span> <span class="o">?</span> <span class="n">path</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">:</span> <span class="n">path</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">peeled</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c1-175"></a><span class="lineno">175</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-176"></a><span class="lineno">176</span> <span class="p">}</span>
<a name="c1-177"></a><span class="lineno">177</span> 
<a name="c1-178"></a><span class="lineno">178</span> <span class="k">struct</span> <span class="n">possible_tag</span> <span class="p">{</span>
<a name="c1-179"></a><span class="lineno">179</span>  <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="c1-180"></a><span class="lineno">180</span>  <span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
<a name="c1-181"></a><span class="lineno">181</span>  <span class="kt">int</span> <span class="n">found_order</span><span class="p">;</span>
<a name="c1-182"></a><span class="lineno">182</span>  <span class="kt">unsigned</span> <span class="n">flag_within</span><span class="p">;</span>
<a name="c1-183"></a><span class="lineno">183</span> <span class="p">};</span>
<a name="c1-184"></a><span class="lineno">184</span> 
<a name="c1-185"></a><span class="lineno">185</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">compare_pt</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a_</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b_</span><span class="p">)</span>
<a name="c1-186"></a><span class="lineno">186</span> <span class="p">{</span>
<a name="c1-187"></a><span class="lineno">187</span>  <span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="p">)</span><span class="n">a_</span><span class="p">;</span>
<a name="c1-188"></a><span class="lineno">188</span>  <span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="p">)</span><span class="n">b_</span><span class="p">;</span>
<a name="c1-189"></a><span class="lineno">189</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span>
<a name="c1-190"></a><span class="lineno">190</span>    <span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
<a name="c1-191"></a><span class="lineno">191</span>  <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">found_order</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">found_order</span><span class="p">)</span>
<a name="c1-192"></a><span class="lineno">192</span>    <span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">found_order</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">found_order</span><span class="p">;</span>
<a name="c1-193"></a><span class="lineno">193</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-194"></a><span class="lineno">194</span> <span class="p">}</span>
<a name="c1-195"></a><span class="lineno">195</span> 
<a name="c1-196"></a><span class="lineno">196</span> <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">finish_depth_computation</span><span class="p">(</span>
<a name="c1-197"></a><span class="lineno">197</span>  <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">**</span><span class="n">list</span><span class="p">,</span>
<a name="c1-198"></a><span class="lineno">198</span>  <span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="n">best</span><span class="p">)</span>
<a name="c1-199"></a><span class="lineno">199</span> <span class="p">{</span>
<a name="c1-200"></a><span class="lineno">200</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seen_commits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-201"></a><span class="lineno">201</span>  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-202"></a><span class="lineno">202</span>    <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">pop_commit</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c1-203"></a><span class="lineno">203</span>    <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">parents</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parents</span><span class="p">;</span>
<a name="c1-204"></a><span class="lineno">204</span>    <span class="n">seen_commits</span><span class="o">++</span><span class="p">;</span>
<a name="c1-205"></a><span class="lineno">205</span>    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">flag_within</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-206"></a><span class="lineno">206</span>      <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c1-207"></a><span class="lineno">207</span>      <span class="k">while</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-208"></a><span class="lineno">208</span>        <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">;</span>
<a name="c1-209"></a><span class="lineno">209</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">flag_within</span><span class="p">))</span>
<a name="c1-210"></a><span class="lineno">210</span>          <span class="k">break</span><span class="p">;</span>
<a name="c1-211"></a><span class="lineno">211</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-212"></a><span class="lineno">212</span>      <span class="p">}</span>
<a name="c1-213"></a><span class="lineno">213</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span>
<a name="c1-214"></a><span class="lineno">214</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-215"></a><span class="lineno">215</span>    <span class="p">}</span> <span class="k">else</span>
<a name="c1-216"></a><span class="lineno">216</span>      <span class="n">best</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>
<a name="c1-217"></a><span class="lineno">217</span>    <span class="k">while</span> <span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-218"></a><span class="lineno">218</span>      <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">parents</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">;</span>
<a name="c1-219"></a><span class="lineno">219</span>      <span class="n">parse_commit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c1-220"></a><span class="lineno">220</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEEN</span><span class="p">))</span>
<a name="c1-221"></a><span class="lineno">221</span>        <span class="n">commit_list_insert_by_date</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<a name="c1-222"></a><span class="lineno">222</span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
<a name="c1-223"></a><span class="lineno">223</span>      <span class="n">parents</span> <span class="o">=</span> <span class="n">parents</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-224"></a><span class="lineno">224</span>    <span class="p">}</span>
<a name="c1-225"></a><span class="lineno">225</span>  <span class="p">}</span>
<a name="c1-226"></a><span class="lineno">226</span>  <span class="k">return</span> <span class="n">seen_commits</span><span class="p">;</span>
<a name="c1-227"></a><span class="lineno">227</span> <span class="p">}</span>
<a name="c1-228"></a><span class="lineno">228</span> 
<a name="c1-229"></a><span class="lineno">229</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">display_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<a name="c1-230"></a><span class="lineno">230</span> <span class="p">{</span>
<a name="c1-231"></a><span class="lineno">231</span>  <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-232"></a><span class="lineno">232</span>    <span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">lookup_tag</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-233"></a><span class="lineno">233</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">||</span> <span class="n">parse_tag</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">))</span>
<a name="c1-234"></a><span class="lineno">234</span>      <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"annotated tag %s not available"</span><span class="p">),</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-235"></a><span class="lineno">235</span>  <span class="p">}</span>
<a name="c1-236"></a><span class="lineno">236</span>  <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name_checked</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-237"></a><span class="lineno">237</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
<a name="c1-238"></a><span class="lineno">238</span>      <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"annotated tag %s has no embedded name"</span><span class="p">),</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-239"></a><span class="lineno">239</span>    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">all</span> <span class="o">?</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">:</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">))</span>
<a name="c1-240"></a><span class="lineno">240</span>      <span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"tag '%s' is really '%s' here"</span><span class="p">),</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-241"></a><span class="lineno">241</span>    <span class="n">n</span><span class="o">-&gt;</span><span class="n">name_checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-242"></a><span class="lineno">242</span>  <span class="p">}</span>
<a name="c1-243"></a><span class="lineno">243</span> 
<a name="c1-244"></a><span class="lineno">244</span>  <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span>
<a name="c1-245"></a><span class="lineno">245</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
<a name="c1-246"></a><span class="lineno">246</span>  <span class="k">else</span>
<a name="c1-247"></a><span class="lineno">247</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-248"></a><span class="lineno">248</span> <span class="p">}</span>
<a name="c1-249"></a><span class="lineno">249</span> 
<a name="c1-250"></a><span class="lineno">250</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">show_suffix</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span><span class="p">)</span>
<a name="c1-251"></a><span class="lineno">251</span> <span class="p">{</span>
<a name="c1-252"></a><span class="lineno">252</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"-%d-g%s"</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">find_unique_abbrev</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">abbrev</span><span class="p">));</span>
<a name="c1-253"></a><span class="lineno">253</span> <span class="p">}</span>
<a name="c1-254"></a><span class="lineno">254</span> 
<a name="c1-255"></a><span class="lineno">255</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">describe</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last_one</span><span class="p">)</span>
<a name="c1-256"></a><span class="lineno">256</span> <span class="p">{</span>
<a name="c1-257"></a><span class="lineno">257</span>  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sha1</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<a name="c1-258"></a><span class="lineno">258</span>  <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">cmit</span><span class="p">,</span> <span class="o">*</span><span class="n">gave_up_on</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-259"></a><span class="lineno">259</span>  <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
<a name="c1-260"></a><span class="lineno">260</span>  <span class="k">struct</span> <span class="n">commit_name</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
<a name="c1-261"></a><span class="lineno">261</span>  <span class="k">struct</span> <span class="n">possible_tag</span> <span class="n">all_matches</span><span class="p">[</span><span class="n">MAX_TAGS</span><span class="p">];</span>
<a name="c1-262"></a><span class="lineno">262</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">match_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">annotated_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur_match</span><span class="p">;</span>
<a name="c1-263"></a><span class="lineno">263</span>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seen_commits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-264"></a><span class="lineno">264</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unannotated_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-265"></a><span class="lineno">265</span> 
<a name="c1-266"></a><span class="lineno">266</span>  <span class="k">if</span> <span class="p">(</span><span class="n">get_sha1</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">sha1</span><span class="p">))</span>
<a name="c1-267"></a><span class="lineno">267</span>    <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Not a valid object name %s"</span><span class="p">),</span> <span class="n">arg</span><span class="p">);</span>
<a name="c1-268"></a><span class="lineno">268</span>  <span class="n">cmit</span> <span class="o">=</span> <span class="n">lookup_commit_reference</span><span class="p">(</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-269"></a><span class="lineno">269</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmit</span><span class="p">)</span>
<a name="c1-270"></a><span class="lineno">270</span>    <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"%s is not a valid '%s' object"</span><span class="p">),</span> <span class="n">arg</span><span class="p">,</span> <span class="n">commit_type</span><span class="p">);</span>
<a name="c1-271"></a><span class="lineno">271</span> 
<a name="c1-272"></a><span class="lineno">272</span>  <span class="n">n</span> <span class="o">=</span> <span class="n">find_commit_name</span><span class="p">(</span><span class="n">cmit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-273"></a><span class="lineno">273</span>  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tags</span> <span class="o">||</span> <span class="n">all</span> <span class="o">||</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-274"></a><span class="lineno">274</span>    <span class="cm">/*</span>
<a name="c1-275"></a><span class="lineno">275</span> <span class="cm">     * Exact match to an existing ref.</span>
<a name="c1-276"></a><span class="lineno">276</span> <span class="cm">     */</span>
<a name="c1-277"></a><span class="lineno">277</span>    <span class="n">display_name</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<a name="c1-278"></a><span class="lineno">278</span>    <span class="k">if</span> <span class="p">(</span><span class="n">longformat</span><span class="p">)</span>
<a name="c1-279"></a><span class="lineno">279</span>      <span class="n">show_suffix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">?</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">tag</span><span class="o">-&gt;</span><span class="n">tagged</span><span class="o">-&gt;</span><span class="n">sha1</span> <span class="o">:</span> <span class="n">sha1</span><span class="p">);</span>
<a name="c1-280"></a><span class="lineno">280</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span>
<a name="c1-281"></a><span class="lineno">281</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">dirty</span><span class="p">);</span>
<a name="c1-282"></a><span class="lineno">282</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-283"></a><span class="lineno">283</span>    <span class="k">return</span><span class="p">;</span>
<a name="c1-284"></a><span class="lineno">284</span>  <span class="p">}</span>
<a name="c1-285"></a><span class="lineno">285</span> 
<a name="c1-286"></a><span class="lineno">286</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_candidates</span><span class="p">)</span>
<a name="c1-287"></a><span class="lineno">287</span>    <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"no tag exactly matches '%s'"</span><span class="p">),</span> <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">cmit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c1-288"></a><span class="lineno">288</span>  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
<a name="c1-289"></a><span class="lineno">289</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"searching to describe %s</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">arg</span><span class="p">);</span>
<a name="c1-290"></a><span class="lineno">290</span> 
<a name="c1-291"></a><span class="lineno">291</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_util</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-292"></a><span class="lineno">292</span>    <span class="n">for_each_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">names</span><span class="p">,</span> <span class="n">set_util</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-293"></a><span class="lineno">293</span>    <span class="n">have_util</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-294"></a><span class="lineno">294</span>  <span class="p">}</span>
<a name="c1-295"></a><span class="lineno">295</span> 
<a name="c1-296"></a><span class="lineno">296</span>  <span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-297"></a><span class="lineno">297</span>  <span class="n">cmit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SEEN</span><span class="p">;</span>
<a name="c1-298"></a><span class="lineno">298</span>  <span class="n">commit_list_insert</span><span class="p">(</span><span class="n">cmit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
<a name="c1-299"></a><span class="lineno">299</span>  <span class="k">while</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-300"></a><span class="lineno">300</span>    <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">pop_commit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
<a name="c1-301"></a><span class="lineno">301</span>    <span class="k">struct</span> <span class="n">commit_list</span> <span class="o">*</span><span class="n">parents</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parents</span><span class="p">;</span>
<a name="c1-302"></a><span class="lineno">302</span>    <span class="n">seen_commits</span><span class="o">++</span><span class="p">;</span>
<a name="c1-303"></a><span class="lineno">303</span>    <span class="n">n</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">util</span><span class="p">;</span>
<a name="c1-304"></a><span class="lineno">304</span>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-305"></a><span class="lineno">305</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">all</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-306"></a><span class="lineno">306</span>        <span class="n">unannotated_cnt</span><span class="o">++</span><span class="p">;</span>
<a name="c1-307"></a><span class="lineno">307</span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">match_cnt</span> <span class="o">&lt;</span> <span class="n">max_candidates</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-308"></a><span class="lineno">308</span>        <span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">all_matches</span><span class="p">[</span><span class="n">match_cnt</span><span class="o">++</span><span class="p">];</span>
<a name="c1-309"></a><span class="lineno">309</span>        <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<a name="c1-310"></a><span class="lineno">310</span>        <span class="n">t</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">seen_commits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-311"></a><span class="lineno">311</span>        <span class="n">t</span><span class="o">-&gt;</span><span class="n">flag_within</span> <span class="o">=</span> <span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">match_cnt</span><span class="p">;</span>
<a name="c1-312"></a><span class="lineno">312</span>        <span class="n">t</span><span class="o">-&gt;</span><span class="n">found_order</span> <span class="o">=</span> <span class="n">match_cnt</span><span class="p">;</span>
<a name="c1-313"></a><span class="lineno">313</span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">flag_within</span><span class="p">;</span>
<a name="c1-314"></a><span class="lineno">314</span>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">prio</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<a name="c1-315"></a><span class="lineno">315</span>          <span class="n">annotated_cnt</span><span class="o">++</span><span class="p">;</span>
<a name="c1-316"></a><span class="lineno">316</span>      <span class="p">}</span>
<a name="c1-317"></a><span class="lineno">317</span>      <span class="k">else</span> <span class="p">{</span>
<a name="c1-318"></a><span class="lineno">318</span>        <span class="n">gave_up_on</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<a name="c1-319"></a><span class="lineno">319</span>        <span class="k">break</span><span class="p">;</span>
<a name="c1-320"></a><span class="lineno">320</span>      <span class="p">}</span>
<a name="c1-321"></a><span class="lineno">321</span>    <span class="p">}</span>
<a name="c1-322"></a><span class="lineno">322</span>    <span class="k">for</span> <span class="p">(</span><span class="n">cur_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cur_match</span> <span class="o">&lt;</span> <span class="n">match_cnt</span><span class="p">;</span> <span class="n">cur_match</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-323"></a><span class="lineno">323</span>      <span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">all_matches</span><span class="p">[</span><span class="n">cur_match</span><span class="p">];</span>
<a name="c1-324"></a><span class="lineno">324</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">flag_within</span><span class="p">))</span>
<a name="c1-325"></a><span class="lineno">325</span>        <span class="n">t</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>
<a name="c1-326"></a><span class="lineno">326</span>    <span class="p">}</span>
<a name="c1-327"></a><span class="lineno">327</span>    <span class="k">if</span> <span class="p">(</span><span class="n">annotated_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-328"></a><span class="lineno">328</span>      <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
<a name="c1-329"></a><span class="lineno">329</span>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"finished search at %s</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span>
<a name="c1-330"></a><span class="lineno">330</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c1-331"></a><span class="lineno">331</span>      <span class="k">break</span><span class="p">;</span>
<a name="c1-332"></a><span class="lineno">332</span>    <span class="p">}</span>
<a name="c1-333"></a><span class="lineno">333</span>    <span class="k">while</span> <span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-334"></a><span class="lineno">334</span>      <span class="k">struct</span> <span class="n">commit</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">parents</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">;</span>
<a name="c1-335"></a><span class="lineno">335</span>      <span class="n">parse_commit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="c1-336"></a><span class="lineno">336</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SEEN</span><span class="p">))</span>
<a name="c1-337"></a><span class="lineno">337</span>        <span class="n">commit_list_insert_by_date</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
<a name="c1-338"></a><span class="lineno">338</span>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
<a name="c1-339"></a><span class="lineno">339</span>      <span class="n">parents</span> <span class="o">=</span> <span class="n">parents</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-340"></a><span class="lineno">340</span>    <span class="p">}</span>
<a name="c1-341"></a><span class="lineno">341</span>  <span class="p">}</span>
<a name="c1-342"></a><span class="lineno">342</span> 
<a name="c1-343"></a><span class="lineno">343</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_cnt</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-344"></a><span class="lineno">344</span>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sha1</span> <span class="o">=</span> <span class="n">cmit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">;</span>
<a name="c1-345"></a><span class="lineno">345</span>    <span class="k">if</span> <span class="p">(</span><span class="n">always</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-346"></a><span class="lineno">346</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">find_unique_abbrev</span><span class="p">(</span><span class="n">sha1</span><span class="p">,</span> <span class="n">abbrev</span><span class="p">));</span>
<a name="c1-347"></a><span class="lineno">347</span>      <span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span>
<a name="c1-348"></a><span class="lineno">348</span>        <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">dirty</span><span class="p">);</span>
<a name="c1-349"></a><span class="lineno">349</span>      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-350"></a><span class="lineno">350</span>      <span class="k">return</span><span class="p">;</span>
<a name="c1-351"></a><span class="lineno">351</span>    <span class="p">}</span>
<a name="c1-352"></a><span class="lineno">352</span>    <span class="k">if</span> <span class="p">(</span><span class="n">unannotated_cnt</span><span class="p">)</span>
<a name="c1-353"></a><span class="lineno">353</span>      <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"No annotated tags can describe '%s'.</span><span class="se">\n</span><span class="s">"</span>
<a name="c1-354"></a><span class="lineno">354</span>          <span class="s">"However, there were unannotated tags: try --tags."</span><span class="p">),</span>
<a name="c1-355"></a><span class="lineno">355</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">));</span>
<a name="c1-356"></a><span class="lineno">356</span>    <span class="k">else</span>
<a name="c1-357"></a><span class="lineno">357</span>      <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"No tags can describe '%s'.</span><span class="se">\n</span><span class="s">"</span>
<a name="c1-358"></a><span class="lineno">358</span>          <span class="s">"Try --always, or create some tags."</span><span class="p">),</span>
<a name="c1-359"></a><span class="lineno">359</span>          <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">sha1</span><span class="p">));</span>
<a name="c1-360"></a><span class="lineno">360</span>  <span class="p">}</span>
<a name="c1-361"></a><span class="lineno">361</span> 
<a name="c1-362"></a><span class="lineno">362</span>  <span class="n">qsort</span><span class="p">(</span><span class="n">all_matches</span><span class="p">,</span> <span class="n">match_cnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">all_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">compare_pt</span><span class="p">);</span>
<a name="c1-363"></a><span class="lineno">363</span> 
<a name="c1-364"></a><span class="lineno">364</span>  <span class="k">if</span> <span class="p">(</span><span class="n">gave_up_on</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-365"></a><span class="lineno">365</span>    <span class="n">commit_list_insert_by_date</span><span class="p">(</span><span class="n">gave_up_on</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
<a name="c1-366"></a><span class="lineno">366</span>    <span class="n">seen_commits</span><span class="o">--</span><span class="p">;</span>
<a name="c1-367"></a><span class="lineno">367</span>  <span class="p">}</span>
<a name="c1-368"></a><span class="lineno">368</span>  <span class="n">seen_commits</span> <span class="o">+=</span> <span class="n">finish_depth_computation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a name="c1-369"></a><span class="lineno">369</span>  <span class="n">free_commit_list</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
<a name="c1-370"></a><span class="lineno">370</span> 
<a name="c1-371"></a><span class="lineno">371</span>  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-372"></a><span class="lineno">372</span>    <span class="k">for</span> <span class="p">(</span><span class="n">cur_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cur_match</span> <span class="o">&lt;</span> <span class="n">match_cnt</span><span class="p">;</span> <span class="n">cur_match</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-373"></a><span class="lineno">373</span>      <span class="k">struct</span> <span class="n">possible_tag</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">all_matches</span><span class="p">[</span><span class="n">cur_match</span><span class="p">];</span>
<a name="c1-374"></a><span class="lineno">374</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">" %-11s %8d %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<a name="c1-375"></a><span class="lineno">375</span>        <span class="n">prio_names</span><span class="p">[</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">],</span>
<a name="c1-376"></a><span class="lineno">376</span>        <span class="n">t</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="c1-377"></a><span class="lineno">377</span>    <span class="p">}</span>
<a name="c1-378"></a><span class="lineno">378</span>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">"traversed %lu commits</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">seen_commits</span><span class="p">);</span>
<a name="c1-379"></a><span class="lineno">379</span>    <span class="k">if</span> <span class="p">(</span><span class="n">gave_up_on</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-380"></a><span class="lineno">380</span>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<a name="c1-381"></a><span class="lineno">381</span>        <span class="n">_</span><span class="p">(</span><span class="s">"more than %i tags found; listed %i most recent</span><span class="se">\n</span><span class="s">"</span>
<a name="c1-382"></a><span class="lineno">382</span>        <span class="s">"gave up search at %s</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span>
<a name="c1-383"></a><span class="lineno">383</span>        <span class="n">max_candidates</span><span class="p">,</span> <span class="n">max_candidates</span><span class="p">,</span>
<a name="c1-384"></a><span class="lineno">384</span>        <span class="n">sha1_to_hex</span><span class="p">(</span><span class="n">gave_up_on</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">));</span>
<a name="c1-385"></a><span class="lineno">385</span>    <span class="p">}</span>
<a name="c1-386"></a><span class="lineno">386</span>  <span class="p">}</span>
<a name="c1-387"></a><span class="lineno">387</span> 
<a name="c1-388"></a><span class="lineno">388</span>  <span class="n">display_name</span><span class="p">(</span><span class="n">all_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
<a name="c1-389"></a><span class="lineno">389</span>  <span class="k">if</span> <span class="p">(</span><span class="n">abbrev</span><span class="p">)</span>
<a name="c1-390"></a><span class="lineno">390</span>    <span class="n">show_suffix</span><span class="p">(</span><span class="n">all_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">depth</span><span class="p">,</span> <span class="n">cmit</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">sha1</span><span class="p">);</span>
<a name="c1-391"></a><span class="lineno">391</span>  <span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span>
<a name="c1-392"></a><span class="lineno">392</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">dirty</span><span class="p">);</span>
<a name="c1-393"></a><span class="lineno">393</span>  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="c1-394"></a><span class="lineno">394</span> 
<a name="c1-395"></a><span class="lineno">395</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_one</span><span class="p">)</span>
<a name="c1-396"></a><span class="lineno">396</span>    <span class="n">clear_commit_marks</span><span class="p">(</span><span class="n">cmit</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a name="c1-397"></a><span class="lineno">397</span> <span class="p">}</span>
<a name="c1-398"></a><span class="lineno">398</span> 
<a name="c1-399"></a><span class="lineno">399</span> <span class="kt">int</span> <span class="nf">cmd_describe</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<a name="c1-400"></a><span class="lineno">400</span> <span class="p">{</span>
<a name="c1-401"></a><span class="lineno">401</span>  <span class="kt">int</span> <span class="n">contains</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-402"></a><span class="lineno">402</span>  <span class="k">struct</span> <span class="n">option</span> <span class="n">options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="c1-403"></a><span class="lineno">403</span> <span class="hll">   <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"contains"</span><span class="p">,</span>   <span class="o">&amp;</span><span class="n">contains</span><span class="p">,</span> <span class="s">"find the tag that comes after the commit"</span><span class="p">),</span>
</span><a name="c1-404"></a><span class="lineno">404</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"debug"</span><span class="p">,</span>      <span class="o">&amp;</span><span class="n">debug</span><span class="p">,</span> <span class="s">"debug search strategy on stderr"</span><span class="p">),</span>
</span><a name="c1-405"></a><span class="lineno">405</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"all"</span><span class="p">,</span>        <span class="o">&amp;</span><span class="n">all</span><span class="p">,</span> <span class="s">"use any ref in .git/refs"</span><span class="p">),</span>
</span><a name="c1-406"></a><span class="lineno">406</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"tags"</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">tags</span><span class="p">,</span> <span class="s">"use any tag in .git/refs/tags"</span><span class="p">),</span>
</span><a name="c1-407"></a><span class="lineno">407</span> <span class="hll">    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"long"</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">longformat</span><span class="p">,</span> <span class="s">"always use long format"</span><span class="p">),</span>
</span><a name="c1-408"></a><span class="lineno">408</span> <span class="hll">    <span class="n">OPT__ABBREV</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abbrev</span><span class="p">),</span>
</span><a name="c1-409"></a><span class="lineno">409</span>     <span class="n">OPT_SET_INT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"exact-match"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_candidates</span><span class="p">,</span>
<a name="c1-410"></a><span class="lineno">410</span>          <span class="s">"only output exact matches"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a name="c1-411"></a><span class="lineno">411</span>    <span class="n">OPT_INTEGER</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"candidates"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_candidates</span><span class="p">,</span>
<a name="c1-412"></a><span class="lineno">412</span>          <span class="s">"consider &lt;n&gt; most recent tags (default: 10)"</span><span class="p">),</span>
<a name="c1-413"></a><span class="lineno">413</span>    <span class="n">OPT_STRING</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"match"</span><span class="p">,</span>       <span class="o">&amp;</span><span class="n">pattern</span><span class="p">,</span> <span class="s">"pattern"</span><span class="p">,</span>
<a name="c1-414"></a><span class="lineno">414</span>         <span class="s">"only consider tags matching &lt;pattern&gt;"</span><span class="p">),</span>
<a name="c1-415"></a><span class="lineno">415</span>    <span class="n">OPT_BOOLEAN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">"always"</span><span class="p">,</span>     <span class="o">&amp;</span><span class="n">always</span><span class="p">,</span>
<a name="c1-416"></a><span class="lineno">416</span>         <span class="s">"show abbreviated commit object as fallback"</span><span class="p">),</span>
<a name="c1-417"></a><span class="lineno">417</span>    <span class="p">{</span><span class="n">OPTION_STRING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"dirty"</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dirty</span><span class="p">,</span> <span class="s">"mark"</span><span class="p">,</span>
<a name="c1-418"></a><span class="lineno">418</span>         <span class="s">"append &lt;mark&gt; on dirty working tree (default: </span><span class="se">\"</span><span class="s">-dirty</span><span class="se">\"</span><span class="s">)"</span><span class="p">,</span>
<a name="c1-419"></a><span class="lineno">419</span>     <span class="n">PARSE_OPT_OPTARG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">intptr_t</span><span class="p">)</span> <span class="s">"-dirty"</span><span class="p">},</span>
<a name="c1-420"></a><span class="lineno">420</span>    <span class="n">OPT_END</span><span class="p">(),</span>
<a name="c1-421"></a><span class="lineno">421</span>  <span class="p">};</span>
<a name="c1-422"></a><span class="lineno">422</span> 
<a name="c1-423"></a><span class="lineno">423</span>  <span class="n">git_config</span><span class="p">(</span><span class="n">git_default_config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-424"></a><span class="lineno">424</span>  <span class="n">argc</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">describe_usage</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-425"></a><span class="lineno">425</span>  <span class="k">if</span> <span class="p">(</span><span class="n">abbrev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-426"></a><span class="lineno">426</span>    <span class="n">abbrev</span> <span class="o">=</span> <span class="n">DEFAULT_ABBREV</span><span class="p">;</span>
<a name="c1-427"></a><span class="lineno">427</span> 
<a name="c1-428"></a><span class="lineno">428</span>  <span class="k">if</span> <span class="p">(</span><span class="n">max_candidates</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-429"></a><span class="lineno">429</span>    <span class="n">max_candidates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-430"></a><span class="lineno">430</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_candidates</span> <span class="o">&gt;</span> <span class="n">MAX_TAGS</span><span class="p">)</span>
<a name="c1-431"></a><span class="lineno">431</span>    <span class="n">max_candidates</span> <span class="o">=</span> <span class="n">MAX_TAGS</span><span class="p">;</span>
<a name="c1-432"></a><span class="lineno">432</span> 
<a name="c1-433"></a><span class="lineno">433</span>  <span class="n">save_commit_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-434"></a><span class="lineno">434</span> 
<a name="c1-435"></a><span class="lineno">435</span>  <span class="k">if</span> <span class="p">(</span><span class="n">longformat</span> <span class="o">&amp;&amp;</span> <span class="n">abbrev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-436"></a><span class="lineno">436</span>    <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"--long is incompatible with --abbrev=0"</span><span class="p">));</span>
<a name="c1-437"></a><span class="lineno">437</span> 
<a name="c1-438"></a><span class="lineno">438</span>  <span class="k">if</span> <span class="p">(</span><span class="n">contains</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-439"></a><span class="lineno">439</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">args</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">((</span><span class="mi">7</span> <span class="o">+</span> <span class="n">argc</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c1-440"></a><span class="lineno">440</span>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-441"></a><span class="lineno">441</span>    <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"name-rev"</span><span class="p">;</span>
<a name="c1-442"></a><span class="lineno">442</span>    <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--name-only"</span><span class="p">;</span>
<a name="c1-443"></a><span class="lineno">443</span>    <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--no-undefined"</span><span class="p">;</span>
<a name="c1-444"></a><span class="lineno">444</span>    <span class="k">if</span> <span class="p">(</span><span class="n">always</span><span class="p">)</span>
<a name="c1-445"></a><span class="lineno">445</span>      <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--always"</span><span class="p">;</span>
<a name="c1-446"></a><span class="lineno">446</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-447"></a><span class="lineno">447</span>      <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">"--tags"</span><span class="p">;</span>
<a name="c1-448"></a><span class="lineno">448</span>      <span class="k">if</span> <span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-449"></a><span class="lineno">449</span>        <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">xmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="s">"--refs=refs/tags/"</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-450"></a><span class="lineno">450</span>        <span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"--refs=refs/tags/%s"</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>
<a name="c1-451"></a><span class="lineno">451</span>        <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<a name="c1-452"></a><span class="lineno">452</span>      <span class="p">}</span>
<a name="c1-453"></a><span class="lineno">453</span>    <span class="p">}</span>
<a name="c1-454"></a><span class="lineno">454</span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">argc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<a name="c1-455"></a><span class="lineno">455</span>    <span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-456"></a><span class="lineno">456</span>    <span class="k">return</span> <span class="n">cmd_name_rev</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">argc</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
<a name="c1-457"></a><span class="lineno">457</span>  <span class="p">}</span>
<a name="c1-458"></a><span class="lineno">458</span> 
<a name="c1-459"></a><span class="lineno">459</span>  <span class="n">init_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">names</span><span class="p">);</span>
<a name="c1-460"></a><span class="lineno">460</span>  <span class="n">for_each_rawref</span><span class="p">(</span><span class="n">get_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-461"></a><span class="lineno">461</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">names</span><span class="p">.</span><span class="n">nr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">always</span><span class="p">)</span>
<a name="c1-462"></a><span class="lineno">462</span>    <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"No names found, cannot describe anything."</span><span class="p">));</span>
<a name="c1-463"></a><span class="lineno">463</span> 
<a name="c1-464"></a><span class="lineno">464</span>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-465"></a><span class="lineno">465</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-466"></a><span class="lineno">466</span>      <span class="k">static</span> <span class="k">struct</span> <span class="n">lock_file</span> <span class="n">index_lock</span><span class="p">;</span>
<a name="c1-467"></a><span class="lineno">467</span>      <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<a name="c1-468"></a><span class="lineno">468</span> 
<a name="c1-469"></a><span class="lineno">469</span>      <span class="n">read_cache_preload</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<a name="c1-470"></a><span class="lineno">470</span>      <span class="n">refresh_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_index</span><span class="p">,</span> <span class="n">REFRESH_QUIET</span><span class="o">|</span><span class="n">REFRESH_UNMERGED</span><span class="p">,</span>
<a name="c1-471"></a><span class="lineno">471</span>              <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<a name="c1-472"></a><span class="lineno">472</span>      <span class="n">fd</span> <span class="o">=</span> <span class="n">hold_locked_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index_lock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-473"></a><span class="lineno">473</span>      <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">fd</span><span class="p">)</span>
<a name="c1-474"></a><span class="lineno">474</span>        <span class="n">update_index_if_able</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index_lock</span><span class="p">);</span>
<a name="c1-475"></a><span class="lineno">475</span> 
<a name="c1-476"></a><span class="lineno">476</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_diff_index</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">diff_index_args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
<a name="c1-477"></a><span class="lineno">477</span>              <span class="n">diff_index_args</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
<a name="c1-478"></a><span class="lineno">478</span>        <span class="n">dirty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-479"></a><span class="lineno">479</span>    <span class="p">}</span>
<a name="c1-480"></a><span class="lineno">480</span>    <span class="n">describe</span><span class="p">(</span><span class="s">"HEAD"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-481"></a><span class="lineno">481</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-482"></a><span class="lineno">482</span>    <span class="n">die</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"--dirty is incompatible with committishes"</span><span class="p">));</span>
<a name="c1-483"></a><span class="lineno">483</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-484"></a><span class="lineno">484</span>    <span class="k">while</span> <span class="p">(</span><span class="n">argc</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-485"></a><span class="lineno">485</span>      <span class="n">describe</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="o">++</span><span class="p">,</span> <span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<a name="c1-486"></a><span class="lineno">486</span>    <span class="p">}</span>
<a name="c1-487"></a><span class="lineno">487</span>  <span class="p">}</span>
<a name="c1-488"></a><span class="lineno">488</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-489"></a><span class="lineno">489</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>

</body></html>