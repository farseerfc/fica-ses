<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0092)http://tyr.ics.es.osaka-u.ac.jp/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000681 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="shortcut icon" href="http://tyr.ics.es.osaka-u.ac.jp/static/favicon.ico">
        <script type="text/javascript" src="./mostmid_files/jquery-1.6.2.js"></script>
        <script type="text/javascript" src="./mostmid_files/jquery-ui-1.8.16.custom.min.js"></script>
        <script type="text/javascript" src="./mostmid_files/jquery.scrollintoview.min.js"></script>

        <script type="text/javascript" src="./mostmid_files/bootstrap-scrollspy.js"> </script>
        <script type="text/javascript" src="./mostmid_files/bootstrap-buttons.js"> </script>
        <script type="text/javascript" src="./mostmid_files/bootstrap-modal.js"> </script>
        <script type="text/javascript" src="./mostmid_files/bootstrap-dropdown.js"> </script>
        <script type="text/javascript" src="./mostmid_files/bootstrap-alerts.js"> </script>

        <script type="text/javascript" src="./mostmid_files/sijax.js"></script>

        <script language="javascript" type="text/javascript" src="./mostmid_files/d3.min.js"></script>
        <script language="javascript" type="text/javascript" src="./mostmid_files/chosen.jquery.js"></script>


        <script src="./mostmid_files/d3.layout.min.js" type="text/javascript"> </script>
        <script src="./mostmid_files/d3.geom.min.js" type="text/javascript"> </script>


        <script type="text/javascript" src="./mostmid_files/fica.js"> </script>

        <script type="text/javascript">
            Sijax.setRequestUri("/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000681");Sijax.setJsonUri("/static/sijax/json2.js");
        </script>
        <link type="text/css" href="./mostmid_files/jquery-ui-1.8.16.custom.css" rel="stylesheet">	
        <link type="text/css" href="./mostmid_files/bootstrap.css" rel="stylesheet">

        <link href="./mostmid_files/force.css" rel="stylesheet" type="text/css">
        <link href="./mostmid_files/chosen.css" rel="stylesheet" type="text/css">

        <link href="./motivating_files/font-awesome.css" rel="stylesheet" type="text/css">
        
<link rel="stylesheet" href="http://tyr.ics.es.osaka-u.ac.jp/pygments.css">
<title>Fica -- survey git-v1.7.9-rc1 12-01-25 02:26:57</title>

<script language="javascript">

    var reheight = function(){
        $(".scrollbox").each(function (){
            $(this).css("max-height", $(window).height() -
                $(this).offset().top -
                $(this).attr("data-padding-bottom"));
        });
    }

    var loadCSInternal = function(id){
        $("#codebody").html($("#loading").clone().removeClass("hide"));
        Sijax.request('cloneset', [id]);  
    }

    var loadCloneset = function(id){
        loadCSInternal(id);  
        
        currentUrl = window.location.href;
        baseUrl = currentUrl.replace(/\?.*$/,"");
        newUrl = baseUrl+"?cs="+id
        window.history.pushState({"csid":id},"",newUrl);
    }
    window.onpopstate = function(e){
        if(e.state){
            loadCSInternal(e.state.csid);
            $("#clonesets").accordion("activate","#cs-"+e.state.csid);
        }
    };

    $(document).ready(function () {
        $(window).resize(reheight);
        $("a[name='c0-271']")[0].scrollIntoView();
        $("a[name='c1-307']")[0].scrollIntoView();
        reheight();

    });
</script>

<style type="text/css">

    .fcfcfcccffccfcf{
    }

    .tokenseq{
        overflow: auto;
        max-height: 80px;
        background-color: rgb(240,240,240);
        font-size: x-small;
        width: 100%;
    }

    .scrollbox{
        overflow-y: auto;
        top: 0;
        left: 0;
    }

    .marked{
        color: blue;
    }

    .unmarked{
        color: red;
    }

    .unknown{
        color: black;
    }

    .selected{
        font-style: italic;
        font-weight: bolder;
    }


    .scrollable-sections-top-shadow {
        background-image: -moz-radial-gradient(center top , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-top: 1px solid rgba(0, 0, 0, 0.4);
        top: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative;

    }

    .scrollable-sections-bottom-shadow {
        background-image: -moz-radial-gradient(center bottom , ellipse farthest-side, rgba(0, 0, 0, 0.3), transparent);
        border-bottom: 1px solid rgba(0, 0, 0, 0.4);
        bottom: 0;
        height: 8px;
        left: 0;
        margin-right: 0;
        position: relative; 
    }

    .scrollable-holder {
        position: relative;
        float: left; 
    }

    .processbar{
        float: left; 
        height: 1em;
        width: 100%;
        position: relative;
        background-color: white;
        border: 1px solid black; 
    }

    .processbar-value{
        height: 1em;
        position: absolute;
        left: 0;
    }

    .processbar-blue{
        color: #ffffff;
        background-color: #0064cd;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
        background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
        background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
        background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
        background-image: -o-linear-gradient(top, #049cdb, #0064cd);
        background-image: linear-gradient(top, #049cdb, #0064cd);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#049cdb', endColorstr='#0064cd', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #0064cd #0064cd #003f81;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }



    .processbar-red{
        background-color: #c43c35;
        background-repeat: repeat-x;
        background-image: -khtml-gradient(linear, left top, left bottom, from(#ee5f5b), to(#c43c35));
        background-image: -moz-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -ms-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #ee5f5b), color-stop(100%, #c43c35));
        background-image: -webkit-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: -o-linear-gradient(top, #ee5f5b, #c43c35);
        background-image: linear-gradient(top, #ee5f5b, #c43c35);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ee5f5b', endColorstr='#c43c35', GradientType=0);
        text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        border-color: #c43c35 #c43c35 #882a25;
        border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
    }

</style>


    </head>

  <table>
    <tr>
        <th><a href="http://localhost/project/4f1f687db61c5411ac000671?cs=4f1f687db61c5411ac000681">73</a></th>
        

        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        

        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn danger small"><i class="icon-check-empty icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
        <td>
            
            <a class="btn primary small"><i class="icon-check icon-large"></i>
            
        </a></td>
        
    </tr></table>

    <body>
<div id="codebox-container">
        
        <div class="codebox" style="width: 50%; ">
            <h3> xdiff/xhistogram.c 
                <small> (273,12)-(287,2)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-0" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c0-1"></a><span class="lineno">  1</span> <span class="cm">/*</span>
<a name="c0-2"></a><span class="lineno">  2</span> <span class="cm"> * Copyright (C) 2010, Google Inc.</span>
<a name="c0-3"></a><span class="lineno">  3</span> <span class="cm"> * and other copyright owners as documented in JGit's IP log.</span>
<a name="c0-4"></a><span class="lineno">  4</span> <span class="cm"> *</span>
<a name="c0-5"></a><span class="lineno">  5</span> <span class="cm"> * This program and the accompanying materials are made available</span>
<a name="c0-6"></a><span class="lineno">  6</span> <span class="cm"> * under the terms of the Eclipse Distribution License v1.0 which</span>
<a name="c0-7"></a><span class="lineno">  7</span> <span class="cm"> * accompanies this distribution, is reproduced below, and is</span>
<a name="c0-8"></a><span class="lineno">  8</span> <span class="cm"> * available at http://www.eclipse.org/org/documents/edl-v10.php</span>
<a name="c0-9"></a><span class="lineno">  9</span> <span class="cm"> *</span>
<a name="c0-10"></a><span class="lineno"> 10</span> <span class="cm"> * All rights reserved.</span>
<a name="c0-11"></a><span class="lineno"> 11</span> <span class="cm"> *</span>
<a name="c0-12"></a><span class="lineno"> 12</span> <span class="cm"> * Redistribution and use in source and binary forms, with or</span>
<a name="c0-13"></a><span class="lineno"> 13</span> <span class="cm"> * without modification, are permitted provided that the following</span>
<a name="c0-14"></a><span class="lineno"> 14</span> <span class="cm"> * conditions are met:</span>
<a name="c0-15"></a><span class="lineno"> 15</span> <span class="cm"> *</span>
<a name="c0-16"></a><span class="lineno"> 16</span> <span class="cm"> * - Redistributions of source code must retain the above copyright</span>
<a name="c0-17"></a><span class="lineno"> 17</span> <span class="cm"> *   notice, this list of conditions and the following disclaimer.</span>
<a name="c0-18"></a><span class="lineno"> 18</span> <span class="cm"> *</span>
<a name="c0-19"></a><span class="lineno"> 19</span> <span class="cm"> * - Redistributions in binary form must reproduce the above</span>
<a name="c0-20"></a><span class="lineno"> 20</span> <span class="cm"> *   copyright notice, this list of conditions and the following</span>
<a name="c0-21"></a><span class="lineno"> 21</span> <span class="cm"> *   disclaimer in the documentation and/or other materials provided</span>
<a name="c0-22"></a><span class="lineno"> 22</span> <span class="cm"> *   with the distribution.</span>
<a name="c0-23"></a><span class="lineno"> 23</span> <span class="cm"> *</span>
<a name="c0-24"></a><span class="lineno"> 24</span> <span class="cm"> * - Neither the name of the Eclipse Foundation, Inc. nor the</span>
<a name="c0-25"></a><span class="lineno"> 25</span> <span class="cm"> *   names of its contributors may be used to endorse or promote</span>
<a name="c0-26"></a><span class="lineno"> 26</span> <span class="cm"> *   products derived from this software without specific prior</span>
<a name="c0-27"></a><span class="lineno"> 27</span> <span class="cm"> *   written permission.</span>
<a name="c0-28"></a><span class="lineno"> 28</span> <span class="cm"> *</span>
<a name="c0-29"></a><span class="lineno"> 29</span> <span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND</span>
<a name="c0-30"></a><span class="lineno"> 30</span> <span class="cm"> * CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,</span>
<a name="c0-31"></a><span class="lineno"> 31</span> <span class="cm"> * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<a name="c0-32"></a><span class="lineno"> 32</span> <span class="cm"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="c0-33"></a><span class="lineno"> 33</span> <span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<a name="c0-34"></a><span class="lineno"> 34</span> <span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="c0-35"></a><span class="lineno"> 35</span> <span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<a name="c0-36"></a><span class="lineno"> 36</span> <span class="cm"> * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="c0-37"></a><span class="lineno"> 37</span> <span class="cm"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="c0-38"></a><span class="lineno"> 38</span> <span class="cm"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<a name="c0-39"></a><span class="lineno"> 39</span> <span class="cm"> * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="c0-40"></a><span class="lineno"> 40</span> <span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF</span>
<a name="c0-41"></a><span class="lineno"> 41</span> <span class="cm"> * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="c0-42"></a><span class="lineno"> 42</span> <span class="cm"> */</span>
<a name="c0-43"></a><span class="lineno"> 43</span> 
<a name="c0-44"></a><span class="lineno"> 44</span> <span class="cp">#include "xinclude.h"</span>
<a name="c0-45"></a><span class="lineno"> 45</span> <span class="cp">#include "xtypes.h"</span>
<a name="c0-46"></a><span class="lineno"> 46</span> <span class="cp">#include "xdiff.h"</span>
<a name="c0-47"></a><span class="lineno"> 47</span> 
<a name="c0-48"></a><span class="lineno"> 48</span> <span class="cp">#define MAX_PTR  UINT_MAX</span>
<a name="c0-49"></a><span class="lineno"> 49</span> <span class="cp">#define MAX_CNT  UINT_MAX</span>
<a name="c0-50"></a><span class="lineno"> 50</span> 
<a name="c0-51"></a><span class="lineno"> 51</span> <span class="cp">#define LINE_END(n) (line##n + count##n - 1)</span>
<a name="c0-52"></a><span class="lineno"> 52</span> <span class="cp">#define LINE_END_PTR(n) (*line##n + *count##n - 1)</span>
<a name="c0-53"></a><span class="lineno"> 53</span> 
<a name="c0-54"></a><span class="lineno"> 54</span> <span class="k">struct</span> <span class="n">histindex</span> <span class="p">{</span>
<a name="c0-55"></a><span class="lineno"> 55</span>   <span class="k">struct</span> <span class="n">record</span> <span class="p">{</span>
<a name="c0-56"></a><span class="lineno"> 56</span>     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
<a name="c0-57"></a><span class="lineno"> 57</span>     <span class="k">struct</span> <span class="n">record</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<a name="c0-58"></a><span class="lineno"> 58</span>   <span class="p">}</span> <span class="o">**</span><span class="n">records</span><span class="p">,</span> <span class="cm">/* an ocurrence */</span>
<a name="c0-59"></a><span class="lineno"> 59</span>     <span class="o">**</span><span class="n">line_map</span><span class="p">;</span> <span class="cm">/* map of line to record chain */</span>
<a name="c0-60"></a><span class="lineno"> 60</span>   <span class="n">chastore_t</span> <span class="n">rcha</span><span class="p">;</span>
<a name="c0-61"></a><span class="lineno"> 61</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">next_ptrs</span><span class="p">;</span>
<a name="c0-62"></a><span class="lineno"> 62</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">table_bits</span><span class="p">,</span>
<a name="c0-63"></a><span class="lineno"> 63</span>          <span class="n">records_size</span><span class="p">,</span>
<a name="c0-64"></a><span class="lineno"> 64</span>          <span class="n">line_map_size</span><span class="p">;</span>
<a name="c0-65"></a><span class="lineno"> 65</span> 
<a name="c0-66"></a><span class="lineno"> 66</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_chain_length</span><span class="p">,</span>
<a name="c0-67"></a><span class="lineno"> 67</span>          <span class="n">key_shift</span><span class="p">,</span>
<a name="c0-68"></a><span class="lineno"> 68</span>          <span class="n">ptr_shift</span><span class="p">;</span>
<a name="c0-69"></a><span class="lineno"> 69</span> 
<a name="c0-70"></a><span class="lineno"> 70</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span>
<a name="c0-71"></a><span class="lineno"> 71</span>          <span class="n">has_common</span><span class="p">;</span>
<a name="c0-72"></a><span class="lineno"> 72</span> 
<a name="c0-73"></a><span class="lineno"> 73</span>   <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">;</span>
<a name="c0-74"></a><span class="lineno"> 74</span>   <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">;</span>
<a name="c0-75"></a><span class="lineno"> 75</span> <span class="p">};</span>
<a name="c0-76"></a><span class="lineno"> 76</span> 
<a name="c0-77"></a><span class="lineno"> 77</span> <span class="k">struct</span> <span class="n">region</span> <span class="p">{</span>
<a name="c0-78"></a><span class="lineno"> 78</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">begin1</span><span class="p">,</span> <span class="n">end1</span><span class="p">;</span>
<a name="c0-79"></a><span class="lineno"> 79</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">begin2</span><span class="p">,</span> <span class="n">end2</span><span class="p">;</span>
<a name="c0-80"></a><span class="lineno"> 80</span> <span class="p">};</span>
<a name="c0-81"></a><span class="lineno"> 81</span> 
<a name="c0-82"></a><span class="lineno"> 82</span> <span class="cp">#define LINE_MAP(i, a) (i-&gt;line_map[(a) - i-&gt;ptr_shift])</span>
<a name="c0-83"></a><span class="lineno"> 83</span> 
<a name="c0-84"></a><span class="lineno"> 84</span> <span class="cp">#define NEXT_PTR(index, ptr) \</span>
<a name="c0-85"></a><span class="lineno"> 85</span> <span class="cp"> (index-&gt;next_ptrs[(ptr) - index-&gt;ptr_shift])</span>
<a name="c0-86"></a><span class="lineno"> 86</span> 
<a name="c0-87"></a><span class="lineno"> 87</span> <span class="cp">#define CNT(index, ptr) \</span>
<a name="c0-88"></a><span class="lineno"> 88</span> <span class="cp"> ((LINE_MAP(index, ptr))-&gt;cnt)</span>
<a name="c0-89"></a><span class="lineno"> 89</span> 
<a name="c0-90"></a><span class="lineno"> 90</span> <span class="cp">#define REC(env, s, l) \</span>
<a name="c0-91"></a><span class="lineno"> 91</span> <span class="cp"> (env-&gt;xdf##s.recs[l - 1])</span>
<a name="c0-92"></a><span class="lineno"> 92</span> 
<a name="c0-93"></a><span class="lineno"> 93</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_recs</span><span class="p">(</span><span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span>
<a name="c0-94"></a><span class="lineno"> 94</span>   <span class="n">xrecord_t</span> <span class="o">*</span><span class="n">r1</span><span class="p">,</span> <span class="n">xrecord_t</span> <span class="o">*</span><span class="n">r2</span><span class="p">)</span>
<a name="c0-95"></a><span class="lineno"> 95</span> <span class="p">{</span>
<a name="c0-96"></a><span class="lineno"> 96</span>   <span class="k">return</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">==</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">&amp;&amp;</span>
<a name="c0-97"></a><span class="lineno"> 97</span>     <span class="n">xdl_recmatch</span><span class="p">(</span><span class="n">r1</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">r1</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">r2</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
<a name="c0-98"></a><span class="lineno"> 98</span>           <span class="n">xpp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<a name="c0-99"></a><span class="lineno"> 99</span> <span class="p">}</span>
<a name="c0-100"></a><span class="lineno">100</span> 
<a name="c0-101"></a><span class="lineno">101</span> <span class="cp">#define CMP_ENV(xpp, env, s1, l1, s2, l2) \</span>
<a name="c0-102"></a><span class="lineno">102</span> <span class="cp">  (cmp_recs(xpp, REC(env, s1, l1), REC(env, s2, l2)))</span>
<a name="c0-103"></a><span class="lineno">103</span> 
<a name="c0-104"></a><span class="lineno">104</span> <span class="cp">#define CMP(i, s1, l1, s2, l2) \</span>
<a name="c0-105"></a><span class="lineno">105</span> <span class="cp">  (cmp_recs(i-&gt;xpp, REC(i-&gt;env, s1, l1), REC(i-&gt;env, s2, l2)))</span>
<a name="c0-106"></a><span class="lineno">106</span> 
<a name="c0-107"></a><span class="lineno">107</span> <span class="cp">#define TABLE_HASH(index, side, line) \</span>
<a name="c0-108"></a><span class="lineno">108</span> <span class="cp">  XDL_HASHLONG((REC(index-&gt;env, side, line))-&gt;ha, index-&gt;table_bits)</span>
<a name="c0-109"></a><span class="lineno">109</span> 
<a name="c0-110"></a><span class="lineno">110</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">scanA</span><span class="p">(</span><span class="k">struct</span> <span class="n">histindex</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">)</span>
<a name="c0-111"></a><span class="lineno">111</span> <span class="p">{</span>
<a name="c0-112"></a><span class="lineno">112</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">tbl_idx</span><span class="p">;</span>
<a name="c0-113"></a><span class="lineno">113</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chain_len</span><span class="p">;</span>
<a name="c0-114"></a><span class="lineno">114</span>  <span class="k">struct</span> <span class="n">record</span> <span class="o">**</span><span class="n">rec_chain</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>
<a name="c0-115"></a><span class="lineno">115</span> 
<a name="c0-116"></a><span class="lineno">116</span>  <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">LINE_END</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">line1</span> <span class="o">&lt;=</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-117"></a><span class="lineno">117</span>    <span class="n">tbl_idx</span> <span class="o">=</span> <span class="n">TABLE_HASH</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<a name="c0-118"></a><span class="lineno">118</span>    <span class="n">rec_chain</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">records</span> <span class="o">+</span> <span class="n">tbl_idx</span><span class="p">;</span>
<a name="c0-119"></a><span class="lineno">119</span>    <span class="n">rec</span> <span class="o">=</span> <span class="o">*</span><span class="n">rec_chain</span><span class="p">;</span>
<a name="c0-120"></a><span class="lineno">120</span> 
<a name="c0-121"></a><span class="lineno">121</span>    <span class="n">chain_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-122"></a><span class="lineno">122</span>    <span class="k">while</span> <span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-123"></a><span class="lineno">123</span>      <span class="k">if</span> <span class="p">(</span><span class="n">CMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-124"></a><span class="lineno">124</span>        <span class="cm">/*</span>
<a name="c0-125"></a><span class="lineno">125</span> <span class="cm">         * ptr is identical to another element. Insert</span>
<a name="c0-126"></a><span class="lineno">126</span> <span class="cm">         * it onto the front of the existing element</span>
<a name="c0-127"></a><span class="lineno">127</span> <span class="cm">         * chain.</span>
<a name="c0-128"></a><span class="lineno">128</span> <span class="cm">         */</span>
<a name="c0-129"></a><span class="lineno">129</span>        <span class="n">NEXT_PTR</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
<a name="c0-130"></a><span class="lineno">130</span>        <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<a name="c0-131"></a><span class="lineno">131</span>        <span class="cm">/* cap rec-&gt;cnt at MAX_CNT */</span>
<a name="c0-132"></a><span class="lineno">132</span>        <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">XDL_MIN</span><span class="p">(</span><span class="n">MAX_CNT</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-133"></a><span class="lineno">133</span>        <span class="n">LINE_MAP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
<a name="c0-134"></a><span class="lineno">134</span>        <span class="k">goto</span> <span class="n">continue_scan</span><span class="p">;</span>
<a name="c0-135"></a><span class="lineno">135</span>      <span class="p">}</span>
<a name="c0-136"></a><span class="lineno">136</span> 
<a name="c0-137"></a><span class="lineno">137</span>      <span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c0-138"></a><span class="lineno">138</span>      <span class="n">chain_len</span><span class="o">++</span><span class="p">;</span>
<a name="c0-139"></a><span class="lineno">139</span>    <span class="p">}</span>
<a name="c0-140"></a><span class="lineno">140</span> 
<a name="c0-141"></a><span class="lineno">141</span>    <span class="k">if</span> <span class="p">(</span><span class="n">chain_len</span> <span class="o">==</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">max_chain_length</span><span class="p">)</span>
<a name="c0-142"></a><span class="lineno">142</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-143"></a><span class="lineno">143</span> 
<a name="c0-144"></a><span class="lineno">144</span>    <span class="cm">/*</span>
<a name="c0-145"></a><span class="lineno">145</span> <span class="cm">     * This is the first time we have ever seen this particular</span>
<a name="c0-146"></a><span class="lineno">146</span> <span class="cm">     * element in the sequence. Construct a new chain for it.</span>
<a name="c0-147"></a><span class="lineno">147</span> <span class="cm">     */</span>
<a name="c0-148"></a><span class="lineno">148</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rec</span> <span class="o">=</span> <span class="n">xdl_cha_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="o">-&gt;</span><span class="n">rcha</span><span class="p">)))</span>
<a name="c0-149"></a><span class="lineno">149</span>      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-150"></a><span class="lineno">150</span>    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<a name="c0-151"></a><span class="lineno">151</span>    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-152"></a><span class="lineno">152</span>    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">rec_chain</span><span class="p">;</span>
<a name="c0-153"></a><span class="lineno">153</span>    <span class="o">*</span><span class="n">rec_chain</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
<a name="c0-154"></a><span class="lineno">154</span>    <span class="n">LINE_MAP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
<a name="c0-155"></a><span class="lineno">155</span> 
<a name="c0-156"></a><span class="lineno">156</span> <span class="nl">continue_scan:</span>
<a name="c0-157"></a><span class="lineno">157</span>    <span class="p">;</span> <span class="cm">/* no op */</span>
<a name="c0-158"></a><span class="lineno">158</span>  <span class="p">}</span>
<a name="c0-159"></a><span class="lineno">159</span> 
<a name="c0-160"></a><span class="lineno">160</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-161"></a><span class="lineno">161</span> <span class="p">}</span>
<a name="c0-162"></a><span class="lineno">162</span> 
<a name="c0-163"></a><span class="lineno">163</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">try_lcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">histindex</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">region</span> <span class="o">*</span><span class="n">lcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b_ptr</span><span class="p">,</span>
<a name="c0-164"></a><span class="lineno">164</span>  <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c0-165"></a><span class="lineno">165</span> <span class="p">{</span>
<a name="c0-166"></a><span class="lineno">166</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b_next</span> <span class="o">=</span> <span class="n">b_ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-167"></a><span class="lineno">167</span>  <span class="k">struct</span> <span class="n">record</span> <span class="o">*</span><span class="n">rec</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="n">TABLE_HASH</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b_ptr</span><span class="p">)];</span>
<a name="c0-168"></a><span class="lineno">168</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">as</span><span class="p">,</span> <span class="n">ae</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
<a name="c0-169"></a><span class="lineno">169</span>  <span class="kt">int</span> <span class="n">should_break</span><span class="p">;</span>
<a name="c0-170"></a><span class="lineno">170</span> 
<a name="c0-171"></a><span class="lineno">171</span>  <span class="k">for</span> <span class="p">(;</span> <span class="n">rec</span><span class="p">;</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-172"></a><span class="lineno">172</span>    <span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-173"></a><span class="lineno">173</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">index</span><span class="o">-&gt;</span><span class="n">has_common</span><span class="p">)</span>
<a name="c0-174"></a><span class="lineno">174</span>        <span class="n">index</span><span class="o">-&gt;</span><span class="n">has_common</span> <span class="o">=</span> <span class="n">CMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b_ptr</span><span class="p">);</span>
<a name="c0-175"></a><span class="lineno">175</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-176"></a><span class="lineno">176</span>    <span class="p">}</span>
<a name="c0-177"></a><span class="lineno">177</span> 
<a name="c0-178"></a><span class="lineno">178</span>    <span class="n">as</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
<a name="c0-179"></a><span class="lineno">179</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b_ptr</span><span class="p">))</span>
<a name="c0-180"></a><span class="lineno">180</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c0-181"></a><span class="lineno">181</span> 
<a name="c0-182"></a><span class="lineno">182</span>    <span class="n">index</span><span class="o">-&gt;</span><span class="n">has_common</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-183"></a><span class="lineno">183</span>    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c0-184"></a><span class="lineno">184</span>      <span class="n">should_break</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-185"></a><span class="lineno">185</span>      <span class="n">np</span> <span class="o">=</span> <span class="n">NEXT_PTR</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
<a name="c0-186"></a><span class="lineno">186</span>      <span class="n">bs</span> <span class="o">=</span> <span class="n">b_ptr</span><span class="p">;</span>
<a name="c0-187"></a><span class="lineno">187</span>      <span class="n">ae</span> <span class="o">=</span> <span class="n">as</span><span class="p">;</span>
<a name="c0-188"></a><span class="lineno">188</span>      <span class="n">be</span> <span class="o">=</span> <span class="n">bs</span><span class="p">;</span>
<a name="c0-189"></a><span class="lineno">189</span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span>
<a name="c0-190"></a><span class="lineno">190</span> 
<a name="c0-191"></a><span class="lineno">191</span>      <span class="k">while</span> <span class="p">(</span><span class="n">line1</span> <span class="o">&lt;</span> <span class="n">as</span> <span class="o">&amp;&amp;</span> <span class="n">line2</span> <span class="o">&lt;</span> <span class="n">bs</span>
<a name="c0-192"></a><span class="lineno">192</span>        <span class="o">&amp;&amp;</span> <span class="n">CMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">as</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-193"></a><span class="lineno">193</span>        <span class="n">as</span><span class="o">--</span><span class="p">;</span>
<a name="c0-194"></a><span class="lineno">194</span>        <span class="n">bs</span><span class="o">--</span><span class="p">;</span>
<a name="c0-195"></a><span class="lineno">195</span>        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="p">)</span>
<a name="c0-196"></a><span class="lineno">196</span>          <span class="n">rc</span> <span class="o">=</span> <span class="n">XDL_MIN</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">CNT</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">as</span><span class="p">));</span>
<a name="c0-197"></a><span class="lineno">197</span>      <span class="p">}</span>
<a name="c0-198"></a><span class="lineno">198</span>      <span class="k">while</span> <span class="p">(</span><span class="n">ae</span> <span class="o">&lt;</span> <span class="n">LINE_END</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">be</span> <span class="o">&lt;</span> <span class="n">LINE_END</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="c0-199"></a><span class="lineno">199</span>        <span class="o">&amp;&amp;</span> <span class="n">CMP</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ae</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">be</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
<a name="c0-200"></a><span class="lineno">200</span>        <span class="n">ae</span><span class="o">++</span><span class="p">;</span>
<a name="c0-201"></a><span class="lineno">201</span>        <span class="n">be</span><span class="o">++</span><span class="p">;</span>
<a name="c0-202"></a><span class="lineno">202</span>        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="p">)</span>
<a name="c0-203"></a><span class="lineno">203</span>          <span class="n">rc</span> <span class="o">=</span> <span class="n">XDL_MIN</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">CNT</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ae</span><span class="p">));</span>
<a name="c0-204"></a><span class="lineno">204</span>      <span class="p">}</span>
<a name="c0-205"></a><span class="lineno">205</span> 
<a name="c0-206"></a><span class="lineno">206</span>      <span class="k">if</span> <span class="p">(</span><span class="n">b_next</span> <span class="o">&lt;=</span> <span class="n">be</span><span class="p">)</span>
<a name="c0-207"></a><span class="lineno">207</span>        <span class="n">b_next</span> <span class="o">=</span> <span class="n">be</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-208"></a><span class="lineno">208</span>      <span class="k">if</span> <span class="p">(</span><span class="n">lcs</span><span class="o">-&gt;</span><span class="n">end1</span> <span class="o">-</span> <span class="n">lcs</span><span class="o">-&gt;</span><span class="n">begin1</span> <span class="o">&lt;</span> <span class="n">ae</span> <span class="o">-</span> <span class="n">as</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">&lt;</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-209"></a><span class="lineno">209</span>        <span class="n">lcs</span><span class="o">-&gt;</span><span class="n">begin1</span> <span class="o">=</span> <span class="n">as</span><span class="p">;</span>
<a name="c0-210"></a><span class="lineno">210</span>        <span class="n">lcs</span><span class="o">-&gt;</span><span class="n">begin2</span> <span class="o">=</span> <span class="n">bs</span><span class="p">;</span>
<a name="c0-211"></a><span class="lineno">211</span>        <span class="n">lcs</span><span class="o">-&gt;</span><span class="n">end1</span> <span class="o">=</span> <span class="n">ae</span><span class="p">;</span>
<a name="c0-212"></a><span class="lineno">212</span>        <span class="n">lcs</span><span class="o">-&gt;</span><span class="n">end2</span> <span class="o">=</span> <span class="n">be</span><span class="p">;</span>
<a name="c0-213"></a><span class="lineno">213</span>        <span class="n">index</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
<a name="c0-214"></a><span class="lineno">214</span>      <span class="p">}</span>
<a name="c0-215"></a><span class="lineno">215</span> 
<a name="c0-216"></a><span class="lineno">216</span>      <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-217"></a><span class="lineno">217</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-218"></a><span class="lineno">218</span> 
<a name="c0-219"></a><span class="lineno">219</span>      <span class="k">while</span> <span class="p">(</span><span class="n">np</span> <span class="o">&lt;=</span> <span class="n">ae</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-220"></a><span class="lineno">220</span>        <span class="n">np</span> <span class="o">=</span> <span class="n">NEXT_PTR</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>
<a name="c0-221"></a><span class="lineno">221</span>        <span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-222"></a><span class="lineno">222</span>          <span class="n">should_break</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-223"></a><span class="lineno">223</span>          <span class="k">break</span><span class="p">;</span>
<a name="c0-224"></a><span class="lineno">224</span>        <span class="p">}</span>
<a name="c0-225"></a><span class="lineno">225</span>      <span class="p">}</span>
<a name="c0-226"></a><span class="lineno">226</span> 
<a name="c0-227"></a><span class="lineno">227</span>      <span class="k">if</span> <span class="p">(</span><span class="n">should_break</span><span class="p">)</span>
<a name="c0-228"></a><span class="lineno">228</span>        <span class="k">break</span><span class="p">;</span>
<a name="c0-229"></a><span class="lineno">229</span> 
<a name="c0-230"></a><span class="lineno">230</span>      <span class="n">as</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
<a name="c0-231"></a><span class="lineno">231</span>    <span class="p">}</span>
<a name="c0-232"></a><span class="lineno">232</span>  <span class="p">}</span>
<a name="c0-233"></a><span class="lineno">233</span>  <span class="k">return</span> <span class="n">b_next</span><span class="p">;</span>
<a name="c0-234"></a><span class="lineno">234</span> <span class="p">}</span>
<a name="c0-235"></a><span class="lineno">235</span> 
<a name="c0-236"></a><span class="lineno">236</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">find_lcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">histindex</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">region</span> <span class="o">*</span><span class="n">lcs</span><span class="p">,</span>
<a name="c0-237"></a><span class="lineno">237</span>  <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-238"></a><span class="lineno">238</span>  <span class="kt">int</span> <span class="n">b_ptr</span><span class="p">;</span>
<a name="c0-239"></a><span class="lineno">239</span> 
<a name="c0-240"></a><span class="lineno">240</span>  <span class="k">if</span> <span class="p">(</span><span class="n">scanA</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">))</span>
<a name="c0-241"></a><span class="lineno">241</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-242"></a><span class="lineno">242</span> 
<a name="c0-243"></a><span class="lineno">243</span>  <span class="n">index</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">max_chain_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-244"></a><span class="lineno">244</span> 
<a name="c0-245"></a><span class="lineno">245</span>  <span class="k">for</span> <span class="p">(</span><span class="n">b_ptr</span> <span class="o">=</span> <span class="n">line2</span><span class="p">;</span> <span class="n">b_ptr</span> <span class="o">&lt;=</span> <span class="n">LINE_END</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="p">)</span>
<a name="c0-246"></a><span class="lineno">246</span>    <span class="n">b_ptr</span> <span class="o">=</span> <span class="n">try_lcs</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">lcs</span><span class="p">,</span> <span class="n">b_ptr</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<a name="c0-247"></a><span class="lineno">247</span> 
<a name="c0-248"></a><span class="lineno">248</span>  <span class="k">return</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">has_common</span> <span class="o">&amp;&amp;</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">max_chain_length</span> <span class="o">&lt;</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span>
<a name="c0-249"></a><span class="lineno">249</span> <span class="p">}</span>
<a name="c0-250"></a><span class="lineno">250</span> 
<a name="c0-251"></a><span class="lineno">251</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fall_back_to_classic_diff</span><span class="p">(</span><span class="k">struct</span> <span class="n">histindex</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span>
<a name="c0-252"></a><span class="lineno">252</span>    <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c0-253"></a><span class="lineno">253</span> <span class="p">{</span>
<a name="c0-254"></a><span class="lineno">254</span>  <span class="n">xpparam_t</span> <span class="n">xpp</span><span class="p">;</span>
<a name="c0-255"></a><span class="lineno">255</span>  <span class="n">xpp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">xpp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XDF_HISTOGRAM_DIFF</span><span class="p">;</span>
<a name="c0-256"></a><span class="lineno">256</span> 
<a name="c0-257"></a><span class="lineno">257</span>  <span class="k">return</span> <span class="n">xdl_fall_back_diff</span><span class="p">(</span><span class="n">index</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xpp</span><span class="p">,</span>
<a name="c0-258"></a><span class="lineno">258</span>          <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<a name="c0-259"></a><span class="lineno">259</span> <span class="p">}</span>
<a name="c0-260"></a><span class="lineno">260</span> 
<a name="c0-261"></a><span class="lineno">261</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">histogram_diff</span><span class="p">(</span><span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span> <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
<a name="c0-262"></a><span class="lineno">262</span>  <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c0-263"></a><span class="lineno">263</span> <span class="p">{</span>
<a name="c0-264"></a><span class="lineno">264</span>  <span class="k">struct</span> <span class="n">histindex</span> <span class="n">index</span><span class="p">;</span>
<a name="c0-265"></a><span class="lineno">265</span>  <span class="k">struct</span> <span class="n">region</span> <span class="n">lcs</span><span class="p">;</span>
<a name="c0-266"></a><span class="lineno">266</span>  <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
<a name="c0-267"></a><span class="lineno">267</span>  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-268"></a><span class="lineno">268</span> 
<a name="c0-269"></a><span class="lineno">269</span>  <span class="k">if</span> <span class="p">(</span><span class="n">count1</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-270"></a><span class="lineno">270</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-271"></a><span class="lineno">271</span> 
<a name="c0-272"></a><span class="lineno">272</span>  <span class="k">if</span> <span class="p">(</span><span class="n">LINE_END</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_PTR</span><span class="p">)</span>
<a name="c0-273"></a><span class="lineno">273</span> <span class="hll">   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><a name="c0-274"></a><span class="lineno">274</span> <span class="hll">
</span><a name="c0-275"></a><span class="lineno">275</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count1</span><span class="p">)</span> <span class="p">{</span>
</span><a name="c0-276"></a><span class="lineno">276</span> <span class="hll">    <span class="k">while</span><span class="p">(</span><span class="n">count2</span><span class="o">--</span><span class="p">)</span>
</span><a name="c0-277"></a><span class="lineno">277</span> <span class="hll">      <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line2</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c0-278"></a><span class="lineno">278</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c0-279"></a><span class="lineno">279</span> <span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count2</span><span class="p">)</span> <span class="p">{</span>
</span><a name="c0-280"></a><span class="lineno">280</span> <span class="hll">    <span class="k">while</span><span class="p">(</span><span class="n">count1</span><span class="o">--</span><span class="p">)</span>
</span><a name="c0-281"></a><span class="lineno">281</span> <span class="hll">      <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line1</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c0-282"></a><span class="lineno">282</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c0-283"></a><span class="lineno">283</span> <span class="hll">  <span class="p">}</span>
</span><a name="c0-284"></a><span class="lineno">284</span> <span class="hll">
</span><a name="c0-285"></a><span class="lineno">285</span> <span class="hll">  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span><a name="c0-286"></a><span class="lineno">286</span> <span class="hll">
</span><a name="c0-287"></a><span class="lineno">287</span> <span class="hll">  <span class="n">index</span><span class="p">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="p">;</span>
</span><a name="c0-288"></a><span class="lineno">288</span>   <span class="n">index</span><span class="p">.</span><span class="n">xpp</span> <span class="o">=</span> <span class="n">xpp</span><span class="p">;</span>
<a name="c0-289"></a><span class="lineno">289</span> 
<a name="c0-290"></a><span class="lineno">290</span>  <span class="n">index</span><span class="p">.</span><span class="n">records</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-291"></a><span class="lineno">291</span>  <span class="n">index</span><span class="p">.</span><span class="n">line_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-292"></a><span class="lineno">292</span>  <span class="cm">/* in case of early xdl_cha_free() */</span>
<a name="c0-293"></a><span class="lineno">293</span>  <span class="n">index</span><span class="p">.</span><span class="n">rcha</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c0-294"></a><span class="lineno">294</span> 
<a name="c0-295"></a><span class="lineno">295</span>  <span class="n">index</span><span class="p">.</span><span class="n">table_bits</span> <span class="o">=</span> <span class="n">xdl_hashbits</span><span class="p">(</span><span class="n">count1</span><span class="p">);</span>
<a name="c0-296"></a><span class="lineno">296</span>  <span class="n">sz</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">records_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">.</span><span class="n">table_bits</span><span class="p">;</span>
<a name="c0-297"></a><span class="lineno">297</span>  <span class="n">sz</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">record</span> <span class="o">*</span><span class="p">);</span>
<a name="c0-298"></a><span class="lineno">298</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">records</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">record</span> <span class="o">**</span><span class="p">)</span> <span class="n">xdl_malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">)))</span>
<a name="c0-299"></a><span class="lineno">299</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-300"></a><span class="lineno">300</span>  <span class="n">memset</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">records</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<a name="c0-301"></a><span class="lineno">301</span> 
<a name="c0-302"></a><span class="lineno">302</span>  <span class="n">sz</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">line_map_size</span> <span class="o">=</span> <span class="n">count1</span><span class="p">;</span>
<a name="c0-303"></a><span class="lineno">303</span>  <span class="n">sz</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">record</span> <span class="o">*</span><span class="p">);</span>
<a name="c0-304"></a><span class="lineno">304</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">line_map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">record</span> <span class="o">**</span><span class="p">)</span> <span class="n">xdl_malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">)))</span>
<a name="c0-305"></a><span class="lineno">305</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-306"></a><span class="lineno">306</span>  <span class="n">memset</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">line_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<a name="c0-307"></a><span class="lineno">307</span> 
<a name="c0-308"></a><span class="lineno">308</span>  <span class="n">sz</span> <span class="o">=</span> <span class="n">index</span><span class="p">.</span><span class="n">line_map_size</span><span class="p">;</span>
<a name="c0-309"></a><span class="lineno">309</span>  <span class="n">sz</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<a name="c0-310"></a><span class="lineno">310</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">next_ptrs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">xdl_malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">)))</span>
<a name="c0-311"></a><span class="lineno">311</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-312"></a><span class="lineno">312</span>  <span class="n">memset</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">next_ptrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<a name="c0-313"></a><span class="lineno">313</span> 
<a name="c0-314"></a><span class="lineno">314</span>  <span class="cm">/* lines / 4 + 1 comes from xprepare.c:xdl_prepare_ctx() */</span>
<a name="c0-315"></a><span class="lineno">315</span>  <span class="k">if</span> <span class="p">(</span><span class="n">xdl_cha_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">.</span><span class="n">rcha</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">record</span><span class="p">),</span> <span class="n">count1</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-316"></a><span class="lineno">316</span>    <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-317"></a><span class="lineno">317</span> 
<a name="c0-318"></a><span class="lineno">318</span>  <span class="n">index</span><span class="p">.</span><span class="n">ptr_shift</span> <span class="o">=</span> <span class="n">line1</span><span class="p">;</span>
<a name="c0-319"></a><span class="lineno">319</span>  <span class="n">index</span><span class="p">.</span><span class="n">max_chain_length</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<a name="c0-320"></a><span class="lineno">320</span> 
<a name="c0-321"></a><span class="lineno">321</span>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcs</span><span class="p">));</span>
<a name="c0-322"></a><span class="lineno">322</span>  <span class="k">if</span> <span class="p">(</span><span class="n">find_lcs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcs</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">))</span>
<a name="c0-323"></a><span class="lineno">323</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">fall_back_to_classic_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<a name="c0-324"></a><span class="lineno">324</span>  <span class="k">else</span> <span class="p">{</span>
<a name="c0-325"></a><span class="lineno">325</span>    <span class="k">if</span> <span class="p">(</span><span class="n">lcs</span><span class="p">.</span><span class="n">begin1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lcs</span><span class="p">.</span><span class="n">begin2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="c0-326"></a><span class="lineno">326</span>      <span class="k">while</span> <span class="p">(</span><span class="n">count1</span><span class="o">--</span><span class="p">)</span>
<a name="c0-327"></a><span class="lineno">327</span>        <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line1</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-328"></a><span class="lineno">328</span>      <span class="k">while</span> <span class="p">(</span><span class="n">count2</span><span class="o">--</span><span class="p">)</span>
<a name="c0-329"></a><span class="lineno">329</span>        <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line2</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c0-330"></a><span class="lineno">330</span>      <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c0-331"></a><span class="lineno">331</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c0-332"></a><span class="lineno">332</span>      <span class="n">result</span> <span class="o">=</span> <span class="n">histogram_diff</span><span class="p">(</span><span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span>
<a name="c0-333"></a><span class="lineno">333</span>            <span class="n">line1</span><span class="p">,</span> <span class="n">lcs</span><span class="p">.</span><span class="n">begin1</span> <span class="o">-</span> <span class="n">line1</span><span class="p">,</span>
<a name="c0-334"></a><span class="lineno">334</span>            <span class="n">line2</span><span class="p">,</span> <span class="n">lcs</span><span class="p">.</span><span class="n">begin2</span> <span class="o">-</span> <span class="n">line2</span><span class="p">);</span>
<a name="c0-335"></a><span class="lineno">335</span>      <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a name="c0-336"></a><span class="lineno">336</span>        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-337"></a><span class="lineno">337</span>      <span class="n">result</span> <span class="o">=</span> <span class="n">histogram_diff</span><span class="p">(</span><span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span>
<a name="c0-338"></a><span class="lineno">338</span>            <span class="n">lcs</span><span class="p">.</span><span class="n">end1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LINE_END</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">lcs</span><span class="p">.</span><span class="n">end1</span><span class="p">,</span>
<a name="c0-339"></a><span class="lineno">339</span>            <span class="n">lcs</span><span class="p">.</span><span class="n">end2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LINE_END</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">lcs</span><span class="p">.</span><span class="n">end2</span><span class="p">);</span>
<a name="c0-340"></a><span class="lineno">340</span>      <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a name="c0-341"></a><span class="lineno">341</span>        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
<a name="c0-342"></a><span class="lineno">342</span>    <span class="p">}</span>
<a name="c0-343"></a><span class="lineno">343</span>  <span class="p">}</span>
<a name="c0-344"></a><span class="lineno">344</span> 
<a name="c0-345"></a><span class="lineno">345</span> <span class="nl">cleanup:</span>
<a name="c0-346"></a><span class="lineno">346</span>  <span class="n">xdl_free</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">records</span><span class="p">);</span>
<a name="c0-347"></a><span class="lineno">347</span>  <span class="n">xdl_free</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">line_map</span><span class="p">);</span>
<a name="c0-348"></a><span class="lineno">348</span>  <span class="n">xdl_free</span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">next_ptrs</span><span class="p">);</span>
<a name="c0-349"></a><span class="lineno">349</span>  <span class="n">xdl_cha_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">index</span><span class="p">.</span><span class="n">rcha</span><span class="p">);</span>
<a name="c0-350"></a><span class="lineno">350</span> 
<a name="c0-351"></a><span class="lineno">351</span>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="c0-352"></a><span class="lineno">352</span> <span class="p">}</span>
<a name="c0-353"></a><span class="lineno">353</span> 
<a name="c0-354"></a><span class="lineno">354</span> <span class="kt">int</span> <span class="nf">xdl_do_histogram_diff</span><span class="p">(</span><span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file1</span><span class="p">,</span> <span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file2</span><span class="p">,</span>
<a name="c0-355"></a><span class="lineno">355</span>  <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span> <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<a name="c0-356"></a><span class="lineno">356</span> <span class="p">{</span>
<a name="c0-357"></a><span class="lineno">357</span>  <span class="k">if</span> <span class="p">(</span><span class="n">xdl_prepare_env</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c0-358"></a><span class="lineno">358</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c0-359"></a><span class="lineno">359</span> 
<a name="c0-360"></a><span class="lineno">360</span>  <span class="k">return</span> <span class="n">histogram_diff</span><span class="p">(</span><span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span>
<a name="c0-361"></a><span class="lineno">361</span>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">dstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">dend</span> <span class="o">-</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">dstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a name="c0-362"></a><span class="lineno">362</span>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">dstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">dend</span> <span class="o">-</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">dstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="c0-363"></a><span class="lineno">363</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
        <div class="codebox" style="width: 50%; ">
            <h3> xdiff/xpatience.c 
                <small> (309,16)-(323,2)
                </small>
            </h3>
            
            <div class="scrollable-holder">
                <div class="scrollable-sections-top-shadow" style="opacity: 5.5;"></div>
                <div class="scrollbox" data-padding-bottom="20" id="code-scrollbox-1" style="max-height: 734px; ">
                    <div class="highlight"><pre><a name="c1-1"></a><span class="lineno">  1</span> <span class="cm">/*</span>
<a name="c1-2"></a><span class="lineno">  2</span> <span class="cm"> *  LibXDiff by Davide Libenzi ( File Differential Library )</span>
<a name="c1-3"></a><span class="lineno">  3</span> <span class="cm"> *  Copyright (C) 2003-2009 Davide Libenzi, Johannes E. Schindelin</span>
<a name="c1-4"></a><span class="lineno">  4</span> <span class="cm"> *</span>
<a name="c1-5"></a><span class="lineno">  5</span> <span class="cm"> *  This library is free software; you can redistribute it and/or</span>
<a name="c1-6"></a><span class="lineno">  6</span> <span class="cm"> *  modify it under the terms of the GNU Lesser General Public</span>
<a name="c1-7"></a><span class="lineno">  7</span> <span class="cm"> *  License as published by the Free Software Foundation; either</span>
<a name="c1-8"></a><span class="lineno">  8</span> <span class="cm"> *  version 2.1 of the License, or (at your option) any later version.</span>
<a name="c1-9"></a><span class="lineno">  9</span> <span class="cm"> *</span>
<a name="c1-10"></a><span class="lineno"> 10</span> <span class="cm"> *  This library is distributed in the hope that it will be useful,</span>
<a name="c1-11"></a><span class="lineno"> 11</span> <span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="c1-12"></a><span class="lineno"> 12</span> <span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="c1-13"></a><span class="lineno"> 13</span> <span class="cm"> *  Lesser General Public License for more details.</span>
<a name="c1-14"></a><span class="lineno"> 14</span> <span class="cm"> *</span>
<a name="c1-15"></a><span class="lineno"> 15</span> <span class="cm"> *  You should have received a copy of the GNU Lesser General Public</span>
<a name="c1-16"></a><span class="lineno"> 16</span> <span class="cm"> *  License along with this library; if not, write to the Free Software</span>
<a name="c1-17"></a><span class="lineno"> 17</span> <span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<a name="c1-18"></a><span class="lineno"> 18</span> <span class="cm"> *</span>
<a name="c1-19"></a><span class="lineno"> 19</span> <span class="cm"> *  Davide Libenzi &lt;davidel@xmailserver.org&gt;</span>
<a name="c1-20"></a><span class="lineno"> 20</span> <span class="cm"> *</span>
<a name="c1-21"></a><span class="lineno"> 21</span> <span class="cm"> */</span>
<a name="c1-22"></a><span class="lineno"> 22</span> <span class="cp">#include "xinclude.h"</span>
<a name="c1-23"></a><span class="lineno"> 23</span> <span class="cp">#include "xtypes.h"</span>
<a name="c1-24"></a><span class="lineno"> 24</span> <span class="cp">#include "xdiff.h"</span>
<a name="c1-25"></a><span class="lineno"> 25</span> 
<a name="c1-26"></a><span class="lineno"> 26</span> <span class="cm">/*</span>
<a name="c1-27"></a><span class="lineno"> 27</span> <span class="cm"> * The basic idea of patience diff is to find lines that are unique in</span>
<a name="c1-28"></a><span class="lineno"> 28</span> <span class="cm"> * both files.  These are intuitively the ones that we want to see as</span>
<a name="c1-29"></a><span class="lineno"> 29</span> <span class="cm"> * common lines.</span>
<a name="c1-30"></a><span class="lineno"> 30</span> <span class="cm"> *</span>
<a name="c1-31"></a><span class="lineno"> 31</span> <span class="cm"> * The maximal ordered sequence of such line pairs (where ordered means</span>
<a name="c1-32"></a><span class="lineno"> 32</span> <span class="cm"> * that the order in the sequence agrees with the order of the lines in</span>
<a name="c1-33"></a><span class="lineno"> 33</span> <span class="cm"> * both files) naturally defines an initial set of common lines.</span>
<a name="c1-34"></a><span class="lineno"> 34</span> <span class="cm"> *</span>
<a name="c1-35"></a><span class="lineno"> 35</span> <span class="cm"> * Now, the algorithm tries to extend the set of common lines by growing</span>
<a name="c1-36"></a><span class="lineno"> 36</span> <span class="cm"> * the line ranges where the files have identical lines.</span>
<a name="c1-37"></a><span class="lineno"> 37</span> <span class="cm"> *</span>
<a name="c1-38"></a><span class="lineno"> 38</span> <span class="cm"> * Between those common lines, the patience diff algorithm is applied</span>
<a name="c1-39"></a><span class="lineno"> 39</span> <span class="cm"> * recursively, until no unique line pairs can be found; these line ranges</span>
<a name="c1-40"></a><span class="lineno"> 40</span> <span class="cm"> * are handled by the well-known Myers algorithm.</span>
<a name="c1-41"></a><span class="lineno"> 41</span> <span class="cm"> */</span>
<a name="c1-42"></a><span class="lineno"> 42</span> 
<a name="c1-43"></a><span class="lineno"> 43</span> <span class="cp">#define NON_UNIQUE ULONG_MAX</span>
<a name="c1-44"></a><span class="lineno"> 44</span> 
<a name="c1-45"></a><span class="lineno"> 45</span> <span class="cm">/*</span>
<a name="c1-46"></a><span class="lineno"> 46</span> <span class="cm"> * This is a hash mapping from line hash to line numbers in the first and</span>
<a name="c1-47"></a><span class="lineno"> 47</span> <span class="cm"> * second file.</span>
<a name="c1-48"></a><span class="lineno"> 48</span> <span class="cm"> */</span>
<a name="c1-49"></a><span class="lineno"> 49</span> <span class="k">struct</span> <span class="n">hashmap</span> <span class="p">{</span>
<a name="c1-50"></a><span class="lineno"> 50</span>   <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">alloc</span><span class="p">;</span>
<a name="c1-51"></a><span class="lineno"> 51</span>   <span class="k">struct</span> <span class="n">entry</span> <span class="p">{</span>
<a name="c1-52"></a><span class="lineno"> 52</span>     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash</span><span class="p">;</span>
<a name="c1-53"></a><span class="lineno"> 53</span>     <span class="cm">/*</span>
<a name="c1-54"></a><span class="lineno"> 54</span> <span class="cm">    * 0 = unused entry, 1 = first line, 2 = second, etc.</span>
<a name="c1-55"></a><span class="lineno"> 55</span> <span class="cm">    * line2 is NON_UNIQUE if the line is not unique</span>
<a name="c1-56"></a><span class="lineno"> 56</span> <span class="cm">    * in either the first or the second file.</span>
<a name="c1-57"></a><span class="lineno"> 57</span> <span class="cm">    */</span>
<a name="c1-58"></a><span class="lineno"> 58</span>     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">;</span>
<a name="c1-59"></a><span class="lineno"> 59</span>     <span class="cm">/*</span>
<a name="c1-60"></a><span class="lineno"> 60</span> <span class="cm">    * "next" &amp; "previous" are used for the longest common</span>
<a name="c1-61"></a><span class="lineno"> 61</span> <span class="cm">    * sequence;</span>
<a name="c1-62"></a><span class="lineno"> 62</span> <span class="cm">    * initially, "next" reflects only the order in file1.</span>
<a name="c1-63"></a><span class="lineno"> 63</span> <span class="cm">    */</span>
<a name="c1-64"></a><span class="lineno"> 64</span>     <span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">previous</span><span class="p">;</span>
<a name="c1-65"></a><span class="lineno"> 65</span>   <span class="p">}</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
<a name="c1-66"></a><span class="lineno"> 66</span>   <span class="cm">/* were common records found? */</span>
<a name="c1-67"></a><span class="lineno"> 67</span>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">has_matches</span><span class="p">;</span>
<a name="c1-68"></a><span class="lineno"> 68</span>   <span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file1</span><span class="p">,</span> <span class="o">*</span><span class="n">file2</span><span class="p">;</span>
<a name="c1-69"></a><span class="lineno"> 69</span>   <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">;</span>
<a name="c1-70"></a><span class="lineno"> 70</span>   <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">;</span>
<a name="c1-71"></a><span class="lineno"> 71</span> <span class="p">};</span>
<a name="c1-72"></a><span class="lineno"> 72</span> 
<a name="c1-73"></a><span class="lineno"> 73</span> <span class="cm">/* The argument "pass" is 1 for the first file, 2 for the second. */</span>
<a name="c1-74"></a><span class="lineno"> 74</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_record</span><span class="p">(</span><span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hashmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pass</span><span class="p">)</span>
<a name="c1-75"></a><span class="lineno"> 75</span> <span class="p">{</span>
<a name="c1-76"></a><span class="lineno"> 76</span>   <span class="n">xrecord_t</span> <span class="o">**</span><span class="n">records</span> <span class="o">=</span> <span class="n">pass</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
<a name="c1-77"></a><span class="lineno"> 77</span>     <span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">recs</span> <span class="o">:</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">recs</span><span class="p">;</span>
<a name="c1-78"></a><span class="lineno"> 78</span>   <span class="n">xrecord_t</span> <span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
<a name="c1-79"></a><span class="lineno"> 79</span>   <span class="cm">/*</span>
<a name="c1-80"></a><span class="lineno"> 80</span> <span class="cm">  * After xdl_prepare_env() (or more precisely, due to</span>
<a name="c1-81"></a><span class="lineno"> 81</span> <span class="cm">  * xdl_classify_record()), the "ha" member of the records (AKA lines)</span>
<a name="c1-82"></a><span class="lineno"> 82</span> <span class="cm">  * is _not_ the hash anymore, but a linearized version of it.  In</span>
<a name="c1-83"></a><span class="lineno"> 83</span> <span class="cm">  * other words, the "ha" member is guaranteed to start with 0 and</span>
<a name="c1-84"></a><span class="lineno"> 84</span> <span class="cm">  * the second record's ha can only be 0 or 1, etc.</span>
<a name="c1-85"></a><span class="lineno"> 85</span> <span class="cm">  *</span>
<a name="c1-86"></a><span class="lineno"> 86</span> <span class="cm">  * So we multiply ha by 2 in the hope that the hashing was</span>
<a name="c1-87"></a><span class="lineno"> 87</span> <span class="cm">  * "unique enough".</span>
<a name="c1-88"></a><span class="lineno"> 88</span> <span class="cm">  */</span>
<a name="c1-89"></a><span class="lineno"> 89</span>   <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
<a name="c1-90"></a><span class="lineno"> 90</span> 
<a name="c1-91"></a><span class="lineno"> 91</span>   <span class="k">while</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">line1</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-92"></a><span class="lineno"> 92</span>     <span class="n">other</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">recs</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">line1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<a name="c1-93"></a><span class="lineno"> 93</span>     <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">hash</span> <span class="o">!=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">||</span>
<a name="c1-94"></a><span class="lineno"> 94</span>         <span class="o">!</span><span class="n">xdl_recmatch</span><span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
<a name="c1-95"></a><span class="lineno"> 95</span>           <span class="n">other</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
<a name="c1-96"></a><span class="lineno"> 96</span>           <span class="n">map</span><span class="o">-&gt;</span><span class="n">xpp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-97"></a><span class="lineno"> 97</span>       <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span>
<a name="c1-98"></a><span class="lineno"> 98</span>         <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-99"></a><span class="lineno"> 99</span>       <span class="k">continue</span><span class="p">;</span>
<a name="c1-100"></a><span class="lineno">100</span>    <span class="p">}</span>
<a name="c1-101"></a><span class="lineno">101</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<a name="c1-102"></a><span class="lineno">102</span>      <span class="n">map</span><span class="o">-&gt;</span><span class="n">has_matches</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-103"></a><span class="lineno">103</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">line2</span><span class="p">)</span>
<a name="c1-104"></a><span class="lineno">104</span>      <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">line2</span> <span class="o">=</span> <span class="n">NON_UNIQUE</span><span class="p">;</span>
<a name="c1-105"></a><span class="lineno">105</span>    <span class="k">else</span>
<a name="c1-106"></a><span class="lineno">106</span>      <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">line2</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c1-107"></a><span class="lineno">107</span>    <span class="k">return</span><span class="p">;</span>
<a name="c1-108"></a><span class="lineno">108</span>  <span class="p">}</span>
<a name="c1-109"></a><span class="lineno">109</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<a name="c1-110"></a><span class="lineno">110</span>    <span class="k">return</span><span class="p">;</span>
<a name="c1-111"></a><span class="lineno">111</span>  <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">line1</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
<a name="c1-112"></a><span class="lineno">112</span>  <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">hash</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
<a name="c1-113"></a><span class="lineno">113</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)</span>
<a name="c1-114"></a><span class="lineno">114</span>    <span class="n">map</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
<a name="c1-115"></a><span class="lineno">115</span>  <span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-116"></a><span class="lineno">116</span>    <span class="n">map</span><span class="o">-&gt;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
<a name="c1-117"></a><span class="lineno">117</span>    <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">previous</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
<a name="c1-118"></a><span class="lineno">118</span>  <span class="p">}</span>
<a name="c1-119"></a><span class="lineno">119</span>  <span class="n">map</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
<a name="c1-120"></a><span class="lineno">120</span>  <span class="n">map</span><span class="o">-&gt;</span><span class="n">nr</span><span class="o">++</span><span class="p">;</span>
<a name="c1-121"></a><span class="lineno">121</span> <span class="p">}</span>
<a name="c1-122"></a><span class="lineno">122</span> 
<a name="c1-123"></a><span class="lineno">123</span> <span class="cm">/*</span>
<a name="c1-124"></a><span class="lineno">124</span> <span class="cm"> * This function has to be called for each recursion into the inter-hunk</span>
<a name="c1-125"></a><span class="lineno">125</span> <span class="cm"> * parts, as previously non-unique lines can become unique when being</span>
<a name="c1-126"></a><span class="lineno">126</span> <span class="cm"> * restricted to a smaller part of the files.</span>
<a name="c1-127"></a><span class="lineno">127</span> <span class="cm"> *</span>
<a name="c1-128"></a><span class="lineno">128</span> <span class="cm"> * It is assumed that env has been prepared using xdl_prepare().</span>
<a name="c1-129"></a><span class="lineno">129</span> <span class="cm"> */</span>
<a name="c1-130"></a><span class="lineno">130</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_hashmap</span><span class="p">(</span><span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file1</span><span class="p">,</span> <span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file2</span><span class="p">,</span>
<a name="c1-131"></a><span class="lineno">131</span>    <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span> <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
<a name="c1-132"></a><span class="lineno">132</span>    <span class="k">struct</span> <span class="n">hashmap</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span>
<a name="c1-133"></a><span class="lineno">133</span>    <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c1-134"></a><span class="lineno">134</span> <span class="p">{</span>
<a name="c1-135"></a><span class="lineno">135</span>  <span class="n">result</span><span class="o">-&gt;</span><span class="n">file1</span> <span class="o">=</span> <span class="n">file1</span><span class="p">;</span>
<a name="c1-136"></a><span class="lineno">136</span>  <span class="n">result</span><span class="o">-&gt;</span><span class="n">file2</span> <span class="o">=</span> <span class="n">file2</span><span class="p">;</span>
<a name="c1-137"></a><span class="lineno">137</span>  <span class="n">result</span><span class="o">-&gt;</span><span class="n">xpp</span> <span class="o">=</span> <span class="n">xpp</span><span class="p">;</span>
<a name="c1-138"></a><span class="lineno">138</span>  <span class="n">result</span><span class="o">-&gt;</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="p">;</span>
<a name="c1-139"></a><span class="lineno">139</span> 
<a name="c1-140"></a><span class="lineno">140</span>  <span class="cm">/* We know exactly how large we want the hash map */</span>
<a name="c1-141"></a><span class="lineno">141</span>  <span class="n">result</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">count1</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<a name="c1-142"></a><span class="lineno">142</span>  <span class="n">result</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="p">)</span>
<a name="c1-143"></a><span class="lineno">143</span>    <span class="n">xdl_malloc</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">entry</span><span class="p">));</span>
<a name="c1-144"></a><span class="lineno">144</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span>
<a name="c1-145"></a><span class="lineno">145</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-146"></a><span class="lineno">146</span>  <span class="n">memset</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">entry</span><span class="p">));</span>
<a name="c1-147"></a><span class="lineno">147</span> 
<a name="c1-148"></a><span class="lineno">148</span>  <span class="cm">/* First, fill with entries from the first file */</span>
<a name="c1-149"></a><span class="lineno">149</span>  <span class="k">while</span> <span class="p">(</span><span class="n">count1</span><span class="o">--</span><span class="p">)</span>
<a name="c1-150"></a><span class="lineno">150</span>    <span class="n">insert_record</span><span class="p">(</span><span class="n">line1</span><span class="o">++</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="c1-151"></a><span class="lineno">151</span> 
<a name="c1-152"></a><span class="lineno">152</span>  <span class="cm">/* Then search for matches in the second file */</span>
<a name="c1-153"></a><span class="lineno">153</span>  <span class="k">while</span> <span class="p">(</span><span class="n">count2</span><span class="o">--</span><span class="p">)</span>
<a name="c1-154"></a><span class="lineno">154</span>    <span class="n">insert_record</span><span class="p">(</span><span class="n">line2</span><span class="o">++</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a name="c1-155"></a><span class="lineno">155</span> 
<a name="c1-156"></a><span class="lineno">156</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-157"></a><span class="lineno">157</span> <span class="p">}</span>
<a name="c1-158"></a><span class="lineno">158</span> 
<a name="c1-159"></a><span class="lineno">159</span> <span class="cm">/*</span>
<a name="c1-160"></a><span class="lineno">160</span> <span class="cm"> * Find the longest sequence with a smaller last element (meaning a smaller</span>
<a name="c1-161"></a><span class="lineno">161</span> <span class="cm"> * line2, as we construct the sequence with entries ordered by line1).</span>
<a name="c1-162"></a><span class="lineno">162</span> <span class="cm"> */</span>
<a name="c1-163"></a><span class="lineno">163</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">binary_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">entry</span> <span class="o">**</span><span class="n">sequence</span><span class="p">,</span> <span class="kt">int</span> <span class="n">longest</span><span class="p">,</span>
<a name="c1-164"></a><span class="lineno">164</span>    <span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<a name="c1-165"></a><span class="lineno">165</span> <span class="p">{</span>
<a name="c1-166"></a><span class="lineno">166</span>  <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">longest</span><span class="p">;</span>
<a name="c1-167"></a><span class="lineno">167</span> 
<a name="c1-168"></a><span class="lineno">168</span>  <span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-169"></a><span class="lineno">169</span>    <span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="c1-170"></a><span class="lineno">170</span>    <span class="cm">/* by construction, no two entries can be equal */</span>
<a name="c1-171"></a><span class="lineno">171</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">middle</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">line2</span> <span class="o">&gt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">line2</span><span class="p">)</span>
<a name="c1-172"></a><span class="lineno">172</span>      <span class="n">right</span> <span class="o">=</span> <span class="n">middle</span><span class="p">;</span>
<a name="c1-173"></a><span class="lineno">173</span>    <span class="k">else</span>
<a name="c1-174"></a><span class="lineno">174</span>      <span class="n">left</span> <span class="o">=</span> <span class="n">middle</span><span class="p">;</span>
<a name="c1-175"></a><span class="lineno">175</span>  <span class="p">}</span>
<a name="c1-176"></a><span class="lineno">176</span>  <span class="cm">/* return the index in "sequence", _not_ the sequence length */</span>
<a name="c1-177"></a><span class="lineno">177</span>  <span class="k">return</span> <span class="n">left</span><span class="p">;</span>
<a name="c1-178"></a><span class="lineno">178</span> <span class="p">}</span>
<a name="c1-179"></a><span class="lineno">179</span> 
<a name="c1-180"></a><span class="lineno">180</span> <span class="cm">/*</span>
<a name="c1-181"></a><span class="lineno">181</span> <span class="cm"> * The idea is to start with the list of common unique lines sorted by</span>
<a name="c1-182"></a><span class="lineno">182</span> <span class="cm"> * the order in file1.  For each of these pairs, the longest (partial)</span>
<a name="c1-183"></a><span class="lineno">183</span> <span class="cm"> * sequence whose last element's line2 is smaller is determined.</span>
<a name="c1-184"></a><span class="lineno">184</span> <span class="cm"> *</span>
<a name="c1-185"></a><span class="lineno">185</span> <span class="cm"> * For efficiency, the sequences are kept in a list containing exactly one</span>
<a name="c1-186"></a><span class="lineno">186</span> <span class="cm"> * item per sequence length: the sequence with the smallest last</span>
<a name="c1-187"></a><span class="lineno">187</span> <span class="cm"> * element (in terms of line2).</span>
<a name="c1-188"></a><span class="lineno">188</span> <span class="cm"> */</span>
<a name="c1-189"></a><span class="lineno">189</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="nf">find_longest_common_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<a name="c1-190"></a><span class="lineno">190</span> <span class="p">{</span>
<a name="c1-191"></a><span class="lineno">191</span>  <span class="k">struct</span> <span class="n">entry</span> <span class="o">**</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">xdl_malloc</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="p">));</span>
<a name="c1-192"></a><span class="lineno">192</span>  <span class="kt">int</span> <span class="n">longest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<a name="c1-193"></a><span class="lineno">193</span>  <span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
<a name="c1-194"></a><span class="lineno">194</span> 
<a name="c1-195"></a><span class="lineno">195</span>  <span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span> <span class="n">entry</span><span class="p">;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-196"></a><span class="lineno">196</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">line2</span> <span class="o">||</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">line2</span> <span class="o">==</span> <span class="n">NON_UNIQUE</span><span class="p">)</span>
<a name="c1-197"></a><span class="lineno">197</span>      <span class="k">continue</span><span class="p">;</span>
<a name="c1-198"></a><span class="lineno">198</span>    <span class="n">i</span> <span class="o">=</span> <span class="n">binary_search</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">longest</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
<a name="c1-199"></a><span class="lineno">199</span>    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">previous</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="c1-200"></a><span class="lineno">200</span>    <span class="n">sequence</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<a name="c1-201"></a><span class="lineno">201</span>    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">longest</span><span class="p">)</span>
<a name="c1-202"></a><span class="lineno">202</span>      <span class="n">longest</span><span class="o">++</span><span class="p">;</span>
<a name="c1-203"></a><span class="lineno">203</span>  <span class="p">}</span>
<a name="c1-204"></a><span class="lineno">204</span> 
<a name="c1-205"></a><span class="lineno">205</span>  <span class="cm">/* No common unique lines were found */</span>
<a name="c1-206"></a><span class="lineno">206</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">longest</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-207"></a><span class="lineno">207</span>    <span class="n">xdl_free</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
<a name="c1-208"></a><span class="lineno">208</span>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-209"></a><span class="lineno">209</span>  <span class="p">}</span>
<a name="c1-210"></a><span class="lineno">210</span> 
<a name="c1-211"></a><span class="lineno">211</span>  <span class="cm">/* Iterate starting at the last element, adjusting the "next" members */</span>
<a name="c1-212"></a><span class="lineno">212</span>  <span class="n">entry</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">longest</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<a name="c1-213"></a><span class="lineno">213</span>  <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="c1-214"></a><span class="lineno">214</span>  <span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">previous</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-215"></a><span class="lineno">215</span>    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">previous</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<a name="c1-216"></a><span class="lineno">216</span>    <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">previous</span><span class="p">;</span>
<a name="c1-217"></a><span class="lineno">217</span>  <span class="p">}</span>
<a name="c1-218"></a><span class="lineno">218</span>  <span class="n">xdl_free</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
<a name="c1-219"></a><span class="lineno">219</span>  <span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<a name="c1-220"></a><span class="lineno">220</span> <span class="p">}</span>
<a name="c1-221"></a><span class="lineno">221</span> 
<a name="c1-222"></a><span class="lineno">222</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">match</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">)</span>
<a name="c1-223"></a><span class="lineno">223</span> <span class="p">{</span>
<a name="c1-224"></a><span class="lineno">224</span>  <span class="n">xrecord_t</span> <span class="o">*</span><span class="n">record1</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">recs</span><span class="p">[</span><span class="n">line1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<a name="c1-225"></a><span class="lineno">225</span>  <span class="n">xrecord_t</span> <span class="o">*</span><span class="n">record2</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">recs</span><span class="p">[</span><span class="n">line2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<a name="c1-226"></a><span class="lineno">226</span>  <span class="k">return</span> <span class="n">xdl_recmatch</span><span class="p">(</span><span class="n">record1</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">record1</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
<a name="c1-227"></a><span class="lineno">227</span>    <span class="n">record2</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">record2</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">xpp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<a name="c1-228"></a><span class="lineno">228</span> <span class="p">}</span>
<a name="c1-229"></a><span class="lineno">229</span> 
<a name="c1-230"></a><span class="lineno">230</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">patience_diff</span><span class="p">(</span><span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file1</span><span class="p">,</span> <span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file2</span><span class="p">,</span>
<a name="c1-231"></a><span class="lineno">231</span>    <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span> <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
<a name="c1-232"></a><span class="lineno">232</span>    <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">);</span>
<a name="c1-233"></a><span class="lineno">233</span> 
<a name="c1-234"></a><span class="lineno">234</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">walk_common_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span>
<a name="c1-235"></a><span class="lineno">235</span>    <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c1-236"></a><span class="lineno">236</span> <span class="p">{</span>
<a name="c1-237"></a><span class="lineno">237</span>  <span class="kt">int</span> <span class="n">end1</span> <span class="o">=</span> <span class="n">line1</span> <span class="o">+</span> <span class="n">count1</span><span class="p">,</span> <span class="n">end2</span> <span class="o">=</span> <span class="n">line2</span> <span class="o">+</span> <span class="n">count2</span><span class="p">;</span>
<a name="c1-238"></a><span class="lineno">238</span>  <span class="kt">int</span> <span class="n">next1</span><span class="p">,</span> <span class="n">next2</span><span class="p">;</span>
<a name="c1-239"></a><span class="lineno">239</span> 
<a name="c1-240"></a><span class="lineno">240</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="c1-241"></a><span class="lineno">241</span>    <span class="cm">/* Try to grow the line ranges of common lines */</span>
<a name="c1-242"></a><span class="lineno">242</span>    <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-243"></a><span class="lineno">243</span>      <span class="n">next1</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">line1</span><span class="p">;</span>
<a name="c1-244"></a><span class="lineno">244</span>      <span class="n">next2</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">line2</span><span class="p">;</span>
<a name="c1-245"></a><span class="lineno">245</span>      <span class="k">while</span> <span class="p">(</span><span class="n">next1</span> <span class="o">&gt;</span> <span class="n">line1</span> <span class="o">&amp;&amp;</span> <span class="n">next2</span> <span class="o">&gt;</span> <span class="n">line2</span> <span class="o">&amp;&amp;</span>
<a name="c1-246"></a><span class="lineno">246</span>          <span class="n">match</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">next1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">next2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-247"></a><span class="lineno">247</span>        <span class="n">next1</span><span class="o">--</span><span class="p">;</span>
<a name="c1-248"></a><span class="lineno">248</span>        <span class="n">next2</span><span class="o">--</span><span class="p">;</span>
<a name="c1-249"></a><span class="lineno">249</span>      <span class="p">}</span>
<a name="c1-250"></a><span class="lineno">250</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="c1-251"></a><span class="lineno">251</span>      <span class="n">next1</span> <span class="o">=</span> <span class="n">end1</span><span class="p">;</span>
<a name="c1-252"></a><span class="lineno">252</span>      <span class="n">next2</span> <span class="o">=</span> <span class="n">end2</span><span class="p">;</span>
<a name="c1-253"></a><span class="lineno">253</span>    <span class="p">}</span>
<a name="c1-254"></a><span class="lineno">254</span>    <span class="k">while</span> <span class="p">(</span><span class="n">line1</span> <span class="o">&lt;</span> <span class="n">next1</span> <span class="o">&amp;&amp;</span> <span class="n">line2</span> <span class="o">&lt;</span> <span class="n">next2</span> <span class="o">&amp;&amp;</span>
<a name="c1-255"></a><span class="lineno">255</span>        <span class="n">match</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">))</span> <span class="p">{</span>
<a name="c1-256"></a><span class="lineno">256</span>      <span class="n">line1</span><span class="o">++</span><span class="p">;</span>
<a name="c1-257"></a><span class="lineno">257</span>      <span class="n">line2</span><span class="o">++</span><span class="p">;</span>
<a name="c1-258"></a><span class="lineno">258</span>    <span class="p">}</span>
<a name="c1-259"></a><span class="lineno">259</span> 
<a name="c1-260"></a><span class="lineno">260</span>    <span class="cm">/* Recurse */</span>
<a name="c1-261"></a><span class="lineno">261</span>    <span class="k">if</span> <span class="p">(</span><span class="n">next1</span> <span class="o">&gt;</span> <span class="n">line1</span> <span class="o">||</span> <span class="n">next2</span> <span class="o">&gt;</span> <span class="n">line2</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-262"></a><span class="lineno">262</span>      <span class="k">struct</span> <span class="n">hashmap</span> <span class="n">submap</span><span class="p">;</span>
<a name="c1-263"></a><span class="lineno">263</span> 
<a name="c1-264"></a><span class="lineno">264</span>      <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">submap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">submap</span><span class="p">));</span>
<a name="c1-265"></a><span class="lineno">265</span>      <span class="k">if</span> <span class="p">(</span><span class="n">patience_diff</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">file1</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">file2</span><span class="p">,</span>
<a name="c1-266"></a><span class="lineno">266</span>          <span class="n">map</span><span class="o">-&gt;</span><span class="n">xpp</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">,</span>
<a name="c1-267"></a><span class="lineno">267</span>          <span class="n">line1</span><span class="p">,</span> <span class="n">next1</span> <span class="o">-</span> <span class="n">line1</span><span class="p">,</span>
<a name="c1-268"></a><span class="lineno">268</span>          <span class="n">line2</span><span class="p">,</span> <span class="n">next2</span> <span class="o">-</span> <span class="n">line2</span><span class="p">))</span>
<a name="c1-269"></a><span class="lineno">269</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-270"></a><span class="lineno">270</span>    <span class="p">}</span>
<a name="c1-271"></a><span class="lineno">271</span> 
<a name="c1-272"></a><span class="lineno">272</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first</span><span class="p">)</span>
<a name="c1-273"></a><span class="lineno">273</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-274"></a><span class="lineno">274</span> 
<a name="c1-275"></a><span class="lineno">275</span>    <span class="k">while</span> <span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">&amp;&amp;</span>
<a name="c1-276"></a><span class="lineno">276</span>        <span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">line1</span> <span class="o">==</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">line1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
<a name="c1-277"></a><span class="lineno">277</span>        <span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">line2</span> <span class="o">==</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">line2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="c1-278"></a><span class="lineno">278</span>      <span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-279"></a><span class="lineno">279</span> 
<a name="c1-280"></a><span class="lineno">280</span>    <span class="n">line1</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">line1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-281"></a><span class="lineno">281</span>    <span class="n">line2</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">line2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-282"></a><span class="lineno">282</span> 
<a name="c1-283"></a><span class="lineno">283</span>    <span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<a name="c1-284"></a><span class="lineno">284</span>  <span class="p">}</span>
<a name="c1-285"></a><span class="lineno">285</span> <span class="p">}</span>
<a name="c1-286"></a><span class="lineno">286</span> 
<a name="c1-287"></a><span class="lineno">287</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">fall_back_to_classic_diff</span><span class="p">(</span><span class="k">struct</span> <span class="n">hashmap</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
<a name="c1-288"></a><span class="lineno">288</span>    <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c1-289"></a><span class="lineno">289</span> <span class="p">{</span>
<a name="c1-290"></a><span class="lineno">290</span>  <span class="n">xpparam_t</span> <span class="n">xpp</span><span class="p">;</span>
<a name="c1-291"></a><span class="lineno">291</span>  <span class="n">xpp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">xpp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XDF_PATIENCE_DIFF</span><span class="p">;</span>
<a name="c1-292"></a><span class="lineno">292</span> 
<a name="c1-293"></a><span class="lineno">293</span>  <span class="k">return</span> <span class="n">xdl_fall_back_diff</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xpp</span><span class="p">,</span>
<a name="c1-294"></a><span class="lineno">294</span>          <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<a name="c1-295"></a><span class="lineno">295</span> <span class="p">}</span>
<a name="c1-296"></a><span class="lineno">296</span> 
<a name="c1-297"></a><span class="lineno">297</span> <span class="cm">/*</span>
<a name="c1-298"></a><span class="lineno">298</span> <span class="cm"> * Recursively find the longest common sequence of unique lines,</span>
<a name="c1-299"></a><span class="lineno">299</span> <span class="cm"> * and if none was found, ask xdl_do_diff() to do the job.</span>
<a name="c1-300"></a><span class="lineno">300</span> <span class="cm"> *</span>
<a name="c1-301"></a><span class="lineno">301</span> <span class="cm"> * This function assumes that env was prepared with xdl_prepare_env().</span>
<a name="c1-302"></a><span class="lineno">302</span> <span class="cm"> */</span>
<a name="c1-303"></a><span class="lineno">303</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">patience_diff</span><span class="p">(</span><span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file1</span><span class="p">,</span> <span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file2</span><span class="p">,</span>
<a name="c1-304"></a><span class="lineno">304</span>    <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span> <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
<a name="c1-305"></a><span class="lineno">305</span>    <span class="kt">int</span> <span class="n">line1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count2</span><span class="p">)</span>
<a name="c1-306"></a><span class="lineno">306</span> <span class="p">{</span>
<a name="c1-307"></a><span class="lineno">307</span>  <span class="k">struct</span> <span class="n">hashmap</span> <span class="n">map</span><span class="p">;</span>
<a name="c1-308"></a><span class="lineno">308</span>  <span class="k">struct</span> <span class="n">entry</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
<a name="c1-309"></a><span class="lineno">309</span> <span class="hll"> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-310"></a><span class="lineno">310</span> <span class="hll">
</span><a name="c1-311"></a><span class="lineno">311</span> <span class="hll">  <span class="cm">/* trivial case: one side is empty */</span>
</span><a name="c1-312"></a><span class="lineno">312</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count1</span><span class="p">)</span> <span class="p">{</span>
</span><a name="c1-313"></a><span class="lineno">313</span> <span class="hll">    <span class="k">while</span><span class="p">(</span><span class="n">count2</span><span class="o">--</span><span class="p">)</span>
</span><a name="c1-314"></a><span class="lineno">314</span> <span class="hll">      <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line2</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c1-315"></a><span class="lineno">315</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-316"></a><span class="lineno">316</span> <span class="hll">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count2</span><span class="p">)</span> <span class="p">{</span>
</span><a name="c1-317"></a><span class="lineno">317</span> <span class="hll">    <span class="k">while</span><span class="p">(</span><span class="n">count1</span><span class="o">--</span><span class="p">)</span>
</span><a name="c1-318"></a><span class="lineno">318</span> <span class="hll">      <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line1</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><a name="c1-319"></a><span class="lineno">319</span> <span class="hll">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><a name="c1-320"></a><span class="lineno">320</span> <span class="hll">  <span class="p">}</span>
</span><a name="c1-321"></a><span class="lineno">321</span> <span class="hll">
</span><a name="c1-322"></a><span class="lineno">322</span> <span class="hll">  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
</span><a name="c1-323"></a><span class="lineno">323</span> <span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">fill_hashmap</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">,</span>
</span><a name="c1-324"></a><span class="lineno">324</span>       <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">))</span>
<a name="c1-325"></a><span class="lineno">325</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-326"></a><span class="lineno">326</span> 
<a name="c1-327"></a><span class="lineno">327</span>  <span class="cm">/* are there any matching lines at all? */</span>
<a name="c1-328"></a><span class="lineno">328</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">.</span><span class="n">has_matches</span><span class="p">)</span> <span class="p">{</span>
<a name="c1-329"></a><span class="lineno">329</span>    <span class="k">while</span><span class="p">(</span><span class="n">count1</span><span class="o">--</span><span class="p">)</span>
<a name="c1-330"></a><span class="lineno">330</span>      <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line1</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-331"></a><span class="lineno">331</span>    <span class="k">while</span><span class="p">(</span><span class="n">count2</span><span class="o">--</span><span class="p">)</span>
<a name="c1-332"></a><span class="lineno">332</span>      <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">rchg</span><span class="p">[</span><span class="n">line2</span><span class="o">++</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="c1-333"></a><span class="lineno">333</span>    <span class="n">xdl_free</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
<a name="c1-334"></a><span class="lineno">334</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="c1-335"></a><span class="lineno">335</span>  <span class="p">}</span>
<a name="c1-336"></a><span class="lineno">336</span> 
<a name="c1-337"></a><span class="lineno">337</span>  <span class="n">first</span> <span class="o">=</span> <span class="n">find_longest_common_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>
<a name="c1-338"></a><span class="lineno">338</span>  <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
<a name="c1-339"></a><span class="lineno">339</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">walk_common_sequence</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span>
<a name="c1-340"></a><span class="lineno">340</span>      <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<a name="c1-341"></a><span class="lineno">341</span>  <span class="k">else</span>
<a name="c1-342"></a><span class="lineno">342</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">fall_back_to_classic_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">,</span>
<a name="c1-343"></a><span class="lineno">343</span>      <span class="n">line1</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">count2</span><span class="p">);</span>
<a name="c1-344"></a><span class="lineno">344</span> 
<a name="c1-345"></a><span class="lineno">345</span>  <span class="n">xdl_free</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
<a name="c1-346"></a><span class="lineno">346</span>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="c1-347"></a><span class="lineno">347</span> <span class="p">}</span>
<a name="c1-348"></a><span class="lineno">348</span> 
<a name="c1-349"></a><span class="lineno">349</span> <span class="kt">int</span> <span class="nf">xdl_do_patience_diff</span><span class="p">(</span><span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file1</span><span class="p">,</span> <span class="n">mmfile_t</span> <span class="o">*</span><span class="n">file2</span><span class="p">,</span>
<a name="c1-350"></a><span class="lineno">350</span>    <span class="n">xpparam_t</span> <span class="k">const</span> <span class="o">*</span><span class="n">xpp</span><span class="p">,</span> <span class="n">xdfenv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<a name="c1-351"></a><span class="lineno">351</span> <span class="p">{</span>
<a name="c1-352"></a><span class="lineno">352</span>  <span class="k">if</span> <span class="p">(</span><span class="n">xdl_prepare_env</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="c1-353"></a><span class="lineno">353</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="c1-354"></a><span class="lineno">354</span> 
<a name="c1-355"></a><span class="lineno">355</span>  <span class="cm">/* environment is cleaned up in xdl_diff() */</span>
<a name="c1-356"></a><span class="lineno">356</span>  <span class="k">return</span> <span class="n">patience_diff</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">xpp</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span>
<a name="c1-357"></a><span class="lineno">357</span>      <span class="mi">1</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf1</span><span class="p">.</span><span class="n">nrec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">xdf2</span><span class="p">.</span><span class="n">nrec</span><span class="p">);</span>
<a name="c1-358"></a><span class="lineno">358</span> <span class="p">}</span>
</pre></div>

                </div>
                <div class="scrollable-sections-bottom-shadow" style="opacity: 5.5;"></div>
            </div>
        </div>
        
    </div>
</body></html>